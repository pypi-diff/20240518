# Comparing `tmp/skypilot_nightly-1.0.0.dev20240516.tar.gz` & `tmp/skypilot_nightly-1.0.0.dev20240517.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "skypilot_nightly-1.0.0.dev20240516.tar", last modified: Thu May 16 10:38:19 2024, max compression
+gzip compressed data, was "skypilot_nightly-1.0.0.dev20240517.tar", last modified: Fri May 17 10:38:10 2024, max compression
```

## Comparing `skypilot_nightly-1.0.0.dev20240516.tar` & `skypilot_nightly-1.0.0.dev20240517.tar`

### file list

```diff
@@ -1,339 +1,339 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.066670 skypilot_nightly-1.0.0.dev20240516/
--rw-r--r--   0 runner    (1001) docker     (127)    12170 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    18140 2024-05-16 10:38:19.066670 skypilot_nightly-1.0.0.dev20240516/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)    12079 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/README.md
--rw-r--r--   0 runner    (1001) docker     (127)      640 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-16 10:38:19.066670 skypilot_nightly-1.0.0.dev20240516/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (127)    12055 2024-05-16 10:38:16.000000 skypilot_nightly-1.0.0.dev20240516/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.006671 skypilot_nightly-1.0.0.dev20240516/sky/
--rw-r--r--   0 runner    (1001) docker     (127)     5588 2024-05-16 10:38:18.000000 skypilot_nightly-1.0.0.dev20240516/sky/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.010671 skypilot_nightly-1.0.0.dev20240516/sky/adaptors/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/adaptors/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     6863 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/adaptors/aws.py
--rw-r--r--   0 runner    (1001) docker     (127)     2291 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/adaptors/azure.py
--rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/adaptors/cloudflare.py
--rw-r--r--   0 runner    (1001) docker     (127)     2354 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/adaptors/common.py
--rw-r--r--   0 runner    (1001) docker     (127)      239 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/adaptors/cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)      468 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/adaptors/docker.py
--rw-r--r--   0 runner    (1001) docker     (127)     3097 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/adaptors/gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)     4906 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/adaptors/ibm.py
--rw-r--r--   0 runner    (1001) docker     (127)     4109 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/adaptors/kubernetes.py
--rw-r--r--   0 runner    (1001) docker     (127)     1480 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/adaptors/oci.py
--rw-r--r--   0 runner    (1001) docker     (127)      225 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/adaptors/runpod.py
--rw-r--r--   0 runner    (1001) docker     (127)     2129 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/adaptors/vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)    21408 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/authentication.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.010671 skypilot_nightly-1.0.0.dev20240516/sky/backends/
--rw-r--r--   0 runner    (1001) docker     (127)      536 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/backends/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     5932 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/backends/backend.py
--rw-r--r--   0 runner    (1001) docker     (127)   125420 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/backends/backend_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)   230760 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/backends/cloud_vm_ray_backend.py
--rw-r--r--   0 runner    (1001) docker     (127)     8358 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/backends/docker_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    16741 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/backends/local_docker_backend.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.010671 skypilot_nightly-1.0.0.dev20240516/sky/backends/monkey_patches/
--rw-r--r--   0 runner    (1001) docker     (127)     3450 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/backends/monkey_patches/monkey_patch_ray_up.py
--rw-r--r--   0 runner    (1001) docker     (127)     7297 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/backends/wheel_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.010671 skypilot_nightly-1.0.0.dev20240516/sky/benchmark/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/benchmark/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     8723 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/benchmark/benchmark_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    26446 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/benchmark/benchmark_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     7289 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/check.py
--rw-r--r--   0 runner    (1001) docker     (127)   192402 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/cli.py
--rw-r--r--   0 runner    (1001) docker     (127)    11806 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/cloud_stores.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.014670 skypilot_nightly-1.0.0.dev20240516/sky/clouds/
--rw-r--r--   0 runner    (1001) docker     (127)     1310 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    44608 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/aws.py
--rw-r--r--   0 runner    (1001) docker     (127)    31006 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/azure.py
--rw-r--r--   0 runner    (1001) docker     (127)    31817 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)      955 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/cloud_registry.py
--rw-r--r--   0 runner    (1001) docker     (127)    12036 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)    12647 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/fluidstack.py
--rw-r--r--   0 runner    (1001) docker     (127)    48019 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)    21044 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/ibm.py
--rw-r--r--   0 runner    (1001) docker     (127)    20376 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/kubernetes.py
--rw-r--r--   0 runner    (1001) docker     (127)    12157 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/lambda_cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)    25299 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/oci.py
--rw-r--r--   0 runner    (1001) docker     (127)    10561 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/paperspace.py
--rw-r--r--   0 runner    (1001) docker     (127)    11166 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/runpod.py
--rw-r--r--   0 runner    (1001) docker     (127)    15546 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/scp.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.018671 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/
--rw-r--r--   0 runner    (1001) docker     (127)    12771 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    12550 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/aws_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     7289 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/azure_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)    26837 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/common.py
--rw-r--r--   0 runner    (1001) docker     (127)     1793 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      411 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)     4335 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/cudo_catalog.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.018671 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/data_fetchers/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/data_fetchers/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    22424 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
--rw-r--r--   0 runner    (1001) docker     (127)    11477 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
--rw-r--r--   0 runner    (1001) docker     (127)     5072 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)     3895 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py
--rw-r--r--   0 runner    (1001) docker     (127)    22243 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)     4297 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)    21462 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)     5038 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/fluidstack_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)    24120 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/gcp_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4472 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/ibm_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4240 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/kubernetes_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     5082 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/lambda_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/oci_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     3768 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/paperspace_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4184 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/runpod_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     5174 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/scp_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4391 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/vsphere_catalog.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.018671 skypilot_nightly-1.0.0.dev20240516/sky/clouds/utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     6968 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/utils/gcp_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     9991 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/utils/lambda_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     4482 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/utils/oci_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    15781 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/utils/scp_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    11969 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/clouds/vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)    34233 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/core.py
--rw-r--r--   0 runner    (1001) docker     (127)     2529 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/dag.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.022671 skypilot_nightly-1.0.0.dev20240516/sky/data/
--rw-r--r--   0 runner    (1001) docker     (127)      184 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/data/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7346 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/data/data_transfer.py
--rw-r--r--   0 runner    (1001) docker     (127)    21664 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/data/data_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     8351 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/data/mounting_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)   118872 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/data/storage.py
--rw-r--r--   0 runner    (1001) docker     (127)     6867 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/data/storage_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     8249 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/exceptions.py
--rw-r--r--   0 runner    (1001) docker     (127)    25107 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/execution.py
--rw-r--r--   0 runner    (1001) docker     (127)    28681 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/global_user_state.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.022671 skypilot_nightly-1.0.0.dev20240516/sky/jobs/
--rw-r--r--   0 runner    (1001) docker     (127)     1398 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/jobs/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1350 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/jobs/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    26607 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/jobs/controller.py
--rw-r--r--   0 runner    (1001) docker     (127)    13430 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/jobs/core.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.022671 skypilot_nightly-1.0.0.dev20240516/sky/jobs/dashboard/
--rw-r--r--   0 runner    (1001) docker     (127)     3050 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/jobs/dashboard/dashboard.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.022671 skypilot_nightly-1.0.0.dev20240516/sky/jobs/dashboard/static/
--rw-r--r--   0 runner    (1001) docker     (127)    15086 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/jobs/dashboard/static/favicon.ico
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.022671 skypilot_nightly-1.0.0.dev20240516/sky/jobs/dashboard/templates/
--rw-r--r--   0 runner    (1001) docker     (127)     9837 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/jobs/dashboard/templates/index.html
--rw-r--r--   0 runner    (1001) docker     (127)    25556 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/jobs/recovery_strategy.py
--rw-r--r--   0 runner    (1001) docker     (127)    23041 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/jobs/state.py
--rw-r--r--   0 runner    (1001) docker     (127)    33067 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/jobs/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    54188 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/optimizer.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.022671 skypilot_nightly-1.0.0.dev20240516/sky/provision/
--rw-r--r--   0 runner    (1001) docker     (127)     5951 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.022671 skypilot_nightly-1.0.0.dev20240516/sky/provision/aws/
--rw-r--r--   0 runner    (1001) docker     (127)      731 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/aws/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    22092 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/aws/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    36307 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/aws/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     3238 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/aws/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.026671 skypilot_nightly-1.0.0.dev20240516/sky/provision/azure/
--rw-r--r--   0 runner    (1001) docker     (127)      146 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/azure/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4028 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/azure/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     9339 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/common.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.026671 skypilot_nightly-1.0.0.dev20240516/sky/provision/cudo/
--rw-r--r--   0 runner    (1001) docker     (127)      676 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/cudo/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      327 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/cudo/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      696 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/cudo/cudo_machine_type.py
--rw-r--r--   0 runner    (1001) docker     (127)     4046 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/cudo/cudo_wrapper.py
--rw-r--r--   0 runner    (1001) docker     (127)     8307 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/cudo/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    16758 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/docker_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.026671 skypilot_nightly-1.0.0.dev20240516/sky/provision/fluidstack/
--rw-r--r--   0 runner    (1001) docker     (127)      592 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/fluidstack/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      326 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/fluidstack/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     8262 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/fluidstack/fluidstack_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    14974 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/fluidstack/instance.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.026671 skypilot_nightly-1.0.0.dev20240516/sky/provision/gcp/
--rw-r--r--   0 runner    (1001) docker     (127)      528 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/gcp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    32964 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/gcp/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     7234 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/gcp/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    24215 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/gcp/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    59069 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/gcp/instance_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    22186 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/instance_setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.026671 skypilot_nightly-1.0.0.dev20240516/sky/provision/kubernetes/
--rw-r--r--   0 runner    (1001) docker     (127)      653 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/kubernetes/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    28319 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/kubernetes/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    32919 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/kubernetes/instance.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.026671 skypilot_nightly-1.0.0.dev20240516/sky/provision/kubernetes/manifests/
--rw-r--r--   0 runner    (1001) docker     (127)      229 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/kubernetes/manifests/smarter-device-manager-configmap.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     1939 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml
--rw-r--r--   0 runner    (1001) docker     (127)    10561 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/kubernetes/network.py
--rw-r--r--   0 runner    (1001) docker     (127)     9384 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/kubernetes/network_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    62091 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/kubernetes/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2103 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/logging.py
--rw-r--r--   0 runner    (1001) docker     (127)     4013 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/metadata_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.030671 skypilot_nightly-1.0.0.dev20240516/sky/provision/paperspace/
--rw-r--r--   0 runner    (1001) docker     (127)      598 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/paperspace/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1541 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/paperspace/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      802 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/paperspace/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    12045 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/paperspace/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     9428 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/paperspace/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    25103 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/provisioner.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.030671 skypilot_nightly-1.0.0.dev20240516/sky/provision/runpod/
--rw-r--r--   0 runner    (1001) docker     (127)      502 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/runpod/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      321 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/runpod/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     7905 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/runpod/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     4648 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/runpod/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.030671 skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/
--rw-r--r--   0 runner    (1001) docker     (127)      788 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.030671 skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/common/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/common/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4167 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/common/cls_api_client.py
--rw-r--r--   0 runner    (1001) docker     (127)    14096 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/common/cls_api_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)      481 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/common/custom_script.py
--rw-r--r--   0 runner    (1001) docker     (127)      303 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/common/id_generator.py
--rw-r--r--   0 runner    (1001) docker     (127)      914 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/common/metadata_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1817 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/common/service_manager.py
--rw-r--r--   0 runner    (1001) docker     (127)      544 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/common/service_manager_factory.py
--rw-r--r--   0 runner    (1001) docker     (127)      795 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/common/ssl_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)     2932 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/common/vapiconnect.py
--rw-r--r--   0 runner    (1001) docker     (127)    17877 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/common/vim_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      504 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    24488 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    15151 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/vsphere_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    65346 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/resources.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.034670 skypilot_nightly-1.0.0.dev20240516/sky/serve/
--rw-r--r--   0 runner    (1001) docker     (127)     1661 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/serve/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    30136 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/serve/autoscalers.py
--rw-r--r--   0 runner    (1001) docker     (127)     4415 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/serve/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)     8022 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/serve/controller.py
--rw-r--r--   0 runner    (1001) docker     (127)    28519 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/serve/core.py
--rw-r--r--   0 runner    (1001) docker     (127)    11548 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/serve/load_balancer.py
--rw-r--r--   0 runner    (1001) docker     (127)     2331 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/serve/load_balancing_policies.py
--rw-r--r--   0 runner    (1001) docker     (127)    56630 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/serve/replica_managers.py
--rw-r--r--   0 runner    (1001) docker     (127)    18830 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/serve/serve_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    37183 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/serve/serve_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    10931 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/serve/service.py
--rw-r--r--   0 runner    (1001) docker     (127)    13803 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/serve/service_spec.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.034670 skypilot_nightly-1.0.0.dev20240516/sky/setup_files/
--rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/setup_files/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    12055 2024-05-16 10:38:16.000000 skypilot_nightly-1.0.0.dev20240516/sky/setup_files/setup.py
--rw-r--r--   0 runner    (1001) docker     (127)     4000 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/sky_logging.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.038670 skypilot_nightly-1.0.0.dev20240516/sky/skylet/
--rw-r--r--   0 runner    (1001) docker     (127)    12381 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1963 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/attempt_skylet.py
--rw-r--r--   0 runner    (1001) docker     (127)     4478 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/autostop_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)     1887 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/configs.py
--rw-r--r--   0 runner    (1001) docker     (127)     9977 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    11759 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/events.py
--rw-r--r--   0 runner    (1001) docker     (127)    35198 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/job_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)    18824 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/log_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)     4295 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/log_lib.pyi
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.038670 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.038670 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/azure/
--rw-r--r--   0 runner    (1001) docker     (127)       97 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/azure/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4344 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/azure/azure-config-template.json
--rw-r--r--   0 runner    (1001) docker     (127)    10901 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/azure/azure-vm-template.json
--rw-r--r--   0 runner    (1001) docker     (127)     6342 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/azure/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    19215 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/azure/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)    16355 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/command_runner.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.038670 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/ibm/
--rw-r--r--   0 runner    (1001) docker     (127)       94 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/ibm/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    38280 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/ibm/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)     1292 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/ibm/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    34630 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/ibm/vpc_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.038670 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/lambda_cloud/
--rw-r--r--   0 runner    (1001) docker     (127)      112 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/lambda_cloud/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    13971 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/lambda_cloud/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.038670 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/oci/
--rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/oci/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    20492 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/oci/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)    17202 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/oci/query_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)      508 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/oci/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.042670 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/scp/
--rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/scp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4683 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/scp/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    22411 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/scp/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.042670 skypilot_nightly-1.0.0.dev20240516/sky/skylet/ray_patches/
--rw-r--r--   0 runner    (1001) docker     (127)     2761 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/ray_patches/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/ray_patches/autoscaler.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      349 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/ray_patches/cli.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      224 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/ray_patches/command_runner.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      531 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/ray_patches/log_monitor.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      658 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      289 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/ray_patches/updater.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      565 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/ray_patches/worker.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)     1153 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/skylet.py
--rw-r--r--   0 runner    (1001) docker     (127)     1348 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skylet/subprocess_daemon.py
--rw-r--r--   0 runner    (1001) docker     (127)     5734 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/skypilot_config.py
--rw-r--r--   0 runner    (1001) docker     (127)     1457 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/status_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)    47130 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/task.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.046670 skypilot_nightly-1.0.0.dev20240516/sky/templates/
--rw-r--r--   0 runner    (1001) docker     (127)     7477 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/templates/aws-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     9037 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/templates/azure-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3435 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/templates/cudo-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3465 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/templates/fluidstack-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     8880 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/templates/gcp-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     6607 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/templates/ibm-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1343 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/templates/jobs-controller.yaml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1095 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/templates/kubernetes-ingress.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)      376 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/templates/kubernetes-loadbalancer.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     2547 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/templates/kubernetes-port-forward-proxy-command.sh.j2
--rw-r--r--   0 runner    (1001) docker     (127)    15373 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/templates/kubernetes-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     2747 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/templates/kubernetes-ssh-jump.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     5676 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/templates/lambda-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1185 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/templates/local-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     6970 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/templates/oci-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3898 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/templates/paperspace-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3496 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/templates/runpod-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     5546 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/templates/scp-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1278 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/templates/sky-serve-controller.yaml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3474 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/templates/vsphere-ray.yml.j2
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.046670 skypilot_nightly-1.0.0.dev20240516/sky/usage/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/usage/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      590 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/usage/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    17601 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/usage/usage_lib.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.050670 skypilot_nightly-1.0.0.dev20240516/sky/utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     3798 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/accelerator_registry.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.050670 skypilot_nightly-1.0.0.dev20240516/sky/utils/cli_utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/cli_utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    11032 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/cli_utils/status_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      849 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/cluster_yaml_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    22168 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/command_runner.py
--rw-r--r--   0 runner    (1001) docker     (127)     4748 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/command_runner.pyi
--rw-r--r--   0 runner    (1001) docker     (127)    23848 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/common_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    34359 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/controller_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     5731 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/dag_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2786 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/db_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      861 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/env_options.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.050670 skypilot_nightly-1.0.0.dev20240516/sky/utils/kubernetes/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/kubernetes/__init__.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     9759 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/kubernetes/create_cluster.sh
--rwxr-xr-x   0 runner    (1001) docker     (127)      927 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/kubernetes/delete_cluster.sh
--rw-r--r--   0 runner    (1001) docker     (127)     3187 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/kubernetes/generate_kind_config.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     4422 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/kubernetes/generate_static_kubeconfig.sh
--rw-r--r--   0 runner    (1001) docker     (127)     6960 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/kubernetes/gpu_labeler.py
--rw-r--r--   0 runner    (1001) docker     (127)     1186 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     3812 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     6560 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py
--rw-r--r--   0 runner    (1001) docker     (127)     1384 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/kubernetes_enums.py
--rw-r--r--   0 runner    (1001) docker     (127)     8139 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/log_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     5540 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/resources_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1581 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/rich_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    22737 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/schemas.py
--rw-r--r--   0 runner    (1001) docker     (127)     6509 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/subprocess_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     3936 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/timeline.py
--rw-r--r--   0 runner    (1001) docker     (127)     3264 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/ux_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      701 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/sky/utils/validator.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.054670 skypilot_nightly-1.0.0.dev20240516/skypilot_nightly.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)    18140 2024-05-16 10:38:18.000000 skypilot_nightly-1.0.0.dev20240516/skypilot_nightly.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     9353 2024-05-16 10:38:18.000000 skypilot_nightly-1.0.0.dev20240516/skypilot_nightly.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-16 10:38:18.000000 skypilot_nightly-1.0.0.dev20240516/skypilot_nightly.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)       36 2024-05-16 10:38:18.000000 skypilot_nightly-1.0.0.dev20240516/skypilot_nightly.egg-info/entry_points.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2270 2024-05-16 10:38:18.000000 skypilot_nightly-1.0.0.dev20240516/skypilot_nightly.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (127)        4 2024-05-16 10:38:18.000000 skypilot_nightly-1.0.0.dev20240516/skypilot_nightly.egg-info/top_level.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-16 10:38:19.054670 skypilot_nightly-1.0.0.dev20240516/tests/
--rw-r--r--   0 runner    (1001) docker     (127)      171 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/tests/test_api.py
--rw-r--r--   0 runner    (1001) docker     (127)     3579 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/tests/test_cli.py
--rw-r--r--   0 runner    (1001) docker     (127)     9592 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/tests/test_config.py
--rw-r--r--   0 runner    (1001) docker     (127)      267 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/tests/test_global_user_state.py
--rw-r--r--   0 runner    (1001) docker     (127)     8789 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/tests/test_jobs.py
--rw-r--r--   0 runner    (1001) docker     (127)    17529 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/tests/test_jobs_and_serve.py
--rw-r--r--   0 runner    (1001) docker     (127)     3718 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/tests/test_list_accelerators.py
--rw-r--r--   0 runner    (1001) docker     (127)    27759 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/tests/test_optimizer_dryruns.py
--rw-r--r--   0 runner    (1001) docker     (127)     6996 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/tests/test_optimizer_random_dag.py
--rw-r--r--   0 runner    (1001) docker     (127)     1102 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/tests/test_serve_autoscaler.py
--rw-r--r--   0 runner    (1001) docker     (127)   216332 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/tests/test_smoke.py
--rw-r--r--   0 runner    (1001) docker     (127)     4048 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/tests/test_storage.py
--rw-r--r--   0 runner    (1001) docker     (127)     1070 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/tests/test_wheels.py
--rw-r--r--   0 runner    (1001) docker     (127)     3915 2024-05-16 10:38:13.000000 skypilot_nightly-1.0.0.dev20240516/tests/test_yaml_parser.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.956118 skypilot_nightly-1.0.0.dev20240517/
+-rw-r--r--   0 runner    (1001) docker     (127)    12170 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    18140 2024-05-17 10:38:10.952118 skypilot_nightly-1.0.0.dev20240517/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)    12079 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/README.md
+-rw-r--r--   0 runner    (1001) docker     (127)      640 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-17 10:38:10.956118 skypilot_nightly-1.0.0.dev20240517/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (127)    12055 2024-05-17 10:38:07.000000 skypilot_nightly-1.0.0.dev20240517/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.896118 skypilot_nightly-1.0.0.dev20240517/sky/
+-rw-r--r--   0 runner    (1001) docker     (127)     5588 2024-05-17 10:38:10.000000 skypilot_nightly-1.0.0.dev20240517/sky/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.896118 skypilot_nightly-1.0.0.dev20240517/sky/adaptors/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/adaptors/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6863 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/adaptors/aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2291 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/adaptors/azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7594 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/adaptors/cloudflare.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2354 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/adaptors/common.py
+-rw-r--r--   0 runner    (1001) docker     (127)      239 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/adaptors/cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)      468 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/adaptors/docker.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3097 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/adaptors/gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4906 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/adaptors/ibm.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4109 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/adaptors/kubernetes.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1480 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/adaptors/oci.py
+-rw-r--r--   0 runner    (1001) docker     (127)      225 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/adaptors/runpod.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2129 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/adaptors/vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21408 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/authentication.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.900118 skypilot_nightly-1.0.0.dev20240517/sky/backends/
+-rw-r--r--   0 runner    (1001) docker     (127)      536 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/backends/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5932 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/backends/backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)   125420 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/backends/backend_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)   230655 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/backends/cloud_vm_ray_backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8358 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/backends/docker_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16741 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/backends/local_docker_backend.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.900118 skypilot_nightly-1.0.0.dev20240517/sky/backends/monkey_patches/
+-rw-r--r--   0 runner    (1001) docker     (127)     3450 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/backends/monkey_patches/monkey_patch_ray_up.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7297 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/backends/wheel_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.900118 skypilot_nightly-1.0.0.dev20240517/sky/benchmark/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/benchmark/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8723 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/benchmark/benchmark_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26446 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/benchmark/benchmark_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9076 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/check.py
+-rw-r--r--   0 runner    (1001) docker     (127)   194274 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/cli.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11806 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/cloud_stores.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.904118 skypilot_nightly-1.0.0.dev20240517/sky/clouds/
+-rw-r--r--   0 runner    (1001) docker     (127)     1310 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    44608 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)    31006 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)    31817 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)      955 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/cloud_registry.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12036 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12647 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/fluidstack.py
+-rw-r--r--   0 runner    (1001) docker     (127)    48019 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21044 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/ibm.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20376 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/kubernetes.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12157 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/lambda_cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25299 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/oci.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10561 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/paperspace.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11166 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/runpod.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15546 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/scp.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.904118 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/
+-rw-r--r--   0 runner    (1001) docker     (127)    12771 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12550 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/aws_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7289 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/azure_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26837 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/common.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1793 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      411 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4335 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/cudo_catalog.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.908118 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/data_fetchers/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/data_fetchers/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22424 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11477 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5072 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3895 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22243 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4297 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21462 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5038 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/fluidstack_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24120 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/gcp_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4472 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/ibm_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4240 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/kubernetes_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5082 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/lambda_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/oci_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3768 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/paperspace_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4184 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/runpod_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5174 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/scp_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4391 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/vsphere_catalog.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.908118 skypilot_nightly-1.0.0.dev20240517/sky/clouds/utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6968 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/utils/gcp_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9991 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/utils/lambda_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4482 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/utils/oci_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15781 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/utils/scp_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11969 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/clouds/vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)    34233 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/core.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2529 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/dag.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.908118 skypilot_nightly-1.0.0.dev20240517/sky/data/
+-rw-r--r--   0 runner    (1001) docker     (127)      184 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/data/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7346 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/data/data_transfer.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21664 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/data/data_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8351 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/data/mounting_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)   118872 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/data/storage.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6867 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/data/storage_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8249 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/exceptions.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25107 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/execution.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28681 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/global_user_state.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.908118 skypilot_nightly-1.0.0.dev20240517/sky/jobs/
+-rw-r--r--   0 runner    (1001) docker     (127)     1398 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/jobs/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1350 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/jobs/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26607 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/jobs/controller.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13430 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/jobs/core.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.912118 skypilot_nightly-1.0.0.dev20240517/sky/jobs/dashboard/
+-rw-r--r--   0 runner    (1001) docker     (127)     3050 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/jobs/dashboard/dashboard.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.912118 skypilot_nightly-1.0.0.dev20240517/sky/jobs/dashboard/static/
+-rw-r--r--   0 runner    (1001) docker     (127)    15086 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/jobs/dashboard/static/favicon.ico
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.912118 skypilot_nightly-1.0.0.dev20240517/sky/jobs/dashboard/templates/
+-rw-r--r--   0 runner    (1001) docker     (127)     9837 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/jobs/dashboard/templates/index.html
+-rw-r--r--   0 runner    (1001) docker     (127)    25556 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/jobs/recovery_strategy.py
+-rw-r--r--   0 runner    (1001) docker     (127)    23041 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/jobs/state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    33067 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/jobs/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    54188 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/optimizer.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.912118 skypilot_nightly-1.0.0.dev20240517/sky/provision/
+-rw-r--r--   0 runner    (1001) docker     (127)     5951 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.912118 skypilot_nightly-1.0.0.dev20240517/sky/provision/aws/
+-rw-r--r--   0 runner    (1001) docker     (127)      731 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/aws/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22092 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/aws/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    36307 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/aws/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3238 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/aws/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.912118 skypilot_nightly-1.0.0.dev20240517/sky/provision/azure/
+-rw-r--r--   0 runner    (1001) docker     (127)      146 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/azure/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4028 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/azure/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9339 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/common.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.912118 skypilot_nightly-1.0.0.dev20240517/sky/provision/cudo/
+-rw-r--r--   0 runner    (1001) docker     (127)      676 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/cudo/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      327 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/cudo/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      696 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/cudo/cudo_machine_type.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4046 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/cudo/cudo_wrapper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8307 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/cudo/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16758 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/docker_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.916118 skypilot_nightly-1.0.0.dev20240517/sky/provision/fluidstack/
+-rw-r--r--   0 runner    (1001) docker     (127)      592 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/fluidstack/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      326 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/fluidstack/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8262 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/fluidstack/fluidstack_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14974 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/fluidstack/instance.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.916118 skypilot_nightly-1.0.0.dev20240517/sky/provision/gcp/
+-rw-r--r--   0 runner    (1001) docker     (127)      528 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/gcp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32964 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/gcp/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7234 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/gcp/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24215 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/gcp/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    59069 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/gcp/instance_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22186 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/instance_setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.916118 skypilot_nightly-1.0.0.dev20240517/sky/provision/kubernetes/
+-rw-r--r--   0 runner    (1001) docker     (127)      653 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/kubernetes/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28319 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/kubernetes/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32919 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/kubernetes/instance.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.916118 skypilot_nightly-1.0.0.dev20240517/sky/provision/kubernetes/manifests/
+-rw-r--r--   0 runner    (1001) docker     (127)      229 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/kubernetes/manifests/smarter-device-manager-configmap.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     1939 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)    10561 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/kubernetes/network.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9384 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/kubernetes/network_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    62091 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/kubernetes/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2103 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/logging.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4013 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/metadata_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.916118 skypilot_nightly-1.0.0.dev20240517/sky/provision/paperspace/
+-rw-r--r--   0 runner    (1001) docker     (127)      598 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/paperspace/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1541 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/paperspace/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      802 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/paperspace/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12045 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/paperspace/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9428 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/paperspace/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25103 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/provisioner.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.920118 skypilot_nightly-1.0.0.dev20240517/sky/provision/runpod/
+-rw-r--r--   0 runner    (1001) docker     (127)      502 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/runpod/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      321 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/runpod/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7905 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/runpod/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4648 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/runpod/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.920118 skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/
+-rw-r--r--   0 runner    (1001) docker     (127)      788 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.920118 skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/common/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/common/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4167 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/common/cls_api_client.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14096 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/common/cls_api_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)      481 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/common/custom_script.py
+-rw-r--r--   0 runner    (1001) docker     (127)      303 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/common/id_generator.py
+-rw-r--r--   0 runner    (1001) docker     (127)      914 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/common/metadata_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1817 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/common/service_manager.py
+-rw-r--r--   0 runner    (1001) docker     (127)      544 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/common/service_manager_factory.py
+-rw-r--r--   0 runner    (1001) docker     (127)      795 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/common/ssl_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2932 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/common/vapiconnect.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17877 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/common/vim_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      504 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24488 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15151 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/vsphere_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    65346 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/resources.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.924118 skypilot_nightly-1.0.0.dev20240517/sky/serve/
+-rw-r--r--   0 runner    (1001) docker     (127)     1661 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/serve/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    30136 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/serve/autoscalers.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4415 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/serve/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8022 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/serve/controller.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28710 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/serve/core.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11548 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/serve/load_balancer.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2331 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/serve/load_balancing_policies.py
+-rw-r--r--   0 runner    (1001) docker     (127)    56630 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/serve/replica_managers.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18830 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/serve/serve_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    37183 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/serve/serve_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10931 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/serve/service.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13803 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/serve/service_spec.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.924118 skypilot_nightly-1.0.0.dev20240517/sky/setup_files/
+-rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/setup_files/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    12055 2024-05-17 10:38:07.000000 skypilot_nightly-1.0.0.dev20240517/sky/setup_files/setup.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4000 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/sky_logging.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.924118 skypilot_nightly-1.0.0.dev20240517/sky/skylet/
+-rw-r--r--   0 runner    (1001) docker     (127)    12381 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1963 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/attempt_skylet.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4478 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/autostop_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1887 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/configs.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9977 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11759 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/events.py
+-rw-r--r--   0 runner    (1001) docker     (127)    35198 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/job_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18824 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/log_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4295 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/log_lib.pyi
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.924118 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.928118 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/azure/
+-rw-r--r--   0 runner    (1001) docker     (127)       97 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/azure/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4344 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/azure/azure-config-template.json
+-rw-r--r--   0 runner    (1001) docker     (127)    10901 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/azure/azure-vm-template.json
+-rw-r--r--   0 runner    (1001) docker     (127)     6342 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/azure/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    19215 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/azure/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16355 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/command_runner.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.928118 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/ibm/
+-rw-r--r--   0 runner    (1001) docker     (127)       94 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/ibm/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    38280 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/ibm/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1292 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/ibm/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    34630 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/ibm/vpc_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.928118 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/lambda_cloud/
+-rw-r--r--   0 runner    (1001) docker     (127)      112 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/lambda_cloud/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13971 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/lambda_cloud/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.928118 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/oci/
+-rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/oci/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20492 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/oci/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17202 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/oci/query_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)      508 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/oci/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.928118 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/scp/
+-rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/scp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4683 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/scp/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22411 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/scp/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.928118 skypilot_nightly-1.0.0.dev20240517/sky/skylet/ray_patches/
+-rw-r--r--   0 runner    (1001) docker     (127)     2761 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/ray_patches/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/ray_patches/autoscaler.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      349 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/ray_patches/cli.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      224 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/ray_patches/command_runner.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      531 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/ray_patches/log_monitor.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      658 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      289 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/ray_patches/updater.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      565 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/ray_patches/worker.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)     1153 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/skylet.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1348 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skylet/subprocess_daemon.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5734 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/skypilot_config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1457 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/status_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)    47807 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/task.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.932118 skypilot_nightly-1.0.0.dev20240517/sky/templates/
+-rw-r--r--   0 runner    (1001) docker     (127)     7477 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/templates/aws-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     9037 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/templates/azure-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3435 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/templates/cudo-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3465 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/templates/fluidstack-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     8880 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/templates/gcp-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     6607 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/templates/ibm-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1343 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/templates/jobs-controller.yaml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1095 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/templates/kubernetes-ingress.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)      376 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/templates/kubernetes-loadbalancer.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     2547 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/templates/kubernetes-port-forward-proxy-command.sh.j2
+-rw-r--r--   0 runner    (1001) docker     (127)    15373 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/templates/kubernetes-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     2747 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/templates/kubernetes-ssh-jump.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     5676 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/templates/lambda-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1185 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/templates/local-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     6970 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/templates/oci-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3898 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/templates/paperspace-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3496 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/templates/runpod-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     5546 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/templates/scp-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1278 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/templates/sky-serve-controller.yaml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3474 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/templates/vsphere-ray.yml.j2
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.932118 skypilot_nightly-1.0.0.dev20240517/sky/usage/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/usage/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      590 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/usage/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17601 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/usage/usage_lib.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.936118 skypilot_nightly-1.0.0.dev20240517/sky/utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3798 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/accelerator_registry.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.936118 skypilot_nightly-1.0.0.dev20240517/sky/utils/cli_utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/cli_utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11032 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/cli_utils/status_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      849 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/cluster_yaml_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22168 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/command_runner.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4748 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/command_runner.pyi
+-rw-r--r--   0 runner    (1001) docker     (127)    23848 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/common_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    34359 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/controller_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5731 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/dag_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2786 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/db_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      861 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/env_options.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.940118 skypilot_nightly-1.0.0.dev20240517/sky/utils/kubernetes/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/kubernetes/__init__.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     9759 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/kubernetes/create_cluster.sh
+-rwxr-xr-x   0 runner    (1001) docker     (127)      927 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/kubernetes/delete_cluster.sh
+-rw-r--r--   0 runner    (1001) docker     (127)     3187 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/kubernetes/generate_kind_config.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     4422 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/kubernetes/generate_static_kubeconfig.sh
+-rw-r--r--   0 runner    (1001) docker     (127)     6960 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/kubernetes/gpu_labeler.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1186 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     3812 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     6560 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1384 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/kubernetes_enums.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8139 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/log_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5540 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/resources_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1581 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/rich_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    23115 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/schemas.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6509 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/subprocess_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3936 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/timeline.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3264 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/ux_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      701 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/sky/utils/validator.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.944118 skypilot_nightly-1.0.0.dev20240517/skypilot_nightly.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)    18140 2024-05-17 10:38:10.000000 skypilot_nightly-1.0.0.dev20240517/skypilot_nightly.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     9353 2024-05-17 10:38:10.000000 skypilot_nightly-1.0.0.dev20240517/skypilot_nightly.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-17 10:38:10.000000 skypilot_nightly-1.0.0.dev20240517/skypilot_nightly.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       36 2024-05-17 10:38:10.000000 skypilot_nightly-1.0.0.dev20240517/skypilot_nightly.egg-info/entry_points.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2270 2024-05-17 10:38:10.000000 skypilot_nightly-1.0.0.dev20240517/skypilot_nightly.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        4 2024-05-17 10:38:10.000000 skypilot_nightly-1.0.0.dev20240517/skypilot_nightly.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-17 10:38:10.944118 skypilot_nightly-1.0.0.dev20240517/tests/
+-rw-r--r--   0 runner    (1001) docker     (127)      171 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/tests/test_api.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3579 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/tests/test_cli.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9592 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/tests/test_config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      267 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/tests/test_global_user_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8789 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/tests/test_jobs.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17649 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/tests/test_jobs_and_serve.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3718 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/tests/test_list_accelerators.py
+-rw-r--r--   0 runner    (1001) docker     (127)    27759 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/tests/test_optimizer_dryruns.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6996 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/tests/test_optimizer_random_dag.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1102 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/tests/test_serve_autoscaler.py
+-rw-r--r--   0 runner    (1001) docker     (127)   216733 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/tests/test_smoke.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4048 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/tests/test_storage.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1070 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/tests/test_wheels.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4279 2024-05-17 10:38:05.000000 skypilot_nightly-1.0.0.dev20240517/tests/test_yaml_parser.py
```

### Comparing `skypilot_nightly-1.0.0.dev20240516/LICENSE` & `skypilot_nightly-1.0.0.dev20240517/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/MANIFEST.in` & `skypilot_nightly-1.0.0.dev20240517/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/PKG-INFO` & `skypilot_nightly-1.0.0.dev20240517/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot-nightly
-Version: 1.0.0.dev20240516
+Version: 1.0.0.dev20240517
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
```

### Comparing `skypilot_nightly-1.0.0.dev20240516/README.md` & `skypilot_nightly-1.0.0.dev20240517/README.md`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/pyproject.toml` & `skypilot_nightly-1.0.0.dev20240517/pyproject.toml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/setup.py` & `skypilot_nightly-1.0.0.dev20240517/setup.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/__init__.py` & `skypilot_nightly-1.0.0.dev20240517/sky/__init__.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,15 +1,15 @@
 """The SkyPilot package."""
 import os
 import subprocess
 from typing import Optional
 import urllib.request
 
 # Replaced with the current commit when building the wheels.
-_SKYPILOT_COMMIT_SHA = 'f24425c62299170d377268e91fee8a8fb5d43b12'
+_SKYPILOT_COMMIT_SHA = '6968be534782a768e8440ba967f0a30ceb46c042'
 
 
 def _get_git_commit():
     if 'SKYPILOT_COMMIT_SHA' not in _SKYPILOT_COMMIT_SHA:
         # This is a release build, so we don't need to get the commit hash from
         # git, as it's already been set.
         return _SKYPILOT_COMMIT_SHA
@@ -31,15 +31,15 @@
             commit_hash += '-dirty'
         return commit_hash
     except Exception:  # pylint: disable=broad-except
         return _SKYPILOT_COMMIT_SHA
 
 
 __commit__ = _get_git_commit()
-__version__ = '1.0.0.dev20240516'
+__version__ = '1.0.0.dev20240517'
 __root_dir__ = os.path.dirname(os.path.abspath(__file__))
 
 
 # ---------------------- Proxy Configuration ---------------------- #
 def _set_http_proxy_env_vars() -> None:
     urllib_proxies = dict(urllib.request.getproxies())
```

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/adaptors/aws.py` & `skypilot_nightly-1.0.0.dev20240517/sky/adaptors/aws.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/adaptors/azure.py` & `skypilot_nightly-1.0.0.dev20240517/sky/adaptors/azure.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/adaptors/cloudflare.py` & `skypilot_nightly-1.0.0.dev20240517/sky/adaptors/cloudflare.py`

 * *Files 1% similar despite different names*

```diff
@@ -19,14 +19,15 @@
 
 _session_creation_lock = threading.RLock()
 ACCOUNT_ID_PATH = '~/.cloudflare/accountid'
 R2_CREDENTIALS_PATH = '~/.cloudflare/r2.credentials'
 R2_PROFILE_NAME = 'r2'
 _INDENT_PREFIX = '    '
 NAME = 'Cloudflare'
+SKY_CHECK_NAME = 'Cloudflare (for R2 object store)'
 
 
 @contextlib.contextmanager
 def _load_r2_credentials_env():
     """Context manager to temporarily change the AWS credentials file path."""
     prev_credentials_path = os.environ.get('AWS_SHARED_CREDENTIALS_FILE')
     os.environ['AWS_SHARED_CREDENTIALS_FILE'] = R2_CREDENTIALS_PATH
```

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/adaptors/common.py` & `skypilot_nightly-1.0.0.dev20240517/sky/adaptors/common.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/adaptors/gcp.py` & `skypilot_nightly-1.0.0.dev20240517/sky/adaptors/gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/adaptors/ibm.py` & `skypilot_nightly-1.0.0.dev20240517/sky/adaptors/ibm.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/adaptors/kubernetes.py` & `skypilot_nightly-1.0.0.dev20240517/sky/adaptors/kubernetes.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/adaptors/oci.py` & `skypilot_nightly-1.0.0.dev20240517/sky/adaptors/oci.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/adaptors/vsphere.py` & `skypilot_nightly-1.0.0.dev20240517/sky/adaptors/vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/authentication.py` & `skypilot_nightly-1.0.0.dev20240517/sky/authentication.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/backends/__init__.py` & `skypilot_nightly-1.0.0.dev20240517/sky/backends/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/backends/backend.py` & `skypilot_nightly-1.0.0.dev20240517/sky/backends/backend.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/backends/backend_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/backends/backend_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/backends/cloud_vm_ray_backend.py` & `skypilot_nightly-1.0.0.dev20240517/sky/backends/cloud_vm_ray_backend.py`

 * *Files 0% similar despite different names*

```diff
@@ -2007,18 +2007,18 @@
                 common_utils.check_cluster_name_is_valid(cluster_name)
                 if dryrun:
                     cloud_user = None
                 else:
                     cloud_user = to_provision.cloud.get_current_user_identity()
 
                 requested_features = self._requested_features.copy()
-                # Skip stop feature for Kubernetes jobs controller.
+                # Skip stop feature for Kubernetes controllers.
                 if (isinstance(to_provision.cloud, clouds.Kubernetes) and
                         controller_utils.Controllers.from_name(cluster_name)
-                        == controller_utils.Controllers.JOBS_CONTROLLER):
+                        is not None):
                     assert (clouds.CloudImplementationFeatures.STOP
                             in requested_features), requested_features
                     requested_features.remove(
                         clouds.CloudImplementationFeatures.STOP)
 
                 # Skip if to_provision.cloud does not support requested features
                 to_provision.cloud.check_features_are_supported(
@@ -4148,19 +4148,18 @@
                      stream_logs: bool = True) -> None:
         # The core.autostop() function should have already checked that the
         # cloud and resources support requested autostop.
         if idle_minutes_to_autostop is not None:
             # Skip auto-stop for Kubernetes clusters.
             if (isinstance(handle.launched_resources.cloud, clouds.Kubernetes)
                     and not down and idle_minutes_to_autostop >= 0):
-                # We should hit this code path only for the jobs controller on
+                # We should hit this code path only for the controllers on
                 # Kubernetes clusters.
                 assert (controller_utils.Controllers.from_name(
-                    handle.cluster_name) == controller_utils.Controllers.
-                        JOBS_CONTROLLER), handle.cluster_name
+                    handle.cluster_name) is not None), handle.cluster_name
                 logger.info('Auto-stop is not supported for Kubernetes '
                             'clusters. Skipping.')
                 return
 
             # Check if we're stopping spot
             assert (handle.launched_resources is not None and
                     handle.launched_resources.cloud is not None), handle
```

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/backends/docker_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/backends/docker_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/backends/local_docker_backend.py` & `skypilot_nightly-1.0.0.dev20240517/sky/backends/local_docker_backend.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/backends/monkey_patches/monkey_patch_ray_up.py` & `skypilot_nightly-1.0.0.dev20240517/sky/backends/monkey_patches/monkey_patch_ray_up.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/backends/wheel_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/backends/wheel_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/benchmark/benchmark_state.py` & `skypilot_nightly-1.0.0.dev20240517/sky/benchmark/benchmark_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/benchmark/benchmark_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/benchmark/benchmark_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/check.py` & `skypilot_nightly-1.0.0.dev20240517/sky/check.py`

 * *Files 20% similar despite different names*

```diff
@@ -1,19 +1,20 @@
 """Credential checks: check cloud credentials and enable clouds."""
 import traceback
 from types import ModuleType
-from typing import Any, Dict, Iterable, List, Optional, Tuple, Union
+from typing import Dict, Iterable, List, Optional, Tuple, Union
 
 import click
 import colorama
 import rich
 
 from sky import clouds as sky_clouds
 from sky import exceptions
 from sky import global_user_state
+from sky import skypilot_config
 from sky.adaptors import cloudflare
 from sky.utils import ux_utils
 
 
 def check(
     quiet: bool = False,
     verbose: bool = False,
@@ -48,71 +49,112 @@
                     echo(f'    Activated account: {activated_account}')
             if reason is not None:
                 echo(f'    Hint: {reason}')
         else:
             disabled_clouds.append(cloud_repr)
             echo(f'    Reason: {reason}')
 
+    def get_cloud_tuple(
+            cloud_name: str) -> Tuple[str, Union[sky_clouds.Cloud, ModuleType]]:
+        # Validates cloud_name and returns a tuple of the cloud's name and
+        # the cloud object. Includes special handling for Cloudflare.
+        if cloud_name.lower().startswith('cloudflare'):
+            return cloudflare.SKY_CHECK_NAME, cloudflare
+        else:
+            cloud_obj = sky_clouds.CLOUD_REGISTRY.from_str(cloud_name)
+            assert cloud_obj is not None, f'Cloud {cloud_name!r} not found'
+            return repr(cloud_obj), cloud_obj
+
+    def get_all_clouds():
+        return tuple([repr(c) for c in sky_clouds.CLOUD_REGISTRY.values()] +
+                     [cloudflare.SKY_CHECK_NAME])
+
     if clouds is not None:
-        clouds_to_check: List[Tuple[str, Any]] = []
-        for cloud in clouds:
-            if cloud.lower() == 'cloudflare':
-                clouds_to_check.append(
-                    ('Cloudflare, for R2 object store', cloudflare))
-            else:
-                cloud_obj = sky_clouds.CLOUD_REGISTRY.from_str(cloud)
-                assert cloud_obj is not None, f'Cloud {cloud!r} not found'
-                clouds_to_check.append((repr(cloud_obj), cloud_obj))
+        cloud_list = clouds
     else:
-        clouds_to_check = [(repr(cloud_obj), cloud_obj)
-                           for cloud_obj in sky_clouds.CLOUD_REGISTRY.values()]
-        clouds_to_check.append(('Cloudflare, for R2 object store', cloudflare))
+        cloud_list = get_all_clouds()
+    clouds_to_check = [get_cloud_tuple(c) for c in cloud_list]
+
+    # Use allowed_clouds from config if it exists, otherwise check all clouds.
+    # Also validate names with get_cloud_tuple.
+    config_allowed_cloud_names = [
+        get_cloud_tuple(c)[0] for c in skypilot_config.get_nested(
+            ['allowed_clouds'], get_all_clouds())
+    ]
+    # Use disallowed_cloud_names for logging the clouds that will be disabled
+    # because they are not included in allowed_clouds in config.yaml.
+    disallowed_cloud_names = [
+        c for c in get_all_clouds() if c not in config_allowed_cloud_names
+    ]
+    # Check only the clouds which are allowed in the config.
+    clouds_to_check = [
+        c for c in clouds_to_check if c[0] in config_allowed_cloud_names
+    ]
 
     for cloud_tuple in sorted(clouds_to_check):
         check_one_cloud(cloud_tuple)
 
     # Cloudflare is not a real cloud in sky_clouds.CLOUD_REGISTRY, and should
     # not be inserted into the DB (otherwise `sky launch` and other code would
     # error out when it's trying to look it up in the registry).
     enabled_clouds_set = {
         cloud for cloud in enabled_clouds if not cloud.startswith('Cloudflare')
     }
     disabled_clouds_set = {
         cloud for cloud in disabled_clouds if not cloud.startswith('Cloudflare')
     }
+    config_allowed_clouds_set = {
+        cloud for cloud in config_allowed_cloud_names
+        if not cloud.startswith('Cloudflare')
+    }
     previously_enabled_clouds_set = {
         repr(cloud) for cloud in global_user_state.get_cached_enabled_clouds()
     }
 
-    # Determine the set of enabled clouds: previously enabled clouds + newly
-    # enabled clouds - newly disabled clouds.
-    all_enabled_clouds = ((previously_enabled_clouds_set | enabled_clouds_set) -
-                          disabled_clouds_set)
+    # Determine the set of enabled clouds: (previously enabled clouds + newly
+    # enabled clouds - newly disabled clouds) intersected with
+    # config_allowed_clouds, if specified in config.yaml.
+    # This means that if a cloud is already enabled and is not included in
+    # allowed_clouds in config.yaml, it will be disabled.
+    all_enabled_clouds = (config_allowed_clouds_set & (
+        (previously_enabled_clouds_set | enabled_clouds_set) -
+        disabled_clouds_set))
     global_user_state.set_enabled_clouds(list(all_enabled_clouds))
 
+    disallowed_clouds_hint = None
+    if disallowed_cloud_names:
+        disallowed_clouds_hint = (
+            '\nNote: The following clouds were disabled because they were not '
+            'included in allowed_clouds in ~/.sky/config.yaml: '
+            f'{", ".join([c for c in disallowed_cloud_names])}')
     if len(all_enabled_clouds) == 0:
         echo(
             click.style(
                 'No cloud is enabled. SkyPilot will not be able to run any '
                 'task. Run `sky check` for more info.',
                 fg='red',
                 bold=True))
+        if disallowed_clouds_hint:
+            echo(click.style(disallowed_clouds_hint, dim=True))
         raise SystemExit()
     else:
         clouds_arg = (' ' +
                       ' '.join(disabled_clouds) if clouds is not None else '')
         echo(
             click.style(
                 '\nTo enable a cloud, follow the hints above and rerun: ',
                 dim=True) + click.style(f'sky check{clouds_arg}', bold=True) +
             '\n' + click.style(
                 'If any problems remain, refer to detailed docs at: '
                 'https://skypilot.readthedocs.io/en/latest/getting-started/installation.html',  # pylint: disable=line-too-long
                 dim=True))
 
+        if disallowed_clouds_hint:
+            echo(click.style(disallowed_clouds_hint, dim=True))
+
         # Pretty print for UX.
         if not quiet:
             enabled_clouds_str = '\n  :heavy_check_mark: '.join(
                 [''] + sorted(all_enabled_clouds))
             rich.print('\n[green]:tada: Enabled clouds :tada:'
                        f'{enabled_clouds_str}[/green]')
```

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/cli.py` & `skypilot_nightly-1.0.0.dev20240517/sky/cli.py`

 * *Files 1% similar despite different names*

```diff
@@ -561,17 +561,18 @@
     if maybe_status is None:
         # Show the optimize log before the prompt if the cluster does not exist.
         try:
             sky_check.get_cached_enabled_clouds_or_refresh(
                 raise_if_no_cloud_access=True)
         except exceptions.NoCloudAccessError as e:
             # Catch the exception where the public cloud is not enabled, and
-            # only print the error message without the error type.
-            click.secho(e, fg='yellow')
-            sys.exit(1)
+            # make it yellow for better visibility.
+            with ux_utils.print_exception_no_traceback():
+                raise RuntimeError(f'{colorama.Fore.YELLOW}{e}'
+                                   f'{colorama.Style.RESET_ALL}') from e
         dag = sky.optimize(dag)
     task = dag.tasks[0]
 
     if handle is not None:
         backend.check_resources_fit_cluster(handle, task)
 
     confirm_shown = False
@@ -683,15 +684,15 @@
             field_value = params.pop(field, None)
             if field_value is not None:
                 click.secho(f'Override param {field}={field_value} is ignored.',
                             fg='yellow')
 
 
 def _make_task_or_dag_from_entrypoint_with_overrides(
-    entrypoint: List[str],
+    entrypoint: Tuple[str, ...],
     *,
     entrypoint_name: str = 'Task',
     name: Optional[str] = None,
     workdir: Optional[str] = None,
     cloud: Optional[str] = None,
     region: Optional[str] = None,
     zone: Optional[str] = None,
@@ -1024,15 +1025,15 @@
     type=str,
     **_get_shell_complete_args(_complete_cluster_name),
     help=('[Experimental] Clone disk from an existing cluster to launch '
           'a new one. This is useful when the new cluster needs to have '
           'the same data on the boot disk as an existing cluster.'))
 @usage_lib.entrypoint
 def launch(
-    entrypoint: List[str],
+    entrypoint: Tuple[str, ...],
     cluster: Optional[str],
     dryrun: bool,
     detach_setup: bool,
     detach_run: bool,
     backend_name: Optional[str],
     name: Optional[str],
     workdir: Optional[str],
@@ -1126,35 +1127,44 @@
                          retry_until_up=retry_until_up,
                          no_setup=no_setup,
                          clone_disk_from=clone_disk_from)
 
 
 @cli.command(cls=_DocumentedCodeCommand)
 @click.argument('cluster',
-                required=True,
+                required=False,
                 type=str,
                 **_get_shell_complete_args(_complete_cluster_name))
+@click.option(
+    '--cluster',
+    '-c',
+    'cluster_option',
+    hidden=True,
+    type=str,
+    help='This is the same as the positional argument, just for consistency.',
+    **_get_shell_complete_args(_complete_cluster_name))
 @click.argument('entrypoint',
-                required=True,
+                required=False,
                 type=str,
                 nargs=-1,
                 **_get_shell_complete_args(_complete_file_name))
 @click.option(
     '--detach-run',
     '-d',
     default=False,
     is_flag=True,
     help=('If True, as soon as a job is submitted, return from this call '
           'and do not stream execution logs.'))
 @_add_click_options(_TASK_OPTIONS_WITH_NAME + _EXTRA_RESOURCES_OPTIONS)
 @usage_lib.entrypoint
 # pylint: disable=redefined-builtin
 def exec(
-    cluster: str,
-    entrypoint: List[str],
+    cluster: Optional[str],
+    cluster_option: Optional[str],
+    entrypoint: Tuple[str, ...],
     detach_run: bool,
     name: Optional[str],
     cloud: Optional[str],
     region: Optional[str],
     zone: Optional[str],
     workdir: Optional[str],
     gpus: Optional[str],
@@ -1224,14 +1234,25 @@
       sky exec mycluster python train_cpu.py
       sky exec mycluster --gpus=V100:1 python train_gpu.py
       \b
       # Pass environment variables to the task.
       sky exec mycluster --env WANDB_API_KEY python train_gpu.py
 
     """
+    if cluster_option is None and cluster is None:
+        raise click.UsageError('Missing argument \'[CLUSTER]\' and '
+                               '\'[ENTRYPOINT]...\'')
+    if cluster_option is not None:
+        if cluster is not None:
+            entrypoint = (cluster,) + entrypoint
+        cluster = cluster_option
+    if not entrypoint:
+        raise click.UsageError('Missing argument \'[ENTRYPOINT]...\'')
+    assert cluster is not None, (cluster, cluster_option, entrypoint)
+
     env = _merge_env_vars(env_file, env)
     controller_utils.check_cluster_name_not_controller(
         cluster, operation_str='Executing task on it')
     handle = global_user_state.get_handle_from_cluster_name(cluster)
     if handle is None:
         raise click.BadParameter(f'Cluster {cluster!r} not found. '
                                  'Use `sky launch` to provision first.')
@@ -2070,24 +2091,24 @@
         click.confirm(f'Cancelling {job_identity_str}. Proceed?',
                       default=True,
                       abort=True,
                       show_default=True)
 
     try:
         core.cancel(cluster, all=all, job_ids=job_ids_to_cancel)
-    except exceptions.NotSupportedError:
+    except exceptions.NotSupportedError as e:
         controller = controller_utils.Controllers.from_name(cluster)
         assert controller is not None, cluster
-        click.echo(controller.value.decline_cancel_hint)
-        sys.exit(1)
+        with ux_utils.print_exception_no_traceback():
+            raise click.UsageError(controller.value.decline_cancel_hint) from e
     except ValueError as e:
         raise click.UsageError(str(e))
-    except exceptions.ClusterNotUpError as e:
-        click.echo(str(e))
-        sys.exit(1)
+    except exceptions.ClusterNotUpError:
+        with ux_utils.print_exception_no_traceback():
+            raise
 
 
 @cli.command(cls=_DocumentedCodeCommand)
 @click.argument('clusters',
                 nargs=-1,
                 required=False,
                 **_get_shell_complete_args(_complete_cluster_name))
@@ -2858,15 +2879,15 @@
     with progress:
         subprocess_utils.run_in_parallel(_down_or_stop, clusters)
         progress.live.transient = False
         # Make sure the progress bar not mess up the terminal.
         progress.refresh()
 
 
-@cli.command()
+@cli.command(cls=_DocumentedCodeCommand)
 @click.argument('clouds', required=False, type=str, nargs=-1)
 @click.option('--verbose',
               '-v',
               is_flag=True,
               default=False,
               help='Show the activated account for each cloud.')
 @usage_lib.entrypoint
@@ -2877,14 +2898,24 @@
     cloud is detected to be inaccessible, the reason and correction steps will
     be shown.
 
     If CLOUDS are specified, checks credentials for only those clouds.
 
     The enabled clouds are cached and form the "search space" to be considered
     for each task.
+
+    Examples:
+
+    .. code-block:: bash
+
+      # Check credentials for all supported clouds.
+      sky check
+      \b
+      # Check only specific clouds - AWS and GCP.
+      sky check aws gcp
     """
     clouds_arg = clouds if len(clouds) > 0 else None
     sky_check.check(verbose=verbose, clouds=clouds_arg)
 
 
 @cli.command()
 @click.argument('accelerator_str', required=False)
@@ -3270,14 +3301,20 @@
 @click.argument('entrypoint',
                 required=True,
                 type=str,
                 nargs=-1,
                 **_get_shell_complete_args(_complete_file_name))
 # TODO(zhwu): Add --dryrun option to test the launch command.
 @_add_click_options(_TASK_OPTIONS_WITH_NAME + _EXTRA_RESOURCES_OPTIONS)
+@click.option('--cluster',
+              '-c',
+              default=None,
+              type=str,
+              hidden=True,
+              help=('Alias for --name, the name of the spot job.'))
 @click.option('--job-recovery',
               default=None,
               type=str,
               help='Recovery strategy to use for managed jobs.')
 @click.option(
     '--detach-run',
     '-d',
@@ -3302,16 +3339,17 @@
               is_flag=True,
               default=False,
               required=False,
               help='Skip confirmation prompt.')
 @timeline.event
 @usage_lib.entrypoint
 def jobs_launch(
-    entrypoint: List[str],
+    entrypoint: Tuple[str, ...],
     name: Optional[str],
+    cluster: Optional[str],
     workdir: Optional[str],
     cloud: Optional[str],
     region: Optional[str],
     zone: Optional[str],
     gpus: Optional[str],
     cpus: Optional[str],
     memory: Optional[str],
@@ -3339,14 +3377,19 @@
     .. code-block:: bash
 
       # You can use normal task YAMLs.
       sky jobs launch task.yaml
 
       sky jobs launch 'echo hello!'
     """
+    if cluster is not None:
+        if name is not None and name != cluster:
+            raise click.UsageError('Cannot specify both --name and --cluster. '
+                                   'Use one of the flags as they are alias.')
+        name = cluster
     env = _merge_env_vars(env_file, env)
     task_or_dag = _make_task_or_dag_from_entrypoint_with_overrides(
         entrypoint,
         name=name,
         workdir=workdir,
         cloud=cloud,
         region=region,
@@ -3592,17 +3635,17 @@
         if controller:
             core.tail_logs(
                 controller_utils.Controllers.JOBS_CONTROLLER.value.cluster_name,
                 job_id=job_id,
                 follow=follow)
         else:
             managed_jobs.tail_logs(name=name, job_id=job_id, follow=follow)
-    except exceptions.ClusterNotUpError as e:
-        click.echo(e)
-        sys.exit(1)
+    except exceptions.ClusterNotUpError:
+        with ux_utils.print_exception_no_traceback():
+            raise
 
 
 @jobs.command('dashboard', cls=_DocumentedCodeCommand)
 @click.option(
     '--port',
     '-p',
     default=None,
@@ -3683,15 +3726,15 @@
 def serve():
     """SkyServe CLI (multi-region, multi-cloud serving)."""
     pass
 
 
 def _generate_task_with_service(
     service_name: str,
-    service_yaml_args: List[str],
+    service_yaml_args: Tuple[str, ...],
     workdir: Optional[str],
     cloud: Optional[str],
     region: Optional[str],
     zone: Optional[str],
     num_nodes: Optional[int],
     use_spot: Optional[bool],
     image_id: Optional[str],
@@ -3788,15 +3831,15 @@
               is_flag=True,
               default=False,
               required=False,
               help='Skip confirmation prompt.')
 @timeline.event
 @usage_lib.entrypoint
 def serve_up(
-    service_yaml: List[str],
+    service_yaml: Tuple[str, ...],
     service_name: Optional[str],
     workdir: Optional[str],
     cloud: Optional[str],
     region: Optional[str],
     zone: Optional[str],
     num_nodes: Optional[int],
     use_spot: Optional[bool],
@@ -3906,15 +3949,15 @@
               default=False,
               required=False,
               help='Skip confirmation prompt.')
 @timeline.event
 @usage_lib.entrypoint
 def serve_update(
     service_name: str,
-    service_yaml: List[str],
+    service_yaml: Tuple[str, ...],
     workdir: Optional[str],
     cloud: Optional[str],
     region: Optional[str],
     zone: Optional[str],
     num_nodes: Optional[int],
     use_spot: Optional[bool],
     image_id: Optional[str],
@@ -4252,17 +4295,17 @@
         assert replica_id is not None
         target_component = serve_lib.ServiceComponent.REPLICA
     try:
         serve_lib.tail_logs(service_name,
                             target=target_component,
                             replica_id=replica_id,
                             follow=follow)
-    except exceptions.ClusterNotUpError as e:
-        click.echo(e)
-        sys.exit(1)
+    except exceptions.ClusterNotUpError:
+        with ux_utils.print_exception_no_traceback():
+            raise
 
 
 # ==============================
 # Sky Benchmark CLIs
 # ==============================
 
 
@@ -4941,18 +4984,19 @@
     if returncode == 0:
         cluster_created = True
     elif returncode == 100:
         click.echo(f'{colorama.Fore.GREEN}Local cluster already '
                    f'exists.{style.RESET_ALL}\n'
                    'If you want to delete it instead, run: sky local down')
     else:
-        click.echo('Failed to create local cluster. '
-                   f'Full log: {log_path}'
-                   f'\nError: {style.BRIGHT}{stderr}{style.RESET_ALL}')
-        sys.exit(1)
+        with ux_utils.print_exception_no_traceback():
+            raise RuntimeError(
+                'Failed to create local cluster. '
+                f'Full log: {log_path}'
+                f'\nError: {style.BRIGHT}{stderr}{style.RESET_ALL}')
     # Run sky check
     with rich_utils.safe_status('[bold cyan]Running sky check...'):
         sky_check.check(quiet=True)
     if cluster_created:
         # Prepare completion message which shows CPU and GPU count
         # Get number of CPUs
         p = subprocess_utils.run(
@@ -5041,18 +5085,19 @@
         stderr = stderr.replace('No kind clusters found.\n', '')
 
         if returncode == 0:
             cluster_removed = True
         elif returncode == 100:
             click.echo('\nLocal cluster does not exist.')
         else:
-            click.echo('Failed to create local cluster. '
-                       f'Stdout: {stdout}'
-                       f'\nError: {style.BRIGHT}{stderr}{style.RESET_ALL}')
-            sys.exit(1)
+            with ux_utils.print_exception_no_traceback():
+                raise RuntimeError(
+                    'Failed to create local cluster. '
+                    f'Stdout: {stdout}'
+                    f'\nError: {style.BRIGHT}{stderr}{style.RESET_ALL}')
     if cluster_removed:
         # Run sky check
         with rich_utils.safe_status('[bold cyan]Running sky check...'):
             sky_check.check(quiet=True)
         click.echo(
             f'{colorama.Fore.GREEN}Local cluster removed.{style.RESET_ALL}')
```

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/cloud_stores.py` & `skypilot_nightly-1.0.0.dev20240517/sky/cloud_stores.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/__init__.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/aws.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/aws.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/azure.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/azure.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/cloud.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/cloud_registry.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/cloud_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/cudo.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/cudo.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/fluidstack.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/fluidstack.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/gcp.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/ibm.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/ibm.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/kubernetes.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/kubernetes.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/lambda_cloud.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/lambda_cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/oci.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/oci.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/paperspace.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/paperspace.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/runpod.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/runpod.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/scp.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/scp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/__init__.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/aws_catalog.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/aws_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/azure_catalog.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/azure_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/common.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/common.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/config.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/cudo_catalog.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/cudo_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/data_fetchers/fetch_aws.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/data_fetchers/fetch_aws.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/data_fetchers/fetch_azure.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/data_fetchers/fetch_azure.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/fluidstack_catalog.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/fluidstack_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/gcp_catalog.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/gcp_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/ibm_catalog.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/ibm_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/kubernetes_catalog.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/kubernetes_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/lambda_catalog.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/lambda_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/oci_catalog.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/oci_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/paperspace_catalog.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/paperspace_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/runpod_catalog.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/runpod_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/scp_catalog.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/scp_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/service_catalog/vsphere_catalog.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/service_catalog/vsphere_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/utils/gcp_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/utils/gcp_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/utils/lambda_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/utils/lambda_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/utils/oci_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/utils/oci_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/utils/scp_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/utils/scp_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/clouds/vsphere.py` & `skypilot_nightly-1.0.0.dev20240517/sky/clouds/vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/core.py` & `skypilot_nightly-1.0.0.dev20240517/sky/core.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/dag.py` & `skypilot_nightly-1.0.0.dev20240517/sky/dag.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/data/data_transfer.py` & `skypilot_nightly-1.0.0.dev20240517/sky/data/data_transfer.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/data/data_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/data/data_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/data/mounting_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/data/mounting_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/data/storage.py` & `skypilot_nightly-1.0.0.dev20240517/sky/data/storage.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/data/storage_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/data/storage_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/exceptions.py` & `skypilot_nightly-1.0.0.dev20240517/sky/exceptions.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/execution.py` & `skypilot_nightly-1.0.0.dev20240517/sky/execution.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/global_user_state.py` & `skypilot_nightly-1.0.0.dev20240517/sky/global_user_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/jobs/__init__.py` & `skypilot_nightly-1.0.0.dev20240517/sky/jobs/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/jobs/constants.py` & `skypilot_nightly-1.0.0.dev20240517/sky/jobs/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/jobs/controller.py` & `skypilot_nightly-1.0.0.dev20240517/sky/jobs/controller.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/jobs/core.py` & `skypilot_nightly-1.0.0.dev20240517/sky/jobs/core.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/jobs/dashboard/dashboard.py` & `skypilot_nightly-1.0.0.dev20240517/sky/jobs/dashboard/dashboard.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/jobs/dashboard/static/favicon.ico` & `skypilot_nightly-1.0.0.dev20240517/sky/jobs/dashboard/static/favicon.ico`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/jobs/dashboard/templates/index.html` & `skypilot_nightly-1.0.0.dev20240517/sky/jobs/dashboard/templates/index.html`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/jobs/recovery_strategy.py` & `skypilot_nightly-1.0.0.dev20240517/sky/jobs/recovery_strategy.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/jobs/state.py` & `skypilot_nightly-1.0.0.dev20240517/sky/jobs/state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/jobs/utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/jobs/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/optimizer.py` & `skypilot_nightly-1.0.0.dev20240517/sky/optimizer.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/__init__.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/aws/__init__.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/aws/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/aws/config.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/aws/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/aws/instance.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/aws/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/aws/utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/aws/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/azure/instance.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/azure/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/common.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/common.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/cudo/__init__.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/cudo/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/cudo/cudo_machine_type.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/cudo/cudo_machine_type.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/cudo/cudo_wrapper.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/cudo/cudo_wrapper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/cudo/instance.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/cudo/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/docker_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/docker_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/fluidstack/__init__.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/fluidstack/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/fluidstack/fluidstack_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/fluidstack/fluidstack_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/fluidstack/instance.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/fluidstack/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/gcp/__init__.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/gcp/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/gcp/config.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/gcp/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/gcp/constants.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/gcp/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/gcp/instance.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/gcp/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/gcp/instance_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/gcp/instance_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/instance_setup.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/instance_setup.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/kubernetes/__init__.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/kubernetes/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/kubernetes/config.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/kubernetes/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/kubernetes/instance.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/kubernetes/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/kubernetes/network.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/kubernetes/network.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/kubernetes/network_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/kubernetes/network_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/kubernetes/utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/kubernetes/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/logging.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/logging.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/metadata_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/metadata_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/paperspace/__init__.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/paperspace/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/paperspace/config.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/paperspace/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/paperspace/constants.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/paperspace/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/paperspace/instance.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/paperspace/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/paperspace/utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/paperspace/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/provisioner.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/provisioner.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/runpod/instance.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/runpod/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/runpod/utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/runpod/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/__init__.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/common/cls_api_client.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/common/cls_api_client.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/common/cls_api_helper.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/common/cls_api_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/common/metadata_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/common/metadata_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/common/service_manager.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/common/service_manager.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/common/service_manager_factory.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/common/service_manager_factory.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/common/ssl_helper.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/common/ssl_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/common/vapiconnect.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/common/vapiconnect.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/common/vim_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/common/vim_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/instance.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/provision/vsphere/vsphere_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/provision/vsphere/vsphere_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/resources.py` & `skypilot_nightly-1.0.0.dev20240517/sky/resources.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/serve/__init__.py` & `skypilot_nightly-1.0.0.dev20240517/sky/serve/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/serve/autoscalers.py` & `skypilot_nightly-1.0.0.dev20240517/sky/serve/autoscalers.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/serve/constants.py` & `skypilot_nightly-1.0.0.dev20240517/sky/serve/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/serve/controller.py` & `skypilot_nightly-1.0.0.dev20240517/sky/serve/controller.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/serve/core.py` & `skypilot_nightly-1.0.0.dev20240517/sky/serve/core.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,11 +1,11 @@
 """SkyServe core APIs."""
 import re
 import tempfile
-from typing import Any, Dict, List, Optional, Union
+from typing import Any, Dict, List, Optional, Tuple, Union
 
 import colorama
 
 import sky
 from sky import backends
 from sky import exceptions
 from sky import sky_logging
@@ -90,22 +90,27 @@
                     'Please specify the same port instead.')
 
 
 @usage_lib.entrypoint
 def up(
     task: 'sky.Task',
     service_name: Optional[str] = None,
-) -> None:
+) -> Tuple[str, str]:
     """Spin up a service.
 
     Please refer to the sky.cli.serve_up for the document.
 
     Args:
         task: sky.Task to serve up.
         service_name: Name of the service.
+
+    Returns:
+        service_name: str; The name of the service.  Same if passed in as an
+            argument.
+        endpoint: str; The service endpoint.
     """
     if service_name is None:
         service_name = serve_utils.generate_service_name()
 
     # The service name will be used as:
     # 1. controller cluster name: 'sky-serve-controller-<service_name>'
     # 2. replica cluster name: '<service_name>-<replica_id>'
@@ -182,22 +187,21 @@
         # successfully write its job id to controller service database;
         # and for all following sky.serve.up(), the controller will throw
         # an exception (name conflict detected) and exit. Therefore the
         # controller job id in database could be use as an indicator of
         # whether the service is already running. If the id is the same
         # with the current job id, we know the service is up and running
         # for the first time; otherwise it is a name conflict.
-        idle_minutes_to_autodown = constants.CONTROLLER_IDLE_MINUTES_TO_AUTOSTOP
+        idle_minutes_to_autostop = constants.CONTROLLER_IDLE_MINUTES_TO_AUTOSTOP
         controller_job_id, controller_handle = sky.launch(
             task=controller_task,
             stream_logs=False,
             cluster_name=controller_name,
             detach_run=True,
-            idle_minutes_to_autostop=idle_minutes_to_autodown,
-            down=True,
+            idle_minutes_to_autostop=idle_minutes_to_autostop,
             retry_until_up=True,
             _disable_controller_check=True,
         )
 
         style = colorama.Style
         fore = colorama.Fore
 
@@ -288,14 +292,15 @@
             f'{backend_utils.BOLD}curl {endpoint}'
             f'{backend_utils.RESET_BOLD}'
             '\n'
             f'\n{fore.GREEN}SkyServe is spinning up your service now.'
             f'{style.RESET_ALL}'
             f'\n{fore.GREEN}The replicas should be ready within a '
             f'short time.{style.RESET_ALL}')
+        return service_name, endpoint
 
 
 @usage_lib.entrypoint
 def update(
         task: 'sky.Task',
         service_name: str,
         mode: serve_utils.UpdateMode = serve_utils.DEFAULT_UPDATE_MODE) -> None:
```

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/serve/load_balancer.py` & `skypilot_nightly-1.0.0.dev20240517/sky/serve/load_balancer.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/serve/load_balancing_policies.py` & `skypilot_nightly-1.0.0.dev20240517/sky/serve/load_balancing_policies.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/serve/replica_managers.py` & `skypilot_nightly-1.0.0.dev20240517/sky/serve/replica_managers.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/serve/serve_state.py` & `skypilot_nightly-1.0.0.dev20240517/sky/serve/serve_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/serve/serve_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/serve/serve_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/serve/service.py` & `skypilot_nightly-1.0.0.dev20240517/sky/serve/service.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/serve/service_spec.py` & `skypilot_nightly-1.0.0.dev20240517/sky/serve/service_spec.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/setup_files/MANIFEST.in` & `skypilot_nightly-1.0.0.dev20240517/sky/setup_files/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/setup_files/setup.py` & `skypilot_nightly-1.0.0.dev20240517/sky/setup_files/setup.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/sky_logging.py` & `skypilot_nightly-1.0.0.dev20240517/sky/sky_logging.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/LICENSE` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/attempt_skylet.py` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/attempt_skylet.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/autostop_lib.py` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/autostop_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/configs.py` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/configs.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/constants.py` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/events.py` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/events.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/job_lib.py` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/job_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/log_lib.py` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/log_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/log_lib.pyi` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/log_lib.pyi`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/azure/azure-config-template.json` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/azure/azure-config-template.json`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/azure/azure-vm-template.json` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/azure/azure-vm-template.json`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/azure/config.py` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/azure/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/azure/node_provider.py` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/azure/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/command_runner.py` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/command_runner.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/ibm/node_provider.py` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/ibm/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/ibm/utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/ibm/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/ibm/vpc_provider.py` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/ibm/vpc_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/lambda_cloud/node_provider.py` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/lambda_cloud/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/oci/node_provider.py` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/oci/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/oci/query_helper.py` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/oci/query_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/scp/config.py` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/scp/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/providers/scp/node_provider.py` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/providers/scp/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/ray_patches/__init__.py` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/ray_patches/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/ray_patches/log_monitor.py.patch` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/ray_patches/log_monitor.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/ray_patches/resource_demand_scheduler.py.patch` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/ray_patches/resource_demand_scheduler.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/ray_patches/worker.py.patch` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/ray_patches/worker.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/skylet.py` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/skylet.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skylet/subprocess_daemon.py` & `skypilot_nightly-1.0.0.dev20240517/sky/skylet/subprocess_daemon.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/skypilot_config.py` & `skypilot_nightly-1.0.0.dev20240517/sky/skypilot_config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/status_lib.py` & `skypilot_nightly-1.0.0.dev20240517/sky/status_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/task.py` & `skypilot_nightly-1.0.0.dev20240517/sky/task.py`

 * *Files 1% similar despite different names*

```diff
@@ -349,29 +349,43 @@
         env_overrides: Optional[List[Tuple[str, str]]] = None,
     ) -> 'Task':
         # More robust handling for 'envs': explicitly convert keys and values to
         # str, since users may pass '123' as keys/values which will get parsed
         # as int causing validate_schema() to fail.
         envs = config.get('envs')
         if envs is not None and isinstance(envs, dict):
-            config['envs'] = {str(k): str(v) for k, v in envs.items()}
-
+            new_envs: Dict[str, Optional[str]] = {}
+            for k, v in envs.items():
+                if v is not None:
+                    new_envs[str(k)] = str(v)
+                else:
+                    new_envs[str(k)] = None
+            config['envs'] = new_envs
         common_utils.validate_schema(config, schemas.get_task_schema(),
                                      'Invalid task YAML: ')
         if env_overrides is not None:
             # We must override env vars before constructing the Task, because
             # the Storage object creation is eager and it (its name/source
             # fields) may depend on env vars.
             #
             # FIXME(zongheng): The eagerness / how we construct Task's from
             # entrypoint (YAML, CLI args) should be fixed.
             new_envs = config.get('envs', {})
             new_envs.update(env_overrides)
             config['envs'] = new_envs
 
+        for k, v in config.get('envs', {}).items():
+            if v is None:
+                with ux_utils.print_exception_no_traceback():
+                    raise ValueError(
+                        f'Environment variable {k!r} is None. Please set a '
+                        'value for it in task YAML or with --env flag. '
+                        f'To set it to be empty, use an empty string ({k}: "" '
+                        f'in task YAML or --env {k}="" in CLI).')
+
         # Fill in any Task.envs into file_mounts (src/dst paths, storage
         # name/source).
         if config.get('file_mounts') is not None:
             config['file_mounts'] = _fill_in_env_vars(config['file_mounts'],
                                                       config.get('envs', {}))
 
         # Fill in any Task.envs into service (e.g. MODEL_NAME).
```

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/templates/aws-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240517/sky/templates/aws-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/templates/azure-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240517/sky/templates/azure-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/templates/cudo-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240517/sky/templates/cudo-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/templates/fluidstack-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240517/sky/templates/fluidstack-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/templates/gcp-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240517/sky/templates/gcp-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/templates/ibm-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240517/sky/templates/ibm-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/templates/jobs-controller.yaml.j2` & `skypilot_nightly-1.0.0.dev20240517/sky/templates/jobs-controller.yaml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/templates/kubernetes-ingress.yml.j2` & `skypilot_nightly-1.0.0.dev20240517/sky/templates/kubernetes-ingress.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/templates/kubernetes-port-forward-proxy-command.sh.j2` & `skypilot_nightly-1.0.0.dev20240517/sky/templates/kubernetes-port-forward-proxy-command.sh.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/templates/kubernetes-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240517/sky/templates/kubernetes-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/templates/kubernetes-ssh-jump.yml.j2` & `skypilot_nightly-1.0.0.dev20240517/sky/templates/kubernetes-ssh-jump.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/templates/lambda-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240517/sky/templates/lambda-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/templates/local-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240517/sky/templates/local-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/templates/oci-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240517/sky/templates/oci-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/templates/paperspace-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240517/sky/templates/paperspace-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/templates/runpod-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240517/sky/templates/runpod-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/templates/scp-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240517/sky/templates/scp-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/templates/sky-serve-controller.yaml.j2` & `skypilot_nightly-1.0.0.dev20240517/sky/templates/sky-serve-controller.yaml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/templates/vsphere-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240517/sky/templates/vsphere-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/usage/constants.py` & `skypilot_nightly-1.0.0.dev20240517/sky/usage/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/usage/usage_lib.py` & `skypilot_nightly-1.0.0.dev20240517/sky/usage/usage_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/accelerator_registry.py` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/accelerator_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/cli_utils/status_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/cli_utils/status_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/cluster_yaml_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/cluster_yaml_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/command_runner.py` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/command_runner.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/command_runner.pyi` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/command_runner.pyi`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/common_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/common_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/controller_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/controller_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/dag_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/dag_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/db_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/db_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/env_options.py` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/env_options.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/kubernetes/create_cluster.sh` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/kubernetes/create_cluster.sh`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/kubernetes/delete_cluster.sh` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/kubernetes/delete_cluster.sh`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/kubernetes/generate_kind_config.py` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/kubernetes/generate_kind_config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/kubernetes/generate_static_kubeconfig.sh` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/kubernetes/generate_static_kubeconfig.sh`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/kubernetes/gpu_labeler.py` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/kubernetes/gpu_labeler.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/kubernetes_enums.py` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/kubernetes_enums.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/log_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/log_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/resources_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/resources_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/rich_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/rich_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/schemas.py` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/schemas.py`

 * *Files 2% similar despite different names*

```diff
@@ -398,15 +398,15 @@
             },
             'envs': {
                 'type': 'object',
                 'required': [],
                 'patternProperties': {
                     # Checks env keys are valid env var names.
                     '^[a-zA-Z_][a-zA-Z0-9_]*$': {
-                        'type': 'string'
+                        'type': ['string', 'null']
                     }
                 },
                 'additionalProperties': False,
             },
             # inputs and outputs are experimental
             'inputs': {
                 'type': 'object',
@@ -583,14 +583,15 @@
         'type': 'string'
     },
 }
 
 
 def get_config_schema():
     # pylint: disable=import-outside-toplevel
+    from sky.clouds import service_catalog
     from sky.utils import kubernetes_enums
 
     resources_schema = {
         k: v
         for k, v in get_resources_schema().items()
         # Validation may fail if $schema is included.
         if k != '$schema'
@@ -718,14 +719,24 @@
                         'type': 'string',
                     },
                 }
             },
         },
     }
 
+    allowed_clouds = {
+        # A list of cloud names that are allowed to be used
+        'type': 'array',
+        'items': {
+            'type': 'string',
+            'case_insensitive_enum':
+                (list(service_catalog.ALL_CLOUDS) + ['cloudflare'])
+        }
+    }
+
     for cloud, config in cloud_configs.items():
         if cloud == 'aws':
             config['properties'].update(_REMOTE_IDENTITY_SCHEMA_AWS)
         elif cloud == 'kubernetes':
             config['properties'].update(_REMOTE_IDENTITY_SCHEMA_KUBERNETES)
         else:
             config['properties'].update(_REMOTE_IDENTITY_SCHEMA)
@@ -734,12 +745,13 @@
         'type': 'object',
         'required': [],
         'additionalProperties': False,
         'properties': {
             'jobs': controller_resources_schema,
             'spot': controller_resources_schema,
             'serve': controller_resources_schema,
+            'allowed_clouds': allowed_clouds,
             **cloud_configs,
         },
         # Avoid spot and jobs being present at the same time.
         **_check_not_both_fields_present('spot', 'jobs')
     }
```

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/subprocess_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/subprocess_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/timeline.py` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/timeline.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/ux_utils.py` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/ux_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/sky/utils/validator.py` & `skypilot_nightly-1.0.0.dev20240517/sky/utils/validator.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/skypilot_nightly.egg-info/PKG-INFO` & `skypilot_nightly-1.0.0.dev20240517/skypilot_nightly.egg-info/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot-nightly
-Version: 1.0.0.dev20240516
+Version: 1.0.0.dev20240517
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
```

### Comparing `skypilot_nightly-1.0.0.dev20240516/skypilot_nightly.egg-info/SOURCES.txt` & `skypilot_nightly-1.0.0.dev20240517/skypilot_nightly.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/skypilot_nightly.egg-info/requires.txt` & `skypilot_nightly-1.0.0.dev20240517/skypilot_nightly.egg-info/requires.txt`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/tests/test_cli.py` & `skypilot_nightly-1.0.0.dev20240517/tests/test_cli.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/tests/test_config.py` & `skypilot_nightly-1.0.0.dev20240517/tests/test_config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/tests/test_jobs.py` & `skypilot_nightly-1.0.0.dev20240517/tests/test_jobs.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/tests/test_jobs_and_serve.py` & `skypilot_nightly-1.0.0.dev20240517/tests/test_jobs_and_serve.py`

 * *Files 1% similar despite different names*

```diff
@@ -250,15 +250,15 @@
         assert isinstance(result.exception, SystemExit)
         assert 'Aborted' in result.output
 
     def test_cancel_on_jobs_controller(self, _mock_cluster_state,
                                        _mock_jobs_controller):
         cli_runner = cli_testing.CliRunner()
         result = cli_runner.invoke(cli.cancel, [jobs.JOB_CONTROLLER_NAME, '-a'])
-        assert result.exit_code == 1
+        assert result.exit_code == click.UsageError.exit_code
         assert 'Cancelling the jobs controller\'s jobs is not allowed.' in str(
             result.output)
 
     @pytest.mark.timeout(60)
     def test_cancel(self, _mock_db_conn):
         cli_runner = cli_testing.CliRunner()
         result = cli_runner.invoke(cli.jobs_cancel, ['-a'])
@@ -268,15 +268,16 @@
 
     @pytest.mark.timeout(60)
     def test_logs(self, _mock_db_conn):
         cli_runner = cli_testing.CliRunner()
         result = cli_runner.invoke(cli.jobs_logs, ['1'])
         assert result.exit_code == 1
         assert controller_utils.Controllers.JOBS_CONTROLLER.value.default_hint_if_non_existent in str(
-            result.output), (result.exception, result.output, result.exc_info)
+            result.exception), (result.exception, result.output,
+                                result.exc_info)
 
     @pytest.mark.timeout(60)
     def test_queue(self, _mock_db_conn):
         cli_runner = cli_testing.CliRunner()
         result = cli_runner.invoke(cli.jobs_queue)
         assert result.exit_code == 0
         assert controller_utils.Controllers.JOBS_CONTROLLER.value.default_hint_if_non_existent in str(
@@ -393,15 +394,15 @@
         assert 'Aborted' in result.output
 
     def test_cancel_on_serve_controller(self, _mock_cluster_state,
                                         _mock_serve_controller):
         cli_runner = cli_testing.CliRunner()
         result = cli_runner.invoke(cli.cancel,
                                    [serve.SKY_SERVE_CONTROLLER_NAME, '-a'])
-        assert result.exit_code == 1
+        assert result.exit_code == click.UsageError.exit_code
         assert 'Cancelling the sky serve controller\'s jobs is not allowed.' in str(
             result.output)
 
     @pytest.mark.timeout(60)
     def test_down(self, _mock_db_conn):
         cli_runner = cli_testing.CliRunner()
         result = cli_runner.invoke(cli.serve_down, ['-a'])
@@ -412,15 +413,16 @@
                                          result.exc_info)
 
     @pytest.mark.timeout(60)
     def test_logs(self, _mock_db_conn):
         cli_runner = cli_testing.CliRunner()
         result = cli_runner.invoke(cli.serve_logs, ['test', '--controller'])
         assert controller_utils.Controllers.SKY_SERVE_CONTROLLER.value.default_hint_if_non_existent in str(
-            result.output), (result.exception, result.output, result.exc_info)
+            result.exception), (result.exception, result.output,
+                                result.exc_info)
 
     @pytest.mark.timeout(60)
     def test_status(self, _mock_db_conn):
         cli_runner = cli_testing.CliRunner()
         result = cli_runner.invoke(cli.serve_status)
         assert result.exit_code == 0
         assert controller_utils.Controllers.SKY_SERVE_CONTROLLER.value.default_hint_if_non_existent in str(
```

### Comparing `skypilot_nightly-1.0.0.dev20240516/tests/test_list_accelerators.py` & `skypilot_nightly-1.0.0.dev20240517/tests/test_list_accelerators.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/tests/test_optimizer_dryruns.py` & `skypilot_nightly-1.0.0.dev20240517/tests/test_optimizer_dryruns.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/tests/test_optimizer_random_dag.py` & `skypilot_nightly-1.0.0.dev20240517/tests/test_optimizer_random_dag.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/tests/test_serve_autoscaler.py` & `skypilot_nightly-1.0.0.dev20240517/tests/test_serve_autoscaler.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/tests/test_smoke.py` & `skypilot_nightly-1.0.0.dev20240517/tests/test_smoke.py`

 * *Files 1% similar despite different names*

```diff
@@ -684,12838 +684,12863 @@
 00002ab0: 6c6f 7564 207c 2067 7265 7020 2d69 207b  loud | grep -i {
 00002ac0: 6765 6e65 7269 635f 636c 6f75 647d 5c27  generic_cloud}\'
 00002ad0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
 00002ae0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
 00002af0: 2035 202d 2d73 7461 7475 7327 2c20 2023   5 --status',  #
 00002b00: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
 00002b10: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-00002b20: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-00002b30: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-00002b40: 657d 272c 0a20 2020 2020 2020 205f 6765  e}',.        _ge
-00002b50: 745f 7469 6d65 6f75 7428 6765 6e65 7269  t_timeout(generi
-00002b60: 635f 636c 6f75 6429 2c0a 2020 2020 290a  c_cloud),.    ).
-00002b70: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00002b80: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
-00002b90: 2d2d 2d2d 2d20 5465 7374 2072 6567 696f  ----- Test regio
-00002ba0: 6e20 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  n ----------.@py
-00002bb0: 7465 7374 2e6d 6172 6b2e 6177 730a 6465  test.mark.aws.de
-00002bc0: 6620 7465 7374 5f61 7773 5f72 6567 696f  f test_aws_regio
-00002bd0: 6e28 293a 0a20 2020 206e 616d 6520 3d20  n():.    name = 
-00002be0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00002bf0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00002c00: 6573 7428 0a20 2020 2020 2020 2027 6177  est(.        'aw
-00002c10: 735f 7265 6769 6f6e 272c 0a20 2020 2020  s_region',.     
-00002c20: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00002c30: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-00002c40: 202d 6320 7b6e 616d 657d 202d 2d72 6567   -c {name} --reg
-00002c50: 696f 6e20 7573 2d65 6173 742d 3220 6578  ion us-east-2 ex
-00002c60: 616d 706c 6573 2f6d 696e 696d 616c 2e79  amples/minimal.y
-00002c70: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00002c80: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-00002c90: 6d65 7d20 6578 616d 706c 6573 2f6d 696e  me} examples/min
-00002ca0: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
-00002cb0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00002cc0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
-00002cd0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
-00002ce0: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
-00002cf0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-00002d00: 6627 736b 7920 7374 6174 7573 202d 2d61  f'sky status --a
-00002d10: 6c6c 207c 2067 7265 7020 7b6e 616d 657d  ll | grep {name}
-00002d20: 207c 2067 7265 7020 7573 2d65 6173 742d   | grep us-east-
-00002d30: 3227 2c20 2023 2045 6e73 7572 6520 7468  2',  # Ensure th
-00002d40: 6520 7265 6769 6f6e 2069 7320 636f 7272  e region is corr
-00002d50: 6563 742e 0a20 2020 2020 2020 2020 2020  ect..           
-00002d60: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00002d70: 657d 205c 2765 6368 6f20 2453 4b59 5049  e} \'echo $SKYPI
-00002d80: 4c4f 545f 434c 5553 5445 525f 494e 464f  LOT_CLUSTER_INFO
-00002d90: 207c 206a 7120 2e72 6567 696f 6e20 7c20   | jq .region | 
-00002da0: 6772 6570 2075 732d 6561 7374 2d32 5c27  grep us-east-2\'
-00002db0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00002dc0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00002dd0: 2032 202d 2d73 7461 7475 7327 2c20 2023   2 --status',  #
-00002de0: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-00002df0: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-00002e00: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-00002e10: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-00002e20: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
-00002e30: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00002e40: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00002e50: 2e67 6370 0a64 6566 2074 6573 745f 6763  .gcp.def test_gc
-00002e60: 705f 7265 6769 6f6e 5f61 6e64 5f73 6572  p_region_and_ser
-00002e70: 7669 6365 5f61 6363 6f75 6e74 2829 3a0a  vice_account():.
-00002e80: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00002e90: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00002ea0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00002eb0: 2020 2020 2020 2020 2767 6370 5f72 6567          'gcp_reg
-00002ec0: 696f 6e27 2c0a 2020 2020 2020 2020 5b0a  ion',.        [.
-00002ed0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00002ee0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-00002ef0: 6e61 6d65 7d20 2d2d 7265 6769 6f6e 2075  name} --region u
-00002f00: 732d 6365 6e74 7261 6c31 202d 2d63 6c6f  s-central1 --clo
-00002f10: 7564 2067 6370 2074 6573 7473 2f74 6573  ud gcp tests/tes
-00002f20: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
-00002f30: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00002f40: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00002f50: 616d 657d 2074 6573 7473 2f74 6573 745f  ame} tests/test_
-00002f60: 7961 6d6c 732f 6d69 6e69 6d61 6c2e 7961  yamls/minimal.ya
-00002f70: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00002f80: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00002f90: 657d 2031 202d 2d73 7461 7475 7327 2c20  e} 1 --status', 
-00002fa0: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
-00002fb0: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
-00002fc0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00002fd0: 7865 6320 7b6e 616d 657d 205c 2763 7572  xec {name} \'cur
-00002fe0: 6c20 2d48 2022 4d65 7461 6461 7461 2d46  l -H "Metadata-F
-00002ff0: 6c61 766f 723a 2047 6f6f 676c 6522 2022  lavor: Google" "
-00003000: 6874 7470 3a2f 2f6d 6574 6164 6174 612e  http://metadata.
-00003010: 676f 6f67 6c65 2e69 6e74 6572 6e61 6c2f  google.internal/
-00003020: 636f 6d70 7574 654d 6574 6164 6174 612f  computeMetadata/
-00003030: 7631 2f69 6e73 7461 6e63 652f 7365 7276  v1/instance/serv
-00003040: 6963 652d 6163 636f 756e 7473 2f64 6566  ice-accounts/def
-00003050: 6175 6c74 2f69 6465 6e74 6974 793f 666f  ault/identity?fo
-00003060: 726d 6174 3d73 7461 6e64 6172 6426 6175  rmat=standard&au
-00003070: 6469 656e 6365 3d67 6370 225c 2727 2c0a  dience=gcp"\'',.
-00003080: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00003090: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
-000030a0: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-000030b0: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-000030c0: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-000030d0: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
-000030e0: 202d 2d61 6c6c 207c 2067 7265 7020 7b6e   --all | grep {n
-000030f0: 616d 657d 207c 2067 7265 7020 7573 2d63  ame} | grep us-c
-00003100: 656e 7472 616c 3127 2c20 2023 2045 6e73  entral1',  # Ens
-00003110: 7572 6520 7468 6520 7265 6769 6f6e 2069  ure the region i
-00003120: 7320 636f 7272 6563 742e 0a20 2020 2020  s correct..     
-00003130: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00003140: 6320 7b6e 616d 657d 205c 2765 6368 6f20  c {name} \'echo 
-00003150: 2453 4b59 5049 4c4f 545f 434c 5553 5445  $SKYPILOT_CLUSTE
-00003160: 525f 494e 464f 207c 206a 7120 2e72 6567  R_INFO | jq .reg
-00003170: 696f 6e20 7c20 6772 6570 2075 732d 6365  ion | grep us-ce
-00003180: 6e74 7261 6c31 5c27 272c 0a20 2020 2020  ntral1\'',.     
-00003190: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-000031a0: 7320 7b6e 616d 657d 2033 202d 2d73 7461  s {name} 3 --sta
-000031b0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-000031c0: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-000031d0: 642e 0a20 2020 2020 2020 205d 2c0a 2020  d..        ],.  
-000031e0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-000031f0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00003200: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00003210: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-00003220: 6573 742e 6d61 726b 2e69 626d 0a64 6566  est.mark.ibm.def
-00003230: 2074 6573 745f 6962 6d5f 7265 6769 6f6e   test_ibm_region
-00003240: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-00003250: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00003260: 2829 0a20 2020 2072 6567 696f 6e20 3d20  ().    region = 
-00003270: 2765 752d 6465 270a 2020 2020 7465 7374  'eu-de'.    test
-00003280: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00003290: 2027 7265 6769 6f6e 272c 0a20 2020 2020   'region',.     
-000032a0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-000032b0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-000032c0: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
-000032d0: 7564 2069 626d 202d 2d72 6567 696f 6e20  ud ibm --region 
-000032e0: 7b72 6567 696f 6e7d 2065 7861 6d70 6c65  {region} example
-000032f0: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
-00003300: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00003310: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-00003320: 2d63 6c6f 7564 2069 626d 2065 7861 6d70  -cloud ibm examp
-00003330: 6c65 732f 6d69 6e69 6d61 6c2e 7961 6d6c  les/minimal.yaml
-00003340: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00003350: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00003360: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
-00003370: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-00003380: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-00003390: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
-000033a0: 7475 7320 2d2d 616c 6c20 7c20 6772 6570  tus --all | grep
-000033b0: 207b 6e61 6d65 7d20 7c20 6772 6570 207b   {name} | grep {
-000033c0: 7265 6769 6f6e 7d27 2c20 2023 2045 6e73  region}',  # Ens
-000033d0: 7572 6520 7468 6520 7265 6769 6f6e 2069  ure the region i
-000033e0: 7320 636f 7272 6563 742e 0a20 2020 2020  s correct..     
-000033f0: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-00003400: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-00003410: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
-00003420: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00003430: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00003440: 2e61 7a75 7265 0a64 6566 2074 6573 745f  .azure.def test_
-00003450: 617a 7572 655f 7265 6769 6f6e 2829 3a0a  azure_region():.
-00003460: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00003470: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00003480: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00003490: 2020 2020 2020 2020 2761 7a75 7265 5f72          'azure_r
-000034a0: 6567 696f 6e27 2c0a 2020 2020 2020 2020  egion',.        
-000034b0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-000034c0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-000034d0: 207b 6e61 6d65 7d20 2d2d 7265 6769 6f6e   {name} --region
-000034e0: 2065 6173 7475 7332 202d 2d63 6c6f 7564   eastus2 --cloud
-000034f0: 2061 7a75 7265 2074 6573 7473 2f74 6573   azure tests/tes
-00003500: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
-00003510: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00003520: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00003530: 616d 657d 2074 6573 7473 2f74 6573 745f  ame} tests/test_
-00003540: 7961 6d6c 732f 6d69 6e69 6d61 6c2e 7961  yamls/minimal.ya
-00003550: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00003560: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00003570: 657d 2031 202d 2d73 7461 7475 7327 2c20  e} 1 --status', 
-00003580: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
-00003590: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
-000035a0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-000035b0: 7461 7475 7320 2d2d 616c 6c20 7c20 6772  tatus --all | gr
-000035c0: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
-000035d0: 2065 6173 7475 7332 272c 2020 2320 456e   eastus2',  # En
-000035e0: 7375 7265 2074 6865 2072 6567 696f 6e20  sure the region 
-000035f0: 6973 2063 6f72 7265 6374 2e0a 2020 2020  is correct..    
-00003600: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-00003610: 6563 207b 6e61 6d65 7d20 5c27 6563 686f  ec {name} \'echo
-00003620: 2024 534b 5950 494c 4f54 5f43 4c55 5354   $SKYPILOT_CLUST
-00003630: 4552 5f49 4e46 4f20 7c20 6a71 202e 7265  ER_INFO | jq .re
-00003640: 6769 6f6e 207c 2067 7265 7020 6561 7374  gion | grep east
-00003650: 7573 325c 2727 2c0a 2020 2020 2020 2020  us2\'',.        
-00003660: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00003670: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
-00003680: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-00003690: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
-000036a0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000036b0: 7920 6578 6563 207b 6e61 6d65 7d20 5c27  y exec {name} \'
-000036c0: 6563 686f 2024 534b 5950 494c 4f54 5f43  echo $SKYPILOT_C
-000036d0: 4c55 5354 4552 5f49 4e46 4f20 7c20 6a71  LUSTER_INFO | jq
-000036e0: 202e 7a6f 6e65 207c 2067 7265 7020 6e75   .zone | grep nu
-000036f0: 6c6c 5c27 272c 0a20 2020 2020 2020 2020  ll\'',.         
-00003700: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00003710: 616d 657d 2033 202d 2d73 7461 7475 7327  ame} 3 --status'
-00003720: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-00003730: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-00003740: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00003750: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00003760: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-00003770: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00003780: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-00003790: 2d2d 2d2d 2054 6573 7420 7a6f 6e65 202d  ---- Test zone -
-000037a0: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
-000037b0: 742e 6d61 726b 2e61 7773 0a64 6566 2074  t.mark.aws.def t
-000037c0: 6573 745f 6177 735f 7a6f 6e65 2829 3a0a  est_aws_zone():.
-000037d0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-000037e0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-000037f0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00003800: 2020 2020 2020 2020 2761 7773 5f7a 6f6e          'aws_zon
-00003810: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
-00003820: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00003830: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-00003840: 6d65 7d20 6578 616d 706c 6573 2f6d 696e  me} examples/min
-00003850: 696d 616c 2e79 616d 6c20 2d2d 7a6f 6e65  imal.yaml --zone
-00003860: 2075 732d 6561 7374 2d32 6227 2c0a 2020   us-east-2b',.  
-00003870: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00003880: 6578 6563 207b 6e61 6d65 7d20 6578 616d  exec {name} exam
-00003890: 706c 6573 2f6d 696e 696d 616c 2e79 616d  ples/minimal.yam
-000038a0: 6c20 2d2d 7a6f 6e65 2075 732d 6561 7374  l --zone us-east
-000038b0: 2d32 6227 2c0a 2020 2020 2020 2020 2020  -2b',.          
-000038c0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-000038d0: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-000038e0: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-000038f0: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-00003900: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00003910: 7374 6174 7573 202d 2d61 6c6c 207c 2067  status --all | g
-00003920: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-00003930: 7020 7573 2d65 6173 742d 3262 272c 2020  p us-east-2b',  
-00003940: 2320 456e 7375 7265 2074 6865 207a 6f6e  # Ensure the zon
-00003950: 6520 6973 2063 6f72 7265 6374 2e0a 2020  e is correct..  
-00003960: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00003970: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00003980: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-00003990: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-000039a0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-000039b0: 6172 6b2e 6962 6d0a 6465 6620 7465 7374  ark.ibm.def test
-000039c0: 5f69 626d 5f7a 6f6e 6528 293a 0a20 2020  _ibm_zone():.   
-000039d0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-000039e0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-000039f0: 7a6f 6e65 203d 2027 6575 2d64 652d 3227  zone = 'eu-de-2'
-00003a00: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00003a10: 280a 2020 2020 2020 2020 277a 6f6e 6527  (.        'zone'
-00003a20: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00003a30: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00003a40: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-00003a50: 7d20 2d2d 636c 6f75 6420 6962 6d20 6578  } --cloud ibm ex
-00003a60: 616d 706c 6573 2f6d 696e 696d 616c 2e79  amples/minimal.y
-00003a70: 616d 6c20 2d2d 7a6f 6e65 207b 7a6f 6e65  aml --zone {zone
-00003a80: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-00003a90: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-00003aa0: 7d20 2d2d 636c 6f75 6420 6962 6d20 6578  } --cloud ibm ex
-00003ab0: 616d 706c 6573 2f6d 696e 696d 616c 2e79  amples/minimal.y
-00003ac0: 616d 6c20 2d2d 7a6f 6e65 207b 7a6f 6e65  aml --zone {zone
-00003ad0: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-00003ae0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00003af0: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
-00003b00: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-00003b10: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-00003b20: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-00003b30: 6174 7573 202d 2d61 6c6c 207c 2067 7265  atus --all | gre
-00003b40: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
-00003b50: 7b7a 6f6e 657d 272c 2020 2320 456e 7375  {zone}',  # Ensu
-00003b60: 7265 2074 6865 207a 6f6e 6520 6973 2063  re the zone is c
-00003b70: 6f72 7265 6374 2e0a 2020 2020 2020 2020  orrect..        
-00003b80: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-00003b90: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d20   down -y {name} 
-00003ba0: 7b6e 616d 657d 2d32 207b 6e61 6d65 7d2d  {name}-2 {name}-
-00003bb0: 3327 2c0a 2020 2020 290a 2020 2020 7275  3',.    ).    ru
-00003bc0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00003bd0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00003be0: 6763 700a 6465 6620 7465 7374 5f67 6370  gcp.def test_gcp
-00003bf0: 5f7a 6f6e 6528 293a 0a20 2020 206e 616d  _zone():.    nam
-00003c00: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00003c10: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00003c20: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00003c30: 2027 6763 705f 7a6f 6e65 272c 0a20 2020   'gcp_zone',.   
-00003c40: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00003c50: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00003c60: 2d79 202d 6320 7b6e 616d 657d 202d 2d7a  -y -c {name} --z
-00003c70: 6f6e 6520 7573 2d63 656e 7472 616c 312d  one us-central1-
-00003c80: 6120 2d2d 636c 6f75 6420 6763 7020 7465  a --cloud gcp te
-00003c90: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
-00003ca0: 696e 696d 616c 2e79 616d 6c27 2c0a 2020  inimal.yaml',.  
-00003cb0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00003cc0: 6578 6563 207b 6e61 6d65 7d20 2d2d 7a6f  exec {name} --zo
-00003cd0: 6e65 2075 732d 6365 6e74 7261 6c31 2d61  ne us-central1-a
-00003ce0: 202d 2d63 6c6f 7564 2067 6370 2074 6573   --cloud gcp tes
-00003cf0: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
-00003d00: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-00003d10: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00003d20: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-00003d30: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-00003d40: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-00003d50: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-00003d60: 2066 2773 6b79 2073 7461 7475 7320 2d2d   f'sky status --
-00003d70: 616c 6c20 7c20 6772 6570 207b 6e61 6d65  all | grep {name
-00003d80: 7d20 7c20 6772 6570 2075 732d 6365 6e74  } | grep us-cent
-00003d90: 7261 6c31 2d61 272c 2020 2320 456e 7375  ral1-a',  # Ensu
-00003da0: 7265 2074 6865 207a 6f6e 6520 6973 2063  re the zone is c
-00003db0: 6f72 7265 6374 2e0a 2020 2020 2020 2020  orrect..        
-00003dc0: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-00003dd0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-00003de0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00003df0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00003e00: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
-00003e10: 7374 2074 6865 2069 6d61 6765 202d 2d2d  st the image ---
-00003e20: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
-00003e30: 6d61 726b 2e61 7773 0a64 6566 2074 6573  mark.aws.def tes
-00003e40: 745f 6177 735f 696d 6167 6573 2829 3a0a  t_aws_images():.
-00003e50: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00003e60: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00003e70: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00003e80: 2020 2020 2020 2020 2761 7773 5f69 6d61          'aws_ima
-00003e90: 6765 7327 2c0a 2020 2020 2020 2020 5b0a  ges',.        [.
-00003ea0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00003eb0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-00003ec0: 6e61 6d65 7d20 2d2d 696d 6167 652d 6964  name} --image-id
-00003ed0: 2073 6b79 7069 6c6f 743a 6770 752d 7562   skypilot:gpu-ub
-00003ee0: 756e 7475 2d31 3830 3420 6578 616d 706c  untu-1804 exampl
-00003ef0: 6573 2f6d 696e 696d 616c 2e79 616d 6c27  es/minimal.yaml'
-00003f00: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00003f10: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00003f20: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
-00003f30: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-00003f40: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-00003f50: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00003f60: 6368 202d 6320 7b6e 616d 657d 202d 2d69  ch -c {name} --i
-00003f70: 6d61 6765 2d69 6420 736b 7970 696c 6f74  mage-id skypilot
-00003f80: 3a67 7075 2d75 6275 6e74 752d 3230 3034  :gpu-ubuntu-2004
-00003f90: 2065 7861 6d70 6c65 732f 6d69 6e69 6d61   examples/minima
-00003fa0: 6c2e 7961 6d6c 2026 2620 6578 6974 2031  l.yaml && exit 1
-00003fb0: 207c 7c20 7472 7565 272c 0a20 2020 2020   || true',.     
-00003fc0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00003fd0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-00003fe0: 2065 7861 6d70 6c65 732f 6d69 6e69 6d61   examples/minima
-00003ff0: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
-00004000: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00004010: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
-00004020: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-00004030: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00004040: 7d20 2d2d 7374 6174 7573 207c 2067 7265  } --status | gre
-00004050: 7020 224a 6f62 2032 3a20 5355 4343 4545  p "Job 2: SUCCEE
-00004060: 4445 4422 272c 2020 2320 4571 7569 7661  DED"',  # Equiva
-00004070: 6c65 6e74 2e0a 2020 2020 2020 2020 2020  lent..          
-00004080: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-00004090: 6d65 7d20 5c27 6563 686f 2024 534b 5950  me} \'echo $SKYP
-000040a0: 494c 4f54 5f43 4c55 5354 4552 5f49 4e46  ILOT_CLUSTER_INF
-000040b0: 4f20 7c20 6a71 202e 636c 6f75 6420 7c20  O | jq .cloud | 
-000040c0: 6772 6570 202d 6920 6177 735c 2727 2c0a  grep -i aws\'',.
-000040d0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000040e0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3320  y logs {name} 3 
-000040f0: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-00004100: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-00004110: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-00004120: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-00004130: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-00004140: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00004150: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00004160: 0a40 7079 7465 7374 2e6d 6172 6b2e 6763  .@pytest.mark.gc
-00004170: 700a 6465 6620 7465 7374 5f67 6370 5f69  p.def test_gcp_i
-00004180: 6d61 6765 7328 293a 0a20 2020 206e 616d  mages():.    nam
-00004190: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-000041a0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-000041b0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-000041c0: 2027 6763 705f 696d 6167 6573 272c 0a20   'gcp_images',. 
-000041d0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-000041e0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-000041f0: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
-00004200: 2d69 6d61 6765 2d69 6420 736b 7970 696c  -image-id skypil
-00004210: 6f74 3a67 7075 2d64 6562 6961 6e2d 3130  ot:gpu-debian-10
-00004220: 202d 2d63 6c6f 7564 2067 6370 2074 6573   --cloud gcp tes
-00004230: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
-00004240: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-00004250: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00004260: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-00004270: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-00004280: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-00004290: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-000042a0: 2066 2773 6b79 206c 6175 6e63 6820 2d63   f'sky launch -c
-000042b0: 207b 6e61 6d65 7d20 2d2d 696d 6167 652d   {name} --image-
-000042c0: 6964 2073 6b79 7069 6c6f 743a 6370 752d  id skypilot:cpu-
-000042d0: 6465 6269 616e 2d31 3020 2d2d 636c 6f75  debian-10 --clou
-000042e0: 6420 6763 7020 7465 7374 732f 7465 7374  d gcp tests/test
-000042f0: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
-00004300: 616d 6c20 2626 2065 7869 7420 3120 7c7c  aml && exit 1 ||
-00004310: 2074 7275 6527 2c0a 2020 2020 2020 2020   true',.        
-00004320: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00004330: 202d 7920 2d63 207b 6e61 6d65 7d20 7465   -y -c {name} te
-00004340: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
-00004350: 696e 696d 616c 2e79 616d 6c27 2c0a 2020  inimal.yaml',.  
-00004360: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00004370: 6c6f 6773 207b 6e61 6d65 7d20 3220 2d2d  logs {name} 2 --
-00004380: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-00004390: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-000043a0: 7b6e 616d 657d 202d 2d73 7461 7475 7320  {name} --status 
-000043b0: 7c20 6772 6570 2022 4a6f 6220 323a 2053  | grep "Job 2: S
-000043c0: 5543 4345 4544 4544 2227 2c20 2023 2045  UCCEEDED"',  # E
-000043d0: 7175 6976 616c 656e 742e 0a20 2020 2020  quivalent..     
-000043e0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-000043f0: 6320 7b6e 616d 657d 205c 2765 6368 6f20  c {name} \'echo 
-00004400: 2453 4b59 5049 4c4f 545f 434c 5553 5445  $SKYPILOT_CLUSTE
-00004410: 525f 494e 464f 207c 206a 7120 2e63 6c6f  R_INFO | jq .clo
-00004420: 7564 207c 2067 7265 7020 2d69 2067 6370  ud | grep -i gcp
-00004430: 5c27 272c 0a20 2020 2020 2020 2020 2020  \'',.           
-00004440: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00004450: 657d 2033 202d 2d73 7461 7475 7327 2c20  e} 3 --status', 
-00004460: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
-00004470: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
-00004480: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00004490: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-000044a0: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
-000044b0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-000044c0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-000044d0: 726b 2e61 7a75 7265 0a64 6566 2074 6573  rk.azure.def tes
-000044e0: 745f 617a 7572 655f 696d 6167 6573 2829  t_azure_images()
-000044f0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-00004500: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00004510: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00004520: 280a 2020 2020 2020 2020 2761 7a75 7265  (.        'azure
-00004530: 5f69 6d61 6765 7327 2c0a 2020 2020 2020  _images',.      
-00004540: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00004550: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00004560: 2d63 207b 6e61 6d65 7d20 2d2d 696d 6167  -c {name} --imag
-00004570: 652d 6964 2073 6b79 7069 6c6f 743a 6770  e-id skypilot:gp
-00004580: 752d 7562 756e 7475 2d32 3230 3420 2d2d  u-ubuntu-2204 --
-00004590: 636c 6f75 6420 617a 7572 6520 7465 7374  cloud azure test
-000045a0: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
-000045b0: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
-000045c0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-000045d0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
-000045e0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
-000045f0: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
-00004600: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-00004610: 6627 736b 7920 6c61 756e 6368 202d 6320  f'sky launch -c 
-00004620: 7b6e 616d 657d 202d 2d69 6d61 6765 2d69  {name} --image-i
-00004630: 6420 736b 7970 696c 6f74 3a76 312d 7562  d skypilot:v1-ub
-00004640: 756e 7475 2d32 3030 3420 2d2d 636c 6f75  untu-2004 --clou
-00004650: 6420 617a 7572 6520 7465 7374 732f 7465  d azure tests/te
-00004660: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
-00004670: 2e79 616d 6c20 2626 2065 7869 7420 3120  .yaml && exit 1 
-00004680: 7c7c 2074 7275 6527 2c0a 2020 2020 2020  || true',.      
-00004690: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-000046a0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-000046b0: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-000046c0: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
-000046d0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000046e0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
-000046f0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00004700: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00004710: 7320 7b6e 616d 657d 202d 2d73 7461 7475  s {name} --statu
-00004720: 7320 7c20 6772 6570 2022 4a6f 6220 323a  s | grep "Job 2:
-00004730: 2053 5543 4345 4544 4544 2227 2c20 2023   SUCCEEDED"',  #
-00004740: 2045 7175 6976 616c 656e 742e 0a20 2020   Equivalent..   
-00004750: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00004760: 7865 6320 7b6e 616d 657d 205c 2765 6368  xec {name} \'ech
-00004770: 6f20 2453 4b59 5049 4c4f 545f 434c 5553  o $SKYPILOT_CLUS
-00004780: 5445 525f 494e 464f 207c 206a 7120 2e63  TER_INFO | jq .c
-00004790: 6c6f 7564 207c 2067 7265 7020 2d69 2061  loud | grep -i a
-000047a0: 7a75 7265 5c27 272c 0a20 2020 2020 2020  zure\'',.       
-000047b0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-000047c0: 7b6e 616d 657d 2033 202d 2d73 7461 7475  {name} 3 --statu
-000047d0: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-000047e0: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-000047f0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00004800: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-00004810: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
-00004820: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00004830: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00004840: 742e 6d61 726b 2e61 7773 0a64 6566 2074  t.mark.aws.def t
-00004850: 6573 745f 6177 735f 696d 6167 655f 6964  est_aws_image_id
-00004860: 5f64 6963 7428 293a 0a20 2020 206e 616d  _dict():.    nam
-00004870: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00004880: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00004890: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-000048a0: 2027 6177 735f 696d 6167 655f 6964 5f64   'aws_image_id_d
-000048b0: 6963 7427 2c0a 2020 2020 2020 2020 5b0a  ict',.        [.
-000048c0: 2020 2020 2020 2020 2020 2020 2320 5573              # Us
-000048d0: 6520 696d 6167 6520 6964 2064 6963 742e  e image id dict.
-000048e0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000048f0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-00004900: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
-00004910: 7065 725f 7265 6769 6f6e 5f69 6d61 6765  per_region_image
-00004920: 732e 7961 6d6c 272c 0a20 2020 2020 2020  s.yaml',.       
-00004930: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00004940: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
-00004950: 7065 725f 7265 6769 6f6e 5f69 6d61 6765  per_region_image
-00004960: 732e 7961 6d6c 272c 0a20 2020 2020 2020  s.yaml',.       
-00004970: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00004980: 7b6e 616d 657d 2022 6c73 207e 2227 2c0a  {name} "ls ~"',.
-00004990: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000049a0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-000049b0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-000049c0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-000049d0: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
-000049e0: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
-000049f0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00004a00: 6d65 7d20 3320 2d2d 7374 6174 7573 272c  me} 3 --status',
-00004a10: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00004a20: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-00004a30: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
-00004a40: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00004a50: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00004a60: 742e 6d61 726b 2e67 6370 0a64 6566 2074  t.mark.gcp.def t
-00004a70: 6573 745f 6763 705f 696d 6167 655f 6964  est_gcp_image_id
-00004a80: 5f64 6963 7428 293a 0a20 2020 206e 616d  _dict():.    nam
-00004a90: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00004aa0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00004ab0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00004ac0: 2027 6763 705f 696d 6167 655f 6964 5f64   'gcp_image_id_d
-00004ad0: 6963 7427 2c0a 2020 2020 2020 2020 5b0a  ict',.        [.
-00004ae0: 2020 2020 2020 2020 2020 2020 2320 5573              # Us
-00004af0: 6520 696d 6167 6520 6964 2064 6963 742e  e image id dict.
-00004b00: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00004b10: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-00004b20: 7b6e 616d 657d 2074 6573 7473 2f74 6573  {name} tests/tes
-00004b30: 745f 7961 6d6c 732f 6763 705f 7065 725f  t_yamls/gcp_per_
-00004b40: 7265 6769 6f6e 5f69 6d61 6765 732e 7961  region_images.ya
-00004b50: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00004b60: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00004b70: 657d 2074 6573 7473 2f74 6573 745f 7961  e} tests/test_ya
-00004b80: 6d6c 732f 6763 705f 7065 725f 7265 6769  mls/gcp_per_regi
-00004b90: 6f6e 5f69 6d61 6765 732e 7961 6d6c 272c  on_images.yaml',
-00004ba0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00004bb0: 6b79 2065 7865 6320 7b6e 616d 657d 2022  ky exec {name} "
-00004bc0: 6c73 207e 2227 2c0a 2020 2020 2020 2020  ls ~"',.        
-00004bd0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00004be0: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
-00004bf0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00004c00: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00004c10: 2032 202d 2d73 7461 7475 7327 2c0a 2020   2 --status',.  
-00004c20: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00004c30: 6c6f 6773 207b 6e61 6d65 7d20 3320 2d2d  logs {name} 3 --
-00004c40: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-00004c50: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-00004c60: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-00004c70: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
-00004c80: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-00004c90: 0a0a 4070 7974 6573 742e 6d61 726b 2e61  ..@pytest.mark.a
-00004ca0: 7773 0a64 6566 2074 6573 745f 6177 735f  ws.def test_aws_
-00004cb0: 696d 6167 655f 6964 5f64 6963 745f 7265  image_id_dict_re
-00004cc0: 6769 6f6e 2829 3a0a 2020 2020 6e61 6d65  gion():.    name
-00004cd0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-00004ce0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-00004cf0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00004d00: 2761 7773 5f69 6d61 6765 5f69 645f 6469  'aws_image_id_di
-00004d10: 6374 5f72 6567 696f 6e27 2c0a 2020 2020  ct_region',.    
-00004d20: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00004d30: 2020 2320 5941 4d4c 2068 6173 0a20 2020    # YAML has.   
-00004d40: 2020 2020 2020 2020 2023 2020 2069 6d61           #   ima
-00004d50: 6765 5f69 643a 0a20 2020 2020 2020 2020  ge_id:.         
-00004d60: 2020 2023 2020 2020 2020 2075 732d 7765     #       us-we
-00004d70: 7374 2d32 3a20 736b 7970 696c 6f74 3a67  st-2: skypilot:g
-00004d80: 7075 2d75 6275 6e74 752d 3138 3034 0a20  pu-ubuntu-1804. 
-00004d90: 2020 2020 2020 2020 2020 2023 2020 2020             #    
-00004da0: 2020 2075 732d 6561 7374 2d32 3a20 736b     us-east-2: sk
-00004db0: 7970 696c 6f74 3a67 7075 2d75 6275 6e74  ypilot:gpu-ubunt
-00004dc0: 752d 3230 3034 0a20 2020 2020 2020 2020  u-2004.         
-00004dd0: 2020 2023 2055 7365 2072 6567 696f 6e20     # Use region 
-00004de0: 746f 2066 696c 7465 7220 696d 6167 655f  to filter image_
-00004df0: 6964 2064 6963 742e 0a20 2020 2020 2020  id dict..       
-00004e00: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00004e10: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
-00004e20: 2d72 6567 696f 6e20 7573 2d65 6173 742d  -region us-east-
-00004e30: 3120 6578 616d 706c 6573 2f70 6572 5f72  1 examples/per_r
-00004e40: 6567 696f 6e5f 696d 6167 6573 2e79 616d  egion_images.yam
-00004e50: 6c20 2626 2065 7869 7420 3120 7c7c 2074  l && exit 1 || t
-00004e60: 7275 6527 2c0a 2020 2020 2020 2020 2020  rue',.          
-00004e70: 2020 6627 736b 7920 7374 6174 7573 207c    f'sky status |
-00004e80: 2067 7265 7020 7b6e 616d 657d 2026 2620   grep {name} && 
-00004e90: 6578 6974 2031 207c 7c20 7472 7565 272c  exit 1 || true',
-00004ea0: 2020 2320 456e 7375 7265 2074 6865 2063    # Ensure the c
-00004eb0: 6c75 7374 6572 2069 7320 6e6f 7420 6372  luster is not cr
-00004ec0: 6561 7465 642e 0a20 2020 2020 2020 2020  eated..         
-00004ed0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00004ee0: 2d79 202d 6320 7b6e 616d 657d 202d 2d72  -y -c {name} --r
-00004ef0: 6567 696f 6e20 7573 2d65 6173 742d 3220  egion us-east-2 
-00004f00: 6578 616d 706c 6573 2f70 6572 5f72 6567  examples/per_reg
-00004f10: 696f 6e5f 696d 6167 6573 2e79 616d 6c27  ion_images.yaml'
-00004f20: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00004f30: 5368 6f75 6c64 2073 7563 6365 7373 2062  Should success b
-00004f40: 6563 6175 7365 2074 6865 2069 6d61 6765  ecause the image
-00004f50: 2069 6420 6d61 7463 6820 666f 7220 7468   id match for th
-00004f60: 6520 7265 6769 6f6e 2e0a 2020 2020 2020  e region..      
-00004f70: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00004f80: 6368 202d 6320 7b6e 616d 657d 202d 2d69  ch -c {name} --i
-00004f90: 6d61 6765 2d69 6420 736b 7970 696c 6f74  mage-id skypilot
-00004fa0: 3a67 7075 2d75 6275 6e74 752d 3230 3034  :gpu-ubuntu-2004
-00004fb0: 2065 7861 6d70 6c65 732f 6d69 6e69 6d61   examples/minima
-00004fc0: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
-00004fd0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00004fe0: 7b6e 616d 657d 202d 2d69 6d61 6765 2d69  {name} --image-i
-00004ff0: 6420 736b 7970 696c 6f74 3a67 7075 2d75  d skypilot:gpu-u
-00005000: 6275 6e74 752d 3230 3034 2065 7861 6d70  buntu-2004 examp
-00005010: 6c65 732f 6d69 6e69 6d61 6c2e 7961 6d6c  les/minimal.yaml
-00005020: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00005030: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00005040: 202d 2d69 6d61 6765 2d69 6420 736b 7970   --image-id skyp
-00005050: 696c 6f74 3a67 7075 2d75 6275 6e74 752d  ilot:gpu-ubuntu-
-00005060: 3138 3034 2065 7861 6d70 6c65 732f 6d69  1804 examples/mi
-00005070: 6e69 6d61 6c2e 7961 6d6c 2026 2620 6578  nimal.yaml && ex
-00005080: 6974 2031 207c 7c20 7472 7565 272c 0a20  it 1 || true',. 
-00005090: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000050a0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-000050b0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-000050c0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-000050d0: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
-000050e0: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-000050f0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00005100: 657d 2033 202d 2d73 7461 7475 7327 2c0a  e} 3 --status',.
-00005110: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00005120: 7920 7374 6174 7573 202d 2d61 6c6c 207c  y status --all |
-00005130: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-00005140: 7265 7020 7573 2d65 6173 742d 3227 2c20  rep us-east-2', 
-00005150: 2023 2045 6e73 7572 6520 7468 6520 7265   # Ensure the re
-00005160: 6769 6f6e 2069 7320 636f 7272 6563 742e  gion is correct.
-00005170: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
-00005180: 6e73 7572 6520 6578 6563 2077 6f72 6b73  nsure exec works
-00005190: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-000051a0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-000051b0: 2d2d 7265 6769 6f6e 2075 732d 6561 7374  --region us-east
-000051c0: 2d32 2065 7861 6d70 6c65 732f 7065 725f  -2 examples/per_
-000051d0: 7265 6769 6f6e 5f69 6d61 6765 732e 7961  region_images.ya
-000051e0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-000051f0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00005200: 657d 2065 7861 6d70 6c65 732f 7065 725f  e} examples/per_
-00005210: 7265 6769 6f6e 5f69 6d61 6765 732e 7961  region_images.ya
-00005220: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00005230: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00005240: 657d 202d 2d63 6c6f 7564 2061 7773 202d  e} --cloud aws -
-00005250: 2d72 6567 696f 6e20 7573 2d65 6173 742d  -region us-east-
-00005260: 3220 226c 7320 7e22 272c 0a20 2020 2020  2 "ls ~"',.     
-00005270: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00005280: 6320 7b6e 616d 657d 2022 6c73 207e 2227  c {name} "ls ~"'
-00005290: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000052a0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-000052b0: 3420 2d2d 7374 6174 7573 272c 0a20 2020  4 --status',.   
-000052c0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-000052d0: 6f67 7320 7b6e 616d 657d 2035 202d 2d73  ogs {name} 5 --s
-000052e0: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-000052f0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00005300: 6e61 6d65 7d20 3620 2d2d 7374 6174 7573  name} 6 --status
-00005310: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00005320: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00005330: 2037 202d 2d73 7461 7475 7327 2c0a 2020   7 --status',.  
-00005340: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00005350: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00005360: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-00005370: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00005380: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-00005390: 6172 6b2e 6763 700a 6465 6620 7465 7374  ark.gcp.def test
-000053a0: 5f67 6370 5f69 6d61 6765 5f69 645f 6469  _gcp_image_id_di
-000053b0: 6374 5f72 6567 696f 6e28 293a 0a20 2020  ct_region():.   
-000053c0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-000053d0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-000053e0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-000053f0: 2020 2020 2027 6763 705f 696d 6167 655f       'gcp_image_
-00005400: 6964 5f64 6963 745f 7265 6769 6f6e 272c  id_dict_region',
-00005410: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-00005420: 2020 2020 2020 2023 2055 7365 2072 6567         # Use reg
-00005430: 696f 6e20 746f 2066 696c 7465 7220 696d  ion to filter im
-00005440: 6167 655f 6964 2064 6963 742e 0a20 2020  age_id dict..   
-00005450: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00005460: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00005470: 657d 202d 2d72 6567 696f 6e20 7573 2d65  e} --region us-e
-00005480: 6173 7431 2074 6573 7473 2f74 6573 745f  ast1 tests/test_
-00005490: 7961 6d6c 732f 6763 705f 7065 725f 7265  yamls/gcp_per_re
-000054a0: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
-000054b0: 2026 2620 6578 6974 2031 207c 7c20 7472   && exit 1 || tr
-000054c0: 7565 272c 0a20 2020 2020 2020 2020 2020  ue',.           
-000054d0: 2066 2773 6b79 2073 7461 7475 7320 7c20   f'sky status | 
-000054e0: 6772 6570 207b 6e61 6d65 7d20 2626 2065  grep {name} && e
-000054f0: 7869 7420 3120 7c7c 2074 7275 6527 2c20  xit 1 || true', 
-00005500: 2023 2045 6e73 7572 6520 7468 6520 636c   # Ensure the cl
-00005510: 7573 7465 7220 6973 206e 6f74 2063 7265  uster is not cre
-00005520: 6174 6564 2e0a 2020 2020 2020 2020 2020  ated..          
-00005530: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00005540: 7920 2d63 207b 6e61 6d65 7d20 2d2d 7265  y -c {name} --re
-00005550: 6769 6f6e 2075 732d 7765 7374 3320 7465  gion us-west3 te
-00005560: 7374 732f 7465 7374 5f79 616d 6c73 2f67  sts/test_yamls/g
-00005570: 6370 5f70 6572 5f72 6567 696f 6e5f 696d  cp_per_region_im
-00005580: 6167 6573 2e79 616d 6c27 2c0a 2020 2020  ages.yaml',.    
-00005590: 2020 2020 2020 2020 2320 5368 6f75 6c64          # Should
-000055a0: 2073 7563 6365 7373 2062 6563 6175 7365   success because
-000055b0: 2074 6865 2069 6d61 6765 2069 6420 6d61   the image id ma
-000055c0: 7463 6820 666f 7220 7468 6520 7265 6769  tch for the regi
-000055d0: 6f6e 2e0a 2020 2020 2020 2020 2020 2020  on..            
-000055e0: 6627 736b 7920 6c61 756e 6368 202d 6320  f'sky launch -c 
-000055f0: 7b6e 616d 657d 202d 2d63 6c6f 7564 2067  {name} --cloud g
-00005600: 6370 202d 2d69 6d61 6765 2d69 6420 7072  cp --image-id pr
-00005610: 6f6a 6563 7473 2f75 6275 6e74 752d 6f73  ojects/ubuntu-os
-00005620: 2d63 6c6f 7564 2f67 6c6f 6261 6c2f 696d  -cloud/global/im
-00005630: 6167 6573 2f75 6275 6e74 752d 3138 3034  ages/ubuntu-1804
-00005640: 2d62 696f 6e69 632d 7632 3032 3330 3131  -bionic-v2023011
-00005650: 3220 7465 7374 732f 7465 7374 5f79 616d  2 tests/test_yam
-00005660: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
-00005670: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00005680: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-00005690: 2d2d 636c 6f75 6420 6763 7020 2d2d 696d  --cloud gcp --im
-000056a0: 6167 652d 6964 2070 726f 6a65 6374 732f  age-id projects/
-000056b0: 7562 756e 7475 2d6f 732d 636c 6f75 642f  ubuntu-os-cloud/
-000056c0: 676c 6f62 616c 2f69 6d61 6765 732f 7562  global/images/ub
-000056d0: 756e 7475 2d31 3830 342d 6269 6f6e 6963  untu-1804-bionic
-000056e0: 2d76 3230 3233 3031 3132 2074 6573 7473  -v20230112 tests
-000056f0: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
-00005700: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
-00005710: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00005720: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-00005730: 2067 6370 202d 2d69 6d61 6765 2d69 6420   gcp --image-id 
-00005740: 736b 7970 696c 6f74 3a63 7075 2d64 6562  skypilot:cpu-deb
-00005750: 6961 6e2d 3130 2074 6573 7473 2f74 6573  ian-10 tests/tes
-00005760: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
-00005770: 7961 6d6c 2026 2620 6578 6974 2031 207c  yaml && exit 1 |
-00005780: 7c20 7472 7565 272c 0a20 2020 2020 2020  | true',.       
-00005790: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-000057a0: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-000057b0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-000057c0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-000057d0: 7d20 3220 2d2d 7374 6174 7573 272c 0a20  } 2 --status',. 
-000057e0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000057f0: 206c 6f67 7320 7b6e 616d 657d 2033 202d   logs {name} 3 -
-00005800: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-00005810: 2020 2020 2020 6627 736b 7920 7374 6174        f'sky stat
-00005820: 7573 202d 2d61 6c6c 207c 2067 7265 7020  us --all | grep 
-00005830: 7b6e 616d 657d 207c 2067 7265 7020 7573  {name} | grep us
-00005840: 2d77 6573 7433 272c 2020 2320 456e 7375  -west3',  # Ensu
-00005850: 7265 2074 6865 2072 6567 696f 6e20 6973  re the region is
-00005860: 2063 6f72 7265 6374 2e0a 2020 2020 2020   correct..      
-00005870: 2020 2020 2020 2320 456e 7375 7265 2065        # Ensure e
-00005880: 7865 6320 776f 726b 732e 0a20 2020 2020  xec works..     
-00005890: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-000058a0: 6320 7b6e 616d 657d 202d 2d72 6567 696f  c {name} --regio
-000058b0: 6e20 7573 2d77 6573 7433 2074 6573 7473  n us-west3 tests
-000058c0: 2f74 6573 745f 7961 6d6c 732f 6763 705f  /test_yamls/gcp_
-000058d0: 7065 725f 7265 6769 6f6e 5f69 6d61 6765  per_region_image
-000058e0: 732e 7961 6d6c 272c 0a20 2020 2020 2020  s.yaml',.       
-000058f0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00005900: 7b6e 616d 657d 2074 6573 7473 2f74 6573  {name} tests/tes
-00005910: 745f 7961 6d6c 732f 6763 705f 7065 725f  t_yamls/gcp_per_
-00005920: 7265 6769 6f6e 5f69 6d61 6765 732e 7961  region_images.ya
-00005930: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00005940: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00005950: 657d 202d 2d63 6c6f 7564 2067 6370 202d  e} --cloud gcp -
-00005960: 2d72 6567 696f 6e20 7573 2d77 6573 7433  -region us-west3
-00005970: 2022 6c73 207e 2227 2c0a 2020 2020 2020   "ls ~"',.      
-00005980: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-00005990: 207b 6e61 6d65 7d20 226c 7320 7e22 272c   {name} "ls ~"',
-000059a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000059b0: 6b79 206c 6f67 7320 7b6e 616d 657d 2034  ky logs {name} 4
-000059c0: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-000059d0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-000059e0: 6773 207b 6e61 6d65 7d20 3520 2d2d 7374  gs {name} 5 --st
-000059f0: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
-00005a00: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00005a10: 616d 657d 2036 202d 2d73 7461 7475 7327  ame} 6 --status'
-00005a20: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00005a30: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00005a40: 3720 2d2d 7374 6174 7573 272c 0a20 2020  7 --status',.   
-00005a50: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00005a60: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-00005a70: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
-00005a80: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00005a90: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00005aa0: 726b 2e61 7773 0a64 6566 2074 6573 745f  rk.aws.def test_
-00005ab0: 6177 735f 696d 6167 655f 6964 5f64 6963  aws_image_id_dic
-00005ac0: 745f 7a6f 6e65 2829 3a0a 2020 2020 6e61  t_zone():.    na
-00005ad0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00005ae0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-00005af0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00005b00: 2020 2761 7773 5f69 6d61 6765 5f69 645f    'aws_image_id_
-00005b10: 6469 6374 5f7a 6f6e 6527 2c0a 2020 2020  dict_zone',.    
-00005b20: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00005b30: 2020 2320 5941 4d4c 2068 6173 0a20 2020    # YAML has.   
-00005b40: 2020 2020 2020 2020 2023 2020 2069 6d61           #   ima
-00005b50: 6765 5f69 643a 0a20 2020 2020 2020 2020  ge_id:.         
-00005b60: 2020 2023 2020 2020 2020 2075 732d 7765     #       us-we
-00005b70: 7374 2d32 3a20 736b 7970 696c 6f74 3a67  st-2: skypilot:g
-00005b80: 7075 2d75 6275 6e74 752d 3138 3034 0a20  pu-ubuntu-1804. 
-00005b90: 2020 2020 2020 2020 2020 2023 2020 2020             #    
-00005ba0: 2020 2075 732d 6561 7374 2d32 3a20 736b     us-east-2: sk
-00005bb0: 7970 696c 6f74 3a67 7075 2d75 6275 6e74  ypilot:gpu-ubunt
-00005bc0: 752d 3230 3034 0a20 2020 2020 2020 2020  u-2004.         
-00005bd0: 2020 2023 2055 7365 207a 6f6e 6520 746f     # Use zone to
-00005be0: 2066 696c 7465 7220 696d 6167 655f 6964   filter image_id
-00005bf0: 2064 6963 742e 0a20 2020 2020 2020 2020   dict..         
-00005c00: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00005c10: 2d79 202d 6320 7b6e 616d 657d 202d 2d7a  -y -c {name} --z
-00005c20: 6f6e 6520 7573 2d65 6173 742d 3162 2065  one us-east-1b e
-00005c30: 7861 6d70 6c65 732f 7065 725f 7265 6769  xamples/per_regi
-00005c40: 6f6e 5f69 6d61 6765 732e 7961 6d6c 2026  on_images.yaml &
-00005c50: 2620 6578 6974 2031 207c 7c20 7472 7565  & exit 1 || true
-00005c60: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00005c70: 2773 6b79 2073 7461 7475 7320 7c20 6772  'sky status | gr
-00005c80: 6570 207b 6e61 6d65 7d20 2626 2065 7869  ep {name} && exi
-00005c90: 7420 3120 7c7c 2074 7275 6527 2c20 2023  t 1 || true',  #
-00005ca0: 2045 6e73 7572 6520 7468 6520 636c 7573   Ensure the clus
-00005cb0: 7465 7220 6973 206e 6f74 2063 7265 6174  ter is not creat
-00005cc0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-00005cd0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00005ce0: 2d63 207b 6e61 6d65 7d20 2d2d 7a6f 6e65  -c {name} --zone
-00005cf0: 2075 732d 6561 7374 2d32 6120 6578 616d   us-east-2a exam
-00005d00: 706c 6573 2f70 6572 5f72 6567 696f 6e5f  ples/per_region_
-00005d10: 696d 6167 6573 2e79 616d 6c27 2c0a 2020  images.yaml',.  
-00005d20: 2020 2020 2020 2020 2020 2320 5368 6f75            # Shou
-00005d30: 6c64 2073 7563 6365 7373 2062 6563 6175  ld success becau
-00005d40: 7365 2074 6865 2069 6d61 6765 2069 6420  se the image id 
-00005d50: 6d61 7463 6820 666f 7220 7468 6520 7a6f  match for the zo
-00005d60: 6e65 2e0a 2020 2020 2020 2020 2020 2020  ne..            
-00005d70: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00005d80: 2d63 207b 6e61 6d65 7d20 2d2d 696d 6167  -c {name} --imag
-00005d90: 652d 6964 2073 6b79 7069 6c6f 743a 6770  e-id skypilot:gp
-00005da0: 752d 7562 756e 7475 2d32 3030 3420 6578  u-ubuntu-2004 ex
-00005db0: 616d 706c 6573 2f6d 696e 696d 616c 2e79  amples/minimal.y
-00005dc0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00005dd0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-00005de0: 6d65 7d20 2d2d 696d 6167 652d 6964 2073  me} --image-id s
-00005df0: 6b79 7069 6c6f 743a 6770 752d 7562 756e  kypilot:gpu-ubun
-00005e00: 7475 2d32 3030 3420 6578 616d 706c 6573  tu-2004 examples
-00005e10: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
-00005e20: 2020 2020 2020 2020 2020 2020 2320 4661              # Fa
-00005e30: 696c 2064 7565 2074 6f20 696d 6167 6520  il due to image 
-00005e40: 6964 206d 6973 6d61 7463 682e 0a20 2020  id mismatch..   
-00005e50: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00005e60: 7865 6320 7b6e 616d 657d 202d 2d69 6d61  xec {name} --ima
-00005e70: 6765 2d69 6420 736b 7970 696c 6f74 3a67  ge-id skypilot:g
-00005e80: 7075 2d75 6275 6e74 752d 3138 3034 2065  pu-ubuntu-1804 e
-00005e90: 7861 6d70 6c65 732f 6d69 6e69 6d61 6c2e  xamples/minimal.
-00005ea0: 7961 6d6c 2026 2620 6578 6974 2031 207c  yaml && exit 1 |
-00005eb0: 7c20 7472 7565 272c 0a20 2020 2020 2020  | true',.       
-00005ec0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00005ed0: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-00005ee0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-00005ef0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00005f00: 7d20 3220 2d2d 7374 6174 7573 272c 0a20  } 2 --status',. 
-00005f10: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00005f20: 206c 6f67 7320 7b6e 616d 657d 2033 202d   logs {name} 3 -
-00005f30: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-00005f40: 2020 2020 2020 6627 736b 7920 7374 6174        f'sky stat
-00005f50: 7573 202d 2d61 6c6c 207c 2067 7265 7020  us --all | grep 
-00005f60: 7b6e 616d 657d 207c 2067 7265 7020 7573  {name} | grep us
-00005f70: 2d65 6173 742d 3261 272c 2020 2320 456e  -east-2a',  # En
-00005f80: 7375 7265 2074 6865 207a 6f6e 6520 6973  sure the zone is
-00005f90: 2063 6f72 7265 6374 2e0a 2020 2020 2020   correct..      
-00005fa0: 2020 2020 2020 2320 456e 7375 7265 2065        # Ensure e
-00005fb0: 7865 6320 776f 726b 732e 0a20 2020 2020  xec works..     
-00005fc0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00005fd0: 6320 7b6e 616d 657d 202d 2d7a 6f6e 6520  c {name} --zone 
-00005fe0: 7573 2d65 6173 742d 3261 2065 7861 6d70  us-east-2a examp
-00005ff0: 6c65 732f 7065 725f 7265 6769 6f6e 5f69  les/per_region_i
-00006000: 6d61 6765 732e 7961 6d6c 272c 0a20 2020  mages.yaml',.   
-00006010: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00006020: 7865 6320 7b6e 616d 657d 2065 7861 6d70  xec {name} examp
-00006030: 6c65 732f 7065 725f 7265 6769 6f6e 5f69  les/per_region_i
-00006040: 6d61 6765 732e 7961 6d6c 272c 0a20 2020  mages.yaml',.   
-00006050: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00006060: 7865 6320 7b6e 616d 657d 202d 2d63 6c6f  xec {name} --clo
-00006070: 7564 2061 7773 202d 2d72 6567 696f 6e20  ud aws --region 
-00006080: 7573 2d65 6173 742d 3220 226c 7320 7e22  us-east-2 "ls ~"
-00006090: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000060a0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-000060b0: 2022 6c73 207e 2227 2c0a 2020 2020 2020   "ls ~"',.      
-000060c0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-000060d0: 207b 6e61 6d65 7d20 3420 2d2d 7374 6174   {name} 4 --stat
-000060e0: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-000060f0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00006100: 657d 2035 202d 2d73 7461 7475 7327 2c0a  e} 5 --status',.
-00006110: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00006120: 7920 6c6f 6773 207b 6e61 6d65 7d20 3620  y logs {name} 6 
-00006130: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00006140: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00006150: 7320 7b6e 616d 657d 2037 202d 2d73 7461  s {name} 7 --sta
-00006160: 7475 7327 2c0a 2020 2020 2020 2020 5d2c  tus',.        ],
-00006170: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-00006180: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-00006190: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-000061a0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-000061b0: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
-000061c0: 6465 6620 7465 7374 5f67 6370 5f69 6d61  def test_gcp_ima
-000061d0: 6765 5f69 645f 6469 6374 5f7a 6f6e 6528  ge_id_dict_zone(
-000061e0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-000061f0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-00006200: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-00006210: 7428 0a20 2020 2020 2020 2027 6763 705f  t(.        'gcp_
-00006220: 696d 6167 655f 6964 5f64 6963 745f 7a6f  image_id_dict_zo
-00006230: 6e65 272c 0a20 2020 2020 2020 205b 0a20  ne',.        [. 
-00006240: 2020 2020 2020 2020 2020 2023 2055 7365             # Use
-00006250: 207a 6f6e 6520 746f 2066 696c 7465 7220   zone to filter 
-00006260: 696d 6167 655f 6964 2064 6963 742e 0a20  image_id dict.. 
-00006270: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00006280: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00006290: 616d 657d 202d 2d7a 6f6e 6520 7573 2d65  ame} --zone us-e
-000062a0: 6173 7431 2d61 2074 6573 7473 2f74 6573  ast1-a tests/tes
-000062b0: 745f 7961 6d6c 732f 6763 705f 7065 725f  t_yamls/gcp_per_
-000062c0: 7265 6769 6f6e 5f69 6d61 6765 732e 7961  region_images.ya
-000062d0: 6d6c 2026 2620 6578 6974 2031 207c 7c20  ml && exit 1 || 
-000062e0: 7472 7565 272c 0a20 2020 2020 2020 2020  true',.         
-000062f0: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
-00006300: 7c20 6772 6570 207b 6e61 6d65 7d20 2626  | grep {name} &&
-00006310: 2065 7869 7420 3120 7c7c 2074 7275 6527   exit 1 || true'
-00006320: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-00006330: 636c 7573 7465 7220 6973 206e 6f74 2063  cluster is not c
-00006340: 7265 6174 6564 2e0a 2020 2020 2020 2020  reated..        
-00006350: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00006360: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
-00006370: 7a6f 6e65 2075 732d 6365 6e74 7261 6c31  zone us-central1
-00006380: 2d61 2074 6573 7473 2f74 6573 745f 7961  -a tests/test_ya
-00006390: 6d6c 732f 6763 705f 7065 725f 7265 6769  mls/gcp_per_regi
-000063a0: 6f6e 5f69 6d61 6765 732e 7961 6d6c 272c  on_images.yaml',
-000063b0: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
-000063c0: 686f 756c 6420 7375 6363 6573 7320 6265  hould success be
-000063d0: 6361 7573 6520 7468 6520 696d 6167 6520  cause the image 
-000063e0: 6964 206d 6174 6368 2066 6f72 2074 6865  id match for the
-000063f0: 207a 6f6e 652e 0a20 2020 2020 2020 2020   zone..         
-00006400: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00006410: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
-00006420: 6c6f 7564 2067 6370 202d 2d69 6d61 6765  loud gcp --image
-00006430: 2d69 6420 736b 7970 696c 6f74 3a63 7075  -id skypilot:cpu
-00006440: 2d64 6562 6961 6e2d 3130 2074 6573 7473  -debian-10 tests
-00006450: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
-00006460: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
-00006470: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00006480: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-00006490: 2067 6370 202d 2d69 6d61 6765 2d69 6420   gcp --image-id 
-000064a0: 736b 7970 696c 6f74 3a63 7075 2d64 6562  skypilot:cpu-deb
-000064b0: 6961 6e2d 3130 2074 6573 7473 2f74 6573  ian-10 tests/tes
-000064c0: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
-000064d0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-000064e0: 2020 2023 2046 6169 6c20 6475 6520 746f     # Fail due to
-000064f0: 2069 6d61 6765 2069 6420 6d69 736d 6174   image id mismat
-00006500: 6368 2e0a 2020 2020 2020 2020 2020 2020  ch..            
-00006510: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-00006520: 7d20 2d2d 636c 6f75 6420 6763 7020 2d2d  } --cloud gcp --
-00006530: 696d 6167 652d 6964 2073 6b79 7069 6c6f  image-id skypilo
-00006540: 743a 6770 752d 6465 6269 616e 2d31 3020  t:gpu-debian-10 
-00006550: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-00006560: 2f6d 696e 696d 616c 2e79 616d 6c20 2626  /minimal.yaml &&
-00006570: 2065 7869 7420 3120 7c7c 2074 7275 6527   exit 1 || true'
-00006580: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00006590: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-000065a0: 3120 2d2d 7374 6174 7573 272c 0a20 2020  1 --status',.   
-000065b0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-000065c0: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
-000065d0: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-000065e0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-000065f0: 6e61 6d65 7d20 3320 2d2d 7374 6174 7573  name} 3 --status
-00006600: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00006610: 2773 6b79 2073 7461 7475 7320 2d2d 616c  'sky status --al
-00006620: 6c20 7c20 6772 6570 207b 6e61 6d65 7d20  l | grep {name} 
-00006630: 7c20 6772 6570 2075 732d 6365 6e74 7261  | grep us-centra
-00006640: 6c31 272c 2020 2320 456e 7375 7265 2074  l1',  # Ensure t
-00006650: 6865 207a 6f6e 6520 6973 2063 6f72 7265  he zone is corre
-00006660: 6374 2e0a 2020 2020 2020 2020 2020 2020  ct..            
-00006670: 2320 456e 7375 7265 2065 7865 6320 776f  # Ensure exec wo
-00006680: 726b 732e 0a20 2020 2020 2020 2020 2020  rks..           
-00006690: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-000066a0: 657d 202d 2d63 6c6f 7564 2067 6370 202d  e} --cloud gcp -
-000066b0: 2d7a 6f6e 6520 7573 2d63 656e 7472 616c  -zone us-central
-000066c0: 312d 6120 7465 7374 732f 7465 7374 5f79  1-a tests/test_y
-000066d0: 616d 6c73 2f67 6370 5f70 6572 5f72 6567  amls/gcp_per_reg
-000066e0: 696f 6e5f 696d 6167 6573 2e79 616d 6c27  ion_images.yaml'
-000066f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00006700: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-00006710: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-00006720: 2f67 6370 5f70 6572 5f72 6567 696f 6e5f  /gcp_per_region_
-00006730: 696d 6167 6573 2e79 616d 6c27 2c0a 2020  images.yaml',.  
+00002b20: 2020 2020 2020 2023 2054 6573 7420 272d         # Test '-
+00002b30: 6327 2066 6f72 2065 7865 630a 2020 2020  c' for exec.    
+00002b40: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00002b50: 6563 202d 6320 7b6e 616d 657d 2065 6368  ec -c {name} ech
+00002b60: 6f27 2c0a 2020 2020 2020 2020 2020 2020  o',.            
+00002b70: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00002b80: 7d20 3620 2d2d 7374 6174 7573 272c 0a20  } 6 --status',. 
+00002b90: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00002ba0: 2065 7865 6320 6563 686f 202d 6320 7b6e   exec echo -c {n
+00002bb0: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
+00002bc0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00002bd0: 616d 657d 2037 202d 2d73 7461 7475 7327  ame} 7 --status'
+00002be0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00002bf0: 736b 7920 6578 6563 202d 6320 7b6e 616d  sky exec -c {nam
+00002c00: 657d 2065 6368 6f20 6869 2074 6573 7427  e} echo hi test'
+00002c10: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00002c20: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00002c30: 3820 7c20 6772 6570 2022 6869 2074 6573  8 | grep "hi tes
+00002c40: 7422 272c 0a20 2020 2020 2020 2020 2020  t"',.           
+00002c50: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+00002c60: 657d 2026 2620 6578 6974 2031 207c 7c20  e} && exit 1 || 
+00002c70: 7472 7565 272c 0a20 2020 2020 2020 2020  true',.         
+00002c80: 2020 2066 2773 6b79 2065 7865 6320 2d63     f'sky exec -c
+00002c90: 207b 6e61 6d65 7d20 2626 2065 7869 7420   {name} && exit 
+00002ca0: 3120 7c7c 2074 7275 6527 2c0a 2020 2020  1 || true',.    
+00002cb0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+00002cc0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+00002cd0: 6d65 7d27 2c0a 2020 2020 2020 2020 5f67  me}',.        _g
+00002ce0: 6574 5f74 696d 656f 7574 2867 656e 6572  et_timeout(gener
+00002cf0: 6963 5f63 6c6f 7564 292c 0a20 2020 2029  ic_cloud),.    )
+00002d00: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00002d10: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+00002d20: 2d2d 2d2d 2d2d 2054 6573 7420 7265 6769  ------ Test regi
+00002d30: 6f6e 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  on ----------.@p
+00002d40: 7974 6573 742e 6d61 726b 2e61 7773 0a64  ytest.mark.aws.d
+00002d50: 6566 2074 6573 745f 6177 735f 7265 6769  ef test_aws_regi
+00002d60: 6f6e 2829 3a0a 2020 2020 6e61 6d65 203d  on():.    name =
+00002d70: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00002d80: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00002d90: 5465 7374 280a 2020 2020 2020 2020 2761  Test(.        'a
+00002da0: 7773 5f72 6567 696f 6e27 2c0a 2020 2020  ws_region',.    
+00002db0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00002dc0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00002dd0: 7920 2d63 207b 6e61 6d65 7d20 2d2d 7265  y -c {name} --re
+00002de0: 6769 6f6e 2075 732d 6561 7374 2d32 2065  gion us-east-2 e
+00002df0: 7861 6d70 6c65 732f 6d69 6e69 6d61 6c2e  xamples/minimal.
+00002e00: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00002e10: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00002e20: 616d 657d 2065 7861 6d70 6c65 732f 6d69  ame} examples/mi
+00002e30: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
+00002e40: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00002e50: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
+00002e60: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+00002e70: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
+00002e80: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
+00002e90: 2066 2773 6b79 2073 7461 7475 7320 2d2d   f'sky status --
+00002ea0: 616c 6c20 7c20 6772 6570 207b 6e61 6d65  all | grep {name
+00002eb0: 7d20 7c20 6772 6570 2075 732d 6561 7374  } | grep us-east
+00002ec0: 2d32 272c 2020 2320 456e 7375 7265 2074  -2',  # Ensure t
+00002ed0: 6865 2072 6567 696f 6e20 6973 2063 6f72  he region is cor
+00002ee0: 7265 6374 2e0a 2020 2020 2020 2020 2020  rect..          
+00002ef0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+00002f00: 6d65 7d20 5c27 6563 686f 2024 534b 5950  me} \'echo $SKYP
+00002f10: 494c 4f54 5f43 4c55 5354 4552 5f49 4e46  ILOT_CLUSTER_INF
+00002f20: 4f20 7c20 6a71 202e 7265 6769 6f6e 207c  O | jq .region |
+00002f30: 2067 7265 7020 7573 2d65 6173 742d 325c   grep us-east-2\
+00002f40: 2727 2c0a 2020 2020 2020 2020 2020 2020  '',.            
+00002f50: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00002f60: 7d20 3220 2d2d 7374 6174 7573 272c 2020  } 2 --status',  
+00002f70: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+00002f80: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+00002f90: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+00002fa0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+00002fb0: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+00002fc0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00002fd0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00002fe0: 6b2e 6763 700a 6465 6620 7465 7374 5f67  k.gcp.def test_g
+00002ff0: 6370 5f72 6567 696f 6e5f 616e 645f 7365  cp_region_and_se
+00003000: 7276 6963 655f 6163 636f 756e 7428 293a  rvice_account():
+00003010: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00003020: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00003030: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00003040: 0a20 2020 2020 2020 2027 6763 705f 7265  .        'gcp_re
+00003050: 6769 6f6e 272c 0a20 2020 2020 2020 205b  gion',.        [
+00003060: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00003070: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00003080: 7b6e 616d 657d 202d 2d72 6567 696f 6e20  {name} --region 
+00003090: 7573 2d63 656e 7472 616c 3120 2d2d 636c  us-central1 --cl
+000030a0: 6f75 6420 6763 7020 7465 7374 732f 7465  oud gcp tests/te
+000030b0: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
+000030c0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+000030d0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+000030e0: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
+000030f0: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
+00003100: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00003110: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00003120: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+00003130: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+00003140: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+00003150: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00003160: 6578 6563 207b 6e61 6d65 7d20 5c27 6375  exec {name} \'cu
+00003170: 726c 202d 4820 224d 6574 6164 6174 612d  rl -H "Metadata-
+00003180: 466c 6176 6f72 3a20 476f 6f67 6c65 2220  Flavor: Google" 
+00003190: 2268 7474 703a 2f2f 6d65 7461 6461 7461  "http://metadata
+000031a0: 2e67 6f6f 676c 652e 696e 7465 726e 616c  .google.internal
+000031b0: 2f63 6f6d 7075 7465 4d65 7461 6461 7461  /computeMetadata
+000031c0: 2f76 312f 696e 7374 616e 6365 2f73 6572  /v1/instance/ser
+000031d0: 7669 6365 2d61 6363 6f75 6e74 732f 6465  vice-accounts/de
+000031e0: 6661 756c 742f 6964 656e 7469 7479 3f66  fault/identity?f
+000031f0: 6f72 6d61 743d 7374 616e 6461 7264 2661  ormat=standard&a
+00003200: 7564 6965 6e63 653d 6763 7022 5c27 272c  udience=gcp"\'',
+00003210: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00003220: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
+00003230: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+00003240: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+00003250: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+00003260: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
+00003270: 7320 2d2d 616c 6c20 7c20 6772 6570 207b  s --all | grep {
+00003280: 6e61 6d65 7d20 7c20 6772 6570 2075 732d  name} | grep us-
+00003290: 6365 6e74 7261 6c31 272c 2020 2320 456e  central1',  # En
+000032a0: 7375 7265 2074 6865 2072 6567 696f 6e20  sure the region 
+000032b0: 6973 2063 6f72 7265 6374 2e0a 2020 2020  is correct..    
+000032c0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+000032d0: 6563 207b 6e61 6d65 7d20 5c27 6563 686f  ec {name} \'echo
+000032e0: 2024 534b 5950 494c 4f54 5f43 4c55 5354   $SKYPILOT_CLUST
+000032f0: 4552 5f49 4e46 4f20 7c20 6a71 202e 7265  ER_INFO | jq .re
+00003300: 6769 6f6e 207c 2067 7265 7020 7573 2d63  gion | grep us-c
+00003310: 656e 7472 616c 315c 2727 2c0a 2020 2020  entral1\'',.    
+00003320: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00003330: 6773 207b 6e61 6d65 7d20 3320 2d2d 7374  gs {name} 3 --st
+00003340: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+00003350: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+00003360: 6564 2e0a 2020 2020 2020 2020 5d2c 0a20  ed..        ],. 
+00003370: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+00003380: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+00003390: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+000033a0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+000033b0: 7465 7374 2e6d 6172 6b2e 6962 6d0a 6465  test.mark.ibm.de
+000033c0: 6620 7465 7374 5f69 626d 5f72 6567 696f  f test_ibm_regio
+000033d0: 6e28 293a 0a20 2020 206e 616d 6520 3d20  n():.    name = 
+000033e0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+000033f0: 6528 290a 2020 2020 7265 6769 6f6e 203d  e().    region =
+00003400: 2027 6575 2d64 6527 0a20 2020 2074 6573   'eu-de'.    tes
+00003410: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00003420: 2020 2772 6567 696f 6e27 2c0a 2020 2020    'region',.    
+00003430: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00003440: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00003450: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
+00003460: 6f75 6420 6962 6d20 2d2d 7265 6769 6f6e  oud ibm --region
+00003470: 207b 7265 6769 6f6e 7d20 6578 616d 706c   {region} exampl
+00003480: 6573 2f6d 696e 696d 616c 2e79 616d 6c27  es/minimal.yaml'
+00003490: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000034a0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+000034b0: 2d2d 636c 6f75 6420 6962 6d20 6578 616d  --cloud ibm exam
+000034c0: 706c 6573 2f6d 696e 696d 616c 2e79 616d  ples/minimal.yam
+000034d0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+000034e0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+000034f0: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
+00003500: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+00003510: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+00003520: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+00003530: 6174 7573 202d 2d61 6c6c 207c 2067 7265  atus --all | gre
+00003540: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
+00003550: 7b72 6567 696f 6e7d 272c 2020 2320 456e  {region}',  # En
+00003560: 7375 7265 2074 6865 2072 6567 696f 6e20  sure the region 
+00003570: 6973 2063 6f72 7265 6374 2e0a 2020 2020  is correct..    
+00003580: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+00003590: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+000035a0: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+000035b0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+000035c0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+000035d0: 6b2e 617a 7572 650a 6465 6620 7465 7374  k.azure.def test
+000035e0: 5f61 7a75 7265 5f72 6567 696f 6e28 293a  _azure_region():
+000035f0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00003600: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00003610: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00003620: 0a20 2020 2020 2020 2027 617a 7572 655f  .        'azure_
+00003630: 7265 6769 6f6e 272c 0a20 2020 2020 2020  region',.       
+00003640: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00003650: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00003660: 6320 7b6e 616d 657d 202d 2d72 6567 696f  c {name} --regio
+00003670: 6e20 6561 7374 7573 3220 2d2d 636c 6f75  n eastus2 --clou
+00003680: 6420 617a 7572 6520 7465 7374 732f 7465  d azure tests/te
+00003690: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
+000036a0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+000036b0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+000036c0: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
+000036d0: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
+000036e0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+000036f0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00003700: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+00003710: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+00003720: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+00003730: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00003740: 7374 6174 7573 202d 2d61 6c6c 207c 2067  status --all | g
+00003750: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+00003760: 7020 6561 7374 7573 3227 2c20 2023 2045  p eastus2',  # E
+00003770: 6e73 7572 6520 7468 6520 7265 6769 6f6e  nsure the region
+00003780: 2069 7320 636f 7272 6563 742e 0a20 2020   is correct..   
+00003790: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+000037a0: 7865 6320 7b6e 616d 657d 205c 2765 6368  xec {name} \'ech
+000037b0: 6f20 2453 4b59 5049 4c4f 545f 434c 5553  o $SKYPILOT_CLUS
+000037c0: 5445 525f 494e 464f 207c 206a 7120 2e72  TER_INFO | jq .r
+000037d0: 6567 696f 6e20 7c20 6772 6570 2065 6173  egion | grep eas
+000037e0: 7475 7332 5c27 272c 0a20 2020 2020 2020  tus2\'',.       
+000037f0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00003800: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
+00003810: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+00003820: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+00003830: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00003840: 6b79 2065 7865 6320 7b6e 616d 657d 205c  ky exec {name} \
+00003850: 2765 6368 6f20 2453 4b59 5049 4c4f 545f  'echo $SKYPILOT_
+00003860: 434c 5553 5445 525f 494e 464f 207c 206a  CLUSTER_INFO | j
+00003870: 7120 2e7a 6f6e 6520 7c20 6772 6570 206e  q .zone | grep n
+00003880: 756c 6c5c 2727 2c0a 2020 2020 2020 2020  ull\'',.        
+00003890: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+000038a0: 6e61 6d65 7d20 3320 2d2d 7374 6174 7573  name} 3 --status
+000038b0: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+000038c0: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+000038d0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+000038e0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+000038f0: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
+00003900: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00003910: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
+00003920: 2d2d 2d2d 2d20 5465 7374 207a 6f6e 6520  ----- Test zone 
+00003930: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
+00003940: 7374 2e6d 6172 6b2e 6177 730a 6465 6620  st.mark.aws.def 
+00003950: 7465 7374 5f61 7773 5f7a 6f6e 6528 293a  test_aws_zone():
+00003960: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00003970: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00003980: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00003990: 0a20 2020 2020 2020 2027 6177 735f 7a6f  .        'aws_zo
+000039a0: 6e65 272c 0a20 2020 2020 2020 205b 0a20  ne',.        [. 
+000039b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000039c0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+000039d0: 616d 657d 2065 7861 6d70 6c65 732f 6d69  ame} examples/mi
+000039e0: 6e69 6d61 6c2e 7961 6d6c 202d 2d7a 6f6e  nimal.yaml --zon
+000039f0: 6520 7573 2d65 6173 742d 3262 272c 0a20  e us-east-2b',. 
+00003a00: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00003a10: 2065 7865 6320 7b6e 616d 657d 2065 7861   exec {name} exa
+00003a20: 6d70 6c65 732f 6d69 6e69 6d61 6c2e 7961  mples/minimal.ya
+00003a30: 6d6c 202d 2d7a 6f6e 6520 7573 2d65 6173  ml --zone us-eas
+00003a40: 742d 3262 272c 0a20 2020 2020 2020 2020  t-2b',.         
+00003a50: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00003a60: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+00003a70: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+00003a80: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+00003a90: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00003aa0: 2073 7461 7475 7320 2d2d 616c 6c20 7c20   status --all | 
+00003ab0: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
+00003ac0: 6570 2075 732d 6561 7374 2d32 6227 2c20  ep us-east-2b', 
+00003ad0: 2023 2045 6e73 7572 6520 7468 6520 7a6f   # Ensure the zo
+00003ae0: 6e65 2069 7320 636f 7272 6563 742e 0a20  ne is correct.. 
+00003af0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00003b00: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00003b10: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00003b20: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00003b30: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00003b40: 6d61 726b 2e69 626d 0a64 6566 2074 6573  mark.ibm.def tes
+00003b50: 745f 6962 6d5f 7a6f 6e65 2829 3a0a 2020  t_ibm_zone():.  
+00003b60: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00003b70: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00003b80: 207a 6f6e 6520 3d20 2765 752d 6465 2d32   zone = 'eu-de-2
+00003b90: 270a 2020 2020 7465 7374 203d 2054 6573  '.    test = Tes
+00003ba0: 7428 0a20 2020 2020 2020 2027 7a6f 6e65  t(.        'zone
+00003bb0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00003bc0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00003bd0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+00003be0: 657d 202d 2d63 6c6f 7564 2069 626d 2065  e} --cloud ibm e
+00003bf0: 7861 6d70 6c65 732f 6d69 6e69 6d61 6c2e  xamples/minimal.
+00003c00: 7961 6d6c 202d 2d7a 6f6e 6520 7b7a 6f6e  yaml --zone {zon
+00003c10: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
+00003c20: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+00003c30: 657d 202d 2d63 6c6f 7564 2069 626d 2065  e} --cloud ibm e
+00003c40: 7861 6d70 6c65 732f 6d69 6e69 6d61 6c2e  xamples/minimal.
+00003c50: 7961 6d6c 202d 2d7a 6f6e 6520 7b7a 6f6e  yaml --zone {zon
+00003c60: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
+00003c70: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00003c80: 657d 2031 202d 2d73 7461 7475 7327 2c20  e} 1 --status', 
+00003c90: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+00003ca0: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
+00003cb0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00003cc0: 7461 7475 7320 2d2d 616c 6c20 7c20 6772  tatus --all | gr
+00003cd0: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
+00003ce0: 207b 7a6f 6e65 7d27 2c20 2023 2045 6e73   {zone}',  # Ens
+00003cf0: 7572 6520 7468 6520 7a6f 6e65 2069 7320  ure the zone is 
+00003d00: 636f 7272 6563 742e 0a20 2020 2020 2020  correct..       
+00003d10: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+00003d20: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00003d30: 207b 6e61 6d65 7d2d 3220 7b6e 616d 657d   {name}-2 {name}
+00003d40: 2d33 272c 0a20 2020 2029 0a20 2020 2072  -3',.    ).    r
+00003d50: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00003d60: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+00003d70: 2e67 6370 0a64 6566 2074 6573 745f 6763  .gcp.def test_gc
+00003d80: 705f 7a6f 6e65 2829 3a0a 2020 2020 6e61  p_zone():.    na
+00003d90: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00003da0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+00003db0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00003dc0: 2020 2767 6370 5f7a 6f6e 6527 2c0a 2020    'gcp_zone',.  
+00003dd0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00003de0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00003df0: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+00003e00: 7a6f 6e65 2075 732d 6365 6e74 7261 6c31  zone us-central1
+00003e10: 2d61 202d 2d63 6c6f 7564 2067 6370 2074  -a --cloud gcp t
+00003e20: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+00003e30: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
+00003e40: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00003e50: 2065 7865 6320 7b6e 616d 657d 202d 2d7a   exec {name} --z
+00003e60: 6f6e 6520 7573 2d63 656e 7472 616c 312d  one us-central1-
+00003e70: 6120 2d2d 636c 6f75 6420 6763 7020 7465  a --cloud gcp te
+00003e80: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
+00003e90: 696e 696d 616c 2e79 616d 6c27 2c0a 2020  inimal.yaml',.  
+00003ea0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00003eb0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+00003ec0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+00003ed0: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
+00003ee0: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
+00003ef0: 2020 6627 736b 7920 7374 6174 7573 202d    f'sky status -
+00003f00: 2d61 6c6c 207c 2067 7265 7020 7b6e 616d  -all | grep {nam
+00003f10: 657d 207c 2067 7265 7020 7573 2d63 656e  e} | grep us-cen
+00003f20: 7472 616c 312d 6127 2c20 2023 2045 6e73  tral1-a',  # Ens
+00003f30: 7572 6520 7468 6520 7a6f 6e65 2069 7320  ure the zone is 
+00003f40: 636f 7272 6563 742e 0a20 2020 2020 2020  correct..       
+00003f50: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+00003f60: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00003f70: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
+00003f80: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00003f90: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
+00003fa0: 6573 7420 7468 6520 696d 6167 6520 2d2d  est the image --
+00003fb0: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
+00003fc0: 2e6d 6172 6b2e 6177 730a 6465 6620 7465  .mark.aws.def te
+00003fd0: 7374 5f61 7773 5f69 6d61 6765 7328 293a  st_aws_images():
+00003fe0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00003ff0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00004000: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00004010: 0a20 2020 2020 2020 2027 6177 735f 696d  .        'aws_im
+00004020: 6167 6573 272c 0a20 2020 2020 2020 205b  ages',.        [
+00004030: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00004040: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00004050: 7b6e 616d 657d 202d 2d69 6d61 6765 2d69  {name} --image-i
+00004060: 6420 736b 7970 696c 6f74 3a67 7075 2d75  d skypilot:gpu-u
+00004070: 6275 6e74 752d 3138 3034 2065 7861 6d70  buntu-1804 examp
+00004080: 6c65 732f 6d69 6e69 6d61 6c2e 7961 6d6c  les/minimal.yaml
+00004090: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000040a0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+000040b0: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
+000040c0: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+000040d0: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+000040e0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+000040f0: 6e63 6820 2d63 207b 6e61 6d65 7d20 2d2d  nch -c {name} --
+00004100: 696d 6167 652d 6964 2073 6b79 7069 6c6f  image-id skypilo
+00004110: 743a 6770 752d 7562 756e 7475 2d32 3030  t:gpu-ubuntu-200
+00004120: 3420 6578 616d 706c 6573 2f6d 696e 696d  4 examples/minim
+00004130: 616c 2e79 616d 6c20 2626 2065 7869 7420  al.yaml && exit 
+00004140: 3120 7c7c 2074 7275 6527 2c0a 2020 2020  1 || true',.    
+00004150: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+00004160: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+00004170: 7d20 6578 616d 706c 6573 2f6d 696e 696d  } examples/minim
+00004180: 616c 2e79 616d 6c27 2c0a 2020 2020 2020  al.yaml',.      
+00004190: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+000041a0: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
+000041b0: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+000041c0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+000041d0: 657d 202d 2d73 7461 7475 7320 7c20 6772  e} --status | gr
+000041e0: 6570 2022 4a6f 6220 323a 2053 5543 4345  ep "Job 2: SUCCE
+000041f0: 4544 4544 2227 2c20 2023 2045 7175 6976  EDED"',  # Equiv
+00004200: 616c 656e 742e 0a20 2020 2020 2020 2020  alent..         
+00004210: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00004220: 616d 657d 205c 2765 6368 6f20 2453 4b59  ame} \'echo $SKY
+00004230: 5049 4c4f 545f 434c 5553 5445 525f 494e  PILOT_CLUSTER_IN
+00004240: 464f 207c 206a 7120 2e63 6c6f 7564 207c  FO | jq .cloud |
+00004250: 2067 7265 7020 2d69 2061 7773 5c27 272c   grep -i aws\'',
+00004260: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00004270: 6b79 206c 6f67 7320 7b6e 616d 657d 2033  ky logs {name} 3
+00004280: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+00004290: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+000042a0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+000042b0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+000042c0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+000042d0: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
+000042e0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+000042f0: 0a0a 4070 7974 6573 742e 6d61 726b 2e67  ..@pytest.mark.g
+00004300: 6370 0a64 6566 2074 6573 745f 6763 705f  cp.def test_gcp_
+00004310: 696d 6167 6573 2829 3a0a 2020 2020 6e61  images():.    na
+00004320: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00004330: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+00004340: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00004350: 2020 2767 6370 5f69 6d61 6765 7327 2c0a    'gcp_images',.
+00004360: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00004370: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00004380: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
+00004390: 2d2d 696d 6167 652d 6964 2073 6b79 7069  --image-id skypi
+000043a0: 6c6f 743a 6770 752d 6465 6269 616e 2d31  lot:gpu-debian-1
+000043b0: 3020 2d2d 636c 6f75 6420 6763 7020 7465  0 --cloud gcp te
+000043c0: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
+000043d0: 696e 696d 616c 2e79 616d 6c27 2c0a 2020  inimal.yaml',.  
+000043e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000043f0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+00004400: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+00004410: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
+00004420: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
+00004430: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00004440: 6320 7b6e 616d 657d 202d 2d69 6d61 6765  c {name} --image
+00004450: 2d69 6420 736b 7970 696c 6f74 3a63 7075  -id skypilot:cpu
+00004460: 2d64 6562 6961 6e2d 3130 202d 2d63 6c6f  -debian-10 --clo
+00004470: 7564 2067 6370 2074 6573 7473 2f74 6573  ud gcp tests/tes
+00004480: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
+00004490: 7961 6d6c 2026 2620 6578 6974 2031 207c  yaml && exit 1 |
+000044a0: 7c20 7472 7565 272c 0a20 2020 2020 2020  | true',.       
+000044b0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+000044c0: 6820 2d79 202d 6320 7b6e 616d 657d 2074  h -y -c {name} t
+000044d0: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+000044e0: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
+000044f0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00004500: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
+00004510: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+00004520: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00004530: 207b 6e61 6d65 7d20 2d2d 7374 6174 7573   {name} --status
+00004540: 207c 2067 7265 7020 224a 6f62 2032 3a20   | grep "Job 2: 
+00004550: 5355 4343 4545 4445 4422 272c 2020 2320  SUCCEEDED"',  # 
+00004560: 4571 7569 7661 6c65 6e74 2e0a 2020 2020  Equivalent..    
+00004570: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00004580: 6563 207b 6e61 6d65 7d20 5c27 6563 686f  ec {name} \'echo
+00004590: 2024 534b 5950 494c 4f54 5f43 4c55 5354   $SKYPILOT_CLUST
+000045a0: 4552 5f49 4e46 4f20 7c20 6a71 202e 636c  ER_INFO | jq .cl
+000045b0: 6f75 6420 7c20 6772 6570 202d 6920 6763  oud | grep -i gc
+000045c0: 705c 2727 2c0a 2020 2020 2020 2020 2020  p\'',.          
+000045d0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+000045e0: 6d65 7d20 3320 2d2d 7374 6174 7573 272c  me} 3 --status',
+000045f0: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+00004600: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+00004610: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00004620: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00004630: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+00004640: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00004650: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00004660: 6172 6b2e 617a 7572 650a 6465 6620 7465  ark.azure.def te
+00004670: 7374 5f61 7a75 7265 5f69 6d61 6765 7328  st_azure_images(
+00004680: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+00004690: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+000046a0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+000046b0: 7428 0a20 2020 2020 2020 2027 617a 7572  t(.        'azur
+000046c0: 655f 696d 6167 6573 272c 0a20 2020 2020  e_images',.     
+000046d0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+000046e0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+000046f0: 202d 6320 7b6e 616d 657d 202d 2d69 6d61   -c {name} --ima
+00004700: 6765 2d69 6420 736b 7970 696c 6f74 3a67  ge-id skypilot:g
+00004710: 7075 2d75 6275 6e74 752d 3232 3034 202d  pu-ubuntu-2204 -
+00004720: 2d63 6c6f 7564 2061 7a75 7265 2074 6573  -cloud azure tes
+00004730: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
+00004740: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
+00004750: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00004760: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
+00004770: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+00004780: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
+00004790: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
+000047a0: 2066 2773 6b79 206c 6175 6e63 6820 2d63   f'sky launch -c
+000047b0: 207b 6e61 6d65 7d20 2d2d 696d 6167 652d   {name} --image-
+000047c0: 6964 2073 6b79 7069 6c6f 743a 7631 2d75  id skypilot:v1-u
+000047d0: 6275 6e74 752d 3230 3034 202d 2d63 6c6f  buntu-2004 --clo
+000047e0: 7564 2061 7a75 7265 2074 6573 7473 2f74  ud azure tests/t
+000047f0: 6573 745f 7961 6d6c 732f 6d69 6e69 6d61  est_yamls/minima
+00004800: 6c2e 7961 6d6c 2026 2620 6578 6974 2031  l.yaml && exit 1
+00004810: 207c 7c20 7472 7565 272c 0a20 2020 2020   || true',.     
+00004820: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+00004830: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+00004840: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+00004850: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
+00004860: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00004870: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
+00004880: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00004890: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+000048a0: 6773 207b 6e61 6d65 7d20 2d2d 7374 6174  gs {name} --stat
+000048b0: 7573 207c 2067 7265 7020 224a 6f62 2032  us | grep "Job 2
+000048c0: 3a20 5355 4343 4545 4445 4422 272c 2020  : SUCCEEDED"',  
+000048d0: 2320 4571 7569 7661 6c65 6e74 2e0a 2020  # Equivalent..  
+000048e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000048f0: 6578 6563 207b 6e61 6d65 7d20 5c27 6563  exec {name} \'ec
+00004900: 686f 2024 534b 5950 494c 4f54 5f43 4c55  ho $SKYPILOT_CLU
+00004910: 5354 4552 5f49 4e46 4f20 7c20 6a71 202e  STER_INFO | jq .
+00004920: 636c 6f75 6420 7c20 6772 6570 202d 6920  cloud | grep -i 
+00004930: 617a 7572 655c 2727 2c0a 2020 2020 2020  azure\'',.      
+00004940: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00004950: 207b 6e61 6d65 7d20 3320 2d2d 7374 6174   {name} 3 --stat
+00004960: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
+00004970: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
+00004980: 2e0a 2020 2020 2020 2020 5d2c 0a20 2020  ..        ],.   
+00004990: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+000049a0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+000049b0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+000049c0: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+000049d0: 7374 2e6d 6172 6b2e 6177 730a 6465 6620  st.mark.aws.def 
+000049e0: 7465 7374 5f61 7773 5f69 6d61 6765 5f69  test_aws_image_i
+000049f0: 645f 6469 6374 2829 3a0a 2020 2020 6e61  d_dict():.    na
+00004a00: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00004a10: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+00004a20: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00004a30: 2020 2761 7773 5f69 6d61 6765 5f69 645f    'aws_image_id_
+00004a40: 6469 6374 272c 0a20 2020 2020 2020 205b  dict',.        [
+00004a50: 0a20 2020 2020 2020 2020 2020 2023 2055  .            # U
+00004a60: 7365 2069 6d61 6765 2069 6420 6469 6374  se image id dict
+00004a70: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00004a80: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00004a90: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
+00004aa0: 2f70 6572 5f72 6567 696f 6e5f 696d 6167  /per_region_imag
+00004ab0: 6573 2e79 616d 6c27 2c0a 2020 2020 2020  es.yaml',.      
+00004ac0: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00004ad0: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
+00004ae0: 2f70 6572 5f72 6567 696f 6e5f 696d 6167  /per_region_imag
+00004af0: 6573 2e79 616d 6c27 2c0a 2020 2020 2020  es.yaml',.      
+00004b00: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00004b10: 207b 6e61 6d65 7d20 226c 7320 7e22 272c   {name} "ls ~"',
+00004b20: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00004b30: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+00004b40: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00004b50: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00004b60: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
+00004b70: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
+00004b80: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00004b90: 616d 657d 2033 202d 2d73 7461 7475 7327  ame} 3 --status'
+00004ba0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00004bb0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+00004bc0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+00004bd0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00004be0: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+00004bf0: 7374 2e6d 6172 6b2e 6763 700a 6465 6620  st.mark.gcp.def 
+00004c00: 7465 7374 5f67 6370 5f69 6d61 6765 5f69  test_gcp_image_i
+00004c10: 645f 6469 6374 2829 3a0a 2020 2020 6e61  d_dict():.    na
+00004c20: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00004c30: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+00004c40: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00004c50: 2020 2767 6370 5f69 6d61 6765 5f69 645f    'gcp_image_id_
+00004c60: 6469 6374 272c 0a20 2020 2020 2020 205b  dict',.        [
+00004c70: 0a20 2020 2020 2020 2020 2020 2023 2055  .            # U
+00004c80: 7365 2069 6d61 6765 2069 6420 6469 6374  se image id dict
+00004c90: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00004ca0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00004cb0: 207b 6e61 6d65 7d20 7465 7374 732f 7465   {name} tests/te
+00004cc0: 7374 5f79 616d 6c73 2f67 6370 5f70 6572  st_yamls/gcp_per
+00004cd0: 5f72 6567 696f 6e5f 696d 6167 6573 2e79  _region_images.y
+00004ce0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00004cf0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+00004d00: 6d65 7d20 7465 7374 732f 7465 7374 5f79  me} tests/test_y
+00004d10: 616d 6c73 2f67 6370 5f70 6572 5f72 6567  amls/gcp_per_reg
+00004d20: 696f 6e5f 696d 6167 6573 2e79 616d 6c27  ion_images.yaml'
+00004d30: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00004d40: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+00004d50: 226c 7320 7e22 272c 0a20 2020 2020 2020  "ls ~"',.       
+00004d60: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00004d70: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+00004d80: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+00004d90: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00004da0: 7d20 3220 2d2d 7374 6174 7573 272c 0a20  } 2 --status',. 
+00004db0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00004dc0: 206c 6f67 7320 7b6e 616d 657d 2033 202d   logs {name} 3 -
+00004dd0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+00004de0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+00004df0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00004e00: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
+00004e10: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00004e20: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00004e30: 6177 730a 6465 6620 7465 7374 5f61 7773  aws.def test_aws
+00004e40: 5f69 6d61 6765 5f69 645f 6469 6374 5f72  _image_id_dict_r
+00004e50: 6567 696f 6e28 293a 0a20 2020 206e 616d  egion():.    nam
+00004e60: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00004e70: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00004e80: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00004e90: 2027 6177 735f 696d 6167 655f 6964 5f64   'aws_image_id_d
+00004ea0: 6963 745f 7265 6769 6f6e 272c 0a20 2020  ict_region',.   
+00004eb0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00004ec0: 2020 2023 2059 414d 4c20 6861 730a 2020     # YAML has.  
+00004ed0: 2020 2020 2020 2020 2020 2320 2020 696d            #   im
+00004ee0: 6167 655f 6964 3a0a 2020 2020 2020 2020  age_id:.        
+00004ef0: 2020 2020 2320 2020 2020 2020 7573 2d77      #       us-w
+00004f00: 6573 742d 323a 2073 6b79 7069 6c6f 743a  est-2: skypilot:
+00004f10: 6770 752d 7562 756e 7475 2d31 3830 340a  gpu-ubuntu-1804.
+00004f20: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+00004f30: 2020 2020 7573 2d65 6173 742d 323a 2073      us-east-2: s
+00004f40: 6b79 7069 6c6f 743a 6770 752d 7562 756e  kypilot:gpu-ubun
+00004f50: 7475 2d32 3030 340a 2020 2020 2020 2020  tu-2004.        
+00004f60: 2020 2020 2320 5573 6520 7265 6769 6f6e      # Use region
+00004f70: 2074 6f20 6669 6c74 6572 2069 6d61 6765   to filter image
+00004f80: 5f69 6420 6469 6374 2e0a 2020 2020 2020  _id dict..      
+00004f90: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00004fa0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
+00004fb0: 2d2d 7265 6769 6f6e 2075 732d 6561 7374  --region us-east
+00004fc0: 2d31 2065 7861 6d70 6c65 732f 7065 725f  -1 examples/per_
+00004fd0: 7265 6769 6f6e 5f69 6d61 6765 732e 7961  region_images.ya
+00004fe0: 6d6c 2026 2620 6578 6974 2031 207c 7c20  ml && exit 1 || 
+00004ff0: 7472 7565 272c 0a20 2020 2020 2020 2020  true',.         
+00005000: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
+00005010: 7c20 6772 6570 207b 6e61 6d65 7d20 2626  | grep {name} &&
+00005020: 2065 7869 7420 3120 7c7c 2074 7275 6527   exit 1 || true'
+00005030: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+00005040: 636c 7573 7465 7220 6973 206e 6f74 2063  cluster is not c
+00005050: 7265 6174 6564 2e0a 2020 2020 2020 2020  reated..        
+00005060: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00005070: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+00005080: 7265 6769 6f6e 2075 732d 6561 7374 2d32  region us-east-2
+00005090: 2065 7861 6d70 6c65 732f 7065 725f 7265   examples/per_re
+000050a0: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
+000050b0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+000050c0: 2053 686f 756c 6420 7375 6363 6573 7320   Should success 
+000050d0: 6265 6361 7573 6520 7468 6520 696d 6167  because the imag
+000050e0: 6520 6964 206d 6174 6368 2066 6f72 2074  e id match for t
+000050f0: 6865 2072 6567 696f 6e2e 0a20 2020 2020  he region..     
+00005100: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+00005110: 6e63 6820 2d63 207b 6e61 6d65 7d20 2d2d  nch -c {name} --
+00005120: 696d 6167 652d 6964 2073 6b79 7069 6c6f  image-id skypilo
+00005130: 743a 6770 752d 7562 756e 7475 2d32 3030  t:gpu-ubuntu-200
+00005140: 3420 6578 616d 706c 6573 2f6d 696e 696d  4 examples/minim
+00005150: 616c 2e79 616d 6c27 2c0a 2020 2020 2020  al.yaml',.      
+00005160: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00005170: 207b 6e61 6d65 7d20 2d2d 696d 6167 652d   {name} --image-
+00005180: 6964 2073 6b79 7069 6c6f 743a 6770 752d  id skypilot:gpu-
+00005190: 7562 756e 7475 2d32 3030 3420 6578 616d  ubuntu-2004 exam
+000051a0: 706c 6573 2f6d 696e 696d 616c 2e79 616d  ples/minimal.yam
+000051b0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+000051c0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+000051d0: 7d20 2d2d 696d 6167 652d 6964 2073 6b79  } --image-id sky
+000051e0: 7069 6c6f 743a 6770 752d 7562 756e 7475  pilot:gpu-ubuntu
+000051f0: 2d31 3830 3420 6578 616d 706c 6573 2f6d  -1804 examples/m
+00005200: 696e 696d 616c 2e79 616d 6c20 2626 2065  inimal.yaml && e
+00005210: 7869 7420 3120 7c7c 2074 7275 6527 2c0a  xit 1 || true',.
+00005220: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00005230: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+00005240: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+00005250: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00005260: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
+00005270: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
+00005280: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00005290: 6d65 7d20 3320 2d2d 7374 6174 7573 272c  me} 3 --status',
+000052a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000052b0: 6b79 2073 7461 7475 7320 2d2d 616c 6c20  ky status --all 
+000052c0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+000052d0: 6772 6570 2075 732d 6561 7374 2d32 272c  grep us-east-2',
+000052e0: 2020 2320 456e 7375 7265 2074 6865 2072    # Ensure the r
+000052f0: 6567 696f 6e20 6973 2063 6f72 7265 6374  egion is correct
+00005300: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00005310: 456e 7375 7265 2065 7865 6320 776f 726b  Ensure exec work
+00005320: 732e 0a20 2020 2020 2020 2020 2020 2066  s..            f
+00005330: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00005340: 202d 2d72 6567 696f 6e20 7573 2d65 6173   --region us-eas
+00005350: 742d 3220 6578 616d 706c 6573 2f70 6572  t-2 examples/per
+00005360: 5f72 6567 696f 6e5f 696d 6167 6573 2e79  _region_images.y
+00005370: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00005380: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+00005390: 6d65 7d20 6578 616d 706c 6573 2f70 6572  me} examples/per
+000053a0: 5f72 6567 696f 6e5f 696d 6167 6573 2e79  _region_images.y
+000053b0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+000053c0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+000053d0: 6d65 7d20 2d2d 636c 6f75 6420 6177 7320  me} --cloud aws 
+000053e0: 2d2d 7265 6769 6f6e 2075 732d 6561 7374  --region us-east
+000053f0: 2d32 2022 6c73 207e 2227 2c0a 2020 2020  -2 "ls ~"',.    
+00005400: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00005410: 6563 207b 6e61 6d65 7d20 226c 7320 7e22  ec {name} "ls ~"
+00005420: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00005430: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00005440: 2034 202d 2d73 7461 7475 7327 2c0a 2020   4 --status',.  
+00005450: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00005460: 6c6f 6773 207b 6e61 6d65 7d20 3520 2d2d  logs {name} 5 --
+00005470: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+00005480: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00005490: 7b6e 616d 657d 2036 202d 2d73 7461 7475  {name} 6 --statu
+000054a0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+000054b0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+000054c0: 7d20 3720 2d2d 7374 6174 7573 272c 0a20  } 7 --status',. 
+000054d0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+000054e0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+000054f0: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00005500: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00005510: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00005520: 6d61 726b 2e67 6370 0a64 6566 2074 6573  mark.gcp.def tes
+00005530: 745f 6763 705f 696d 6167 655f 6964 5f64  t_gcp_image_id_d
+00005540: 6963 745f 7265 6769 6f6e 2829 3a0a 2020  ict_region():.  
+00005550: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00005560: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00005570: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00005580: 2020 2020 2020 2767 6370 5f69 6d61 6765        'gcp_image
+00005590: 5f69 645f 6469 6374 5f72 6567 696f 6e27  _id_dict_region'
+000055a0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+000055b0: 2020 2020 2020 2020 2320 5573 6520 7265          # Use re
+000055c0: 6769 6f6e 2074 6f20 6669 6c74 6572 2069  gion to filter i
+000055d0: 6d61 6765 5f69 6420 6469 6374 2e0a 2020  mage_id dict..  
+000055e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000055f0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+00005600: 6d65 7d20 2d2d 7265 6769 6f6e 2075 732d  me} --region us-
+00005610: 6561 7374 3120 7465 7374 732f 7465 7374  east1 tests/test
+00005620: 5f79 616d 6c73 2f67 6370 5f70 6572 5f72  _yamls/gcp_per_r
+00005630: 6567 696f 6e5f 696d 6167 6573 2e79 616d  egion_images.yam
+00005640: 6c20 2626 2065 7869 7420 3120 7c7c 2074  l && exit 1 || t
+00005650: 7275 6527 2c0a 2020 2020 2020 2020 2020  rue',.          
+00005660: 2020 6627 736b 7920 7374 6174 7573 207c    f'sky status |
+00005670: 2067 7265 7020 7b6e 616d 657d 2026 2620   grep {name} && 
+00005680: 6578 6974 2031 207c 7c20 7472 7565 272c  exit 1 || true',
+00005690: 2020 2320 456e 7375 7265 2074 6865 2063    # Ensure the c
+000056a0: 6c75 7374 6572 2069 7320 6e6f 7420 6372  luster is not cr
+000056b0: 6561 7465 642e 0a20 2020 2020 2020 2020  eated..         
+000056c0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+000056d0: 2d79 202d 6320 7b6e 616d 657d 202d 2d72  -y -c {name} --r
+000056e0: 6567 696f 6e20 7573 2d77 6573 7433 2074  egion us-west3 t
+000056f0: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+00005700: 6763 705f 7065 725f 7265 6769 6f6e 5f69  gcp_per_region_i
+00005710: 6d61 6765 732e 7961 6d6c 272c 0a20 2020  mages.yaml',.   
+00005720: 2020 2020 2020 2020 2023 2053 686f 756c           # Shoul
+00005730: 6420 7375 6363 6573 7320 6265 6361 7573  d success becaus
+00005740: 6520 7468 6520 696d 6167 6520 6964 206d  e the image id m
+00005750: 6174 6368 2066 6f72 2074 6865 2072 6567  atch for the reg
+00005760: 696f 6e2e 0a20 2020 2020 2020 2020 2020  ion..           
+00005770: 2066 2773 6b79 206c 6175 6e63 6820 2d63   f'sky launch -c
+00005780: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00005790: 6763 7020 2d2d 696d 6167 652d 6964 2070  gcp --image-id p
+000057a0: 726f 6a65 6374 732f 7562 756e 7475 2d6f  rojects/ubuntu-o
+000057b0: 732d 636c 6f75 642f 676c 6f62 616c 2f69  s-cloud/global/i
+000057c0: 6d61 6765 732f 7562 756e 7475 2d31 3830  mages/ubuntu-180
+000057d0: 342d 6269 6f6e 6963 2d76 3230 3233 3031  4-bionic-v202301
+000057e0: 3132 2074 6573 7473 2f74 6573 745f 7961  12 tests/test_ya
+000057f0: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
+00005800: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00005810: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00005820: 202d 2d63 6c6f 7564 2067 6370 202d 2d69   --cloud gcp --i
+00005830: 6d61 6765 2d69 6420 7072 6f6a 6563 7473  mage-id projects
+00005840: 2f75 6275 6e74 752d 6f73 2d63 6c6f 7564  /ubuntu-os-cloud
+00005850: 2f67 6c6f 6261 6c2f 696d 6167 6573 2f75  /global/images/u
+00005860: 6275 6e74 752d 3138 3034 2d62 696f 6e69  buntu-1804-bioni
+00005870: 632d 7632 3032 3330 3131 3220 7465 7374  c-v20230112 test
+00005880: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
+00005890: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
+000058a0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+000058b0: 6563 207b 6e61 6d65 7d20 2d2d 636c 6f75  ec {name} --clou
+000058c0: 6420 6763 7020 2d2d 696d 6167 652d 6964  d gcp --image-id
+000058d0: 2073 6b79 7069 6c6f 743a 6370 752d 6465   skypilot:cpu-de
+000058e0: 6269 616e 2d31 3020 7465 7374 732f 7465  bian-10 tests/te
+000058f0: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
+00005900: 2e79 616d 6c20 2626 2065 7869 7420 3120  .yaml && exit 1 
+00005910: 7c7c 2074 7275 6527 2c0a 2020 2020 2020  || true',.      
+00005920: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00005930: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
+00005940: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+00005950: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00005960: 657d 2032 202d 2d73 7461 7475 7327 2c0a  e} 2 --status',.
+00005970: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00005980: 7920 6c6f 6773 207b 6e61 6d65 7d20 3320  y logs {name} 3 
+00005990: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+000059a0: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
+000059b0: 7475 7320 2d2d 616c 6c20 7c20 6772 6570  tus --all | grep
+000059c0: 207b 6e61 6d65 7d20 7c20 6772 6570 2075   {name} | grep u
+000059d0: 732d 7765 7374 3327 2c20 2023 2045 6e73  s-west3',  # Ens
+000059e0: 7572 6520 7468 6520 7265 6769 6f6e 2069  ure the region i
+000059f0: 7320 636f 7272 6563 742e 0a20 2020 2020  s correct..     
+00005a00: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
+00005a10: 6578 6563 2077 6f72 6b73 2e0a 2020 2020  exec works..    
+00005a20: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00005a30: 6563 207b 6e61 6d65 7d20 2d2d 7265 6769  ec {name} --regi
+00005a40: 6f6e 2075 732d 7765 7374 3320 7465 7374  on us-west3 test
+00005a50: 732f 7465 7374 5f79 616d 6c73 2f67 6370  s/test_yamls/gcp
+00005a60: 5f70 6572 5f72 6567 696f 6e5f 696d 6167  _per_region_imag
+00005a70: 6573 2e79 616d 6c27 2c0a 2020 2020 2020  es.yaml',.      
+00005a80: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00005a90: 207b 6e61 6d65 7d20 7465 7374 732f 7465   {name} tests/te
+00005aa0: 7374 5f79 616d 6c73 2f67 6370 5f70 6572  st_yamls/gcp_per
+00005ab0: 5f72 6567 696f 6e5f 696d 6167 6573 2e79  _region_images.y
+00005ac0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00005ad0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+00005ae0: 6d65 7d20 2d2d 636c 6f75 6420 6763 7020  me} --cloud gcp 
+00005af0: 2d2d 7265 6769 6f6e 2075 732d 7765 7374  --region us-west
+00005b00: 3320 226c 7320 7e22 272c 0a20 2020 2020  3 "ls ~"',.     
+00005b10: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00005b20: 6320 7b6e 616d 657d 2022 6c73 207e 2227  c {name} "ls ~"'
+00005b30: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00005b40: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00005b50: 3420 2d2d 7374 6174 7573 272c 0a20 2020  4 --status',.   
+00005b60: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00005b70: 6f67 7320 7b6e 616d 657d 2035 202d 2d73  ogs {name} 5 --s
+00005b80: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+00005b90: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00005ba0: 6e61 6d65 7d20 3620 2d2d 7374 6174 7573  name} 6 --status
+00005bb0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00005bc0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00005bd0: 2037 202d 2d73 7461 7475 7327 2c0a 2020   7 --status',.  
+00005be0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00005bf0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00005c00: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+00005c10: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00005c20: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00005c30: 6172 6b2e 6177 730a 6465 6620 7465 7374  ark.aws.def test
+00005c40: 5f61 7773 5f69 6d61 6765 5f69 645f 6469  _aws_image_id_di
+00005c50: 6374 5f7a 6f6e 6528 293a 0a20 2020 206e  ct_zone():.    n
+00005c60: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00005c70: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+00005c80: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00005c90: 2020 2027 6177 735f 696d 6167 655f 6964     'aws_image_id
+00005ca0: 5f64 6963 745f 7a6f 6e65 272c 0a20 2020  _dict_zone',.   
+00005cb0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00005cc0: 2020 2023 2059 414d 4c20 6861 730a 2020     # YAML has.  
+00005cd0: 2020 2020 2020 2020 2020 2320 2020 696d            #   im
+00005ce0: 6167 655f 6964 3a0a 2020 2020 2020 2020  age_id:.        
+00005cf0: 2020 2020 2320 2020 2020 2020 7573 2d77      #       us-w
+00005d00: 6573 742d 323a 2073 6b79 7069 6c6f 743a  est-2: skypilot:
+00005d10: 6770 752d 7562 756e 7475 2d31 3830 340a  gpu-ubuntu-1804.
+00005d20: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+00005d30: 2020 2020 7573 2d65 6173 742d 323a 2073      us-east-2: s
+00005d40: 6b79 7069 6c6f 743a 6770 752d 7562 756e  kypilot:gpu-ubun
+00005d50: 7475 2d32 3030 340a 2020 2020 2020 2020  tu-2004.        
+00005d60: 2020 2020 2320 5573 6520 7a6f 6e65 2074      # Use zone t
+00005d70: 6f20 6669 6c74 6572 2069 6d61 6765 5f69  o filter image_i
+00005d80: 6420 6469 6374 2e0a 2020 2020 2020 2020  d dict..        
+00005d90: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00005da0: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+00005db0: 7a6f 6e65 2075 732d 6561 7374 2d31 6220  zone us-east-1b 
+00005dc0: 6578 616d 706c 6573 2f70 6572 5f72 6567  examples/per_reg
+00005dd0: 696f 6e5f 696d 6167 6573 2e79 616d 6c20  ion_images.yaml 
+00005de0: 2626 2065 7869 7420 3120 7c7c 2074 7275  && exit 1 || tru
+00005df0: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
+00005e00: 6627 736b 7920 7374 6174 7573 207c 2067  f'sky status | g
+00005e10: 7265 7020 7b6e 616d 657d 2026 2620 6578  rep {name} && ex
+00005e20: 6974 2031 207c 7c20 7472 7565 272c 2020  it 1 || true',  
+00005e30: 2320 456e 7375 7265 2074 6865 2063 6c75  # Ensure the clu
+00005e40: 7374 6572 2069 7320 6e6f 7420 6372 6561  ster is not crea
+00005e50: 7465 642e 0a20 2020 2020 2020 2020 2020  ted..           
+00005e60: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00005e70: 202d 6320 7b6e 616d 657d 202d 2d7a 6f6e   -c {name} --zon
+00005e80: 6520 7573 2d65 6173 742d 3261 2065 7861  e us-east-2a exa
+00005e90: 6d70 6c65 732f 7065 725f 7265 6769 6f6e  mples/per_region
+00005ea0: 5f69 6d61 6765 732e 7961 6d6c 272c 0a20  _images.yaml',. 
+00005eb0: 2020 2020 2020 2020 2020 2023 2053 686f             # Sho
+00005ec0: 756c 6420 7375 6363 6573 7320 6265 6361  uld success beca
+00005ed0: 7573 6520 7468 6520 696d 6167 6520 6964  use the image id
+00005ee0: 206d 6174 6368 2066 6f72 2074 6865 207a   match for the z
+00005ef0: 6f6e 652e 0a20 2020 2020 2020 2020 2020  one..           
+00005f00: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00005f10: 202d 6320 7b6e 616d 657d 202d 2d69 6d61   -c {name} --ima
+00005f20: 6765 2d69 6420 736b 7970 696c 6f74 3a67  ge-id skypilot:g
+00005f30: 7075 2d75 6275 6e74 752d 3230 3034 2065  pu-ubuntu-2004 e
+00005f40: 7861 6d70 6c65 732f 6d69 6e69 6d61 6c2e  xamples/minimal.
+00005f50: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00005f60: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00005f70: 616d 657d 202d 2d69 6d61 6765 2d69 6420  ame} --image-id 
+00005f80: 736b 7970 696c 6f74 3a67 7075 2d75 6275  skypilot:gpu-ubu
+00005f90: 6e74 752d 3230 3034 2065 7861 6d70 6c65  ntu-2004 example
+00005fa0: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
+00005fb0: 0a20 2020 2020 2020 2020 2020 2023 2046  .            # F
+00005fc0: 6169 6c20 6475 6520 746f 2069 6d61 6765  ail due to image
+00005fd0: 2069 6420 6d69 736d 6174 6368 2e0a 2020   id mismatch..  
+00005fe0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00005ff0: 6578 6563 207b 6e61 6d65 7d20 2d2d 696d  exec {name} --im
+00006000: 6167 652d 6964 2073 6b79 7069 6c6f 743a  age-id skypilot:
+00006010: 6770 752d 7562 756e 7475 2d31 3830 3420  gpu-ubuntu-1804 
+00006020: 6578 616d 706c 6573 2f6d 696e 696d 616c  examples/minimal
+00006030: 2e79 616d 6c20 2626 2065 7869 7420 3120  .yaml && exit 1 
+00006040: 7c7c 2074 7275 6527 2c0a 2020 2020 2020  || true',.      
+00006050: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00006060: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
+00006070: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+00006080: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00006090: 657d 2032 202d 2d73 7461 7475 7327 2c0a  e} 2 --status',.
+000060a0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000060b0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3320  y logs {name} 3 
+000060c0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+000060d0: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
+000060e0: 7475 7320 2d2d 616c 6c20 7c20 6772 6570  tus --all | grep
+000060f0: 207b 6e61 6d65 7d20 7c20 6772 6570 2075   {name} | grep u
+00006100: 732d 6561 7374 2d32 6127 2c20 2023 2045  s-east-2a',  # E
+00006110: 6e73 7572 6520 7468 6520 7a6f 6e65 2069  nsure the zone i
+00006120: 7320 636f 7272 6563 742e 0a20 2020 2020  s correct..     
+00006130: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
+00006140: 6578 6563 2077 6f72 6b73 2e0a 2020 2020  exec works..    
+00006150: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00006160: 6563 207b 6e61 6d65 7d20 2d2d 7a6f 6e65  ec {name} --zone
+00006170: 2075 732d 6561 7374 2d32 6120 6578 616d   us-east-2a exam
+00006180: 706c 6573 2f70 6572 5f72 6567 696f 6e5f  ples/per_region_
+00006190: 696d 6167 6573 2e79 616d 6c27 2c0a 2020  images.yaml',.  
+000061a0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000061b0: 6578 6563 207b 6e61 6d65 7d20 6578 616d  exec {name} exam
+000061c0: 706c 6573 2f70 6572 5f72 6567 696f 6e5f  ples/per_region_
+000061d0: 696d 6167 6573 2e79 616d 6c27 2c0a 2020  images.yaml',.  
+000061e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000061f0: 6578 6563 207b 6e61 6d65 7d20 2d2d 636c  exec {name} --cl
+00006200: 6f75 6420 6177 7320 2d2d 7265 6769 6f6e  oud aws --region
+00006210: 2075 732d 6561 7374 2d32 2022 6c73 207e   us-east-2 "ls ~
+00006220: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00006230: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00006240: 7d20 226c 7320 7e22 272c 0a20 2020 2020  } "ls ~"',.     
+00006250: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00006260: 7320 7b6e 616d 657d 2034 202d 2d73 7461  s {name} 4 --sta
+00006270: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
+00006280: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00006290: 6d65 7d20 3520 2d2d 7374 6174 7573 272c  me} 5 --status',
+000062a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000062b0: 6b79 206c 6f67 7320 7b6e 616d 657d 2036  ky logs {name} 6
+000062c0: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+000062d0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+000062e0: 6773 207b 6e61 6d65 7d20 3720 2d2d 7374  gs {name} 7 --st
+000062f0: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
+00006300: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00006310: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00006320: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00006330: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00006340: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
+00006350: 0a64 6566 2074 6573 745f 6763 705f 696d  .def test_gcp_im
+00006360: 6167 655f 6964 5f64 6963 745f 7a6f 6e65  age_id_dict_zone
+00006370: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
+00006380: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+00006390: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+000063a0: 7374 280a 2020 2020 2020 2020 2767 6370  st(.        'gcp
+000063b0: 5f69 6d61 6765 5f69 645f 6469 6374 5f7a  _image_id_dict_z
+000063c0: 6f6e 6527 2c0a 2020 2020 2020 2020 5b0a  one',.        [.
+000063d0: 2020 2020 2020 2020 2020 2020 2320 5573              # Us
+000063e0: 6520 7a6f 6e65 2074 6f20 6669 6c74 6572  e zone to filter
+000063f0: 2069 6d61 6765 5f69 6420 6469 6374 2e0a   image_id dict..
+00006400: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00006410: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00006420: 6e61 6d65 7d20 2d2d 7a6f 6e65 2075 732d  name} --zone us-
+00006430: 6561 7374 312d 6120 7465 7374 732f 7465  east1-a tests/te
+00006440: 7374 5f79 616d 6c73 2f67 6370 5f70 6572  st_yamls/gcp_per
+00006450: 5f72 6567 696f 6e5f 696d 6167 6573 2e79  _region_images.y
+00006460: 616d 6c20 2626 2065 7869 7420 3120 7c7c  aml && exit 1 ||
+00006470: 2074 7275 6527 2c0a 2020 2020 2020 2020   true',.        
+00006480: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
+00006490: 207c 2067 7265 7020 7b6e 616d 657d 2026   | grep {name} &
+000064a0: 2620 6578 6974 2031 207c 7c20 7472 7565  & exit 1 || true
+000064b0: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+000064c0: 2063 6c75 7374 6572 2069 7320 6e6f 7420   cluster is not 
+000064d0: 6372 6561 7465 642e 0a20 2020 2020 2020  created..       
+000064e0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+000064f0: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
+00006500: 2d7a 6f6e 6520 7573 2d63 656e 7472 616c  -zone us-central
+00006510: 312d 6120 7465 7374 732f 7465 7374 5f79  1-a tests/test_y
+00006520: 616d 6c73 2f67 6370 5f70 6572 5f72 6567  amls/gcp_per_reg
+00006530: 696f 6e5f 696d 6167 6573 2e79 616d 6c27  ion_images.yaml'
+00006540: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00006550: 5368 6f75 6c64 2073 7563 6365 7373 2062  Should success b
+00006560: 6563 6175 7365 2074 6865 2069 6d61 6765  ecause the image
+00006570: 2069 6420 6d61 7463 6820 666f 7220 7468   id match for th
+00006580: 6520 7a6f 6e65 2e0a 2020 2020 2020 2020  e zone..        
+00006590: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+000065a0: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+000065b0: 636c 6f75 6420 6763 7020 2d2d 696d 6167  cloud gcp --imag
+000065c0: 652d 6964 2073 6b79 7069 6c6f 743a 6370  e-id skypilot:cp
+000065d0: 752d 6465 6269 616e 2d31 3020 7465 7374  u-debian-10 test
+000065e0: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
+000065f0: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
+00006600: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00006610: 6563 207b 6e61 6d65 7d20 2d2d 636c 6f75  ec {name} --clou
+00006620: 6420 6763 7020 2d2d 696d 6167 652d 6964  d gcp --image-id
+00006630: 2073 6b79 7069 6c6f 743a 6370 752d 6465   skypilot:cpu-de
+00006640: 6269 616e 2d31 3020 7465 7374 732f 7465  bian-10 tests/te
+00006650: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
+00006660: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00006670: 2020 2020 2320 4661 696c 2064 7565 2074      # Fail due t
+00006680: 6f20 696d 6167 6520 6964 206d 6973 6d61  o image id misma
+00006690: 7463 682e 0a20 2020 2020 2020 2020 2020  tch..           
+000066a0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+000066b0: 657d 202d 2d63 6c6f 7564 2067 6370 202d  e} --cloud gcp -
+000066c0: 2d69 6d61 6765 2d69 6420 736b 7970 696c  -image-id skypil
+000066d0: 6f74 3a67 7075 2d64 6562 6961 6e2d 3130  ot:gpu-debian-10
+000066e0: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+000066f0: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 2026  s/minimal.yaml &
+00006700: 2620 6578 6974 2031 207c 7c20 7472 7565  & exit 1 || true
+00006710: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00006720: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00006730: 2031 202d 2d73 7461 7475 7327 2c0a 2020   1 --status',.  
 00006740: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00006750: 6578 6563 207b 6e61 6d65 7d20 2d2d 636c  exec {name} --cl
-00006760: 6f75 6420 6763 7020 2d2d 7265 6769 6f6e  oud gcp --region
-00006770: 2075 732d 6365 6e74 7261 6c31 2022 6c73   us-central1 "ls
-00006780: 207e 2227 2c0a 2020 2020 2020 2020 2020   ~"',.          
-00006790: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-000067a0: 6d65 7d20 226c 7320 7e22 272c 0a20 2020  me} "ls ~"',.   
-000067b0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-000067c0: 6f67 7320 7b6e 616d 657d 2034 202d 2d73  ogs {name} 4 --s
-000067d0: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-000067e0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-000067f0: 6e61 6d65 7d20 3520 2d2d 7374 6174 7573  name} 5 --status
-00006800: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00006810: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00006820: 2036 202d 2d73 7461 7475 7327 2c0a 2020   6 --status',.  
-00006830: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00006840: 6c6f 6773 207b 6e61 6d65 7d20 3720 2d2d  logs {name} 7 --
-00006850: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-00006860: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-00006870: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-00006880: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
-00006890: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-000068a0: 0a0a 4070 7974 6573 742e 6d61 726b 2e61  ..@pytest.mark.a
-000068b0: 7773 0a64 6566 2074 6573 745f 636c 6f6e  ws.def test_clon
-000068c0: 655f 6469 736b 5f61 7773 2829 3a0a 2020  e_disk_aws():.  
-000068d0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-000068e0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-000068f0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00006900: 2020 2020 2020 2763 6c6f 6e65 5f64 6973        'clone_dis
-00006910: 6b5f 6177 7327 2c0a 2020 2020 2020 2020  k_aws',.        
-00006920: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-00006930: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-00006940: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-00006950: 6177 7320 2d2d 7265 6769 6f6e 2075 732d  aws --region us-
-00006960: 6561 7374 2d32 202d 2d72 6574 7279 2d75  east-2 --retry-u
-00006970: 6e74 696c 2d75 7020 2265 6368 6f20 6865  ntil-up "echo he
-00006980: 6c6c 6f20 3e20 7e2f 7573 6572 5f66 696c  llo > ~/user_fil
-00006990: 652e 7478 7422 272c 0a20 2020 2020 2020  e.txt"',.       
-000069a0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-000069b0: 6820 2d2d 636c 6f6e 652d 6469 736b 2d66  h --clone-disk-f
-000069c0: 726f 6d20 7b6e 616d 657d 202d 7920 2d63  rom {name} -y -c
-000069d0: 207b 6e61 6d65 7d2d 636c 6f6e 6520 2626   {name}-clone &&
-000069e0: 2065 7869 7420 3120 7c7c 2074 7275 6527   exit 1 || true'
-000069f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00006a00: 736b 7920 7374 6f70 207b 6e61 6d65 7d20  sky stop {name} 
-00006a10: 2d79 272c 0a20 2020 2020 2020 2020 2020  -y',.           
-00006a20: 2027 736c 6565 7020 3630 272c 0a20 2020   'sleep 60',.   
-00006a30: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00006a40: 6175 6e63 6820 2d2d 636c 6f6e 652d 6469  aunch --clone-di
-00006a50: 736b 2d66 726f 6d20 7b6e 616d 657d 202d  sk-from {name} -
-00006a60: 7920 2d63 207b 6e61 6d65 7d2d 636c 6f6e  y -c {name}-clon
-00006a70: 6520 2d2d 636c 6f75 6420 6177 7320 2d64  e --cloud aws -d
-00006a80: 202d 2d72 6567 696f 6e20 7573 2d65 6173   --region us-eas
-00006a90: 742d 3220 2263 6174 207e 2f75 7365 725f  t-2 "cat ~/user_
-00006aa0: 6669 6c65 2e74 7874 207c 2067 7265 7020  file.txt | grep 
-00006ab0: 6865 6c6c 6f22 272c 0a20 2020 2020 2020  hello"',.       
-00006ac0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00006ad0: 6820 2d2d 636c 6f6e 652d 6469 736b 2d66  h --clone-disk-f
-00006ae0: 726f 6d20 7b6e 616d 657d 202d 7920 2d63  rom {name} -y -c
-00006af0: 207b 6e61 6d65 7d2d 636c 6f6e 652d 3220   {name}-clone-2 
-00006b00: 2d2d 636c 6f75 6420 6177 7320 2d64 202d  --cloud aws -d -
-00006b10: 2d72 6567 696f 6e20 7573 2d65 6173 742d  -region us-east-
-00006b20: 3220 2263 6174 207e 2f75 7365 725f 6669  2 "cat ~/user_fi
-00006b30: 6c65 2e74 7874 207c 2067 7265 7020 6865  le.txt | grep he
-00006b40: 6c6c 6f22 272c 0a20 2020 2020 2020 2020  llo"',.         
-00006b50: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00006b60: 616d 657d 2d63 6c6f 6e65 2031 202d 2d73  ame}-clone 1 --s
-00006b70: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-00006b80: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00006b90: 6e61 6d65 7d2d 636c 6f6e 652d 3220 3120  name}-clone-2 1 
-00006ba0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00006bb0: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-00006bc0: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-00006bd0: 657d 207b 6e61 6d65 7d2d 636c 6f6e 6520  e} {name}-clone 
-00006be0: 7b6e 616d 657d 2d63 6c6f 6e65 2d32 272c  {name}-clone-2',
-00006bf0: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-00006c00: 3d33 3020 2a20 3630 2c0a 2020 2020 290a  =30 * 60,.    ).
-00006c10: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00006c20: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-00006c30: 2e6d 6172 6b2e 6763 700a 6465 6620 7465  .mark.gcp.def te
-00006c40: 7374 5f63 6c6f 6e65 5f64 6973 6b5f 6763  st_clone_disk_gc
-00006c50: 7028 293a 0a20 2020 206e 616d 6520 3d20  p():.    name = 
-00006c60: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00006c70: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00006c80: 6573 7428 0a20 2020 2020 2020 2027 636c  est(.        'cl
-00006c90: 6f6e 655f 6469 736b 5f67 6370 272c 0a20  one_disk_gcp',. 
-00006ca0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00006cb0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00006cc0: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
-00006cd0: 2d63 6c6f 7564 2067 6370 202d 2d7a 6f6e  -cloud gcp --zon
-00006ce0: 6520 7573 2d65 6173 7431 2d62 202d 2d72  e us-east1-b --r
-00006cf0: 6574 7279 2d75 6e74 696c 2d75 7020 2265  etry-until-up "e
-00006d00: 6368 6f20 6865 6c6c 6f20 3e20 7e2f 7573  cho hello > ~/us
-00006d10: 6572 5f66 696c 652e 7478 7422 272c 0a20  er_file.txt"',. 
-00006d20: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00006d30: 206c 6175 6e63 6820 2d2d 636c 6f6e 652d   launch --clone-
-00006d40: 6469 736b 2d66 726f 6d20 7b6e 616d 657d  disk-from {name}
-00006d50: 202d 7920 2d63 207b 6e61 6d65 7d2d 636c   -y -c {name}-cl
-00006d60: 6f6e 6520 2626 2065 7869 7420 3120 7c7c  one && exit 1 ||
-00006d70: 2074 7275 6527 2c0a 2020 2020 2020 2020   true',.        
-00006d80: 2020 2020 6627 736b 7920 7374 6f70 207b      f'sky stop {
-00006d90: 6e61 6d65 7d20 2d79 272c 0a20 2020 2020  name} -y',.     
-00006da0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00006db0: 6e63 6820 2d2d 636c 6f6e 652d 6469 736b  nch --clone-disk
-00006dc0: 2d66 726f 6d20 7b6e 616d 657d 202d 7920  -from {name} -y 
-00006dd0: 2d63 207b 6e61 6d65 7d2d 636c 6f6e 6520  -c {name}-clone 
-00006de0: 2d2d 636c 6f75 6420 6763 7020 2d2d 7a6f  --cloud gcp --zo
-00006df0: 6e65 2075 732d 6365 6e74 7261 6c31 2d61  ne us-central1-a
-00006e00: 2022 6361 7420 7e2f 7573 6572 5f66 696c   "cat ~/user_fil
-00006e10: 652e 7478 7420 7c20 6772 6570 2068 656c  e.txt | grep hel
-00006e20: 6c6f 2227 2c0a 2020 2020 2020 2020 2020  lo"',.          
-00006e30: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00006e40: 2d63 6c6f 6e65 2d64 6973 6b2d 6672 6f6d  -clone-disk-from
-00006e50: 207b 6e61 6d65 7d20 2d79 202d 6320 7b6e   {name} -y -c {n
-00006e60: 616d 657d 2d63 6c6f 6e65 2d32 202d 2d63  ame}-clone-2 --c
-00006e70: 6c6f 7564 2067 6370 202d 2d7a 6f6e 6520  loud gcp --zone 
-00006e80: 7573 2d65 6173 7431 2d62 2022 6361 7420  us-east1-b "cat 
-00006e90: 7e2f 7573 6572 5f66 696c 652e 7478 7420  ~/user_file.txt 
-00006ea0: 7c20 6772 6570 2068 656c 6c6f 2227 2c0a  | grep hello"',.
+00006750: 6c6f 6773 207b 6e61 6d65 7d20 3220 2d2d  logs {name} 2 --
+00006760: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+00006770: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00006780: 7b6e 616d 657d 2033 202d 2d73 7461 7475  {name} 3 --statu
+00006790: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+000067a0: 6627 736b 7920 7374 6174 7573 202d 2d61  f'sky status --a
+000067b0: 6c6c 207c 2067 7265 7020 7b6e 616d 657d  ll | grep {name}
+000067c0: 207c 2067 7265 7020 7573 2d63 656e 7472   | grep us-centr
+000067d0: 616c 3127 2c20 2023 2045 6e73 7572 6520  al1',  # Ensure 
+000067e0: 7468 6520 7a6f 6e65 2069 7320 636f 7272  the zone is corr
+000067f0: 6563 742e 0a20 2020 2020 2020 2020 2020  ect..           
+00006800: 2023 2045 6e73 7572 6520 6578 6563 2077   # Ensure exec w
+00006810: 6f72 6b73 2e0a 2020 2020 2020 2020 2020  orks..          
+00006820: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+00006830: 6d65 7d20 2d2d 636c 6f75 6420 6763 7020  me} --cloud gcp 
+00006840: 2d2d 7a6f 6e65 2075 732d 6365 6e74 7261  --zone us-centra
+00006850: 6c31 2d61 2074 6573 7473 2f74 6573 745f  l1-a tests/test_
+00006860: 7961 6d6c 732f 6763 705f 7065 725f 7265  yamls/gcp_per_re
+00006870: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
+00006880: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00006890: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+000068a0: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+000068b0: 732f 6763 705f 7065 725f 7265 6769 6f6e  s/gcp_per_region
+000068c0: 5f69 6d61 6765 732e 7961 6d6c 272c 0a20  _images.yaml',. 
+000068d0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000068e0: 2065 7865 6320 7b6e 616d 657d 202d 2d63   exec {name} --c
+000068f0: 6c6f 7564 2067 6370 202d 2d72 6567 696f  loud gcp --regio
+00006900: 6e20 7573 2d63 656e 7472 616c 3120 226c  n us-central1 "l
+00006910: 7320 7e22 272c 0a20 2020 2020 2020 2020  s ~"',.         
+00006920: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00006930: 616d 657d 2022 6c73 207e 2227 2c0a 2020  ame} "ls ~"',.  
+00006940: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00006950: 6c6f 6773 207b 6e61 6d65 7d20 3420 2d2d  logs {name} 4 --
+00006960: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+00006970: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00006980: 7b6e 616d 657d 2035 202d 2d73 7461 7475  {name} 5 --statu
+00006990: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+000069a0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+000069b0: 7d20 3620 2d2d 7374 6174 7573 272c 0a20  } 6 --status',. 
+000069c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000069d0: 206c 6f67 7320 7b6e 616d 657d 2037 202d   logs {name} 7 -
+000069e0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+000069f0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+00006a00: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00006a10: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
+00006a20: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00006a30: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00006a40: 6177 730a 6465 6620 7465 7374 5f63 6c6f  aws.def test_clo
+00006a50: 6e65 5f64 6973 6b5f 6177 7328 293a 0a20  ne_disk_aws():. 
+00006a60: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00006a70: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00006a80: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00006a90: 2020 2020 2020 2027 636c 6f6e 655f 6469         'clone_di
+00006aa0: 736b 5f61 7773 272c 0a20 2020 2020 2020  sk_aws',.       
+00006ab0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00006ac0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00006ad0: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+00006ae0: 2061 7773 202d 2d72 6567 696f 6e20 7573   aws --region us
+00006af0: 2d65 6173 742d 3220 2d2d 7265 7472 792d  -east-2 --retry-
+00006b00: 756e 7469 6c2d 7570 2022 6563 686f 2068  until-up "echo h
+00006b10: 656c 6c6f 203e 207e 2f75 7365 725f 6669  ello > ~/user_fi
+00006b20: 6c65 2e74 7874 2227 2c0a 2020 2020 2020  le.txt"',.      
+00006b30: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00006b40: 6368 202d 2d63 6c6f 6e65 2d64 6973 6b2d  ch --clone-disk-
+00006b50: 6672 6f6d 207b 6e61 6d65 7d20 2d79 202d  from {name} -y -
+00006b60: 6320 7b6e 616d 657d 2d63 6c6f 6e65 2026  c {name}-clone &
+00006b70: 2620 6578 6974 2031 207c 7c20 7472 7565  & exit 1 || true
+00006b80: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00006b90: 2773 6b79 2073 746f 7020 7b6e 616d 657d  'sky stop {name}
+00006ba0: 202d 7927 2c0a 2020 2020 2020 2020 2020   -y',.          
+00006bb0: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
+00006bc0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00006bd0: 6c61 756e 6368 202d 2d63 6c6f 6e65 2d64  launch --clone-d
+00006be0: 6973 6b2d 6672 6f6d 207b 6e61 6d65 7d20  isk-from {name} 
+00006bf0: 2d79 202d 6320 7b6e 616d 657d 2d63 6c6f  -y -c {name}-clo
+00006c00: 6e65 202d 2d63 6c6f 7564 2061 7773 202d  ne --cloud aws -
+00006c10: 6420 2d2d 7265 6769 6f6e 2075 732d 6561  d --region us-ea
+00006c20: 7374 2d32 2022 6361 7420 7e2f 7573 6572  st-2 "cat ~/user
+00006c30: 5f66 696c 652e 7478 7420 7c20 6772 6570  _file.txt | grep
+00006c40: 2068 656c 6c6f 2227 2c0a 2020 2020 2020   hello"',.      
+00006c50: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00006c60: 6368 202d 2d63 6c6f 6e65 2d64 6973 6b2d  ch --clone-disk-
+00006c70: 6672 6f6d 207b 6e61 6d65 7d20 2d79 202d  from {name} -y -
+00006c80: 6320 7b6e 616d 657d 2d63 6c6f 6e65 2d32  c {name}-clone-2
+00006c90: 202d 2d63 6c6f 7564 2061 7773 202d 6420   --cloud aws -d 
+00006ca0: 2d2d 7265 6769 6f6e 2075 732d 6561 7374  --region us-east
+00006cb0: 2d32 2022 6361 7420 7e2f 7573 6572 5f66  -2 "cat ~/user_f
+00006cc0: 696c 652e 7478 7420 7c20 6772 6570 2068  ile.txt | grep h
+00006cd0: 656c 6c6f 2227 2c0a 2020 2020 2020 2020  ello"',.        
+00006ce0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00006cf0: 6e61 6d65 7d2d 636c 6f6e 6520 3120 2d2d  name}-clone 1 --
+00006d00: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+00006d10: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00006d20: 7b6e 616d 657d 2d63 6c6f 6e65 2d32 2031  {name}-clone-2 1
+00006d30: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00006d40: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+00006d50: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+00006d60: 6d65 7d20 7b6e 616d 657d 2d63 6c6f 6e65  me} {name}-clone
+00006d70: 207b 6e61 6d65 7d2d 636c 6f6e 652d 3227   {name}-clone-2'
+00006d80: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+00006d90: 743d 3330 202a 2036 302c 0a20 2020 2029  t=30 * 60,.    )
+00006da0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00006db0: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00006dc0: 742e 6d61 726b 2e67 6370 0a64 6566 2074  t.mark.gcp.def t
+00006dd0: 6573 745f 636c 6f6e 655f 6469 736b 5f67  est_clone_disk_g
+00006de0: 6370 2829 3a0a 2020 2020 6e61 6d65 203d  cp():.    name =
+00006df0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00006e00: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00006e10: 5465 7374 280a 2020 2020 2020 2020 2763  Test(.        'c
+00006e20: 6c6f 6e65 5f64 6973 6b5f 6763 7027 2c0a  lone_disk_gcp',.
+00006e30: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00006e40: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00006e50: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
+00006e60: 2d2d 636c 6f75 6420 6763 7020 2d2d 7a6f  --cloud gcp --zo
+00006e70: 6e65 2075 732d 6561 7374 312d 6220 2d2d  ne us-east1-b --
+00006e80: 7265 7472 792d 756e 7469 6c2d 7570 2022  retry-until-up "
+00006e90: 6563 686f 2068 656c 6c6f 203e 207e 2f75  echo hello > ~/u
+00006ea0: 7365 725f 6669 6c65 2e74 7874 2227 2c0a  ser_file.txt"',.
 00006eb0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00006ec0: 7920 6c6f 6773 207b 6e61 6d65 7d2d 636c  y logs {name}-cl
-00006ed0: 6f6e 6520 3120 2d2d 7374 6174 7573 272c  one 1 --status',
-00006ee0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00006ef0: 6b79 206c 6f67 7320 7b6e 616d 657d 2d63  ky logs {name}-c
-00006f00: 6c6f 6e65 2d32 2031 202d 2d73 7461 7475  lone-2 1 --statu
-00006f10: 7327 2c0a 2020 2020 2020 2020 5d2c 0a20  s',.        ],. 
-00006f20: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-00006f30: 6e20 2d79 207b 6e61 6d65 7d20 7b6e 616d  n -y {name} {nam
-00006f40: 657d 2d63 6c6f 6e65 207b 6e61 6d65 7d2d  e}-clone {name}-
-00006f50: 636c 6f6e 652d 3227 2c0a 2020 2020 290a  clone-2',.    ).
-00006f60: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00006f70: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-00006f80: 2e6d 6172 6b2e 6177 730a 6465 6620 7465  .mark.aws.def te
-00006f90: 7374 5f69 6d61 6765 5f6e 6f5f 636f 6e64  st_image_no_cond
-00006fa0: 6128 293a 0a20 2020 206e 616d 6520 3d20  a():.    name = 
-00006fb0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00006fc0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00006fd0: 6573 7428 0a20 2020 2020 2020 2027 696d  est(.        'im
-00006fe0: 6167 655f 6e6f 5f63 6f6e 6461 272c 0a20  age_no_conda',. 
-00006ff0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00007000: 2020 2020 2023 2055 7365 2069 6d61 6765       # Use image
-00007010: 2069 6420 6469 6374 2e0a 2020 2020 2020   id dict..      
-00007020: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00007030: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-00007040: 2d2d 7265 6769 6f6e 2075 732d 6561 7374  --region us-east
-00007050: 2d32 2065 7861 6d70 6c65 732f 7065 725f  -2 examples/per_
-00007060: 7265 6769 6f6e 5f69 6d61 6765 732e 7961  region_images.ya
-00007070: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00007080: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00007090: 657d 2031 202d 2d73 7461 7475 7327 2c0a  e} 1 --status',.
-000070a0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000070b0: 7920 7374 6f70 207b 6e61 6d65 7d20 2d79  y stop {name} -y
-000070c0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000070d0: 2773 6b79 2073 7461 7274 207b 6e61 6d65  'sky start {name
-000070e0: 7d20 2d79 272c 0a20 2020 2020 2020 2020  } -y',.         
-000070f0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00007100: 616d 657d 2065 7861 6d70 6c65 732f 7065  ame} examples/pe
-00007110: 725f 7265 6769 6f6e 5f69 6d61 6765 732e  r_region_images.
-00007120: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00007130: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00007140: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
-00007150: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-00007160: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-00007170: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-00007180: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00007190: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-000071a0: 7374 2e6d 6172 6b2e 6e6f 5f6b 7562 6572  st.mark.no_kuber
-000071b0: 6e65 7465 7320 2023 204b 7562 6572 6e65  netes  # Kuberne
-000071c0: 7465 7320 646f 6573 206e 6f74 2073 7570  tes does not sup
-000071d0: 706f 7274 2073 746f 7070 696e 6720 696e  port stopping in
-000071e0: 7374 616e 6365 730a 6465 6620 7465 7374  stances.def test
-000071f0: 5f63 7573 746f 6d5f 6465 6661 756c 745f  _custom_default_
-00007200: 636f 6e64 615f 656e 7628 6765 6e65 7269  conda_env(generi
-00007210: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-00007220: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-00007230: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-00007240: 2020 7465 7374 203d 2054 6573 7428 2763    test = Test('c
-00007250: 7573 746f 6d5f 6465 6661 756c 745f 636f  ustom_default_co
-00007260: 6e64 615f 656e 7627 2c20 5b0a 2020 2020  nda_env', [.    
-00007270: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00007280: 202d 6320 7b6e 616d 657d 202d 7920 2d2d   -c {name} -y --
-00007290: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-000072a0: 6c6f 7564 7d20 7465 7374 732f 7465 7374  loud} tests/test
-000072b0: 5f79 616d 6c73 2f74 6573 745f 6375 7374  _yamls/test_cust
-000072c0: 6f6d 5f64 6566 6175 6c74 5f63 6f6e 6461  om_default_conda
-000072d0: 5f65 6e76 2e79 616d 6c27 2c0a 2020 2020  _env.yaml',.    
-000072e0: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
-000072f0: 202d 7220 7b6e 616d 657d 207c 2067 7265   -r {name} | gre
-00007300: 7020 2255 5022 272c 0a20 2020 2020 2020  p "UP"',.       
-00007310: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00007320: 657d 2031 202d 2d73 7461 7475 7327 2c0a  e} 1 --status',.
-00007330: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00007340: 6773 207b 6e61 6d65 7d20 3120 2d2d 6e6f  gs {name} 1 --no
-00007350: 2d66 6f6c 6c6f 7720 7c20 6772 6570 202d  -follow | grep -
-00007360: 5020 226d 7965 6e76 5c5c 732b 5c5c 2a22  P "myenv\\s+\\*"
-00007370: 272c 0a20 2020 2020 2020 2066 2773 6b79  ',.        f'sky
-00007380: 2065 7865 6320 7b6e 616d 657d 2074 6573   exec {name} tes
-00007390: 7473 2f74 6573 745f 7961 6d6c 732f 7465  ts/test_yamls/te
-000073a0: 7374 5f63 7573 746f 6d5f 6465 6661 756c  st_custom_defaul
-000073b0: 745f 636f 6e64 615f 656e 762e 7961 6d6c  t_conda_env.yaml
-000073c0: 272c 0a20 2020 2020 2020 2066 2773 6b79  ',.        f'sky
-000073d0: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
-000073e0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-000073f0: 2020 6627 736b 7920 6175 746f 7374 6f70    f'sky autostop
-00007400: 202d 7920 2d69 2030 207b 6e61 6d65 7d27   -y -i 0 {name}'
-00007410: 2c0a 2020 2020 2020 2020 2773 6c65 6570  ,.        'sleep
-00007420: 2036 3027 2c0a 2020 2020 2020 2020 6627   60',.        f'
-00007430: 736b 7920 7374 6174 7573 202d 7220 7b6e  sky status -r {n
-00007440: 616d 657d 207c 2067 7265 7020 2253 544f  ame} | grep "STO
-00007450: 5050 4544 2227 2c0a 2020 2020 2020 2020  PPED"',.        
-00007460: 6627 736b 7920 7374 6172 7420 2d79 207b  f'sky start -y {
-00007470: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
-00007480: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00007490: 7d20 3220 2d2d 6e6f 2d66 6f6c 6c6f 7720  } 2 --no-follow 
-000074a0: 7c20 6772 6570 202d 5020 226d 7965 6e76  | grep -P "myenv
-000074b0: 5c5c 732b 5c5c 2a22 272c 0a20 2020 2020  \\s+\\*"',.     
-000074c0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-000074d0: 616d 657d 2074 6573 7473 2f74 6573 745f  ame} tests/test_
-000074e0: 7961 6d6c 732f 7465 7374 5f63 7573 746f  yamls/test_custo
-000074f0: 6d5f 6465 6661 756c 745f 636f 6e64 615f  m_default_conda_
-00007500: 656e 762e 7961 6d6c 272c 0a20 2020 2020  env.yaml',.     
-00007510: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00007520: 616d 657d 2033 202d 2d73 7461 7475 7327  ame} 3 --status'
-00007530: 2c0a 2020 2020 5d2c 2066 2773 6b79 2064  ,.    ], f'sky d
-00007540: 6f77 6e20 2d79 207b 6e61 6d65 7d27 290a  own -y {name}').
-00007550: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00007560: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
-00007570: 2d2d 2d2d 2d2d 2d20 5465 7374 2073 7461  ------- Test sta
-00007580: 6c65 206a 6f62 202d 2d2d 2d2d 2d2d 2d2d  le job ---------
-00007590: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
-000075a0: 2e6e 6f5f 666c 7569 6473 7461 636b 2020  .no_fluidstack  
-000075b0: 2320 466c 7569 6453 7461 636b 2064 6f65  # FluidStack doe
-000075c0: 7320 6e6f 7420 7375 7070 6f72 7420 7374  s not support st
-000075d0: 6f70 7069 6e67 2069 6e73 7461 6e63 6573  opping instances
-000075e0: 2069 6e20 536b 7950 696c 6f74 2069 6d70   in SkyPilot imp
-000075f0: 6c65 6d65 6e74 6174 696f 6e0a 4070 7974  lementation.@pyt
-00007600: 6573 742e 6d61 726b 2e6e 6f5f 6c61 6d62  est.mark.no_lamb
-00007610: 6461 5f63 6c6f 7564 2020 2320 4c61 6d62  da_cloud  # Lamb
-00007620: 6461 2043 6c6f 7564 2064 6f65 7320 6e6f  da Cloud does no
-00007630: 7420 7375 7070 6f72 7420 7374 6f70 7069  t support stoppi
-00007640: 6e67 2069 6e73 7461 6e63 6573 0a40 7079  ng instances.@py
-00007650: 7465 7374 2e6d 6172 6b2e 6e6f 5f6b 7562  test.mark.no_kub
-00007660: 6572 6e65 7465 7320 2023 204b 7562 6572  ernetes  # Kuber
-00007670: 6e65 7465 7320 646f 6573 206e 6f74 2073  netes does not s
-00007680: 7570 706f 7274 2073 746f 7070 696e 6720  upport stopping 
-00007690: 696e 7374 616e 6365 730a 6465 6620 7465  instances.def te
-000076a0: 7374 5f73 7461 6c65 5f6a 6f62 2867 656e  st_stale_job(gen
-000076b0: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-000076c0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-000076d0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-000076e0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-000076f0: 280a 2020 2020 2020 2020 2773 7461 6c65  (.        'stale
-00007700: 5f6a 6f62 272c 0a20 2020 2020 2020 205b  _job',.        [
-00007710: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00007720: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-00007730: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
-00007740: 6765 6e65 7269 635f 636c 6f75 647d 2022  generic_cloud} "
-00007750: 6563 686f 2068 6922 272c 0a20 2020 2020  echo hi"',.     
-00007760: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00007770: 6320 7b6e 616d 657d 202d 6420 2265 6368  c {name} -d "ech
-00007780: 6f20 7374 6172 743b 2073 6c65 6570 2031  o start; sleep 1
-00007790: 3030 3030 2227 2c0a 2020 2020 2020 2020  0000"',.        
-000077a0: 2020 2020 6627 736b 7920 7374 6f70 207b      f'sky stop {
-000077b0: 6e61 6d65 7d20 2d79 272c 0a20 2020 2020  name} -y',.     
-000077c0: 2020 2020 2020 2027 736c 6565 7020 3130         'sleep 10
-000077d0: 3027 2c20 2023 2045 6e73 7572 6520 7468  0',  # Ensure th
-000077e0: 6973 2069 7320 6c61 7267 6520 656e 6f75  is is large enou
-000077f0: 6768 2c20 656c 7365 2047 4350 206c 6561  gh, else GCP lea
-00007800: 6b73 2e0a 2020 2020 2020 2020 2020 2020  ks..            
-00007810: 6627 736b 7920 7374 6172 7420 7b6e 616d  f'sky start {nam
-00007820: 657d 202d 7927 2c0a 2020 2020 2020 2020  e} -y',.        
-00007830: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00007840: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
-00007850: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00007860: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
-00007870: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
-00007880: 223b 2065 6368 6f3b 2065 6368 6f3b 2065  "; echo; echo; e
-00007890: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-000078a0: 4641 494c 4544 272c 0a20 2020 2020 2020  FAILED',.       
-000078b0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-000078c0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-000078d0: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
-000078e0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-000078f0: 0a0a 4070 7974 6573 742e 6d61 726b 2e61  ..@pytest.mark.a
-00007900: 7773 0a64 6566 2074 6573 745f 6177 735f  ws.def test_aws_
-00007910: 7374 616c 655f 6a6f 625f 6d61 6e75 616c  stale_job_manual
-00007920: 5f72 6573 7461 7274 2829 3a0a 2020 2020  _restart():.    
-00007930: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-00007940: 7465 725f 6e61 6d65 2829 0a20 2020 206e  ter_name().    n
-00007950: 616d 655f 6f6e 5f63 6c6f 7564 203d 2063  ame_on_cloud = c
-00007960: 6f6d 6d6f 6e5f 7574 696c 732e 6d61 6b65  ommon_utils.make
-00007970: 5f63 6c75 7374 6572 5f6e 616d 655f 6f6e  _cluster_name_on
-00007980: 5f63 6c6f 7564 280a 2020 2020 2020 2020  _cloud(.        
-00007990: 6e61 6d65 2c20 736b 792e 4157 532e 6d61  name, sky.AWS.ma
-000079a0: 785f 636c 7573 7465 725f 6e61 6d65 5f6c  x_cluster_name_l
-000079b0: 656e 6774 6828 2929 0a20 2020 2072 6567  ength()).    reg
-000079c0: 696f 6e20 3d20 2775 732d 6561 7374 2d32  ion = 'us-east-2
-000079d0: 270a 2020 2020 7465 7374 203d 2054 6573  '.    test = Tes
-000079e0: 7428 0a20 2020 2020 2020 2027 6177 735f  t(.        'aws_
-000079f0: 7374 616c 655f 6a6f 625f 6d61 6e75 616c  stale_job_manual
-00007a00: 5f72 6573 7461 7274 272c 0a20 2020 2020  _restart',.     
-00007a10: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00007a20: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-00007a30: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
-00007a40: 7564 2061 7773 202d 2d72 6567 696f 6e20  ud aws --region 
-00007a50: 7b72 6567 696f 6e7d 2022 6563 686f 2068  {region} "echo h
-00007a60: 6922 272c 0a20 2020 2020 2020 2020 2020  i"',.           
-00007a70: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00007a80: 657d 202d 6420 2265 6368 6f20 7374 6172  e} -d "echo star
-00007a90: 743b 2073 6c65 6570 2031 3030 3030 2227  t; sleep 10000"'
-00007aa0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00007ab0: 5374 6f70 2074 6865 2063 6c75 7374 6572  Stop the cluster
-00007ac0: 206d 616e 7561 6c6c 792e 0a20 2020 2020   manually..     
-00007ad0: 2020 2020 2020 2066 2769 643d 6061 7773         f'id=`aws
-00007ae0: 2065 6332 2064 6573 6372 6962 652d 696e   ec2 describe-in
-00007af0: 7374 616e 6365 7320 2d2d 7265 6769 6f6e  stances --region
-00007b00: 207b 7265 6769 6f6e 7d20 2d2d 6669 6c74   {region} --filt
-00007b10: 6572 7320 270a 2020 2020 2020 2020 2020  ers '.          
-00007b20: 2020 6627 4e61 6d65 3d74 6167 3a72 6179    f'Name=tag:ray
-00007b30: 2d63 6c75 7374 6572 2d6e 616d 652c 5661  -cluster-name,Va
-00007b40: 6c75 6573 3d7b 6e61 6d65 5f6f 6e5f 636c  lues={name_on_cl
-00007b50: 6f75 647d 2027 0a20 2020 2020 2020 2020  oud} '.         
-00007b60: 2020 2066 272d 2d71 7565 7279 2052 6573     f'--query Res
-00007b70: 6572 7661 7469 6f6e 735b 5d2e 496e 7374  ervations[].Inst
-00007b80: 616e 6365 735b 5d2e 496e 7374 616e 6365  ances[].Instance
-00007b90: 4964 2027 0a20 2020 2020 2020 2020 2020  Id '.           
-00007ba0: 2027 2d2d 6f75 7470 7574 2074 6578 7460   '--output text`
-00007bb0: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-00007bc0: 6627 6177 7320 6563 3220 7374 6f70 2d69  f'aws ec2 stop-i
-00007bd0: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
-00007be0: 6e20 7b72 6567 696f 6e7d 2027 0a20 2020  n {region} '.   
-00007bf0: 2020 2020 2020 2020 2027 2d2d 696e 7374           '--inst
-00007c00: 616e 6365 2d69 6473 2024 6964 272c 0a20  ance-ids $id',. 
-00007c10: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00007c20: 7020 3430 272c 0a20 2020 2020 2020 2020  p 40',.         
-00007c30: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00007c40: 2d63 207b 6e61 6d65 7d20 2d79 2022 6563  -c {name} -y "ec
-00007c50: 686f 2068 6922 272c 0a20 2020 2020 2020  ho hi"',.       
-00007c60: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00007c70: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-00007c80: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-00007c90: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00007ca0: 7d20 3320 2d2d 7374 6174 7573 272c 0a20  } 3 --status',. 
-00007cb0: 2020 2020 2020 2020 2020 2023 2045 6e73             # Ens
-00007cc0: 7572 6520 7468 6520 736b 796c 6574 2075  ure the skylet u
-00007cd0: 7064 6174 6564 2074 6865 2073 7461 6c65  pdated the stale
-00007ce0: 206a 6f62 2073 7461 7475 732e 0a20 2020   job status..   
-00007cf0: 2020 2020 2020 2020 2066 2773 6c65 6570           f'sleep
-00007d00: 207b 6576 656e 7473 2e4a 6f62 5363 6865   {events.JobSche
-00007d10: 6475 6c65 7245 7665 6e74 2e45 5645 4e54  dulerEvent.EVENT
-00007d20: 5f49 4e54 4552 5641 4c5f 5345 434f 4e44  _INTERVAL_SECOND
-00007d30: 537d 272c 0a20 2020 2020 2020 2020 2020  S}',.           
-00007d40: 2066 2773 3d24 2873 6b79 2071 7565 7565   f's=$(sky queue
-00007d50: 207b 6e61 6d65 7d29 3b20 6563 686f 2022   {name}); echo "
-00007d60: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
-00007d70: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
-00007d80: 7020 4641 494c 4544 272c 0a20 2020 2020  p FAILED',.     
-00007d90: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-00007da0: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-00007db0: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
-00007dc0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00007dd0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00007de0: 2e67 6370 0a64 6566 2074 6573 745f 6763  .gcp.def test_gc
-00007df0: 705f 7374 616c 655f 6a6f 625f 6d61 6e75  p_stale_job_manu
-00007e00: 616c 5f72 6573 7461 7274 2829 3a0a 2020  al_restart():.  
-00007e10: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00007e20: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00007e30: 206e 616d 655f 6f6e 5f63 6c6f 7564 203d   name_on_cloud =
-00007e40: 2063 6f6d 6d6f 6e5f 7574 696c 732e 6d61   common_utils.ma
-00007e50: 6b65 5f63 6c75 7374 6572 5f6e 616d 655f  ke_cluster_name_
-00007e60: 6f6e 5f63 6c6f 7564 280a 2020 2020 2020  on_cloud(.      
-00007e70: 2020 6e61 6d65 2c20 736b 792e 4743 502e    name, sky.GCP.
-00007e80: 6d61 785f 636c 7573 7465 725f 6e61 6d65  max_cluster_name
-00007e90: 5f6c 656e 6774 6828 2929 0a20 2020 207a  _length()).    z
-00007ea0: 6f6e 6520 3d20 2775 732d 7765 7374 322d  one = 'us-west2-
-00007eb0: 6127 0a20 2020 2071 7565 7279 5f63 6d64  a'.    query_cmd
-00007ec0: 203d 2028 6627 6763 6c6f 7564 2063 6f6d   = (f'gcloud com
-00007ed0: 7075 7465 2069 6e73 7461 6e63 6573 206c  pute instances l
-00007ee0: 6973 7420 2d2d 6669 6c74 6572 3d27 0a20  ist --filter='. 
-00007ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007f00: 6627 2228 6c61 6265 6c73 2e72 6179 2d63  f'"(labels.ray-c
-00007f10: 6c75 7374 6572 2d6e 616d 653d 7b6e 616d  luster-name={nam
-00007f20: 655f 6f6e 5f63 6c6f 7564 7d29 2220 270a  e_on_cloud})" '.
-00007f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007f40: 2066 272d 2d7a 6f6e 6573 3d7b 7a6f 6e65   f'--zones={zone
-00007f50: 7d20 2d2d 666f 726d 6174 3d22 7661 6c75  } --format="valu
-00007f60: 6528 6e61 6d65 2922 2729 0a20 2020 2073  e(name)"').    s
-00007f70: 746f 705f 636d 6420 3d20 2866 2767 636c  top_cmd = (f'gcl
-00007f80: 6f75 6420 636f 6d70 7574 6520 696e 7374  oud compute inst
-00007f90: 616e 6365 7320 7374 6f70 202d 2d7a 6f6e  ances stop --zon
-00007fa0: 653d 7b7a 6f6e 657d 270a 2020 2020 2020  e={zone}'.      
-00007fb0: 2020 2020 2020 2020 2020 6627 202d 2d71            f' --q
-00007fc0: 7569 6574 2024 287b 7175 6572 795f 636d  uiet $({query_cm
-00007fd0: 647d 2927 290a 2020 2020 7465 7374 203d  d})').    test =
-00007fe0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00007ff0: 6763 705f 7374 616c 655f 6a6f 625f 6d61  gcp_stale_job_ma
-00008000: 6e75 616c 5f72 6573 7461 7274 272c 0a20  nual_restart',. 
-00008010: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00008020: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00008030: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
-00008040: 2d63 6c6f 7564 2067 6370 202d 2d7a 6f6e  -cloud gcp --zon
-00008050: 6520 7b7a 6f6e 657d 2022 6563 686f 2068  e {zone} "echo h
-00008060: 6922 272c 0a20 2020 2020 2020 2020 2020  i"',.           
-00008070: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00008080: 657d 202d 6420 2265 6368 6f20 7374 6172  e} -d "echo star
-00008090: 743b 2073 6c65 6570 2031 3030 3030 2227  t; sleep 10000"'
-000080a0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-000080b0: 5374 6f70 2074 6865 2063 6c75 7374 6572  Stop the cluster
-000080c0: 206d 616e 7561 6c6c 792e 0a20 2020 2020   manually..     
-000080d0: 2020 2020 2020 2073 746f 705f 636d 642c         stop_cmd,
-000080e0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-000080f0: 6565 7020 3430 272c 0a20 2020 2020 2020  eep 40',.       
-00008100: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00008110: 6820 2d63 207b 6e61 6d65 7d20 2d79 2022  h -c {name} -y "
-00008120: 6563 686f 2068 6922 272c 0a20 2020 2020  echo hi"',.     
-00008130: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00008140: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-00008150: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
-00008160: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00008170: 6d65 7d20 3320 2d2d 7374 6174 7573 272c  me} 3 --status',
-00008180: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
-00008190: 6e73 7572 6520 7468 6520 736b 796c 6574  nsure the skylet
-000081a0: 2075 7064 6174 6564 2074 6865 2073 7461   updated the sta
-000081b0: 6c65 206a 6f62 2073 7461 7475 732e 0a20  le job status.. 
-000081c0: 2020 2020 2020 2020 2020 2066 2773 6c65             f'sle
-000081d0: 6570 207b 6576 656e 7473 2e4a 6f62 5363  ep {events.JobSc
-000081e0: 6865 6475 6c65 7245 7665 6e74 2e45 5645  hedulerEvent.EVE
-000081f0: 4e54 5f49 4e54 4552 5641 4c5f 5345 434f  NT_INTERVAL_SECO
-00008200: 4e44 537d 272c 0a20 2020 2020 2020 2020  NDS}',.         
-00008210: 2020 2066 2773 3d24 2873 6b79 2071 7565     f's=$(sky que
-00008220: 7565 207b 6e61 6d65 7d29 3b20 6563 686f  ue {name}); echo
-00008230: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
-00008240: 6f3b 2065 6368 6f20 2224 7322 207c 2067  o; echo "$s" | g
-00008250: 7265 7020 4641 494c 4544 272c 0a20 2020  rep FAILED',.   
-00008260: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00008270: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-00008280: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
-00008290: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-000082a0: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
-000082b0: 2d2d 2043 6865 636b 2053 6b79 2773 2065  -- Check Sky's e
-000082c0: 6e76 6972 6f6e 6d65 6e74 2076 6172 6961  nvironment varia
-000082d0: 626c 6573 3b20 776f 726b 6469 722e 202d  bles; workdir. -
-000082e0: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
-000082f0: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
-00008300: 7461 636b 2020 2320 5265 7175 6972 6573  tack  # Requires
-00008310: 2061 6d61 7a6f 6e20 5333 0a40 7079 7465   amazon S3.@pyte
-00008320: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
-00008330: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
-00008340: 7570 706f 7274 206e 756d 5f6e 6f64 6573  upport num_nodes
-00008350: 203e 2031 2079 6574 0a64 6566 2074 6573   > 1 yet.def tes
-00008360: 745f 656e 765f 6368 6563 6b28 6765 6e65  t_env_check(gene
-00008370: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
-00008380: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00008390: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-000083a0: 2020 2020 746f 7461 6c5f 7469 6d65 6f75      total_timeou
-000083b0: 745f 6d69 6e75 7465 7320 3d20 3235 2069  t_minutes = 25 i
-000083c0: 6620 6765 6e65 7269 635f 636c 6f75 6420  f generic_cloud 
-000083d0: 3d3d 2027 617a 7572 6527 2065 6c73 6520  == 'azure' else 
-000083e0: 3135 0a20 2020 2074 6573 7420 3d20 5465  15.    test = Te
-000083f0: 7374 280a 2020 2020 2020 2020 2765 6e76  st(.        'env
-00008400: 5f63 6865 636b 272c 0a20 2020 2020 2020  _check',.       
-00008410: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00008420: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00008430: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-00008440: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-00008450: 202d 2d64 6574 6163 682d 7365 7475 7020   --detach-setup 
-00008460: 6578 616d 706c 6573 2f65 6e76 5f63 6865  examples/env_che
-00008470: 636b 2e79 616d 6c27 2c0a 2020 2020 2020  ck.yaml',.      
-00008480: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-00008490: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
-000084a0: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
-000084b0: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
-000084c0: 2e0a 2020 2020 2020 2020 5d2c 0a20 2020  ..        ],.   
-000084d0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-000084e0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-000084f0: 2020 2020 7469 6d65 6f75 743d 746f 7461      timeout=tota
-00008500: 6c5f 7469 6d65 6f75 745f 6d69 6e75 7465  l_timeout_minute
-00008510: 7320 2a20 3630 2c0a 2020 2020 290a 2020  s * 60,.    ).  
-00008520: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00008530: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-00008540: 2d2d 2d20 6669 6c65 5f6d 6f75 6e74 7320  --- file_mounts 
-00008550: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
-00008560: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
-00008570: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
-00008580: 7570 706f 7274 206e 756d 5f6e 6f64 6573  upport num_nodes
-00008590: 203e 2031 2079 6574 2e20 5275 6e20 7465   > 1 yet. Run te
-000085a0: 7374 5f73 6370 5f66 696c 655f 6d6f 756e  st_scp_file_moun
-000085b0: 7473 2069 6e73 7465 6164 2e0a 6465 6620  ts instead..def 
-000085c0: 7465 7374 5f66 696c 655f 6d6f 756e 7473  test_file_mounts
-000085d0: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
-000085e0: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
-000085f0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00008600: 6d65 2829 0a20 2020 2065 7874 7261 5f66  me().    extra_f
-00008610: 6c61 6773 203d 2027 270a 2020 2020 6966  lags = ''.    if
-00008620: 2067 656e 6572 6963 5f63 6c6f 7564 2069   generic_cloud i
-00008630: 6e20 276b 7562 6572 6e65 7465 7327 3a0a  n 'kubernetes':.
-00008640: 2020 2020 2020 2020 2320 4b75 6265 726e          # Kubern
-00008650: 6574 6573 2064 6f65 7320 6e6f 7420 7375  etes does not su
-00008660: 7070 6f72 7420 6d75 6c74 692d 6e6f 6465  pport multi-node
-00008670: 0a20 2020 2020 2020 2023 204e 4f54 453a  .        # NOTE:
-00008680: 2054 6869 7320 7465 7374 2077 696c 6c20   This test will 
-00008690: 6661 696c 2069 6620 796f 7520 6861 7665  fail if you have
-000086a0: 2061 204b 7562 6572 6e65 7465 7320 636c   a Kubernetes cl
-000086b0: 7573 7465 7220 7275 6e6e 696e 6720 6f6e  uster running on
-000086c0: 0a20 2020 2020 2020 2023 2020 6172 6d36  .        #  arm6
-000086d0: 3420 2865 2e67 2e2c 2041 7070 6c65 2053  4 (e.g., Apple S
-000086e0: 696c 6963 6f6e 2920 7369 6e63 6520 676f  ilicon) since go
-000086f0: 6f66 7973 2064 6f65 7320 6e6f 7420 776f  ofys does not wo
-00008700: 726b 206f 6e20 6172 6d36 342e 0a20 2020  rk on arm64..   
-00008710: 2020 2020 2065 7874 7261 5f66 6c61 6773       extra_flags
-00008720: 203d 2027 2d2d 6e75 6d2d 6e6f 6465 7320   = '--num-nodes 
-00008730: 3127 0a20 2020 2074 6573 745f 636f 6d6d  1'.    test_comm
-00008740: 616e 6473 203d 205b 0a20 2020 2020 2020  ands = [.       
-00008750: 202a 7374 6f72 6167 655f 7365 7475 705f   *storage_setup_
-00008760: 636f 6d6d 616e 6473 2c0a 2020 2020 2020  commands,.      
-00008770: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00008780: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
-00008790: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-000087a0: 7564 7d20 7b65 7874 7261 5f66 6c61 6773  ud} {extra_flags
-000087b0: 7d20 6578 616d 706c 6573 2f75 7369 6e67  } examples/using
-000087c0: 5f66 696c 655f 6d6f 756e 7473 2e79 616d  _file_mounts.yam
-000087d0: 6c27 2c0a 2020 2020 2020 2020 6627 736b  l',.        f'sk
-000087e0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-000087f0: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-00008800: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-00008810: 6365 6564 6564 2e0a 2020 2020 5d0a 2020  ceeded..    ].  
-00008820: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00008830: 2020 2020 2020 2027 7573 696e 675f 6669         'using_fi
-00008840: 6c65 5f6d 6f75 6e74 7327 2c0a 2020 2020  le_mounts',.    
-00008850: 2020 2020 7465 7374 5f63 6f6d 6d61 6e64      test_command
-00008860: 732c 0a20 2020 2020 2020 2066 2773 6b79  s,.        f'sky
-00008870: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-00008880: 2c0a 2020 2020 2020 2020 5f67 6574 5f74  ,.        _get_t
-00008890: 696d 656f 7574 2867 656e 6572 6963 5f63  imeout(generic_c
-000088a0: 6c6f 7564 2c20 3230 202a 2036 3029 2c20  loud, 20 * 60), 
-000088b0: 2023 2032 3020 6d69 6e73 0a20 2020 2029   # 20 mins.    )
-000088c0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-000088d0: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-000088e0: 742e 6d61 726b 2e73 6370 0a64 6566 2074  t.mark.scp.def t
-000088f0: 6573 745f 7363 705f 6669 6c65 5f6d 6f75  est_scp_file_mou
-00008900: 6e74 7328 293a 0a20 2020 206e 616d 6520  nts():.    name 
-00008910: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00008920: 616d 6528 290a 2020 2020 7465 7374 5f63  ame().    test_c
-00008930: 6f6d 6d61 6e64 7320 3d20 5b0a 2020 2020  ommands = [.    
-00008940: 2020 2020 2a73 746f 7261 6765 5f73 6574      *storage_set
-00008950: 7570 5f63 6f6d 6d61 6e64 732c 0a20 2020  up_commands,.   
-00008960: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00008970: 6820 2d79 202d 6320 7b6e 616d 657d 207b  h -y -c {name} {
-00008980: 5343 505f 5459 5045 7d20 2d2d 6e75 6d2d  SCP_TYPE} --num-
-00008990: 6e6f 6465 7320 3120 6578 616d 706c 6573  nodes 1 examples
-000089a0: 2f75 7369 6e67 5f66 696c 655f 6d6f 756e  /using_file_moun
-000089b0: 7473 2e79 616d 6c27 2c0a 2020 2020 2020  ts.yaml',.      
-000089c0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-000089d0: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-000089e0: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-000089f0: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-00008a00: 2020 5d0a 2020 2020 7465 7374 203d 2054    ].    test = T
-00008a10: 6573 7428 0a20 2020 2020 2020 2027 5343  est(.        'SC
-00008a20: 505f 7573 696e 675f 6669 6c65 5f6d 6f75  P_using_file_mou
-00008a30: 6e74 7327 2c0a 2020 2020 2020 2020 7465  nts',.        te
-00008a40: 7374 5f63 6f6d 6d61 6e64 732c 0a20 2020  st_commands,.   
-00008a50: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-00008a60: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-00008a70: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
-00008a80: 2036 302c 2020 2320 3230 206d 696e 730a   60,  # 20 mins.
-00008a90: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00008aa0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00008ab0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
-00008ac0: 6c75 6964 7374 6163 6b20 2023 2052 6571  luidstack  # Req
-00008ad0: 7569 7265 7320 4743 5020 746f 2062 6520  uires GCP to be 
-00008ae0: 656e 6162 6c65 640a 6465 6620 7465 7374  enabled.def test
-00008af0: 5f75 7369 6e67 5f66 696c 655f 6d6f 756e  _using_file_moun
-00008b00: 7473 5f77 6974 685f 656e 765f 7661 7273  ts_with_env_vars
-00008b10: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
-00008b20: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
-00008b30: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00008b40: 6d65 2829 0a20 2020 2073 746f 7261 6765  me().    storage
-00008b50: 5f6e 616d 6520 3d20 5465 7374 5374 6f72  _name = TestStor
-00008b60: 6167 6557 6974 6843 7265 6465 6e74 6961  ageWithCredentia
-00008b70: 6c73 2e67 656e 6572 6174 655f 6275 636b  ls.generate_buck
-00008b80: 6574 5f6e 616d 6528 290a 2020 2020 7465  et_name().    te
-00008b90: 7374 5f63 6f6d 6d61 6e64 7320 3d20 5b0a  st_commands = [.
-00008ba0: 2020 2020 2020 2020 2a73 746f 7261 6765          *storage
-00008bb0: 5f73 6574 7570 5f63 6f6d 6d61 6e64 732c  _setup_commands,
-00008bc0: 0a20 2020 2020 2020 2028 6627 736b 7920  .        (f'sky 
-00008bd0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-00008be0: 6d65 7d20 2d2d 6370 7573 2032 2b20 2d2d  me} --cpus 2+ --
-00008bf0: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-00008c00: 6c6f 7564 7d20 270a 2020 2020 2020 2020  loud} '.        
-00008c10: 2027 6578 616d 706c 6573 2f75 7369 6e67   'examples/using
-00008c20: 5f66 696c 655f 6d6f 756e 7473 5f77 6974  _file_mounts_wit
-00008c30: 685f 656e 765f 7661 7273 2e79 616d 6c20  h_env_vars.yaml 
-00008c40: 270a 2020 2020 2020 2020 2066 272d 2d65  '.         f'--e
-00008c50: 6e76 204d 595f 4255 434b 4554 3d7b 7374  nv MY_BUCKET={st
-00008c60: 6f72 6167 655f 6e61 6d65 7d27 292c 0a20  orage_name}'),. 
-00008c70: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00008c80: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-00008c90: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-00008ca0: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-00008cb0: 642e 0a20 2020 2020 2020 2023 204f 7665  d..        # Ove
-00008cc0: 7272 6964 6520 7769 7468 202d 2d65 6e76  rride with --env
-00008cd0: 3a0a 2020 2020 2020 2020 2866 2773 6b79  :.        (f'sky
-00008ce0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00008cf0: 616d 657d 2d32 202d 2d63 7075 7320 322b  ame}-2 --cpus 2+
-00008d00: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-00008d10: 635f 636c 6f75 647d 2027 0a20 2020 2020  c_cloud} '.     
-00008d20: 2020 2020 2765 7861 6d70 6c65 732f 7573      'examples/us
-00008d30: 696e 675f 6669 6c65 5f6d 6f75 6e74 735f  ing_file_mounts_
-00008d40: 7769 7468 5f65 6e76 5f76 6172 732e 7961  with_env_vars.ya
-00008d50: 6d6c 2027 0a20 2020 2020 2020 2020 6627  ml '.         f'
-00008d60: 2d2d 656e 7620 4d59 5f42 5543 4b45 543d  --env MY_BUCKET=
-00008d70: 7b73 746f 7261 6765 5f6e 616d 657d 2027  {storage_name} '
-00008d80: 0a20 2020 2020 2020 2020 272d 2d65 6e76  .         '--env
-00008d90: 204d 595f 4c4f 4341 4c5f 5041 5448 3d74   MY_LOCAL_PATH=t
-00008da0: 6d70 6669 6c65 2729 2c0a 2020 2020 2020  mpfile'),.      
-00008db0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00008dc0: 6d65 7d2d 3220 3120 2d2d 7374 6174 7573  me}-2 1 --status
-00008dd0: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-00008de0: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
-00008df0: 2020 2020 5d0a 2020 2020 7465 7374 203d      ].    test =
-00008e00: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00008e10: 7573 696e 675f 6669 6c65 5f6d 6f75 6e74  using_file_mount
-00008e20: 735f 7769 7468 5f65 6e76 5f76 6172 7327  s_with_env_vars'
-00008e30: 2c0a 2020 2020 2020 2020 7465 7374 5f63  ,.        test_c
-00008e40: 6f6d 6d61 6e64 732c 0a20 2020 2020 2020  ommands,.       
-00008e50: 2028 6627 736b 7920 646f 776e 202d 7920   (f'sky down -y 
-00008e60: 7b6e 616d 657d 207b 6e61 6d65 7d2d 3227  {name} {name}-2'
-00008e70: 2c0a 2020 2020 2020 2020 2066 2773 6b79  ,.         f'sky
-00008e80: 2073 746f 7261 6765 2064 656c 6574 6520   storage delete 
-00008e90: 2d79 207b 7374 6f72 6167 655f 6e61 6d65  -y {storage_name
-00008ea0: 7d20 7b73 746f 7261 6765 5f6e 616d 657d  } {storage_name}
-00008eb0: 2d32 2729 2c0a 2020 2020 2020 2020 7469  -2'),.        ti
-00008ec0: 6d65 6f75 743d 3230 202a 2036 302c 2020  meout=20 * 60,  
-00008ed0: 2320 3230 206d 696e 730a 2020 2020 290a  # 20 mins.    ).
-00008ee0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00008ef0: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
-00008f00: 2d2d 2d2d 2d20 7374 6f72 6167 6520 2d2d  ----- storage --
-00008f10: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
-00008f20: 2e6d 6172 6b2e 6177 730a 6465 6620 7465  .mark.aws.def te
-00008f30: 7374 5f61 7773 5f73 746f 7261 6765 5f6d  st_aws_storage_m
-00008f40: 6f75 6e74 735f 7769 7468 5f73 746f 7028  ounts_with_stop(
-00008f50: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-00008f60: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-00008f70: 290a 2020 2020 7374 6f72 6167 655f 6e61  ).    storage_na
-00008f80: 6d65 203d 2066 2773 6b79 2d74 6573 742d  me = f'sky-test-
-00008f90: 7b69 6e74 2874 696d 652e 7469 6d65 2829  {int(time.time()
-00008fa0: 297d 270a 2020 2020 7465 6d70 6c61 7465  )}'.    template
-00008fb0: 5f73 7472 203d 2070 6174 686c 6962 2e50  _str = pathlib.P
-00008fc0: 6174 6828 0a20 2020 2020 2020 2027 7465  ath(.        'te
-00008fd0: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
-00008fe0: 6573 745f 7374 6f72 6167 655f 6d6f 756e  est_storage_moun
-00008ff0: 7469 6e67 2e79 616d 6c2e 6a32 2729 2e72  ting.yaml.j2').r
-00009000: 6561 645f 7465 7874 2829 0a20 2020 2074  ead_text().    t
-00009010: 656d 706c 6174 6520 3d20 6a69 6e6a 6132  emplate = jinja2
-00009020: 2e54 656d 706c 6174 6528 7465 6d70 6c61  .Template(templa
-00009030: 7465 5f73 7472 290a 2020 2020 636f 6e74  te_str).    cont
-00009040: 656e 7420 3d20 7465 6d70 6c61 7465 2e72  ent = template.r
-00009050: 656e 6465 7228 7374 6f72 6167 655f 6e61  ender(storage_na
-00009060: 6d65 3d73 746f 7261 6765 5f6e 616d 6529  me=storage_name)
-00009070: 0a20 2020 2077 6974 6820 7465 6d70 6669  .    with tempfi
-00009080: 6c65 2e4e 616d 6564 5465 6d70 6f72 6172  le.NamedTemporar
-00009090: 7946 696c 6528 7375 6666 6978 3d27 2e79  yFile(suffix='.y
-000090a0: 616d 6c27 2c20 6d6f 6465 3d27 7727 2920  aml', mode='w') 
-000090b0: 6173 2066 3a0a 2020 2020 2020 2020 662e  as f:.        f.
-000090c0: 7772 6974 6528 636f 6e74 656e 7429 0a20  write(content). 
-000090d0: 2020 2020 2020 2066 2e66 6c75 7368 2829         f.flush()
-000090e0: 0a20 2020 2020 2020 2066 696c 655f 7061  .        file_pa
-000090f0: 7468 203d 2066 2e6e 616d 650a 2020 2020  th = f.name.    
-00009100: 2020 2020 7465 7374 5f63 6f6d 6d61 6e64      test_command
-00009110: 7320 3d20 5b0a 2020 2020 2020 2020 2020  s = [.          
-00009120: 2020 2a73 746f 7261 6765 5f73 6574 7570    *storage_setup
-00009130: 5f63 6f6d 6d61 6e64 732c 0a20 2020 2020  _commands,.     
-00009140: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00009150: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-00009160: 202d 2d63 6c6f 7564 2061 7773 207b 6669   --cloud aws {fi
-00009170: 6c65 5f70 6174 687d 272c 0a20 2020 2020  le_path}',.     
-00009180: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00009190: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-000091a0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-000091b0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-000091c0: 2020 2020 2020 2020 2020 2066 2761 7773             f'aws
-000091d0: 2073 3320 6c73 207b 7374 6f72 6167 655f   s3 ls {storage_
-000091e0: 6e61 6d65 7d2f 6865 6c6c 6f2e 7478 7427  name}/hello.txt'
-000091f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00009200: 736b 7920 7374 6f70 202d 7920 7b6e 616d  sky stop -y {nam
-00009210: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
-00009220: 2066 2773 6b79 2073 7461 7274 202d 7920   f'sky start -y 
-00009230: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
-00009240: 2020 2020 2023 2043 6865 636b 2069 6620       # Check if 
-00009250: 6865 6c6c 6f2e 7478 7420 6672 6f6d 206d  hello.txt from m
-00009260: 6f75 6e74 696e 6720 6275 636b 6574 2065  ounting bucket e
-00009270: 7869 7374 7320 6166 7465 7220 7265 7374  xists after rest
-00009280: 6172 7420 696e 0a20 2020 2020 2020 2020  art in.         
-00009290: 2020 2023 2074 6865 206d 6f75 6e74 6564     # the mounted
-000092a0: 2064 6972 6563 746f 7279 0a20 2020 2020   directory.     
-000092b0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-000092c0: 6320 7b6e 616d 657d 202d 2d20 2273 6574  c {name} -- "set
-000092d0: 202d 6578 3b20 6c73 202f 6d6f 756e 745f   -ex; ls /mount_
-000092e0: 7072 6976 6174 655f 6d6f 756e 742f 6865  private_mount/he
-000092f0: 6c6c 6f2e 7478 7422 270a 2020 2020 2020  llo.txt"'.      
-00009300: 2020 5d0a 2020 2020 2020 2020 7465 7374    ].        test
-00009310: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00009320: 2020 2020 2027 6177 735f 7374 6f72 6167       'aws_storag
-00009330: 655f 6d6f 756e 7473 272c 0a20 2020 2020  e_mounts',.     
-00009340: 2020 2020 2020 2074 6573 745f 636f 6d6d         test_comm
-00009350: 616e 6473 2c0a 2020 2020 2020 2020 2020  ands,.          
-00009360: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00009370: 7b6e 616d 657d 3b20 736b 7920 7374 6f72  {name}; sky stor
-00009380: 6167 6520 6465 6c65 7465 202d 7920 7b73  age delete -y {s
-00009390: 746f 7261 6765 5f6e 616d 657d 272c 0a20  torage_name}',. 
-000093a0: 2020 2020 2020 2020 2020 2074 696d 656f             timeo
-000093b0: 7574 3d32 3020 2a20 3630 2c20 2023 2032  ut=20 * 60,  # 2
-000093c0: 3020 6d69 6e73 0a20 2020 2020 2020 2029  0 mins.        )
-000093d0: 0a20 2020 2020 2020 2072 756e 5f6f 6e65  .        run_one
-000093e0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-000093f0: 7974 6573 742e 6d61 726b 2e67 6370 0a64  ytest.mark.gcp.d
-00009400: 6566 2074 6573 745f 6763 705f 7374 6f72  ef test_gcp_stor
-00009410: 6167 655f 6d6f 756e 7473 5f77 6974 685f  age_mounts_with_
-00009420: 7374 6f70 2829 3a0a 2020 2020 6e61 6d65  stop():.    name
-00009430: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-00009440: 6e61 6d65 2829 0a20 2020 2073 746f 7261  name().    stora
-00009450: 6765 5f6e 616d 6520 3d20 6627 736b 792d  ge_name = f'sky-
-00009460: 7465 7374 2d7b 696e 7428 7469 6d65 2e74  test-{int(time.t
-00009470: 696d 6528 2929 7d27 0a20 2020 2074 656d  ime())}'.    tem
-00009480: 706c 6174 655f 7374 7220 3d20 7061 7468  plate_str = path
-00009490: 6c69 622e 5061 7468 280a 2020 2020 2020  lib.Path(.      
-000094a0: 2020 2774 6573 7473 2f74 6573 745f 7961    'tests/test_ya
-000094b0: 6d6c 732f 7465 7374 5f73 746f 7261 6765  mls/test_storage
-000094c0: 5f6d 6f75 6e74 696e 672e 7961 6d6c 2e6a  _mounting.yaml.j
-000094d0: 3227 292e 7265 6164 5f74 6578 7428 290a  2').read_text().
-000094e0: 2020 2020 7465 6d70 6c61 7465 203d 206a      template = j
-000094f0: 696e 6a61 322e 5465 6d70 6c61 7465 2874  inja2.Template(t
-00009500: 656d 706c 6174 655f 7374 7229 0a20 2020  emplate_str).   
-00009510: 2063 6f6e 7465 6e74 203d 2074 656d 706c   content = templ
-00009520: 6174 652e 7265 6e64 6572 2873 746f 7261  ate.render(stora
-00009530: 6765 5f6e 616d 653d 7374 6f72 6167 655f  ge_name=storage_
-00009540: 6e61 6d65 290a 2020 2020 7769 7468 2074  name).    with t
-00009550: 656d 7066 696c 652e 4e61 6d65 6454 656d  empfile.NamedTem
-00009560: 706f 7261 7279 4669 6c65 2873 7566 6669  poraryFile(suffi
-00009570: 783d 272e 7961 6d6c 272c 206d 6f64 653d  x='.yaml', mode=
-00009580: 2777 2729 2061 7320 663a 0a20 2020 2020  'w') as f:.     
-00009590: 2020 2066 2e77 7269 7465 2863 6f6e 7465     f.write(conte
-000095a0: 6e74 290a 2020 2020 2020 2020 662e 666c  nt).        f.fl
-000095b0: 7573 6828 290a 2020 2020 2020 2020 6669  ush().        fi
-000095c0: 6c65 5f70 6174 6820 3d20 662e 6e61 6d65  le_path = f.name
-000095d0: 0a20 2020 2020 2020 2074 6573 745f 636f  .        test_co
-000095e0: 6d6d 616e 6473 203d 205b 0a20 2020 2020  mmands = [.     
-000095f0: 2020 2020 2020 202a 7374 6f72 6167 655f         *storage_
-00009600: 7365 7475 705f 636f 6d6d 616e 6473 2c0a  setup_commands,.
-00009610: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00009620: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-00009630: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6763  name} --cloud gc
-00009640: 7020 7b66 696c 655f 7061 7468 7d27 2c0a  p {file_path}',.
-00009650: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00009660: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-00009670: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-00009680: 7375 7265 206a 6f62 2073 7563 6365 6564  sure job succeed
-00009690: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-000096a0: 6627 6773 7574 696c 206c 7320 6773 3a2f  f'gsutil ls gs:/
-000096b0: 2f7b 7374 6f72 6167 655f 6e61 6d65 7d2f  /{storage_name}/
-000096c0: 6865 6c6c 6f2e 7478 7427 2c0a 2020 2020  hello.txt',.    
-000096d0: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-000096e0: 6f70 202d 7920 7b6e 616d 657d 272c 0a20  op -y {name}',. 
-000096f0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00009700: 2073 7461 7274 202d 7920 7b6e 616d 657d   start -y {name}
-00009710: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-00009720: 2043 6865 636b 2069 6620 6865 6c6c 6f2e   Check if hello.
-00009730: 7478 7420 6672 6f6d 206d 6f75 6e74 696e  txt from mountin
-00009740: 6720 6275 636b 6574 2065 7869 7374 7320  g bucket exists 
-00009750: 6166 7465 7220 7265 7374 6172 7420 696e  after restart in
-00009760: 0a20 2020 2020 2020 2020 2020 2023 2074  .            # t
-00009770: 6865 206d 6f75 6e74 6564 2064 6972 6563  he mounted direc
-00009780: 746f 7279 0a20 2020 2020 2020 2020 2020  tory.           
-00009790: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-000097a0: 657d 202d 2d20 2273 6574 202d 6578 3b20  e} -- "set -ex; 
-000097b0: 6c73 202f 6d6f 756e 745f 7072 6976 6174  ls /mount_privat
-000097c0: 655f 6d6f 756e 742f 6865 6c6c 6f2e 7478  e_mount/hello.tx
-000097d0: 7422 270a 2020 2020 2020 2020 5d0a 2020  t"'.        ].  
-000097e0: 2020 2020 2020 7465 7374 203d 2054 6573        test = Tes
-000097f0: 7428 0a20 2020 2020 2020 2020 2020 2027  t(.            '
-00009800: 6763 705f 7374 6f72 6167 655f 6d6f 756e  gcp_storage_moun
-00009810: 7473 272c 0a20 2020 2020 2020 2020 2020  ts',.           
-00009820: 2074 6573 745f 636f 6d6d 616e 6473 2c0a   test_commands,.
-00009830: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00009840: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-00009850: 3b20 736b 7920 7374 6f72 6167 6520 6465  ; sky storage de
-00009860: 6c65 7465 202d 7920 7b73 746f 7261 6765  lete -y {storage
-00009870: 5f6e 616d 657d 272c 0a20 2020 2020 2020  _name}',.       
-00009880: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
-00009890: 2a20 3630 2c20 2023 2032 3020 6d69 6e73  * 60,  # 20 mins
-000098a0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-000098b0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-000098c0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-000098d0: 6d61 726b 2e6b 7562 6572 6e65 7465 730a  mark.kubernetes.
-000098e0: 6465 6620 7465 7374 5f6b 7562 6572 6e65  def test_kuberne
-000098f0: 7465 735f 7374 6f72 6167 655f 6d6f 756e  tes_storage_moun
-00009900: 7473 2829 3a0a 2020 2020 2320 5465 7374  ts():.    # Test
-00009910: 7320 6275 636b 6574 206d 6f75 6e74 696e  s bucket mountin
-00009920: 6720 6f6e 206b 3873 2c20 6173 7375 6d69  g on k8s, assumi
-00009930: 6e67 2053 3320 6973 2063 6f6e 6669 6775  ng S3 is configu
-00009940: 7265 642e 0a20 2020 2023 2054 6869 7320  red..    # This 
-00009950: 7465 7374 2077 696c 6c20 6661 696c 2069  test will fail i
-00009960: 6620 7275 6e20 6f6e 206e 6f6e 2078 3836  f run on non x86
-00009970: 5f36 3420 6172 6368 6974 6563 7475 7265  _64 architecture
-00009980: 2c20 7369 6e63 6520 676f 6f66 7973 2069  , since goofys i
-00009990: 730a 2020 2020 2320 6275 696c 7420 666f  s.    # built fo
-000099a0: 7220 7838 365f 3634 206f 6e6c 792e 0a20  r x86_64 only.. 
-000099b0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-000099c0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-000099d0: 2020 7374 6f72 6167 655f 6e61 6d65 203d    storage_name =
-000099e0: 2066 2773 6b79 2d74 6573 742d 7b69 6e74   f'sky-test-{int
-000099f0: 2874 696d 652e 7469 6d65 2829 297d 270a  (time.time())}'.
-00009a00: 2020 2020 7465 6d70 6c61 7465 5f73 7472      template_str
-00009a10: 203d 2070 6174 686c 6962 2e50 6174 6828   = pathlib.Path(
-00009a20: 0a20 2020 2020 2020 2027 7465 7374 732f  .        'tests/
-00009a30: 7465 7374 5f79 616d 6c73 2f74 6573 745f  test_yamls/test_
-00009a40: 7374 6f72 6167 655f 6d6f 756e 7469 6e67  storage_mounting
-00009a50: 2e79 616d 6c2e 6a32 2729 2e72 6561 645f  .yaml.j2').read_
-00009a60: 7465 7874 2829 0a20 2020 2074 656d 706c  text().    templ
-00009a70: 6174 6520 3d20 6a69 6e6a 6132 2e54 656d  ate = jinja2.Tem
-00009a80: 706c 6174 6528 7465 6d70 6c61 7465 5f73  plate(template_s
-00009a90: 7472 290a 2020 2020 636f 6e74 656e 7420  tr).    content 
-00009aa0: 3d20 7465 6d70 6c61 7465 2e72 656e 6465  = template.rende
-00009ab0: 7228 7374 6f72 6167 655f 6e61 6d65 3d73  r(storage_name=s
-00009ac0: 746f 7261 6765 5f6e 616d 6529 0a20 2020  torage_name).   
-00009ad0: 2077 6974 6820 7465 6d70 6669 6c65 2e4e   with tempfile.N
-00009ae0: 616d 6564 5465 6d70 6f72 6172 7946 696c  amedTemporaryFil
-00009af0: 6528 7375 6666 6978 3d27 2e79 616d 6c27  e(suffix='.yaml'
-00009b00: 2c20 6d6f 6465 3d27 7727 2920 6173 2066  , mode='w') as f
-00009b10: 3a0a 2020 2020 2020 2020 662e 7772 6974  :.        f.writ
-00009b20: 6528 636f 6e74 656e 7429 0a20 2020 2020  e(content).     
-00009b30: 2020 2066 2e66 6c75 7368 2829 0a20 2020     f.flush().   
-00009b40: 2020 2020 2066 696c 655f 7061 7468 203d       file_path =
-00009b50: 2066 2e6e 616d 650a 2020 2020 2020 2020   f.name.        
-00009b60: 7465 7374 5f63 6f6d 6d61 6e64 7320 3d20  test_commands = 
-00009b70: 5b0a 2020 2020 2020 2020 2020 2020 2a73  [.            *s
-00009b80: 746f 7261 6765 5f73 6574 7570 5f63 6f6d  torage_setup_com
-00009b90: 6d61 6e64 732c 0a20 2020 2020 2020 2020  mands,.         
-00009ba0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00009bb0: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
-00009bc0: 6c6f 7564 206b 7562 6572 6e65 7465 7320  loud kubernetes 
-00009bd0: 7b66 696c 655f 7061 7468 7d27 2c0a 2020  {file_path}',.  
-00009be0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00009bf0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
-00009c00: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-00009c10: 7265 206a 6f62 2073 7563 6365 6564 6564  re job succeeded
-00009c20: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00009c30: 6177 7320 7333 206c 7320 7b73 746f 7261  aws s3 ls {stora
-00009c40: 6765 5f6e 616d 657d 2f68 656c 6c6f 2e74  ge_name}/hello.t
-00009c50: 7874 207c 7c20 270a 2020 2020 2020 2020  xt || '.        
-00009c60: 2020 2020 6627 6773 7574 696c 206c 7320      f'gsutil ls 
-00009c70: 6773 3a2f 2f7b 7374 6f72 6167 655f 6e61  gs://{storage_na
-00009c80: 6d65 7d2f 6865 6c6c 6f2e 7478 7427 2c0a  me}/hello.txt',.
-00009c90: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-00009ca0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00009cb0: 2020 2020 2020 2020 2020 2027 6b75 6265             'kube
-00009cc0: 726e 6574 6573 5f73 746f 7261 6765 5f6d  rnetes_storage_m
-00009cd0: 6f75 6e74 7327 2c0a 2020 2020 2020 2020  ounts',.        
-00009ce0: 2020 2020 7465 7374 5f63 6f6d 6d61 6e64      test_command
-00009cf0: 732c 0a20 2020 2020 2020 2020 2020 2066  s,.            f
-00009d00: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00009d10: 6d65 7d3b 2073 6b79 2073 746f 7261 6765  me}; sky storage
-00009d20: 2064 656c 6574 6520 2d79 207b 7374 6f72   delete -y {stor
-00009d30: 6167 655f 6e61 6d65 7d27 2c0a 2020 2020  age_name}',.    
-00009d40: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-00009d50: 3230 202a 2036 302c 2020 2320 3230 206d  20 * 60,  # 20 m
-00009d60: 696e 730a 2020 2020 2020 2020 290a 2020  ins.        ).  
-00009d70: 2020 2020 2020 7275 6e5f 6f6e 655f 7465        run_one_te
-00009d80: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-00009d90: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
-00009da0: 697a 6528 0a20 2020 2027 696d 6167 655f  ize(.    'image_
-00009db0: 6964 272c 0a20 2020 205b 0a20 2020 2020  id',.    [.     
-00009dc0: 2020 2027 646f 636b 6572 3a6e 7669 6469     'docker:nvidi
-00009dd0: 612f 6375 6461 3a31 312e 382e 302d 6465  a/cuda:11.8.0-de
-00009de0: 7665 6c2d 7562 756e 7475 3138 2e30 3427  vel-ubuntu18.04'
-00009df0: 2c0a 2020 2020 2020 2020 2764 6f63 6b65  ,.        'docke
-00009e00: 723a 7562 756e 7475 3a31 382e 3034 272c  r:ubuntu:18.04',
-00009e10: 0a20 2020 2020 2020 2023 2054 6573 7420  .        # Test 
-00009e20: 6c61 7465 7374 2069 6d61 6765 2077 6974  latest image wit
-00009e30: 6820 7079 7468 6f6e 2033 2e31 3120 696e  h python 3.11 in
-00009e40: 7374 616c 6c65 6420 6279 2064 6566 6175  stalled by defau
-00009e50: 6c74 2e0a 2020 2020 2020 2020 2320 446f  lt..        # Do
-00009e60: 6573 206e 6f74 2077 6f72 6b20 666f 7220  es not work for 
-00009e70: 7079 7468 6f6e 2033 2e31 3220 6475 6520  python 3.12 due 
-00009e80: 746f 2072 6179 2773 2072 6571 7569 7265  to ray's require
-00009e90: 6d65 6e74 2066 6f72 2033 2e31 312e 0a20  ment for 3.11.. 
-00009ea0: 2020 2020 2020 2027 646f 636b 6572 3a63         'docker:c
-00009eb0: 6f6e 7469 6e75 756d 696f 2f6d 696e 6963  ontinuumio/minic
-00009ec0: 6f6e 6461 333a 3234 2e31 2e32 2d30 272c  onda3:24.1.2-0',
-00009ed0: 0a20 2020 205d 290a 6465 6620 7465 7374  .    ]).def test
-00009ee0: 5f64 6f63 6b65 725f 7374 6f72 6167 655f  _docker_storage_
-00009ef0: 6d6f 756e 7473 2867 656e 6572 6963 5f63  mounts(generic_c
-00009f00: 6c6f 7564 3a20 7374 722c 2069 6d61 6765  loud: str, image
-00009f10: 5f69 643a 2073 7472 293a 0a20 2020 2023  _id: str):.    #
-00009f20: 2054 6573 7473 2062 7563 6b65 7420 6d6f   Tests bucket mo
-00009f30: 756e 7469 6e67 206f 6e20 646f 636b 6572  unting on docker
-00009f40: 2063 6f6e 7461 696e 6572 0a20 2020 206e   container.    n
-00009f50: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00009f60: 6572 5f6e 616d 6528 290a 2020 2020 7469  er_name().    ti
-00009f70: 6d65 7374 616d 7020 3d20 7374 7228 7469  mestamp = str(ti
-00009f80: 6d65 2e74 696d 6528 2929 2e72 6570 6c61  me.time()).repla
-00009f90: 6365 2827 2e27 2c20 2727 290a 2020 2020  ce('.', '').    
-00009fa0: 7374 6f72 6167 655f 6e61 6d65 203d 2066  storage_name = f
-00009fb0: 2773 6b79 2d74 6573 742d 7b74 696d 6573  'sky-test-{times
-00009fc0: 7461 6d70 7d27 0a20 2020 2074 656d 706c  tamp}'.    templ
-00009fd0: 6174 655f 7374 7220 3d20 7061 7468 6c69  ate_str = pathli
-00009fe0: 622e 5061 7468 280a 2020 2020 2020 2020  b.Path(.        
-00009ff0: 2774 6573 7473 2f74 6573 745f 7961 6d6c  'tests/test_yaml
-0000a000: 732f 7465 7374 5f73 746f 7261 6765 5f6d  s/test_storage_m
-0000a010: 6f75 6e74 696e 672e 7961 6d6c 2e6a 3227  ounting.yaml.j2'
-0000a020: 292e 7265 6164 5f74 6578 7428 290a 2020  ).read_text().  
-0000a030: 2020 7465 6d70 6c61 7465 203d 206a 696e    template = jin
-0000a040: 6a61 322e 5465 6d70 6c61 7465 2874 656d  ja2.Template(tem
-0000a050: 706c 6174 655f 7374 7229 0a20 2020 2063  plate_str).    c
-0000a060: 6f6e 7465 6e74 203d 2074 656d 706c 6174  ontent = templat
-0000a070: 652e 7265 6e64 6572 2873 746f 7261 6765  e.render(storage
-0000a080: 5f6e 616d 653d 7374 6f72 6167 655f 6e61  _name=storage_na
-0000a090: 6d65 290a 2020 2020 7769 7468 2074 656d  me).    with tem
-0000a0a0: 7066 696c 652e 4e61 6d65 6454 656d 706f  pfile.NamedTempo
-0000a0b0: 7261 7279 4669 6c65 2873 7566 6669 783d  raryFile(suffix=
-0000a0c0: 272e 7961 6d6c 272c 206d 6f64 653d 2777  '.yaml', mode='w
-0000a0d0: 2729 2061 7320 663a 0a20 2020 2020 2020  ') as f:.       
-0000a0e0: 2066 2e77 7269 7465 2863 6f6e 7465 6e74   f.write(content
-0000a0f0: 290a 2020 2020 2020 2020 662e 666c 7573  ).        f.flus
-0000a100: 6828 290a 2020 2020 2020 2020 6669 6c65  h().        file
-0000a110: 5f70 6174 6820 3d20 662e 6e61 6d65 0a20  _path = f.name. 
-0000a120: 2020 2020 2020 2074 6573 745f 636f 6d6d         test_comm
-0000a130: 616e 6473 203d 205b 0a20 2020 2020 2020  ands = [.       
-0000a140: 2020 2020 202a 7374 6f72 6167 655f 7365       *storage_se
-0000a150: 7475 705f 636f 6d6d 616e 6473 2c0a 2020  tup_commands,.  
-0000a160: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000a170: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-0000a180: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-0000a190: 6572 6963 5f63 6c6f 7564 7d20 2d2d 696d  eric_cloud} --im
-0000a1a0: 6167 652d 6964 207b 696d 6167 655f 6964  age-id {image_id
-0000a1b0: 7d20 7b66 696c 655f 7061 7468 7d27 2c0a  } {file_path}',.
-0000a1c0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000a1d0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-0000a1e0: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-0000a1f0: 7375 7265 206a 6f62 2073 7563 6365 6564  sure job succeed
-0000a200: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-0000a210: 6627 6177 7320 7333 206c 7320 7b73 746f  f'aws s3 ls {sto
-0000a220: 7261 6765 5f6e 616d 657d 2f68 656c 6c6f  rage_name}/hello
-0000a230: 2e74 7874 207c 7c20 270a 2020 2020 2020  .txt || '.      
-0000a240: 2020 2020 2020 6627 6773 7574 696c 206c        f'gsutil l
-0000a250: 7320 6773 3a2f 2f7b 7374 6f72 6167 655f  s gs://{storage_
-0000a260: 6e61 6d65 7d2f 6865 6c6c 6f2e 7478 7427  name}/hello.txt'
-0000a270: 2c0a 2020 2020 2020 2020 5d0a 2020 2020  ,.        ].    
-0000a280: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-0000a290: 0a20 2020 2020 2020 2020 2020 2027 646f  .            'do
-0000a2a0: 636b 6572 5f73 746f 7261 6765 5f6d 6f75  cker_storage_mou
-0000a2b0: 6e74 7327 2c0a 2020 2020 2020 2020 2020  nts',.          
-0000a2c0: 2020 7465 7374 5f63 6f6d 6d61 6e64 732c    test_commands,
-0000a2d0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000a2e0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-0000a2f0: 7d3b 2073 6b79 2073 746f 7261 6765 2064  }; sky storage d
-0000a300: 656c 6574 6520 2d79 207b 7374 6f72 6167  elete -y {storag
-0000a310: 655f 6e61 6d65 7d27 2c0a 2020 2020 2020  e_name}',.      
-0000a320: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
-0000a330: 202a 2036 302c 2020 2320 3230 206d 696e   * 60,  # 20 min
-0000a340: 730a 2020 2020 2020 2020 290a 2020 2020  s.        ).    
-0000a350: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-0000a360: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-0000a370: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
-0000a380: 0a64 6566 2074 6573 745f 636c 6f75 6466  .def test_cloudf
-0000a390: 6c61 7265 5f73 746f 7261 6765 5f6d 6f75  lare_storage_mou
-0000a3a0: 6e74 7328 6765 6e65 7269 635f 636c 6f75  nts(generic_clou
-0000a3b0: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
-0000a3c0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-0000a3d0: 5f6e 616d 6528 290a 2020 2020 7374 6f72  _name().    stor
-0000a3e0: 6167 655f 6e61 6d65 203d 2066 2773 6b79  age_name = f'sky
-0000a3f0: 2d74 6573 742d 7b69 6e74 2874 696d 652e  -test-{int(time.
-0000a400: 7469 6d65 2829 297d 270a 2020 2020 7465  time())}'.    te
-0000a410: 6d70 6c61 7465 5f73 7472 203d 2070 6174  mplate_str = pat
-0000a420: 686c 6962 2e50 6174 6828 0a20 2020 2020  hlib.Path(.     
-0000a430: 2020 2027 7465 7374 732f 7465 7374 5f79     'tests/test_y
-0000a440: 616d 6c73 2f74 6573 745f 7232 5f73 746f  amls/test_r2_sto
-0000a450: 7261 6765 5f6d 6f75 6e74 696e 672e 7961  rage_mounting.ya
-0000a460: 6d6c 2729 2e72 6561 645f 7465 7874 2829  ml').read_text()
-0000a470: 0a20 2020 2074 656d 706c 6174 6520 3d20  .    template = 
-0000a480: 6a69 6e6a 6132 2e54 656d 706c 6174 6528  jinja2.Template(
-0000a490: 7465 6d70 6c61 7465 5f73 7472 290a 2020  template_str).  
-0000a4a0: 2020 636f 6e74 656e 7420 3d20 7465 6d70    content = temp
-0000a4b0: 6c61 7465 2e72 656e 6465 7228 7374 6f72  late.render(stor
-0000a4c0: 6167 655f 6e61 6d65 3d73 746f 7261 6765  age_name=storage
-0000a4d0: 5f6e 616d 6529 0a20 2020 2065 6e64 706f  _name).    endpo
-0000a4e0: 696e 745f 7572 6c20 3d20 636c 6f75 6466  int_url = cloudf
-0000a4f0: 6c61 7265 2e63 7265 6174 655f 656e 6470  lare.create_endp
-0000a500: 6f69 6e74 2829 0a20 2020 2077 6974 6820  oint().    with 
-0000a510: 7465 6d70 6669 6c65 2e4e 616d 6564 5465  tempfile.NamedTe
-0000a520: 6d70 6f72 6172 7946 696c 6528 7375 6666  mporaryFile(suff
-0000a530: 6978 3d27 2e79 616d 6c27 2c20 6d6f 6465  ix='.yaml', mode
-0000a540: 3d27 7727 2920 6173 2066 3a0a 2020 2020  ='w') as f:.    
-0000a550: 2020 2020 662e 7772 6974 6528 636f 6e74      f.write(cont
-0000a560: 656e 7429 0a20 2020 2020 2020 2066 2e66  ent).        f.f
-0000a570: 6c75 7368 2829 0a20 2020 2020 2020 2066  lush().        f
-0000a580: 696c 655f 7061 7468 203d 2066 2e6e 616d  ile_path = f.nam
-0000a590: 650a 2020 2020 2020 2020 7465 7374 5f63  e.        test_c
-0000a5a0: 6f6d 6d61 6e64 7320 3d20 5b0a 2020 2020  ommands = [.    
-0000a5b0: 2020 2020 2020 2020 2a73 746f 7261 6765          *storage
-0000a5c0: 5f73 6574 7570 5f63 6f6d 6d61 6e64 732c  _setup_commands,
-0000a5d0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000a5e0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-0000a5f0: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
-0000a600: 6765 6e65 7269 635f 636c 6f75 647d 207b  generic_cloud} {
-0000a610: 6669 6c65 5f70 6174 687d 272c 0a20 2020  file_path}',.   
-0000a620: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000a630: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-0000a640: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-0000a650: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-0000a660: 0a20 2020 2020 2020 2020 2020 2066 2741  .            f'A
-0000a670: 5753 5f53 4841 5245 445f 4352 4544 454e  WS_SHARED_CREDEN
-0000a680: 5449 414c 535f 4649 4c45 3d7b 636c 6f75  TIALS_FILE={clou
-0000a690: 6466 6c61 7265 2e52 325f 4352 4544 454e  dflare.R2_CREDEN
-0000a6a0: 5449 414c 535f 5041 5448 7d20 6177 7320  TIALS_PATH} aws 
-0000a6b0: 7333 206c 7320 7333 3a2f 2f7b 7374 6f72  s3 ls s3://{stor
-0000a6c0: 6167 655f 6e61 6d65 7d2f 6865 6c6c 6f2e  age_name}/hello.
-0000a6d0: 7478 7420 2d2d 656e 6470 6f69 6e74 207b  txt --endpoint {
-0000a6e0: 656e 6470 6f69 6e74 5f75 726c 7d20 2d2d  endpoint_url} --
-0000a6f0: 7072 6f66 696c 653d 7232 270a 2020 2020  profile=r2'.    
-0000a700: 2020 2020 5d0a 0a20 2020 2020 2020 2074      ]..        t
-0000a710: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-0000a720: 2020 2020 2020 2020 2763 6c6f 7564 666c          'cloudfl
-0000a730: 6172 655f 7374 6f72 6167 655f 6d6f 756e  are_storage_moun
-0000a740: 7473 272c 0a20 2020 2020 2020 2020 2020  ts',.           
-0000a750: 2074 6573 745f 636f 6d6d 616e 6473 2c0a   test_commands,.
-0000a760: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000a770: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-0000a780: 3b20 736b 7920 7374 6f72 6167 6520 6465  ; sky storage de
-0000a790: 6c65 7465 202d 7920 7b73 746f 7261 6765  lete -y {storage
-0000a7a0: 5f6e 616d 657d 272c 0a20 2020 2020 2020  _name}',.       
-0000a7b0: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
-0000a7c0: 2a20 3630 2c20 2023 2032 3020 6d69 6e73  * 60,  # 20 mins
-0000a7d0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0000a7e0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-0000a7f0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-0000a800: 6d61 726b 2e69 626d 0a64 6566 2074 6573  mark.ibm.def tes
-0000a810: 745f 6962 6d5f 7374 6f72 6167 655f 6d6f  t_ibm_storage_mo
-0000a820: 756e 7473 2829 3a0a 2020 2020 6e61 6d65  unts():.    name
-0000a830: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-0000a840: 6e61 6d65 2829 0a20 2020 2073 746f 7261  name().    stora
-0000a850: 6765 5f6e 616d 6520 3d20 6627 736b 792d  ge_name = f'sky-
-0000a860: 7465 7374 2d7b 696e 7428 7469 6d65 2e74  test-{int(time.t
-0000a870: 696d 6528 2929 7d27 0a20 2020 2062 7563  ime())}'.    buc
-0000a880: 6b65 745f 7263 6c6f 6e65 5f70 726f 6669  ket_rclone_profi
-0000a890: 6c65 203d 2052 636c 6f6e 652e 6765 6e65  le = Rclone.gene
-0000a8a0: 7261 7465 5f72 636c 6f6e 655f 6275 636b  rate_rclone_buck
-0000a8b0: 6574 5f70 726f 6669 6c65 5f6e 616d 6528  et_profile_name(
-0000a8c0: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
-0000a8d0: 5f6e 616d 652c 2052 636c 6f6e 652e 5263  _name, Rclone.Rc
-0000a8e0: 6c6f 6e65 436c 6f75 6473 2e49 424d 290a  loneClouds.IBM).
-0000a8f0: 2020 2020 7465 6d70 6c61 7465 5f73 7472      template_str
-0000a900: 203d 2070 6174 686c 6962 2e50 6174 6828   = pathlib.Path(
-0000a910: 0a20 2020 2020 2020 2027 7465 7374 732f  .        'tests/
-0000a920: 7465 7374 5f79 616d 6c73 2f74 6573 745f  test_yamls/test_
-0000a930: 6962 6d5f 636f 735f 7374 6f72 6167 655f  ibm_cos_storage_
-0000a940: 6d6f 756e 7469 6e67 2e79 616d 6c27 292e  mounting.yaml').
-0000a950: 7265 6164 5f74 6578 7428 290a 2020 2020  read_text().    
-0000a960: 7465 6d70 6c61 7465 203d 206a 696e 6a61  template = jinja
-0000a970: 322e 5465 6d70 6c61 7465 2874 656d 706c  2.Template(templ
-0000a980: 6174 655f 7374 7229 0a20 2020 2063 6f6e  ate_str).    con
-0000a990: 7465 6e74 203d 2074 656d 706c 6174 652e  tent = template.
-0000a9a0: 7265 6e64 6572 2873 746f 7261 6765 5f6e  render(storage_n
-0000a9b0: 616d 653d 7374 6f72 6167 655f 6e61 6d65  ame=storage_name
-0000a9c0: 290a 2020 2020 7769 7468 2074 656d 7066  ).    with tempf
-0000a9d0: 696c 652e 4e61 6d65 6454 656d 706f 7261  ile.NamedTempora
-0000a9e0: 7279 4669 6c65 2873 7566 6669 783d 272e  ryFile(suffix='.
-0000a9f0: 7961 6d6c 272c 206d 6f64 653d 2777 2729  yaml', mode='w')
-0000aa00: 2061 7320 663a 0a20 2020 2020 2020 2066   as f:.        f
-0000aa10: 2e77 7269 7465 2863 6f6e 7465 6e74 290a  .write(content).
-0000aa20: 2020 2020 2020 2020 662e 666c 7573 6828          f.flush(
-0000aa30: 290a 2020 2020 2020 2020 6669 6c65 5f70  ).        file_p
-0000aa40: 6174 6820 3d20 662e 6e61 6d65 0a20 2020  ath = f.name.   
-0000aa50: 2020 2020 2074 6573 745f 636f 6d6d 616e       test_comman
-0000aa60: 6473 203d 205b 0a20 2020 2020 2020 2020  ds = [.         
-0000aa70: 2020 202a 7374 6f72 6167 655f 7365 7475     *storage_setu
-0000aa80: 705f 636f 6d6d 616e 6473 2c0a 2020 2020  p_commands,.    
-0000aa90: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-0000aaa0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-0000aab0: 7d20 2d2d 636c 6f75 6420 6962 6d20 7b66  } --cloud ibm {f
-0000aac0: 696c 655f 7061 7468 7d27 2c0a 2020 2020  ile_path}',.    
-0000aad0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-0000aae0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
-0000aaf0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
-0000ab00: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
-0000ab10: 2020 2020 2020 2020 2020 2020 6627 7263              f'rc
-0000ab20: 6c6f 6e65 206c 7320 7b62 7563 6b65 745f  lone ls {bucket_
-0000ab30: 7263 6c6f 6e65 5f70 726f 6669 6c65 7d3a  rclone_profile}:
-0000ab40: 7b73 746f 7261 6765 5f6e 616d 657d 2f68  {storage_name}/h
-0000ab50: 656c 6c6f 2e74 7874 272c 0a20 2020 2020  ello.txt',.     
-0000ab60: 2020 205d 0a20 2020 2020 2020 2074 6573     ].        tes
-0000ab70: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-0000ab80: 2020 2020 2020 2769 626d 5f73 746f 7261        'ibm_stora
-0000ab90: 6765 5f6d 6f75 6e74 7327 2c0a 2020 2020  ge_mounts',.    
-0000aba0: 2020 2020 2020 2020 7465 7374 5f63 6f6d          test_com
-0000abb0: 6d61 6e64 732c 0a20 2020 2020 2020 2020  mands,.         
-0000abc0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-0000abd0: 207b 6e61 6d65 7d3b 2073 6b79 2073 746f   {name}; sky sto
-0000abe0: 7261 6765 2064 656c 6574 6520 2d79 207b  rage delete -y {
-0000abf0: 7374 6f72 6167 655f 6e61 6d65 7d27 2c0a  storage_name}',.
-0000ac00: 2020 2020 2020 2020 2020 2020 7469 6d65              time
-0000ac10: 6f75 743d 3230 202a 2036 302c 2020 2320  out=20 * 60,  # 
-0000ac20: 3230 206d 696e 730a 2020 2020 2020 2020  20 mins.        
-0000ac30: 290a 2020 2020 2020 2020 7275 6e5f 6f6e  ).        run_on
-0000ac40: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
-0000ac50: 202d 2d2d 2d2d 2d2d 2d2d 2d20 434c 4920   ---------- CLI 
-0000ac60: 6c6f 6773 202d 2d2d 2d2d 2d2d 2d2d 2d0a  logs ----------.
-0000ac70: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-0000ac80: 7363 7020 2023 2053 4350 2064 6f65 7320  scp  # SCP does 
-0000ac90: 6e6f 7420 7375 7070 6f72 7420 6e75 6d5f  not support num_
-0000aca0: 6e6f 6465 7320 3e20 3120 7965 742e 2052  nodes > 1 yet. R
-0000acb0: 756e 2074 6573 745f 7363 705f 6c6f 6773  un test_scp_logs
-0000acc0: 2069 6e73 7465 6164 2e0a 6465 6620 7465   instead..def te
-0000acd0: 7374 5f63 6c69 5f6c 6f67 7328 6765 6e65  st_cli_logs(gene
-0000ace0: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
-0000acf0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0000ad00: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0000ad10: 2020 2020 6e75 6d5f 6e6f 6465 7320 3d20      num_nodes = 
-0000ad20: 320a 2020 2020 6966 2067 656e 6572 6963  2.    if generic
-0000ad30: 5f63 6c6f 7564 203d 3d20 276b 7562 6572  _cloud == 'kuber
-0000ad40: 6e65 7465 7327 3a0a 2020 2020 2020 2020  netes':.        
-0000ad50: 2320 4b75 6265 726e 6574 6573 2064 6f65  # Kubernetes doe
-0000ad60: 7320 6e6f 7420 7375 7070 6f72 7420 6d75  s not support mu
-0000ad70: 6c74 692d 6e6f 6465 0a20 2020 2020 2020  lti-node.       
-0000ad80: 206e 756d 5f6e 6f64 6573 203d 2031 0a20   num_nodes = 1. 
-0000ad90: 2020 2074 696d 6573 7461 6d70 203d 2074     timestamp = t
-0000ada0: 696d 652e 7469 6d65 2829 0a20 2020 2074  ime.time().    t
-0000adb0: 6573 7420 3d20 5465 7374 2827 636c 695f  est = Test('cli_
-0000adc0: 6c6f 6773 272c 205b 0a20 2020 2020 2020  logs', [.       
-0000add0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-0000ade0: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
-0000adf0: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
-0000ae00: 647d 202d 2d6e 756d 2d6e 6f64 6573 207b  d} --num-nodes {
-0000ae10: 6e75 6d5f 6e6f 6465 737d 2022 6563 686f  num_nodes} "echo
-0000ae20: 207b 7469 6d65 7374 616d 707d 2031 2227   {timestamp} 1"'
-0000ae30: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-0000ae40: 6578 6563 207b 6e61 6d65 7d20 2265 6368  exec {name} "ech
-0000ae50: 6f20 7b74 696d 6573 7461 6d70 7d20 3222  o {timestamp} 2"
-0000ae60: 272c 0a20 2020 2020 2020 2066 2773 6b79  ',.        f'sky
-0000ae70: 2065 7865 6320 7b6e 616d 657d 2022 6563   exec {name} "ec
-0000ae80: 686f 207b 7469 6d65 7374 616d 707d 2033  ho {timestamp} 3
-0000ae90: 2227 2c0a 2020 2020 2020 2020 6627 736b  "',.        f'sk
-0000aea0: 7920 6578 6563 207b 6e61 6d65 7d20 2265  y exec {name} "e
-0000aeb0: 6368 6f20 7b74 696d 6573 7461 6d70 7d20  cho {timestamp} 
-0000aec0: 3422 272c 0a20 2020 2020 2020 2066 2773  4"',.        f's
-0000aed0: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
-0000aee0: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-0000aef0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-0000af00: 6e61 6d65 7d20 3320 3420 2d2d 7379 6e63  name} 3 4 --sync
-0000af10: 2d64 6f77 6e27 2c0a 2020 2020 2020 2020  -down',.        
-0000af20: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-0000af30: 7d20 2a20 2d2d 7379 6e63 2d64 6f77 6e27  } * --sync-down'
-0000af40: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-0000af50: 6c6f 6773 207b 6e61 6d65 7d20 3120 7c20  logs {name} 1 | 
-0000af60: 6772 6570 2022 7b74 696d 6573 7461 6d70  grep "{timestamp
-0000af70: 7d20 3122 272c 0a20 2020 2020 2020 2066  } 1"',.        f
-0000af80: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0000af90: 207c 2067 7265 7020 227b 7469 6d65 7374   | grep "{timest
-0000afa0: 616d 707d 2034 2227 2c0a 2020 2020 5d2c  amp} 4"',.    ],
-0000afb0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-0000afc0: 6e61 6d65 7d27 290a 2020 2020 7275 6e5f  name}').    run_
-0000afd0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-0000afe0: 0a40 7079 7465 7374 2e6d 6172 6b2e 7363  .@pytest.mark.sc
-0000aff0: 700a 6465 6620 7465 7374 5f73 6370 5f6c  p.def test_scp_l
-0000b000: 6f67 7328 293a 0a20 2020 206e 616d 6520  ogs():.    name 
-0000b010: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0000b020: 616d 6528 290a 2020 2020 7469 6d65 7374  ame().    timest
-0000b030: 616d 7020 3d20 7469 6d65 2e74 696d 6528  amp = time.time(
-0000b040: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-0000b050: 7428 0a20 2020 2020 2020 2027 5343 505f  t(.        'SCP_
-0000b060: 636c 695f 6c6f 6773 272c 0a20 2020 2020  cli_logs',.     
-0000b070: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-0000b080: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-0000b090: 202d 6320 7b6e 616d 657d 207b 5343 505f   -c {name} {SCP_
-0000b0a0: 5459 5045 7d20 2265 6368 6f20 7b74 696d  TYPE} "echo {tim
-0000b0b0: 6573 7461 6d70 7d20 3122 272c 0a20 2020  estamp} 1"',.   
-0000b0c0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-0000b0d0: 7865 6320 7b6e 616d 657d 2022 6563 686f  xec {name} "echo
-0000b0e0: 207b 7469 6d65 7374 616d 707d 2032 2227   {timestamp} 2"'
-0000b0f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000b100: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-0000b110: 2265 6368 6f20 7b74 696d 6573 7461 6d70  "echo {timestamp
-0000b120: 7d20 3322 272c 0a20 2020 2020 2020 2020  } 3"',.         
-0000b130: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-0000b140: 616d 657d 2022 6563 686f 207b 7469 6d65  ame} "echo {time
-0000b150: 7374 616d 707d 2034 2227 2c0a 2020 2020  stamp} 4"',.    
-0000b160: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-0000b170: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
-0000b180: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
-0000b190: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-0000b1a0: 616d 657d 2033 2034 202d 2d73 796e 632d  ame} 3 4 --sync-
-0000b1b0: 646f 776e 272c 0a20 2020 2020 2020 2020  down',.         
-0000b1c0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-0000b1d0: 616d 657d 202a 202d 2d73 796e 632d 646f  ame} * --sync-do
-0000b1e0: 776e 272c 0a20 2020 2020 2020 2020 2020  wn',.           
-0000b1f0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-0000b200: 657d 2031 207c 2067 7265 7020 227b 7469  e} 1 | grep "{ti
-0000b210: 6d65 7374 616d 707d 2031 2227 2c0a 2020  mestamp} 1"',.  
-0000b220: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000b230: 6c6f 6773 207b 6e61 6d65 7d20 7c20 6772  logs {name} | gr
-0000b240: 6570 2022 7b74 696d 6573 7461 6d70 7d20  ep "{timestamp} 
-0000b250: 3422 272c 0a20 2020 2020 2020 205d 2c0a  4"',.        ],.
-0000b260: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-0000b270: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-0000b280: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-0000b290: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-0000b2a0: 2d2d 2d2d 2d2d 2d2d 2d2d 204a 6f62 2051  ---------- Job Q
-0000b2b0: 7565 7565 2e20 2d2d 2d2d 2d2d 2d2d 2d2d  ueue. ----------
-0000b2c0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-0000b2d0: 5f66 6c75 6964 7374 6163 6b20 2023 2046  _fluidstack  # F
-0000b2e0: 6c75 6964 5374 6163 6b20 4443 2068 6173  luidStack DC has
-0000b2f0: 206c 6f77 2061 7661 696c 6162 696c 6974   low availabilit
-0000b300: 7920 6f66 2054 3420 4750 5573 0a40 7079  y of T4 GPUs.@py
-0000b310: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
-0000b320: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
-0000b330: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
-0000b340: 6f74 2068 6176 6520 5434 2067 7075 730a  ot have T4 gpus.
-0000b350: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-0000b360: 6962 6d20 2023 2049 424d 2043 6c6f 7564  ibm  # IBM Cloud
-0000b370: 2064 6f65 7320 6e6f 7420 6861 7665 2054   does not have T
-0000b380: 3420 6770 7573 2e20 7275 6e20 7465 7374  4 gpus. run test
-0000b390: 5f69 626d 5f6a 6f62 5f71 7565 7565 2069  _ibm_job_queue i
-0000b3a0: 6e73 7465 6164 0a40 7079 7465 7374 2e6d  nstead.@pytest.m
-0000b3b0: 6172 6b2e 6e6f 5f73 6370 2020 2320 5343  ark.no_scp  # SC
-0000b3c0: 5020 646f 6573 206e 6f74 2068 6176 6520  P does not have 
-0000b3d0: 5434 2067 7075 732e 2052 756e 2074 6573  T4 gpus. Run tes
-0000b3e0: 745f 7363 705f 6a6f 625f 7175 6575 6520  t_scp_job_queue 
-0000b3f0: 696e 7374 6561 640a 4070 7974 6573 742e  instead.@pytest.
-0000b400: 6d61 726b 2e6e 6f5f 7061 7065 7273 7061  mark.no_paperspa
-0000b410: 6365 2020 2320 5061 7065 7273 7061 6365  ce  # Paperspace
-0000b420: 2064 6f65 7320 6e6f 7420 6861 7665 2054   does not have T
-0000b430: 3420 6770 7573 2e0a 4070 7974 6573 742e  4 gpus..@pytest.
-0000b440: 6d61 726b 2e6e 6f5f 6f63 6920 2023 204f  mark.no_oci  # O
-0000b450: 4349 2064 6f65 7320 6e6f 7420 6861 7665  CI does not have
-0000b460: 2054 3420 6770 7573 0a64 6566 2074 6573   T4 gpus.def tes
-0000b470: 745f 6a6f 625f 7175 6575 6528 6765 6e65  t_job_queue(gene
-0000b480: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
-0000b490: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0000b4a0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0000b4b0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-0000b4c0: 0a20 2020 2020 2020 2027 6a6f 625f 7175  .        'job_qu
-0000b4d0: 6575 6527 2c0a 2020 2020 2020 2020 5b0a  eue',.        [.
-0000b4e0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000b4f0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-0000b500: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
-0000b510: 656e 6572 6963 5f63 6c6f 7564 7d20 6578  eneric_cloud} ex
-0000b520: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
-0000b530: 2f63 6c75 7374 6572 2e79 616d 6c27 2c0a  /cluster.yaml',.
-0000b540: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000b550: 7920 6578 6563 207b 6e61 6d65 7d20 2d6e  y exec {name} -n
-0000b560: 207b 6e61 6d65 7d2d 3120 2d64 2065 7861   {name}-1 -d exa
-0000b570: 6d70 6c65 732f 6a6f 625f 7175 6575 652f  mples/job_queue/
-0000b580: 6a6f 622e 7961 6d6c 272c 0a20 2020 2020  job.yaml',.     
-0000b590: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-0000b5a0: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
-0000b5b0: 657d 2d32 202d 6420 6578 616d 706c 6573  e}-2 -d examples
-0000b5c0: 2f6a 6f62 5f71 7565 7565 2f6a 6f62 2e79  /job_queue/job.y
-0000b5d0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-0000b5e0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000b5f0: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3320  me} -n {name}-3 
-0000b600: 2d64 2065 7861 6d70 6c65 732f 6a6f 625f  -d examples/job_
-0000b610: 7175 6575 652f 6a6f 622e 7961 6d6c 272c  queue/job.yaml',
-0000b620: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000b630: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
-0000b640: 6d65 7d29 3b20 6563 686f 2022 2473 223b  me}); echo "$s";
-0000b650: 2065 6368 6f3b 2065 6368 6f3b 2065 6368   echo; echo; ech
-0000b660: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
-0000b670: 616d 657d 2d31 207c 2067 7265 7020 5255  ame}-1 | grep RU
-0000b680: 4e4e 494e 4727 2c0a 2020 2020 2020 2020  NNING',.        
-0000b690: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
-0000b6a0: 6575 6520 7b6e 616d 657d 293b 2065 6368  eue {name}); ech
-0000b6b0: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
-0000b6c0: 686f 3b20 6563 686f 2022 2473 2220 7c20  ho; echo "$s" | 
-0000b6d0: 6772 6570 207b 6e61 6d65 7d2d 3220 7c20  grep {name}-2 | 
-0000b6e0: 6772 6570 2052 554e 4e49 4e47 272c 0a20  grep RUNNING',. 
-0000b6f0: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-0000b700: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
-0000b710: 7d29 3b20 6563 686f 2022 2473 223b 2065  }); echo "$s"; e
-0000b720: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
-0000b730: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
-0000b740: 657d 2d33 207c 2067 7265 7020 5045 4e44  e}-3 | grep PEND
-0000b750: 494e 4727 2c0a 2020 2020 2020 2020 2020  ING',.          
-0000b760: 2020 6627 736b 7920 6361 6e63 656c 202d    f'sky cancel -
-0000b770: 7920 7b6e 616d 657d 2032 272c 0a20 2020  y {name} 2',.   
-0000b780: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-0000b790: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
-0000b7a0: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
-0000b7b0: 7b6e 616d 657d 293b 2065 6368 6f20 2224  {name}); echo "$
-0000b7c0: 7322 3b20 6563 686f 3b20 6563 686f 3b20  s"; echo; echo; 
-0000b7d0: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-0000b7e0: 207b 6e61 6d65 7d2d 3320 7c20 6772 6570   {name}-3 | grep
-0000b7f0: 2052 554e 4e49 4e47 272c 0a20 2020 2020   RUNNING',.     
-0000b800: 2020 2020 2020 2066 2773 6b79 2063 616e         f'sky can
-0000b810: 6365 6c20 2d79 207b 6e61 6d65 7d20 3327  cel -y {name} 3'
-0000b820: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000b830: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-0000b840: 2d2d 6770 7573 2054 343a 302e 3220 225b  --gpus T4:0.2 "[
-0000b850: 5b20 5c24 534b 5950 494c 4f54 5f4e 554d  [ \$SKYPILOT_NUM
-0000b860: 5f47 5055 535f 5045 525f 4e4f 4445 202d  _GPUS_PER_NODE -
-0000b870: 6571 2031 205d 5d20 7c7c 2065 7869 7420  eq 1 ]] || exit 
-0000b880: 3122 272c 0a20 2020 2020 2020 2020 2020  1"',.           
-0000b890: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-0000b8a0: 657d 202d 2d67 7075 7320 5434 3a31 2022  e} --gpus T4:1 "
-0000b8b0: 5b5b 205c 2453 4b59 5049 4c4f 545f 4e55  [[ \$SKYPILOT_NU
-0000b8c0: 4d5f 4750 5553 5f50 4552 5f4e 4f44 4520  M_GPUS_PER_NODE 
-0000b8d0: 2d65 7120 3120 5d5d 207c 7c20 6578 6974  -eq 1 ]] || exit
-0000b8e0: 2031 2227 2c0a 2020 2020 2020 2020 2020   1"',.          
-0000b8f0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-0000b900: 6d65 7d20 3420 2d2d 7374 6174 7573 272c  me} 4 --status',
-0000b910: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000b920: 6b79 206c 6f67 7320 7b6e 616d 657d 2035  ky logs {name} 5
-0000b930: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-0000b940: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-0000b950: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-0000b960: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-0000b970: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0000b980: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
-0000b990: 2d20 4a6f 6220 5175 6575 6520 7769 7468  - Job Queue with
-0000b9a0: 2044 6f63 6b65 722e 202d 2d2d 2d2d 2d2d   Docker. -------
-0000b9b0: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
-0000b9c0: 2e6e 6f5f 666c 7569 6473 7461 636b 2020  .no_fluidstack  
-0000b9d0: 2320 466c 7569 6453 7461 636b 2064 6f65  # FluidStack doe
-0000b9e0: 7320 6e6f 7420 7375 7070 6f72 7420 646f  s not support do
-0000b9f0: 636b 6572 2066 6f72 206e 6f77 0a40 7079  cker for now.@py
-0000ba00: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
-0000ba10: 6264 615f 636c 6f75 6420 2023 2044 6f65  bda_cloud  # Doe
-0000ba20: 736e 2774 2073 7570 706f 7274 204c 616d  sn't support Lam
-0000ba30: 6264 6120 436c 6f75 6420 666f 7220 6e6f  bda Cloud for no
-0000ba40: 770a 4070 7974 6573 742e 6d61 726b 2e6e  w.@pytest.mark.n
-0000ba50: 6f5f 6962 6d20 2023 2044 6f65 736e 2774  o_ibm  # Doesn't
-0000ba60: 2073 7570 706f 7274 2049 424d 2043 6c6f   support IBM Clo
-0000ba70: 7564 2066 6f72 206e 6f77 0a40 7079 7465  ud for now.@pyte
-0000ba80: 7374 2e6d 6172 6b2e 6e6f 5f70 6170 6572  st.mark.no_paper
-0000ba90: 7370 6163 6520 2023 2050 6170 6572 7370  space  # Papersp
-0000baa0: 6163 6520 646f 6573 6e27 7420 6861 7665  ace doesn't have
-0000bab0: 2054 3420 4750 5573 0a40 7079 7465 7374   T4 GPUs.@pytest
-0000bac0: 2e6d 6172 6b2e 6e6f 5f73 6370 2020 2320  .mark.no_scp  # 
-0000bad0: 446f 6573 6e27 7420 7375 7070 6f72 7420  Doesn't support 
-0000bae0: 5343 5020 666f 7220 6e6f 770a 4070 7974  SCP for now.@pyt
-0000baf0: 6573 742e 6d61 726b 2e6e 6f5f 6f63 6920  est.mark.no_oci 
-0000bb00: 2023 2044 6f65 736e 2774 2073 7570 706f   # Doesn't suppo
-0000bb10: 7274 204f 4349 2066 6f72 206e 6f77 0a40  rt OCI for now.@
-0000bb20: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6b  pytest.mark.no_k
-0000bb30: 7562 6572 6e65 7465 7320 2023 2044 6f65  ubernetes  # Doe
-0000bb40: 736e 2774 2073 7570 706f 7274 204b 7562  sn't support Kub
-0000bb50: 6572 6e65 7465 7320 666f 7220 6e6f 770a  ernetes for now.
-0000bb60: 4070 7974 6573 742e 6d61 726b 2e70 6172  @pytest.mark.par
-0000bb70: 616d 6574 7269 7a65 280a 2020 2020 2769  ametrize(.    'i
-0000bb80: 6d61 6765 5f69 6427 2c0a 2020 2020 5b0a  mage_id',.    [.
-0000bb90: 2020 2020 2020 2020 2764 6f63 6b65 723a          'docker:
-0000bba0: 6e76 6964 6961 2f63 7564 613a 3131 2e38  nvidia/cuda:11.8
-0000bbb0: 2e30 2d64 6576 656c 2d75 6275 6e74 7531  .0-devel-ubuntu1
-0000bbc0: 382e 3034 272c 0a20 2020 2020 2020 2027  8.04',.        '
-0000bbd0: 646f 636b 6572 3a75 6275 6e74 753a 3138  docker:ubuntu:18
-0000bbe0: 2e30 3427 2c0a 2020 2020 2020 2020 2320  .04',.        # 
-0000bbf0: 5465 7374 206c 6174 6573 7420 696d 6167  Test latest imag
-0000bc00: 6520 7769 7468 2070 7974 686f 6e20 332e  e with python 3.
-0000bc10: 3131 2069 6e73 7461 6c6c 6564 2062 7920  11 installed by 
-0000bc20: 6465 6661 756c 742e 0a20 2020 2020 2020  default..       
-0000bc30: 2023 2044 6f65 7320 6e6f 7420 776f 726b   # Does not work
-0000bc40: 2066 6f72 2070 7974 686f 6e20 332e 3132   for python 3.12
-0000bc50: 2064 7565 2074 6f20 7261 7927 7320 7265   due to ray's re
-0000bc60: 7175 6972 656d 656e 7420 666f 7220 332e  quirement for 3.
-0000bc70: 3131 2e0a 2020 2020 2020 2020 2764 6f63  11..        'doc
-0000bc80: 6b65 723a 636f 6e74 696e 7575 6d69 6f2f  ker:continuumio/
-0000bc90: 6d69 6e69 636f 6e64 6133 3a32 342e 312e  miniconda3:24.1.
-0000bca0: 322d 3027 2c0a 2020 2020 5d29 0a64 6566  2-0',.    ]).def
-0000bcb0: 2074 6573 745f 6a6f 625f 7175 6575 655f   test_job_queue_
-0000bcc0: 7769 7468 5f64 6f63 6b65 7228 6765 6e65  with_docker(gene
-0000bcd0: 7269 635f 636c 6f75 643a 2073 7472 2c20  ric_cloud: str, 
-0000bce0: 696d 6167 655f 6964 3a20 7374 7229 3a0a  image_id: str):.
-0000bcf0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-0000bd00: 636c 7573 7465 725f 6e61 6d65 2829 202b  cluster_name() +
-0000bd10: 2069 6d61 6765 5f69 645b 6c65 6e28 2764   image_id[len('d
-0000bd20: 6f63 6b65 723a 2729 3a5d 5b3a 345d 0a20  ocker:'):][:4]. 
-0000bd30: 2020 2074 6f74 616c 5f74 696d 656f 7574     total_timeout
-0000bd40: 5f6d 696e 7574 6573 203d 2034 3020 6966  _minutes = 40 if
-0000bd50: 2067 656e 6572 6963 5f63 6c6f 7564 203d   generic_cloud =
-0000bd60: 3d20 2761 7a75 7265 2720 656c 7365 2031  = 'azure' else 1
-0000bd70: 350a 2020 2020 7469 6d65 5f74 6f5f 736c  5.    time_to_sl
-0000bd80: 6565 7020 3d20 3330 3020 6966 2067 656e  eep = 300 if gen
-0000bd90: 6572 6963 5f63 6c6f 7564 203d 3d20 2761  eric_cloud == 'a
-0000bda0: 7a75 7265 2720 656c 7365 2031 3830 0a20  zure' else 180. 
-0000bdb0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-0000bdc0: 2020 2020 2020 2020 276a 6f62 5f71 7565          'job_que
-0000bdd0: 7565 5f77 6974 685f 646f 636b 6572 272c  ue_with_docker',
-0000bde0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-0000bdf0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-0000be00: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-0000be10: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-0000be20: 635f 636c 6f75 647d 202d 2d69 6d61 6765  c_cloud} --image
-0000be30: 2d69 6420 7b69 6d61 6765 5f69 647d 2065  -id {image_id} e
-0000be40: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
-0000be50: 652f 636c 7573 7465 725f 646f 636b 6572  e/cluster_docker
-0000be60: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-0000be70: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-0000be80: 6e61 6d65 7d20 2d6e 207b 6e61 6d65 7d2d  name} -n {name}-
-0000be90: 3120 2d64 202d 2d69 6d61 6765 2d69 6420  1 -d --image-id 
-0000bea0: 7b69 6d61 6765 5f69 647d 202d 2d65 6e76  {image_id} --env
-0000beb0: 2054 494d 455f 544f 5f53 4c45 4550 3d7b   TIME_TO_SLEEP={
-0000bec0: 7469 6d65 5f74 6f5f 736c 6565 707d 2065  time_to_sleep} e
-0000bed0: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
-0000bee0: 652f 6a6f 625f 646f 636b 6572 2e79 616d  e/job_docker.yam
-0000bef0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-0000bf00: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-0000bf10: 7d20 2d6e 207b 6e61 6d65 7d2d 3220 2d64  } -n {name}-2 -d
-0000bf20: 202d 2d69 6d61 6765 2d69 6420 7b69 6d61   --image-id {ima
-0000bf30: 6765 5f69 647d 202d 2d65 6e76 2054 494d  ge_id} --env TIM
-0000bf40: 455f 544f 5f53 4c45 4550 3d7b 7469 6d65  E_TO_SLEEP={time
-0000bf50: 5f74 6f5f 736c 6565 707d 2065 7861 6d70  _to_sleep} examp
-0000bf60: 6c65 732f 6a6f 625f 7175 6575 652f 6a6f  les/job_queue/jo
-0000bf70: 625f 646f 636b 6572 2e79 616d 6c27 2c0a  b_docker.yaml',.
-0000bf80: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000bf90: 7920 6578 6563 207b 6e61 6d65 7d20 2d6e  y exec {name} -n
-0000bfa0: 207b 6e61 6d65 7d2d 3320 2d64 202d 2d69   {name}-3 -d --i
-0000bfb0: 6d61 6765 2d69 6420 7b69 6d61 6765 5f69  mage-id {image_i
-0000bfc0: 647d 202d 2d65 6e76 2054 494d 455f 544f  d} --env TIME_TO
-0000bfd0: 5f53 4c45 4550 3d7b 7469 6d65 5f74 6f5f  _SLEEP={time_to_
-0000bfe0: 736c 6565 707d 2065 7861 6d70 6c65 732f  sleep} examples/
-0000bff0: 6a6f 625f 7175 6575 652f 6a6f 625f 646f  job_queue/job_do
-0000c000: 636b 6572 2e79 616d 6c27 2c0a 2020 2020  cker.yaml',.    
-0000c010: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-0000c020: 7920 7175 6575 6520 7b6e 616d 657d 293b  y queue {name});
-0000c030: 2065 6368 6f20 2224 7322 3b20 6563 686f   echo "$s"; echo
-0000c040: 3b20 6563 686f 3b20 6563 686f 2022 2473  ; echo; echo "$s
-0000c050: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
-0000c060: 3120 7c20 6772 6570 2052 554e 4e49 4e47  1 | grep RUNNING
-0000c070: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000c080: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
-0000c090: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
-0000c0a0: 223b 2065 6368 6f3b 2065 6368 6f3b 2065  "; echo; echo; e
-0000c0b0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-0000c0c0: 7b6e 616d 657d 2d32 207c 2067 7265 7020  {name}-2 | grep 
-0000c0d0: 5255 4e4e 494e 4727 2c0a 2020 2020 2020  RUNNING',.      
-0000c0e0: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
-0000c0f0: 7175 6575 6520 7b6e 616d 657d 293b 2065  queue {name}); e
-0000c100: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
-0000c110: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
-0000c120: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
-0000c130: 7c20 6772 6570 2050 454e 4449 4e47 272c  | grep PENDING',
-0000c140: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000c150: 6b79 2063 616e 6365 6c20 2d79 207b 6e61  ky cancel -y {na
-0000c160: 6d65 7d20 3227 2c0a 2020 2020 2020 2020  me} 2',.        
-0000c170: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
-0000c180: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-0000c190: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
-0000c1a0: 7d29 3b20 6563 686f 2022 2473 223b 2065  }); echo "$s"; e
-0000c1b0: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
-0000c1c0: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
-0000c1d0: 657d 2d33 207c 2067 7265 7020 5255 4e4e  e}-3 | grep RUNN
-0000c1e0: 494e 4727 2c0a 2020 2020 2020 2020 2020  ING',.          
-0000c1f0: 2020 6627 736b 7920 6361 6e63 656c 202d    f'sky cancel -
-0000c200: 7920 7b6e 616d 657d 2033 272c 0a20 2020  y {name} 3',.   
-0000c210: 2020 2020 2020 2020 2023 204d 616b 6520           # Make 
-0000c220: 7375 7265 2074 6865 2047 5055 2069 7320  sure the GPU is 
-0000c230: 7374 696c 6c20 7669 7369 626c 6520 746f  still visible to
-0000c240: 2074 6865 2063 6f6e 7461 696e 6572 2e0a   the container..
-0000c250: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000c260: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
-0000c270: 696d 6167 652d 6964 207b 696d 6167 655f  image-id {image_
-0000c280: 6964 7d20 6e76 6964 6961 2d73 6d69 207c  id} nvidia-smi |
-0000c290: 2067 7265 7020 2254 6573 6c61 2054 3422   grep "Tesla T4"
-0000c2a0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000c2b0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0000c2c0: 2034 202d 2d73 7461 7475 7327 2c0a 2020   4 --status',.  
-0000c2d0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000c2e0: 7374 6f70 202d 7920 7b6e 616d 657d 272c  stop -y {name}',
-0000c2f0: 0a20 2020 2020 2020 2020 2020 2023 204d  .            # M
-0000c300: 616b 6520 7375 7265 2074 6865 206a 6f62  ake sure the job
-0000c310: 2073 7461 7475 7320 7072 6573 6572 7665   status preserve
-0000c320: 2061 6674 6572 2073 746f 7020 616e 6420   after stop and 
-0000c330: 7374 6172 7420 7468 650a 2020 2020 2020  start the.      
-0000c340: 2020 2020 2020 2320 636c 7573 7465 722e        # cluster.
-0000c350: 2054 6869 7320 6973 2061 6c73 6f20 6120   This is also a 
-0000c360: 7465 7374 2066 6f72 2074 6865 2064 6f63  test for the doc
-0000c370: 6b65 7220 636f 6e74 6169 6e65 7220 746f  ker container to
-0000c380: 2062 650a 2020 2020 2020 2020 2020 2020   be.            
-0000c390: 2320 7072 6573 6572 7665 6420 6166 7465  # preserved afte
-0000c3a0: 7220 7374 6f70 2061 6e64 2073 7461 7274  r stop and start
-0000c3b0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-0000c3c0: 736b 7920 7374 6172 7420 2d79 207b 6e61  sky start -y {na
-0000c3d0: 6d65 7d27 2c0a 2020 2020 2020 2020 2020  me}',.          
-0000c3e0: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
-0000c3f0: 6520 7b6e 616d 657d 293b 2065 6368 6f20  e {name}); echo 
-0000c400: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
-0000c410: 3b20 6563 686f 2022 2473 2220 7c20 6772  ; echo "$s" | gr
-0000c420: 6570 207b 6e61 6d65 7d2d 3120 7c20 6772  ep {name}-1 | gr
-0000c430: 6570 2046 4149 4c45 4427 2c0a 2020 2020  ep FAILED',.    
-0000c440: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-0000c450: 7920 7175 6575 6520 7b6e 616d 657d 293b  y queue {name});
-0000c460: 2065 6368 6f20 2224 7322 3b20 6563 686f   echo "$s"; echo
-0000c470: 3b20 6563 686f 3b20 6563 686f 2022 2473  ; echo; echo "$s
-0000c480: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
-0000c490: 3220 7c20 6772 6570 2043 414e 4345 4c4c  2 | grep CANCELL
-0000c4a0: 4544 272c 0a20 2020 2020 2020 2020 2020  ED',.           
-0000c4b0: 2066 2773 3d24 2873 6b79 2071 7565 7565   f's=$(sky queue
-0000c4c0: 207b 6e61 6d65 7d29 3b20 6563 686f 2022   {name}); echo "
-0000c4d0: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
-0000c4e0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
-0000c4f0: 7020 7b6e 616d 657d 2d33 207c 2067 7265  p {name}-3 | gre
-0000c500: 7020 4341 4e43 454c 4c45 4427 2c0a 2020  p CANCELLED',.  
-0000c510: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000c520: 6578 6563 207b 6e61 6d65 7d20 2d2d 6770  exec {name} --gp
-0000c530: 7573 2054 343a 302e 3220 225b 5b20 5c24  us T4:0.2 "[[ \$
-0000c540: 534b 5950 494c 4f54 5f4e 554d 5f47 5055  SKYPILOT_NUM_GPU
-0000c550: 535f 5045 525f 4e4f 4445 202d 6571 2031  S_PER_NODE -eq 1
-0000c560: 205d 5d20 7c7c 2065 7869 7420 3122 272c   ]] || exit 1"',
-0000c570: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000c580: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-0000c590: 2d67 7075 7320 5434 3a31 2022 5b5b 205c  -gpus T4:1 "[[ \
-0000c5a0: 2453 4b59 5049 4c4f 545f 4e55 4d5f 4750  $SKYPILOT_NUM_GP
-0000c5b0: 5553 5f50 4552 5f4e 4f44 4520 2d65 7120  US_PER_NODE -eq 
-0000c5c0: 3120 5d5d 207c 7c20 6578 6974 2031 2227  1 ]] || exit 1"'
-0000c5d0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000c5e0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0000c5f0: 3520 2d2d 7374 6174 7573 272c 0a20 2020  5 --status',.   
-0000c600: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000c610: 6f67 7320 7b6e 616d 657d 2036 202d 2d73  ogs {name} 6 --s
-0000c620: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-0000c630: 2020 2020 2320 4d61 6b65 2073 7572 6520      # Make sure 
-0000c640: 6974 2069 7320 7374 696c 6c20 7669 7369  it is still visi
-0000c650: 626c 6520 6166 7465 7220 616e 2073 746f  ble after an sto
-0000c660: 7020 2620 7374 6172 7420 6379 636c 652e  p & start cycle.
-0000c670: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000c680: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-0000c690: 2d69 6d61 6765 2d69 6420 7b69 6d61 6765  -image-id {image
-0000c6a0: 5f69 647d 206e 7669 6469 612d 736d 6920  _id} nvidia-smi 
-0000c6b0: 7c20 6772 6570 2022 5465 736c 6120 5434  | grep "Tesla T4
-0000c6c0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-0000c6d0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-0000c6e0: 7d20 3720 2d2d 7374 6174 7573 270a 2020  } 7 --status'.  
-0000c6f0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0000c700: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-0000c710: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
-0000c720: 7469 6d65 6f75 743d 746f 7461 6c5f 7469  timeout=total_ti
-0000c730: 6d65 6f75 745f 6d69 6e75 7465 7320 2a20  meout_minutes * 
-0000c740: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-0000c750: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-0000c760: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-0000c770: 6c61 6d62 6461 5f63 6c6f 7564 0a64 6566  lambda_cloud.def
-0000c780: 2074 6573 745f 6c61 6d62 6461 5f6a 6f62   test_lambda_job
-0000c790: 5f71 7565 7565 2829 3a0a 2020 2020 6e61  _queue():.    na
-0000c7a0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-0000c7b0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-0000c7c0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-0000c7d0: 2020 276c 616d 6264 615f 6a6f 625f 7175    'lambda_job_qu
-0000c7e0: 6575 6527 2c0a 2020 2020 2020 2020 5b0a  eue',.        [.
-0000c7f0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000c800: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-0000c810: 6e61 6d65 7d20 7b4c 414d 4244 415f 5459  name} {LAMBDA_TY
-0000c820: 5045 7d20 6578 616d 706c 6573 2f6a 6f62  PE} examples/job
-0000c830: 5f71 7565 7565 2f63 6c75 7374 6572 2e79  _queue/cluster.y
-0000c840: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-0000c850: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000c860: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3120  me} -n {name}-1 
-0000c870: 2d2d 6770 7573 2041 3130 3a30 2e35 202d  --gpus A10:0.5 -
-0000c880: 6420 6578 616d 706c 6573 2f6a 6f62 5f71  d examples/job_q
-0000c890: 7565 7565 2f6a 6f62 2e79 616d 6c27 2c0a  ueue/job.yaml',.
-0000c8a0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000c8b0: 7920 6578 6563 207b 6e61 6d65 7d20 2d6e  y exec {name} -n
-0000c8c0: 207b 6e61 6d65 7d2d 3220 2d2d 6770 7573   {name}-2 --gpus
-0000c8d0: 2041 3130 3a30 2e35 202d 6420 6578 616d   A10:0.5 -d exam
-0000c8e0: 706c 6573 2f6a 6f62 5f71 7565 7565 2f6a  ples/job_queue/j
-0000c8f0: 6f62 2e79 616d 6c27 2c0a 2020 2020 2020  ob.yaml',.      
-0000c900: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-0000c910: 207b 6e61 6d65 7d20 2d6e 207b 6e61 6d65   {name} -n {name
-0000c920: 7d2d 3320 2d2d 6770 7573 2041 3130 3a30  }-3 --gpus A10:0
-0000c930: 2e35 202d 6420 6578 616d 706c 6573 2f6a  .5 -d examples/j
-0000c940: 6f62 5f71 7565 7565 2f6a 6f62 2e79 616d  ob_queue/job.yam
-0000c950: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-0000c960: 6627 736b 7920 7175 6575 6520 7b6e 616d  f'sky queue {nam
-0000c970: 657d 207c 2067 7265 7020 7b6e 616d 657d  e} | grep {name}
-0000c980: 2d31 207c 2067 7265 7020 5255 4e4e 494e  -1 | grep RUNNIN
-0000c990: 4727 2c0a 2020 2020 2020 2020 2020 2020  G',.            
-0000c9a0: 6627 736b 7920 7175 6575 6520 7b6e 616d  f'sky queue {nam
-0000c9b0: 657d 207c 2067 7265 7020 7b6e 616d 657d  e} | grep {name}
-0000c9c0: 2d32 207c 2067 7265 7020 5255 4e4e 494e  -2 | grep RUNNIN
-0000c9d0: 4727 2c0a 2020 2020 2020 2020 2020 2020  G',.            
-0000c9e0: 6627 736b 7920 7175 6575 6520 7b6e 616d  f'sky queue {nam
-0000c9f0: 657d 207c 2067 7265 7020 7b6e 616d 657d  e} | grep {name}
-0000ca00: 2d33 207c 2067 7265 7020 5045 4e44 494e  -3 | grep PENDIN
-0000ca10: 4727 2c0a 2020 2020 2020 2020 2020 2020  G',.            
-0000ca20: 6627 736b 7920 6361 6e63 656c 202d 7920  f'sky cancel -y 
-0000ca30: 7b6e 616d 657d 2032 272c 0a20 2020 2020  {name} 2',.     
-0000ca40: 2020 2020 2020 2027 736c 6565 7020 3527         'sleep 5'
-0000ca50: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000ca60: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
-0000ca70: 207c 2067 7265 7020 7b6e 616d 657d 2d33   | grep {name}-3
-0000ca80: 207c 2067 7265 7020 5255 4e4e 494e 4727   | grep RUNNING'
-0000ca90: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000caa0: 736b 7920 6361 6e63 656c 202d 7920 7b6e  sky cancel -y {n
-0000cab0: 616d 657d 2033 272c 0a20 2020 2020 2020  ame} 3',.       
-0000cac0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-0000cad0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-0000cae0: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
-0000caf0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-0000cb00: 0a0a 4070 7974 6573 742e 6d61 726b 2e69  ..@pytest.mark.i
-0000cb10: 626d 0a64 6566 2074 6573 745f 6962 6d5f  bm.def test_ibm_
-0000cb20: 6a6f 625f 7175 6575 6528 293a 0a20 2020  job_queue():.   
-0000cb30: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-0000cb40: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-0000cb50: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-0000cb60: 2020 2020 2027 6962 6d5f 6a6f 625f 7175       'ibm_job_qu
-0000cb70: 6575 6527 2c0a 2020 2020 2020 2020 5b0a  eue',.        [.
-0000cb80: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000cb90: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-0000cba0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6962  name} --cloud ib
-0000cbb0: 6d20 2d2d 6770 7573 2076 3130 3027 2c0a  m --gpus v100',.
-0000cbc0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000cbd0: 7920 6578 6563 207b 6e61 6d65 7d20 2d6e  y exec {name} -n
-0000cbe0: 207b 6e61 6d65 7d2d 3120 2d2d 636c 6f75   {name}-1 --clou
-0000cbf0: 6420 6962 6d20 2d64 2065 7861 6d70 6c65  d ibm -d example
-0000cc00: 732f 6a6f 625f 7175 6575 652f 6a6f 625f  s/job_queue/job_
-0000cc10: 6962 6d2e 7961 6d6c 272c 0a20 2020 2020  ibm.yaml',.     
-0000cc20: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-0000cc30: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
-0000cc40: 657d 2d32 202d 2d63 6c6f 7564 2069 626d  e}-2 --cloud ibm
-0000cc50: 202d 6420 6578 616d 706c 6573 2f6a 6f62   -d examples/job
-0000cc60: 5f71 7565 7565 2f6a 6f62 5f69 626d 2e79  _queue/job_ibm.y
-0000cc70: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-0000cc80: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000cc90: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3320  me} -n {name}-3 
-0000cca0: 2d2d 636c 6f75 6420 6962 6d20 2d64 2065  --cloud ibm -d e
-0000ccb0: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
-0000ccc0: 652f 6a6f 625f 6962 6d2e 7961 6d6c 272c  e/job_ibm.yaml',
-0000ccd0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000cce0: 6b79 2071 7565 7565 207b 6e61 6d65 7d20  ky queue {name} 
-0000ccf0: 7c20 6772 6570 207b 6e61 6d65 7d2d 3120  | grep {name}-1 
-0000cd00: 7c20 6772 6570 2052 554e 4e49 4e47 272c  | grep RUNNING',
+00006ec0: 7920 6c61 756e 6368 202d 2d63 6c6f 6e65  y launch --clone
+00006ed0: 2d64 6973 6b2d 6672 6f6d 207b 6e61 6d65  -disk-from {name
+00006ee0: 7d20 2d79 202d 6320 7b6e 616d 657d 2d63  } -y -c {name}-c
+00006ef0: 6c6f 6e65 2026 2620 6578 6974 2031 207c  lone && exit 1 |
+00006f00: 7c20 7472 7565 272c 0a20 2020 2020 2020  | true',.       
+00006f10: 2020 2020 2066 2773 6b79 2073 746f 7020       f'sky stop 
+00006f20: 7b6e 616d 657d 202d 7927 2c0a 2020 2020  {name} -y',.    
+00006f30: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+00006f40: 756e 6368 202d 2d63 6c6f 6e65 2d64 6973  unch --clone-dis
+00006f50: 6b2d 6672 6f6d 207b 6e61 6d65 7d20 2d79  k-from {name} -y
+00006f60: 202d 6320 7b6e 616d 657d 2d63 6c6f 6e65   -c {name}-clone
+00006f70: 202d 2d63 6c6f 7564 2067 6370 202d 2d7a   --cloud gcp --z
+00006f80: 6f6e 6520 7573 2d63 656e 7472 616c 312d  one us-central1-
+00006f90: 6120 2263 6174 207e 2f75 7365 725f 6669  a "cat ~/user_fi
+00006fa0: 6c65 2e74 7874 207c 2067 7265 7020 6865  le.txt | grep he
+00006fb0: 6c6c 6f22 272c 0a20 2020 2020 2020 2020  llo"',.         
+00006fc0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00006fd0: 2d2d 636c 6f6e 652d 6469 736b 2d66 726f  --clone-disk-fro
+00006fe0: 6d20 7b6e 616d 657d 202d 7920 2d63 207b  m {name} -y -c {
+00006ff0: 6e61 6d65 7d2d 636c 6f6e 652d 3220 2d2d  name}-clone-2 --
+00007000: 636c 6f75 6420 6763 7020 2d2d 7a6f 6e65  cloud gcp --zone
+00007010: 2075 732d 6561 7374 312d 6220 2263 6174   us-east1-b "cat
+00007020: 207e 2f75 7365 725f 6669 6c65 2e74 7874   ~/user_file.txt
+00007030: 207c 2067 7265 7020 6865 6c6c 6f22 272c   | grep hello"',
+00007040: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00007050: 6b79 206c 6f67 7320 7b6e 616d 657d 2d63  ky logs {name}-c
+00007060: 6c6f 6e65 2031 202d 2d73 7461 7475 7327  lone 1 --status'
+00007070: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00007080: 736b 7920 6c6f 6773 207b 6e61 6d65 7d2d  sky logs {name}-
+00007090: 636c 6f6e 652d 3220 3120 2d2d 7374 6174  clone-2 1 --stat
+000070a0: 7573 272c 0a20 2020 2020 2020 205d 2c0a  us',.        ],.
+000070b0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+000070c0: 776e 202d 7920 7b6e 616d 657d 207b 6e61  wn -y {name} {na
+000070d0: 6d65 7d2d 636c 6f6e 6520 7b6e 616d 657d  me}-clone {name}
+000070e0: 2d63 6c6f 6e65 2d32 272c 0a20 2020 2029  -clone-2',.    )
+000070f0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00007100: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00007110: 742e 6d61 726b 2e61 7773 0a64 6566 2074  t.mark.aws.def t
+00007120: 6573 745f 696d 6167 655f 6e6f 5f63 6f6e  est_image_no_con
+00007130: 6461 2829 3a0a 2020 2020 6e61 6d65 203d  da():.    name =
+00007140: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00007150: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00007160: 5465 7374 280a 2020 2020 2020 2020 2769  Test(.        'i
+00007170: 6d61 6765 5f6e 6f5f 636f 6e64 6127 2c0a  mage_no_conda',.
+00007180: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00007190: 2020 2020 2020 2320 5573 6520 696d 6167        # Use imag
+000071a0: 6520 6964 2064 6963 742e 0a20 2020 2020  e id dict..     
+000071b0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+000071c0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+000071d0: 202d 2d72 6567 696f 6e20 7573 2d65 6173   --region us-eas
+000071e0: 742d 3220 6578 616d 706c 6573 2f70 6572  t-2 examples/per
+000071f0: 5f72 6567 696f 6e5f 696d 6167 6573 2e79  _region_images.y
+00007200: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00007210: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00007220: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+00007230: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00007240: 6b79 2073 746f 7020 7b6e 616d 657d 202d  ky stop {name} -
+00007250: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
+00007260: 6627 736b 7920 7374 6172 7420 7b6e 616d  f'sky start {nam
+00007270: 657d 202d 7927 2c0a 2020 2020 2020 2020  e} -y',.        
+00007280: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+00007290: 6e61 6d65 7d20 6578 616d 706c 6573 2f70  name} examples/p
+000072a0: 6572 5f72 6567 696f 6e5f 696d 6167 6573  er_region_images
+000072b0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+000072c0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+000072d0: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
+000072e0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+000072f0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00007300: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00007310: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00007320: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+00007330: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
+00007340: 726e 6574 6573 2020 2320 4b75 6265 726e  rnetes  # Kubern
+00007350: 6574 6573 2064 6f65 7320 6e6f 7420 7375  etes does not su
+00007360: 7070 6f72 7420 7374 6f70 7069 6e67 2069  pport stopping i
+00007370: 6e73 7461 6e63 6573 0a64 6566 2074 6573  nstances.def tes
+00007380: 745f 6375 7374 6f6d 5f64 6566 6175 6c74  t_custom_default
+00007390: 5f63 6f6e 6461 5f65 6e76 2867 656e 6572  _conda_env(gener
+000073a0: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+000073b0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+000073c0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+000073d0: 2020 2074 6573 7420 3d20 5465 7374 2827     test = Test('
+000073e0: 6375 7374 6f6d 5f64 6566 6175 6c74 5f63  custom_default_c
+000073f0: 6f6e 6461 5f65 6e76 272c 205b 0a20 2020  onda_env', [.   
+00007400: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00007410: 6820 2d63 207b 6e61 6d65 7d20 2d79 202d  h -c {name} -y -
+00007420: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+00007430: 636c 6f75 647d 2074 6573 7473 2f74 6573  cloud} tests/tes
+00007440: 745f 7961 6d6c 732f 7465 7374 5f63 7573  t_yamls/test_cus
+00007450: 746f 6d5f 6465 6661 756c 745f 636f 6e64  tom_default_cond
+00007460: 615f 656e 762e 7961 6d6c 272c 0a20 2020  a_env.yaml',.   
+00007470: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
+00007480: 7320 2d72 207b 6e61 6d65 7d20 7c20 6772  s -r {name} | gr
+00007490: 6570 2022 5550 2227 2c0a 2020 2020 2020  ep "UP"',.      
+000074a0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+000074b0: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+000074c0: 0a20 2020 2020 2020 2066 2773 6b79 206c  .        f'sky l
+000074d0: 6f67 7320 7b6e 616d 657d 2031 202d 2d6e  ogs {name} 1 --n
+000074e0: 6f2d 666f 6c6c 6f77 207c 2067 7265 7020  o-follow | grep 
+000074f0: 2d50 2022 6d79 656e 765c 5c73 2b5c 5c2a  -P "myenv\\s+\\*
+00007500: 2227 2c0a 2020 2020 2020 2020 6627 736b  "',.        f'sk
+00007510: 7920 6578 6563 207b 6e61 6d65 7d20 7465  y exec {name} te
+00007520: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
+00007530: 6573 745f 6375 7374 6f6d 5f64 6566 6175  est_custom_defau
+00007540: 6c74 5f63 6f6e 6461 5f65 6e76 2e79 616d  lt_conda_env.yam
+00007550: 6c27 2c0a 2020 2020 2020 2020 6627 736b  l',.        f'sk
+00007560: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
+00007570: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+00007580: 2020 2066 2773 6b79 2061 7574 6f73 746f     f'sky autosto
+00007590: 7020 2d79 202d 6920 3020 7b6e 616d 657d  p -y -i 0 {name}
+000075a0: 272c 0a20 2020 2020 2020 2027 736c 6565  ',.        'slee
+000075b0: 7020 3630 272c 0a20 2020 2020 2020 2066  p 60',.        f
+000075c0: 2773 6b79 2073 7461 7475 7320 2d72 207b  'sky status -r {
+000075d0: 6e61 6d65 7d20 7c20 6772 6570 2022 5354  name} | grep "ST
+000075e0: 4f50 5045 4422 272c 0a20 2020 2020 2020  OPPED"',.       
+000075f0: 2066 2773 6b79 2073 7461 7274 202d 7920   f'sky start -y 
+00007600: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
+00007610: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00007620: 657d 2032 202d 2d6e 6f2d 666f 6c6c 6f77  e} 2 --no-follow
+00007630: 207c 2067 7265 7020 2d50 2022 6d79 656e   | grep -P "myen
+00007640: 765c 5c73 2b5c 5c2a 2227 2c0a 2020 2020  v\\s+\\*"',.    
+00007650: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+00007660: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
+00007670: 5f79 616d 6c73 2f74 6573 745f 6375 7374  _yamls/test_cust
+00007680: 6f6d 5f64 6566 6175 6c74 5f63 6f6e 6461  om_default_conda
+00007690: 5f65 6e76 2e79 616d 6c27 2c0a 2020 2020  _env.yaml',.    
+000076a0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+000076b0: 6e61 6d65 7d20 3320 2d2d 7374 6174 7573  name} 3 --status
+000076c0: 272c 0a20 2020 205d 2c20 6627 736b 7920  ',.    ], f'sky 
+000076d0: 646f 776e 202d 7920 7b6e 616d 657d 2729  down -y {name}')
+000076e0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+000076f0: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+00007700: 2d2d 2d2d 2d2d 2d2d 2054 6573 7420 7374  -------- Test st
+00007710: 616c 6520 6a6f 6220 2d2d 2d2d 2d2d 2d2d  ale job --------
+00007720: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
+00007730: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b20  k.no_fluidstack 
+00007740: 2023 2046 6c75 6964 5374 6163 6b20 646f   # FluidStack do
+00007750: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
+00007760: 746f 7070 696e 6720 696e 7374 616e 6365  topping instance
+00007770: 7320 696e 2053 6b79 5069 6c6f 7420 696d  s in SkyPilot im
+00007780: 706c 656d 656e 7461 7469 6f6e 0a40 7079  plementation.@py
+00007790: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
+000077a0: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
+000077b0: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
+000077c0: 6f74 2073 7570 706f 7274 2073 746f 7070  ot support stopp
+000077d0: 696e 6720 696e 7374 616e 6365 730a 4070  ing instances.@p
+000077e0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6b75  ytest.mark.no_ku
+000077f0: 6265 726e 6574 6573 2020 2320 4b75 6265  bernetes  # Kube
+00007800: 726e 6574 6573 2064 6f65 7320 6e6f 7420  rnetes does not 
+00007810: 7375 7070 6f72 7420 7374 6f70 7069 6e67  support stopping
+00007820: 2069 6e73 7461 6e63 6573 0a64 6566 2074   instances.def t
+00007830: 6573 745f 7374 616c 655f 6a6f 6228 6765  est_stale_job(ge
+00007840: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+00007850: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+00007860: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+00007870: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+00007880: 7428 0a20 2020 2020 2020 2027 7374 616c  t(.        'stal
+00007890: 655f 6a6f 6227 2c0a 2020 2020 2020 2020  e_job',.        
+000078a0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+000078b0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+000078c0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+000078d0: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+000078e0: 2265 6368 6f20 6869 2227 2c0a 2020 2020  "echo hi"',.    
+000078f0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00007900: 6563 207b 6e61 6d65 7d20 2d64 2022 6563  ec {name} -d "ec
+00007910: 686f 2073 7461 7274 3b20 736c 6565 7020  ho start; sleep 
+00007920: 3130 3030 3022 272c 0a20 2020 2020 2020  10000"',.       
+00007930: 2020 2020 2066 2773 6b79 2073 746f 7020       f'sky stop 
+00007940: 7b6e 616d 657d 202d 7927 2c0a 2020 2020  {name} -y',.    
+00007950: 2020 2020 2020 2020 2773 6c65 6570 2031          'sleep 1
+00007960: 3030 272c 2020 2320 456e 7375 7265 2074  00',  # Ensure t
+00007970: 6869 7320 6973 206c 6172 6765 2065 6e6f  his is large eno
+00007980: 7567 682c 2065 6c73 6520 4743 5020 6c65  ugh, else GCP le
+00007990: 616b 732e 0a20 2020 2020 2020 2020 2020  aks..           
+000079a0: 2066 2773 6b79 2073 7461 7274 207b 6e61   f'sky start {na
+000079b0: 6d65 7d20 2d79 272c 0a20 2020 2020 2020  me} -y',.       
+000079c0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+000079d0: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+000079e0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+000079f0: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
+00007a00: 7b6e 616d 657d 293b 2065 6368 6f20 2224  {name}); echo "$
+00007a10: 7322 3b20 6563 686f 3b20 6563 686f 3b20  s"; echo; echo; 
+00007a20: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+00007a30: 2046 4149 4c45 4427 2c0a 2020 2020 2020   FAILED',.      
+00007a40: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+00007a50: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00007a60: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
+00007a70: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00007a80: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00007a90: 6177 730a 6465 6620 7465 7374 5f61 7773  aws.def test_aws
+00007aa0: 5f73 7461 6c65 5f6a 6f62 5f6d 616e 7561  _stale_job_manua
+00007ab0: 6c5f 7265 7374 6172 7428 293a 0a20 2020  l_restart():.   
+00007ac0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+00007ad0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+00007ae0: 6e61 6d65 5f6f 6e5f 636c 6f75 6420 3d20  name_on_cloud = 
+00007af0: 636f 6d6d 6f6e 5f75 7469 6c73 2e6d 616b  common_utils.mak
+00007b00: 655f 636c 7573 7465 725f 6e61 6d65 5f6f  e_cluster_name_o
+00007b10: 6e5f 636c 6f75 6428 0a20 2020 2020 2020  n_cloud(.       
+00007b20: 206e 616d 652c 2073 6b79 2e41 5753 2e6d   name, sky.AWS.m
+00007b30: 6178 5f63 6c75 7374 6572 5f6e 616d 655f  ax_cluster_name_
+00007b40: 6c65 6e67 7468 2829 290a 2020 2020 7265  length()).    re
+00007b50: 6769 6f6e 203d 2027 7573 2d65 6173 742d  gion = 'us-east-
+00007b60: 3227 0a20 2020 2074 6573 7420 3d20 5465  2'.    test = Te
+00007b70: 7374 280a 2020 2020 2020 2020 2761 7773  st(.        'aws
+00007b80: 5f73 7461 6c65 5f6a 6f62 5f6d 616e 7561  _stale_job_manua
+00007b90: 6c5f 7265 7374 6172 7427 2c0a 2020 2020  l_restart',.    
+00007ba0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00007bb0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00007bc0: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
+00007bd0: 6f75 6420 6177 7320 2d2d 7265 6769 6f6e  oud aws --region
+00007be0: 207b 7265 6769 6f6e 7d20 2265 6368 6f20   {region} "echo 
+00007bf0: 6869 2227 2c0a 2020 2020 2020 2020 2020  hi"',.          
+00007c00: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+00007c10: 6d65 7d20 2d64 2022 6563 686f 2073 7461  me} -d "echo sta
+00007c20: 7274 3b20 736c 6565 7020 3130 3030 3022  rt; sleep 10000"
+00007c30: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+00007c40: 2053 746f 7020 7468 6520 636c 7573 7465   Stop the cluste
+00007c50: 7220 6d61 6e75 616c 6c79 2e0a 2020 2020  r manually..    
+00007c60: 2020 2020 2020 2020 6627 6964 3d60 6177          f'id=`aw
+00007c70: 7320 6563 3220 6465 7363 7269 6265 2d69  s ec2 describe-i
+00007c80: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
+00007c90: 6e20 7b72 6567 696f 6e7d 202d 2d66 696c  n {region} --fil
+00007ca0: 7465 7273 2027 0a20 2020 2020 2020 2020  ters '.         
+00007cb0: 2020 2066 274e 616d 653d 7461 673a 7261     f'Name=tag:ra
+00007cc0: 792d 636c 7573 7465 722d 6e61 6d65 2c56  y-cluster-name,V
+00007cd0: 616c 7565 733d 7b6e 616d 655f 6f6e 5f63  alues={name_on_c
+00007ce0: 6c6f 7564 7d20 270a 2020 2020 2020 2020  loud} '.        
+00007cf0: 2020 2020 6627 2d2d 7175 6572 7920 5265      f'--query Re
+00007d00: 7365 7276 6174 696f 6e73 5b5d 2e49 6e73  servations[].Ins
+00007d10: 7461 6e63 6573 5b5d 2e49 6e73 7461 6e63  tances[].Instanc
+00007d20: 6549 6420 270a 2020 2020 2020 2020 2020  eId '.          
+00007d30: 2020 272d 2d6f 7574 7075 7420 7465 7874    '--output text
+00007d40: 603b 2027 0a20 2020 2020 2020 2020 2020  `; '.           
+00007d50: 2066 2761 7773 2065 6332 2073 746f 702d   f'aws ec2 stop-
+00007d60: 696e 7374 616e 6365 7320 2d2d 7265 6769  instances --regi
+00007d70: 6f6e 207b 7265 6769 6f6e 7d20 270a 2020  on {region} '.  
+00007d80: 2020 2020 2020 2020 2020 272d 2d69 6e73            '--ins
+00007d90: 7461 6e63 652d 6964 7320 2469 6427 2c0a  tance-ids $id',.
+00007da0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00007db0: 6570 2034 3027 2c0a 2020 2020 2020 2020  ep 40',.        
+00007dc0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00007dd0: 202d 6320 7b6e 616d 657d 202d 7920 2265   -c {name} -y "e
+00007de0: 6368 6f20 6869 2227 2c0a 2020 2020 2020  cho hi"',.      
+00007df0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00007e00: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
+00007e10: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+00007e20: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00007e30: 657d 2033 202d 2d73 7461 7475 7327 2c0a  e} 3 --status',.
+00007e40: 2020 2020 2020 2020 2020 2020 2320 456e              # En
+00007e50: 7375 7265 2074 6865 2073 6b79 6c65 7420  sure the skylet 
+00007e60: 7570 6461 7465 6420 7468 6520 7374 616c  updated the stal
+00007e70: 6520 6a6f 6220 7374 6174 7573 2e0a 2020  e job status..  
+00007e80: 2020 2020 2020 2020 2020 6627 736c 6565            f'slee
+00007e90: 7020 7b65 7665 6e74 732e 4a6f 6253 6368  p {events.JobSch
+00007ea0: 6564 756c 6572 4576 656e 742e 4556 454e  edulerEvent.EVEN
+00007eb0: 545f 494e 5445 5256 414c 5f53 4543 4f4e  T_INTERVAL_SECON
+00007ec0: 4453 7d27 2c0a 2020 2020 2020 2020 2020  DS}',.          
+00007ed0: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
+00007ee0: 6520 7b6e 616d 657d 293b 2065 6368 6f20  e {name}); echo 
+00007ef0: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
+00007f00: 3b20 6563 686f 2022 2473 2220 7c20 6772  ; echo "$s" | gr
+00007f10: 6570 2046 4149 4c45 4427 2c0a 2020 2020  ep FAILED',.    
+00007f20: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+00007f30: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+00007f40: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+00007f50: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00007f60: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00007f70: 6b2e 6763 700a 6465 6620 7465 7374 5f67  k.gcp.def test_g
+00007f80: 6370 5f73 7461 6c65 5f6a 6f62 5f6d 616e  cp_stale_job_man
+00007f90: 7561 6c5f 7265 7374 6172 7428 293a 0a20  ual_restart():. 
+00007fa0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00007fb0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00007fc0: 2020 6e61 6d65 5f6f 6e5f 636c 6f75 6420    name_on_cloud 
+00007fd0: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e6d  = common_utils.m
+00007fe0: 616b 655f 636c 7573 7465 725f 6e61 6d65  ake_cluster_name
+00007ff0: 5f6f 6e5f 636c 6f75 6428 0a20 2020 2020  _on_cloud(.     
+00008000: 2020 206e 616d 652c 2073 6b79 2e47 4350     name, sky.GCP
+00008010: 2e6d 6178 5f63 6c75 7374 6572 5f6e 616d  .max_cluster_nam
+00008020: 655f 6c65 6e67 7468 2829 290a 2020 2020  e_length()).    
+00008030: 7a6f 6e65 203d 2027 7573 2d77 6573 7432  zone = 'us-west2
+00008040: 2d61 270a 2020 2020 7175 6572 795f 636d  -a'.    query_cm
+00008050: 6420 3d20 2866 2767 636c 6f75 6420 636f  d = (f'gcloud co
+00008060: 6d70 7574 6520 696e 7374 616e 6365 7320  mpute instances 
+00008070: 6c69 7374 202d 2d66 696c 7465 723d 270a  list --filter='.
+00008080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008090: 2066 2722 286c 6162 656c 732e 7261 792d   f'"(labels.ray-
+000080a0: 636c 7573 7465 722d 6e61 6d65 3d7b 6e61  cluster-name={na
+000080b0: 6d65 5f6f 6e5f 636c 6f75 647d 2922 2027  me_on_cloud})" '
+000080c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000080d0: 2020 6627 2d2d 7a6f 6e65 733d 7b7a 6f6e    f'--zones={zon
+000080e0: 657d 202d 2d66 6f72 6d61 743d 2276 616c  e} --format="val
+000080f0: 7565 286e 616d 6529 2227 290a 2020 2020  ue(name)"').    
+00008100: 7374 6f70 5f63 6d64 203d 2028 6627 6763  stop_cmd = (f'gc
+00008110: 6c6f 7564 2063 6f6d 7075 7465 2069 6e73  loud compute ins
+00008120: 7461 6e63 6573 2073 746f 7020 2d2d 7a6f  tances stop --zo
+00008130: 6e65 3d7b 7a6f 6e65 7d27 0a20 2020 2020  ne={zone}'.     
+00008140: 2020 2020 2020 2020 2020 2066 2720 2d2d             f' --
+00008150: 7175 6965 7420 2428 7b71 7565 7279 5f63  quiet $({query_c
+00008160: 6d64 7d29 2729 0a20 2020 2074 6573 7420  md})').    test 
+00008170: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00008180: 2767 6370 5f73 7461 6c65 5f6a 6f62 5f6d  'gcp_stale_job_m
+00008190: 616e 7561 6c5f 7265 7374 6172 7427 2c0a  anual_restart',.
+000081a0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+000081b0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+000081c0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
+000081d0: 2d2d 636c 6f75 6420 6763 7020 2d2d 7a6f  --cloud gcp --zo
+000081e0: 6e65 207b 7a6f 6e65 7d20 2265 6368 6f20  ne {zone} "echo 
+000081f0: 6869 2227 2c0a 2020 2020 2020 2020 2020  hi"',.          
+00008200: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+00008210: 6d65 7d20 2d64 2022 6563 686f 2073 7461  me} -d "echo sta
+00008220: 7274 3b20 736c 6565 7020 3130 3030 3022  rt; sleep 10000"
+00008230: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+00008240: 2053 746f 7020 7468 6520 636c 7573 7465   Stop the cluste
+00008250: 7220 6d61 6e75 616c 6c79 2e0a 2020 2020  r manually..    
+00008260: 2020 2020 2020 2020 7374 6f70 5f63 6d64          stop_cmd
+00008270: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+00008280: 6c65 6570 2034 3027 2c0a 2020 2020 2020  leep 40',.      
+00008290: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+000082a0: 6368 202d 6320 7b6e 616d 657d 202d 7920  ch -c {name} -y 
+000082b0: 2265 6368 6f20 6869 2227 2c0a 2020 2020  "echo hi"',.    
+000082c0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+000082d0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+000082e0: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
+000082f0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00008300: 616d 657d 2033 202d 2d73 7461 7475 7327  ame} 3 --status'
+00008310: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00008320: 456e 7375 7265 2074 6865 2073 6b79 6c65  Ensure the skyle
+00008330: 7420 7570 6461 7465 6420 7468 6520 7374  t updated the st
+00008340: 616c 6520 6a6f 6220 7374 6174 7573 2e0a  ale job status..
+00008350: 2020 2020 2020 2020 2020 2020 6627 736c              f'sl
+00008360: 6565 7020 7b65 7665 6e74 732e 4a6f 6253  eep {events.JobS
+00008370: 6368 6564 756c 6572 4576 656e 742e 4556  chedulerEvent.EV
+00008380: 454e 545f 494e 5445 5256 414c 5f53 4543  ENT_INTERVAL_SEC
+00008390: 4f4e 4453 7d27 2c0a 2020 2020 2020 2020  ONDS}',.        
+000083a0: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
+000083b0: 6575 6520 7b6e 616d 657d 293b 2065 6368  eue {name}); ech
+000083c0: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
+000083d0: 686f 3b20 6563 686f 2022 2473 2220 7c20  ho; echo "$s" | 
+000083e0: 6772 6570 2046 4149 4c45 4427 2c0a 2020  grep FAILED',.  
+000083f0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00008400: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00008410: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+00008420: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00008430: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
+00008440: 2d2d 2d20 4368 6563 6b20 536b 7927 7320  --- Check Sky's 
+00008450: 656e 7669 726f 6e6d 656e 7420 7661 7269  environment vari
+00008460: 6162 6c65 733b 2077 6f72 6b64 6972 2e20  ables; workdir. 
+00008470: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
+00008480: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
+00008490: 7374 6163 6b20 2023 2052 6571 7569 7265  stack  # Require
+000084a0: 7320 616d 617a 6f6e 2053 330a 4070 7974  s amazon S3.@pyt
+000084b0: 6573 742e 6d61 726b 2e6e 6f5f 7363 7020  est.mark.no_scp 
+000084c0: 2023 2053 4350 2064 6f65 7320 6e6f 7420   # SCP does not 
+000084d0: 7375 7070 6f72 7420 6e75 6d5f 6e6f 6465  support num_node
+000084e0: 7320 3e20 3120 7965 740a 6465 6620 7465  s > 1 yet.def te
+000084f0: 7374 5f65 6e76 5f63 6865 636b 2867 656e  st_env_check(gen
+00008500: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+00008510: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+00008520: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00008530: 0a20 2020 2074 6f74 616c 5f74 696d 656f  .    total_timeo
+00008540: 7574 5f6d 696e 7574 6573 203d 2032 3520  ut_minutes = 25 
+00008550: 6966 2067 656e 6572 6963 5f63 6c6f 7564  if generic_cloud
+00008560: 203d 3d20 2761 7a75 7265 2720 656c 7365   == 'azure' else
+00008570: 2031 350a 2020 2020 7465 7374 203d 2054   15.    test = T
+00008580: 6573 7428 0a20 2020 2020 2020 2027 656e  est(.        'en
+00008590: 765f 6368 6563 6b27 2c0a 2020 2020 2020  v_check',.      
+000085a0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+000085b0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+000085c0: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
+000085d0: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+000085e0: 7d20 2d2d 6465 7461 6368 2d73 6574 7570  } --detach-setup
+000085f0: 2065 7861 6d70 6c65 732f 656e 765f 6368   examples/env_ch
+00008600: 6563 6b2e 7961 6d6c 272c 0a20 2020 2020  eck.yaml',.     
+00008610: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00008620: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+00008630: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+00008640: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+00008650: 642e 0a20 2020 2020 2020 205d 2c0a 2020  d..        ],.  
+00008660: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00008670: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00008680: 2020 2020 2074 696d 656f 7574 3d74 6f74       timeout=tot
+00008690: 616c 5f74 696d 656f 7574 5f6d 696e 7574  al_timeout_minut
+000086a0: 6573 202a 2036 302c 0a20 2020 2029 0a20  es * 60,.    ). 
+000086b0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+000086c0: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+000086d0: 2d2d 2d2d 2066 696c 655f 6d6f 756e 7473  ---- file_mounts
+000086e0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
+000086f0: 6573 742e 6d61 726b 2e6e 6f5f 7363 7020  est.mark.no_scp 
+00008700: 2023 2053 4350 2064 6f65 7320 6e6f 7420   # SCP does not 
+00008710: 7375 7070 6f72 7420 6e75 6d5f 6e6f 6465  support num_node
+00008720: 7320 3e20 3120 7965 742e 2052 756e 2074  s > 1 yet. Run t
+00008730: 6573 745f 7363 705f 6669 6c65 5f6d 6f75  est_scp_file_mou
+00008740: 6e74 7320 696e 7374 6561 642e 0a64 6566  nts instead..def
+00008750: 2074 6573 745f 6669 6c65 5f6d 6f75 6e74   test_file_mount
+00008760: 7328 6765 6e65 7269 635f 636c 6f75 643a  s(generic_cloud:
+00008770: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
+00008780: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00008790: 616d 6528 290a 2020 2020 6578 7472 615f  ame().    extra_
+000087a0: 666c 6167 7320 3d20 2727 0a20 2020 2069  flags = ''.    i
+000087b0: 6620 6765 6e65 7269 635f 636c 6f75 6420  f generic_cloud 
+000087c0: 696e 2027 6b75 6265 726e 6574 6573 273a  in 'kubernetes':
+000087d0: 0a20 2020 2020 2020 2023 204b 7562 6572  .        # Kuber
+000087e0: 6e65 7465 7320 646f 6573 206e 6f74 2073  netes does not s
+000087f0: 7570 706f 7274 206d 756c 7469 2d6e 6f64  upport multi-nod
+00008800: 650a 2020 2020 2020 2020 2320 4e4f 5445  e.        # NOTE
+00008810: 3a20 5468 6973 2074 6573 7420 7769 6c6c  : This test will
+00008820: 2066 6169 6c20 6966 2079 6f75 2068 6176   fail if you hav
+00008830: 6520 6120 4b75 6265 726e 6574 6573 2063  e a Kubernetes c
+00008840: 6c75 7374 6572 2072 756e 6e69 6e67 206f  luster running o
+00008850: 6e0a 2020 2020 2020 2020 2320 2061 726d  n.        #  arm
+00008860: 3634 2028 652e 672e 2c20 4170 706c 6520  64 (e.g., Apple 
+00008870: 5369 6c69 636f 6e29 2073 696e 6365 2067  Silicon) since g
+00008880: 6f6f 6679 7320 646f 6573 206e 6f74 2077  oofys does not w
+00008890: 6f72 6b20 6f6e 2061 726d 3634 2e0a 2020  ork on arm64..  
+000088a0: 2020 2020 2020 6578 7472 615f 666c 6167        extra_flag
+000088b0: 7320 3d20 272d 2d6e 756d 2d6e 6f64 6573  s = '--num-nodes
+000088c0: 2031 270a 2020 2020 7465 7374 5f63 6f6d   1'.    test_com
+000088d0: 6d61 6e64 7320 3d20 5b0a 2020 2020 2020  mands = [.      
+000088e0: 2020 2a73 746f 7261 6765 5f73 6574 7570    *storage_setup
+000088f0: 5f63 6f6d 6d61 6e64 732c 0a20 2020 2020  _commands,.     
+00008900: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00008910: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
+00008920: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+00008930: 6f75 647d 207b 6578 7472 615f 666c 6167  oud} {extra_flag
+00008940: 737d 2065 7861 6d70 6c65 732f 7573 696e  s} examples/usin
+00008950: 675f 6669 6c65 5f6d 6f75 6e74 732e 7961  g_file_mounts.ya
+00008960: 6d6c 272c 0a20 2020 2020 2020 2066 2773  ml',.        f's
+00008970: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+00008980: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+00008990: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+000089a0: 6363 6565 6465 642e 0a20 2020 205d 0a20  cceeded..    ]. 
+000089b0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+000089c0: 2020 2020 2020 2020 2775 7369 6e67 5f66          'using_f
+000089d0: 696c 655f 6d6f 756e 7473 272c 0a20 2020  ile_mounts',.   
+000089e0: 2020 2020 2074 6573 745f 636f 6d6d 616e       test_comman
+000089f0: 6473 2c0a 2020 2020 2020 2020 6627 736b  ds,.        f'sk
+00008a00: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00008a10: 272c 0a20 2020 2020 2020 205f 6765 745f  ',.        _get_
+00008a20: 7469 6d65 6f75 7428 6765 6e65 7269 635f  timeout(generic_
+00008a30: 636c 6f75 642c 2032 3020 2a20 3630 292c  cloud, 20 * 60),
+00008a40: 2020 2320 3230 206d 696e 730a 2020 2020    # 20 mins.    
+00008a50: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00008a60: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+00008a70: 7374 2e6d 6172 6b2e 7363 700a 6465 6620  st.mark.scp.def 
+00008a80: 7465 7374 5f73 6370 5f66 696c 655f 6d6f  test_scp_file_mo
+00008a90: 756e 7473 2829 3a0a 2020 2020 6e61 6d65  unts():.    name
+00008aa0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00008ab0: 6e61 6d65 2829 0a20 2020 2074 6573 745f  name().    test_
+00008ac0: 636f 6d6d 616e 6473 203d 205b 0a20 2020  commands = [.   
+00008ad0: 2020 2020 202a 7374 6f72 6167 655f 7365       *storage_se
+00008ae0: 7475 705f 636f 6d6d 616e 6473 2c0a 2020  tup_commands,.  
+00008af0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00008b00: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
+00008b10: 7b53 4350 5f54 5950 457d 202d 2d6e 756d  {SCP_TYPE} --num
+00008b20: 2d6e 6f64 6573 2031 2065 7861 6d70 6c65  -nodes 1 example
+00008b30: 732f 7573 696e 675f 6669 6c65 5f6d 6f75  s/using_file_mou
+00008b40: 6e74 732e 7961 6d6c 272c 0a20 2020 2020  nts.yaml',.     
+00008b50: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00008b60: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+00008b70: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+00008b80: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+00008b90: 2020 205d 0a20 2020 2074 6573 7420 3d20     ].    test = 
+00008ba0: 5465 7374 280a 2020 2020 2020 2020 2753  Test(.        'S
+00008bb0: 4350 5f75 7369 6e67 5f66 696c 655f 6d6f  CP_using_file_mo
+00008bc0: 756e 7473 272c 0a20 2020 2020 2020 2074  unts',.        t
+00008bd0: 6573 745f 636f 6d6d 616e 6473 2c0a 2020  est_commands,.  
+00008be0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00008bf0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00008c00: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
+00008c10: 2a20 3630 2c20 2023 2032 3020 6d69 6e73  * 60,  # 20 mins
+00008c20: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00008c30: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00008c40: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00008c50: 666c 7569 6473 7461 636b 2020 2320 5265  fluidstack  # Re
+00008c60: 7175 6972 6573 2047 4350 2074 6f20 6265  quires GCP to be
+00008c70: 2065 6e61 626c 6564 0a64 6566 2074 6573   enabled.def tes
+00008c80: 745f 7573 696e 675f 6669 6c65 5f6d 6f75  t_using_file_mou
+00008c90: 6e74 735f 7769 7468 5f65 6e76 5f76 6172  nts_with_env_var
+00008ca0: 7328 6765 6e65 7269 635f 636c 6f75 643a  s(generic_cloud:
+00008cb0: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
+00008cc0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00008cd0: 616d 6528 290a 2020 2020 7374 6f72 6167  ame().    storag
+00008ce0: 655f 6e61 6d65 203d 2054 6573 7453 746f  e_name = TestSto
+00008cf0: 7261 6765 5769 7468 4372 6564 656e 7469  rageWithCredenti
+00008d00: 616c 732e 6765 6e65 7261 7465 5f62 7563  als.generate_buc
+00008d10: 6b65 745f 6e61 6d65 2829 0a20 2020 2074  ket_name().    t
+00008d20: 6573 745f 636f 6d6d 616e 6473 203d 205b  est_commands = [
+00008d30: 0a20 2020 2020 2020 202a 7374 6f72 6167  .        *storag
+00008d40: 655f 7365 7475 705f 636f 6d6d 616e 6473  e_setup_commands
+00008d50: 2c0a 2020 2020 2020 2020 2866 2773 6b79  ,.        (f'sky
+00008d60: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+00008d70: 616d 657d 202d 2d63 7075 7320 322b 202d  ame} --cpus 2+ -
+00008d80: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+00008d90: 636c 6f75 647d 2027 0a20 2020 2020 2020  cloud} '.       
+00008da0: 2020 2765 7861 6d70 6c65 732f 7573 696e    'examples/usin
+00008db0: 675f 6669 6c65 5f6d 6f75 6e74 735f 7769  g_file_mounts_wi
+00008dc0: 7468 5f65 6e76 5f76 6172 732e 7961 6d6c  th_env_vars.yaml
+00008dd0: 2027 0a20 2020 2020 2020 2020 6627 2d2d   '.         f'--
+00008de0: 656e 7620 4d59 5f42 5543 4b45 543d 7b73  env MY_BUCKET={s
+00008df0: 746f 7261 6765 5f6e 616d 657d 2729 2c0a  torage_name}'),.
+00008e00: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00008e10: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+00008e20: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+00008e30: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+00008e40: 6564 2e0a 2020 2020 2020 2020 2320 4f76  ed..        # Ov
+00008e50: 6572 7269 6465 2077 6974 6820 2d2d 656e  erride with --en
+00008e60: 763a 0a20 2020 2020 2020 2028 6627 736b  v:.        (f'sk
+00008e70: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00008e80: 6e61 6d65 7d2d 3220 2d2d 6370 7573 2032  name}-2 --cpus 2
+00008e90: 2b20 2d2d 636c 6f75 6420 7b67 656e 6572  + --cloud {gener
+00008ea0: 6963 5f63 6c6f 7564 7d20 270a 2020 2020  ic_cloud} '.    
+00008eb0: 2020 2020 2027 6578 616d 706c 6573 2f75       'examples/u
+00008ec0: 7369 6e67 5f66 696c 655f 6d6f 756e 7473  sing_file_mounts
+00008ed0: 5f77 6974 685f 656e 765f 7661 7273 2e79  _with_env_vars.y
+00008ee0: 616d 6c20 270a 2020 2020 2020 2020 2066  aml '.         f
+00008ef0: 272d 2d65 6e76 204d 595f 4255 434b 4554  '--env MY_BUCKET
+00008f00: 3d7b 7374 6f72 6167 655f 6e61 6d65 7d20  ={storage_name} 
+00008f10: 270a 2020 2020 2020 2020 2027 2d2d 656e  '.         '--en
+00008f20: 7620 4d59 5f4c 4f43 414c 5f50 4154 483d  v MY_LOCAL_PATH=
+00008f30: 746d 7066 696c 6527 292c 0a20 2020 2020  tmpfile'),.     
+00008f40: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00008f50: 616d 657d 2d32 2031 202d 2d73 7461 7475  ame}-2 1 --statu
+00008f60: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+00008f70: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+00008f80: 0a20 2020 205d 0a20 2020 2074 6573 7420  .    ].    test 
+00008f90: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00008fa0: 2775 7369 6e67 5f66 696c 655f 6d6f 756e  'using_file_moun
+00008fb0: 7473 5f77 6974 685f 656e 765f 7661 7273  ts_with_env_vars
+00008fc0: 272c 0a20 2020 2020 2020 2074 6573 745f  ',.        test_
+00008fd0: 636f 6d6d 616e 6473 2c0a 2020 2020 2020  commands,.      
+00008fe0: 2020 2866 2773 6b79 2064 6f77 6e20 2d79    (f'sky down -y
+00008ff0: 207b 6e61 6d65 7d20 7b6e 616d 657d 2d32   {name} {name}-2
+00009000: 272c 0a20 2020 2020 2020 2020 6627 736b  ',.         f'sk
+00009010: 7920 7374 6f72 6167 6520 6465 6c65 7465  y storage delete
+00009020: 202d 7920 7b73 746f 7261 6765 5f6e 616d   -y {storage_nam
+00009030: 657d 207b 7374 6f72 6167 655f 6e61 6d65  e} {storage_name
+00009040: 7d2d 3227 292c 0a20 2020 2020 2020 2074  }-2'),.        t
+00009050: 696d 656f 7574 3d32 3020 2a20 3630 2c20  imeout=20 * 60, 
+00009060: 2023 2032 3020 6d69 6e73 0a20 2020 2029   # 20 mins.    )
+00009070: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00009080: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+00009090: 2d2d 2d2d 2d2d 2073 746f 7261 6765 202d  ------ storage -
+000090a0: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
+000090b0: 742e 6d61 726b 2e61 7773 0a64 6566 2074  t.mark.aws.def t
+000090c0: 6573 745f 6177 735f 7374 6f72 6167 655f  est_aws_storage_
+000090d0: 6d6f 756e 7473 5f77 6974 685f 7374 6f70  mounts_with_stop
+000090e0: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
+000090f0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+00009100: 2829 0a20 2020 2073 746f 7261 6765 5f6e  ().    storage_n
+00009110: 616d 6520 3d20 6627 736b 792d 7465 7374  ame = f'sky-test
+00009120: 2d7b 696e 7428 7469 6d65 2e74 696d 6528  -{int(time.time(
+00009130: 2929 7d27 0a20 2020 2074 656d 706c 6174  ))}'.    templat
+00009140: 655f 7374 7220 3d20 7061 7468 6c69 622e  e_str = pathlib.
+00009150: 5061 7468 280a 2020 2020 2020 2020 2774  Path(.        't
+00009160: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+00009170: 7465 7374 5f73 746f 7261 6765 5f6d 6f75  test_storage_mou
+00009180: 6e74 696e 672e 7961 6d6c 2e6a 3227 292e  nting.yaml.j2').
+00009190: 7265 6164 5f74 6578 7428 290a 2020 2020  read_text().    
+000091a0: 7465 6d70 6c61 7465 203d 206a 696e 6a61  template = jinja
+000091b0: 322e 5465 6d70 6c61 7465 2874 656d 706c  2.Template(templ
+000091c0: 6174 655f 7374 7229 0a20 2020 2063 6f6e  ate_str).    con
+000091d0: 7465 6e74 203d 2074 656d 706c 6174 652e  tent = template.
+000091e0: 7265 6e64 6572 2873 746f 7261 6765 5f6e  render(storage_n
+000091f0: 616d 653d 7374 6f72 6167 655f 6e61 6d65  ame=storage_name
+00009200: 290a 2020 2020 7769 7468 2074 656d 7066  ).    with tempf
+00009210: 696c 652e 4e61 6d65 6454 656d 706f 7261  ile.NamedTempora
+00009220: 7279 4669 6c65 2873 7566 6669 783d 272e  ryFile(suffix='.
+00009230: 7961 6d6c 272c 206d 6f64 653d 2777 2729  yaml', mode='w')
+00009240: 2061 7320 663a 0a20 2020 2020 2020 2066   as f:.        f
+00009250: 2e77 7269 7465 2863 6f6e 7465 6e74 290a  .write(content).
+00009260: 2020 2020 2020 2020 662e 666c 7573 6828          f.flush(
+00009270: 290a 2020 2020 2020 2020 6669 6c65 5f70  ).        file_p
+00009280: 6174 6820 3d20 662e 6e61 6d65 0a20 2020  ath = f.name.   
+00009290: 2020 2020 2074 6573 745f 636f 6d6d 616e       test_comman
+000092a0: 6473 203d 205b 0a20 2020 2020 2020 2020  ds = [.         
+000092b0: 2020 202a 7374 6f72 6167 655f 7365 7475     *storage_setu
+000092c0: 705f 636f 6d6d 616e 6473 2c0a 2020 2020  p_commands,.    
+000092d0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+000092e0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+000092f0: 7d20 2d2d 636c 6f75 6420 6177 7320 7b66  } --cloud aws {f
+00009300: 696c 655f 7061 7468 7d27 2c0a 2020 2020  ile_path}',.    
+00009310: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00009320: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+00009330: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+00009340: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+00009350: 2020 2020 2020 2020 2020 2020 6627 6177              f'aw
+00009360: 7320 7333 206c 7320 7b73 746f 7261 6765  s s3 ls {storage
+00009370: 5f6e 616d 657d 2f68 656c 6c6f 2e74 7874  _name}/hello.txt
+00009380: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00009390: 2773 6b79 2073 746f 7020 2d79 207b 6e61  'sky stop -y {na
+000093a0: 6d65 7d27 2c0a 2020 2020 2020 2020 2020  me}',.          
+000093b0: 2020 6627 736b 7920 7374 6172 7420 2d79    f'sky start -y
+000093c0: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
+000093d0: 2020 2020 2020 2320 4368 6563 6b20 6966        # Check if
+000093e0: 2068 656c 6c6f 2e74 7874 2066 726f 6d20   hello.txt from 
+000093f0: 6d6f 756e 7469 6e67 2062 7563 6b65 7420  mounting bucket 
+00009400: 6578 6973 7473 2061 6674 6572 2072 6573  exists after res
+00009410: 7461 7274 2069 6e0a 2020 2020 2020 2020  tart in.        
+00009420: 2020 2020 2320 7468 6520 6d6f 756e 7465      # the mounte
+00009430: 6420 6469 7265 6374 6f72 790a 2020 2020  d directory.    
+00009440: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00009450: 6563 207b 6e61 6d65 7d20 2d2d 2022 7365  ec {name} -- "se
+00009460: 7420 2d65 783b 206c 7320 2f6d 6f75 6e74  t -ex; ls /mount
+00009470: 5f70 7269 7661 7465 5f6d 6f75 6e74 2f68  _private_mount/h
+00009480: 656c 6c6f 2e74 7874 2227 0a20 2020 2020  ello.txt"'.     
+00009490: 2020 205d 0a20 2020 2020 2020 2074 6573     ].        tes
+000094a0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+000094b0: 2020 2020 2020 2761 7773 5f73 746f 7261        'aws_stora
+000094c0: 6765 5f6d 6f75 6e74 7327 2c0a 2020 2020  ge_mounts',.    
+000094d0: 2020 2020 2020 2020 7465 7374 5f63 6f6d          test_com
+000094e0: 6d61 6e64 732c 0a20 2020 2020 2020 2020  mands,.         
+000094f0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+00009500: 207b 6e61 6d65 7d3b 2073 6b79 2073 746f   {name}; sky sto
+00009510: 7261 6765 2064 656c 6574 6520 2d79 207b  rage delete -y {
+00009520: 7374 6f72 6167 655f 6e61 6d65 7d27 2c0a  storage_name}',.
+00009530: 2020 2020 2020 2020 2020 2020 7469 6d65              time
+00009540: 6f75 743d 3230 202a 2036 302c 2020 2320  out=20 * 60,  # 
+00009550: 3230 206d 696e 730a 2020 2020 2020 2020  20 mins.        
+00009560: 290a 2020 2020 2020 2020 7275 6e5f 6f6e  ).        run_on
+00009570: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+00009580: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
+00009590: 6465 6620 7465 7374 5f67 6370 5f73 746f  def test_gcp_sto
+000095a0: 7261 6765 5f6d 6f75 6e74 735f 7769 7468  rage_mounts_with
+000095b0: 5f73 746f 7028 293a 0a20 2020 206e 616d  _stop():.    nam
+000095c0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+000095d0: 5f6e 616d 6528 290a 2020 2020 7374 6f72  _name().    stor
+000095e0: 6167 655f 6e61 6d65 203d 2066 2773 6b79  age_name = f'sky
+000095f0: 2d74 6573 742d 7b69 6e74 2874 696d 652e  -test-{int(time.
+00009600: 7469 6d65 2829 297d 270a 2020 2020 7465  time())}'.    te
+00009610: 6d70 6c61 7465 5f73 7472 203d 2070 6174  mplate_str = pat
+00009620: 686c 6962 2e50 6174 6828 0a20 2020 2020  hlib.Path(.     
+00009630: 2020 2027 7465 7374 732f 7465 7374 5f79     'tests/test_y
+00009640: 616d 6c73 2f74 6573 745f 7374 6f72 6167  amls/test_storag
+00009650: 655f 6d6f 756e 7469 6e67 2e79 616d 6c2e  e_mounting.yaml.
+00009660: 6a32 2729 2e72 6561 645f 7465 7874 2829  j2').read_text()
+00009670: 0a20 2020 2074 656d 706c 6174 6520 3d20  .    template = 
+00009680: 6a69 6e6a 6132 2e54 656d 706c 6174 6528  jinja2.Template(
+00009690: 7465 6d70 6c61 7465 5f73 7472 290a 2020  template_str).  
+000096a0: 2020 636f 6e74 656e 7420 3d20 7465 6d70    content = temp
+000096b0: 6c61 7465 2e72 656e 6465 7228 7374 6f72  late.render(stor
+000096c0: 6167 655f 6e61 6d65 3d73 746f 7261 6765  age_name=storage
+000096d0: 5f6e 616d 6529 0a20 2020 2077 6974 6820  _name).    with 
+000096e0: 7465 6d70 6669 6c65 2e4e 616d 6564 5465  tempfile.NamedTe
+000096f0: 6d70 6f72 6172 7946 696c 6528 7375 6666  mporaryFile(suff
+00009700: 6978 3d27 2e79 616d 6c27 2c20 6d6f 6465  ix='.yaml', mode
+00009710: 3d27 7727 2920 6173 2066 3a0a 2020 2020  ='w') as f:.    
+00009720: 2020 2020 662e 7772 6974 6528 636f 6e74      f.write(cont
+00009730: 656e 7429 0a20 2020 2020 2020 2066 2e66  ent).        f.f
+00009740: 6c75 7368 2829 0a20 2020 2020 2020 2066  lush().        f
+00009750: 696c 655f 7061 7468 203d 2066 2e6e 616d  ile_path = f.nam
+00009760: 650a 2020 2020 2020 2020 7465 7374 5f63  e.        test_c
+00009770: 6f6d 6d61 6e64 7320 3d20 5b0a 2020 2020  ommands = [.    
+00009780: 2020 2020 2020 2020 2a73 746f 7261 6765          *storage
+00009790: 5f73 6574 7570 5f63 6f6d 6d61 6e64 732c  _setup_commands,
+000097a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000097b0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+000097c0: 7b6e 616d 657d 202d 2d63 6c6f 7564 2067  {name} --cloud g
+000097d0: 6370 207b 6669 6c65 5f70 6174 687d 272c  cp {file_path}',
+000097e0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000097f0: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+00009800: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+00009810: 6e73 7572 6520 6a6f 6220 7375 6363 6565  nsure job succee
+00009820: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
+00009830: 2066 2767 7375 7469 6c20 6c73 2067 733a   f'gsutil ls gs:
+00009840: 2f2f 7b73 746f 7261 6765 5f6e 616d 657d  //{storage_name}
+00009850: 2f68 656c 6c6f 2e74 7874 272c 0a20 2020  /hello.txt',.   
+00009860: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00009870: 746f 7020 2d79 207b 6e61 6d65 7d27 2c0a  top -y {name}',.
+00009880: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00009890: 7920 7374 6172 7420 2d79 207b 6e61 6d65  y start -y {name
+000098a0: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+000098b0: 2320 4368 6563 6b20 6966 2068 656c 6c6f  # Check if hello
+000098c0: 2e74 7874 2066 726f 6d20 6d6f 756e 7469  .txt from mounti
+000098d0: 6e67 2062 7563 6b65 7420 6578 6973 7473  ng bucket exists
+000098e0: 2061 6674 6572 2072 6573 7461 7274 2069   after restart i
+000098f0: 6e0a 2020 2020 2020 2020 2020 2020 2320  n.            # 
+00009900: 7468 6520 6d6f 756e 7465 6420 6469 7265  the mounted dire
+00009910: 6374 6f72 790a 2020 2020 2020 2020 2020  ctory.          
+00009920: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+00009930: 6d65 7d20 2d2d 2022 7365 7420 2d65 783b  me} -- "set -ex;
+00009940: 206c 7320 2f6d 6f75 6e74 5f70 7269 7661   ls /mount_priva
+00009950: 7465 5f6d 6f75 6e74 2f68 656c 6c6f 2e74  te_mount/hello.t
+00009960: 7874 2227 0a20 2020 2020 2020 205d 0a20  xt"'.        ]. 
+00009970: 2020 2020 2020 2074 6573 7420 3d20 5465         test = Te
+00009980: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
+00009990: 2767 6370 5f73 746f 7261 6765 5f6d 6f75  'gcp_storage_mou
+000099a0: 6e74 7327 2c0a 2020 2020 2020 2020 2020  nts',.          
+000099b0: 2020 7465 7374 5f63 6f6d 6d61 6e64 732c    test_commands,
+000099c0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000099d0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+000099e0: 7d3b 2073 6b79 2073 746f 7261 6765 2064  }; sky storage d
+000099f0: 656c 6574 6520 2d79 207b 7374 6f72 6167  elete -y {storag
+00009a00: 655f 6e61 6d65 7d27 2c0a 2020 2020 2020  e_name}',.      
+00009a10: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
+00009a20: 202a 2036 302c 2020 2320 3230 206d 696e   * 60,  # 20 min
+00009a30: 730a 2020 2020 2020 2020 290a 2020 2020  s.        ).    
+00009a40: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00009a50: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00009a60: 2e6d 6172 6b2e 6b75 6265 726e 6574 6573  .mark.kubernetes
+00009a70: 0a64 6566 2074 6573 745f 6b75 6265 726e  .def test_kubern
+00009a80: 6574 6573 5f73 746f 7261 6765 5f6d 6f75  etes_storage_mou
+00009a90: 6e74 7328 293a 0a20 2020 2023 2054 6573  nts():.    # Tes
+00009aa0: 7473 2062 7563 6b65 7420 6d6f 756e 7469  ts bucket mounti
+00009ab0: 6e67 206f 6e20 6b38 732c 2061 7373 756d  ng on k8s, assum
+00009ac0: 696e 6720 5333 2069 7320 636f 6e66 6967  ing S3 is config
+00009ad0: 7572 6564 2e0a 2020 2020 2320 5468 6973  ured..    # This
+00009ae0: 2074 6573 7420 7769 6c6c 2066 6169 6c20   test will fail 
+00009af0: 6966 2072 756e 206f 6e20 6e6f 6e20 7838  if run on non x8
+00009b00: 365f 3634 2061 7263 6869 7465 6374 7572  6_64 architectur
+00009b10: 652c 2073 696e 6365 2067 6f6f 6679 7320  e, since goofys 
+00009b20: 6973 0a20 2020 2023 2062 7569 6c74 2066  is.    # built f
+00009b30: 6f72 2078 3836 5f36 3420 6f6e 6c79 2e0a  or x86_64 only..
+00009b40: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00009b50: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00009b60: 2020 2073 746f 7261 6765 5f6e 616d 6520     storage_name 
+00009b70: 3d20 6627 736b 792d 7465 7374 2d7b 696e  = f'sky-test-{in
+00009b80: 7428 7469 6d65 2e74 696d 6528 2929 7d27  t(time.time())}'
+00009b90: 0a20 2020 2074 656d 706c 6174 655f 7374  .    template_st
+00009ba0: 7220 3d20 7061 7468 6c69 622e 5061 7468  r = pathlib.Path
+00009bb0: 280a 2020 2020 2020 2020 2774 6573 7473  (.        'tests
+00009bc0: 2f74 6573 745f 7961 6d6c 732f 7465 7374  /test_yamls/test
+00009bd0: 5f73 746f 7261 6765 5f6d 6f75 6e74 696e  _storage_mountin
+00009be0: 672e 7961 6d6c 2e6a 3227 292e 7265 6164  g.yaml.j2').read
+00009bf0: 5f74 6578 7428 290a 2020 2020 7465 6d70  _text().    temp
+00009c00: 6c61 7465 203d 206a 696e 6a61 322e 5465  late = jinja2.Te
+00009c10: 6d70 6c61 7465 2874 656d 706c 6174 655f  mplate(template_
+00009c20: 7374 7229 0a20 2020 2063 6f6e 7465 6e74  str).    content
+00009c30: 203d 2074 656d 706c 6174 652e 7265 6e64   = template.rend
+00009c40: 6572 2873 746f 7261 6765 5f6e 616d 653d  er(storage_name=
+00009c50: 7374 6f72 6167 655f 6e61 6d65 290a 2020  storage_name).  
+00009c60: 2020 7769 7468 2074 656d 7066 696c 652e    with tempfile.
+00009c70: 4e61 6d65 6454 656d 706f 7261 7279 4669  NamedTemporaryFi
+00009c80: 6c65 2873 7566 6669 783d 272e 7961 6d6c  le(suffix='.yaml
+00009c90: 272c 206d 6f64 653d 2777 2729 2061 7320  ', mode='w') as 
+00009ca0: 663a 0a20 2020 2020 2020 2066 2e77 7269  f:.        f.wri
+00009cb0: 7465 2863 6f6e 7465 6e74 290a 2020 2020  te(content).    
+00009cc0: 2020 2020 662e 666c 7573 6828 290a 2020      f.flush().  
+00009cd0: 2020 2020 2020 6669 6c65 5f70 6174 6820        file_path 
+00009ce0: 3d20 662e 6e61 6d65 0a20 2020 2020 2020  = f.name.       
+00009cf0: 2074 6573 745f 636f 6d6d 616e 6473 203d   test_commands =
+00009d00: 205b 0a20 2020 2020 2020 2020 2020 202a   [.            *
+00009d10: 7374 6f72 6167 655f 7365 7475 705f 636f  storage_setup_co
+00009d20: 6d6d 616e 6473 2c0a 2020 2020 2020 2020  mmands,.        
+00009d30: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00009d40: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+00009d50: 636c 6f75 6420 6b75 6265 726e 6574 6573  cloud kubernetes
+00009d60: 207b 6669 6c65 5f70 6174 687d 272c 0a20   {file_path}',. 
+00009d70: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00009d80: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+00009d90: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+00009da0: 7572 6520 6a6f 6220 7375 6363 6565 6465  ure job succeede
+00009db0: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
+00009dc0: 2761 7773 2073 3320 6c73 207b 7374 6f72  'aws s3 ls {stor
+00009dd0: 6167 655f 6e61 6d65 7d2f 6865 6c6c 6f2e  age_name}/hello.
+00009de0: 7478 7420 7c7c 2027 0a20 2020 2020 2020  txt || '.       
+00009df0: 2020 2020 2066 2767 7375 7469 6c20 6c73       f'gsutil ls
+00009e00: 2067 733a 2f2f 7b73 746f 7261 6765 5f6e   gs://{storage_n
+00009e10: 616d 657d 2f68 656c 6c6f 2e74 7874 272c  ame}/hello.txt',
+00009e20: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
+00009e30: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00009e40: 2020 2020 2020 2020 2020 2020 276b 7562              'kub
+00009e50: 6572 6e65 7465 735f 7374 6f72 6167 655f  ernetes_storage_
+00009e60: 6d6f 756e 7473 272c 0a20 2020 2020 2020  mounts',.       
+00009e70: 2020 2020 2074 6573 745f 636f 6d6d 616e       test_comman
+00009e80: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
+00009e90: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+00009ea0: 616d 657d 3b20 736b 7920 7374 6f72 6167  ame}; sky storag
+00009eb0: 6520 6465 6c65 7465 202d 7920 7b73 746f  e delete -y {sto
+00009ec0: 7261 6765 5f6e 616d 657d 272c 0a20 2020  rage_name}',.   
+00009ed0: 2020 2020 2020 2020 2074 696d 656f 7574           timeout
+00009ee0: 3d32 3020 2a20 3630 2c20 2023 2032 3020  =20 * 60,  # 20 
+00009ef0: 6d69 6e73 0a20 2020 2020 2020 2029 0a20  mins.        ). 
+00009f00: 2020 2020 2020 2072 756e 5f6f 6e65 5f74         run_one_t
+00009f10: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+00009f20: 6573 742e 6d61 726b 2e70 6172 616d 6574  est.mark.paramet
+00009f30: 7269 7a65 280a 2020 2020 2769 6d61 6765  rize(.    'image
+00009f40: 5f69 6427 2c0a 2020 2020 5b0a 2020 2020  _id',.    [.    
+00009f50: 2020 2020 2764 6f63 6b65 723a 6e76 6964      'docker:nvid
+00009f60: 6961 2f63 7564 613a 3131 2e38 2e30 2d64  ia/cuda:11.8.0-d
+00009f70: 6576 656c 2d75 6275 6e74 7531 382e 3034  evel-ubuntu18.04
+00009f80: 272c 0a20 2020 2020 2020 2027 646f 636b  ',.        'dock
+00009f90: 6572 3a75 6275 6e74 753a 3138 2e30 3427  er:ubuntu:18.04'
+00009fa0: 2c0a 2020 2020 2020 2020 2320 5465 7374  ,.        # Test
+00009fb0: 206c 6174 6573 7420 696d 6167 6520 7769   latest image wi
+00009fc0: 7468 2070 7974 686f 6e20 332e 3131 2069  th python 3.11 i
+00009fd0: 6e73 7461 6c6c 6564 2062 7920 6465 6661  nstalled by defa
+00009fe0: 756c 742e 0a20 2020 2020 2020 2023 2044  ult..        # D
+00009ff0: 6f65 7320 6e6f 7420 776f 726b 2066 6f72  oes not work for
+0000a000: 2070 7974 686f 6e20 332e 3132 2064 7565   python 3.12 due
+0000a010: 2074 6f20 7261 7927 7320 7265 7175 6972   to ray's requir
+0000a020: 656d 656e 7420 666f 7220 332e 3131 2e0a  ement for 3.11..
+0000a030: 2020 2020 2020 2020 2764 6f63 6b65 723a          'docker:
+0000a040: 636f 6e74 696e 7575 6d69 6f2f 6d69 6e69  continuumio/mini
+0000a050: 636f 6e64 6133 3a32 342e 312e 322d 3027  conda3:24.1.2-0'
+0000a060: 2c0a 2020 2020 5d29 0a64 6566 2074 6573  ,.    ]).def tes
+0000a070: 745f 646f 636b 6572 5f73 746f 7261 6765  t_docker_storage
+0000a080: 5f6d 6f75 6e74 7328 6765 6e65 7269 635f  _mounts(generic_
+0000a090: 636c 6f75 643a 2073 7472 2c20 696d 6167  cloud: str, imag
+0000a0a0: 655f 6964 3a20 7374 7229 3a0a 2020 2020  e_id: str):.    
+0000a0b0: 2320 5465 7374 7320 6275 636b 6574 206d  # Tests bucket m
+0000a0c0: 6f75 6e74 696e 6720 6f6e 2064 6f63 6b65  ounting on docke
+0000a0d0: 7220 636f 6e74 6169 6e65 720a 2020 2020  r container.    
+0000a0e0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+0000a0f0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+0000a100: 696d 6573 7461 6d70 203d 2073 7472 2874  imestamp = str(t
+0000a110: 696d 652e 7469 6d65 2829 292e 7265 706c  ime.time()).repl
+0000a120: 6163 6528 272e 272c 2027 2729 0a20 2020  ace('.', '').   
+0000a130: 2073 746f 7261 6765 5f6e 616d 6520 3d20   storage_name = 
+0000a140: 6627 736b 792d 7465 7374 2d7b 7469 6d65  f'sky-test-{time
+0000a150: 7374 616d 707d 270a 2020 2020 7465 6d70  stamp}'.    temp
+0000a160: 6c61 7465 5f73 7472 203d 2070 6174 686c  late_str = pathl
+0000a170: 6962 2e50 6174 6828 0a20 2020 2020 2020  ib.Path(.       
+0000a180: 2027 7465 7374 732f 7465 7374 5f79 616d   'tests/test_yam
+0000a190: 6c73 2f74 6573 745f 7374 6f72 6167 655f  ls/test_storage_
+0000a1a0: 6d6f 756e 7469 6e67 2e79 616d 6c2e 6a32  mounting.yaml.j2
+0000a1b0: 2729 2e72 6561 645f 7465 7874 2829 0a20  ').read_text(). 
+0000a1c0: 2020 2074 656d 706c 6174 6520 3d20 6a69     template = ji
+0000a1d0: 6e6a 6132 2e54 656d 706c 6174 6528 7465  nja2.Template(te
+0000a1e0: 6d70 6c61 7465 5f73 7472 290a 2020 2020  mplate_str).    
+0000a1f0: 636f 6e74 656e 7420 3d20 7465 6d70 6c61  content = templa
+0000a200: 7465 2e72 656e 6465 7228 7374 6f72 6167  te.render(storag
+0000a210: 655f 6e61 6d65 3d73 746f 7261 6765 5f6e  e_name=storage_n
+0000a220: 616d 6529 0a20 2020 2077 6974 6820 7465  ame).    with te
+0000a230: 6d70 6669 6c65 2e4e 616d 6564 5465 6d70  mpfile.NamedTemp
+0000a240: 6f72 6172 7946 696c 6528 7375 6666 6978  oraryFile(suffix
+0000a250: 3d27 2e79 616d 6c27 2c20 6d6f 6465 3d27  ='.yaml', mode='
+0000a260: 7727 2920 6173 2066 3a0a 2020 2020 2020  w') as f:.      
+0000a270: 2020 662e 7772 6974 6528 636f 6e74 656e    f.write(conten
+0000a280: 7429 0a20 2020 2020 2020 2066 2e66 6c75  t).        f.flu
+0000a290: 7368 2829 0a20 2020 2020 2020 2066 696c  sh().        fil
+0000a2a0: 655f 7061 7468 203d 2066 2e6e 616d 650a  e_path = f.name.
+0000a2b0: 2020 2020 2020 2020 7465 7374 5f63 6f6d          test_com
+0000a2c0: 6d61 6e64 7320 3d20 5b0a 2020 2020 2020  mands = [.      
+0000a2d0: 2020 2020 2020 2a73 746f 7261 6765 5f73        *storage_s
+0000a2e0: 6574 7570 5f63 6f6d 6d61 6e64 732c 0a20  etup_commands,. 
+0000a2f0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000a300: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+0000a310: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
+0000a320: 6e65 7269 635f 636c 6f75 647d 202d 2d69  neric_cloud} --i
+0000a330: 6d61 6765 2d69 6420 7b69 6d61 6765 5f69  mage-id {image_i
+0000a340: 647d 207b 6669 6c65 5f70 6174 687d 272c  d} {file_path}',
+0000a350: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000a360: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+0000a370: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+0000a380: 6e73 7572 6520 6a6f 6220 7375 6363 6565  nsure job succee
+0000a390: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
+0000a3a0: 2066 2761 7773 2073 3320 6c73 207b 7374   f'aws s3 ls {st
+0000a3b0: 6f72 6167 655f 6e61 6d65 7d2f 6865 6c6c  orage_name}/hell
+0000a3c0: 6f2e 7478 7420 7c7c 2027 0a20 2020 2020  o.txt || '.     
+0000a3d0: 2020 2020 2020 2066 2767 7375 7469 6c20         f'gsutil 
+0000a3e0: 6c73 2067 733a 2f2f 7b73 746f 7261 6765  ls gs://{storage
+0000a3f0: 5f6e 616d 657d 2f68 656c 6c6f 2e74 7874  _name}/hello.txt
+0000a400: 272c 0a20 2020 2020 2020 205d 0a20 2020  ',.        ].   
+0000a410: 2020 2020 2074 6573 7420 3d20 5465 7374       test = Test
+0000a420: 280a 2020 2020 2020 2020 2020 2020 2764  (.            'd
+0000a430: 6f63 6b65 725f 7374 6f72 6167 655f 6d6f  ocker_storage_mo
+0000a440: 756e 7473 272c 0a20 2020 2020 2020 2020  unts',.         
+0000a450: 2020 2074 6573 745f 636f 6d6d 616e 6473     test_commands
+0000a460: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000a470: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+0000a480: 657d 3b20 736b 7920 7374 6f72 6167 6520  e}; sky storage 
+0000a490: 6465 6c65 7465 202d 7920 7b73 746f 7261  delete -y {stora
+0000a4a0: 6765 5f6e 616d 657d 272c 0a20 2020 2020  ge_name}',.     
+0000a4b0: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+0000a4c0: 3020 2a20 3630 2c20 2023 2032 3020 6d69  0 * 60,  # 20 mi
+0000a4d0: 6e73 0a20 2020 2020 2020 2029 0a20 2020  ns.        ).   
+0000a4e0: 2020 2020 2072 756e 5f6f 6e65 5f74 6573       run_one_tes
+0000a4f0: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+0000a500: 742e 6d61 726b 2e63 6c6f 7564 666c 6172  t.mark.cloudflar
+0000a510: 650a 6465 6620 7465 7374 5f63 6c6f 7564  e.def test_cloud
+0000a520: 666c 6172 655f 7374 6f72 6167 655f 6d6f  flare_storage_mo
+0000a530: 756e 7473 2867 656e 6572 6963 5f63 6c6f  unts(generic_clo
+0000a540: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
+0000a550: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+0000a560: 725f 6e61 6d65 2829 0a20 2020 2073 746f  r_name().    sto
+0000a570: 7261 6765 5f6e 616d 6520 3d20 6627 736b  rage_name = f'sk
+0000a580: 792d 7465 7374 2d7b 696e 7428 7469 6d65  y-test-{int(time
+0000a590: 2e74 696d 6528 2929 7d27 0a20 2020 2074  .time())}'.    t
+0000a5a0: 656d 706c 6174 655f 7374 7220 3d20 7061  emplate_str = pa
+0000a5b0: 7468 6c69 622e 5061 7468 280a 2020 2020  thlib.Path(.    
+0000a5c0: 2020 2020 2774 6573 7473 2f74 6573 745f      'tests/test_
+0000a5d0: 7961 6d6c 732f 7465 7374 5f72 325f 7374  yamls/test_r2_st
+0000a5e0: 6f72 6167 655f 6d6f 756e 7469 6e67 2e79  orage_mounting.y
+0000a5f0: 616d 6c27 292e 7265 6164 5f74 6578 7428  aml').read_text(
+0000a600: 290a 2020 2020 7465 6d70 6c61 7465 203d  ).    template =
+0000a610: 206a 696e 6a61 322e 5465 6d70 6c61 7465   jinja2.Template
+0000a620: 2874 656d 706c 6174 655f 7374 7229 0a20  (template_str). 
+0000a630: 2020 2063 6f6e 7465 6e74 203d 2074 656d     content = tem
+0000a640: 706c 6174 652e 7265 6e64 6572 2873 746f  plate.render(sto
+0000a650: 7261 6765 5f6e 616d 653d 7374 6f72 6167  rage_name=storag
+0000a660: 655f 6e61 6d65 290a 2020 2020 656e 6470  e_name).    endp
+0000a670: 6f69 6e74 5f75 726c 203d 2063 6c6f 7564  oint_url = cloud
+0000a680: 666c 6172 652e 6372 6561 7465 5f65 6e64  flare.create_end
+0000a690: 706f 696e 7428 290a 2020 2020 7769 7468  point().    with
+0000a6a0: 2074 656d 7066 696c 652e 4e61 6d65 6454   tempfile.NamedT
+0000a6b0: 656d 706f 7261 7279 4669 6c65 2873 7566  emporaryFile(suf
+0000a6c0: 6669 783d 272e 7961 6d6c 272c 206d 6f64  fix='.yaml', mod
+0000a6d0: 653d 2777 2729 2061 7320 663a 0a20 2020  e='w') as f:.   
+0000a6e0: 2020 2020 2066 2e77 7269 7465 2863 6f6e       f.write(con
+0000a6f0: 7465 6e74 290a 2020 2020 2020 2020 662e  tent).        f.
+0000a700: 666c 7573 6828 290a 2020 2020 2020 2020  flush().        
+0000a710: 6669 6c65 5f70 6174 6820 3d20 662e 6e61  file_path = f.na
+0000a720: 6d65 0a20 2020 2020 2020 2074 6573 745f  me.        test_
+0000a730: 636f 6d6d 616e 6473 203d 205b 0a20 2020  commands = [.   
+0000a740: 2020 2020 2020 2020 202a 7374 6f72 6167           *storag
+0000a750: 655f 7365 7475 705f 636f 6d6d 616e 6473  e_setup_commands
+0000a760: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000a770: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+0000a780: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+0000a790: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+0000a7a0: 7b66 696c 655f 7061 7468 7d27 2c0a 2020  {file_path}',.  
+0000a7b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000a7c0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+0000a7d0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+0000a7e0: 7265 206a 6f62 2073 7563 6365 6564 6564  re job succeeded
+0000a7f0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+0000a800: 4157 535f 5348 4152 4544 5f43 5245 4445  AWS_SHARED_CREDE
+0000a810: 4e54 4941 4c53 5f46 494c 453d 7b63 6c6f  NTIALS_FILE={clo
+0000a820: 7564 666c 6172 652e 5232 5f43 5245 4445  udflare.R2_CREDE
+0000a830: 4e54 4941 4c53 5f50 4154 487d 2061 7773  NTIALS_PATH} aws
+0000a840: 2073 3320 6c73 2073 333a 2f2f 7b73 746f   s3 ls s3://{sto
+0000a850: 7261 6765 5f6e 616d 657d 2f68 656c 6c6f  rage_name}/hello
+0000a860: 2e74 7874 202d 2d65 6e64 706f 696e 7420  .txt --endpoint 
+0000a870: 7b65 6e64 706f 696e 745f 7572 6c7d 202d  {endpoint_url} -
+0000a880: 2d70 726f 6669 6c65 3d72 3227 0a20 2020  -profile=r2'.   
+0000a890: 2020 2020 205d 0a0a 2020 2020 2020 2020       ]..        
+0000a8a0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+0000a8b0: 2020 2020 2020 2020 2027 636c 6f75 6466           'cloudf
+0000a8c0: 6c61 7265 5f73 746f 7261 6765 5f6d 6f75  lare_storage_mou
+0000a8d0: 6e74 7327 2c0a 2020 2020 2020 2020 2020  nts',.          
+0000a8e0: 2020 7465 7374 5f63 6f6d 6d61 6e64 732c    test_commands,
+0000a8f0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000a900: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+0000a910: 7d3b 2073 6b79 2073 746f 7261 6765 2064  }; sky storage d
+0000a920: 656c 6574 6520 2d79 207b 7374 6f72 6167  elete -y {storag
+0000a930: 655f 6e61 6d65 7d27 2c0a 2020 2020 2020  e_name}',.      
+0000a940: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
+0000a950: 202a 2036 302c 2020 2320 3230 206d 696e   * 60,  # 20 min
+0000a960: 730a 2020 2020 2020 2020 290a 2020 2020  s.        ).    
+0000a970: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+0000a980: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+0000a990: 2e6d 6172 6b2e 6962 6d0a 6465 6620 7465  .mark.ibm.def te
+0000a9a0: 7374 5f69 626d 5f73 746f 7261 6765 5f6d  st_ibm_storage_m
+0000a9b0: 6f75 6e74 7328 293a 0a20 2020 206e 616d  ounts():.    nam
+0000a9c0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+0000a9d0: 5f6e 616d 6528 290a 2020 2020 7374 6f72  _name().    stor
+0000a9e0: 6167 655f 6e61 6d65 203d 2066 2773 6b79  age_name = f'sky
+0000a9f0: 2d74 6573 742d 7b69 6e74 2874 696d 652e  -test-{int(time.
+0000aa00: 7469 6d65 2829 297d 270a 2020 2020 6275  time())}'.    bu
+0000aa10: 636b 6574 5f72 636c 6f6e 655f 7072 6f66  cket_rclone_prof
+0000aa20: 696c 6520 3d20 5263 6c6f 6e65 2e67 656e  ile = Rclone.gen
+0000aa30: 6572 6174 655f 7263 6c6f 6e65 5f62 7563  erate_rclone_buc
+0000aa40: 6b65 745f 7072 6f66 696c 655f 6e61 6d65  ket_profile_name
+0000aa50: 280a 2020 2020 2020 2020 7374 6f72 6167  (.        storag
+0000aa60: 655f 6e61 6d65 2c20 5263 6c6f 6e65 2e52  e_name, Rclone.R
+0000aa70: 636c 6f6e 6543 6c6f 7564 732e 4942 4d29  cloneClouds.IBM)
+0000aa80: 0a20 2020 2074 656d 706c 6174 655f 7374  .    template_st
+0000aa90: 7220 3d20 7061 7468 6c69 622e 5061 7468  r = pathlib.Path
+0000aaa0: 280a 2020 2020 2020 2020 2774 6573 7473  (.        'tests
+0000aab0: 2f74 6573 745f 7961 6d6c 732f 7465 7374  /test_yamls/test
+0000aac0: 5f69 626d 5f63 6f73 5f73 746f 7261 6765  _ibm_cos_storage
+0000aad0: 5f6d 6f75 6e74 696e 672e 7961 6d6c 2729  _mounting.yaml')
+0000aae0: 2e72 6561 645f 7465 7874 2829 0a20 2020  .read_text().   
+0000aaf0: 2074 656d 706c 6174 6520 3d20 6a69 6e6a   template = jinj
+0000ab00: 6132 2e54 656d 706c 6174 6528 7465 6d70  a2.Template(temp
+0000ab10: 6c61 7465 5f73 7472 290a 2020 2020 636f  late_str).    co
+0000ab20: 6e74 656e 7420 3d20 7465 6d70 6c61 7465  ntent = template
+0000ab30: 2e72 656e 6465 7228 7374 6f72 6167 655f  .render(storage_
+0000ab40: 6e61 6d65 3d73 746f 7261 6765 5f6e 616d  name=storage_nam
+0000ab50: 6529 0a20 2020 2077 6974 6820 7465 6d70  e).    with temp
+0000ab60: 6669 6c65 2e4e 616d 6564 5465 6d70 6f72  file.NamedTempor
+0000ab70: 6172 7946 696c 6528 7375 6666 6978 3d27  aryFile(suffix='
+0000ab80: 2e79 616d 6c27 2c20 6d6f 6465 3d27 7727  .yaml', mode='w'
+0000ab90: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
+0000aba0: 662e 7772 6974 6528 636f 6e74 656e 7429  f.write(content)
+0000abb0: 0a20 2020 2020 2020 2066 2e66 6c75 7368  .        f.flush
+0000abc0: 2829 0a20 2020 2020 2020 2066 696c 655f  ().        file_
+0000abd0: 7061 7468 203d 2066 2e6e 616d 650a 2020  path = f.name.  
+0000abe0: 2020 2020 2020 7465 7374 5f63 6f6d 6d61        test_comma
+0000abf0: 6e64 7320 3d20 5b0a 2020 2020 2020 2020  nds = [.        
+0000ac00: 2020 2020 2a73 746f 7261 6765 5f73 6574      *storage_set
+0000ac10: 7570 5f63 6f6d 6d61 6e64 732c 0a20 2020  up_commands,.   
+0000ac20: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+0000ac30: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+0000ac40: 657d 202d 2d63 6c6f 7564 2069 626d 207b  e} --cloud ibm {
+0000ac50: 6669 6c65 5f70 6174 687d 272c 0a20 2020  file_path}',.   
+0000ac60: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+0000ac70: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
+0000ac80: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+0000ac90: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+0000aca0: 0a20 2020 2020 2020 2020 2020 2066 2772  .            f'r
+0000acb0: 636c 6f6e 6520 6c73 207b 6275 636b 6574  clone ls {bucket
+0000acc0: 5f72 636c 6f6e 655f 7072 6f66 696c 657d  _rclone_profile}
+0000acd0: 3a7b 7374 6f72 6167 655f 6e61 6d65 7d2f  :{storage_name}/
+0000ace0: 6865 6c6c 6f2e 7478 7427 2c0a 2020 2020  hello.txt',.    
+0000acf0: 2020 2020 5d0a 2020 2020 2020 2020 7465      ].        te
+0000ad00: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+0000ad10: 2020 2020 2020 2027 6962 6d5f 7374 6f72         'ibm_stor
+0000ad20: 6167 655f 6d6f 756e 7473 272c 0a20 2020  age_mounts',.   
+0000ad30: 2020 2020 2020 2020 2074 6573 745f 636f           test_co
+0000ad40: 6d6d 616e 6473 2c0a 2020 2020 2020 2020  mmands,.        
+0000ad50: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+0000ad60: 7920 7b6e 616d 657d 3b20 736b 7920 7374  y {name}; sky st
+0000ad70: 6f72 6167 6520 6465 6c65 7465 202d 7920  orage delete -y 
+0000ad80: 7b73 746f 7261 6765 5f6e 616d 657d 272c  {storage_name}',
+0000ad90: 0a20 2020 2020 2020 2020 2020 2074 696d  .            tim
+0000ada0: 656f 7574 3d32 3020 2a20 3630 2c20 2023  eout=20 * 60,  #
+0000adb0: 2032 3020 6d69 6e73 0a20 2020 2020 2020   20 mins.       
+0000adc0: 2029 0a20 2020 2020 2020 2072 756e 5f6f   ).        run_o
+0000add0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+0000ade0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2043 4c49  # ---------- CLI
+0000adf0: 206c 6f67 7320 2d2d 2d2d 2d2d 2d2d 2d2d   logs ----------
+0000ae00: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+0000ae10: 5f73 6370 2020 2320 5343 5020 646f 6573  _scp  # SCP does
+0000ae20: 206e 6f74 2073 7570 706f 7274 206e 756d   not support num
+0000ae30: 5f6e 6f64 6573 203e 2031 2079 6574 2e20  _nodes > 1 yet. 
+0000ae40: 5275 6e20 7465 7374 5f73 6370 5f6c 6f67  Run test_scp_log
+0000ae50: 7320 696e 7374 6561 642e 0a64 6566 2074  s instead..def t
+0000ae60: 6573 745f 636c 695f 6c6f 6773 2867 656e  est_cli_logs(gen
+0000ae70: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+0000ae80: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+0000ae90: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+0000aea0: 0a20 2020 206e 756d 5f6e 6f64 6573 203d  .    num_nodes =
+0000aeb0: 2032 0a20 2020 2069 6620 6765 6e65 7269   2.    if generi
+0000aec0: 635f 636c 6f75 6420 3d3d 2027 6b75 6265  c_cloud == 'kube
+0000aed0: 726e 6574 6573 273a 0a20 2020 2020 2020  rnetes':.       
+0000aee0: 2023 204b 7562 6572 6e65 7465 7320 646f   # Kubernetes do
+0000aef0: 6573 206e 6f74 2073 7570 706f 7274 206d  es not support m
+0000af00: 756c 7469 2d6e 6f64 650a 2020 2020 2020  ulti-node.      
+0000af10: 2020 6e75 6d5f 6e6f 6465 7320 3d20 310a    num_nodes = 1.
+0000af20: 2020 2020 7469 6d65 7374 616d 7020 3d20      timestamp = 
+0000af30: 7469 6d65 2e74 696d 6528 290a 2020 2020  time.time().    
+0000af40: 7465 7374 203d 2054 6573 7428 2763 6c69  test = Test('cli
+0000af50: 5f6c 6f67 7327 2c20 5b0a 2020 2020 2020  _logs', [.      
+0000af60: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+0000af70: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
+0000af80: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+0000af90: 7564 7d20 2d2d 6e75 6d2d 6e6f 6465 7320  ud} --num-nodes 
+0000afa0: 7b6e 756d 5f6e 6f64 6573 7d20 2265 6368  {num_nodes} "ech
+0000afb0: 6f20 7b74 696d 6573 7461 6d70 7d20 3122  o {timestamp} 1"
+0000afc0: 272c 0a20 2020 2020 2020 2066 2773 6b79  ',.        f'sky
+0000afd0: 2065 7865 6320 7b6e 616d 657d 2022 6563   exec {name} "ec
+0000afe0: 686f 207b 7469 6d65 7374 616d 707d 2032  ho {timestamp} 2
+0000aff0: 2227 2c0a 2020 2020 2020 2020 6627 736b  "',.        f'sk
+0000b000: 7920 6578 6563 207b 6e61 6d65 7d20 2265  y exec {name} "e
+0000b010: 6368 6f20 7b74 696d 6573 7461 6d70 7d20  cho {timestamp} 
+0000b020: 3322 272c 0a20 2020 2020 2020 2066 2773  3"',.        f's
+0000b030: 6b79 2065 7865 6320 7b6e 616d 657d 2022  ky exec {name} "
+0000b040: 6563 686f 207b 7469 6d65 7374 616d 707d  echo {timestamp}
+0000b050: 2034 2227 2c0a 2020 2020 2020 2020 6627   4"',.        f'
+0000b060: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+0000b070: 3220 2d2d 7374 6174 7573 272c 0a20 2020  2 --status',.   
+0000b080: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+0000b090: 7b6e 616d 657d 2033 2034 202d 2d73 796e  {name} 3 4 --syn
+0000b0a0: 632d 646f 776e 272c 0a20 2020 2020 2020  c-down',.       
+0000b0b0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+0000b0c0: 657d 202a 202d 2d73 796e 632d 646f 776e  e} * --sync-down
+0000b0d0: 272c 0a20 2020 2020 2020 2066 2773 6b79  ',.        f'sky
+0000b0e0: 206c 6f67 7320 7b6e 616d 657d 2031 207c   logs {name} 1 |
+0000b0f0: 2067 7265 7020 227b 7469 6d65 7374 616d   grep "{timestam
+0000b100: 707d 2031 2227 2c0a 2020 2020 2020 2020  p} 1"',.        
+0000b110: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+0000b120: 7d20 7c20 6772 6570 2022 7b74 696d 6573  } | grep "{times
+0000b130: 7461 6d70 7d20 3422 272c 0a20 2020 205d  tamp} 4"',.    ]
+0000b140: 2c20 6627 736b 7920 646f 776e 202d 7920  , f'sky down -y 
+0000b150: 7b6e 616d 657d 2729 0a20 2020 2072 756e  {name}').    run
+0000b160: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+0000b170: 0a0a 4070 7974 6573 742e 6d61 726b 2e73  ..@pytest.mark.s
+0000b180: 6370 0a64 6566 2074 6573 745f 7363 705f  cp.def test_scp_
+0000b190: 6c6f 6773 2829 3a0a 2020 2020 6e61 6d65  logs():.    name
+0000b1a0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+0000b1b0: 6e61 6d65 2829 0a20 2020 2074 696d 6573  name().    times
+0000b1c0: 7461 6d70 203d 2074 696d 652e 7469 6d65  tamp = time.time
+0000b1d0: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+0000b1e0: 7374 280a 2020 2020 2020 2020 2753 4350  st(.        'SCP
+0000b1f0: 5f63 6c69 5f6c 6f67 7327 2c0a 2020 2020  _cli_logs',.    
+0000b200: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+0000b210: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+0000b220: 7920 2d63 207b 6e61 6d65 7d20 7b53 4350  y -c {name} {SCP
+0000b230: 5f54 5950 457d 2022 6563 686f 207b 7469  _TYPE} "echo {ti
+0000b240: 6d65 7374 616d 707d 2031 2227 2c0a 2020  mestamp} 1"',.  
+0000b250: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000b260: 6578 6563 207b 6e61 6d65 7d20 2265 6368  exec {name} "ech
+0000b270: 6f20 7b74 696d 6573 7461 6d70 7d20 3222  o {timestamp} 2"
+0000b280: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000b290: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+0000b2a0: 2022 6563 686f 207b 7469 6d65 7374 616d   "echo {timestam
+0000b2b0: 707d 2033 2227 2c0a 2020 2020 2020 2020  p} 3"',.        
+0000b2c0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+0000b2d0: 6e61 6d65 7d20 2265 6368 6f20 7b74 696d  name} "echo {tim
+0000b2e0: 6573 7461 6d70 7d20 3422 272c 0a20 2020  estamp} 4"',.   
+0000b2f0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+0000b300: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
+0000b310: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+0000b320: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0000b330: 6e61 6d65 7d20 3320 3420 2d2d 7379 6e63  name} 3 4 --sync
+0000b340: 2d64 6f77 6e27 2c0a 2020 2020 2020 2020  -down',.        
+0000b350: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0000b360: 6e61 6d65 7d20 2a20 2d2d 7379 6e63 2d64  name} * --sync-d
+0000b370: 6f77 6e27 2c0a 2020 2020 2020 2020 2020  own',.          
+0000b380: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+0000b390: 6d65 7d20 3120 7c20 6772 6570 2022 7b74  me} 1 | grep "{t
+0000b3a0: 696d 6573 7461 6d70 7d20 3122 272c 0a20  imestamp} 1"',. 
+0000b3b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000b3c0: 206c 6f67 7320 7b6e 616d 657d 207c 2067   logs {name} | g
+0000b3d0: 7265 7020 227b 7469 6d65 7374 616d 707d  rep "{timestamp}
+0000b3e0: 2034 2227 2c0a 2020 2020 2020 2020 5d2c   4"',.        ],
+0000b3f0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+0000b400: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+0000b410: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+0000b420: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
+0000b430: 202d 2d2d 2d2d 2d2d 2d2d 2d20 4a6f 6220   ---------- Job 
+0000b440: 5175 6575 652e 202d 2d2d 2d2d 2d2d 2d2d  Queue. ---------
+0000b450: 2d0a 4070 7974 6573 742e 6d61 726b 2e6e  -.@pytest.mark.n
+0000b460: 6f5f 666c 7569 6473 7461 636b 2020 2320  o_fluidstack  # 
+0000b470: 466c 7569 6453 7461 636b 2044 4320 6861  FluidStack DC ha
+0000b480: 7320 6c6f 7720 6176 6169 6c61 6269 6c69  s low availabili
+0000b490: 7479 206f 6620 5434 2047 5055 730a 4070  ty of T4 GPUs.@p
+0000b4a0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6c61  ytest.mark.no_la
+0000b4b0: 6d62 6461 5f63 6c6f 7564 2020 2320 4c61  mbda_cloud  # La
+0000b4c0: 6d62 6461 2043 6c6f 7564 2064 6f65 7320  mbda Cloud does 
+0000b4d0: 6e6f 7420 6861 7665 2054 3420 6770 7573  not have T4 gpus
+0000b4e0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+0000b4f0: 5f69 626d 2020 2320 4942 4d20 436c 6f75  _ibm  # IBM Clou
+0000b500: 6420 646f 6573 206e 6f74 2068 6176 6520  d does not have 
+0000b510: 5434 2067 7075 732e 2072 756e 2074 6573  T4 gpus. run tes
+0000b520: 745f 6962 6d5f 6a6f 625f 7175 6575 6520  t_ibm_job_queue 
+0000b530: 696e 7374 6561 640a 4070 7974 6573 742e  instead.@pytest.
+0000b540: 6d61 726b 2e6e 6f5f 7363 7020 2023 2053  mark.no_scp  # S
+0000b550: 4350 2064 6f65 7320 6e6f 7420 6861 7665  CP does not have
+0000b560: 2054 3420 6770 7573 2e20 5275 6e20 7465   T4 gpus. Run te
+0000b570: 7374 5f73 6370 5f6a 6f62 5f71 7565 7565  st_scp_job_queue
+0000b580: 2069 6e73 7465 6164 0a40 7079 7465 7374   instead.@pytest
+0000b590: 2e6d 6172 6b2e 6e6f 5f70 6170 6572 7370  .mark.no_papersp
+0000b5a0: 6163 6520 2023 2050 6170 6572 7370 6163  ace  # Paperspac
+0000b5b0: 6520 646f 6573 206e 6f74 2068 6176 6520  e does not have 
+0000b5c0: 5434 2067 7075 732e 0a40 7079 7465 7374  T4 gpus..@pytest
+0000b5d0: 2e6d 6172 6b2e 6e6f 5f6f 6369 2020 2320  .mark.no_oci  # 
+0000b5e0: 4f43 4920 646f 6573 206e 6f74 2068 6176  OCI does not hav
+0000b5f0: 6520 5434 2067 7075 730a 6465 6620 7465  e T4 gpus.def te
+0000b600: 7374 5f6a 6f62 5f71 7565 7565 2867 656e  st_job_queue(gen
+0000b610: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+0000b620: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+0000b630: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+0000b640: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+0000b650: 280a 2020 2020 2020 2020 276a 6f62 5f71  (.        'job_q
+0000b660: 7565 7565 272c 0a20 2020 2020 2020 205b  ueue',.        [
+0000b670: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000b680: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+0000b690: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
+0000b6a0: 6765 6e65 7269 635f 636c 6f75 647d 2065  generic_cloud} e
+0000b6b0: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
+0000b6c0: 652f 636c 7573 7465 722e 7961 6d6c 272c  e/cluster.yaml',
+0000b6d0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000b6e0: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+0000b6f0: 6e20 7b6e 616d 657d 2d31 202d 6420 6578  n {name}-1 -d ex
+0000b700: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
+0000b710: 2f6a 6f62 2e79 616d 6c27 2c0a 2020 2020  /job.yaml',.    
+0000b720: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+0000b730: 6563 207b 6e61 6d65 7d20 2d6e 207b 6e61  ec {name} -n {na
+0000b740: 6d65 7d2d 3220 2d64 2065 7861 6d70 6c65  me}-2 -d example
+0000b750: 732f 6a6f 625f 7175 6575 652f 6a6f 622e  s/job_queue/job.
+0000b760: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+0000b770: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+0000b780: 616d 657d 202d 6e20 7b6e 616d 657d 2d33  ame} -n {name}-3
+0000b790: 202d 6420 6578 616d 706c 6573 2f6a 6f62   -d examples/job
+0000b7a0: 5f71 7565 7565 2f6a 6f62 2e79 616d 6c27  _queue/job.yaml'
+0000b7b0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000b7c0: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
+0000b7d0: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
+0000b7e0: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
+0000b7f0: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
+0000b800: 6e61 6d65 7d2d 3120 7c20 6772 6570 2052  name}-1 | grep R
+0000b810: 554e 4e49 4e47 272c 0a20 2020 2020 2020  UNNING',.       
+0000b820: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
+0000b830: 7565 7565 207b 6e61 6d65 7d29 3b20 6563  ueue {name}); ec
+0000b840: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
+0000b850: 6368 6f3b 2065 6368 6f20 2224 7322 207c  cho; echo "$s" |
+0000b860: 2067 7265 7020 7b6e 616d 657d 2d32 207c   grep {name}-2 |
+0000b870: 2067 7265 7020 5255 4e4e 494e 4727 2c0a   grep RUNNING',.
+0000b880: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+0000b890: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
+0000b8a0: 657d 293b 2065 6368 6f20 2224 7322 3b20  e}); echo "$s"; 
+0000b8b0: 6563 686f 3b20 6563 686f 3b20 6563 686f  echo; echo; echo
+0000b8c0: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
+0000b8d0: 6d65 7d2d 3320 7c20 6772 6570 2050 454e  me}-3 | grep PEN
+0000b8e0: 4449 4e47 272c 0a20 2020 2020 2020 2020  DING',.         
+0000b8f0: 2020 2066 2773 6b79 2063 616e 6365 6c20     f'sky cancel 
+0000b900: 2d79 207b 6e61 6d65 7d20 3227 2c0a 2020  -y {name} 2',.  
+0000b910: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0000b920: 2035 272c 0a20 2020 2020 2020 2020 2020   5',.           
+0000b930: 2066 2773 3d24 2873 6b79 2071 7565 7565   f's=$(sky queue
+0000b940: 207b 6e61 6d65 7d29 3b20 6563 686f 2022   {name}); echo "
+0000b950: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
+0000b960: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+0000b970: 7020 7b6e 616d 657d 2d33 207c 2067 7265  p {name}-3 | gre
+0000b980: 7020 5255 4e4e 494e 4727 2c0a 2020 2020  p RUNNING',.    
+0000b990: 2020 2020 2020 2020 6627 736b 7920 6361          f'sky ca
+0000b9a0: 6e63 656c 202d 7920 7b6e 616d 657d 2033  ncel -y {name} 3
+0000b9b0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000b9c0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+0000b9d0: 202d 2d67 7075 7320 5434 3a30 2e32 2022   --gpus T4:0.2 "
+0000b9e0: 5b5b 205c 2453 4b59 5049 4c4f 545f 4e55  [[ \$SKYPILOT_NU
+0000b9f0: 4d5f 4750 5553 5f50 4552 5f4e 4f44 4520  M_GPUS_PER_NODE 
+0000ba00: 2d65 7120 3120 5d5d 207c 7c20 6578 6974  -eq 1 ]] || exit
+0000ba10: 2031 2227 2c0a 2020 2020 2020 2020 2020   1"',.          
+0000ba20: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+0000ba30: 6d65 7d20 2d2d 6770 7573 2054 343a 3120  me} --gpus T4:1 
+0000ba40: 225b 5b20 5c24 534b 5950 494c 4f54 5f4e  "[[ \$SKYPILOT_N
+0000ba50: 554d 5f47 5055 535f 5045 525f 4e4f 4445  UM_GPUS_PER_NODE
+0000ba60: 202d 6571 2031 205d 5d20 7c7c 2065 7869   -eq 1 ]] || exi
+0000ba70: 7420 3122 272c 0a20 2020 2020 2020 2020  t 1"',.         
+0000ba80: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+0000ba90: 616d 657d 2034 202d 2d73 7461 7475 7327  ame} 4 --status'
+0000baa0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000bab0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+0000bac0: 3520 2d2d 7374 6174 7573 272c 0a20 2020  5 --status',.   
+0000bad0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+0000bae0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+0000baf0: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
+0000bb00: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+0000bb10: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
+0000bb20: 2d2d 204a 6f62 2051 7565 7565 2077 6974  -- Job Queue wit
+0000bb30: 6820 446f 636b 6572 2e20 2d2d 2d2d 2d2d  h Docker. ------
+0000bb40: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
+0000bb50: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b20  k.no_fluidstack 
+0000bb60: 2023 2046 6c75 6964 5374 6163 6b20 646f   # FluidStack do
+0000bb70: 6573 206e 6f74 2073 7570 706f 7274 2064  es not support d
+0000bb80: 6f63 6b65 7220 666f 7220 6e6f 770a 4070  ocker for now.@p
+0000bb90: 7974 6573 742e 6d61 726b 2e6e 6f5f 6c61  ytest.mark.no_la
+0000bba0: 6d62 6461 5f63 6c6f 7564 2020 2320 446f  mbda_cloud  # Do
+0000bbb0: 6573 6e27 7420 7375 7070 6f72 7420 4c61  esn't support La
+0000bbc0: 6d62 6461 2043 6c6f 7564 2066 6f72 206e  mbda Cloud for n
+0000bbd0: 6f77 0a40 7079 7465 7374 2e6d 6172 6b2e  ow.@pytest.mark.
+0000bbe0: 6e6f 5f69 626d 2020 2320 446f 6573 6e27  no_ibm  # Doesn'
+0000bbf0: 7420 7375 7070 6f72 7420 4942 4d20 436c  t support IBM Cl
+0000bc00: 6f75 6420 666f 7220 6e6f 770a 4070 7974  oud for now.@pyt
+0000bc10: 6573 742e 6d61 726b 2e6e 6f5f 7061 7065  est.mark.no_pape
+0000bc20: 7273 7061 6365 2020 2320 5061 7065 7273  rspace  # Papers
+0000bc30: 7061 6365 2064 6f65 736e 2774 2068 6176  pace doesn't hav
+0000bc40: 6520 5434 2047 5055 730a 4070 7974 6573  e T4 GPUs.@pytes
+0000bc50: 742e 6d61 726b 2e6e 6f5f 7363 7020 2023  t.mark.no_scp  #
+0000bc60: 2044 6f65 736e 2774 2073 7570 706f 7274   Doesn't support
+0000bc70: 2053 4350 2066 6f72 206e 6f77 0a40 7079   SCP for now.@py
+0000bc80: 7465 7374 2e6d 6172 6b2e 6e6f 5f6f 6369  test.mark.no_oci
+0000bc90: 2020 2320 446f 6573 6e27 7420 7375 7070    # Doesn't supp
+0000bca0: 6f72 7420 4f43 4920 666f 7220 6e6f 770a  ort OCI for now.
+0000bcb0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+0000bcc0: 6b75 6265 726e 6574 6573 2020 2320 446f  kubernetes  # Do
+0000bcd0: 6573 6e27 7420 7375 7070 6f72 7420 4b75  esn't support Ku
+0000bce0: 6265 726e 6574 6573 2066 6f72 206e 6f77  bernetes for now
+0000bcf0: 0a40 7079 7465 7374 2e6d 6172 6b2e 7061  .@pytest.mark.pa
+0000bd00: 7261 6d65 7472 697a 6528 0a20 2020 2027  rametrize(.    '
+0000bd10: 696d 6167 655f 6964 272c 0a20 2020 205b  image_id',.    [
+0000bd20: 0a20 2020 2020 2020 2027 646f 636b 6572  .        'docker
+0000bd30: 3a6e 7669 6469 612f 6375 6461 3a31 312e  :nvidia/cuda:11.
+0000bd40: 382e 302d 6465 7665 6c2d 7562 756e 7475  8.0-devel-ubuntu
+0000bd50: 3138 2e30 3427 2c0a 2020 2020 2020 2020  18.04',.        
+0000bd60: 2764 6f63 6b65 723a 7562 756e 7475 3a31  'docker:ubuntu:1
+0000bd70: 382e 3034 272c 0a20 2020 2020 2020 2023  8.04',.        #
+0000bd80: 2054 6573 7420 6c61 7465 7374 2069 6d61   Test latest ima
+0000bd90: 6765 2077 6974 6820 7079 7468 6f6e 2033  ge with python 3
+0000bda0: 2e31 3120 696e 7374 616c 6c65 6420 6279  .11 installed by
+0000bdb0: 2064 6566 6175 6c74 2e0a 2020 2020 2020   default..      
+0000bdc0: 2020 2320 446f 6573 206e 6f74 2077 6f72    # Does not wor
+0000bdd0: 6b20 666f 7220 7079 7468 6f6e 2033 2e31  k for python 3.1
+0000bde0: 3220 6475 6520 746f 2072 6179 2773 2072  2 due to ray's r
+0000bdf0: 6571 7569 7265 6d65 6e74 2066 6f72 2033  equirement for 3
+0000be00: 2e31 312e 0a20 2020 2020 2020 2027 646f  .11..        'do
+0000be10: 636b 6572 3a63 6f6e 7469 6e75 756d 696f  cker:continuumio
+0000be20: 2f6d 696e 6963 6f6e 6461 333a 3234 2e31  /miniconda3:24.1
+0000be30: 2e32 2d30 272c 0a20 2020 205d 290a 6465  .2-0',.    ]).de
+0000be40: 6620 7465 7374 5f6a 6f62 5f71 7565 7565  f test_job_queue
+0000be50: 5f77 6974 685f 646f 636b 6572 2867 656e  _with_docker(gen
+0000be60: 6572 6963 5f63 6c6f 7564 3a20 7374 722c  eric_cloud: str,
+0000be70: 2069 6d61 6765 5f69 643a 2073 7472 293a   image_id: str):
+0000be80: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+0000be90: 5f63 6c75 7374 6572 5f6e 616d 6528 2920  _cluster_name() 
+0000bea0: 2b20 696d 6167 655f 6964 5b6c 656e 2827  + image_id[len('
+0000beb0: 646f 636b 6572 3a27 293a 5d5b 3a34 5d0a  docker:'):][:4].
+0000bec0: 2020 2020 746f 7461 6c5f 7469 6d65 6f75      total_timeou
+0000bed0: 745f 6d69 6e75 7465 7320 3d20 3430 2069  t_minutes = 40 i
+0000bee0: 6620 6765 6e65 7269 635f 636c 6f75 6420  f generic_cloud 
+0000bef0: 3d3d 2027 617a 7572 6527 2065 6c73 6520  == 'azure' else 
+0000bf00: 3135 0a20 2020 2074 696d 655f 746f 5f73  15.    time_to_s
+0000bf10: 6c65 6570 203d 2033 3030 2069 6620 6765  leep = 300 if ge
+0000bf20: 6e65 7269 635f 636c 6f75 6420 3d3d 2027  neric_cloud == '
+0000bf30: 617a 7572 6527 2065 6c73 6520 3138 300a  azure' else 180.
+0000bf40: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+0000bf50: 0a20 2020 2020 2020 2027 6a6f 625f 7175  .        'job_qu
+0000bf60: 6575 655f 7769 7468 5f64 6f63 6b65 7227  eue_with_docker'
+0000bf70: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+0000bf80: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+0000bf90: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+0000bfa0: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+0000bfb0: 6963 5f63 6c6f 7564 7d20 2d2d 696d 6167  ic_cloud} --imag
+0000bfc0: 652d 6964 207b 696d 6167 655f 6964 7d20  e-id {image_id} 
+0000bfd0: 6578 616d 706c 6573 2f6a 6f62 5f71 7565  examples/job_que
+0000bfe0: 7565 2f63 6c75 7374 6572 5f64 6f63 6b65  ue/cluster_docke
+0000bff0: 722e 7961 6d6c 272c 0a20 2020 2020 2020  r.yaml',.       
+0000c000: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+0000c010: 7b6e 616d 657d 202d 6e20 7b6e 616d 657d  {name} -n {name}
+0000c020: 2d31 202d 6420 2d2d 696d 6167 652d 6964  -1 -d --image-id
+0000c030: 207b 696d 6167 655f 6964 7d20 2d2d 656e   {image_id} --en
+0000c040: 7620 5449 4d45 5f54 4f5f 534c 4545 503d  v TIME_TO_SLEEP=
+0000c050: 7b74 696d 655f 746f 5f73 6c65 6570 7d20  {time_to_sleep} 
+0000c060: 6578 616d 706c 6573 2f6a 6f62 5f71 7565  examples/job_que
+0000c070: 7565 2f6a 6f62 5f64 6f63 6b65 722e 7961  ue/job_docker.ya
+0000c080: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+0000c090: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+0000c0a0: 657d 202d 6e20 7b6e 616d 657d 2d32 202d  e} -n {name}-2 -
+0000c0b0: 6420 2d2d 696d 6167 652d 6964 207b 696d  d --image-id {im
+0000c0c0: 6167 655f 6964 7d20 2d2d 656e 7620 5449  age_id} --env TI
+0000c0d0: 4d45 5f54 4f5f 534c 4545 503d 7b74 696d  ME_TO_SLEEP={tim
+0000c0e0: 655f 746f 5f73 6c65 6570 7d20 6578 616d  e_to_sleep} exam
+0000c0f0: 706c 6573 2f6a 6f62 5f71 7565 7565 2f6a  ples/job_queue/j
+0000c100: 6f62 5f64 6f63 6b65 722e 7961 6d6c 272c  ob_docker.yaml',
+0000c110: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000c120: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+0000c130: 6e20 7b6e 616d 657d 2d33 202d 6420 2d2d  n {name}-3 -d --
+0000c140: 696d 6167 652d 6964 207b 696d 6167 655f  image-id {image_
+0000c150: 6964 7d20 2d2d 656e 7620 5449 4d45 5f54  id} --env TIME_T
+0000c160: 4f5f 534c 4545 503d 7b74 696d 655f 746f  O_SLEEP={time_to
+0000c170: 5f73 6c65 6570 7d20 6578 616d 706c 6573  _sleep} examples
+0000c180: 2f6a 6f62 5f71 7565 7565 2f6a 6f62 5f64  /job_queue/job_d
+0000c190: 6f63 6b65 722e 7961 6d6c 272c 0a20 2020  ocker.yaml',.   
+0000c1a0: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
+0000c1b0: 6b79 2071 7565 7565 207b 6e61 6d65 7d29  ky queue {name})
+0000c1c0: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
+0000c1d0: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
+0000c1e0: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
+0000c1f0: 2d31 207c 2067 7265 7020 5255 4e4e 494e  -1 | grep RUNNIN
+0000c200: 4727 2c0a 2020 2020 2020 2020 2020 2020  G',.            
+0000c210: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
+0000c220: 7b6e 616d 657d 293b 2065 6368 6f20 2224  {name}); echo "$
+0000c230: 7322 3b20 6563 686f 3b20 6563 686f 3b20  s"; echo; echo; 
+0000c240: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+0000c250: 207b 6e61 6d65 7d2d 3220 7c20 6772 6570   {name}-2 | grep
+0000c260: 2052 554e 4e49 4e47 272c 0a20 2020 2020   RUNNING',.     
+0000c270: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+0000c280: 2071 7565 7565 207b 6e61 6d65 7d29 3b20   queue {name}); 
+0000c290: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
+0000c2a0: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
+0000c2b0: 207c 2067 7265 7020 7b6e 616d 657d 2d33   | grep {name}-3
+0000c2c0: 207c 2067 7265 7020 5045 4e44 494e 4727   | grep PENDING'
+0000c2d0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000c2e0: 736b 7920 6361 6e63 656c 202d 7920 7b6e  sky cancel -y {n
+0000c2f0: 616d 657d 2032 272c 0a20 2020 2020 2020  ame} 2',.       
+0000c300: 2020 2020 2027 736c 6565 7020 3527 2c0a       'sleep 5',.
+0000c310: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+0000c320: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
+0000c330: 657d 293b 2065 6368 6f20 2224 7322 3b20  e}); echo "$s"; 
+0000c340: 6563 686f 3b20 6563 686f 3b20 6563 686f  echo; echo; echo
+0000c350: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
+0000c360: 6d65 7d2d 3320 7c20 6772 6570 2052 554e  me}-3 | grep RUN
+0000c370: 4e49 4e47 272c 0a20 2020 2020 2020 2020  NING',.         
+0000c380: 2020 2066 2773 6b79 2063 616e 6365 6c20     f'sky cancel 
+0000c390: 2d79 207b 6e61 6d65 7d20 3327 2c0a 2020  -y {name} 3',.  
+0000c3a0: 2020 2020 2020 2020 2020 2320 4d61 6b65            # Make
+0000c3b0: 2073 7572 6520 7468 6520 4750 5520 6973   sure the GPU is
+0000c3c0: 2073 7469 6c6c 2076 6973 6962 6c65 2074   still visible t
+0000c3d0: 6f20 7468 6520 636f 6e74 6169 6e65 722e  o the container.
+0000c3e0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000c3f0: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+0000c400: 2d69 6d61 6765 2d69 6420 7b69 6d61 6765  -image-id {image
+0000c410: 5f69 647d 206e 7669 6469 612d 736d 6920  _id} nvidia-smi 
+0000c420: 7c20 6772 6570 2022 5465 736c 6120 5434  | grep "Tesla T4
+0000c430: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0000c440: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+0000c450: 7d20 3420 2d2d 7374 6174 7573 272c 0a20  } 4 --status',. 
+0000c460: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000c470: 2073 746f 7020 2d79 207b 6e61 6d65 7d27   stop -y {name}'
+0000c480: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+0000c490: 4d61 6b65 2073 7572 6520 7468 6520 6a6f  Make sure the jo
+0000c4a0: 6220 7374 6174 7573 2070 7265 7365 7276  b status preserv
+0000c4b0: 6520 6166 7465 7220 7374 6f70 2061 6e64  e after stop and
+0000c4c0: 2073 7461 7274 2074 6865 0a20 2020 2020   start the.     
+0000c4d0: 2020 2020 2020 2023 2063 6c75 7374 6572         # cluster
+0000c4e0: 2e20 5468 6973 2069 7320 616c 736f 2061  . This is also a
+0000c4f0: 2074 6573 7420 666f 7220 7468 6520 646f   test for the do
+0000c500: 636b 6572 2063 6f6e 7461 696e 6572 2074  cker container t
+0000c510: 6f20 6265 0a20 2020 2020 2020 2020 2020  o be.           
+0000c520: 2023 2070 7265 7365 7276 6564 2061 6674   # preserved aft
+0000c530: 6572 2073 746f 7020 616e 6420 7374 6172  er stop and star
+0000c540: 742e 0a20 2020 2020 2020 2020 2020 2066  t..            f
+0000c550: 2773 6b79 2073 7461 7274 202d 7920 7b6e  'sky start -y {n
+0000c560: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
+0000c570: 2020 2066 2773 3d24 2873 6b79 2071 7565     f's=$(sky que
+0000c580: 7565 207b 6e61 6d65 7d29 3b20 6563 686f  ue {name}); echo
+0000c590: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
+0000c5a0: 6f3b 2065 6368 6f20 2224 7322 207c 2067  o; echo "$s" | g
+0000c5b0: 7265 7020 7b6e 616d 657d 2d31 207c 2067  rep {name}-1 | g
+0000c5c0: 7265 7020 4641 494c 4544 272c 0a20 2020  rep FAILED',.   
+0000c5d0: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
+0000c5e0: 6b79 2071 7565 7565 207b 6e61 6d65 7d29  ky queue {name})
+0000c5f0: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
+0000c600: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
+0000c610: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
+0000c620: 2d32 207c 2067 7265 7020 4341 4e43 454c  -2 | grep CANCEL
+0000c630: 4c45 4427 2c0a 2020 2020 2020 2020 2020  LED',.          
+0000c640: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
+0000c650: 6520 7b6e 616d 657d 293b 2065 6368 6f20  e {name}); echo 
+0000c660: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
+0000c670: 3b20 6563 686f 2022 2473 2220 7c20 6772  ; echo "$s" | gr
+0000c680: 6570 207b 6e61 6d65 7d2d 3320 7c20 6772  ep {name}-3 | gr
+0000c690: 6570 2043 414e 4345 4c4c 4544 272c 0a20  ep CANCELLED',. 
+0000c6a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000c6b0: 2065 7865 6320 7b6e 616d 657d 202d 2d67   exec {name} --g
+0000c6c0: 7075 7320 5434 3a30 2e32 2022 5b5b 205c  pus T4:0.2 "[[ \
+0000c6d0: 2453 4b59 5049 4c4f 545f 4e55 4d5f 4750  $SKYPILOT_NUM_GP
+0000c6e0: 5553 5f50 4552 5f4e 4f44 4520 2d65 7120  US_PER_NODE -eq 
+0000c6f0: 3120 5d5d 207c 7c20 6578 6974 2031 2227  1 ]] || exit 1"'
+0000c700: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000c710: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+0000c720: 2d2d 6770 7573 2054 343a 3120 225b 5b20  --gpus T4:1 "[[ 
+0000c730: 5c24 534b 5950 494c 4f54 5f4e 554d 5f47  \$SKYPILOT_NUM_G
+0000c740: 5055 535f 5045 525f 4e4f 4445 202d 6571  PUS_PER_NODE -eq
+0000c750: 2031 205d 5d20 7c7c 2065 7869 7420 3122   1 ]] || exit 1"
+0000c760: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000c770: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+0000c780: 2035 202d 2d73 7461 7475 7327 2c0a 2020   5 --status',.  
+0000c790: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000c7a0: 6c6f 6773 207b 6e61 6d65 7d20 3620 2d2d  logs {name} 6 --
+0000c7b0: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+0000c7c0: 2020 2020 2023 204d 616b 6520 7375 7265       # Make sure
+0000c7d0: 2069 7420 6973 2073 7469 6c6c 2076 6973   it is still vis
+0000c7e0: 6962 6c65 2061 6674 6572 2061 6e20 7374  ible after an st
+0000c7f0: 6f70 2026 2073 7461 7274 2063 7963 6c65  op & start cycle
+0000c800: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+0000c810: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+0000c820: 2d2d 696d 6167 652d 6964 207b 696d 6167  --image-id {imag
+0000c830: 655f 6964 7d20 6e76 6964 6961 2d73 6d69  e_id} nvidia-smi
+0000c840: 207c 2067 7265 7020 2254 6573 6c61 2054   | grep "Tesla T
+0000c850: 3422 272c 0a20 2020 2020 2020 2020 2020  4"',.           
+0000c860: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+0000c870: 657d 2037 202d 2d73 7461 7475 7327 0a20  e} 7 --status'. 
+0000c880: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+0000c890: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+0000c8a0: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
+0000c8b0: 2074 696d 656f 7574 3d74 6f74 616c 5f74   timeout=total_t
+0000c8c0: 696d 656f 7574 5f6d 696e 7574 6573 202a  imeout_minutes *
+0000c8d0: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+0000c8e0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0000c8f0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+0000c900: 2e6c 616d 6264 615f 636c 6f75 640a 6465  .lambda_cloud.de
+0000c910: 6620 7465 7374 5f6c 616d 6264 615f 6a6f  f test_lambda_jo
+0000c920: 625f 7175 6575 6528 293a 0a20 2020 206e  b_queue():.    n
+0000c930: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+0000c940: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+0000c950: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+0000c960: 2020 2027 6c61 6d62 6461 5f6a 6f62 5f71     'lambda_job_q
+0000c970: 7565 7565 272c 0a20 2020 2020 2020 205b  ueue',.        [
+0000c980: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000c990: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+0000c9a0: 7b6e 616d 657d 207b 4c41 4d42 4441 5f54  {name} {LAMBDA_T
+0000c9b0: 5950 457d 2065 7861 6d70 6c65 732f 6a6f  YPE} examples/jo
+0000c9c0: 625f 7175 6575 652f 636c 7573 7465 722e  b_queue/cluster.
+0000c9d0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+0000c9e0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+0000c9f0: 616d 657d 202d 6e20 7b6e 616d 657d 2d31  ame} -n {name}-1
+0000ca00: 202d 2d67 7075 7320 4131 303a 302e 3520   --gpus A10:0.5 
+0000ca10: 2d64 2065 7861 6d70 6c65 732f 6a6f 625f  -d examples/job_
+0000ca20: 7175 6575 652f 6a6f 622e 7961 6d6c 272c  queue/job.yaml',
+0000ca30: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000ca40: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+0000ca50: 6e20 7b6e 616d 657d 2d32 202d 2d67 7075  n {name}-2 --gpu
+0000ca60: 7320 4131 303a 302e 3520 2d64 2065 7861  s A10:0.5 -d exa
+0000ca70: 6d70 6c65 732f 6a6f 625f 7175 6575 652f  mples/job_queue/
+0000ca80: 6a6f 622e 7961 6d6c 272c 0a20 2020 2020  job.yaml',.     
+0000ca90: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0000caa0: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
+0000cab0: 657d 2d33 202d 2d67 7075 7320 4131 303a  e}-3 --gpus A10:
+0000cac0: 302e 3520 2d64 2065 7861 6d70 6c65 732f  0.5 -d examples/
+0000cad0: 6a6f 625f 7175 6575 652f 6a6f 622e 7961  job_queue/job.ya
+0000cae0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+0000caf0: 2066 2773 6b79 2071 7565 7565 207b 6e61   f'sky queue {na
+0000cb00: 6d65 7d20 7c20 6772 6570 207b 6e61 6d65  me} | grep {name
+0000cb10: 7d2d 3120 7c20 6772 6570 2052 554e 4e49  }-1 | grep RUNNI
+0000cb20: 4e47 272c 0a20 2020 2020 2020 2020 2020  NG',.           
+0000cb30: 2066 2773 6b79 2071 7565 7565 207b 6e61   f'sky queue {na
+0000cb40: 6d65 7d20 7c20 6772 6570 207b 6e61 6d65  me} | grep {name
+0000cb50: 7d2d 3220 7c20 6772 6570 2052 554e 4e49  }-2 | grep RUNNI
+0000cb60: 4e47 272c 0a20 2020 2020 2020 2020 2020  NG',.           
+0000cb70: 2066 2773 6b79 2071 7565 7565 207b 6e61   f'sky queue {na
+0000cb80: 6d65 7d20 7c20 6772 6570 207b 6e61 6d65  me} | grep {name
+0000cb90: 7d2d 3320 7c20 6772 6570 2050 454e 4449  }-3 | grep PENDI
+0000cba0: 4e47 272c 0a20 2020 2020 2020 2020 2020  NG',.           
+0000cbb0: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
+0000cbc0: 207b 6e61 6d65 7d20 3227 2c0a 2020 2020   {name} 2',.    
+0000cbd0: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
+0000cbe0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000cbf0: 2773 6b79 2071 7565 7565 207b 6e61 6d65  'sky queue {name
+0000cc00: 7d20 7c20 6772 6570 207b 6e61 6d65 7d2d  } | grep {name}-
+0000cc10: 3320 7c20 6772 6570 2052 554e 4e49 4e47  3 | grep RUNNING
+0000cc20: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000cc30: 2773 6b79 2063 616e 6365 6c20 2d79 207b  'sky cancel -y {
+0000cc40: 6e61 6d65 7d20 3327 2c0a 2020 2020 2020  name} 3',.      
+0000cc50: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+0000cc60: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+0000cc70: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
+0000cc80: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+0000cc90: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+0000cca0: 6962 6d0a 6465 6620 7465 7374 5f69 626d  ibm.def test_ibm
+0000ccb0: 5f6a 6f62 5f71 7565 7565 2829 3a0a 2020  _job_queue():.  
+0000ccc0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+0000ccd0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+0000cce0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+0000ccf0: 2020 2020 2020 2769 626d 5f6a 6f62 5f71        'ibm_job_q
+0000cd00: 7565 7565 272c 0a20 2020 2020 2020 205b  ueue',.        [
 0000cd10: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000cd20: 6b79 2071 7565 7565 207b 6e61 6d65 7d20  ky queue {name} 
-0000cd30: 7c20 6772 6570 207b 6e61 6d65 7d2d 3220  | grep {name}-2 
-0000cd40: 7c20 6772 6570 2052 554e 4e49 4e47 272c  | grep RUNNING',
+0000cd20: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+0000cd30: 7b6e 616d 657d 202d 2d63 6c6f 7564 2069  {name} --cloud i
+0000cd40: 626d 202d 2d67 7075 7320 7631 3030 272c  bm --gpus v100',
 0000cd50: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000cd60: 6b79 2071 7565 7565 207b 6e61 6d65 7d20  ky queue {name} 
-0000cd70: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
-0000cd80: 7c20 6772 6570 2050 454e 4449 4e47 272c  | grep PENDING',
-0000cd90: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000cda0: 6b79 2063 616e 6365 6c20 2d79 207b 6e61  ky cancel -y {na
-0000cdb0: 6d65 7d20 3227 2c0a 2020 2020 2020 2020  me} 2',.        
-0000cdc0: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
-0000cdd0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000cde0: 2071 7565 7565 207b 6e61 6d65 7d20 7c20   queue {name} | 
-0000cdf0: 6772 6570 207b 6e61 6d65 7d2d 3320 7c20  grep {name}-3 | 
-0000ce00: 6772 6570 2052 554e 4e49 4e47 272c 0a20  grep RUNNING',. 
-0000ce10: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000ce20: 2063 616e 6365 6c20 2d79 207b 6e61 6d65   cancel -y {name
-0000ce30: 7d20 3327 2c0a 2020 2020 2020 2020 5d2c  } 3',.        ],
-0000ce40: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-0000ce50: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-0000ce60: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-0000ce70: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-0000ce80: 7079 7465 7374 2e6d 6172 6b2e 7363 700a  pytest.mark.scp.
-0000ce90: 6465 6620 7465 7374 5f73 6370 5f6a 6f62  def test_scp_job
-0000cea0: 5f71 7565 7565 2829 3a0a 2020 2020 6e61  _queue():.    na
-0000ceb0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-0000cec0: 725f 6e61 6d65 2829 0a20 2020 206e 756d  r_name().    num
-0000ced0: 5f6f 665f 6770 755f 6c61 756e 6368 203d  _of_gpu_launch =
-0000cee0: 2031 0a20 2020 206e 756d 5f6f 665f 6770   1.    num_of_gp
-0000cef0: 755f 6578 6563 203d 2030 2e35 0a20 2020  u_exec = 0.5.   
-0000cf00: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-0000cf10: 2020 2020 2020 2753 4350 5f6a 6f62 5f71        'SCP_job_q
-0000cf20: 7565 7565 272c 0a20 2020 2020 2020 205b  ueue',.        [
-0000cf30: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000cf40: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-0000cf50: 7b6e 616d 657d 207b 5343 505f 5459 5045  {name} {SCP_TYPE
-0000cf60: 7d20 7b53 4350 5f47 5055 5f56 3130 307d  } {SCP_GPU_V100}
-0000cf70: 3a7b 6e75 6d5f 6f66 5f67 7075 5f6c 6175  :{num_of_gpu_lau
-0000cf80: 6e63 687d 2065 7861 6d70 6c65 732f 6a6f  nch} examples/jo
-0000cf90: 625f 7175 6575 652f 636c 7573 7465 722e  b_queue/cluster.
-0000cfa0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-0000cfb0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-0000cfc0: 616d 657d 202d 6e20 7b6e 616d 657d 2d31  ame} -n {name}-1
-0000cfd0: 207b 5343 505f 4750 555f 5631 3030 7d3a   {SCP_GPU_V100}:
-0000cfe0: 7b6e 756d 5f6f 665f 6770 755f 6578 6563  {num_of_gpu_exec
-0000cff0: 7d20 2d64 2065 7861 6d70 6c65 732f 6a6f  } -d examples/jo
-0000d000: 625f 7175 6575 652f 6a6f 622e 7961 6d6c  b_queue/job.yaml
-0000d010: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000d020: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-0000d030: 202d 6e20 7b6e 616d 657d 2d32 207b 5343   -n {name}-2 {SC
-0000d040: 505f 4750 555f 5631 3030 7d3a 7b6e 756d  P_GPU_V100}:{num
-0000d050: 5f6f 665f 6770 755f 6578 6563 7d20 2d64  _of_gpu_exec} -d
-0000d060: 2065 7861 6d70 6c65 732f 6a6f 625f 7175   examples/job_qu
-0000d070: 6575 652f 6a6f 622e 7961 6d6c 272c 0a20  eue/job.yaml',. 
-0000d080: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000d090: 2065 7865 6320 7b6e 616d 657d 202d 6e20   exec {name} -n 
-0000d0a0: 7b6e 616d 657d 2d33 207b 5343 505f 4750  {name}-3 {SCP_GP
-0000d0b0: 555f 5631 3030 7d3a 7b6e 756d 5f6f 665f  U_V100}:{num_of_
-0000d0c0: 6770 755f 6578 6563 7d20 2d64 2065 7861  gpu_exec} -d exa
-0000d0d0: 6d70 6c65 732f 6a6f 625f 7175 6575 652f  mples/job_queue/
-0000d0e0: 6a6f 622e 7961 6d6c 272c 0a20 2020 2020  job.yaml',.     
-0000d0f0: 2020 2020 2020 2066 2773 6b79 2071 7565         f'sky que
-0000d100: 7565 207b 6e61 6d65 7d20 7c20 6772 6570  ue {name} | grep
-0000d110: 207b 6e61 6d65 7d2d 3120 7c20 6772 6570   {name}-1 | grep
-0000d120: 2052 554e 4e49 4e47 272c 0a20 2020 2020   RUNNING',.     
-0000d130: 2020 2020 2020 2066 2773 6b79 2071 7565         f'sky que
-0000d140: 7565 207b 6e61 6d65 7d20 7c20 6772 6570  ue {name} | grep
-0000d150: 207b 6e61 6d65 7d2d 3220 7c20 6772 6570   {name}-2 | grep
-0000d160: 2052 554e 4e49 4e47 272c 0a20 2020 2020   RUNNING',.     
-0000d170: 2020 2020 2020 2066 2773 6b79 2071 7565         f'sky que
-0000d180: 7565 207b 6e61 6d65 7d20 7c20 6772 6570  ue {name} | grep
-0000d190: 207b 6e61 6d65 7d2d 3320 7c20 6772 6570   {name}-3 | grep
-0000d1a0: 2050 454e 4449 4e47 272c 0a20 2020 2020   PENDING',.     
-0000d1b0: 2020 2020 2020 2066 2773 6b79 2063 616e         f'sky can
-0000d1c0: 6365 6c20 2d79 207b 6e61 6d65 7d20 3227  cel -y {name} 2'
-0000d1d0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0000d1e0: 6c65 6570 2035 272c 0a20 2020 2020 2020  leep 5',.       
-0000d1f0: 2020 2020 2066 2773 6b79 2071 7565 7565       f'sky queue
-0000d200: 207b 6e61 6d65 7d20 7c20 6772 6570 207b   {name} | grep {
-0000d210: 6e61 6d65 7d2d 3320 7c20 6772 6570 2052  name}-3 | grep R
-0000d220: 554e 4e49 4e47 272c 0a20 2020 2020 2020  UNNING',.       
-0000d230: 2020 2020 2066 2773 6b79 2063 616e 6365       f'sky cance
-0000d240: 6c20 2d79 207b 6e61 6d65 7d20 3327 2c0a  l -y {name} 3',.
-0000d250: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-0000d260: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-0000d270: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
-0000d280: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-0000d290: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-0000d2a0: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
-0000d2b0: 6163 6b20 2023 2046 6c75 6964 5374 6163  ack  # FluidStac
-0000d2c0: 6b20 4443 2068 6173 206c 6f77 2061 7661  k DC has low ava
-0000d2d0: 696c 6162 696c 6974 7920 6f66 2054 3420  ilability of T4 
-0000d2e0: 4750 5573 0a40 7079 7465 7374 2e6d 6172  GPUs.@pytest.mar
-0000d2f0: 6b2e 6e6f 5f6c 616d 6264 615f 636c 6f75  k.no_lambda_clou
-0000d300: 6420 2023 204c 616d 6264 6120 436c 6f75  d  # Lambda Clou
-0000d310: 6420 646f 6573 206e 6f74 2068 6176 6520  d does not have 
-0000d320: 5434 2067 7075 730a 4070 7974 6573 742e  T4 gpus.@pytest.
-0000d330: 6d61 726b 2e6e 6f5f 6962 6d20 2023 2049  mark.no_ibm  # I
-0000d340: 424d 2043 6c6f 7564 2064 6f65 7320 6e6f  BM Cloud does no
-0000d350: 7420 6861 7665 2054 3420 6770 7573 2e20  t have T4 gpus. 
-0000d360: 7275 6e20 7465 7374 5f69 626d 5f6a 6f62  run test_ibm_job
-0000d370: 5f71 7565 7565 5f6d 756c 7469 6e6f 6465  _queue_multinode
-0000d380: 2069 6e73 7465 6164 0a40 7079 7465 7374   instead.@pytest
-0000d390: 2e6d 6172 6b2e 6e6f 5f70 6170 6572 7370  .mark.no_papersp
-0000d3a0: 6163 6520 2023 2050 6170 6572 7370 6163  ace  # Paperspac
-0000d3b0: 6520 646f 6573 206e 6f74 2068 6176 6520  e does not have 
-0000d3c0: 5434 2067 7075 732e 0a40 7079 7465 7374  T4 gpus..@pytest
-0000d3d0: 2e6d 6172 6b2e 6e6f 5f73 6370 2020 2320  .mark.no_scp  # 
-0000d3e0: 5343 5020 646f 6573 206e 6f74 2073 7570  SCP does not sup
-0000d3f0: 706f 7274 206e 756d 5f6e 6f64 6573 203e  port num_nodes >
-0000d400: 2031 2079 6574 0a40 7079 7465 7374 2e6d   1 yet.@pytest.m
-0000d410: 6172 6b2e 6e6f 5f6f 6369 2020 2320 4f43  ark.no_oci  # OC
-0000d420: 4920 436c 6f75 6420 646f 6573 206e 6f74  I Cloud does not
-0000d430: 2068 6176 6520 5434 2067 7075 732e 0a40   have T4 gpus..@
-0000d440: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6b  pytest.mark.no_k
-0000d450: 7562 6572 6e65 7465 7320 2023 204b 7562  ubernetes  # Kub
-0000d460: 6572 6e65 7465 7320 6e6f 7420 7375 7070  ernetes not supp
-0000d470: 6f72 7420 6e75 6d5f 6e6f 6465 7320 3e20  ort num_nodes > 
-0000d480: 3120 7965 740a 6465 6620 7465 7374 5f6a  1 yet.def test_j
-0000d490: 6f62 5f71 7565 7565 5f6d 756c 7469 6e6f  ob_queue_multino
-0000d4a0: 6465 2867 656e 6572 6963 5f63 6c6f 7564  de(generic_cloud
-0000d4b0: 3a20 7374 7229 3a0a 2020 2020 6e61 6d65  : str):.    name
-0000d4c0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-0000d4d0: 6e61 6d65 2829 0a20 2020 2074 6f74 616c  name().    total
-0000d4e0: 5f74 696d 656f 7574 5f6d 696e 7574 6573  _timeout_minutes
-0000d4f0: 203d 2033 3020 6966 2067 656e 6572 6963   = 30 if generic
-0000d500: 5f63 6c6f 7564 203d 3d20 2761 7a75 7265  _cloud == 'azure
-0000d510: 2720 656c 7365 2031 350a 2020 2020 7465  ' else 15.    te
-0000d520: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-0000d530: 2020 2027 6a6f 625f 7175 6575 655f 6d75     'job_queue_mu
-0000d540: 6c74 696e 6f64 6527 2c0a 2020 2020 2020  ltinode',.      
-0000d550: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-0000d560: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-0000d570: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
-0000d580: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-0000d590: 7d20 6578 616d 706c 6573 2f6a 6f62 5f71  } examples/job_q
-0000d5a0: 7565 7565 2f63 6c75 7374 6572 5f6d 756c  ueue/cluster_mul
-0000d5b0: 7469 6e6f 6465 2e79 616d 6c27 2c0a 2020  tinode.yaml',.  
-0000d5c0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000d5d0: 6578 6563 207b 6e61 6d65 7d20 2d6e 207b  exec {name} -n {
-0000d5e0: 6e61 6d65 7d2d 3120 2d64 2065 7861 6d70  name}-1 -d examp
-0000d5f0: 6c65 732f 6a6f 625f 7175 6575 652f 6a6f  les/job_queue/jo
-0000d600: 625f 6d75 6c74 696e 6f64 652e 7961 6d6c  b_multinode.yaml
-0000d610: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000d620: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-0000d630: 202d 6e20 7b6e 616d 657d 2d32 202d 6420   -n {name}-2 -d 
-0000d640: 6578 616d 706c 6573 2f6a 6f62 5f71 7565  examples/job_que
-0000d650: 7565 2f6a 6f62 5f6d 756c 7469 6e6f 6465  ue/job_multinode
-0000d660: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-0000d670: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-0000d680: 202d 6320 7b6e 616d 657d 202d 6e20 7b6e   -c {name} -n {n
-0000d690: 616d 657d 2d33 202d 2d64 6574 6163 682d  ame}-3 --detach-
-0000d6a0: 7365 7475 7020 2d64 2065 7861 6d70 6c65  setup -d example
-0000d6b0: 732f 6a6f 625f 7175 6575 652f 6a6f 625f  s/job_queue/job_
-0000d6c0: 6d75 6c74 696e 6f64 652e 7961 6d6c 272c  multinode.yaml',
-0000d6d0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000d6e0: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
-0000d6f0: 6d65 7d29 2026 2620 6563 686f 2022 2473  me}) && echo "$s
-0000d700: 2220 2626 2028 6563 686f 2022 2473 2220  " && (echo "$s" 
-0000d710: 7c20 6772 6570 207b 6e61 6d65 7d2d 3120  | grep {name}-1 
-0000d720: 7c20 6772 6570 2052 554e 4e49 4e47 2927  | grep RUNNING)'
-0000d730: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000d740: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
-0000d750: 616d 657d 2920 2626 2065 6368 6f20 2224  ame}) && echo "$
-0000d760: 7322 2026 2620 2865 6368 6f20 2224 7322  s" && (echo "$s"
-0000d770: 207c 2067 7265 7020 7b6e 616d 657d 2d32   | grep {name}-2
-0000d780: 207c 2067 7265 7020 5255 4e4e 494e 4729   | grep RUNNING)
-0000d790: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000d7a0: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
-0000d7b0: 6e61 6d65 7d29 2026 2620 6563 686f 2022  name}) && echo "
-0000d7c0: 2473 2220 2626 2028 6563 686f 2022 2473  $s" && (echo "$s
-0000d7d0: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
-0000d7e0: 3320 7c20 6772 6570 2050 454e 4449 4e47  3 | grep PENDING
-0000d7f0: 2927 2c0a 2020 2020 2020 2020 2020 2020  )',.            
-0000d800: 2773 6c65 6570 2039 3027 2c0a 2020 2020  'sleep 90',.    
-0000d810: 2020 2020 2020 2020 6627 736b 7920 6361          f'sky ca
-0000d820: 6e63 656c 202d 7920 7b6e 616d 657d 2031  ncel -y {name} 1
-0000d830: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-0000d840: 736c 6565 7020 3527 2c0a 2020 2020 2020  sleep 5',.      
-0000d850: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
-0000d860: 7175 6575 6520 7b6e 616d 657d 293b 2065  queue {name}); e
-0000d870: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
-0000d880: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
-0000d890: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
-0000d8a0: 7c20 6772 6570 2053 4554 5449 4e47 5f55  | grep SETTING_U
-0000d8b0: 5027 2c0a 2020 2020 2020 2020 2020 2020  P',.            
-0000d8c0: 6627 736b 7920 6361 6e63 656c 202d 7920  f'sky cancel -y 
-0000d8d0: 7b6e 616d 657d 2031 2032 2033 272c 0a20  {name} 1 2 3',. 
-0000d8e0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000d8f0: 206c 6175 6e63 6820 2d63 207b 6e61 6d65   launch -c {name
-0000d900: 7d20 2d6e 207b 6e61 6d65 7d2d 3420 2d2d  } -n {name}-4 --
-0000d910: 6465 7461 6368 2d73 6574 7570 202d 6420  detach-setup -d 
-0000d920: 6578 616d 706c 6573 2f6a 6f62 5f71 7565  examples/job_que
-0000d930: 7565 2f6a 6f62 5f6d 756c 7469 6e6f 6465  ue/job_multinode
-0000d940: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-0000d950: 2020 2020 2320 5465 7374 2074 6865 206a      # Test the j
-0000d960: 6f62 2073 7461 7475 7320 6973 2063 6f72  ob status is cor
-0000d970: 7265 6374 6c79 2073 6574 2074 6f20 5345  rectly set to SE
-0000d980: 5454 494e 475f 5550 2c20 6475 7269 6e67  TTING_UP, during
-0000d990: 2074 6865 2073 6574 7570 2069 7320 7275   the setup is ru
-0000d9a0: 6e6e 696e 672c 0a20 2020 2020 2020 2020  nning,.         
-0000d9b0: 2020 2023 2061 6e64 2074 6865 206a 6f62     # and the job
-0000d9c0: 2063 616e 2062 6520 6361 6e63 656c 6c65   can be cancelle
-0000d9d0: 6420 6475 7269 6e67 2074 6865 2073 6574  d during the set
-0000d9e0: 7570 2e0a 2020 2020 2020 2020 2020 2020  up..            
-0000d9f0: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
-0000da00: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-0000da10: 2071 7565 7565 207b 6e61 6d65 7d29 2026   queue {name}) &
-0000da20: 2620 6563 686f 2022 2473 2220 2626 2028  & echo "$s" && (
-0000da30: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-0000da40: 207b 6e61 6d65 7d2d 3420 7c20 6772 6570   {name}-4 | grep
-0000da50: 2053 4554 5449 4e47 5f55 5029 272c 0a20   SETTING_UP)',. 
-0000da60: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000da70: 2063 616e 6365 6c20 2d79 207b 6e61 6d65   cancel -y {name
-0000da80: 7d20 3427 2c0a 2020 2020 2020 2020 2020  } 4',.          
-0000da90: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
-0000daa0: 6520 7b6e 616d 657d 2920 2626 2065 6368  e {name}) && ech
-0000dab0: 6f20 2224 7322 2026 2620 2865 6368 6f20  o "$s" && (echo 
-0000dac0: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
-0000dad0: 657d 2d34 207c 2067 7265 7020 4341 4e43  e}-4 | grep CANC
-0000dae0: 454c 4c45 4429 272c 0a20 2020 2020 2020  ELLED)',.       
-0000daf0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-0000db00: 7b6e 616d 657d 202d 2d67 7075 7320 5434  {name} --gpus T4
-0000db10: 3a30 2e32 2022 5b5b 205c 2453 4b59 5049  :0.2 "[[ \$SKYPI
-0000db20: 4c4f 545f 4e55 4d5f 4750 5553 5f50 4552  LOT_NUM_GPUS_PER
-0000db30: 5f4e 4f44 4520 2d65 7120 3120 5d5d 207c  _NODE -eq 1 ]] |
-0000db40: 7c20 6578 6974 2031 2227 2c0a 2020 2020  | exit 1"',.    
-0000db50: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-0000db60: 6563 207b 6e61 6d65 7d20 2d2d 6770 7573  ec {name} --gpus
-0000db70: 2054 343a 302e 3220 2d2d 6e75 6d2d 6e6f   T4:0.2 --num-no
-0000db80: 6465 7320 3220 225b 5b20 5c24 534b 5950  des 2 "[[ \$SKYP
-0000db90: 494c 4f54 5f4e 554d 5f47 5055 535f 5045  ILOT_NUM_GPUS_PE
-0000dba0: 525f 4e4f 4445 202d 6571 2031 205d 5d20  R_NODE -eq 1 ]] 
-0000dbb0: 7c7c 2065 7869 7420 3122 272c 0a20 2020  || exit 1"',.   
-0000dbc0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-0000dbd0: 7865 6320 7b6e 616d 657d 202d 2d67 7075  xec {name} --gpu
-0000dbe0: 7320 5434 3a31 202d 2d6e 756d 2d6e 6f64  s T4:1 --num-nod
-0000dbf0: 6573 2032 2022 5b5b 205c 2453 4b59 5049  es 2 "[[ \$SKYPI
-0000dc00: 4c4f 545f 4e55 4d5f 4750 5553 5f50 4552  LOT_NUM_GPUS_PER
-0000dc10: 5f4e 4f44 4520 2d65 7120 3120 5d5d 207c  _NODE -eq 1 ]] |
-0000dc20: 7c20 6578 6974 2031 2227 2c0a 2020 2020  | exit 1"',.    
-0000dc30: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-0000dc40: 6773 207b 6e61 6d65 7d20 3520 2d2d 7374  gs {name} 5 --st
-0000dc50: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
-0000dc60: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-0000dc70: 616d 657d 2036 202d 2d73 7461 7475 7327  ame} 6 --status'
-0000dc80: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000dc90: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0000dca0: 3720 2d2d 7374 6174 7573 272c 0a20 2020  7 --status',.   
-0000dcb0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0000dcc0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-0000dcd0: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
-0000dce0: 696d 656f 7574 3d74 6f74 616c 5f74 696d  imeout=total_tim
-0000dcf0: 656f 7574 5f6d 696e 7574 6573 202a 2036  eout_minutes * 6
-0000dd00: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
-0000dd10: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-0000dd20: 0a0a 4070 7974 6573 742e 6d61 726b 2e6e  ..@pytest.mark.n
-0000dd30: 6f5f 6c61 6d62 6461 5f63 6c6f 7564 2020  o_lambda_cloud  
-0000dd40: 2320 4e6f 204c 616d 6264 6120 436c 6f75  # No Lambda Clou
-0000dd50: 6420 564d 2068 6173 2038 2043 5055 730a  d VM has 8 CPUs.
-0000dd60: 6465 6620 7465 7374 5f6c 6172 6765 5f6a  def test_large_j
-0000dd70: 6f62 5f71 7565 7565 2867 656e 6572 6963  ob_queue(generic
-0000dd80: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
-0000dd90: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-0000dda0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-0000ddb0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-0000ddc0: 2020 2020 2020 276c 6172 6765 5f6a 6f62        'large_job
-0000ddd0: 5f71 7565 7565 272c 0a20 2020 2020 2020  _queue',.       
-0000dde0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-0000ddf0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-0000de00: 6320 7b6e 616d 657d 202d 2d63 7075 7320  c {name} --cpus 
-0000de10: 3820 2d2d 636c 6f75 6420 7b67 656e 6572  8 --cloud {gener
-0000de20: 6963 5f63 6c6f 7564 7d27 2c0a 2020 2020  ic_cloud}',.    
-0000de30: 2020 2020 2020 2020 6627 666f 7220 6920          f'for i 
-0000de40: 696e 2060 7365 7120 3120 3735 603b 2064  in `seq 1 75`; d
-0000de50: 6f20 736b 7920 6578 6563 207b 6e61 6d65  o sky exec {name
-0000de60: 7d20 2d6e 207b 6e61 6d65 7d2d 2469 202d  } -n {name}-$i -
-0000de70: 6420 2265 6368 6f20 2469 3b20 736c 6565  d "echo $i; slee
-0000de80: 7020 3130 3030 3030 3030 3022 3b20 646f  p 100000000"; do
-0000de90: 6e65 272c 0a20 2020 2020 2020 2020 2020  ne',.           
-0000dea0: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
-0000deb0: 207b 6e61 6d65 7d20 3120 3220 3320 3420   {name} 1 2 3 4 
-0000dec0: 3520 3620 3720 3820 3920 3130 2031 3120  5 6 7 8 9 10 11 
-0000ded0: 3132 2031 3320 3134 2031 3520 3136 272c  12 13 14 15 16',
-0000dee0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0000def0: 6565 7020 3930 272c 0a20 2020 2020 2020  eep 90',.       
-0000df00: 2020 2020 2023 2045 6163 6820 6a6f 6220       # Each job 
-0000df10: 7461 6b65 7320 302e 3520 4350 5520 616e  takes 0.5 CPU an
-0000df20: 6420 7468 6520 6465 6661 756c 7420 564d  d the default VM
-0000df30: 2068 6173 2038 2043 5055 732c 2073 6f20   has 8 CPUs, so 
-0000df40: 7468 6572 6520 7368 6f75 6c64 2062 6520  there should be 
-0000df50: 3820 2f20 302e 3520 3d20 3136 206a 6f62  8 / 0.5 = 16 job
-0000df60: 7320 7275 6e6e 696e 672e 0a20 2020 2020  s running..     
-0000df70: 2020 2020 2020 2023 2054 6865 2066 6972         # The fir
-0000df80: 7374 2031 3620 6a6f 6273 2061 7265 2063  st 16 jobs are c
-0000df90: 616e 6365 6c65 642c 2073 6f20 7468 6572  anceled, so ther
-0000dfa0: 6520 7368 6f75 6c64 2062 6520 3735 202d  e should be 75 -
-0000dfb0: 2033 3220 3d20 3433 206a 6f62 7320 5045   32 = 43 jobs PE
-0000dfc0: 4e44 494e 472e 0a20 2020 2020 2020 2020  NDING..         
-0000dfd0: 2020 2066 2773 3d24 2873 6b79 2071 7565     f's=$(sky que
-0000dfe0: 7565 207b 6e61 6d65 7d29 3b20 6563 686f  ue {name}); echo
-0000dff0: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
-0000e000: 6f3b 2065 6368 6f20 2224 7322 207c 2067  o; echo "$s" | g
-0000e010: 7265 7020 2d76 2067 7265 7020 7c20 6772  rep -v grep | gr
-0000e020: 6570 2050 454e 4449 4e47 207c 2077 6320  ep PENDING | wc 
-0000e030: 2d6c 207c 2067 7265 7020 3433 272c 0a20  -l | grep 43',. 
-0000e040: 2020 2020 2020 2020 2020 2023 204d 616b             # Mak
-0000e050: 6520 7375 7265 2074 6865 206a 6f62 7320  e sure the jobs 
-0000e060: 6172 6520 7363 6865 6475 6c65 6420 696e  are scheduled in
-0000e070: 2046 4946 4f20 6f72 6465 720a 2020 2020   FIFO order.    
-0000e080: 2020 2020 2020 2020 2a5b 0a20 2020 2020          *[.     
-0000e090: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-0000e0a0: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
-0000e0b0: 7d29 3b20 6563 686f 2022 2473 223b 2065  }); echo "$s"; e
-0000e0c0: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
-0000e0d0: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
-0000e0e0: 657d 2d7b 697d 207c 2067 7265 7020 4341  e}-{i} | grep CA
-0000e0f0: 4e43 454c 4c45 4427 0a20 2020 2020 2020  NCELLED'.       
-0000e100: 2020 2020 2020 2020 2066 6f72 2069 2069           for i i
-0000e110: 6e20 7261 6e67 6528 312c 2031 3729 0a20  n range(1, 17). 
-0000e120: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
-0000e130: 2020 2020 2020 2020 2020 2a5b 0a20 2020            *[.   
-0000e140: 2020 2020 2020 2020 2020 2020 2066 2773               f's
-0000e150: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
-0000e160: 6d65 7d29 3b20 6563 686f 2022 2473 223b  me}); echo "$s";
-0000e170: 2065 6368 6f3b 2065 6368 6f3b 2065 6368   echo; echo; ech
-0000e180: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
-0000e190: 616d 657d 2d7b 697d 207c 2067 7265 7020  ame}-{i} | grep 
-0000e1a0: 5255 4e4e 494e 4727 0a20 2020 2020 2020  RUNNING'.       
-0000e1b0: 2020 2020 2020 2020 2066 6f72 2069 2069           for i i
-0000e1c0: 6e20 7261 6e67 6528 3137 2c20 3333 290a  n range(17, 33).
-0000e1d0: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
-0000e1e0: 2020 2020 2020 2020 2020 202a 5b0a 2020             *[.  
-0000e1f0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-0000e200: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
-0000e210: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
-0000e220: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
-0000e230: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
-0000e240: 6e61 6d65 7d2d 7b69 7d20 7c20 6772 6570  name}-{i} | grep
-0000e250: 2050 454e 4449 4e47 270a 2020 2020 2020   PENDING'.      
-0000e260: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
-0000e270: 696e 2072 616e 6765 2833 332c 2037 3529  in range(33, 75)
-0000e280: 0a20 2020 2020 2020 2020 2020 205d 2c0a  .            ],.
-0000e290: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000e2a0: 7920 6361 6e63 656c 202d 7920 7b6e 616d  y cancel -y {nam
-0000e2b0: 657d 2033 3320 3335 2033 3720 3339 2031  e} 33 35 37 39 1
-0000e2c0: 3720 3138 2031 3927 2c0a 2020 2020 2020  7 18 19',.      
-0000e2d0: 2020 2020 2020 2a5b 0a20 2020 2020 2020        *[.       
-0000e2e0: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-0000e2f0: 6b79 2071 7565 7565 207b 6e61 6d65 7d29  ky queue {name})
-0000e300: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
-0000e310: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
-0000e320: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
-0000e330: 2d7b 697d 207c 2067 7265 7020 4341 4e43  -{i} | grep CANC
-0000e340: 454c 4c45 4427 0a20 2020 2020 2020 2020  ELLED'.         
-0000e350: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
-0000e360: 7261 6e67 6528 3333 2c20 3430 2c20 3229  range(33, 40, 2)
-0000e370: 0a20 2020 2020 2020 2020 2020 205d 2c0a  .            ],.
-0000e380: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-0000e390: 6570 2031 3027 2c0a 2020 2020 2020 2020  ep 10',.        
-0000e3a0: 2020 2020 2a5b 0a20 2020 2020 2020 2020      *[.         
-0000e3b0: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-0000e3c0: 2071 7565 7565 207b 6e61 6d65 7d29 3b20   queue {name}); 
-0000e3d0: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
-0000e3e0: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
-0000e3f0: 207c 2067 7265 7020 7b6e 616d 657d 2d7b   | grep {name}-{
-0000e400: 697d 207c 2067 7265 7020 5255 4e4e 494e  i} | grep RUNNIN
-0000e410: 4727 0a20 2020 2020 2020 2020 2020 2020  G'.             
-0000e420: 2020 2066 6f72 2069 2069 6e20 5b33 342c     for i in [34,
-0000e430: 2033 362c 2033 385d 0a20 2020 2020 2020   36, 38].       
-0000e440: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0000e450: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-0000e460: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-0000e470: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-0000e480: 743d 3235 202a 2036 302c 0a20 2020 2029  t=25 * 60,.    )
-0000e490: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-0000e4a0: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-0000e4b0: 742e 6d61 726b 2e6e 6f5f 6c61 6d62 6461  t.mark.no_lambda
-0000e4c0: 5f63 6c6f 7564 2020 2320 4e6f 204c 616d  _cloud  # No Lam
-0000e4d0: 6264 6120 436c 6f75 6420 564d 2068 6173  bda Cloud VM has
-0000e4e0: 2038 2043 5055 730a 6465 6620 7465 7374   8 CPUs.def test
-0000e4f0: 5f66 6173 745f 6c61 7267 655f 6a6f 625f  _fast_large_job_
-0000e500: 7175 6575 6528 6765 6e65 7269 635f 636c  queue(generic_cl
-0000e510: 6f75 643a 2073 7472 293a 0a20 2020 2023  oud: str):.    #
-0000e520: 2054 6869 7320 6973 2074 6f20 7465 7374   This is to test
-0000e530: 2074 6865 206a 6f62 7320 6361 6e20 6265   the jobs can be
-0000e540: 2073 6368 6564 756c 6564 2071 7569 636b   scheduled quick
-0000e550: 6c79 2077 6865 6e20 7468 6572 6520 6172  ly when there ar
-0000e560: 6520 6d61 6e79 206a 6f62 7320 696e 2074  e many jobs in t
-0000e570: 6865 2071 7565 7565 2e0a 2020 2020 6e61  he queue..    na
-0000e580: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-0000e590: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-0000e5a0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-0000e5b0: 2020 2766 6173 745f 6c61 7267 655f 6a6f    'fast_large_jo
-0000e5c0: 625f 7175 6575 6527 2c0a 2020 2020 2020  b_queue',.      
-0000e5d0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-0000e5e0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-0000e5f0: 2d63 207b 6e61 6d65 7d20 2d2d 6370 7573  -c {name} --cpus
-0000e600: 2038 202d 2d63 6c6f 7564 207b 6765 6e65   8 --cloud {gene
-0000e610: 7269 635f 636c 6f75 647d 272c 0a20 2020  ric_cloud}',.   
-0000e620: 2020 2020 2020 2020 2066 2766 6f72 2069           f'for i
-0000e630: 2069 6e20 6073 6571 2031 2033 3260 3b20   in `seq 1 32`; 
-0000e640: 646f 2073 6b79 2065 7865 6320 7b6e 616d  do sky exec {nam
-0000e650: 657d 202d 6e20 7b6e 616d 657d 2d24 6920  e} -n {name}-$i 
-0000e660: 2d64 2022 6563 686f 2024 6922 3b20 646f  -d "echo $i"; do
-0000e670: 6e65 272c 0a20 2020 2020 2020 2020 2020  ne',.           
-0000e680: 2027 736c 6565 7020 3630 272c 0a20 2020   'sleep 60',.   
-0000e690: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-0000e6a0: 6b79 2071 7565 7565 207b 6e61 6d65 7d29  ky queue {name})
-0000e6b0: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
-0000e6c0: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
-0000e6d0: 7322 207c 2067 7265 7020 2d76 2067 7265  s" | grep -v gre
-0000e6e0: 7020 7c20 6772 6570 2053 5543 4345 4544  p | grep SUCCEED
-0000e6f0: 4544 207c 2077 6320 2d6c 207c 2067 7265  ED | wc -l | gre
-0000e700: 7020 3332 272c 0a20 2020 2020 2020 205d  p 32',.        ]
-0000e710: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-0000e720: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-0000e730: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-0000e740: 3d32 3020 2a20 3630 2c0a 2020 2020 290a  =20 * 60,.    ).
-0000e750: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-0000e760: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-0000e770: 2e6d 6172 6b2e 6962 6d0a 6465 6620 7465  .mark.ibm.def te
-0000e780: 7374 5f69 626d 5f6a 6f62 5f71 7565 7565  st_ibm_job_queue
-0000e790: 5f6d 756c 7469 6e6f 6465 2829 3a0a 2020  _multinode():.  
-0000e7a0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-0000e7b0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-0000e7c0: 2074 6173 6b5f 6669 6c65 203d 2027 6578   task_file = 'ex
-0000e7d0: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
-0000e7e0: 2f6a 6f62 5f6d 756c 7469 6e6f 6465 5f69  /job_multinode_i
-0000e7f0: 626d 2e79 616d 6c27 0a20 2020 2074 6573  bm.yaml'.    tes
-0000e800: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-0000e810: 2020 2769 626d 5f6a 6f62 5f71 7565 7565    'ibm_job_queue
-0000e820: 5f6d 756c 7469 6e6f 6465 272c 0a20 2020  _multinode',.   
-0000e830: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-0000e840: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-0000e850: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
-0000e860: 6c6f 7564 2069 626d 202d 2d67 7075 7320  loud ibm --gpus 
-0000e870: 7631 3030 202d 2d6e 756d 2d6e 6f64 6573  v100 --num-nodes
-0000e880: 2032 272c 0a20 2020 2020 2020 2020 2020   2',.           
-0000e890: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-0000e8a0: 657d 202d 6e20 7b6e 616d 657d 2d31 202d  e} -n {name}-1 -
-0000e8b0: 6420 7b74 6173 6b5f 6669 6c65 7d27 2c0a  d {task_file}',.
-0000e8c0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000e8d0: 7920 6578 6563 207b 6e61 6d65 7d20 2d6e  y exec {name} -n
-0000e8e0: 207b 6e61 6d65 7d2d 3220 2d64 207b 7461   {name}-2 -d {ta
-0000e8f0: 736b 5f66 696c 657d 272c 0a20 2020 2020  sk_file}',.     
-0000e900: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-0000e910: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-0000e920: 202d 6e20 7b6e 616d 657d 2d33 202d 2d64   -n {name}-3 --d
-0000e930: 6574 6163 682d 7365 7475 7020 2d64 207b  etach-setup -d {
-0000e940: 7461 736b 5f66 696c 657d 272c 0a20 2020  task_file}',.   
-0000e950: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-0000e960: 6b79 2071 7565 7565 207b 6e61 6d65 7d29  ky queue {name})
-0000e970: 2026 2620 7072 696e 7466 2022 2473 2220   && printf "$s" 
-0000e980: 2626 2028 6563 686f 2022 2473 2220 7c20  && (echo "$s" | 
-0000e990: 6772 6570 207b 6e61 6d65 7d2d 3120 7c20  grep {name}-1 | 
-0000e9a0: 6772 6570 2052 554e 4e49 4e47 2927 2c0a  grep RUNNING)',.
-0000e9b0: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
-0000e9c0: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
-0000e9d0: 657d 2920 2626 2070 7269 6e74 6620 2224  e}) && printf "$
-0000e9e0: 7322 2026 2620 2865 6368 6f20 2224 7322  s" && (echo "$s"
-0000e9f0: 207c 2067 7265 7020 7b6e 616d 657d 2d32   | grep {name}-2
-0000ea00: 207c 2067 7265 7020 5255 4e4e 494e 4729   | grep RUNNING)
-0000ea10: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000ea20: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
-0000ea30: 6e61 6d65 7d29 2026 2620 7072 696e 7466  name}) && printf
-0000ea40: 2022 2473 2220 2626 2028 6563 686f 2022   "$s" && (echo "
-0000ea50: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
-0000ea60: 7d2d 3320 7c20 6772 6570 2053 4554 5449  }-3 | grep SETTI
-0000ea70: 4e47 5f55 5029 272c 0a20 2020 2020 2020  NG_UP)',.       
-0000ea80: 2020 2020 2027 736c 6565 7020 3930 272c       'sleep 90',
-0000ea90: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000eaa0: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
-0000eab0: 6d65 7d29 2026 2620 7072 696e 7466 2022  me}) && printf "
-0000eac0: 2473 2220 2626 2028 6563 686f 2022 2473  $s" && (echo "$s
-0000ead0: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
-0000eae0: 3320 7c20 6772 6570 2050 454e 4449 4e47  3 | grep PENDING
-0000eaf0: 2927 2c0a 2020 2020 2020 2020 2020 2020  )',.            
-0000eb00: 6627 736b 7920 6361 6e63 656c 202d 7920  f'sky cancel -y 
-0000eb10: 7b6e 616d 657d 2031 272c 0a20 2020 2020  {name} 1',.     
-0000eb20: 2020 2020 2020 2027 736c 6565 7020 3527         'sleep 5'
-0000eb30: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000eb40: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
-0000eb50: 207c 2067 7265 7020 7b6e 616d 657d 2d33   | grep {name}-3
-0000eb60: 207c 2067 7265 7020 5255 4e4e 494e 4727   | grep RUNNING'
-0000eb70: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000eb80: 736b 7920 6361 6e63 656c 202d 7920 7b6e  sky cancel -y {n
-0000eb90: 616d 657d 2031 2032 2033 272c 0a20 2020  ame} 1 2 3',.   
-0000eba0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000ebb0: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
-0000ebc0: 2d6e 207b 6e61 6d65 7d2d 3420 2d2d 6465  -n {name}-4 --de
-0000ebd0: 7461 6368 2d73 6574 7570 202d 6420 7b74  tach-setup -d {t
-0000ebe0: 6173 6b5f 6669 6c65 7d27 2c0a 2020 2020  ask_file}',.    
-0000ebf0: 2020 2020 2020 2020 2320 5465 7374 2074          # Test t
-0000ec00: 6865 206a 6f62 2073 7461 7475 7320 6973  he job status is
-0000ec10: 2063 6f72 7265 6374 6c79 2073 6574 2074   correctly set t
-0000ec20: 6f20 5345 5454 494e 475f 5550 2c20 6475  o SETTING_UP, du
-0000ec30: 7269 6e67 2074 6865 2073 6574 7570 2069  ring the setup i
-0000ec40: 7320 7275 6e6e 696e 672c 0a20 2020 2020  s running,.     
-0000ec50: 2020 2020 2020 2023 2061 6e64 2074 6865         # and the
-0000ec60: 206a 6f62 2063 616e 2062 6520 6361 6e63   job can be canc
-0000ec70: 656c 6c65 6420 6475 7269 6e67 2074 6865  elled during the
-0000ec80: 2073 6574 7570 2e0a 2020 2020 2020 2020   setup..        
-0000ec90: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
-0000eca0: 6575 6520 7b6e 616d 657d 2920 2626 2070  eue {name}) && p
-0000ecb0: 7269 6e74 6620 2224 7322 2026 2620 2865  rintf "$s" && (e
-0000ecc0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-0000ecd0: 7b6e 616d 657d 2d34 207c 2067 7265 7020  {name}-4 | grep 
-0000ece0: 5345 5454 494e 475f 5550 2927 2c0a 2020  SETTING_UP)',.  
-0000ecf0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000ed00: 6361 6e63 656c 202d 7920 7b6e 616d 657d  cancel -y {name}
-0000ed10: 2034 272c 0a20 2020 2020 2020 2020 2020   4',.           
-0000ed20: 2066 2773 3d24 2873 6b79 2071 7565 7565   f's=$(sky queue
-0000ed30: 207b 6e61 6d65 7d29 2026 2620 7072 696e   {name}) && prin
-0000ed40: 7466 2022 2473 2220 2626 2028 6563 686f  tf "$s" && (echo
-0000ed50: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
-0000ed60: 6d65 7d2d 3420 7c20 6772 6570 2043 414e  me}-4 | grep CAN
-0000ed70: 4345 4c4c 4544 2927 2c0a 2020 2020 2020  CELLED)',.      
-0000ed80: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-0000ed90: 207b 6e61 6d65 7d20 2d2d 6770 7573 2076   {name} --gpus v
-0000eda0: 3130 303a 302e 3220 225b 5b20 5c24 534b  100:0.2 "[[ \$SK
-0000edb0: 5950 494c 4f54 5f4e 554d 5f47 5055 535f  YPILOT_NUM_GPUS_
-0000edc0: 5045 525f 4e4f 4445 202d 6571 2031 205d  PER_NODE -eq 1 ]
-0000edd0: 5d20 7c7c 2065 7869 7420 3122 272c 0a20  ] || exit 1"',. 
-0000ede0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000edf0: 2065 7865 6320 7b6e 616d 657d 202d 2d67   exec {name} --g
-0000ee00: 7075 7320 7631 3030 3a30 2e32 202d 2d6e  pus v100:0.2 --n
-0000ee10: 756d 2d6e 6f64 6573 2032 2022 5b5b 205c  um-nodes 2 "[[ \
-0000ee20: 2453 4b59 5049 4c4f 545f 4e55 4d5f 4750  $SKYPILOT_NUM_GP
-0000ee30: 5553 5f50 4552 5f4e 4f44 4520 2d65 7120  US_PER_NODE -eq 
-0000ee40: 3120 5d5d 207c 7c20 6578 6974 2031 2227  1 ]] || exit 1"'
-0000ee50: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000ee60: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-0000ee70: 2d2d 6770 7573 2076 3130 303a 3120 2d2d  --gpus v100:1 --
-0000ee80: 6e75 6d2d 6e6f 6465 7320 3220 225b 5b20  num-nodes 2 "[[ 
-0000ee90: 5c24 534b 5950 494c 4f54 5f4e 554d 5f47  \$SKYPILOT_NUM_G
-0000eea0: 5055 535f 5045 525f 4e4f 4445 202d 6571  PUS_PER_NODE -eq
-0000eeb0: 2031 205d 5d20 7c7c 2065 7869 7420 3122   1 ]] || exit 1"
-0000eec0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000eed0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0000eee0: 2035 202d 2d73 7461 7475 7327 2c0a 2020   5 --status',.  
-0000eef0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000ef00: 6c6f 6773 207b 6e61 6d65 7d20 3620 2d2d  logs {name} 6 --
-0000ef10: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-0000ef20: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-0000ef30: 7b6e 616d 657d 2037 202d 2d73 7461 7475  {name} 7 --statu
-0000ef40: 7327 2c0a 2020 2020 2020 2020 5d2c 0a20  s',.        ],. 
-0000ef50: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-0000ef60: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-0000ef70: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
-0000ef80: 202a 2036 302c 2020 2320 3230 206d 696e   * 60,  # 20 min
-0000ef90: 730a 2020 2020 290a 2020 2020 7275 6e5f  s.    ).    run_
-0000efa0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-0000efb0: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 446f  .# ---------- Do
-0000efc0: 636b 6572 2077 6974 6820 7072 6569 6e73  cker with preins
-0000efd0: 7461 6c6c 6564 2070 6163 6b61 6765 2e20  talled package. 
-0000efe0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
-0000eff0: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
-0000f000: 7374 6163 6b20 2023 2044 6f65 736e 2774  stack  # Doesn't
-0000f010: 2073 7570 706f 7274 2046 6c75 6964 7374   support Fluidst
-0000f020: 6163 6b20 666f 7220 6e6f 770a 4070 7974  ack for now.@pyt
-0000f030: 6573 742e 6d61 726b 2e6e 6f5f 6c61 6d62  est.mark.no_lamb
-0000f040: 6461 5f63 6c6f 7564 2020 2320 446f 6573  da_cloud  # Does
-0000f050: 6e27 7420 7375 7070 6f72 7420 4c61 6d62  n't support Lamb
-0000f060: 6461 2043 6c6f 7564 2066 6f72 206e 6f77  da Cloud for now
-0000f070: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-0000f080: 5f69 626d 2020 2320 446f 6573 6e27 7420  _ibm  # Doesn't 
-0000f090: 7375 7070 6f72 7420 4942 4d20 436c 6f75  support IBM Clou
-0000f0a0: 6420 666f 7220 6e6f 770a 4070 7974 6573  d for now.@pytes
-0000f0b0: 742e 6d61 726b 2e6e 6f5f 7363 7020 2023  t.mark.no_scp  #
-0000f0c0: 2044 6f65 736e 2774 2073 7570 706f 7274   Doesn't support
-0000f0d0: 2053 4350 2066 6f72 206e 6f77 0a40 7079   SCP for now.@py
-0000f0e0: 7465 7374 2e6d 6172 6b2e 6e6f 5f6f 6369  test.mark.no_oci
-0000f0f0: 2020 2320 446f 6573 6e27 7420 7375 7070    # Doesn't supp
-0000f100: 6f72 7420 4f43 4920 666f 7220 6e6f 770a  ort OCI for now.
-0000f110: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-0000f120: 6b75 6265 726e 6574 6573 2020 2320 446f  kubernetes  # Do
-0000f130: 6573 6e27 7420 7375 7070 6f72 7420 4b75  esn't support Ku
-0000f140: 6265 726e 6574 6573 2066 6f72 206e 6f77  bernetes for now
-0000f150: 0a23 2054 4f44 4f28 7a68 7775 293a 2077  .# TODO(zhwu): w
-0000f160: 6520 7368 6f75 6c64 2066 6978 2074 6869  e should fix thi
-0000f170: 7320 666f 7220 6b75 6265 726e 6574 6573  s for kubernetes
-0000f180: 0a64 6566 2074 6573 745f 646f 636b 6572  .def test_docker
-0000f190: 5f70 7265 696e 7374 616c 6c65 645f 7061  _preinstalled_pa
-0000f1a0: 636b 6167 6528 6765 6e65 7269 635f 636c  ckage(generic_cl
-0000f1b0: 6f75 643a 2073 7472 293a 0a20 2020 206e  oud: str):.    n
-0000f1c0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-0000f1d0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-0000f1e0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-0000f1f0: 2020 2027 646f 636b 6572 5f77 6974 685f     'docker_with_
-0000f200: 7072 6569 6e73 7461 6c6c 6564 5f70 6163  preinstalled_pac
-0000f210: 6b61 6765 272c 0a20 2020 2020 2020 205b  kage',.        [
-0000f220: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000f230: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-0000f240: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
-0000f250: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
-0000f260: 2d69 6d61 6765 2d69 6420 646f 636b 6572  -image-id docker
-0000f270: 3a6e 6769 6e78 272c 0a20 2020 2020 2020  :nginx',.       
-0000f280: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-0000f290: 7b6e 616d 657d 2022 6e67 696e 7820 2d56  {name} "nginx -V
-0000f2a0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-0000f2b0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-0000f2c0: 7d20 3120 2d2d 7374 6174 7573 272c 0a20  } 1 --status',. 
-0000f2d0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000f2e0: 2065 7865 6320 7b6e 616d 657d 2077 686f   exec {name} who
-0000f2f0: 616d 6920 7c20 6772 6570 2072 6f6f 7427  ami | grep root'
-0000f300: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-0000f310: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-0000f320: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-0000f330: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-0000f340: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-0000f350: 2d2d 2d2d 2d2d 2d20 5375 626d 6974 7469  ------- Submitti
-0000f360: 6e67 206d 756c 7469 706c 6520 7461 736b  ng multiple task
-0000f370: 7320 746f 2074 6865 2073 616d 6520 636c  s to the same cl
-0000f380: 7573 7465 722e 202d 2d2d 2d2d 2d2d 2d2d  uster. ---------
-0000f390: 2d0a 4070 7974 6573 742e 6d61 726b 2e6e  -.@pytest.mark.n
-0000f3a0: 6f5f 666c 7569 6473 7461 636b 2020 2320  o_fluidstack  # 
-0000f3b0: 466c 7569 6453 7461 636b 2044 4320 6861  FluidStack DC ha
-0000f3c0: 7320 6c6f 7720 6176 6169 6c61 6269 6c69  s low availabili
-0000f3d0: 7479 206f 6620 5434 2047 5055 730a 4070  ty of T4 GPUs.@p
-0000f3e0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6c61  ytest.mark.no_la
-0000f3f0: 6d62 6461 5f63 6c6f 7564 2020 2320 4c61  mbda_cloud  # La
-0000f400: 6d62 6461 2043 6c6f 7564 2064 6f65 7320  mbda Cloud does 
-0000f410: 6e6f 7420 6861 7665 2054 3420 6770 7573  not have T4 gpus
-0000f420: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-0000f430: 5f70 6170 6572 7370 6163 6520 2023 2050  _paperspace  # P
-0000f440: 6170 6572 7370 6163 6520 646f 6573 206e  aperspace does n
-0000f450: 6f74 2068 6176 6520 5434 2067 7075 730a  ot have T4 gpus.
-0000f460: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-0000f470: 6962 6d20 2023 2049 424d 2043 6c6f 7564  ibm  # IBM Cloud
-0000f480: 2064 6f65 7320 6e6f 7420 6861 7665 2054   does not have T
-0000f490: 3420 6770 7573 0a40 7079 7465 7374 2e6d  4 gpus.@pytest.m
-0000f4a0: 6172 6b2e 6e6f 5f73 6370 2020 2320 5343  ark.no_scp  # SC
-0000f4b0: 5020 646f 6573 206e 6f74 2073 7570 706f  P does not suppo
-0000f4c0: 7274 206e 756d 5f6e 6f64 6573 203e 2031  rt num_nodes > 1
-0000f4d0: 2079 6574 0a40 7079 7465 7374 2e6d 6172   yet.@pytest.mar
-0000f4e0: 6b2e 6e6f 5f6f 6369 2020 2320 4f43 4920  k.no_oci  # OCI 
-0000f4f0: 436c 6f75 6420 646f 6573 206e 6f74 2068  Cloud does not h
-0000f500: 6176 6520 5434 2067 7075 730a 6465 6620  ave T4 gpus.def 
-0000f510: 7465 7374 5f6d 756c 7469 5f65 6368 6f28  test_multi_echo(
-0000f520: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-0000f530: 7472 293a 0a20 2020 206e 616d 6520 3d20  tr):.    name = 
-0000f540: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-0000f550: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-0000f560: 6573 7428 0a20 2020 2020 2020 2027 6d75  est(.        'mu
-0000f570: 6c74 695f 6563 686f 272c 0a20 2020 2020  lti_echo',.     
-0000f580: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-0000f590: 2066 2770 7974 686f 6e20 6578 616d 706c   f'python exampl
-0000f5a0: 6573 2f6d 756c 7469 5f65 6368 6f2e 7079  es/multi_echo.py
-0000f5b0: 207b 6e61 6d65 7d20 7b67 656e 6572 6963   {name} {generic
-0000f5c0: 5f63 6c6f 7564 7d27 2c0a 2020 2020 2020  _cloud}',.      
-0000f5d0: 2020 2020 2020 2773 6c65 6570 2031 3230        'sleep 120
-0000f5e0: 272c 0a20 2020 2020 2020 205d 202b 0a20  ',.        ] +. 
-0000f5f0: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
-0000f600: 6a6f 6273 2073 7563 6365 6564 6564 2e0a  jobs succeeded..
-0000f610: 2020 2020 2020 2020 5b66 2773 6b79 206c          [f'sky l
-0000f620: 6f67 7320 7b6e 616d 657d 207b 6920 2b20  ogs {name} {i + 
-0000f630: 317d 202d 2d73 7461 7475 7327 2066 6f72  1} --status' for
-0000f640: 2069 2069 6e20 7261 6e67 6528 3332 295d   i in range(32)]
-0000f650: 202b 0a20 2020 2020 2020 2023 2045 6e73   +.        # Ens
-0000f660: 7572 6520 6d6f 6e69 746f 722f 6175 746f  ure monitor/auto
-0000f670: 7363 616c 6572 2064 6964 6e27 7420 6372  scaler didn't cr
-0000f680: 6173 6820 6f6e 2074 6865 2027 6173 7365  ash on the 'asse
-0000f690: 7274 206e 6f74 0a20 2020 2020 2020 2023  rt not.        #
-0000f6a0: 2075 6e66 756c 6669 6c6c 6564 2720 6572   unfulfilled' er
-0000f6b0: 726f 722e 2020 4966 2070 726f 6365 7373  ror.  If process
-0000f6c0: 206e 6f74 2066 6f75 6e64 2c20 6772 6570   not found, grep
-0000f6d0: 2d3e 7373 6820 7265 7475 726e 7320 312e  ->ssh returns 1.
-0000f6e0: 0a20 2020 2020 2020 205b 6627 7373 6820  .        [f'ssh 
-0000f6f0: 7b6e 616d 657d 205c 2770 7320 6175 7820  {name} \'ps aux 
-0000f700: 7c20 6772 6570 2022 5b2f 5d22 6d6f 6e69  | grep "[/]"moni
-0000f710: 746f 722e 7079 5c27 275d 2c0a 2020 2020  tor.py\''],.    
-0000f720: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-0000f730: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
-0000f740: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
-0000f750: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-0000f760: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-0000f770: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
-0000f780: 5461 736b 3a20 3120 6e6f 6465 2074 7261  Task: 1 node tra
-0000f790: 696e 696e 672e 202d 2d2d 2d2d 2d2d 2d2d  ining. ---------
-0000f7a0: 2d0a 4070 7974 6573 742e 6d61 726b 2e6e  -.@pytest.mark.n
-0000f7b0: 6f5f 6c61 6d62 6461 5f63 6c6f 7564 2020  o_lambda_cloud  
-0000f7c0: 2320 4c61 6d62 6461 2043 6c6f 7564 2064  # Lambda Cloud d
-0000f7d0: 6f65 7320 6e6f 7420 6861 7665 2056 3130  oes not have V10
-0000f7e0: 3020 6770 7573 0a40 7079 7465 7374 2e6d  0 gpus.@pytest.m
-0000f7f0: 6172 6b2e 6e6f 5f69 626d 2020 2320 4942  ark.no_ibm  # IB
-0000f800: 4d20 636c 6f75 6420 6375 7272 656e 746c  M cloud currentl
-0000f810: 7920 646f 6573 6e27 7420 7072 6f76 6964  y doesn't provid
-0000f820: 6520 7075 626c 6963 2069 6d61 6765 2077  e public image w
-0000f830: 6974 6820 4355 4441 0a40 7079 7465 7374  ith CUDA.@pytest
-0000f840: 2e6d 6172 6b2e 6e6f 5f73 6370 2020 2320  .mark.no_scp  # 
-0000f850: 5343 5020 646f 6573 206e 6f74 2068 6176  SCP does not hav
-0000f860: 6520 5631 3030 2028 3136 4742 2920 4750  e V100 (16GB) GP
-0000f870: 5573 2e20 5275 6e20 7465 7374 5f73 6370  Us. Run test_scp
-0000f880: 5f68 7567 6769 6e67 6661 6365 2069 6e73  _huggingface ins
-0000f890: 7465 6164 2e0a 6465 6620 7465 7374 5f68  tead..def test_h
-0000f8a0: 7567 6769 6e67 6661 6365 2867 656e 6572  uggingface(gener
-0000f8b0: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
-0000f8c0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-0000f8d0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-0000f8e0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-0000f8f0: 2020 2020 2020 2020 2768 7567 6769 6e67          'hugging
-0000f900: 6661 6365 5f67 6c75 655f 696d 6462 5f61  face_glue_imdb_a
-0000f910: 7070 272c 0a20 2020 2020 2020 205b 0a20  pp',.        [. 
-0000f920: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000f930: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-0000f940: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
-0000f950: 6e65 7269 635f 636c 6f75 647d 2065 7861  neric_cloud} exa
-0000f960: 6d70 6c65 732f 6875 6767 696e 6766 6163  mples/huggingfac
-0000f970: 655f 676c 7565 5f69 6d64 625f 6170 702e  e_glue_imdb_app.
-0000f980: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-0000f990: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-0000f9a0: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
-0000f9b0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-0000f9c0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-0000f9d0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000f9e0: 2065 7865 6320 7b6e 616d 657d 2065 7861   exec {name} exa
-0000f9f0: 6d70 6c65 732f 6875 6767 696e 6766 6163  mples/huggingfac
-0000fa00: 655f 676c 7565 5f69 6d64 625f 6170 702e  e_glue_imdb_app.
-0000fa10: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-0000fa20: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-0000fa30: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
-0000fa40: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-0000fa50: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-0000fa60: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-0000fa70: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-0000fa80: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-0000fa90: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-0000faa0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-0000fab0: 6d61 726b 2e6c 616d 6264 615f 636c 6f75  mark.lambda_clou
-0000fac0: 640a 6465 6620 7465 7374 5f6c 616d 6264  d.def test_lambd
-0000fad0: 615f 6875 6767 696e 6766 6163 6528 6765  a_huggingface(ge
-0000fae0: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
-0000faf0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-0000fb00: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-0000fb10: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-0000fb20: 7428 0a20 2020 2020 2020 2027 6c61 6d62  t(.        'lamb
-0000fb30: 6461 5f68 7567 6769 6e67 6661 6365 5f67  da_huggingface_g
-0000fb40: 6c75 655f 696d 6462 5f61 7070 272c 0a20  lue_imdb_app',. 
-0000fb50: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0000fb60: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-0000fb70: 6820 2d79 202d 6320 7b6e 616d 657d 207b  h -y -c {name} {
-0000fb80: 4c41 4d42 4441 5f54 5950 457d 2065 7861  LAMBDA_TYPE} exa
-0000fb90: 6d70 6c65 732f 6875 6767 696e 6766 6163  mples/huggingfac
-0000fba0: 655f 676c 7565 5f69 6d64 625f 6170 702e  e_glue_imdb_app.
-0000fbb0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-0000fbc0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-0000fbd0: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
-0000fbe0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-0000fbf0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-0000fc00: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000fc10: 2065 7865 6320 7b6e 616d 657d 207b 4c41   exec {name} {LA
-0000fc20: 4d42 4441 5f54 5950 457d 2065 7861 6d70  MBDA_TYPE} examp
-0000fc30: 6c65 732f 6875 6767 696e 6766 6163 655f  les/huggingface_
-0000fc40: 676c 7565 5f69 6d64 625f 6170 702e 7961  glue_imdb_app.ya
-0000fc50: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-0000fc60: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-0000fc70: 657d 2032 202d 2d73 7461 7475 7327 2c20  e} 2 --status', 
-0000fc80: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
-0000fc90: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
-0000fca0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0000fcb0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-0000fcc0: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
-0000fcd0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-0000fce0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-0000fcf0: 726b 2e73 6370 0a64 6566 2074 6573 745f  rk.scp.def test_
-0000fd00: 7363 705f 6875 6767 696e 6766 6163 6528  scp_huggingface(
-0000fd10: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-0000fd20: 7472 293a 0a20 2020 206e 616d 6520 3d20  tr):.    name = 
-0000fd30: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-0000fd40: 6528 290a 2020 2020 6e75 6d5f 6f66 5f67  e().    num_of_g
-0000fd50: 7075 5f6c 6175 6e63 6820 3d20 310a 2020  pu_launch = 1.  
-0000fd60: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-0000fd70: 2020 2020 2020 2027 5343 505f 6875 6767         'SCP_hugg
-0000fd80: 696e 6766 6163 655f 676c 7565 5f69 6d64  ingface_glue_imd
-0000fd90: 625f 6170 7027 2c0a 2020 2020 2020 2020  b_app',.        
-0000fda0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-0000fdb0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-0000fdc0: 207b 6e61 6d65 7d20 7b53 4350 5f54 5950   {name} {SCP_TYP
-0000fdd0: 457d 207b 5343 505f 4750 555f 5631 3030  E} {SCP_GPU_V100
-0000fde0: 7d3a 7b6e 756d 5f6f 665f 6770 755f 6c61  }:{num_of_gpu_la
-0000fdf0: 756e 6368 7d20 6578 616d 706c 6573 2f68  unch} examples/h
-0000fe00: 7567 6769 6e67 6661 6365 5f67 6c75 655f  uggingface_glue_
-0000fe10: 696d 6462 5f61 7070 2e79 616d 6c27 2c0a  imdb_app.yaml',.
-0000fe20: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000fe30: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-0000fe40: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-0000fe50: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-0000fe60: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-0000fe70: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-0000fe80: 6e61 6d65 7d20 7b53 4350 5f54 5950 457d  name} {SCP_TYPE}
-0000fe90: 207b 5343 505f 4750 555f 5631 3030 7d3a   {SCP_GPU_V100}:
-0000fea0: 7b6e 756d 5f6f 665f 6770 755f 6c61 756e  {num_of_gpu_laun
-0000feb0: 6368 7d20 6578 616d 706c 6573 2f68 7567  ch} examples/hug
-0000fec0: 6769 6e67 6661 6365 5f67 6c75 655f 696d  gingface_glue_im
-0000fed0: 6462 5f61 7070 2e79 616d 6c27 2c0a 2020  db_app.yaml',.  
-0000fee0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000fef0: 6c6f 6773 207b 6e61 6d65 7d20 3220 2d2d  logs {name} 2 --
-0000ff00: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-0000ff10: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
-0000ff20: 6564 6564 2e0a 2020 2020 2020 2020 5d2c  eded..        ],
-0000ff30: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-0000ff40: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-0000ff50: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-0000ff60: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
-0000ff70: 202d 2d2d 2d2d 2d2d 2d2d 2d20 496e 6665   ---------- Infe
-0000ff80: 7265 6e74 6961 2e20 2d2d 2d2d 2d2d 2d2d  rentia. --------
-0000ff90: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
-0000ffa0: 6177 730a 6465 6620 7465 7374 5f69 6e66  aws.def test_inf
-0000ffb0: 6572 656e 7469 6128 293a 0a20 2020 206e  erentia():.    n
-0000ffc0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-0000ffd0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-0000ffe0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-0000fff0: 2020 2027 7465 7374 5f69 6e66 6572 656e     'test_inferen
-00010000: 7469 6127 2c0a 2020 2020 2020 2020 5b0a  tia',.        [.
-00010010: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00010020: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-00010030: 6e61 6d65 7d20 2d74 2069 6e66 322e 786c  name} -t inf2.xl
-00010040: 6172 6765 202d 2d20 6563 686f 2068 6927  arge -- echo hi'
-00010050: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00010060: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-00010070: 2d2d 6770 7573 2049 6e66 6572 656e 7469  --gpus Inferenti
-00010080: 613a 3120 6563 686f 2068 6927 2c0a 2020  a:1 echo hi',.  
-00010090: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000100a0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
-000100b0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-000100c0: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
-000100d0: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
-000100e0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-000100f0: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
-00010100: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-00010110: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-00010120: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00010130: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00010140: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-00010150: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00010160: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-00010170: 2d2d 2d20 5450 552e 202d 2d2d 2d2d 2d2d  --- TPU. -------
-00010180: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
-00010190: 2e67 6370 0a40 7079 7465 7374 2e6d 6172  .gcp.@pytest.mar
-000101a0: 6b2e 7470 750a 6465 6620 7465 7374 5f74  k.tpu.def test_t
-000101b0: 7075 2829 3a0a 2020 2020 6e61 6d65 203d  pu():.    name =
-000101c0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-000101d0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-000101e0: 5465 7374 280a 2020 2020 2020 2020 2774  Test(.        't
-000101f0: 7075 5f61 7070 272c 0a20 2020 2020 2020  pu_app',.       
-00010200: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00010210: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00010220: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
-00010230: 732f 7470 752f 7470 755f 6170 702e 7961  s/tpu/tpu_app.ya
-00010240: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00010250: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00010260: 657d 2031 272c 2020 2320 456e 7375 7265  e} 1',  # Ensure
-00010270: 2074 6865 206a 6f62 2066 696e 6973 6865   the job finishe
-00010280: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
-00010290: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-000102a0: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
-000102b0: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-000102c0: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-000102d0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-000102e0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-000102f0: 2065 7861 6d70 6c65 732f 7470 752f 7470   examples/tpu/tp
-00010300: 755f 6170 702e 7961 6d6c 207c 2067 7265  u_app.yaml | gre
-00010310: 7020 2254 5055 202e 2a20 616c 7265 6164  p "TPU .* alread
-00010320: 7920 6578 6973 7473 2227 2c20 2023 2045  y exists"',  # E
-00010330: 6e73 7572 6520 736b 7920 6c61 756e 6368  nsure sky launch
-00010340: 2077 6f6e 2774 2063 7265 6174 6520 616e   won't create an
-00010350: 6f74 6865 7220 5450 552e 0a20 2020 2020  other TPU..     
-00010360: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-00010370: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-00010380: 657d 272c 0a20 2020 2020 2020 2074 696d  e}',.        tim
-00010390: 656f 7574 3d33 3020 2a20 3630 2c20 2023  eout=30 * 60,  #
-000103a0: 2063 616e 2074 616b 6520 3e32 3020 6d69   can take >20 mi
-000103b0: 6e73 0a20 2020 2029 0a20 2020 2072 756e  ns.    ).    run
-000103c0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-000103d0: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
-000103e0: 5055 2056 4d2e 202d 2d2d 2d2d 2d2d 2d2d  PU VM. ---------
-000103f0: 2d0a 4070 7974 6573 742e 6d61 726b 2e67  -.@pytest.mark.g
-00010400: 6370 0a40 7079 7465 7374 2e6d 6172 6b2e  cp.@pytest.mark.
-00010410: 7470 750a 6465 6620 7465 7374 5f74 7075  tpu.def test_tpu
-00010420: 5f76 6d28 293a 0a20 2020 206e 616d 6520  _vm():.    name 
-00010430: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00010440: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-00010450: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00010460: 7470 755f 766d 5f61 7070 272c 0a20 2020  tpu_vm_app',.   
-00010470: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00010480: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00010490: 2d79 202d 6320 7b6e 616d 657d 2065 7861  -y -c {name} exa
-000104a0: 6d70 6c65 732f 7470 752f 7470 7576 6d5f  mples/tpu/tpuvm_
-000104b0: 6d6e 6973 742e 7961 6d6c 272c 0a20 2020  mnist.yaml',.   
-000104c0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-000104d0: 6f67 7320 7b6e 616d 657d 2031 272c 2020  ogs {name} 1',  
-000104e0: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-000104f0: 2066 696e 6973 6865 642e 0a20 2020 2020   finished..     
-00010500: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00010510: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-00010520: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-00010530: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-00010540: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
-00010550: 2773 6b79 2073 746f 7020 2d79 207b 6e61  'sky stop -y {na
-00010560: 6d65 7d27 2c0a 2020 2020 2020 2020 2020  me}',.          
-00010570: 2020 6627 733d 2428 736b 7920 7374 6174    f's=$(sky stat
-00010580: 7573 207b 6e61 6d65 7d20 2d2d 7265 6672  us {name} --refr
-00010590: 6573 6829 3b20 6563 686f 2022 2473 223b  esh); echo "$s";
-000105a0: 2065 6368 6f3b 2065 6368 6f3b 2065 6368   echo; echo; ech
-000105b0: 6f20 2224 7322 2020 7c20 6772 6570 207b  o "$s"  | grep {
-000105c0: 6e61 6d65 7d20 7c20 6772 6570 2053 544f  name} | grep STO
-000105d0: 5050 4544 272c 2020 2320 456e 7375 7265  PPED',  # Ensure
-000105e0: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
-000105f0: 5354 4f50 5045 442e 0a20 2020 2020 2020  STOPPED..       
-00010600: 2020 2020 2023 2055 7365 2072 6574 7279       # Use retry
-00010610: 3a20 6775 6172 6420 6167 6169 6e73 7420  : guard against 
-00010620: 7472 616e 7369 656e 7420 6572 726f 7273  transient errors
-00010630: 206f 6273 6572 7665 6420 666f 720a 2020   observed for.  
-00010640: 2020 2020 2020 2020 2020 2320 6a75 7374            # just
-00010650: 2d73 746f 7070 6564 2054 5055 2056 4d73  -stopped TPU VMs
-00010660: 2028 2339 3632 292e 0a20 2020 2020 2020   (#962)..       
-00010670: 2020 2020 2066 2773 6b79 2073 7461 7274       f'sky start
-00010680: 202d 2d72 6574 7279 2d75 6e74 696c 2d75   --retry-until-u
-00010690: 7020 2d79 207b 6e61 6d65 7d27 2c0a 2020  p -y {name}',.  
-000106a0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000106b0: 6578 6563 207b 6e61 6d65 7d20 6578 616d  exec {name} exam
-000106c0: 706c 6573 2f74 7075 2f74 7075 766d 5f6d  ples/tpu/tpuvm_m
-000106d0: 6e69 7374 2e79 616d 6c27 2c0a 2020 2020  nist.yaml',.    
-000106e0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-000106f0: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
-00010700: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
-00010710: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
-00010720: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-00010730: 6627 736b 7920 7374 6f70 202d 7920 7b6e  f'sky stop -y {n
-00010740: 616d 657d 272c 0a20 2020 2020 2020 205d  ame}',.        ]
-00010750: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00010760: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-00010770: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-00010780: 3d33 3020 2a20 3630 2c20 2023 2063 616e  =30 * 60,  # can
-00010790: 2074 616b 6520 3330 206d 696e 730a 2020   take 30 mins.  
-000107a0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-000107b0: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
-000107c0: 2d2d 2d2d 2d2d 2d2d 2d20 5450 5520 564d  --------- TPU VM
-000107d0: 2050 6f64 2e20 2d2d 2d2d 2d2d 2d2d 2d2d   Pod. ----------
-000107e0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6763  .@pytest.mark.gc
-000107f0: 700a 4070 7974 6573 742e 6d61 726b 2e74  p.@pytest.mark.t
-00010800: 7075 0a64 6566 2074 6573 745f 7470 755f  pu.def test_tpu_
-00010810: 766d 5f70 6f64 2829 3a0a 2020 2020 6e61  vm_pod():.    na
-00010820: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00010830: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-00010840: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00010850: 2020 2774 7075 5f70 6f64 272c 0a20 2020    'tpu_pod',.   
-00010860: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00010870: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00010880: 2d79 202d 6320 7b6e 616d 657d 2065 7861  -y -c {name} exa
-00010890: 6d70 6c65 732f 7470 752f 7470 7576 6d5f  mples/tpu/tpuvm_
-000108a0: 6d6e 6973 742e 7961 6d6c 202d 2d67 7075  mnist.yaml --gpu
-000108b0: 7320 7470 752d 7632 2d33 3220 2d2d 7573  s tpu-v2-32 --us
-000108c0: 652d 7370 6f74 202d 2d7a 6f6e 6520 6575  e-spot --zone eu
-000108d0: 726f 7065 2d77 6573 7434 2d61 272c 0a20  rope-west4-a',. 
-000108e0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000108f0: 206c 6f67 7320 7b6e 616d 657d 2031 272c   logs {name} 1',
-00010900: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-00010910: 6f62 2066 696e 6973 6865 642e 0a20 2020  ob finished..   
-00010920: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00010930: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-00010940: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-00010950: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-00010960: 6465 642e 0a20 2020 2020 2020 205d 2c0a  ded..        ],.
-00010970: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-00010980: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-00010990: 2020 2020 2020 2074 696d 656f 7574 3d33         timeout=3
-000109a0: 3020 2a20 3630 2c20 2023 2063 616e 2074  0 * 60,  # can t
-000109b0: 616b 6520 3330 206d 696e 730a 2020 2020  ake 30 mins.    
-000109c0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-000109d0: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-000109e0: 2d2d 2d2d 2d2d 2d20 5369 6d70 6c65 2061  ------- Simple a
-000109f0: 7070 732e 202d 2d2d 2d2d 2d2d 2d2d 2d0a  pps. ----------.
-00010a00: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00010a10: 7363 7020 2023 2053 4350 2064 6f65 7320  scp  # SCP does 
-00010a20: 6e6f 7420 7375 7070 6f72 7420 6e75 6d5f  not support num_
-00010a30: 6e6f 6465 7320 3e20 3120 7965 740a 6465  nodes > 1 yet.de
-00010a40: 6620 7465 7374 5f6d 756c 7469 5f68 6f73  f test_multi_hos
-00010a50: 746e 616d 6528 6765 6e65 7269 635f 636c  tname(generic_cl
-00010a60: 6f75 643a 2073 7472 293a 0a20 2020 206e  oud: str):.    n
-00010a70: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00010a80: 6572 5f6e 616d 6528 290a 2020 2020 746f  er_name().    to
-00010a90: 7461 6c5f 7469 6d65 6f75 745f 6d69 6e75  tal_timeout_minu
-00010aa0: 7465 7320 3d20 3235 2069 6620 6765 6e65  tes = 25 if gene
-00010ab0: 7269 635f 636c 6f75 6420 3d3d 2027 617a  ric_cloud == 'az
-00010ac0: 7572 6527 2065 6c73 6520 3135 0a20 2020  ure' else 15.   
-00010ad0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00010ae0: 2020 2020 2020 276d 756c 7469 5f68 6f73        'multi_hos
-00010af0: 746e 616d 6527 2c0a 2020 2020 2020 2020  tname',.        
-00010b00: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-00010b10: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-00010b20: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-00010b30: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
-00010b40: 6578 616d 706c 6573 2f6d 756c 7469 5f68  examples/multi_h
-00010b50: 6f73 746e 616d 652e 7961 6d6c 272c 0a20  ostname.yaml',. 
-00010b60: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00010b70: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-00010b80: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
-00010b90: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
-00010ba0: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
-00010bb0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00010bc0: 616d 657d 2031 207c 2067 7265 7020 224d  ame} 1 | grep "M
-00010bd0: 7920 686f 7374 6e61 6d65 3a22 207c 2077  y hostname:" | w
-00010be0: 6320 2d6c 207c 2067 7265 7020 3227 2c20  c -l | grep 2', 
-00010bf0: 2023 2045 6e73 7572 6520 7468 6572 6520   # Ensure there 
-00010c00: 6172 6520 3220 686f 7374 732e 0a20 2020  are 2 hosts..   
-00010c10: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00010c20: 7865 6320 7b6e 616d 657d 2065 7861 6d70  xec {name} examp
-00010c30: 6c65 732f 6d75 6c74 695f 686f 7374 6e61  les/multi_hostna
-00010c40: 6d65 2e79 616d 6c27 2c0a 2020 2020 2020  me.yaml',.      
-00010c50: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-00010c60: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
-00010c70: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
-00010c80: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
-00010c90: 2e0a 2020 2020 2020 2020 5d2c 0a20 2020  ..        ],.   
-00010ca0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-00010cb0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-00010cc0: 2020 2020 7469 6d65 6f75 743d 5f67 6574      timeout=_get
-00010cd0: 5f74 696d 656f 7574 2867 656e 6572 6963  _timeout(generic
-00010ce0: 5f63 6c6f 7564 2c20 746f 7461 6c5f 7469  _cloud, total_ti
-00010cf0: 6d65 6f75 745f 6d69 6e75 7465 7320 2a20  meout_minutes * 
-00010d00: 3630 292c 0a20 2020 2029 0a20 2020 2072  60),.    ).    r
-00010d10: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00010d20: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00010d30: 2e6e 6f5f 7363 7020 2023 2053 4350 2064  .no_scp  # SCP d
-00010d40: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-00010d50: 6e75 6d5f 6e6f 6465 7320 3e20 3120 7965  num_nodes > 1 ye
-00010d60: 740a 6465 6620 7465 7374 5f6d 756c 7469  t.def test_multi
-00010d70: 5f6e 6f64 655f 6661 696c 7572 6528 6765  _node_failure(ge
-00010d80: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
-00010d90: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-00010da0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-00010db0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-00010dc0: 7428 0a20 2020 2020 2020 2027 6d75 6c74  t(.        'mult
-00010dd0: 695f 6e6f 6465 5f66 6169 6c75 7265 272c  i_node_failure',
-00010de0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-00010df0: 2020 2020 2020 2023 2054 4f44 4f28 7a68         # TODO(zh
-00010e00: 7775 293a 2077 6520 7573 6520 6d75 6c74  wu): we use mult
-00010e10: 692d 7468 7265 6164 2074 6f20 7275 6e20  i-thread to run 
-00010e20: 7468 6520 636f 6d6d 616e 6473 2069 6e20  the commands in 
-00010e30: 7365 7475 700a 2020 2020 2020 2020 2020  setup.          
-00010e40: 2020 2320 636f 6d6d 616e 6473 2069 6e20    # commands in 
-00010e50: 7061 7261 6c6c 656c 2c20 7768 6963 6820  parallel, which 
-00010e60: 6d61 6b65 7320 6974 2069 6d70 6f73 7369  makes it impossi
-00010e70: 626c 6520 746f 2066 6169 6c20 6661 7374  ble to fail fast
-00010e80: 0a20 2020 2020 2020 2020 2020 2023 2077  .            # w
-00010e90: 6865 6e20 6f6e 6520 6f66 2074 6865 206e  hen one of the n
-00010ea0: 6f64 6573 2066 6169 6c73 2e20 5765 2073  odes fails. We s
-00010eb0: 686f 756c 6420 6669 7820 7468 6973 2069  hould fix this i
-00010ec0: 6e20 7468 6520 6675 7475 7265 2e0a 2020  n the future..  
-00010ed0: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
-00010ee0: 2d2d 6465 7461 6368 2d73 6574 7570 2076  --detach-setup v
-00010ef0: 6572 7369 6f6e 2063 616e 2066 6169 6c20  ersion can fail 
-00010f00: 6661 7374 2c20 6173 2074 6865 2073 6574  fast, as the set
-00010f10: 7570 2069 730a 2020 2020 2020 2020 2020  up is.          
-00010f20: 2020 2320 7375 626d 6974 7465 6420 746f    # submitted to
-00010f30: 2074 6865 2072 656d 6f74 6520 6d61 6368   the remote mach
-00010f40: 696e 652c 2077 6869 6368 2064 6f65 7320  ine, which does 
-00010f50: 6e6f 7420 7573 6520 6d75 6c74 692d 7468  not use multi-th
-00010f60: 7265 6164 2e0a 2020 2020 2020 2020 2020  read..          
-00010f70: 2020 2320 5265 6665 7220 746f 2074 6865    # Refer to the
-00010f80: 2063 6f6d 6d65 6e74 2069 6e20 6073 7562   comment in `sub
-00010f90: 7072 6f63 6573 735f 7574 696c 732e 7275  process_utils.ru
-00010fa0: 6e5f 696e 5f70 6172 616c 6c65 6c60 2e0a  n_in_parallel`..
-00010fb0: 2020 2020 2020 2020 2020 2020 2320 6627              # f'
-00010fc0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-00010fd0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-00010fe0: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
-00010ff0: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-00011000: 2f66 6169 6c65 645f 776f 726b 6572 5f73  /failed_worker_s
-00011010: 6574 7570 2e79 616d 6c20 2626 2065 7869  etup.yaml && exi
-00011020: 7420 3127 2c20 2023 2045 6e73 7572 6520  t 1',  # Ensure 
-00011030: 7468 6520 6a6f 6220 7365 7475 7020 6661  the job setup fa
-00011040: 696c 6564 2e0a 2020 2020 2020 2020 2020  iled..          
-00011050: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00011060: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
-00011070: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-00011080: 7564 7d20 2d2d 6465 7461 6368 2d73 6574  ud} --detach-set
-00011090: 7570 2074 6573 7473 2f74 6573 745f 7961  up tests/test_ya
-000110a0: 6d6c 732f 6661 696c 6564 5f77 6f72 6b65  mls/failed_worke
-000110b0: 725f 7365 7475 702e 7961 6d6c 272c 0a20  r_setup.yaml',. 
-000110c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000110d0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-000110e0: 2d73 7461 7475 7320 7c20 6772 6570 2046  -status | grep F
-000110f0: 4149 4c45 445f 5345 5455 5027 2c20 2023  AILED_SETUP',  #
-00011100: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-00011110: 7365 7475 7020 6661 696c 6564 2e0a 2020  setup failed..  
-00011120: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00011130: 6578 6563 207b 6e61 6d65 7d20 7465 7374  exec {name} test
-00011140: 732f 7465 7374 5f79 616d 6c73 2f66 6169  s/test_yamls/fai
-00011150: 6c65 645f 776f 726b 6572 5f72 756e 2e79  led_worker_run.y
-00011160: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00011170: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00011180: 6d65 7d20 3220 2d2d 7374 6174 7573 207c  me} 2 --status |
-00011190: 2067 7265 7020 4641 494c 4544 272c 2020   grep FAILED',  
-000111a0: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-000111b0: 2066 6169 6c65 642e 0a20 2020 2020 2020   failed..       
-000111c0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-000111d0: 7b6e 616d 657d 2032 207c 2067 7265 7020  {name} 2 | grep 
-000111e0: 224d 7920 686f 7374 6e61 6d65 3a22 207c  "My hostname:" |
-000111f0: 2077 6320 2d6c 207c 2067 7265 7020 3227   wc -l | grep 2'
-00011200: 2c20 2023 2045 6e73 7572 6520 7468 6572  ,  # Ensure ther
-00011210: 6520 3220 6f66 2074 6865 2068 6f73 7473  e 2 of the hosts
-00011220: 2070 7269 6e74 6564 2074 6865 6972 2068   printed their h
-00011230: 6f73 746e 616d 652e 0a20 2020 2020 2020  ostname..       
-00011240: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-00011250: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-00011260: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
-00011270: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-00011280: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2057  ..# ---------- W
-00011290: 6562 2061 7070 7320 7769 7468 2063 7573  eb apps with cus
-000112a0: 746f 6d20 706f 7274 7320 6f6e 2047 4350  tom ports on GCP
-000112b0: 2e20 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  . ----------.@py
-000112c0: 7465 7374 2e6d 6172 6b2e 6763 700a 6465  test.mark.gcp.de
-000112d0: 6620 7465 7374 5f67 6370 5f68 7474 705f  f test_gcp_http_
-000112e0: 7365 7276 6572 5f77 6974 685f 6375 7374  server_with_cust
-000112f0: 6f6d 5f70 6f72 7473 2829 3a0a 2020 2020  om_ports():.    
-00011300: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-00011310: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-00011320: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-00011330: 2020 2020 2767 6370 5f68 7474 705f 7365      'gcp_http_se
-00011340: 7276 6572 5f77 6974 685f 6375 7374 6f6d  rver_with_custom
-00011350: 5f70 6f72 7473 272c 0a20 2020 2020 2020  _ports',.       
-00011360: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00011370: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00011380: 6420 2d63 207b 6e61 6d65 7d20 2d2d 636c  d -c {name} --cl
-00011390: 6f75 6420 6763 7020 6578 616d 706c 6573  oud gcp examples
-000113a0: 2f68 7474 705f 7365 7276 6572 5f77 6974  /http_server_wit
-000113b0: 685f 6375 7374 6f6d 5f70 6f72 7473 2f74  h_custom_ports/t
-000113c0: 6173 6b2e 7961 6d6c 272c 0a20 2020 2020  ask.yaml',.     
-000113d0: 2020 2020 2020 2066 2775 6e74 696c 2053         f'until S
-000113e0: 4b59 5049 4c4f 545f 4445 4255 473d 3020  KYPILOT_DEBUG=0 
-000113f0: 736b 7920 7374 6174 7573 202d 2d65 6e64  sky status --end
-00011400: 706f 696e 7420 3333 3832 3820 7b6e 616d  point 33828 {nam
-00011410: 657d 3b20 646f 2073 6c65 6570 2031 303b  e}; do sleep 10;
-00011420: 2064 6f6e 6527 2c0a 2020 2020 2020 2020   done',.        
-00011430: 2020 2020 2320 5265 7472 7920 6120 6665      # Retry a fe
-00011440: 7720 7469 6d65 7320 746f 2061 766f 6964  w times to avoid
-00011450: 2066 6c61 6b69 6e65 7373 2069 6e20 706f   flakiness in po
-00011460: 7274 7320 6265 696e 6720 6f70 656e 2e0a  rts being open..
-00011470: 2020 2020 2020 2020 2020 2020 6627 6970              f'ip
-00011480: 3d24 2853 4b59 5049 4c4f 545f 4445 4255  =$(SKYPILOT_DEBU
-00011490: 473d 3020 736b 7920 7374 6174 7573 202d  G=0 sky status -
-000114a0: 2d65 6e64 706f 696e 7420 3333 3832 3820  -endpoint 33828 
-000114b0: 7b6e 616d 657d 293b 2073 7563 6365 7373  {name}); success
-000114c0: 3d66 616c 7365 3b20 666f 7220 6920 696e  =false; for i in
-000114d0: 2024 2873 6571 2031 2035 293b 2064 6f20   $(seq 1 5); do 
-000114e0: 6966 2063 7572 6c20 2469 7020 7c20 6772  if curl $ip | gr
-000114f0: 6570 2022 3c68 313e 5468 6973 2069 7320  ep "<h1>This is 
-00011500: 6120 6465 6d6f 2048 544d 4c20 7061 6765  a demo HTML page
-00011510: 2e3c 2f68 313e 223b 2074 6865 6e20 7375  .</h1>"; then su
-00011520: 6363 6573 733d 7472 7565 3b20 6272 6561  ccess=true; brea
-00011530: 6b3b 2066 693b 2073 6c65 6570 2031 303b  k; fi; sleep 10;
-00011540: 2064 6f6e 653b 2069 6620 5b20 2224 7375   done; if [ "$su
-00011550: 6363 6573 7322 203d 2066 616c 7365 205d  ccess" = false ]
-00011560: 3b20 7468 656e 2065 7869 7420 313b 2066  ; then exit 1; f
-00011570: 6927 2c0a 2020 2020 2020 2020 5d2c 0a20  i',.        ],. 
-00011580: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-00011590: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-000115a0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-000115b0: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
-000115c0: 2d2d 2d2d 2d2d 2d2d 2d20 5765 6220 6170  --------- Web ap
-000115d0: 7073 2077 6974 6820 6375 7374 6f6d 2070  ps with custom p
-000115e0: 6f72 7473 206f 6e20 4157 532e 202d 2d2d  orts on AWS. ---
-000115f0: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
-00011600: 6d61 726b 2e61 7773 0a64 6566 2074 6573  mark.aws.def tes
-00011610: 745f 6177 735f 6874 7470 5f73 6572 7665  t_aws_http_serve
-00011620: 725f 7769 7468 5f63 7573 746f 6d5f 706f  r_with_custom_po
-00011630: 7274 7328 293a 0a20 2020 206e 616d 6520  rts():.    name 
-00011640: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00011650: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-00011660: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00011670: 6177 735f 6874 7470 5f73 6572 7665 725f  aws_http_server_
-00011680: 7769 7468 5f63 7573 746f 6d5f 706f 7274  with_custom_port
-00011690: 7327 2c0a 2020 2020 2020 2020 5b0a 2020  s',.        [.  
-000116a0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000116b0: 6c61 756e 6368 202d 7920 2d64 202d 6320  launch -y -d -c 
-000116c0: 7b6e 616d 657d 202d 2d63 6c6f 7564 2061  {name} --cloud a
-000116d0: 7773 2065 7861 6d70 6c65 732f 6874 7470  ws examples/http
-000116e0: 5f73 6572 7665 725f 7769 7468 5f63 7573  _server_with_cus
-000116f0: 746f 6d5f 706f 7274 732f 7461 736b 2e79  tom_ports/task.y
-00011700: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00011710: 2020 6627 756e 7469 6c20 534b 5950 494c    f'until SKYPIL
-00011720: 4f54 5f44 4542 5547 3d30 2073 6b79 2073  OT_DEBUG=0 sky s
-00011730: 7461 7475 7320 2d2d 656e 6470 6f69 6e74  tatus --endpoint
-00011740: 2033 3338 3238 207b 6e61 6d65 7d3b 2064   33828 {name}; d
-00011750: 6f20 736c 6565 7020 3130 3b20 646f 6e65  o sleep 10; done
-00011760: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-00011770: 2052 6574 7279 2061 2066 6577 2074 696d   Retry a few tim
-00011780: 6573 2074 6f20 6176 6f69 6420 666c 616b  es to avoid flak
-00011790: 696e 6573 7320 696e 2070 6f72 7473 2062  iness in ports b
-000117a0: 6569 6e67 206f 7065 6e2e 0a20 2020 2020  eing open..     
-000117b0: 2020 2020 2020 2066 2769 703d 2428 534b         f'ip=$(SK
-000117c0: 5950 494c 4f54 5f44 4542 5547 3d30 2073  YPILOT_DEBUG=0 s
-000117d0: 6b79 2073 7461 7475 7320 2d2d 656e 6470  ky status --endp
-000117e0: 6f69 6e74 2033 3338 3238 207b 6e61 6d65  oint 33828 {name
-000117f0: 7d29 3b20 7375 6363 6573 733d 6661 6c73  }); success=fals
-00011800: 653b 2066 6f72 2069 2069 6e20 2428 7365  e; for i in $(se
-00011810: 7120 3120 3529 3b20 646f 2069 6620 6375  q 1 5); do if cu
-00011820: 726c 2024 6970 207c 2067 7265 7020 223c  rl $ip | grep "<
-00011830: 6831 3e54 6869 7320 6973 2061 2064 656d  h1>This is a dem
-00011840: 6f20 4854 4d4c 2070 6167 652e 3c2f 6831  o HTML page.</h1
-00011850: 3e22 3b20 7468 656e 2073 7563 6365 7373  >"; then success
-00011860: 3d74 7275 653b 2062 7265 616b 3b20 6669  =true; break; fi
-00011870: 3b20 736c 6565 7020 3130 3b20 646f 6e65  ; sleep 10; done
-00011880: 3b20 6966 205b 2022 2473 7563 6365 7373  ; if [ "$success
-00011890: 2220 3d20 6661 6c73 6520 5d3b 2074 6865  " = false ]; the
-000118a0: 6e20 6578 6974 2031 3b20 6669 270a 2020  n exit 1; fi'.  
-000118b0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-000118c0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-000118d0: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-000118e0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-000118f0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-00011900: 2d2d 2d20 5765 6220 6170 7073 2077 6974  --- Web apps wit
-00011910: 6820 6375 7374 6f6d 2070 6f72 7473 206f  h custom ports o
-00011920: 6e20 417a 7572 652e 202d 2d2d 2d2d 2d2d  n Azure. -------
-00011930: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
-00011940: 2e61 7a75 7265 0a64 6566 2074 6573 745f  .azure.def test_
-00011950: 617a 7572 655f 6874 7470 5f73 6572 7665  azure_http_serve
-00011960: 725f 7769 7468 5f63 7573 746f 6d5f 706f  r_with_custom_po
-00011970: 7274 7328 293a 0a20 2020 206e 616d 6520  rts():.    name 
-00011980: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00011990: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-000119a0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-000119b0: 617a 7572 655f 6874 7470 5f73 6572 7665  azure_http_serve
-000119c0: 725f 7769 7468 5f63 7573 746f 6d5f 706f  r_with_custom_po
-000119d0: 7274 7327 2c0a 2020 2020 2020 2020 5b0a  rts',.        [.
-000119e0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000119f0: 7920 6c61 756e 6368 202d 7920 2d64 202d  y launch -y -d -
-00011a00: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-00011a10: 2061 7a75 7265 2065 7861 6d70 6c65 732f   azure examples/
-00011a20: 6874 7470 5f73 6572 7665 725f 7769 7468  http_server_with
-00011a30: 5f63 7573 746f 6d5f 706f 7274 732f 7461  _custom_ports/ta
-00011a40: 736b 2e79 616d 6c27 2c0a 2020 2020 2020  sk.yaml',.      
-00011a50: 2020 2020 2020 6627 756e 7469 6c20 534b        f'until SK
-00011a60: 5950 494c 4f54 5f44 4542 5547 3d30 2073  YPILOT_DEBUG=0 s
-00011a70: 6b79 2073 7461 7475 7320 2d2d 656e 6470  ky status --endp
-00011a80: 6f69 6e74 2033 3338 3238 207b 6e61 6d65  oint 33828 {name
-00011a90: 7d3b 2064 6f20 736c 6565 7020 3130 3b20  }; do sleep 10; 
-00011aa0: 646f 6e65 272c 0a20 2020 2020 2020 2020  done',.         
-00011ab0: 2020 2023 2052 6574 7279 2061 2066 6577     # Retry a few
-00011ac0: 2074 696d 6573 2074 6f20 6176 6f69 6420   times to avoid 
-00011ad0: 666c 616b 696e 6573 7320 696e 2070 6f72  flakiness in por
-00011ae0: 7473 2062 6569 6e67 206f 7065 6e2e 0a20  ts being open.. 
-00011af0: 2020 2020 2020 2020 2020 2066 2769 703d             f'ip=
-00011b00: 2428 534b 5950 494c 4f54 5f44 4542 5547  $(SKYPILOT_DEBUG
-00011b10: 3d30 2073 6b79 2073 7461 7475 7320 2d2d  =0 sky status --
-00011b20: 656e 6470 6f69 6e74 2033 3338 3238 207b  endpoint 33828 {
-00011b30: 6e61 6d65 7d29 3b20 7375 6363 6573 733d  name}); success=
-00011b40: 6661 6c73 653b 2066 6f72 2069 2069 6e20  false; for i in 
-00011b50: 2428 7365 7120 3120 3529 3b20 646f 2069  $(seq 1 5); do i
-00011b60: 6620 6375 726c 2024 6970 207c 2067 7265  f curl $ip | gre
-00011b70: 7020 223c 6831 3e54 6869 7320 6973 2061  p "<h1>This is a
-00011b80: 2064 656d 6f20 4854 4d4c 2070 6167 652e   demo HTML page.
-00011b90: 3c2f 6831 3e22 3b20 7468 656e 2073 7563  </h1>"; then suc
-00011ba0: 6365 7373 3d74 7275 653b 2062 7265 616b  cess=true; break
-00011bb0: 3b20 6669 3b20 736c 6565 7020 3130 3b20  ; fi; sleep 10; 
-00011bc0: 646f 6e65 3b20 6966 205b 2022 2473 7563  done; if [ "$suc
-00011bd0: 6365 7373 2220 3d20 6661 6c73 6520 5d3b  cess" = false ];
-00011be0: 2074 6865 6e20 6578 6974 2031 3b20 6669   then exit 1; fi
-00011bf0: 270a 2020 2020 2020 2020 5d2c 0a20 2020  '.        ],.   
-00011c00: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-00011c10: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-00011c20: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00011c30: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-00011c40: 2d2d 2d2d 2d2d 2d20 5765 6220 6170 7073  ------- Web apps
-00011c50: 2077 6974 6820 6375 7374 6f6d 2070 6f72   with custom por
-00011c60: 7473 206f 6e20 4b75 6265 726e 6574 6573  ts on Kubernetes
-00011c70: 2e20 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  . ----------.@py
-00011c80: 7465 7374 2e6d 6172 6b2e 6b75 6265 726e  test.mark.kubern
-00011c90: 6574 6573 0a64 6566 2074 6573 745f 6b75  etes.def test_ku
-00011ca0: 6265 726e 6574 6573 5f68 7474 705f 7365  bernetes_http_se
-00011cb0: 7276 6572 5f77 6974 685f 6375 7374 6f6d  rver_with_custom
-00011cc0: 5f70 6f72 7473 2829 3a0a 2020 2020 6e61  _ports():.    na
-00011cd0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00011ce0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-00011cf0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00011d00: 2020 276b 7562 6572 6e65 7465 735f 6874    'kubernetes_ht
-00011d10: 7470 5f73 6572 7665 725f 7769 7468 5f63  tp_server_with_c
-00011d20: 7573 746f 6d5f 706f 7274 7327 2c0a 2020  ustom_ports',.  
-00011d30: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00011d40: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00011d50: 202d 7920 2d64 202d 6320 7b6e 616d 657d   -y -d -c {name}
-00011d60: 202d 2d63 6c6f 7564 206b 7562 6572 6e65   --cloud kuberne
-00011d70: 7465 7320 6578 616d 706c 6573 2f68 7474  tes examples/htt
-00011d80: 705f 7365 7276 6572 5f77 6974 685f 6375  p_server_with_cu
-00011d90: 7374 6f6d 5f70 6f72 7473 2f74 6173 6b2e  stom_ports/task.
-00011da0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00011db0: 2020 2066 2775 6e74 696c 2053 4b59 5049     f'until SKYPI
-00011dc0: 4c4f 545f 4445 4255 473d 3020 736b 7920  LOT_DEBUG=0 sky 
-00011dd0: 7374 6174 7573 202d 2d65 6e64 706f 696e  status --endpoin
-00011de0: 7420 3333 3832 3820 7b6e 616d 657d 3b20  t 33828 {name}; 
-00011df0: 646f 2073 6c65 6570 2031 303b 2064 6f6e  do sleep 10; don
-00011e00: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
-00011e10: 2320 5265 7472 7920 6120 6665 7720 7469  # Retry a few ti
-00011e20: 6d65 7320 746f 2061 766f 6964 2066 6c61  mes to avoid fla
-00011e30: 6b69 6e65 7373 2069 6e20 706f 7274 7320  kiness in ports 
-00011e40: 6265 696e 6720 6f70 656e 2e0a 2020 2020  being open..    
-00011e50: 2020 2020 2020 2020 6627 6970 3d24 2853          f'ip=$(S
-00011e60: 4b59 5049 4c4f 545f 4445 4255 473d 3020  KYPILOT_DEBUG=0 
-00011e70: 736b 7920 7374 6174 7573 202d 2d65 6e64  sky status --end
-00011e80: 706f 696e 7420 3333 3832 3820 7b6e 616d  point 33828 {nam
-00011e90: 657d 293b 2073 7563 6365 7373 3d66 616c  e}); success=fal
-00011ea0: 7365 3b20 666f 7220 6920 696e 2024 2873  se; for i in $(s
-00011eb0: 6571 2031 2031 3030 293b 2064 6f20 6966  eq 1 100); do if
-00011ec0: 2063 7572 6c20 2469 7020 7c20 6772 6570   curl $ip | grep
-00011ed0: 2022 3c68 313e 5468 6973 2069 7320 6120   "<h1>This is a 
-00011ee0: 6465 6d6f 2048 544d 4c20 7061 6765 2e3c  demo HTML page.<
-00011ef0: 2f68 313e 223b 2074 6865 6e20 7375 6363  /h1>"; then succ
-00011f00: 6573 733d 7472 7565 3b20 6272 6561 6b3b  ess=true; break;
-00011f10: 2066 693b 2073 6c65 6570 2035 3b20 646f   fi; sleep 5; do
-00011f20: 6e65 3b20 6966 205b 2022 2473 7563 6365  ne; if [ "$succe
-00011f30: 7373 2220 3d20 6661 6c73 6520 5d3b 2074  ss" = false ]; t
-00011f40: 6865 6e20 6578 6974 2031 3b20 6669 270a  hen exit 1; fi'.
-00011f50: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00011f60: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-00011f70: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
-00011f80: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00011f90: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
-00011fa0: 2d2d 2d2d 2d20 5765 6220 6170 7073 2077  ----- Web apps w
-00011fb0: 6974 6820 6375 7374 6f6d 2070 6f72 7473  ith custom ports
-00011fc0: 206f 6e20 5061 7065 7273 7061 6365 2e20   on Paperspace. 
-00011fd0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
-00011fe0: 7374 2e6d 6172 6b2e 7061 7065 7273 7061  st.mark.paperspa
-00011ff0: 6365 0a64 6566 2074 6573 745f 7061 7065  ce.def test_pape
-00012000: 7273 7061 6365 5f68 7474 705f 7365 7276  rspace_http_serv
-00012010: 6572 5f77 6974 685f 6375 7374 6f6d 5f70  er_with_custom_p
-00012020: 6f72 7473 2829 3a0a 2020 2020 6e61 6d65  orts():.    name
-00012030: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-00012040: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-00012050: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00012060: 2770 6170 6572 7370 6163 655f 6874 7470  'paperspace_http
-00012070: 5f73 6572 7665 725f 7769 7468 5f63 7573  _server_with_cus
-00012080: 746f 6d5f 706f 7274 7327 2c0a 2020 2020  tom_ports',.    
-00012090: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-000120a0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-000120b0: 7920 2d64 202d 6320 7b6e 616d 657d 202d  y -d -c {name} -
-000120c0: 2d63 6c6f 7564 2070 6170 6572 7370 6163  -cloud paperspac
-000120d0: 6520 6578 616d 706c 6573 2f68 7474 705f  e examples/http_
-000120e0: 7365 7276 6572 5f77 6974 685f 6375 7374  server_with_cust
-000120f0: 6f6d 5f70 6f72 7473 2f74 6173 6b2e 7961  om_ports/task.ya
-00012100: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00012110: 2066 2775 6e74 696c 2053 4b59 5049 4c4f   f'until SKYPILO
-00012120: 545f 4445 4255 473d 3020 736b 7920 7374  T_DEBUG=0 sky st
-00012130: 6174 7573 202d 2d65 6e64 706f 696e 7420  atus --endpoint 
-00012140: 3333 3832 3820 7b6e 616d 657d 3b20 646f  33828 {name}; do
-00012150: 2073 6c65 6570 2031 303b 2064 6f6e 6527   sleep 10; done'
-00012160: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00012170: 5265 7472 7920 6120 6665 7720 7469 6d65  Retry a few time
-00012180: 7320 746f 2061 766f 6964 2066 6c61 6b69  s to avoid flaki
-00012190: 6e65 7373 2069 6e20 706f 7274 7320 6265  ness in ports be
-000121a0: 696e 6720 6f70 656e 2e0a 2020 2020 2020  ing open..      
-000121b0: 2020 2020 2020 6627 6970 3d24 2853 4b59        f'ip=$(SKY
-000121c0: 5049 4c4f 545f 4445 4255 473d 3020 736b  PILOT_DEBUG=0 sk
-000121d0: 7920 7374 6174 7573 202d 2d65 6e64 706f  y status --endpo
-000121e0: 696e 7420 3333 3832 3820 7b6e 616d 657d  int 33828 {name}
-000121f0: 293b 2073 7563 6365 7373 3d66 616c 7365  ); success=false
-00012200: 3b20 666f 7220 6920 696e 2024 2873 6571  ; for i in $(seq
-00012210: 2031 2035 293b 2064 6f20 6966 2063 7572   1 5); do if cur
-00012220: 6c20 2469 7020 7c20 6772 6570 2022 3c68  l $ip | grep "<h
-00012230: 313e 5468 6973 2069 7320 6120 6465 6d6f  1>This is a demo
-00012240: 2048 544d 4c20 7061 6765 2e3c 2f68 313e   HTML page.</h1>
-00012250: 223b 2074 6865 6e20 7375 6363 6573 733d  "; then success=
-00012260: 7472 7565 3b20 6272 6561 6b3b 2066 693b  true; break; fi;
-00012270: 2073 6c65 6570 2031 303b 2064 6f6e 653b   sleep 10; done;
-00012280: 2069 6620 5b20 2224 7375 6363 6573 7322   if [ "$success"
-00012290: 203d 2066 616c 7365 205d 3b20 7468 656e   = false ]; then
-000122a0: 2065 7869 7420 313b 2066 6927 2c0a 2020   exit 1; fi',.  
-000122b0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-000122c0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-000122d0: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-000122e0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-000122f0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-00012300: 2d2d 2d20 4c61 6265 6c73 2066 726f 6d20  --- Labels from 
-00012310: 7461 736b 206f 6e20 4157 5320 2869 6e73  task on AWS (ins
-00012320: 7461 6e63 655f 7461 6773 2920 2d2d 2d2d  tance_tags) ----
-00012330: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
-00012340: 6172 6b2e 6177 730a 6465 6620 7465 7374  ark.aws.def test
-00012350: 5f74 6173 6b5f 6c61 6265 6c73 5f61 7773  _task_labels_aws
-00012360: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-00012370: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00012380: 2829 0a20 2020 2074 656d 706c 6174 655f  ().    template_
-00012390: 7374 7220 3d20 7061 7468 6c69 622e 5061  str = pathlib.Pa
-000123a0: 7468 280a 2020 2020 2020 2020 2774 6573  th(.        'tes
-000123b0: 7473 2f74 6573 745f 7961 6d6c 732f 7465  ts/test_yamls/te
-000123c0: 7374 5f6c 6162 656c 732e 7961 6d6c 2e6a  st_labels.yaml.j
-000123d0: 3227 292e 7265 6164 5f74 6578 7428 290a  2').read_text().
-000123e0: 2020 2020 7465 6d70 6c61 7465 203d 206a      template = j
-000123f0: 696e 6a61 322e 5465 6d70 6c61 7465 2874  inja2.Template(t
-00012400: 656d 706c 6174 655f 7374 7229 0a20 2020  emplate_str).   
-00012410: 2063 6f6e 7465 6e74 203d 2074 656d 706c   content = templ
-00012420: 6174 652e 7265 6e64 6572 2863 6c6f 7564  ate.render(cloud
-00012430: 3d27 6177 7327 2c20 7265 6769 6f6e 3d27  ='aws', region='
-00012440: 7573 2d65 6173 742d 3127 290a 2020 2020  us-east-1').    
-00012450: 7769 7468 2074 656d 7066 696c 652e 4e61  with tempfile.Na
-00012460: 6d65 6454 656d 706f 7261 7279 4669 6c65  medTemporaryFile
-00012470: 2873 7566 6669 783d 272e 7961 6d6c 272c  (suffix='.yaml',
-00012480: 206d 6f64 653d 2777 2729 2061 7320 663a   mode='w') as f:
-00012490: 0a20 2020 2020 2020 2066 2e77 7269 7465  .        f.write
-000124a0: 2863 6f6e 7465 6e74 290a 2020 2020 2020  (content).      
-000124b0: 2020 662e 666c 7573 6828 290a 2020 2020    f.flush().    
-000124c0: 2020 2020 6669 6c65 5f70 6174 6820 3d20      file_path = 
-000124d0: 662e 6e61 6d65 0a20 2020 2020 2020 2074  f.name.        t
-000124e0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-000124f0: 2020 2020 2020 2020 2774 6173 6b5f 6c61          'task_la
-00012500: 6265 6c73 5f61 7773 272c 0a20 2020 2020  bels_aws',.     
-00012510: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00012520: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00012530: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00012540: 657d 207b 6669 6c65 5f70 6174 687d 272c  e} {file_path}',
-00012550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012560: 2023 2056 6572 6966 7920 7769 7468 2061   # Verify with a
-00012570: 7773 2063 6c69 2074 6861 7420 7468 6520  ws cli that the 
-00012580: 7461 6773 2061 7265 2073 6574 2e0a 2020  tags are set..  
-00012590: 2020 2020 2020 2020 2020 2020 2020 2761                'a
-000125a0: 7773 2065 6332 2064 6573 6372 6962 652d  ws ec2 describe-
-000125b0: 696e 7374 616e 6365 7320 270a 2020 2020  instances '.    
-000125c0: 2020 2020 2020 2020 2020 2020 272d 2d71              '--q
-000125d0: 7565 7279 2022 5265 7365 7276 6174 696f  uery "Reservatio
-000125e0: 6e73 5b2a 5d2e 496e 7374 616e 6365 735b  ns[*].Instances[
-000125f0: 2a5d 2e49 6e73 7461 6e63 6549 6422 2027  *].InstanceId" '
-00012600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012610: 2027 2d2d 6669 6c74 6572 7320 224e 616d   '--filters "Nam
-00012620: 653d 696e 7374 616e 6365 2d73 7461 7465  e=instance-state
-00012630: 2d6e 616d 652c 5661 6c75 6573 3d72 756e  -name,Values=run
-00012640: 6e69 6e67 2220 270a 2020 2020 2020 2020  ning" '.        
-00012650: 2020 2020 2020 2020 6627 2d2d 6669 6c74          f'--filt
-00012660: 6572 7320 224e 616d 653d 7461 673a 736b  ers "Name=tag:sk
-00012670: 7970 696c 6f74 2d63 6c75 7374 6572 2d6e  ypilot-cluster-n
-00012680: 616d 652c 5661 6c75 6573 3d7b 6e61 6d65  ame,Values={name
-00012690: 7d2a 2220 270a 2020 2020 2020 2020 2020  }*" '.          
-000126a0: 2020 2020 2020 272d 2d66 696c 7465 7273        '--filters
-000126b0: 2022 4e61 6d65 3d74 6167 3a69 6e6c 696e   "Name=tag:inlin
-000126c0: 656c 6162 656c 312c 5661 6c75 6573 3d69  elabel1,Values=i
-000126d0: 6e6c 696e 6576 616c 7565 3122 2027 0a20  nlinevalue1" '. 
-000126e0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-000126f0: 2d2d 6669 6c74 6572 7320 224e 616d 653d  --filters "Name=
-00012700: 7461 673a 696e 6c69 6e65 6c61 6265 6c32  tag:inlinelabel2
-00012710: 2c56 616c 7565 733d 696e 6c69 6e65 7661  ,Values=inlineva
-00012720: 6c75 6532 2220 270a 2020 2020 2020 2020  lue2" '.        
-00012730: 2020 2020 2020 2020 272d 2d72 6567 696f          '--regio
-00012740: 6e20 7573 2d65 6173 742d 3120 2d2d 6f75  n us-east-1 --ou
-00012750: 7470 7574 2074 6578 7427 2c0a 2020 2020  tput text',.    
-00012760: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00012770: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-00012780: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-00012790: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000127a0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-000127b0: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
-000127c0: 2d20 4c61 6265 6c73 2066 726f 6d20 7461  - Labels from ta
-000127d0: 736b 206f 6e20 4743 5020 286c 6162 656c  sk on GCP (label
-000127e0: 7329 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  s) ----------.@p
-000127f0: 7974 6573 742e 6d61 726b 2e67 6370 0a64  ytest.mark.gcp.d
-00012800: 6566 2074 6573 745f 7461 736b 5f6c 6162  ef test_task_lab
-00012810: 656c 735f 6763 7028 293a 0a20 2020 206e  els_gcp():.    n
-00012820: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00012830: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-00012840: 6d70 6c61 7465 5f73 7472 203d 2070 6174  mplate_str = pat
-00012850: 686c 6962 2e50 6174 6828 0a20 2020 2020  hlib.Path(.     
-00012860: 2020 2027 7465 7374 732f 7465 7374 5f79     'tests/test_y
-00012870: 616d 6c73 2f74 6573 745f 6c61 6265 6c73  amls/test_labels
-00012880: 2e79 616d 6c2e 6a32 2729 2e72 6561 645f  .yaml.j2').read_
-00012890: 7465 7874 2829 0a20 2020 2074 656d 706c  text().    templ
-000128a0: 6174 6520 3d20 6a69 6e6a 6132 2e54 656d  ate = jinja2.Tem
-000128b0: 706c 6174 6528 7465 6d70 6c61 7465 5f73  plate(template_s
-000128c0: 7472 290a 2020 2020 636f 6e74 656e 7420  tr).    content 
-000128d0: 3d20 7465 6d70 6c61 7465 2e72 656e 6465  = template.rende
-000128e0: 7228 636c 6f75 643d 2767 6370 2729 0a20  r(cloud='gcp'). 
-000128f0: 2020 2077 6974 6820 7465 6d70 6669 6c65     with tempfile
-00012900: 2e4e 616d 6564 5465 6d70 6f72 6172 7946  .NamedTemporaryF
-00012910: 696c 6528 7375 6666 6978 3d27 2e79 616d  ile(suffix='.yam
-00012920: 6c27 2c20 6d6f 6465 3d27 7727 2920 6173  l', mode='w') as
-00012930: 2066 3a0a 2020 2020 2020 2020 662e 7772   f:.        f.wr
-00012940: 6974 6528 636f 6e74 656e 7429 0a20 2020  ite(content).   
-00012950: 2020 2020 2066 2e66 6c75 7368 2829 0a20       f.flush(). 
-00012960: 2020 2020 2020 2066 696c 655f 7061 7468         file_path
-00012970: 203d 2066 2e6e 616d 650a 2020 2020 2020   = f.name.      
-00012980: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00012990: 2020 2020 2020 2020 2020 2027 7461 736b             'task
-000129a0: 5f6c 6162 656c 735f 6763 7027 2c0a 2020  _labels_gcp',.  
-000129b0: 2020 2020 2020 2020 2020 5b0a 2020 2020            [.    
-000129c0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000129d0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-000129e0: 6e61 6d65 7d20 7b66 696c 655f 7061 7468  name} {file_path
-000129f0: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-00012a00: 2020 2020 2320 5665 7269 6679 2077 6974      # Verify wit
-00012a10: 6820 6763 6c6f 7564 2063 6c69 2074 6861  h gcloud cli tha
-00012a20: 7420 7468 6520 7461 6773 2061 7265 2073  t the tags are s
-00012a30: 6574 0a20 2020 2020 2020 2020 2020 2020  et.             
-00012a40: 2020 2066 2767 636c 6f75 6420 636f 6d70     f'gcloud comp
-00012a50: 7574 6520 696e 7374 616e 6365 7320 6c69  ute instances li
-00012a60: 7374 202d 2d66 696c 7465 723d 226e 616d  st --filter="nam
-00012a70: 657e 5c27 5e7b 6e61 6d65 7d5c 2720 414e  e~\'^{name}\' AN
-00012a80: 4420 270a 2020 2020 2020 2020 2020 2020  D '.            
-00012a90: 2020 2020 276c 6162 656c 732e 696e 6c69      'labels.inli
-00012aa0: 6e65 6c61 6265 6c31 3d5c 2769 6e6c 696e  nelabel1=\'inlin
-00012ab0: 6576 616c 7565 315c 2720 414e 4420 270a  evalue1\' AND '.
-00012ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ad0: 276c 6162 656c 732e 696e 6c69 6e65 6c61  'labels.inlinela
-00012ae0: 6265 6c32 3d5c 2769 6e6c 696e 6576 616c  bel2=\'inlineval
-00012af0: 7565 325c 2722 2027 0a20 2020 2020 2020  ue2\'" '.       
-00012b00: 2020 2020 2020 2020 2027 2d2d 666f 726d           '--form
-00012b10: 6174 3d22 7661 6c75 6528 6e61 6d65 2922  at="value(name)"
-00012b20: 207c 2067 7265 7020 2e27 2c0a 2020 2020   | grep .',.    
-00012b30: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00012b40: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-00012b50: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-00012b60: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00012b70: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00012b80: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
-00012b90: 2d20 4c61 6265 6c73 2066 726f 6d20 7461  - Labels from ta
-00012ba0: 736b 206f 6e20 4b75 6265 726e 6574 6573  sk on Kubernetes
-00012bb0: 2028 6c61 6265 6c73 2920 2d2d 2d2d 2d2d   (labels) ------
-00012bc0: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
-00012bd0: 6b2e 6b75 6265 726e 6574 6573 0a64 6566  k.kubernetes.def
-00012be0: 2074 6573 745f 7461 736b 5f6c 6162 656c   test_task_label
-00012bf0: 735f 6b75 6265 726e 6574 6573 2829 3a0a  s_kubernetes():.
-00012c00: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00012c10: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00012c20: 2020 2074 656d 706c 6174 655f 7374 7220     template_str 
-00012c30: 3d20 7061 7468 6c69 622e 5061 7468 280a  = pathlib.Path(.
-00012c40: 2020 2020 2020 2020 2774 6573 7473 2f74          'tests/t
-00012c50: 6573 745f 7961 6d6c 732f 7465 7374 5f6c  est_yamls/test_l
-00012c60: 6162 656c 732e 7961 6d6c 2e6a 3227 292e  abels.yaml.j2').
-00012c70: 7265 6164 5f74 6578 7428 290a 2020 2020  read_text().    
-00012c80: 7465 6d70 6c61 7465 203d 206a 696e 6a61  template = jinja
-00012c90: 322e 5465 6d70 6c61 7465 2874 656d 706c  2.Template(templ
-00012ca0: 6174 655f 7374 7229 0a20 2020 2063 6f6e  ate_str).    con
-00012cb0: 7465 6e74 203d 2074 656d 706c 6174 652e  tent = template.
-00012cc0: 7265 6e64 6572 2863 6c6f 7564 3d27 6b75  render(cloud='ku
-00012cd0: 6265 726e 6574 6573 2729 0a20 2020 2077  bernetes').    w
-00012ce0: 6974 6820 7465 6d70 6669 6c65 2e4e 616d  ith tempfile.Nam
-00012cf0: 6564 5465 6d70 6f72 6172 7946 696c 6528  edTemporaryFile(
-00012d00: 7375 6666 6978 3d27 2e79 616d 6c27 2c20  suffix='.yaml', 
-00012d10: 6d6f 6465 3d27 7727 2920 6173 2066 3a0a  mode='w') as f:.
-00012d20: 2020 2020 2020 2020 662e 7772 6974 6528          f.write(
-00012d30: 636f 6e74 656e 7429 0a20 2020 2020 2020  content).       
-00012d40: 2066 2e66 6c75 7368 2829 0a20 2020 2020   f.flush().     
-00012d50: 2020 2066 696c 655f 7061 7468 203d 2066     file_path = f
-00012d60: 2e6e 616d 650a 2020 2020 2020 2020 7465  .name.        te
-00012d70: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00012d80: 2020 2020 2020 2027 7461 736b 5f6c 6162         'task_lab
-00012d90: 656c 735f 6b75 6265 726e 6574 6573 272c  els_kubernetes',
-00012da0: 0a20 2020 2020 2020 2020 2020 205b 0a20  .            [. 
-00012db0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00012dc0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00012dd0: 6320 7b6e 616d 657d 207b 6669 6c65 5f70  c {name} {file_p
-00012de0: 6174 687d 272c 0a20 2020 2020 2020 2020  ath}',.         
-00012df0: 2020 2020 2020 2023 2056 6572 6966 7920         # Verify 
-00012e00: 7769 7468 206b 7562 6563 746c 2074 6861  with kubectl tha
-00012e10: 7420 7468 6520 6c61 6265 6c73 2061 7265  t the labels are
-00012e20: 2073 6574 2e0a 2020 2020 2020 2020 2020   set..          
-00012e30: 2020 2020 2020 276b 7562 6563 746c 2067        'kubectl g
-00012e40: 6574 2070 6f64 7320 270a 2020 2020 2020  et pods '.      
-00012e50: 2020 2020 2020 2020 2020 272d 2d73 656c            '--sel
-00012e60: 6563 746f 7220 696e 6c69 6e65 6c61 6265  ector inlinelabe
-00012e70: 6c31 3d69 6e6c 696e 6576 616c 7565 3120  l1=inlinevalue1 
-00012e80: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00012e90: 2020 272d 2d73 656c 6563 746f 7220 696e    '--selector in
-00012ea0: 6c69 6e65 6c61 6265 6c32 3d69 6e6c 696e  linelabel2=inlin
-00012eb0: 6576 616c 7565 3220 270a 2020 2020 2020  evalue2 '.      
-00012ec0: 2020 2020 2020 2020 2020 272d 6f20 6a73            '-o js
-00012ed0: 6f6e 7061 7468 3d5c 277b 2e69 7465 6d73  onpath=\'{.items
-00012ee0: 5b2a 5d2e 6d65 7461 6461 7461 2e6e 616d  [*].metadata.nam
-00012ef0: 657d 5c27 207c 2027 0a20 2020 2020 2020  e}\' | '.       
-00012f00: 2020 2020 2020 2020 2066 2767 7265 7020           f'grep 
-00012f10: 5c27 5e7b 6e61 6d65 7d5c 2727 0a20 2020  \'^{name}\''.   
-00012f20: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
-00012f30: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-00012f40: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-00012f50: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00012f60: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00012f70: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
-00012f80: 2d2d 2054 6173 6b3a 206e 3d32 206e 6f64  -- Task: n=2 nod
-00012f90: 6573 2077 6974 6820 7365 7475 7073 2e20  es with setups. 
-00012fa0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
-00012fb0: 7374 2e6d 6172 6b2e 6e6f 5f6c 616d 6264  st.mark.no_lambd
-00012fc0: 615f 636c 6f75 6420 2023 204c 616d 6264  a_cloud  # Lambd
-00012fd0: 6120 436c 6f75 6420 646f 6573 206e 6f74  a Cloud does not
-00012fe0: 2068 6176 6520 5631 3030 2067 7075 730a   have V100 gpus.
-00012ff0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00013000: 6962 6d20 2023 2049 424d 2063 6c6f 7564  ibm  # IBM cloud
-00013010: 2063 7572 7265 6e74 6c79 2064 6f65 736e   currently doesn
-00013020: 2774 2070 726f 7669 6465 2070 7562 6c69  't provide publi
-00013030: 6320 696d 6167 6520 7769 7468 2043 5544  c image with CUD
-00013040: 410a 4070 7974 6573 742e 6d61 726b 2e6e  A.@pytest.mark.n
-00013050: 6f5f 7363 7020 2023 2053 4350 2064 6f65  o_scp  # SCP doe
-00013060: 7320 6e6f 7420 7375 7070 6f72 7420 6e75  s not support nu
-00013070: 6d5f 6e6f 6465 7320 3e20 3120 7965 740a  m_nodes > 1 yet.
-00013080: 4070 7974 6573 742e 6d61 726b 2e73 6b69  @pytest.mark.ski
-00013090: 7028 0a20 2020 2072 6561 736f 6e3d 0a20  p(.    reason=. 
-000130a0: 2020 2027 5468 6520 7265 736e 6574 5f64     'The resnet_d
-000130b0: 6973 7472 6962 7574 6564 5f74 665f 6170  istributed_tf_ap
-000130c0: 7020 6973 2066 6c61 6b79 2c20 6475 6520  p is flaky, due 
-000130d0: 746f 2069 7420 6661 696c 696e 6720 746f  to it failing to
-000130e0: 2064 6574 6563 7420 4750 5573 2e27 290a   detect GPUs.').
-000130f0: 6465 6620 7465 7374 5f64 6973 7472 6962  def test_distrib
-00013100: 7574 6564 5f74 6628 6765 6e65 7269 635f  uted_tf(generic_
-00013110: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
-00013120: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00013130: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00013140: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00013150: 2020 2020 2027 7265 736e 6574 5f64 6973       'resnet_dis
-00013160: 7472 6962 7574 6564 5f74 665f 6170 7027  tributed_tf_app'
-00013170: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00013180: 2020 2020 2020 2020 2320 4e4f 5445 3a20          # NOTE: 
-00013190: 7275 6e6e 696e 6720 6974 2074 7769 6365  running it twice
-000131a0: 2077 696c 6c20 6861 6e67 2028 736f 6d65   will hang (some
-000131b0: 7469 6d65 733f 2920 2d20 616e 2061 7070  times?) - an app
-000131c0: 2d6c 6576 656c 2062 7567 2e0a 2020 2020  -level bug..    
-000131d0: 2020 2020 2020 2020 6627 7079 7468 6f6e          f'python
-000131e0: 2065 7861 6d70 6c65 732f 7265 736e 6574   examples/resnet
-000131f0: 5f64 6973 7472 6962 7574 6564 5f74 665f  _distributed_tf_
-00013200: 6170 702e 7079 207b 6e61 6d65 7d20 7b67  app.py {name} {g
-00013210: 656e 6572 6963 5f63 6c6f 7564 7d27 2c0a  eneric_cloud}',.
-00013220: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00013230: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-00013240: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-00013250: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-00013260: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-00013270: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-00013280: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-00013290: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-000132a0: 743d 3235 202a 2036 302c 2020 2320 3235  t=25 * 60,  # 25
-000132b0: 206d 696e 7320 2869 7420 7461 6b65 7320   mins (it takes 
-000132c0: 6172 6f75 6e64 207e 3139 206d 696e 7329  around ~19 mins)
-000132d0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-000132e0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-000132f0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
-00013300: 7469 6e67 2047 4350 2073 7461 7274 2061  ting GCP start a
-00013310: 6e64 2073 746f 7020 696e 7374 616e 6365  nd stop instance
-00013320: 7320 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  s ----------.@py
-00013330: 7465 7374 2e6d 6172 6b2e 6763 700a 6465  test.mark.gcp.de
-00013340: 6620 7465 7374 5f67 6370 5f73 7461 7274  f test_gcp_start
-00013350: 5f73 746f 7028 293a 0a20 2020 206e 616d  _stop():.    nam
-00013360: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00013370: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00013380: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00013390: 2027 6763 702d 7374 6172 742d 7374 6f70   'gcp-start-stop
-000133a0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-000133b0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-000133c0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-000133d0: 657d 2065 7861 6d70 6c65 732f 6763 705f  e} examples/gcp_
-000133e0: 7374 6172 745f 7374 6f70 2e79 616d 6c27  start_stop.yaml'
-000133f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00013400: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00013410: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
-00013420: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-00013430: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-00013440: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-00013450: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
-00013460: 2f67 6370 5f73 7461 7274 5f73 746f 702e  /gcp_start_stop.
-00013470: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00013480: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00013490: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
-000134a0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-000134b0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-000134c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000134d0: 2065 7865 6320 7b6e 616d 657d 2022 7072   exec {name} "pr
-000134e0: 6c69 6d69 7420 2d6e 202d 2d70 6964 3d5c  limit -n --pid=\
-000134f0: 2428 7067 7265 7020 2d66 205c 2772 6179  $(pgrep -f \'ray
-00013500: 6c65 742f 7261 796c 6574 202d 2d72 6179  let/raylet --ray
-00013510: 6c65 745f 736f 636b 6574 5f6e 616d 655c  let_socket_name\
-00013520: 2729 207c 2067 7265 7020 5c27 225c 2731  ') | grep \'"\'1
-00013530: 3034 3835 3736 2031 3034 3835 3736 5c27  048576 1048576\'
-00013540: 225c 2722 272c 2020 2320 456e 7375 7265  "\'"',  # Ensure
-00013550: 2074 6865 2072 6179 6c65 7420 7072 6f63   the raylet proc
-00013560: 6573 7320 6861 7320 7468 6520 636f 7272  ess has the corr
-00013570: 6563 7420 6669 6c65 2064 6573 6372 6970  ect file descrip
-00013580: 746f 7220 6c69 6d69 742e 0a20 2020 2020  tor limit..     
-00013590: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-000135a0: 7320 7b6e 616d 657d 2033 202d 2d73 7461  s {name} 3 --sta
-000135b0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-000135c0: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-000135d0: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
-000135e0: 2773 6b79 2073 746f 7020 2d79 207b 6e61  'sky stop -y {na
-000135f0: 6d65 7d27 2c0a 2020 2020 2020 2020 2020  me}',.          
-00013600: 2020 6627 736c 6565 7020 3230 272c 0a20    f'sleep 20',. 
-00013610: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00013620: 2073 7461 7274 202d 7920 7b6e 616d 657d   start -y {name}
-00013630: 202d 6920 3127 2c0a 2020 2020 2020 2020   -i 1',.        
-00013640: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00013650: 6e61 6d65 7d20 6578 616d 706c 6573 2f67  name} examples/g
-00013660: 6370 5f73 7461 7274 5f73 746f 702e 7961  cp_start_stop.ya
-00013670: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00013680: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00013690: 657d 2034 202d 2d73 7461 7475 7327 2c20  e} 4 --status', 
-000136a0: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
-000136b0: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
-000136c0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-000136d0: 3138 3027 2c0a 2020 2020 2020 2020 2020  180',.          
-000136e0: 2020 6627 736b 7920 7374 6174 7573 202d    f'sky status -
-000136f0: 7220 7b6e 616d 657d 207c 2067 7265 7020  r {name} | grep 
-00013700: 2249 4e49 545c 7c53 544f 5050 4544 2227  "INIT\|STOPPED"'
-00013710: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-00013720: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-00013730: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-00013740: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00013750: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-00013760: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
-00013770: 417a 7572 6520 7374 6172 7420 616e 6420  Azure start and 
-00013780: 7374 6f70 2069 6e73 7461 6e63 6573 202d  stop instances -
-00013790: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
-000137a0: 742e 6d61 726b 2e61 7a75 7265 0a64 6566  t.mark.azure.def
-000137b0: 2074 6573 745f 617a 7572 655f 7374 6172   test_azure_star
-000137c0: 745f 7374 6f70 2829 3a0a 2020 2020 6e61  t_stop():.    na
-000137d0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-000137e0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-000137f0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00013800: 2020 2761 7a75 7265 2d73 7461 7274 2d73    'azure-start-s
-00013810: 746f 7027 2c0a 2020 2020 2020 2020 5b0a  top',.        [.
-00013820: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00013830: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-00013840: 6e61 6d65 7d20 6578 616d 706c 6573 2f61  name} examples/a
-00013850: 7a75 7265 5f73 7461 7274 5f73 746f 702e  zure_start_stop.
-00013860: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00013870: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00013880: 616d 657d 2065 7861 6d70 6c65 732f 617a  ame} examples/az
-00013890: 7572 655f 7374 6172 745f 7374 6f70 2e79  ure_start_stop.y
-000138a0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-000138b0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-000138c0: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-000138d0: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-000138e0: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-000138f0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00013900: 6578 6563 207b 6e61 6d65 7d20 2270 726c  exec {name} "prl
-00013910: 696d 6974 202d 6e20 2d2d 7069 643d 5c24  imit -n --pid=\$
-00013920: 2870 6772 6570 202d 6620 5c27 7261 796c  (pgrep -f \'rayl
-00013930: 6574 2f72 6179 6c65 7420 2d2d 7261 796c  et/raylet --rayl
-00013940: 6574 5f73 6f63 6b65 745f 6e61 6d65 5c27  et_socket_name\'
-00013950: 2920 7c20 6772 6570 205c 2722 5c27 3130  ) | grep \'"\'10
-00013960: 3438 3537 3620 3130 3438 3537 365c 2722  48576 1048576\'"
-00013970: 5c27 2227 2c20 2023 2045 6e73 7572 6520  \'"',  # Ensure 
-00013980: 7468 6520 7261 796c 6574 2070 726f 6365  the raylet proce
-00013990: 7373 2068 6173 2074 6865 2063 6f72 7265  ss has the corre
-000139a0: 6374 2066 696c 6520 6465 7363 7269 7074  ct file descript
-000139b0: 6f72 206c 696d 6974 2e0a 2020 2020 2020  or limit..      
-000139c0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-000139d0: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
-000139e0: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
-000139f0: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
-00013a00: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00013a10: 736b 7920 7374 6f70 202d 7920 7b6e 616d  sky stop -y {nam
-00013a20: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
-00013a30: 2066 2773 6b79 2073 7461 7274 202d 7920   f'sky start -y 
-00013a40: 7b6e 616d 657d 202d 6920 3127 2c0a 2020  {name} -i 1',.  
-00013a50: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00013a60: 6578 6563 207b 6e61 6d65 7d20 6578 616d  exec {name} exam
-00013a70: 706c 6573 2f61 7a75 7265 5f73 7461 7274  ples/azure_start
-00013a80: 5f73 746f 702e 7961 6d6c 272c 0a20 2020  _stop.yaml',.   
-00013a90: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00013aa0: 6f67 7320 7b6e 616d 657d 2033 202d 2d73  ogs {name} 3 --s
-00013ab0: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-00013ac0: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-00013ad0: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-00013ae0: 2027 736c 6565 7020 3236 3027 2c0a 2020   'sleep 260',.  
-00013af0: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-00013b00: 736b 7920 7374 6174 7573 202d 7220 7b6e  sky status -r {n
-00013b10: 616d 657d 2920 2626 2065 6368 6f20 2224  ame}) && echo "$
-00013b20: 7322 2026 2620 6563 686f 2022 2473 2220  s" && echo "$s" 
-00013b30: 7c20 6772 6570 2022 494e 4954 5c7c 5354  | grep "INIT\|ST
-00013b40: 4f50 5045 4422 270a 2020 2020 2020 2020  OPPED"'.        
-00013b50: 2020 2020 6627 7c7c 207b 7b20 7373 6820      f'|| {{ ssh 
-00013b60: 7b6e 616d 657d 2022 6361 7420 7e2f 2e73  {name} "cat ~/.s
-00013b70: 6b79 2f73 6b79 6c65 742e 6c6f 6722 3b20  ky/skylet.log"; 
-00013b80: 6578 6974 2031 3b20 7d7d 270a 2020 2020  exit 1; }}'.    
-00013b90: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-00013ba0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00013bb0: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
-00013bc0: 6d65 6f75 743d 3330 202a 2036 302c 2020  meout=30 * 60,  
-00013bd0: 2320 3330 206d 696e 730a 2020 2020 290a  # 30 mins.    ).
-00013be0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00013bf0: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
-00013c00: 2d2d 2d2d 2d20 5465 7374 696e 6720 4175  ----- Testing Au
-00013c10: 746f 7374 6f70 7069 6e67 202d 2d2d 2d2d  tostopping -----
-00013c20: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
-00013c30: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
-00013c40: 2020 2320 466c 7569 6453 7461 636b 2064    # FluidStack d
-00013c50: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-00013c60: 7374 6f70 7069 6e67 2069 6e20 536b 7950  stopping in SkyP
-00013c70: 696c 6f74 2069 6d70 6c65 6d65 6e74 6174  ilot implementat
-00013c80: 696f 6e0a 4070 7974 6573 742e 6d61 726b  ion.@pytest.mark
-00013c90: 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f 7564  .no_lambda_cloud
-00013ca0: 2020 2320 4c61 6d62 6461 2043 6c6f 7564    # Lambda Cloud
-00013cb0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00013cc0: 7420 7374 6f70 7069 6e67 2069 6e73 7461  t stopping insta
-00013cd0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-00013ce0: 6b2e 6e6f 5f69 626d 2020 2320 4649 5828  k.no_ibm  # FIX(
-00013cf0: 4942 4d29 2073 706f 7261 6469 6361 6c6c  IBM) sporadicall
-00013d00: 7920 6661 696c 732c 2061 7320 7265 7374  y fails, as rest
-00013d10: 6172 7465 6420 776f 726b 6572 7320 7374  arted workers st
-00013d20: 6179 2075 6e69 6e69 7469 616c 697a 6564  ay uninitialized
-00013d30: 2069 6e64 6566 696e 6974 656c 790a 4070   indefinitely.@p
-00013d40: 7974 6573 742e 6d61 726b 2e6e 6f5f 7363  ytest.mark.no_sc
-00013d50: 7020 2023 2053 4350 2064 6f65 7320 6e6f  p  # SCP does no
-00013d60: 7420 7375 7070 6f72 7420 6e75 6d5f 6e6f  t support num_no
-00013d70: 6465 7320 3e20 3120 7965 740a 4070 7974  des > 1 yet.@pyt
-00013d80: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
-00013d90: 726e 6574 6573 2020 2320 4b75 6265 726e  rnetes  # Kubern
-00013da0: 6574 6573 2064 6f65 7320 6e6f 7420 6175  etes does not au
-00013db0: 746f 7374 6f70 2079 6574 0a64 6566 2074  tostop yet.def t
-00013dc0: 6573 745f 6175 746f 7374 6f70 2867 656e  est_autostop(gen
-00013dd0: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-00013de0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-00013df0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00013e00: 0a20 2020 2023 2041 7a75 7265 2074 616b  .    # Azure tak
-00013e10: 6573 207e 2037 6d31 3573 2028 3433 3573  es ~ 7m15s (435s
-00013e20: 2920 746f 2061 7574 6f73 746f 7020 6120  ) to autostop a 
-00013e30: 564d 2c20 736f 2068 6572 6520 7765 2075  VM, so here we u
-00013e40: 7365 2036 3030 2074 6f20 656e 7375 7265  se 600 to ensure
-00013e50: 0a20 2020 2023 2074 6865 2056 4d20 6973  .    # the VM is
-00013e60: 2073 746f 7070 6564 2e0a 2020 2020 6175   stopped..    au
-00013e70: 746f 7374 6f70 5f74 696d 656f 7574 203d  tostop_timeout =
-00013e80: 2036 3030 2069 6620 6765 6e65 7269 635f   600 if generic_
-00013e90: 636c 6f75 6420 3d3d 2027 617a 7572 6527  cloud == 'azure'
-00013ea0: 2065 6c73 6520 3235 300a 2020 2020 2320   else 250.    # 
-00013eb0: 4c61 756e 6368 696e 6720 616e 6420 7374  Launching and st
-00013ec0: 6172 7469 6e67 2041 7a75 7265 2063 6c75  arting Azure clu
-00013ed0: 7374 6572 7320 6361 6e20 7461 6b65 2061  sters can take a
-00013ee0: 206c 6f6e 6720 7469 6d65 2074 6f6f 2e20   long time too. 
-00013ef0: 652e 672e 2c20 7265 7374 6172 740a 2020  e.g., restart.  
-00013f00: 2020 2320 6120 7374 6f70 7065 6420 417a    # a stopped Az
-00013f10: 7572 6520 636c 7573 7465 7220 6361 6e20  ure cluster can 
-00013f20: 7461 6b65 2037 6d2e 2053 6f20 7765 2073  take 7m. So we s
-00013f30: 6574 2074 6865 2074 6f74 616c 2074 696d  et the total tim
-00013f40: 656f 7574 2074 6f20 3730 6d2e 0a20 2020  eout to 70m..   
-00013f50: 2074 6f74 616c 5f74 696d 656f 7574 5f6d   total_timeout_m
-00013f60: 696e 7574 6573 203d 2037 3020 6966 2067  inutes = 70 if g
-00013f70: 656e 6572 6963 5f63 6c6f 7564 203d 3d20  eneric_cloud == 
-00013f80: 2761 7a75 7265 2720 656c 7365 2032 300a  'azure' else 20.
-00013f90: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00013fa0: 0a20 2020 2020 2020 2027 6175 746f 7374  .        'autost
-00013fb0: 6f70 272c 0a20 2020 2020 2020 205b 0a20  op',.        [. 
-00013fc0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00013fd0: 206c 6175 6e63 6820 2d79 202d 6420 2d63   launch -y -d -c
-00013fe0: 207b 6e61 6d65 7d20 2d2d 6e75 6d2d 6e6f   {name} --num-no
-00013ff0: 6465 7320 3220 2d2d 636c 6f75 6420 7b67  des 2 --cloud {g
-00014000: 656e 6572 6963 5f63 6c6f 7564 7d20 7465  eneric_cloud} te
-00014010: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
-00014020: 696e 696d 616c 2e79 616d 6c27 2c0a 2020  inimal.yaml',.  
-00014030: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00014040: 6175 746f 7374 6f70 202d 7920 7b6e 616d  autostop -y {nam
-00014050: 657d 202d 6920 3127 2c0a 0a20 2020 2020  e} -i 1',..     
-00014060: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
-00014070: 6175 746f 7374 6f70 2069 7320 7365 742e  autostop is set.
-00014080: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00014090: 6b79 2073 7461 7475 7320 7c20 6772 6570  ky status | grep
-000140a0: 207b 6e61 6d65 7d20 7c20 6772 6570 2022   {name} | grep "
-000140b0: 316d 2227 2c0a 0a20 2020 2020 2020 2020  1m"',..         
-000140c0: 2020 2023 2045 6e73 7572 6520 7468 6520     # Ensure the 
-000140d0: 636c 7573 7465 7220 6973 206e 6f74 2073  cluster is not s
-000140e0: 746f 7070 6564 2065 6172 6c79 2e0a 2020  topped early..  
-000140f0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-00014100: 2034 3027 2c0a 2020 2020 2020 2020 2020   40',.          
-00014110: 2020 6627 733d 2428 736b 7920 7374 6174    f's=$(sky stat
-00014120: 7573 207b 6e61 6d65 7d20 2d2d 7265 6672  us {name} --refr
-00014130: 6573 6829 3b20 6563 686f 2022 2473 223b  esh); echo "$s";
-00014140: 2065 6368 6f3b 2065 6368 6f3b 2065 6368   echo; echo; ech
-00014150: 6f20 2224 7322 2020 7c20 6772 6570 207b  o "$s"  | grep {
-00014160: 6e61 6d65 7d20 7c20 6772 6570 2055 5027  name} | grep UP'
-00014170: 2c0a 0a20 2020 2020 2020 2020 2020 2023  ,..            #
-00014180: 2045 6e73 7572 6520 7468 6520 636c 7573   Ensure the clus
-00014190: 7465 7220 6973 2053 544f 5050 4544 2e0a  ter is STOPPED..
-000141a0: 2020 2020 2020 2020 2020 2020 6627 736c              f'sl
-000141b0: 6565 7020 7b61 7574 6f73 746f 705f 7469  eep {autostop_ti
-000141c0: 6d65 6f75 747d 272c 0a20 2020 2020 2020  meout}',.       
-000141d0: 2020 2020 2066 2773 3d24 2873 6b79 2073       f's=$(sky s
-000141e0: 7461 7475 7320 7b6e 616d 657d 202d 2d72  tatus {name} --r
-000141f0: 6566 7265 7368 293b 2065 6368 6f20 2224  efresh); echo "$
-00014200: 7322 3b20 6563 686f 3b20 6563 686f 3b20  s"; echo; echo; 
-00014210: 6563 686f 2022 2473 2220 207c 2067 7265  echo "$s"  | gre
-00014220: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
-00014230: 5354 4f50 5045 4427 2c0a 0a20 2020 2020  STOPPED',..     
-00014240: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
-00014250: 7468 6520 636c 7573 7465 7220 6973 2055  the cluster is U
-00014260: 5020 616e 6420 7468 6520 6175 746f 7374  P and the autost
-00014270: 6f70 2073 6574 7469 6e67 2069 7320 7265  op setting is re
-00014280: 7365 7420 2827 2d27 292e 0a20 2020 2020  set ('-')..     
-00014290: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
-000142a0: 7274 202d 7920 7b6e 616d 657d 272c 0a20  rt -y {name}',. 
-000142b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000142c0: 2073 7461 7475 7320 7c20 6772 6570 207b   status | grep {
-000142d0: 6e61 6d65 7d20 7c20 6772 6570 202d 4520  name} | grep -E 
-000142e0: 2255 505c 732b 2d22 272c 0a0a 2020 2020  "UP\s+-"',..    
-000142f0: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
-00014300: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
-00014310: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-00014320: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-00014330: 7d20 7465 7374 732f 7465 7374 5f79 616d  } tests/test_yam
-00014340: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
-00014350: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00014360: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00014370: 3220 2d2d 7374 6174 7573 272c 0a0a 2020  2 --status',..  
-00014380: 2020 2020 2020 2020 2020 2320 5465 7374            # Test
-00014390: 2072 6573 7461 7274 696e 6720 7468 6520   restarting the 
-000143a0: 6964 6c65 6e65 7373 2074 696d 6572 2076  idleness timer v
-000143b0: 6961 2072 6573 6574 3a0a 2020 2020 2020  ia reset:.      
-000143c0: 2020 2020 2020 6627 736b 7920 6175 746f        f'sky auto
-000143d0: 7374 6f70 202d 7920 7b6e 616d 657d 202d  stop -y {name} -
-000143e0: 6920 3127 2c20 2023 2049 646c 656e 6573  i 1',  # Idlenes
-000143f0: 7320 7374 6172 7473 2063 6f75 6e74 696e  s starts countin
-00014400: 672e 0a20 2020 2020 2020 2020 2020 2027  g..            '
-00014410: 736c 6565 7020 3430 272c 2020 2320 416c  sleep 40',  # Al
-00014420: 6d6f 7374 2072 6561 6368 6564 2074 6865  most reached the
-00014430: 2074 6872 6573 686f 6c64 2e0a 2020 2020   threshold..    
-00014440: 2020 2020 2020 2020 6627 736b 7920 6175          f'sky au
-00014450: 746f 7374 6f70 202d 7920 7b6e 616d 657d  tostop -y {name}
-00014460: 202d 6920 3127 2c20 2023 2053 686f 756c   -i 1',  # Shoul
-00014470: 6420 7265 7374 6172 7420 7468 6520 7469  d restart the ti
-00014480: 6d65 722e 0a20 2020 2020 2020 2020 2020  mer..           
-00014490: 2027 736c 6565 7020 3430 272c 0a20 2020   'sleep 40',.   
-000144a0: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-000144b0: 6b79 2073 7461 7475 7320 7b6e 616d 657d  ky status {name}
-000144c0: 202d 2d72 6566 7265 7368 293b 2065 6368   --refresh); ech
-000144d0: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
-000144e0: 686f 3b20 6563 686f 2022 2473 2220 7c20  ho; echo "$s" | 
-000144f0: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
-00014500: 6570 2055 5027 2c0a 2020 2020 2020 2020  ep UP',.        
-00014510: 2020 2020 6627 736c 6565 7020 7b61 7574      f'sleep {aut
-00014520: 6f73 746f 705f 7469 6d65 6f75 747d 272c  ostop_timeout}',
-00014530: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00014540: 3d24 2873 6b79 2073 7461 7475 7320 7b6e  =$(sky status {n
-00014550: 616d 657d 202d 2d72 6566 7265 7368 293b  ame} --refresh);
-00014560: 2065 6368 6f20 2224 7322 3b20 6563 686f   echo "$s"; echo
-00014570: 3b20 6563 686f 3b20 6563 686f 2022 2473  ; echo; echo "$s
-00014580: 2220 207c 2067 7265 7020 7b6e 616d 657d  "  | grep {name}
-00014590: 207c 2067 7265 7020 5354 4f50 5045 4427   | grep STOPPED'
-000145a0: 2c0a 0a20 2020 2020 2020 2020 2020 2023  ,..            #
-000145b0: 2054 6573 7420 7265 7374 6172 7469 6e67   Test restarting
-000145c0: 2074 6865 2069 646c 656e 6573 7320 7469   the idleness ti
-000145d0: 6d65 7220 7669 6120 6578 6563 3a0a 2020  mer via exec:.  
-000145e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000145f0: 7374 6172 7420 2d79 207b 6e61 6d65 7d27  start -y {name}'
-00014600: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00014610: 736b 7920 7374 6174 7573 207c 2067 7265  sky status | gre
-00014620: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
-00014630: 2d45 2022 5550 5c73 2b2d 2227 2c0a 2020  -E "UP\s+-"',.  
-00014640: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00014650: 6175 746f 7374 6f70 202d 7920 7b6e 616d  autostop -y {nam
-00014660: 657d 202d 6920 3127 2c20 2023 2049 646c  e} -i 1',  # Idl
-00014670: 656e 6573 7320 7374 6172 7473 2063 6f75  eness starts cou
-00014680: 6e74 696e 672e 0a20 2020 2020 2020 2020  nting..         
-00014690: 2020 2027 736c 6565 7020 3435 272c 2020     'sleep 45',  
-000146a0: 2320 416c 6d6f 7374 2072 6561 6368 6564  # Almost reached
-000146b0: 2074 6865 2074 6872 6573 686f 6c64 2e0a   the threshold..
-000146c0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000146d0: 7920 6578 6563 207b 6e61 6d65 7d20 6563  y exec {name} ec
-000146e0: 686f 2068 6927 2c20 2023 2053 686f 756c  ho hi',  # Shoul
-000146f0: 6420 7265 7374 6172 7420 7468 6520 7469  d restart the ti
-00014700: 6d65 722e 0a20 2020 2020 2020 2020 2020  mer..           
-00014710: 2027 736c 6565 7020 3435 272c 0a20 2020   'sleep 45',.   
-00014720: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-00014730: 6b79 2073 7461 7475 7320 7b6e 616d 657d  ky status {name}
-00014740: 202d 2d72 6566 7265 7368 293b 2065 6368   --refresh); ech
-00014750: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
-00014760: 686f 3b20 6563 686f 2022 2473 2220 207c  ho; echo "$s"  |
-00014770: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-00014780: 7265 7020 5550 272c 0a20 2020 2020 2020  rep UP',.       
-00014790: 2020 2020 2066 2773 6c65 6570 207b 6175       f'sleep {au
-000147a0: 746f 7374 6f70 5f74 696d 656f 7574 7d27  tostop_timeout}'
-000147b0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000147c0: 733d 2428 736b 7920 7374 6174 7573 207b  s=$(sky status {
-000147d0: 6e61 6d65 7d20 2d2d 7265 6672 6573 6829  name} --refresh)
-000147e0: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
-000147f0: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
-00014800: 7322 2020 7c20 6772 6570 207b 6e61 6d65  s"  | grep {name
-00014810: 7d20 7c20 6772 6570 2053 544f 5050 4544  } | grep STOPPED
-00014820: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-00014830: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-00014840: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00014850: 2020 2020 2074 696d 656f 7574 3d74 6f74       timeout=tot
-00014860: 616c 5f74 696d 656f 7574 5f6d 696e 7574  al_timeout_minut
-00014870: 6573 202a 2036 302c 0a20 2020 2029 0a20  es * 60,.    ). 
-00014880: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00014890: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-000148a0: 2d2d 2d2d 2054 6573 7469 6e67 2041 7574  ---- Testing Aut
-000148b0: 6f64 6f77 6e69 6e67 202d 2d2d 2d2d 2d2d  odowning -------
-000148c0: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
-000148d0: 2e6e 6f5f 666c 7569 6473 7461 636b 2020  .no_fluidstack  
-000148e0: 2320 466c 7569 6453 7461 636b 2064 6f65  # FluidStack doe
-000148f0: 7320 6e6f 7420 7375 7070 6f72 7420 7374  s not support st
-00014900: 6f70 7069 6e67 2069 6e20 536b 7950 696c  opping in SkyPil
-00014910: 6f74 2069 6d70 6c65 6d65 6e74 6174 696f  ot implementatio
-00014920: 6e0a 4070 7974 6573 742e 6d61 726b 2e6e  n.@pytest.mark.n
-00014930: 6f5f 7363 7020 2023 2053 4350 2064 6f65  o_scp  # SCP doe
-00014940: 7320 6e6f 7420 7375 7070 6f72 7420 6e75  s not support nu
-00014950: 6d5f 6e6f 6465 7320 3e20 3120 7965 742e  m_nodes > 1 yet.
-00014960: 2052 756e 2074 6573 745f 7363 705f 6175   Run test_scp_au
-00014970: 746f 646f 776e 2069 6e73 7465 6164 2e0a  todown instead..
-00014980: 6465 6620 7465 7374 5f61 7574 6f64 6f77  def test_autodow
-00014990: 6e28 6765 6e65 7269 635f 636c 6f75 643a  n(generic_cloud:
-000149a0: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
-000149b0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-000149c0: 616d 6528 290a 2020 2020 2320 417a 7572  ame().    # Azur
-000149d0: 6520 7461 6b65 7320 7e20 3133 6d33 3073  e takes ~ 13m30s
-000149e0: 2028 3831 3073 2920 746f 2061 7574 6f64   (810s) to autod
-000149f0: 6f77 6e20 6120 564d 2c20 736f 2068 6572  own a VM, so her
-00014a00: 6520 7765 2075 7365 2039 3030 2074 6f20  e we use 900 to 
-00014a10: 656e 7375 7265 0a20 2020 2023 2074 6865  ensure.    # the
-00014a20: 2056 4d20 6973 2074 6572 6d69 6e61 7465   VM is terminate
-00014a30: 642e 0a20 2020 2061 7574 6f64 6f77 6e5f  d..    autodown_
-00014a40: 7469 6d65 6f75 7420 3d20 3930 3020 6966  timeout = 900 if
-00014a50: 2067 656e 6572 6963 5f63 6c6f 7564 203d   generic_cloud =
-00014a60: 3d20 2761 7a75 7265 2720 656c 7365 2032  = 'azure' else 2
-00014a70: 3430 0a20 2020 2074 6f74 616c 5f74 696d  40.    total_tim
-00014a80: 656f 7574 5f6d 696e 7574 6573 203d 2039  eout_minutes = 9
-00014a90: 3020 6966 2067 656e 6572 6963 5f63 6c6f  0 if generic_clo
-00014aa0: 7564 203d 3d20 2761 7a75 7265 2720 656c  ud == 'azure' el
-00014ab0: 7365 2032 300a 2020 2020 7465 7374 203d  se 20.    test =
-00014ac0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00014ad0: 6175 746f 646f 776e 272c 0a20 2020 2020  autodown',.     
-00014ae0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00014af0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-00014b00: 202d 6420 2d63 207b 6e61 6d65 7d20 2d2d   -d -c {name} --
-00014b10: 6e75 6d2d 6e6f 6465 7320 3220 2d2d 636c  num-nodes 2 --cl
-00014b20: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-00014b30: 7564 7d20 7465 7374 732f 7465 7374 5f79  ud} tests/test_y
-00014b40: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
-00014b50: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00014b60: 6627 736b 7920 6175 746f 7374 6f70 202d  f'sky autostop -
-00014b70: 7920 7b6e 616d 657d 202d 2d64 6f77 6e20  y {name} --down 
-00014b80: 2d69 2031 272c 0a20 2020 2020 2020 2020  -i 1',.         
-00014b90: 2020 2023 2045 6e73 7572 6520 6175 746f     # Ensure auto
-00014ba0: 7374 6f70 2069 7320 7365 742e 0a20 2020  stop is set..   
-00014bb0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-00014bc0: 7461 7475 7320 7c20 6772 6570 207b 6e61  tatus | grep {na
-00014bd0: 6d65 7d20 7c20 6772 6570 2022 316d 2028  me} | grep "1m (
-00014be0: 646f 776e 2922 272c 0a20 2020 2020 2020  down)"',.       
-00014bf0: 2020 2020 2023 2045 6e73 7572 6520 7468       # Ensure th
-00014c00: 6520 636c 7573 7465 7220 6973 206e 6f74  e cluster is not
-00014c10: 2074 6572 6d69 6e61 7465 6420 6561 726c   terminated earl
-00014c20: 792e 0a20 2020 2020 2020 2020 2020 2027  y..            '
-00014c30: 736c 6565 7020 3430 272c 0a20 2020 2020  sleep 40',.     
-00014c40: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-00014c50: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
-00014c60: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
-00014c70: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
-00014c80: 3b20 6563 686f 2022 2473 2220 207c 2067  ; echo "$s"  | g
-00014c90: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-00014ca0: 7020 5550 272c 0a20 2020 2020 2020 2020  p UP',.         
-00014cb0: 2020 2023 2045 6e73 7572 6520 7468 6520     # Ensure the 
-00014cc0: 636c 7573 7465 7220 6973 2074 6572 6d69  cluster is termi
-00014cd0: 6e61 7465 642e 0a20 2020 2020 2020 2020  nated..         
-00014ce0: 2020 2066 2773 6c65 6570 207b 6175 746f     f'sleep {auto
-00014cf0: 646f 776e 5f74 696d 656f 7574 7d27 2c0a  down_timeout}',.
-00014d00: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
-00014d10: 2428 534b 5950 494c 4f54 5f44 4542 5547  $(SKYPILOT_DEBUG
-00014d20: 3d30 2073 6b79 2073 7461 7475 7320 7b6e  =0 sky status {n
-00014d30: 616d 657d 202d 2d72 6566 7265 7368 2920  ame} --refresh) 
-00014d40: 2626 2065 6368 6f20 2224 7322 2026 2620  && echo "$s" && 
-00014d50: 7b7b 2065 6368 6f20 2224 7322 207c 2067  {{ echo "$s" | g
-00014d60: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-00014d70: 7020 2241 7574 6f64 6f77 6e65 6420 636c  p "Autodowned cl
-00014d80: 7573 7465 725c 7c74 6572 6d69 6e61 7465  uster\|terminate
-00014d90: 6420 6f6e 2074 6865 2063 6c6f 7564 223b  d on the cloud";
-00014da0: 207d 7d20 7c7c 207b 7b20 6563 686f 2022   }} || {{ echo "
-00014db0: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
-00014dc0: 7d20 2626 2065 7869 7420 3120 7c7c 2065  } && exit 1 || e
-00014dd0: 7869 7420 303b 207d 7d27 2c0a 2020 2020  xit 0; }}',.    
-00014de0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00014df0: 756e 6368 202d 7920 2d64 202d 6320 7b6e  unch -y -d -c {n
-00014e00: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
-00014e10: 6e65 7269 635f 636c 6f75 647d 202d 2d6e  neric_cloud} --n
-00014e20: 756d 2d6e 6f64 6573 2032 202d 2d64 6f77  um-nodes 2 --dow
-00014e30: 6e20 7465 7374 732f 7465 7374 5f79 616d  n tests/test_yam
-00014e40: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
-00014e50: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00014e60: 736b 7920 7374 6174 7573 207c 2067 7265  sky status | gre
-00014e70: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
-00014e80: 5550 272c 2020 2320 456e 7375 7265 2074  UP',  # Ensure t
-00014e90: 6865 2063 6c75 7374 6572 2069 7320 5550  he cluster is UP
-00014ea0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00014eb0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-00014ec0: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-00014ed0: 5f63 6c6f 7564 7d20 7465 7374 732f 7465  _cloud} tests/te
-00014ee0: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
-00014ef0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00014f00: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
-00014f10: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
-00014f20: 2067 7265 7020 2231 6d20 2864 6f77 6e29   grep "1m (down)
-00014f30: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00014f40: 6627 736c 6565 7020 7b61 7574 6f64 6f77  f'sleep {autodow
-00014f50: 6e5f 7469 6d65 6f75 747d 272c 0a20 2020  n_timeout}',.   
-00014f60: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
-00014f70: 6520 7468 6520 636c 7573 7465 7220 6973  e the cluster is
-00014f80: 2074 6572 6d69 6e61 7465 642e 0a20 2020   terminated..   
-00014f90: 2020 2020 2020 2020 2066 2773 3d24 2853           f's=$(S
-00014fa0: 4b59 5049 4c4f 545f 4445 4255 473d 3020  KYPILOT_DEBUG=0 
-00014fb0: 736b 7920 7374 6174 7573 207b 6e61 6d65  sky status {name
-00014fc0: 7d20 2d2d 7265 6672 6573 6829 2026 2620  } --refresh) && 
-00014fd0: 6563 686f 2022 2473 2220 2626 207b 7b20  echo "$s" && {{ 
-00014fe0: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-00014ff0: 207b 6e61 6d65 7d20 7c20 6772 6570 2022   {name} | grep "
-00015000: 4175 746f 646f 776e 6564 2063 6c75 7374  Autodowned clust
-00015010: 6572 5c7c 7465 726d 696e 6174 6564 206f  er\|terminated o
-00015020: 6e20 7468 6520 636c 6f75 6422 3b20 7d7d  n the cloud"; }}
-00015030: 207c 7c20 7b7b 2065 6368 6f20 2224 7322   || {{ echo "$s"
-00015040: 207c 2067 7265 7020 7b6e 616d 657d 2026   | grep {name} &
-00015050: 2620 6578 6974 2031 207c 7c20 6578 6974  & exit 1 || exit
-00015060: 2030 3b20 7d7d 272c 0a20 2020 2020 2020   0; }}',.       
-00015070: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00015080: 6820 2d79 202d 6420 2d63 207b 6e61 6d65  h -y -d -c {name
-00015090: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
-000150a0: 6963 5f63 6c6f 7564 7d20 2d2d 6e75 6d2d  ic_cloud} --num-
-000150b0: 6e6f 6465 7320 3220 2d2d 646f 776e 2074  nodes 2 --down t
-000150c0: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
-000150d0: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
-000150e0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000150f0: 2061 7574 6f73 746f 7020 2d79 207b 6e61   autostop -y {na
-00015100: 6d65 7d20 2d2d 6361 6e63 656c 272c 0a20  me} --cancel',. 
-00015110: 2020 2020 2020 2020 2020 2066 2773 6c65             f'sle
-00015120: 6570 207b 6175 746f 646f 776e 5f74 696d  ep {autodown_tim
-00015130: 656f 7574 7d27 2c0a 2020 2020 2020 2020  eout}',.        
-00015140: 2020 2020 2320 456e 7375 7265 2074 6865      # Ensure the
-00015150: 2063 6c75 7374 6572 2069 7320 7374 696c   cluster is stil
-00015160: 6c20 5550 2e0a 2020 2020 2020 2020 2020  l UP..          
-00015170: 2020 6627 733d 2428 534b 5950 494c 4f54    f's=$(SKYPILOT
-00015180: 5f44 4542 5547 3d30 2073 6b79 2073 7461  _DEBUG=0 sky sta
-00015190: 7475 7320 7b6e 616d 657d 202d 2d72 6566  tus {name} --ref
-000151a0: 7265 7368 2920 2626 2065 6368 6f20 2224  resh) && echo "$
-000151b0: 7322 2026 2620 6563 686f 2022 2473 2220  s" && echo "$s" 
-000151c0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-000151d0: 6772 6570 2055 5027 2c0a 2020 2020 2020  grep UP',.      
-000151e0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-000151f0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00015200: 7d27 2c0a 2020 2020 2020 2020 7469 6d65  }',.        time
-00015210: 6f75 743d 746f 7461 6c5f 7469 6d65 6f75  out=total_timeou
-00015220: 745f 6d69 6e75 7465 7320 2a20 3630 2c0a  t_minutes * 60,.
-00015230: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00015240: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00015250: 7079 7465 7374 2e6d 6172 6b2e 7363 700a  pytest.mark.scp.
-00015260: 6465 6620 7465 7374 5f73 6370 5f61 7574  def test_scp_aut
-00015270: 6f64 6f77 6e28 293a 0a20 2020 206e 616d  odown():.    nam
-00015280: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00015290: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-000152a0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-000152b0: 2027 5343 505f 6175 746f 646f 776e 272c   'SCP_autodown',
-000152c0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-000152d0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-000152e0: 6e63 6820 2d79 202d 6420 2d63 207b 6e61  nch -y -d -c {na
-000152f0: 6d65 7d20 7b53 4350 5f54 5950 457d 2074  me} {SCP_TYPE} t
-00015300: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
-00015310: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
-00015320: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00015330: 2061 7574 6f73 746f 7020 2d79 207b 6e61   autostop -y {na
-00015340: 6d65 7d20 2d2d 646f 776e 202d 6920 3127  me} --down -i 1'
-00015350: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00015360: 456e 7375 7265 2061 7574 6f73 746f 7020  Ensure autostop 
-00015370: 6973 2073 6574 2e0a 2020 2020 2020 2020  is set..        
-00015380: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
-00015390: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
-000153a0: 2067 7265 7020 2231 6d20 2864 6f77 6e29   grep "1m (down)
-000153b0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-000153c0: 2320 456e 7375 7265 2074 6865 2063 6c75  # Ensure the clu
-000153d0: 7374 6572 2069 7320 6e6f 7420 7465 726d  ster is not term
-000153e0: 696e 6174 6564 2065 6172 6c79 2e0a 2020  inated early..  
-000153f0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-00015400: 2034 3527 2c0a 2020 2020 2020 2020 2020   45',.          
-00015410: 2020 6627 736b 7920 7374 6174 7573 202d    f'sky status -
-00015420: 2d72 6566 7265 7368 207c 2067 7265 7020  -refresh | grep 
-00015430: 7b6e 616d 657d 207c 2067 7265 7020 5550  {name} | grep UP
-00015440: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-00015450: 2045 6e73 7572 6520 7468 6520 636c 7573   Ensure the clus
-00015460: 7465 7220 6973 2074 6572 6d69 6e61 7465  ter is terminate
-00015470: 642e 0a20 2020 2020 2020 2020 2020 2027  d..            '
-00015480: 736c 6565 7020 3230 3027 2c0a 2020 2020  sleep 200',.    
-00015490: 2020 2020 2020 2020 6627 733d 2428 534b          f's=$(SK
-000154a0: 5950 494c 4f54 5f44 4542 5547 3d30 2073  YPILOT_DEBUG=0 s
-000154b0: 6b79 2073 7461 7475 7320 2d2d 7265 6672  ky status --refr
-000154c0: 6573 6829 2026 2620 7072 696e 7466 2022  esh) && printf "
-000154d0: 2473 2220 2626 207b 7b20 6563 686f 2022  $s" && {{ echo "
-000154e0: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
-000154f0: 7d20 7c20 6772 6570 2022 4175 746f 646f  } | grep "Autodo
-00015500: 776e 6564 2063 6c75 7374 6572 5c7c 7465  wned cluster\|te
-00015510: 726d 696e 6174 6564 206f 6e20 7468 6520  rminated on the 
-00015520: 636c 6f75 6422 3b20 7d7d 207c 7c20 7b7b  cloud"; }} || {{
-00015530: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
-00015540: 7020 7b6e 616d 657d 2026 2620 6578 6974  p {name} && exit
-00015550: 2031 207c 7c20 6578 6974 2030 3b20 7d7d   1 || exit 0; }}
-00015560: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00015570: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00015580: 6420 2d63 207b 6e61 6d65 7d20 7b53 4350  d -c {name} {SCP
-00015590: 5f54 5950 457d 202d 2d64 6f77 6e20 7465  _TYPE} --down te
-000155a0: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
-000155b0: 696e 696d 616c 2e79 616d 6c27 2c0a 2020  inimal.yaml',.  
-000155c0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000155d0: 7374 6174 7573 207c 2067 7265 7020 7b6e  status | grep {n
-000155e0: 616d 657d 207c 2067 7265 7020 5550 272c  ame} | grep UP',
-000155f0: 2020 2320 456e 7375 7265 2074 6865 2063    # Ensure the c
-00015600: 6c75 7374 6572 2069 7320 5550 2e0a 2020  luster is UP..  
-00015610: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00015620: 6578 6563 207b 6e61 6d65 7d20 7b53 4350  exec {name} {SCP
-00015630: 5f54 5950 457d 2074 6573 7473 2f74 6573  _TYPE} tests/tes
-00015640: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
-00015650: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00015660: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
-00015670: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-00015680: 6772 6570 2022 316d 2028 646f 776e 2922  grep "1m (down)"
-00015690: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-000156a0: 736c 6565 7020 3230 3027 2c0a 2020 2020  sleep 200',.    
-000156b0: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
-000156c0: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
-000156d0: 7465 726d 696e 6174 6564 2e0a 2020 2020  terminated..    
-000156e0: 2020 2020 2020 2020 6627 733d 2428 534b          f's=$(SK
-000156f0: 5950 494c 4f54 5f44 4542 5547 3d30 2073  YPILOT_DEBUG=0 s
-00015700: 6b79 2073 7461 7475 7320 2d2d 7265 6672  ky status --refr
-00015710: 6573 6829 2026 2620 7072 696e 7466 2022  esh) && printf "
-00015720: 2473 2220 2626 207b 7b20 6563 686f 2022  $s" && {{ echo "
-00015730: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
-00015740: 7d20 7c20 6772 6570 2022 4175 746f 646f  } | grep "Autodo
-00015750: 776e 6564 2063 6c75 7374 6572 5c7c 7465  wned cluster\|te
-00015760: 726d 696e 6174 6564 206f 6e20 7468 6520  rminated on the 
-00015770: 636c 6f75 6422 3b20 7d7d 207c 7c20 7b7b  cloud"; }} || {{
-00015780: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
-00015790: 7020 7b6e 616d 657d 2026 2620 6578 6974  p {name} && exit
-000157a0: 2031 207c 7c20 6578 6974 2030 3b20 7d7d   1 || exit 0; }}
-000157b0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000157c0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-000157d0: 6420 2d63 207b 6e61 6d65 7d20 7b53 4350  d -c {name} {SCP
-000157e0: 5f54 5950 457d 202d 2d64 6f77 6e20 7465  _TYPE} --down te
-000157f0: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
-00015800: 696e 696d 616c 2e79 616d 6c27 2c0a 2020  inimal.yaml',.  
-00015810: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00015820: 6175 746f 7374 6f70 202d 7920 7b6e 616d  autostop -y {nam
-00015830: 657d 202d 2d63 616e 6365 6c27 2c0a 2020  e} --cancel',.  
-00015840: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-00015850: 2032 3030 272c 0a20 2020 2020 2020 2020   200',.         
-00015860: 2020 2023 2045 6e73 7572 6520 7468 6520     # Ensure the 
-00015870: 636c 7573 7465 7220 6973 2073 7469 6c6c  cluster is still
-00015880: 2055 502e 0a20 2020 2020 2020 2020 2020   UP..           
-00015890: 2066 2773 3d24 2853 4b59 5049 4c4f 545f   f's=$(SKYPILOT_
-000158a0: 4445 4255 473d 3020 736b 7920 7374 6174  DEBUG=0 sky stat
-000158b0: 7573 202d 2d72 6566 7265 7368 2920 2626  us --refresh) &&
-000158c0: 2070 7269 6e74 6620 2224 7322 2026 2620   printf "$s" && 
-000158d0: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-000158e0: 207b 6e61 6d65 7d20 7c20 6772 6570 2055   {name} | grep U
-000158f0: 5027 2c0a 2020 2020 2020 2020 5d2c 0a20  P',.        ],. 
-00015900: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-00015910: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-00015920: 2020 2020 2020 7469 6d65 6f75 743d 3235        timeout=25
-00015930: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-00015940: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00015950: 7374 290a 0a0a 6465 6620 5f67 6574 5f63  st)...def _get_c
-00015960: 616e 6365 6c5f 7461 736b 5f77 6974 685f  ancel_task_with_
-00015970: 636c 6f75 6428 6e61 6d65 2c20 636c 6f75  cloud(name, clou
-00015980: 642c 2074 696d 656f 7574 3d31 3520 2a20  d, timeout=15 * 
-00015990: 3630 293a 0a20 2020 2074 6573 7420 3d20  60):.    test = 
-000159a0: 5465 7374 280a 2020 2020 2020 2020 6627  Test(.        f'
-000159b0: 7b63 6c6f 7564 7d2d 6361 6e63 656c 2d74  {cloud}-cancel-t
-000159c0: 6173 6b27 2c0a 2020 2020 2020 2020 5b0a  ask',.        [.
-000159d0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000159e0: 7920 6c61 756e 6368 202d 6320 7b6e 616d  y launch -c {nam
-000159f0: 657d 2065 7861 6d70 6c65 732f 7265 736e  e} examples/resn
-00015a00: 6574 5f61 7070 2e79 616d 6c20 2d2d 636c  et_app.yaml --cl
-00015a10: 6f75 6420 7b63 6c6f 7564 7d20 2d79 202d  oud {cloud} -y -
-00015a20: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-00015a30: 2320 5761 6974 2074 6865 2047 5055 2070  # Wait the GPU p
-00015a40: 726f 6365 7373 2074 6f20 7374 6172 742e  rocess to start.
-00015a50: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00015a60: 6565 7020 3630 272c 0a20 2020 2020 2020  eep 60',.       
-00015a70: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00015a80: 7b6e 616d 657d 2022 6e76 6964 6961 2d73  {name} "nvidia-s
-00015a90: 6d69 207c 2067 7265 7020 7079 7468 6f6e  mi | grep python
-00015aa0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00015ab0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00015ac0: 7d20 3220 2d2d 7374 6174 7573 272c 2020  } 2 --status',  
-00015ad0: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-00015ae0: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-00015af0: 2020 2020 2020 2020 6627 736b 7920 6361          f'sky ca
-00015b00: 6e63 656c 202d 7920 7b6e 616d 657d 2031  ncel -y {name} 1
-00015b10: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00015b20: 736c 6565 7020 3630 272c 0a20 2020 2020  sleep 60',.     
-00015b30: 2020 2020 2020 2023 2063 6865 636b 2069         # check i
-00015b40: 6620 7468 6520 7079 7468 6f6e 206a 6f62  f the python job
-00015b50: 2069 7320 676f 6e65 2e0a 2020 2020 2020   is gone..      
-00015b60: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-00015b70: 207b 6e61 6d65 7d20 2221 206e 7669 6469   {name} "! nvidi
-00015b80: 612d 736d 6920 7c20 6772 6570 2070 7974  a-smi | grep pyt
-00015b90: 686f 6e22 272c 0a20 2020 2020 2020 2020  hon"',.         
-00015ba0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00015bb0: 616d 657d 2033 202d 2d73 7461 7475 7327  ame} 3 --status'
-00015bc0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-00015bd0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-00015be0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00015bf0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00015c00: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
-00015c10: 2074 696d 656f 7574 3d74 696d 656f 7574   timeout=timeout
-00015c20: 2c0a 2020 2020 290a 2020 2020 7265 7475  ,.    ).    retu
-00015c30: 726e 2074 6573 740a 0a0a 2320 2d2d 2d2d  rn test...# ----
-00015c40: 2d2d 2d2d 2d2d 2054 6573 7469 6e67 2060  ------ Testing `
-00015c50: 736b 7920 6361 6e63 656c 6020 2d2d 2d2d  sky cancel` ----
-00015c60: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
-00015c70: 6172 6b2e 6177 730a 4070 7974 6573 742e  ark.aws.@pytest.
-00015c80: 6d61 726b 2e73 6b69 7028 0a20 2020 2072  mark.skip(.    r
-00015c90: 6561 736f 6e3d 2754 6865 2072 6573 6e65  eason='The resne
-00015ca0: 745f 6170 7020 6973 2066 6c61 6b79 2c20  t_app is flaky, 
-00015cb0: 6475 6520 746f 2054 4620 6661 696c 696e  due to TF failin
-00015cc0: 6720 746f 2064 6574 6563 7420 4750 5573  g to detect GPUs
-00015cd0: 2e27 290a 6465 6620 7465 7374 5f63 616e  .').def test_can
-00015ce0: 6365 6c5f 6177 7328 293a 0a20 2020 206e  cel_aws():.    n
-00015cf0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00015d00: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-00015d10: 7374 203d 205f 6765 745f 6361 6e63 656c  st = _get_cancel
-00015d20: 5f74 6173 6b5f 7769 7468 5f63 6c6f 7564  _task_with_cloud
-00015d30: 286e 616d 652c 2027 6177 7327 290a 2020  (name, 'aws').  
-00015d40: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00015d50: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-00015d60: 6172 6b2e 6763 700a 4070 7974 6573 742e  ark.gcp.@pytest.
-00015d70: 6d61 726b 2e73 6b69 7028 0a20 2020 2072  mark.skip(.    r
-00015d80: 6561 736f 6e3d 2754 6865 2072 6573 6e65  eason='The resne
-00015d90: 745f 6170 7020 6973 2066 6c61 6b79 2c20  t_app is flaky, 
-00015da0: 6475 6520 746f 2054 4620 6661 696c 696e  due to TF failin
-00015db0: 6720 746f 2064 6574 6563 7420 4750 5573  g to detect GPUs
-00015dc0: 2e27 290a 6465 6620 7465 7374 5f63 616e  .').def test_can
-00015dd0: 6365 6c5f 6763 7028 293a 0a20 2020 206e  cel_gcp():.    n
-00015de0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00015df0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-00015e00: 7374 203d 205f 6765 745f 6361 6e63 656c  st = _get_cancel
-00015e10: 5f74 6173 6b5f 7769 7468 5f63 6c6f 7564  _task_with_cloud
-00015e20: 286e 616d 652c 2027 6763 7027 290a 2020  (name, 'gcp').  
-00015e30: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00015e40: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-00015e50: 6172 6b2e 617a 7572 650a 4070 7974 6573  ark.azure.@pytes
-00015e60: 742e 6d61 726b 2e73 6b69 7028 0a20 2020  t.mark.skip(.   
-00015e70: 2072 6561 736f 6e3d 2754 6865 2072 6573   reason='The res
-00015e80: 6e65 745f 6170 7020 6973 2066 6c61 6b79  net_app is flaky
-00015e90: 2c20 6475 6520 746f 2054 4620 6661 696c  , due to TF fail
-00015ea0: 696e 6720 746f 2064 6574 6563 7420 4750  ing to detect GP
-00015eb0: 5573 2e27 290a 6465 6620 7465 7374 5f63  Us.').def test_c
-00015ec0: 616e 6365 6c5f 617a 7572 6528 293a 0a20  ancel_azure():. 
-00015ed0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-00015ee0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-00015ef0: 2020 7465 7374 203d 205f 6765 745f 6361    test = _get_ca
-00015f00: 6e63 656c 5f74 6173 6b5f 7769 7468 5f63  ncel_task_with_c
-00015f10: 6c6f 7564 286e 616d 652c 2027 617a 7572  loud(name, 'azur
-00015f20: 6527 2c20 7469 6d65 6f75 743d 3330 202a  e', timeout=30 *
-00015f30: 2036 3029 0a20 2020 2072 756e 5f6f 6e65   60).    run_one
-00015f40: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-00015f50: 7974 6573 742e 6d61 726b 2e6e 6f5f 6c61  ytest.mark.no_la
-00015f60: 6d62 6461 5f63 6c6f 7564 2020 2320 4c61  mbda_cloud  # La
-00015f70: 6d62 6461 2043 6c6f 7564 2064 6f65 7320  mbda Cloud does 
-00015f80: 6e6f 7420 6861 7665 2056 3130 3020 6770  not have V100 gp
-00015f90: 7573 0a40 7079 7465 7374 2e6d 6172 6b2e  us.@pytest.mark.
-00015fa0: 6e6f 5f69 626d 2020 2320 4942 4d20 636c  no_ibm  # IBM cl
-00015fb0: 6f75 6420 6375 7272 656e 746c 7920 646f  oud currently do
-00015fc0: 6573 6e27 7420 7072 6f76 6964 6520 7075  esn't provide pu
-00015fd0: 626c 6963 2069 6d61 6765 2077 6974 6820  blic image with 
-00015fe0: 4355 4441 0a40 7079 7465 7374 2e6d 6172  CUDA.@pytest.mar
-00015ff0: 6b2e 6e6f 5f70 6170 6572 7370 6163 6520  k.no_paperspace 
-00016000: 2023 2050 6170 6572 7370 6163 6520 6861   # Paperspace ha
-00016010: 7320 6067 6e6f 6d65 2d73 6865 6c6c 6020  s `gnome-shell` 
-00016020: 6f6e 206e 7669 6469 612d 736d 690a 4070  on nvidia-smi.@p
-00016030: 7974 6573 742e 6d61 726b 2e6e 6f5f 7363  ytest.mark.no_sc
-00016040: 7020 2023 2053 4350 2064 6f65 7320 6e6f  p  # SCP does no
-00016050: 7420 7375 7070 6f72 7420 6e75 6d5f 6e6f  t support num_no
-00016060: 6465 7320 3e20 3120 7965 740a 6465 6620  des > 1 yet.def 
-00016070: 7465 7374 5f63 616e 6365 6c5f 7079 746f  test_cancel_pyto
-00016080: 7263 6828 6765 6e65 7269 635f 636c 6f75  rch(generic_clou
-00016090: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
-000160a0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-000160b0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-000160c0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-000160d0: 2027 6361 6e63 656c 2d70 7974 6f72 6368   'cancel-pytorch
-000160e0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-000160f0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00016100: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
-00016110: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-00016120: 5f63 6c6f 7564 7d20 6578 616d 706c 6573  _cloud} examples
-00016130: 2f72 6573 6e65 745f 6469 7374 7269 6275  /resnet_distribu
-00016140: 7465 645f 746f 7263 682e 7961 6d6c 202d  ted_torch.yaml -
-00016150: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
-00016160: 2020 2023 2057 6169 7420 7468 6520 4750     # Wait the GP
-00016170: 5520 7072 6f63 6573 7320 746f 2073 7461  U process to sta
-00016180: 7274 2e0a 2020 2020 2020 2020 2020 2020  rt..            
-00016190: 2773 6c65 6570 2039 3027 2c0a 2020 2020  'sleep 90',.    
-000161a0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-000161b0: 6563 207b 6e61 6d65 7d20 2228 6e76 6964  ec {name} "(nvid
-000161c0: 6961 2d73 6d69 207c 2067 7265 7020 7079  ia-smi | grep py
-000161d0: 7468 6f6e 2920 7c7c 2027 0a20 2020 2020  thon) || '.     
-000161e0: 2020 2020 2020 2023 2057 6865 6e20 7275         # When ru
-000161f0: 6e20 696e 7369 6465 2063 6f6e 7461 696e  n inside contain
-00016200: 6572 2f6b 3873 2c20 6e76 6964 6961 2d73  er/k8s, nvidia-s
-00016210: 6d69 2063 616e 6e6f 7420 7368 6f77 2070  mi cannot show p
-00016220: 726f 6365 7373 2069 6473 2e0a 2020 2020  rocess ids..    
-00016230: 2020 2020 2020 2020 2320 5365 6520 6874          # See ht
-00016240: 7470 733a 2f2f 6769 7468 7562 2e63 6f6d  tps://github.com
-00016250: 2f4e 5649 4449 412f 6e76 6964 6961 2d64  /NVIDIA/nvidia-d
-00016260: 6f63 6b65 722f 6973 7375 6573 2f31 3739  ocker/issues/179
-00016270: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00016280: 6f20 776f 726b 2061 726f 756e 642c 2077  o work around, w
-00016290: 6520 6368 6563 6b20 6966 2047 5055 2075  e check if GPU u
-000162a0: 7469 6c69 7a61 7469 6f6e 2069 7320 6772  tilization is gr
-000162b0: 6561 7465 7220 7468 616e 2030 2e0a 2020  eater than 0..  
-000162c0: 2020 2020 2020 2020 2020 6627 5b20 5c24            f'[ \$
-000162d0: 286e 7669 6469 612d 736d 6920 2d2d 7175  (nvidia-smi --qu
-000162e0: 6572 792d 6770 753d 7574 696c 697a 6174  ery-gpu=utilizat
-000162f0: 696f 6e2e 6770 7520 2d2d 666f 726d 6174  ion.gpu --format
-00016300: 3d63 7376 2c6e 6f68 6561 6465 722c 6e6f  =csv,noheader,no
-00016310: 756e 6974 7329 202d 6774 2030 205d 2227  units) -gt 0 ]"'
-00016320: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00016330: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00016340: 3220 2d2d 7374 6174 7573 272c 2020 2320  2 --status',  # 
-00016350: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-00016360: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-00016370: 2020 2020 2020 6627 736b 7920 6361 6e63        f'sky canc
-00016380: 656c 202d 7920 7b6e 616d 657d 2031 272c  el -y {name} 1',
-00016390: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-000163a0: 6565 7020 3630 272c 0a20 2020 2020 2020  eep 60',.       
-000163b0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-000163c0: 7b6e 616d 657d 2022 286e 7669 6469 612d  {name} "(nvidia-
-000163d0: 736d 6920 7c20 6772 6570 205c 274e 6f20  smi | grep \'No 
-000163e0: 7275 6e6e 696e 6720 7072 6f63 6573 735c  running process\
-000163f0: 2729 207c 7c20 270a 2020 2020 2020 2020  ') || '.        
-00016400: 2020 2020 2320 456e 7375 7265 2058 6f72      # Ensure Xor
-00016410: 6720 6973 2074 6865 206f 6e6c 7920 7072  g is the only pr
-00016420: 6f63 6573 7320 7275 6e6e 696e 672e 0a20  ocess running.. 
-00016430: 2020 2020 2020 2020 2020 2027 5b20 5c24             '[ \$
-00016440: 286e 7669 6469 612d 736d 6920 7c20 6772  (nvidia-smi | gr
-00016450: 6570 202d 4120 3130 2050 726f 6365 7373  ep -A 10 Process
-00016460: 6573 207c 2067 7265 7020 2d41 2031 3020  es | grep -A 10 
-00016470: 3d3d 3d20 7c20 6772 6570 202d 7620 586f  === | grep -v Xo
-00016480: 7267 2920 2d65 7120 3220 5d22 272c 0a20  rg) -eq 2 ]"',. 
-00016490: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000164a0: 206c 6f67 7320 7b6e 616d 657d 2033 202d   logs {name} 3 -
-000164b0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
-000164c0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
-000164d0: 6565 6465 642e 0a20 2020 2020 2020 205d  eeded..        ]
-000164e0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-000164f0: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-00016500: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-00016510: 3d32 3020 2a20 3630 2c0a 2020 2020 290a  =20 * 60,.    ).
-00016520: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00016530: 2874 6573 7429 0a0a 0a23 2063 616e 2774  (test)...# can't
-00016540: 2075 7365 2060 5f67 6574 5f63 616e 6365   use `_get_cance
-00016550: 6c5f 7461 736b 5f77 6974 685f 636c 6f75  l_task_with_clou
-00016560: 6428 2960 2c20 6173 2063 6f6d 6d61 6e64  d()`, as command
-00016570: 2060 6e76 6964 6961 2d73 6d69 600a 2320   `nvidia-smi`.# 
-00016580: 7265 7175 6972 6573 2061 2043 5544 4120  requires a CUDA 
-00016590: 7075 626c 6963 2069 6d61 6765 2c20 7768  public image, wh
-000165a0: 6963 6820 4942 4d20 646f 6573 6e27 7420  ich IBM doesn't 
-000165b0: 6f66 6665 720a 4070 7974 6573 742e 6d61  offer.@pytest.ma
-000165c0: 726b 2e69 626d 0a64 6566 2074 6573 745f  rk.ibm.def test_
-000165d0: 6361 6e63 656c 5f69 626d 2829 3a0a 2020  cancel_ibm():.  
-000165e0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-000165f0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00016600: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00016610: 2020 2020 2020 2769 626d 2d63 616e 6365        'ibm-cance
-00016620: 6c2d 7461 736b 272c 0a20 2020 2020 2020  l-task',.       
-00016630: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00016640: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00016650: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-00016660: 2069 626d 2065 7861 6d70 6c65 732f 6d69   ibm examples/mi
-00016670: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-00016680: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00016690: 7865 6320 7b6e 616d 657d 202d 6e20 7b6e  xec {name} -n {n
-000166a0: 616d 657d 2d31 202d 6420 2022 7768 696c  ame}-1 -d  "whil
-000166b0: 6520 7472 7565 3b20 646f 2065 6368 6f20  e true; do echo 
-000166c0: 5c27 4865 6c6c 6f20 536b 7950 696c 6f74  \'Hello SkyPilot
-000166d0: 5c27 3b20 736c 6565 7020 323b 2064 6f6e  \'; sleep 2; don
-000166e0: 6522 272c 0a20 2020 2020 2020 2020 2020  e"',.           
-000166f0: 2027 736c 6565 7020 3230 272c 0a20 2020   'sleep 20',.   
-00016700: 2020 2020 2020 2020 2066 2773 6b79 2071           f'sky q
-00016710: 7565 7565 207b 6e61 6d65 7d20 7c20 6772  ueue {name} | gr
-00016720: 6570 207b 6e61 6d65 7d2d 3120 7c20 6772  ep {name}-1 | gr
-00016730: 6570 2052 554e 4e49 4e47 272c 0a20 2020  ep RUNNING',.   
-00016740: 2020 2020 2020 2020 2066 2773 6b79 2063           f'sky c
-00016750: 616e 6365 6c20 2d79 207b 6e61 6d65 7d20  ancel -y {name} 
-00016760: 3227 2c0a 2020 2020 2020 2020 2020 2020  2',.            
-00016770: 6627 736c 6565 7020 3527 2c0a 2020 2020  f'sleep 5',.    
-00016780: 2020 2020 2020 2020 6627 736b 7920 7175          f'sky qu
-00016790: 6575 6520 7b6e 616d 657d 207c 2067 7265  eue {name} | gre
-000167a0: 7020 7b6e 616d 657d 2d31 207c 2067 7265  p {name}-1 | gre
-000167b0: 7020 4341 4e43 454c 4c45 4427 2c0a 2020  p CANCELLED',.  
-000167c0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-000167d0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-000167e0: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-000167f0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00016800: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-00016810: 2d2d 2d20 5465 7374 696e 6720 7573 652d  --- Testing use-
-00016820: 7370 6f74 206f 7074 696f 6e20 2d2d 2d2d  spot option ----
-00016830: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
-00016840: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
-00016850: 6b20 2023 2046 6c75 6964 5374 6163 6b20  k  # FluidStack 
-00016860: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-00016870: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
-00016880: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00016890: 617a 7572 6520 2023 2041 7a75 7265 2064  azure  # Azure d
-000168a0: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-000168b0: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-000168c0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6c  pytest.mark.no_l
-000168d0: 616d 6264 615f 636c 6f75 6420 2023 204c  ambda_cloud  # L
-000168e0: 616d 6264 6120 436c 6f75 6420 646f 6573  ambda Cloud does
-000168f0: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
-00016900: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-00016910: 6573 742e 6d61 726b 2e6e 6f5f 7061 7065  est.mark.no_pape
-00016920: 7273 7061 6365 2020 2320 5061 7065 7273  rspace  # Papers
-00016930: 7061 6365 2064 6f65 7320 6e6f 7420 7375  pace does not su
-00016940: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-00016950: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-00016960: 6b2e 6e6f 5f69 626d 2020 2320 4942 4d20  k.no_ibm  # IBM 
-00016970: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
-00016980: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-00016990: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-000169a0: 726b 2e6e 6f5f 7363 7020 2023 2053 4350  rk.no_scp  # SCP
-000169b0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-000169c0: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-000169d0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-000169e0: 5f6b 7562 6572 6e65 7465 7320 2023 204b  _kubernetes  # K
-000169f0: 7562 6572 6e65 7465 7320 646f 6573 206e  ubernetes does n
-00016a00: 6f74 2068 6176 6520 6120 6e6f 7469 6f6e  ot have a notion
-00016a10: 206f 6620 7370 6f74 2069 6e73 7461 6e63   of spot instanc
-00016a20: 6573 0a64 6566 2074 6573 745f 7573 655f  es.def test_use_
-00016a30: 7370 6f74 2867 656e 6572 6963 5f63 6c6f  spot(generic_clo
-00016a40: 7564 3a20 7374 7229 3a0a 2020 2020 2222  ud: str):.    ""
-00016a50: 2254 6573 7420 7573 652d 7370 6f74 2061  "Test use-spot a
-00016a60: 6e64 2073 6b79 2065 7865 632e 2222 220a  nd sky exec.""".
-00016a70: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00016a80: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00016a90: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00016aa0: 2020 2020 2020 2020 2775 7365 2d73 706f          'use-spo
-00016ab0: 7427 2c0a 2020 2020 2020 2020 5b0a 2020  t',.        [.  
-00016ac0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00016ad0: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
-00016ae0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-00016af0: 635f 636c 6f75 647d 2074 6573 7473 2f74  c_cloud} tests/t
-00016b00: 6573 745f 7961 6d6c 732f 6d69 6e69 6d61  est_yamls/minima
-00016b10: 6c2e 7961 6d6c 202d 2d75 7365 2d73 706f  l.yaml --use-spo
-00016b20: 7420 2d79 272c 0a20 2020 2020 2020 2020  t -y',.         
-00016b30: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00016b40: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
-00016b50: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00016b60: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-00016b70: 6563 686f 2068 6927 2c0a 2020 2020 2020  echo hi',.      
-00016b80: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-00016b90: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
-00016ba0: 7573 272c 0a20 2020 2020 2020 205d 2c0a  us',.        ],.
-00016bb0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-00016bc0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-00016bd0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00016be0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-00016bf0: 7974 6573 742e 6d61 726b 2e67 6370 0a64  ytest.mark.gcp.d
-00016c00: 6566 2074 6573 745f 7374 6f70 5f67 6370  ef test_stop_gcp
-00016c10: 5f73 706f 7428 293a 0a20 2020 2022 2222  _spot():.    """
-00016c20: 5465 7374 2047 4350 2073 706f 7420 6361  Test GCP spot ca
-00016c30: 6e20 6265 2073 746f 7070 6564 2c20 6175  n be stopped, au
-00016c40: 746f 7374 6f70 7065 642c 2072 6573 7461  tostopped, resta
-00016c50: 7274 6564 2e22 2222 0a20 2020 206e 616d  rted.""".    nam
-00016c60: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00016c70: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00016c80: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00016c90: 2027 7374 6f70 5f67 6370 5f73 706f 7427   'stop_gcp_spot'
-00016ca0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00016cb0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00016cc0: 756e 6368 202d 6320 7b6e 616d 657d 202d  unch -c {name} -
-00016cd0: 2d63 6c6f 7564 2067 6370 202d 2d75 7365  -cloud gcp --use
-00016ce0: 2d73 706f 7420 2d2d 6370 7573 2032 2b20  -spot --cpus 2+ 
-00016cf0: 2d79 202d 2d20 746f 7563 6820 6d79 6669  -y -- touch myfi
-00016d00: 6c65 272c 0a20 2020 2020 2020 2020 2020  le',.           
-00016d10: 2023 2073 746f 7020 7368 6f75 6c64 2067   # stop should g
-00016d20: 6f20 7468 726f 7567 683a 0a20 2020 2020  o through:.     
-00016d30: 2020 2020 2020 2066 2773 6b79 2073 746f         f'sky sto
-00016d40: 7020 7b6e 616d 657d 202d 7927 2c0a 2020  p {name} -y',.  
-00016d50: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00016d60: 7374 6172 7420 7b6e 616d 657d 202d 7927  start {name} -y'
-00016d70: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00016d80: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-00016d90: 2d2d 206c 7320 6d79 6669 6c65 272c 0a20  -- ls myfile',. 
-00016da0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00016db0: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
-00016dc0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-00016dd0: 2020 2020 2020 6627 736b 7920 6175 746f        f'sky auto
-00016de0: 7374 6f70 207b 6e61 6d65 7d20 2d69 3020  stop {name} -i0 
-00016df0: 2d79 272c 0a20 2020 2020 2020 2020 2020  -y',.           
-00016e00: 2027 736c 6565 7020 3930 272c 0a20 2020   'sleep 90',.   
-00016e10: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-00016e20: 6b79 2073 7461 7475 7320 7b6e 616d 657d  ky status {name}
-00016e30: 202d 2d72 6566 7265 7368 293b 2065 6368   --refresh); ech
-00016e40: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
-00016e50: 686f 3b20 6563 686f 2022 2473 2220 207c  ho; echo "$s"  |
-00016e60: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-00016e70: 7265 7020 5354 4f50 5045 4427 2c0a 2020  rep STOPPED',.  
-00016e80: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00016e90: 7374 6172 7420 7b6e 616d 657d 202d 7927  start {name} -y'
-00016ea0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00016eb0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-00016ec0: 2d2d 206c 7320 6d79 6669 6c65 272c 0a20  -- ls myfile',. 
-00016ed0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00016ee0: 206c 6f67 7320 7b6e 616d 657d 2033 202d   logs {name} 3 -
-00016ef0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-00016f00: 2020 2020 2020 2320 2d69 206f 7074 696f        # -i optio
-00016f10: 6e20 6174 206c 6175 6e63 6820 7368 6f75  n at launch shou
-00016f20: 6c64 2067 6f20 7468 726f 7567 683a 0a20  ld go through:. 
-00016f30: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00016f40: 206c 6175 6e63 6820 2d63 207b 6e61 6d65   launch -c {name
-00016f50: 7d20 2d69 3020 2d79 272c 0a20 2020 2020  } -i0 -y',.     
-00016f60: 2020 2020 2020 2027 736c 6565 7020 3132         'sleep 12
-00016f70: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-00016f80: 6627 733d 2428 736b 7920 7374 6174 7573  f's=$(sky status
-00016f90: 207b 6e61 6d65 7d20 2d2d 7265 6672 6573   {name} --refres
-00016fa0: 6829 3b20 6563 686f 2022 2473 223b 2065  h); echo "$s"; e
-00016fb0: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
-00016fc0: 2224 7322 2020 7c20 6772 6570 207b 6e61  "$s"  | grep {na
-00016fd0: 6d65 7d20 7c20 6772 6570 2053 544f 5050  me} | grep STOPP
-00016fe0: 4544 272c 0a20 2020 2020 2020 205d 2c0a  ED',.        ],.
-00016ff0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-00017000: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-00017010: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00017020: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-00017030: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7469  ---------- Testi
-00017040: 6e67 206d 616e 6167 6564 206a 6f62 202d  ng managed job -
-00017050: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
-00017060: 742e 6d61 726b 2e6d 616e 6167 6564 5f6a  t.mark.managed_j
-00017070: 6f62 730a 6465 6620 7465 7374 5f6d 616e  obs.def test_man
-00017080: 6167 6564 5f6a 6f62 7328 6765 6e65 7269  aged_jobs(generi
-00017090: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-000170a0: 2020 2022 2222 5465 7374 2074 6865 206d     """Test the m
-000170b0: 616e 6167 6564 206a 6f62 7320 7961 6d6c  anaged jobs yaml
-000170c0: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
-000170d0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-000170e0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-000170f0: 6573 7428 0a20 2020 2020 2020 2027 6d61  est(.        'ma
-00017100: 6e61 6765 642d 6a6f 6273 272c 0a20 2020  naged-jobs',.   
-00017110: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00017120: 2020 2066 2773 6b79 206a 6f62 7320 6c61     f'sky jobs la
-00017130: 756e 6368 202d 6e20 7b6e 616d 657d 2d31  unch -n {name}-1
-00017140: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-00017150: 635f 636c 6f75 647d 2065 7861 6d70 6c65  c_cloud} example
-00017160: 732f 6d61 6e61 6765 645f 6a6f 622e 7961  s/managed_job.ya
-00017170: 6d6c 202d 7920 2d64 272c 0a20 2020 2020  ml -y -d',.     
-00017180: 2020 2020 2020 2066 2773 6b79 206a 6f62         f'sky job
-00017190: 7320 6c61 756e 6368 202d 6e20 7b6e 616d  s launch -n {nam
-000171a0: 657d 2d32 202d 2d63 6c6f 7564 207b 6765  e}-2 --cloud {ge
-000171b0: 6e65 7269 635f 636c 6f75 647d 2065 7861  neric_cloud} exa
-000171c0: 6d70 6c65 732f 6d61 6e61 6765 645f 6a6f  mples/managed_jo
-000171d0: 622e 7961 6d6c 202d 7920 2d64 272c 0a20  b.yaml -y -d',. 
-000171e0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-000171f0: 7020 3527 2c0a 2020 2020 2020 2020 2020  p 5',.          
-00017200: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
-00017210: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
-00017220: 657d 2d31 207c 2068 6561 6420 2d6e 3120  e}-1 | head -n1 
-00017230: 7c20 6772 6570 2022 5354 4152 5449 4e47  | grep "STARTING
-00017240: 5c7c 5255 4e4e 494e 4722 272c 0a20 2020  \|RUNNING"',.   
-00017250: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
-00017260: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-00017270: 6570 207b 6e61 6d65 7d2d 3220 7c20 6865  ep {name}-2 | he
-00017280: 6164 202d 6e31 207c 2067 7265 7020 2253  ad -n1 | grep "S
-00017290: 5441 5254 494e 475c 7c52 554e 4e49 4e47  TARTING\|RUNNING
-000172a0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-000172b0: 5f4a 4f42 5f43 414e 4345 4c5f 5741 4954  _JOB_CANCEL_WAIT
-000172c0: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
-000172d0: 3d66 277b 6e61 6d65 7d2d 3127 292c 0a20  =f'{name}-1'),. 
-000172e0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-000172f0: 7020 3527 2c0a 2020 2020 2020 2020 2020  p 5',.          
-00017300: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
-00017310: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
-00017320: 657d 2d31 207c 2068 6561 6420 2d6e 3120  e}-1 | head -n1 
-00017330: 7c20 6772 6570 2022 4341 4e43 454c 4c49  | grep "CANCELLI
-00017340: 4e47 5c7c 4341 4e43 454c 4c45 4422 272c  NG\|CANCELLED"',
-00017350: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00017360: 6565 7020 3230 3027 2c0a 2020 2020 2020  eep 200',.      
-00017370: 2020 2020 2020 6627 7b5f 4a4f 425f 5155        f'{_JOB_QU
-00017380: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-00017390: 7b6e 616d 657d 2d31 207c 2068 6561 6420  {name}-1 | head 
-000173a0: 2d6e 3120 7c20 6772 6570 2043 414e 4345  -n1 | grep CANCE
-000173b0: 4c4c 4544 272c 0a20 2020 2020 2020 2020  LLED',.         
-000173c0: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
-000173d0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-000173e0: 6d65 7d2d 3220 7c20 6865 6164 202d 6e31  me}-2 | head -n1
-000173f0: 207c 2067 7265 7020 2252 554e 4e49 4e47   | grep "RUNNING
-00017400: 5c7c 5355 4343 4545 4445 4422 272c 0a20  \|SUCCEEDED"',. 
-00017410: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00017420: 2020 2320 544f 444f 287a 6877 7529 3a20    # TODO(zhwu): 
-00017430: 4368 616e 6765 2074 6f20 5f4a 4f42 5f43  Change to _JOB_C
-00017440: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
-00017450: 7428 6a6f 625f 6e61 6d65 3d66 277b 6e61  t(job_name=f'{na
-00017460: 6d65 7d2d 3120 2d6e 207b 6e61 6d65 7d2d  me}-1 -n {name}-
-00017470: 3227 2920 7768 656e 0a20 2020 2020 2020  2') when.       
-00017480: 2023 2063 616e 6365 6c69 6e67 206d 756c   # canceling mul
-00017490: 7469 706c 6520 6a6f 6220 6e61 6d65 7320  tiple job names 
-000174a0: 6973 2073 7570 706f 7274 6564 2e0a 2020  is supported..  
-000174b0: 2020 2020 2020 285f 4a4f 425f 4341 4e43        (_JOB_CANC
-000174c0: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
-000174d0: 6f62 5f6e 616d 653d 6627 7b6e 616d 657d  ob_name=f'{name}
-000174e0: 2d31 2729 202b 2027 3b20 2720 2b0a 2020  -1') + '; ' +.  
-000174f0: 2020 2020 2020 205f 4a4f 425f 4341 4e43         _JOB_CANC
-00017500: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
-00017510: 6f62 5f6e 616d 653d 6627 7b6e 616d 657d  ob_name=f'{name}
-00017520: 2d32 2729 292c 0a20 2020 2020 2020 2023  -2')),.        #
-00017530: 2049 6e63 7265 6173 6520 7469 6d65 6f75   Increase timeou
-00017540: 7420 7369 6e63 6520 736b 7920 6a6f 6273  t since sky jobs
-00017550: 2071 7565 7565 202d 7220 6361 6e20 6265   queue -r can be
-00017560: 2062 6c6f 636b 6564 2062 7920 6f74 6865   blocked by othe
-00017570: 7220 7370 6f74 2074 6573 7473 2e0a 2020  r spot tests..  
-00017580: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
-00017590: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-000175a0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-000175b0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-000175c0: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
-000175d0: 2020 2366 6c75 6964 7374 6163 6b20 646f    #fluidstack do
-000175e0: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-000175f0: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
-00017600: 7974 6573 742e 6d61 726b 2e6e 6f5f 617a  ytest.mark.no_az
-00017610: 7572 6520 2023 2041 7a75 7265 2064 6f65  ure  # Azure doe
-00017620: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
-00017630: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
-00017640: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
-00017650: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
-00017660: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
-00017670: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-00017680: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-00017690: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
-000176a0: 2049 424d 2043 6c6f 7564 2064 6f65 7320   IBM Cloud does 
-000176b0: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-000176c0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-000176d0: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
-000176e0: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
-000176f0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-00017700: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-00017710: 726b 2e6e 6f5f 7061 7065 7273 7061 6365  rk.no_paperspace
-00017720: 2020 2320 5061 7065 7273 7061 6365 2064    # Paperspace d
-00017730: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-00017740: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-00017750: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6b  pytest.mark.no_k
-00017760: 7562 6572 6e65 7465 7320 2023 204b 7562  ubernetes  # Kub
-00017770: 6572 6e65 7465 7320 646f 6573 206e 6f74  ernetes does not
-00017780: 2068 6176 6520 6120 6e6f 7469 6f6e 206f   have a notion o
-00017790: 6620 7370 6f74 2069 6e73 7461 6e63 6573  f spot instances
-000177a0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
-000177b0: 6e61 6765 645f 6a6f 6273 0a64 6566 2074  naged_jobs.def t
-000177c0: 6573 745f 6a6f 625f 7069 7065 6c69 6e65  est_job_pipeline
-000177d0: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
-000177e0: 7374 7229 3a0a 2020 2020 2222 2254 6573  str):.    """Tes
-000177f0: 7420 6120 6a6f 6220 7069 7065 6c69 6e65  t a job pipeline
-00017800: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
-00017810: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00017820: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00017830: 6573 7428 0a20 2020 2020 2020 2027 7370  est(.        'sp
-00017840: 6f74 2d70 6970 656c 696e 6527 2c0a 2020  ot-pipeline',.  
-00017850: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00017860: 2020 2020 6627 736b 7920 6a6f 6273 206c      f'sky jobs l
-00017870: 6175 6e63 6820 2d6e 207b 6e61 6d65 7d20  aunch -n {name} 
-00017880: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-00017890: 2f70 6970 656c 696e 652e 7961 6d6c 202d  /pipeline.yaml -
-000178a0: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
-000178b0: 2020 2027 736c 6565 7020 3527 2c0a 2020     'sleep 5',.  
-000178c0: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
-000178d0: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
-000178e0: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
-000178f0: 6420 2d6e 3120 7c20 6772 6570 2022 5354  d -n1 | grep "ST
-00017900: 4152 5449 4e47 5c7c 5255 4e4e 494e 4722  ARTING\|RUNNING"
-00017910: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-00017920: 2060 6772 6570 202d 4120 3420 7b6e 616d   `grep -A 4 {nam
-00017930: 657d 6020 6669 6e64 7320 7468 6520 6a6f  e}` finds the jo
-00017940: 6220 7769 7468 207b 6e61 6d65 7d20 616e  b with {name} an
-00017950: 6420 7468 6520 3420 6c69 6e65 730a 2020  d the 4 lines.  
-00017960: 2020 2020 2020 2020 2020 2320 6166 7465            # afte
-00017970: 7220 6974 2c20 692e 652e 2074 6865 2034  r it, i.e. the 4
-00017980: 2074 6173 6b73 2077 6974 6869 6e20 7468   tasks within th
-00017990: 6520 6a6f 622e 0a20 2020 2020 2020 2020  e job..         
-000179a0: 2020 2023 2060 7365 6420 2d6e 2032 7060     # `sed -n 2p`
-000179b0: 2067 6574 7320 7468 6520 7365 636f 6e64   gets the second
-000179c0: 206c 696e 6520 6f66 2074 6865 2034 206c   line of the 4 l
-000179d0: 696e 6573 2c20 692e 652e 2074 6865 2066  ines, i.e. the f
-000179e0: 6972 7374 0a20 2020 2020 2020 2020 2020  irst.           
-000179f0: 2023 2074 6173 6b20 7769 7468 696e 2074   # task within t
-00017a00: 6865 206a 6f62 2e0a 2020 2020 2020 2020  he job..        
-00017a10: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
-00017a20: 455f 5741 4954 7d7c 2067 7265 7020 2d41  E_WAIT}| grep -A
-00017a30: 2034 207b 6e61 6d65 7d7c 2073 6564 202d   4 {name}| sed -
-00017a40: 6e20 3270 207c 2067 7265 7020 2253 5441  n 2p | grep "STA
-00017a50: 5254 494e 475c 7c52 554e 4e49 4e47 2227  RTING\|RUNNING"'
-00017a60: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00017a70: 7b5f 4a4f 425f 5155 4555 455f 5741 4954  {_JOB_QUEUE_WAIT
-00017a80: 7d7c 2067 7265 7020 2d41 2034 207b 6e61  }| grep -A 4 {na
-00017a90: 6d65 7d7c 2073 6564 202d 6e20 3370 207c  me}| sed -n 3p |
-00017aa0: 2067 7265 7020 2250 454e 4449 4e47 2227   grep "PENDING"'
-00017ab0: 2c0a 2020 2020 2020 2020 2020 2020 5f4a  ,.            _J
-00017ac0: 4f42 5f43 414e 4345 4c5f 5741 4954 2e66  OB_CANCEL_WAIT.f
-00017ad0: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d66  ormat(job_name=f
-00017ae0: 277b 6e61 6d65 7d27 292c 0a20 2020 2020  '{name}'),.     
-00017af0: 2020 2020 2020 2027 736c 6565 7020 3527         'sleep 5'
-00017b00: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00017b10: 7b5f 4a4f 425f 5155 4555 455f 5741 4954  {_JOB_QUEUE_WAIT
-00017b20: 7d7c 2067 7265 7020 2d41 2034 207b 6e61  }| grep -A 4 {na
-00017b30: 6d65 7d7c 2073 6564 202d 6e20 3270 207c  me}| sed -n 2p |
-00017b40: 2067 7265 7020 2243 414e 4345 4c4c 494e   grep "CANCELLIN
-00017b50: 475c 7c43 414e 4345 4c4c 4544 2227 2c0a  G\|CANCELLED"',.
-00017b60: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00017b70: 4a4f 425f 5155 4555 455f 5741 4954 7d7c  JOB_QUEUE_WAIT}|
-00017b80: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
-00017b90: 7d7c 2073 6564 202d 6e20 3370 207c 2067  }| sed -n 3p | g
-00017ba0: 7265 7020 2243 414e 4345 4c4c 494e 475c  rep "CANCELLING\
-00017bb0: 7c43 414e 4345 4c4c 4544 2227 2c0a 2020  |CANCELLED"',.  
-00017bc0: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
-00017bd0: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
-00017be0: 7265 7020 2d41 2034 207b 6e61 6d65 7d7c  rep -A 4 {name}|
-00017bf0: 2073 6564 202d 6e20 3470 207c 2067 7265   sed -n 4p | gre
-00017c00: 7020 2243 414e 4345 4c4c 494e 475c 7c43  p "CANCELLING\|C
-00017c10: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
-00017c20: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
-00017c30: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-00017c40: 7020 2d41 2034 207b 6e61 6d65 7d7c 2073  p -A 4 {name}| s
-00017c50: 6564 202d 6e20 3570 207c 2067 7265 7020  ed -n 5p | grep 
-00017c60: 2243 414e 4345 4c4c 494e 475c 7c43 414e  "CANCELLING\|CAN
-00017c70: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
-00017c80: 2020 2020 2020 2773 6c65 6570 2032 3030        'sleep 200
+0000cd60: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+0000cd70: 6e20 7b6e 616d 657d 2d31 202d 2d63 6c6f  n {name}-1 --clo
+0000cd80: 7564 2069 626d 202d 6420 6578 616d 706c  ud ibm -d exampl
+0000cd90: 6573 2f6a 6f62 5f71 7565 7565 2f6a 6f62  es/job_queue/job
+0000cda0: 5f69 626d 2e79 616d 6c27 2c0a 2020 2020  _ibm.yaml',.    
+0000cdb0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+0000cdc0: 6563 207b 6e61 6d65 7d20 2d6e 207b 6e61  ec {name} -n {na
+0000cdd0: 6d65 7d2d 3220 2d2d 636c 6f75 6420 6962  me}-2 --cloud ib
+0000cde0: 6d20 2d64 2065 7861 6d70 6c65 732f 6a6f  m -d examples/jo
+0000cdf0: 625f 7175 6575 652f 6a6f 625f 6962 6d2e  b_queue/job_ibm.
+0000ce00: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+0000ce10: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+0000ce20: 616d 657d 202d 6e20 7b6e 616d 657d 2d33  ame} -n {name}-3
+0000ce30: 202d 2d63 6c6f 7564 2069 626d 202d 6420   --cloud ibm -d 
+0000ce40: 6578 616d 706c 6573 2f6a 6f62 5f71 7565  examples/job_que
+0000ce50: 7565 2f6a 6f62 5f69 626d 2e79 616d 6c27  ue/job_ibm.yaml'
+0000ce60: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000ce70: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+0000ce80: 207c 2067 7265 7020 7b6e 616d 657d 2d31   | grep {name}-1
+0000ce90: 207c 2067 7265 7020 5255 4e4e 494e 4727   | grep RUNNING'
+0000cea0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000ceb0: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+0000cec0: 207c 2067 7265 7020 7b6e 616d 657d 2d32   | grep {name}-2
+0000ced0: 207c 2067 7265 7020 5255 4e4e 494e 4727   | grep RUNNING'
+0000cee0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000cef0: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+0000cf00: 207c 2067 7265 7020 7b6e 616d 657d 2d33   | grep {name}-3
+0000cf10: 207c 2067 7265 7020 5045 4e44 494e 4727   | grep PENDING'
+0000cf20: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000cf30: 736b 7920 6361 6e63 656c 202d 7920 7b6e  sky cancel -y {n
+0000cf40: 616d 657d 2032 272c 0a20 2020 2020 2020  ame} 2',.       
+0000cf50: 2020 2020 2027 736c 6565 7020 3527 2c0a       'sleep 5',.
+0000cf60: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000cf70: 7920 7175 6575 6520 7b6e 616d 657d 207c  y queue {name} |
+0000cf80: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
+0000cf90: 2067 7265 7020 5255 4e4e 494e 4727 2c0a   grep RUNNING',.
+0000cfa0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000cfb0: 7920 6361 6e63 656c 202d 7920 7b6e 616d  y cancel -y {nam
+0000cfc0: 657d 2033 272c 0a20 2020 2020 2020 205d  e} 3',.        ]
+0000cfd0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+0000cfe0: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+0000cff0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+0000d000: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+0000d010: 4070 7974 6573 742e 6d61 726b 2e73 6370  @pytest.mark.scp
+0000d020: 0a64 6566 2074 6573 745f 7363 705f 6a6f  .def test_scp_jo
+0000d030: 625f 7175 6575 6528 293a 0a20 2020 206e  b_queue():.    n
+0000d040: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+0000d050: 6572 5f6e 616d 6528 290a 2020 2020 6e75  er_name().    nu
+0000d060: 6d5f 6f66 5f67 7075 5f6c 6175 6e63 6820  m_of_gpu_launch 
+0000d070: 3d20 310a 2020 2020 6e75 6d5f 6f66 5f67  = 1.    num_of_g
+0000d080: 7075 5f65 7865 6320 3d20 302e 350a 2020  pu_exec = 0.5.  
+0000d090: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+0000d0a0: 2020 2020 2020 2027 5343 505f 6a6f 625f         'SCP_job_
+0000d0b0: 7175 6575 6527 2c0a 2020 2020 2020 2020  queue',.        
+0000d0c0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+0000d0d0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+0000d0e0: 207b 6e61 6d65 7d20 7b53 4350 5f54 5950   {name} {SCP_TYP
+0000d0f0: 457d 207b 5343 505f 4750 555f 5631 3030  E} {SCP_GPU_V100
+0000d100: 7d3a 7b6e 756d 5f6f 665f 6770 755f 6c61  }:{num_of_gpu_la
+0000d110: 756e 6368 7d20 6578 616d 706c 6573 2f6a  unch} examples/j
+0000d120: 6f62 5f71 7565 7565 2f63 6c75 7374 6572  ob_queue/cluster
+0000d130: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+0000d140: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+0000d150: 6e61 6d65 7d20 2d6e 207b 6e61 6d65 7d2d  name} -n {name}-
+0000d160: 3120 7b53 4350 5f47 5055 5f56 3130 307d  1 {SCP_GPU_V100}
+0000d170: 3a7b 6e75 6d5f 6f66 5f67 7075 5f65 7865  :{num_of_gpu_exe
+0000d180: 637d 202d 6420 6578 616d 706c 6573 2f6a  c} -d examples/j
+0000d190: 6f62 5f71 7565 7565 2f6a 6f62 2e79 616d  ob_queue/job.yam
+0000d1a0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+0000d1b0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+0000d1c0: 7d20 2d6e 207b 6e61 6d65 7d2d 3220 7b53  } -n {name}-2 {S
+0000d1d0: 4350 5f47 5055 5f56 3130 307d 3a7b 6e75  CP_GPU_V100}:{nu
+0000d1e0: 6d5f 6f66 5f67 7075 5f65 7865 637d 202d  m_of_gpu_exec} -
+0000d1f0: 6420 6578 616d 706c 6573 2f6a 6f62 5f71  d examples/job_q
+0000d200: 7565 7565 2f6a 6f62 2e79 616d 6c27 2c0a  ueue/job.yaml',.
+0000d210: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000d220: 7920 6578 6563 207b 6e61 6d65 7d20 2d6e  y exec {name} -n
+0000d230: 207b 6e61 6d65 7d2d 3320 7b53 4350 5f47   {name}-3 {SCP_G
+0000d240: 5055 5f56 3130 307d 3a7b 6e75 6d5f 6f66  PU_V100}:{num_of
+0000d250: 5f67 7075 5f65 7865 637d 202d 6420 6578  _gpu_exec} -d ex
+0000d260: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
+0000d270: 2f6a 6f62 2e79 616d 6c27 2c0a 2020 2020  /job.yaml',.    
+0000d280: 2020 2020 2020 2020 6627 736b 7920 7175          f'sky qu
+0000d290: 6575 6520 7b6e 616d 657d 207c 2067 7265  eue {name} | gre
+0000d2a0: 7020 7b6e 616d 657d 2d31 207c 2067 7265  p {name}-1 | gre
+0000d2b0: 7020 5255 4e4e 494e 4727 2c0a 2020 2020  p RUNNING',.    
+0000d2c0: 2020 2020 2020 2020 6627 736b 7920 7175          f'sky qu
+0000d2d0: 6575 6520 7b6e 616d 657d 207c 2067 7265  eue {name} | gre
+0000d2e0: 7020 7b6e 616d 657d 2d32 207c 2067 7265  p {name}-2 | gre
+0000d2f0: 7020 5255 4e4e 494e 4727 2c0a 2020 2020  p RUNNING',.    
+0000d300: 2020 2020 2020 2020 6627 736b 7920 7175          f'sky qu
+0000d310: 6575 6520 7b6e 616d 657d 207c 2067 7265  eue {name} | gre
+0000d320: 7020 7b6e 616d 657d 2d33 207c 2067 7265  p {name}-3 | gre
+0000d330: 7020 5045 4e44 494e 4727 2c0a 2020 2020  p PENDING',.    
+0000d340: 2020 2020 2020 2020 6627 736b 7920 6361          f'sky ca
+0000d350: 6e63 656c 202d 7920 7b6e 616d 657d 2032  ncel -y {name} 2
+0000d360: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+0000d370: 736c 6565 7020 3527 2c0a 2020 2020 2020  sleep 5',.      
+0000d380: 2020 2020 2020 6627 736b 7920 7175 6575        f'sky queu
+0000d390: 6520 7b6e 616d 657d 207c 2067 7265 7020  e {name} | grep 
+0000d3a0: 7b6e 616d 657d 2d33 207c 2067 7265 7020  {name}-3 | grep 
+0000d3b0: 5255 4e4e 494e 4727 2c0a 2020 2020 2020  RUNNING',.      
+0000d3c0: 2020 2020 2020 6627 736b 7920 6361 6e63        f'sky canc
+0000d3d0: 656c 202d 7920 7b6e 616d 657d 2033 272c  el -y {name} 3',
+0000d3e0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+0000d3f0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+0000d400: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
+0000d410: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+0000d420: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+0000d430: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
+0000d440: 7461 636b 2020 2320 466c 7569 6453 7461  tack  # FluidSta
+0000d450: 636b 2044 4320 6861 7320 6c6f 7720 6176  ck DC has low av
+0000d460: 6169 6c61 6269 6c69 7479 206f 6620 5434  ailability of T4
+0000d470: 2047 5055 730a 4070 7974 6573 742e 6d61   GPUs.@pytest.ma
+0000d480: 726b 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f  rk.no_lambda_clo
+0000d490: 7564 2020 2320 4c61 6d62 6461 2043 6c6f  ud  # Lambda Clo
+0000d4a0: 7564 2064 6f65 7320 6e6f 7420 6861 7665  ud does not have
+0000d4b0: 2054 3420 6770 7573 0a40 7079 7465 7374   T4 gpus.@pytest
+0000d4c0: 2e6d 6172 6b2e 6e6f 5f69 626d 2020 2320  .mark.no_ibm  # 
+0000d4d0: 4942 4d20 436c 6f75 6420 646f 6573 206e  IBM Cloud does n
+0000d4e0: 6f74 2068 6176 6520 5434 2067 7075 732e  ot have T4 gpus.
+0000d4f0: 2072 756e 2074 6573 745f 6962 6d5f 6a6f   run test_ibm_jo
+0000d500: 625f 7175 6575 655f 6d75 6c74 696e 6f64  b_queue_multinod
+0000d510: 6520 696e 7374 6561 640a 4070 7974 6573  e instead.@pytes
+0000d520: 742e 6d61 726b 2e6e 6f5f 7061 7065 7273  t.mark.no_papers
+0000d530: 7061 6365 2020 2320 5061 7065 7273 7061  pace  # Paperspa
+0000d540: 6365 2064 6f65 7320 6e6f 7420 6861 7665  ce does not have
+0000d550: 2054 3420 6770 7573 2e0a 4070 7974 6573   T4 gpus..@pytes
+0000d560: 742e 6d61 726b 2e6e 6f5f 7363 7020 2023  t.mark.no_scp  #
+0000d570: 2053 4350 2064 6f65 7320 6e6f 7420 7375   SCP does not su
+0000d580: 7070 6f72 7420 6e75 6d5f 6e6f 6465 7320  pport num_nodes 
+0000d590: 3e20 3120 7965 740a 4070 7974 6573 742e  > 1 yet.@pytest.
+0000d5a0: 6d61 726b 2e6e 6f5f 6f63 6920 2023 204f  mark.no_oci  # O
+0000d5b0: 4349 2043 6c6f 7564 2064 6f65 7320 6e6f  CI Cloud does no
+0000d5c0: 7420 6861 7665 2054 3420 6770 7573 2e0a  t have T4 gpus..
+0000d5d0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+0000d5e0: 6b75 6265 726e 6574 6573 2020 2320 4b75  kubernetes  # Ku
+0000d5f0: 6265 726e 6574 6573 206e 6f74 2073 7570  bernetes not sup
+0000d600: 706f 7274 206e 756d 5f6e 6f64 6573 203e  port num_nodes >
+0000d610: 2031 2079 6574 0a64 6566 2074 6573 745f   1 yet.def test_
+0000d620: 6a6f 625f 7175 6575 655f 6d75 6c74 696e  job_queue_multin
+0000d630: 6f64 6528 6765 6e65 7269 635f 636c 6f75  ode(generic_clou
+0000d640: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
+0000d650: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+0000d660: 5f6e 616d 6528 290a 2020 2020 746f 7461  _name().    tota
+0000d670: 6c5f 7469 6d65 6f75 745f 6d69 6e75 7465  l_timeout_minute
+0000d680: 7320 3d20 3330 2069 6620 6765 6e65 7269  s = 30 if generi
+0000d690: 635f 636c 6f75 6420 3d3d 2027 617a 7572  c_cloud == 'azur
+0000d6a0: 6527 2065 6c73 6520 3135 0a20 2020 2074  e' else 15.    t
+0000d6b0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+0000d6c0: 2020 2020 276a 6f62 5f71 7565 7565 5f6d      'job_queue_m
+0000d6d0: 756c 7469 6e6f 6465 272c 0a20 2020 2020  ultinode',.     
+0000d6e0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+0000d6f0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+0000d700: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
+0000d710: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
+0000d720: 647d 2065 7861 6d70 6c65 732f 6a6f 625f  d} examples/job_
+0000d730: 7175 6575 652f 636c 7573 7465 725f 6d75  queue/cluster_mu
+0000d740: 6c74 696e 6f64 652e 7961 6d6c 272c 0a20  ltinode.yaml',. 
+0000d750: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000d760: 2065 7865 6320 7b6e 616d 657d 202d 6e20   exec {name} -n 
+0000d770: 7b6e 616d 657d 2d31 202d 6420 6578 616d  {name}-1 -d exam
+0000d780: 706c 6573 2f6a 6f62 5f71 7565 7565 2f6a  ples/job_queue/j
+0000d790: 6f62 5f6d 756c 7469 6e6f 6465 2e79 616d  ob_multinode.yam
+0000d7a0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+0000d7b0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+0000d7c0: 7d20 2d6e 207b 6e61 6d65 7d2d 3220 2d64  } -n {name}-2 -d
+0000d7d0: 2065 7861 6d70 6c65 732f 6a6f 625f 7175   examples/job_qu
+0000d7e0: 6575 652f 6a6f 625f 6d75 6c74 696e 6f64  eue/job_multinod
+0000d7f0: 652e 7961 6d6c 272c 0a20 2020 2020 2020  e.yaml',.       
+0000d800: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+0000d810: 6820 2d63 207b 6e61 6d65 7d20 2d6e 207b  h -c {name} -n {
+0000d820: 6e61 6d65 7d2d 3320 2d2d 6465 7461 6368  name}-3 --detach
+0000d830: 2d73 6574 7570 202d 6420 6578 616d 706c  -setup -d exampl
+0000d840: 6573 2f6a 6f62 5f71 7565 7565 2f6a 6f62  es/job_queue/job
+0000d850: 5f6d 756c 7469 6e6f 6465 2e79 616d 6c27  _multinode.yaml'
+0000d860: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000d870: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
+0000d880: 616d 657d 2920 2626 2065 6368 6f20 2224  ame}) && echo "$
+0000d890: 7322 2026 2620 2865 6368 6f20 2224 7322  s" && (echo "$s"
+0000d8a0: 207c 2067 7265 7020 7b6e 616d 657d 2d31   | grep {name}-1
+0000d8b0: 207c 2067 7265 7020 5255 4e4e 494e 4729   | grep RUNNING)
+0000d8c0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000d8d0: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
+0000d8e0: 6e61 6d65 7d29 2026 2620 6563 686f 2022  name}) && echo "
+0000d8f0: 2473 2220 2626 2028 6563 686f 2022 2473  $s" && (echo "$s
+0000d900: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
+0000d910: 3220 7c20 6772 6570 2052 554e 4e49 4e47  2 | grep RUNNING
+0000d920: 2927 2c0a 2020 2020 2020 2020 2020 2020  )',.            
+0000d930: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
+0000d940: 7b6e 616d 657d 2920 2626 2065 6368 6f20  {name}) && echo 
+0000d950: 2224 7322 2026 2620 2865 6368 6f20 2224  "$s" && (echo "$
+0000d960: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
+0000d970: 2d33 207c 2067 7265 7020 5045 4e44 494e  -3 | grep PENDIN
+0000d980: 4729 272c 0a20 2020 2020 2020 2020 2020  G)',.           
+0000d990: 2027 736c 6565 7020 3930 272c 0a20 2020   'sleep 90',.   
+0000d9a0: 2020 2020 2020 2020 2066 2773 6b79 2063           f'sky c
+0000d9b0: 616e 6365 6c20 2d79 207b 6e61 6d65 7d20  ancel -y {name} 
+0000d9c0: 3127 2c0a 2020 2020 2020 2020 2020 2020  1',.            
+0000d9d0: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
+0000d9e0: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+0000d9f0: 2071 7565 7565 207b 6e61 6d65 7d29 3b20   queue {name}); 
+0000da00: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
+0000da10: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
+0000da20: 207c 2067 7265 7020 7b6e 616d 657d 2d33   | grep {name}-3
+0000da30: 207c 2067 7265 7020 5345 5454 494e 475f   | grep SETTING_
+0000da40: 5550 272c 0a20 2020 2020 2020 2020 2020  UP',.           
+0000da50: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
+0000da60: 207b 6e61 6d65 7d20 3120 3220 3327 2c0a   {name} 1 2 3',.
+0000da70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000da80: 7920 6c61 756e 6368 202d 6320 7b6e 616d  y launch -c {nam
+0000da90: 657d 202d 6e20 7b6e 616d 657d 2d34 202d  e} -n {name}-4 -
+0000daa0: 2d64 6574 6163 682d 7365 7475 7020 2d64  -detach-setup -d
+0000dab0: 2065 7861 6d70 6c65 732f 6a6f 625f 7175   examples/job_qu
+0000dac0: 6575 652f 6a6f 625f 6d75 6c74 696e 6f64  eue/job_multinod
+0000dad0: 652e 7961 6d6c 272c 0a20 2020 2020 2020  e.yaml',.       
+0000dae0: 2020 2020 2023 2054 6573 7420 7468 6520       # Test the 
+0000daf0: 6a6f 6220 7374 6174 7573 2069 7320 636f  job status is co
+0000db00: 7272 6563 746c 7920 7365 7420 746f 2053  rrectly set to S
+0000db10: 4554 5449 4e47 5f55 502c 2064 7572 696e  ETTING_UP, durin
+0000db20: 6720 7468 6520 7365 7475 7020 6973 2072  g the setup is r
+0000db30: 756e 6e69 6e67 2c0a 2020 2020 2020 2020  unning,.        
+0000db40: 2020 2020 2320 616e 6420 7468 6520 6a6f      # and the jo
+0000db50: 6220 6361 6e20 6265 2063 616e 6365 6c6c  b can be cancell
+0000db60: 6564 2064 7572 696e 6720 7468 6520 7365  ed during the se
+0000db70: 7475 702e 0a20 2020 2020 2020 2020 2020  tup..           
+0000db80: 2027 736c 6565 7020 3527 2c0a 2020 2020   'sleep 5',.    
+0000db90: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
+0000dba0: 7920 7175 6575 6520 7b6e 616d 657d 2920  y queue {name}) 
+0000dbb0: 2626 2065 6368 6f20 2224 7322 2026 2620  && echo "$s" && 
+0000dbc0: 2865 6368 6f20 2224 7322 207c 2067 7265  (echo "$s" | gre
+0000dbd0: 7020 7b6e 616d 657d 2d34 207c 2067 7265  p {name}-4 | gre
+0000dbe0: 7020 5345 5454 494e 475f 5550 2927 2c0a  p SETTING_UP)',.
+0000dbf0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000dc00: 7920 6361 6e63 656c 202d 7920 7b6e 616d  y cancel -y {nam
+0000dc10: 657d 2034 272c 0a20 2020 2020 2020 2020  e} 4',.         
+0000dc20: 2020 2066 2773 3d24 2873 6b79 2071 7565     f's=$(sky que
+0000dc30: 7565 207b 6e61 6d65 7d29 2026 2620 6563  ue {name}) && ec
+0000dc40: 686f 2022 2473 2220 2626 2028 6563 686f  ho "$s" && (echo
+0000dc50: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
+0000dc60: 6d65 7d2d 3420 7c20 6772 6570 2043 414e  me}-4 | grep CAN
+0000dc70: 4345 4c4c 4544 2927 2c0a 2020 2020 2020  CELLED)',.      
+0000dc80: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+0000dc90: 207b 6e61 6d65 7d20 2d2d 6770 7573 2054   {name} --gpus T
+0000dca0: 343a 302e 3220 225b 5b20 5c24 534b 5950  4:0.2 "[[ \$SKYP
+0000dcb0: 494c 4f54 5f4e 554d 5f47 5055 535f 5045  ILOT_NUM_GPUS_PE
+0000dcc0: 525f 4e4f 4445 202d 6571 2031 205d 5d20  R_NODE -eq 1 ]] 
+0000dcd0: 7c7c 2065 7869 7420 3122 272c 0a20 2020  || exit 1"',.   
+0000dce0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+0000dcf0: 7865 6320 7b6e 616d 657d 202d 2d67 7075  xec {name} --gpu
+0000dd00: 7320 5434 3a30 2e32 202d 2d6e 756d 2d6e  s T4:0.2 --num-n
+0000dd10: 6f64 6573 2032 2022 5b5b 205c 2453 4b59  odes 2 "[[ \$SKY
+0000dd20: 5049 4c4f 545f 4e55 4d5f 4750 5553 5f50  PILOT_NUM_GPUS_P
+0000dd30: 4552 5f4e 4f44 4520 2d65 7120 3120 5d5d  ER_NODE -eq 1 ]]
+0000dd40: 207c 7c20 6578 6974 2031 2227 2c0a 2020   || exit 1"',.  
+0000dd50: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000dd60: 6578 6563 207b 6e61 6d65 7d20 2d2d 6770  exec {name} --gp
+0000dd70: 7573 2054 343a 3120 2d2d 6e75 6d2d 6e6f  us T4:1 --num-no
+0000dd80: 6465 7320 3220 225b 5b20 5c24 534b 5950  des 2 "[[ \$SKYP
+0000dd90: 494c 4f54 5f4e 554d 5f47 5055 535f 5045  ILOT_NUM_GPUS_PE
+0000dda0: 525f 4e4f 4445 202d 6571 2031 205d 5d20  R_NODE -eq 1 ]] 
+0000ddb0: 7c7c 2065 7869 7420 3122 272c 0a20 2020  || exit 1"',.   
+0000ddc0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+0000ddd0: 6f67 7320 7b6e 616d 657d 2035 202d 2d73  ogs {name} 5 --s
+0000dde0: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+0000ddf0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0000de00: 6e61 6d65 7d20 3620 2d2d 7374 6174 7573  name} 6 --status
+0000de10: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000de20: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+0000de30: 2037 202d 2d73 7461 7475 7327 2c0a 2020   7 --status',.  
+0000de40: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+0000de50: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+0000de60: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
+0000de70: 7469 6d65 6f75 743d 746f 7461 6c5f 7469  timeout=total_ti
+0000de80: 6d65 6f75 745f 6d69 6e75 7465 7320 2a20  meout_minutes * 
+0000de90: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
+0000dea0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+0000deb0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+0000dec0: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
+0000ded0: 2023 204e 6f20 4c61 6d62 6461 2043 6c6f   # No Lambda Clo
+0000dee0: 7564 2056 4d20 6861 7320 3820 4350 5573  ud VM has 8 CPUs
+0000def0: 0a64 6566 2074 6573 745f 6c61 7267 655f  .def test_large_
+0000df00: 6a6f 625f 7175 6575 6528 6765 6e65 7269  job_queue(generi
+0000df10: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+0000df20: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+0000df30: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+0000df40: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+0000df50: 2020 2020 2020 2027 6c61 7267 655f 6a6f         'large_jo
+0000df60: 625f 7175 6575 6527 2c0a 2020 2020 2020  b_queue',.      
+0000df70: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+0000df80: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+0000df90: 2d63 207b 6e61 6d65 7d20 2d2d 6370 7573  -c {name} --cpus
+0000dfa0: 2038 202d 2d63 6c6f 7564 207b 6765 6e65   8 --cloud {gene
+0000dfb0: 7269 635f 636c 6f75 647d 272c 0a20 2020  ric_cloud}',.   
+0000dfc0: 2020 2020 2020 2020 2066 2766 6f72 2069           f'for i
+0000dfd0: 2069 6e20 6073 6571 2031 2037 3560 3b20   in `seq 1 75`; 
+0000dfe0: 646f 2073 6b79 2065 7865 6320 7b6e 616d  do sky exec {nam
+0000dff0: 657d 202d 6e20 7b6e 616d 657d 2d24 6920  e} -n {name}-$i 
+0000e000: 2d64 2022 6563 686f 2024 693b 2073 6c65  -d "echo $i; sle
+0000e010: 6570 2031 3030 3030 3030 3030 223b 2064  ep 100000000"; d
+0000e020: 6f6e 6527 2c0a 2020 2020 2020 2020 2020  one',.          
+0000e030: 2020 6627 736b 7920 6361 6e63 656c 202d    f'sky cancel -
+0000e040: 7920 7b6e 616d 657d 2031 2032 2033 2034  y {name} 1 2 3 4
+0000e050: 2035 2036 2037 2038 2039 2031 3020 3131   5 6 7 8 9 10 11
+0000e060: 2031 3220 3133 2031 3420 3135 2031 3627   12 13 14 15 16'
+0000e070: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0000e080: 6c65 6570 2039 3027 2c0a 2020 2020 2020  leep 90',.      
+0000e090: 2020 2020 2020 2320 4561 6368 206a 6f62        # Each job
+0000e0a0: 2074 616b 6573 2030 2e35 2043 5055 2061   takes 0.5 CPU a
+0000e0b0: 6e64 2074 6865 2064 6566 6175 6c74 2056  nd the default V
+0000e0c0: 4d20 6861 7320 3820 4350 5573 2c20 736f  M has 8 CPUs, so
+0000e0d0: 2074 6865 7265 2073 686f 756c 6420 6265   there should be
+0000e0e0: 2038 202f 2030 2e35 203d 2031 3620 6a6f   8 / 0.5 = 16 jo
+0000e0f0: 6273 2072 756e 6e69 6e67 2e0a 2020 2020  bs running..    
+0000e100: 2020 2020 2020 2020 2320 5468 6520 6669          # The fi
+0000e110: 7273 7420 3136 206a 6f62 7320 6172 6520  rst 16 jobs are 
+0000e120: 6361 6e63 656c 6564 2c20 736f 2074 6865  canceled, so the
+0000e130: 7265 2073 686f 756c 6420 6265 2037 3520  re should be 75 
+0000e140: 2d20 3332 203d 2034 3320 6a6f 6273 2050  - 32 = 43 jobs P
+0000e150: 454e 4449 4e47 2e0a 2020 2020 2020 2020  ENDING..        
+0000e160: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
+0000e170: 6575 6520 7b6e 616d 657d 293b 2065 6368  eue {name}); ech
+0000e180: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
+0000e190: 686f 3b20 6563 686f 2022 2473 2220 7c20  ho; echo "$s" | 
+0000e1a0: 6772 6570 202d 7620 6772 6570 207c 2067  grep -v grep | g
+0000e1b0: 7265 7020 5045 4e44 494e 4720 7c20 7763  rep PENDING | wc
+0000e1c0: 202d 6c20 7c20 6772 6570 2034 3327 2c0a   -l | grep 43',.
+0000e1d0: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
+0000e1e0: 6b65 2073 7572 6520 7468 6520 6a6f 6273  ke sure the jobs
+0000e1f0: 2061 7265 2073 6368 6564 756c 6564 2069   are scheduled i
+0000e200: 6e20 4649 464f 206f 7264 6572 0a20 2020  n FIFO order.   
+0000e210: 2020 2020 2020 2020 202a 5b0a 2020 2020           *[.    
+0000e220: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+0000e230: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
+0000e240: 657d 293b 2065 6368 6f20 2224 7322 3b20  e}); echo "$s"; 
+0000e250: 6563 686f 3b20 6563 686f 3b20 6563 686f  echo; echo; echo
+0000e260: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
+0000e270: 6d65 7d2d 7b69 7d20 7c20 6772 6570 2043  me}-{i} | grep C
+0000e280: 414e 4345 4c4c 4544 270a 2020 2020 2020  ANCELLED'.      
+0000e290: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
+0000e2a0: 696e 2072 616e 6765 2831 2c20 3137 290a  in range(1, 17).
+0000e2b0: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
+0000e2c0: 2020 2020 2020 2020 2020 202a 5b0a 2020             *[.  
+0000e2d0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0000e2e0: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
+0000e2f0: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
+0000e300: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
+0000e310: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
+0000e320: 6e61 6d65 7d2d 7b69 7d20 7c20 6772 6570  name}-{i} | grep
+0000e330: 2052 554e 4e49 4e47 270a 2020 2020 2020   RUNNING'.      
+0000e340: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
+0000e350: 696e 2072 616e 6765 2831 372c 2033 3329  in range(17, 33)
+0000e360: 0a20 2020 2020 2020 2020 2020 205d 2c0a  .            ],.
+0000e370: 2020 2020 2020 2020 2020 2020 2a5b 0a20              *[. 
+0000e380: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000e390: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
+0000e3a0: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
+0000e3b0: 223b 2065 6368 6f3b 2065 6368 6f3b 2065  "; echo; echo; e
+0000e3c0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+0000e3d0: 7b6e 616d 657d 2d7b 697d 207c 2067 7265  {name}-{i} | gre
+0000e3e0: 7020 5045 4e44 494e 4727 0a20 2020 2020  p PENDING'.     
+0000e3f0: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+0000e400: 2069 6e20 7261 6e67 6528 3333 2c20 3735   in range(33, 75
+0000e410: 290a 2020 2020 2020 2020 2020 2020 5d2c  ).            ],
+0000e420: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000e430: 6b79 2063 616e 6365 6c20 2d79 207b 6e61  ky cancel -y {na
+0000e440: 6d65 7d20 3333 2033 3520 3337 2033 3920  me} 33 35 37 39 
+0000e450: 3137 2031 3820 3139 272c 0a20 2020 2020  17 18 19',.     
+0000e460: 2020 2020 2020 202a 5b0a 2020 2020 2020         *[.      
+0000e470: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+0000e480: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+0000e490: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
+0000e4a0: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
+0000e4b0: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
+0000e4c0: 7d2d 7b69 7d20 7c20 6772 6570 2043 414e  }-{i} | grep CAN
+0000e4d0: 4345 4c4c 4544 270a 2020 2020 2020 2020  CELLED'.        
+0000e4e0: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
+0000e4f0: 2072 616e 6765 2833 332c 2034 302c 2032   range(33, 40, 2
+0000e500: 290a 2020 2020 2020 2020 2020 2020 5d2c  ).            ],
+0000e510: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0000e520: 6565 7020 3130 272c 0a20 2020 2020 2020  eep 10',.       
+0000e530: 2020 2020 202a 5b0a 2020 2020 2020 2020       *[.        
+0000e540: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
+0000e550: 7920 7175 6575 6520 7b6e 616d 657d 293b  y queue {name});
+0000e560: 2065 6368 6f20 2224 7322 3b20 6563 686f   echo "$s"; echo
+0000e570: 3b20 6563 686f 3b20 6563 686f 2022 2473  ; echo; echo "$s
+0000e580: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
+0000e590: 7b69 7d20 7c20 6772 6570 2052 554e 4e49  {i} | grep RUNNI
+0000e5a0: 4e47 270a 2020 2020 2020 2020 2020 2020  NG'.            
+0000e5b0: 2020 2020 666f 7220 6920 696e 205b 3334      for i in [34
+0000e5c0: 2c20 3336 2c20 3338 5d0a 2020 2020 2020  , 36, 38].      
+0000e5d0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+0000e5e0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+0000e5f0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+0000e600: 272c 0a20 2020 2020 2020 2074 696d 656f  ',.        timeo
+0000e610: 7574 3d32 3520 2a20 3630 2c0a 2020 2020  ut=25 * 60,.    
+0000e620: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+0000e630: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+0000e640: 7374 2e6d 6172 6b2e 6e6f 5f6c 616d 6264  st.mark.no_lambd
+0000e650: 615f 636c 6f75 6420 2023 204e 6f20 4c61  a_cloud  # No La
+0000e660: 6d62 6461 2043 6c6f 7564 2056 4d20 6861  mbda Cloud VM ha
+0000e670: 7320 3820 4350 5573 0a64 6566 2074 6573  s 8 CPUs.def tes
+0000e680: 745f 6661 7374 5f6c 6172 6765 5f6a 6f62  t_fast_large_job
+0000e690: 5f71 7565 7565 2867 656e 6572 6963 5f63  _queue(generic_c
+0000e6a0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+0000e6b0: 2320 5468 6973 2069 7320 746f 2074 6573  # This is to tes
+0000e6c0: 7420 7468 6520 6a6f 6273 2063 616e 2062  t the jobs can b
+0000e6d0: 6520 7363 6865 6475 6c65 6420 7175 6963  e scheduled quic
+0000e6e0: 6b6c 7920 7768 656e 2074 6865 7265 2061  kly when there a
+0000e6f0: 7265 206d 616e 7920 6a6f 6273 2069 6e20  re many jobs in 
+0000e700: 7468 6520 7175 6575 652e 0a20 2020 206e  the queue..    n
+0000e710: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+0000e720: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+0000e730: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+0000e740: 2020 2027 6661 7374 5f6c 6172 6765 5f6a     'fast_large_j
+0000e750: 6f62 5f71 7565 7565 272c 0a20 2020 2020  ob_queue',.     
+0000e760: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+0000e770: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+0000e780: 202d 6320 7b6e 616d 657d 202d 2d63 7075   -c {name} --cpu
+0000e790: 7320 3820 2d2d 636c 6f75 6420 7b67 656e  s 8 --cloud {gen
+0000e7a0: 6572 6963 5f63 6c6f 7564 7d27 2c0a 2020  eric_cloud}',.  
+0000e7b0: 2020 2020 2020 2020 2020 6627 666f 7220            f'for 
+0000e7c0: 6920 696e 2060 7365 7120 3120 3332 603b  i in `seq 1 32`;
+0000e7d0: 2064 6f20 736b 7920 6578 6563 207b 6e61   do sky exec {na
+0000e7e0: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 2469  me} -n {name}-$i
+0000e7f0: 202d 6420 2265 6368 6f20 2469 223b 2064   -d "echo $i"; d
+0000e800: 6f6e 6527 2c0a 2020 2020 2020 2020 2020  one',.          
+0000e810: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
+0000e820: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+0000e830: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+0000e840: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
+0000e850: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
+0000e860: 2473 2220 7c20 6772 6570 202d 7620 6772  $s" | grep -v gr
+0000e870: 6570 207c 2067 7265 7020 5355 4343 4545  ep | grep SUCCEE
+0000e880: 4445 4420 7c20 7763 202d 6c20 7c20 6772  DED | wc -l | gr
+0000e890: 6570 2033 3227 2c0a 2020 2020 2020 2020  ep 32',.        
+0000e8a0: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+0000e8b0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+0000e8c0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+0000e8d0: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
+0000e8e0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+0000e8f0: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+0000e900: 742e 6d61 726b 2e69 626d 0a64 6566 2074  t.mark.ibm.def t
+0000e910: 6573 745f 6962 6d5f 6a6f 625f 7175 6575  est_ibm_job_queu
+0000e920: 655f 6d75 6c74 696e 6f64 6528 293a 0a20  e_multinode():. 
+0000e930: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+0000e940: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+0000e950: 2020 7461 736b 5f66 696c 6520 3d20 2765    task_file = 'e
+0000e960: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
+0000e970: 652f 6a6f 625f 6d75 6c74 696e 6f64 655f  e/job_multinode_
+0000e980: 6962 6d2e 7961 6d6c 270a 2020 2020 7465  ibm.yaml'.    te
+0000e990: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+0000e9a0: 2020 2027 6962 6d5f 6a6f 625f 7175 6575     'ibm_job_queu
+0000e9b0: 655f 6d75 6c74 696e 6f64 6527 2c0a 2020  e_multinode',.  
+0000e9c0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+0000e9d0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+0000e9e0: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+0000e9f0: 636c 6f75 6420 6962 6d20 2d2d 6770 7573  cloud ibm --gpus
+0000ea00: 2076 3130 3020 2d2d 6e75 6d2d 6e6f 6465   v100 --num-node
+0000ea10: 7320 3227 2c0a 2020 2020 2020 2020 2020  s 2',.          
+0000ea20: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+0000ea30: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3120  me} -n {name}-1 
+0000ea40: 2d64 207b 7461 736b 5f66 696c 657d 272c  -d {task_file}',
+0000ea50: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000ea60: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+0000ea70: 6e20 7b6e 616d 657d 2d32 202d 6420 7b74  n {name}-2 -d {t
+0000ea80: 6173 6b5f 6669 6c65 7d27 2c0a 2020 2020  ask_file}',.    
+0000ea90: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+0000eaa0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+0000eab0: 7d20 2d6e 207b 6e61 6d65 7d2d 3320 2d2d  } -n {name}-3 --
+0000eac0: 6465 7461 6368 2d73 6574 7570 202d 6420  detach-setup -d 
+0000ead0: 7b74 6173 6b5f 6669 6c65 7d27 2c0a 2020  {task_file}',.  
+0000eae0: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+0000eaf0: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+0000eb00: 2920 2626 2070 7269 6e74 6620 2224 7322  ) && printf "$s"
+0000eb10: 2026 2620 2865 6368 6f20 2224 7322 207c   && (echo "$s" |
+0000eb20: 2067 7265 7020 7b6e 616d 657d 2d31 207c   grep {name}-1 |
+0000eb30: 2067 7265 7020 5255 4e4e 494e 4729 272c   grep RUNNING)',
+0000eb40: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000eb50: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
+0000eb60: 6d65 7d29 2026 2620 7072 696e 7466 2022  me}) && printf "
+0000eb70: 2473 2220 2626 2028 6563 686f 2022 2473  $s" && (echo "$s
+0000eb80: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
+0000eb90: 3220 7c20 6772 6570 2052 554e 4e49 4e47  2 | grep RUNNING
+0000eba0: 2927 2c0a 2020 2020 2020 2020 2020 2020  )',.            
+0000ebb0: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
+0000ebc0: 7b6e 616d 657d 2920 2626 2070 7269 6e74  {name}) && print
+0000ebd0: 6620 2224 7322 2026 2620 2865 6368 6f20  f "$s" && (echo 
+0000ebe0: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+0000ebf0: 657d 2d33 207c 2067 7265 7020 5345 5454  e}-3 | grep SETT
+0000ec00: 494e 475f 5550 2927 2c0a 2020 2020 2020  ING_UP)',.      
+0000ec10: 2020 2020 2020 2773 6c65 6570 2039 3027        'sleep 90'
+0000ec20: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000ec30: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
+0000ec40: 616d 657d 2920 2626 2070 7269 6e74 6620  ame}) && printf 
+0000ec50: 2224 7322 2026 2620 2865 6368 6f20 2224  "$s" && (echo "$
+0000ec60: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
+0000ec70: 2d33 207c 2067 7265 7020 5045 4e44 494e  -3 | grep PENDIN
+0000ec80: 4729 272c 0a20 2020 2020 2020 2020 2020  G)',.           
+0000ec90: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
+0000eca0: 207b 6e61 6d65 7d20 3127 2c0a 2020 2020   {name} 1',.    
+0000ecb0: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
+0000ecc0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000ecd0: 2773 6b79 2071 7565 7565 207b 6e61 6d65  'sky queue {name
+0000ece0: 7d20 7c20 6772 6570 207b 6e61 6d65 7d2d  } | grep {name}-
+0000ecf0: 3320 7c20 6772 6570 2052 554e 4e49 4e47  3 | grep RUNNING
+0000ed00: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000ed10: 2773 6b79 2063 616e 6365 6c20 2d79 207b  'sky cancel -y {
+0000ed20: 6e61 6d65 7d20 3120 3220 3327 2c0a 2020  name} 1 2 3',.  
+0000ed30: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000ed40: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
+0000ed50: 202d 6e20 7b6e 616d 657d 2d34 202d 2d64   -n {name}-4 --d
+0000ed60: 6574 6163 682d 7365 7475 7020 2d64 207b  etach-setup -d {
+0000ed70: 7461 736b 5f66 696c 657d 272c 0a20 2020  task_file}',.   
+0000ed80: 2020 2020 2020 2020 2023 2054 6573 7420           # Test 
+0000ed90: 7468 6520 6a6f 6220 7374 6174 7573 2069  the job status i
+0000eda0: 7320 636f 7272 6563 746c 7920 7365 7420  s correctly set 
+0000edb0: 746f 2053 4554 5449 4e47 5f55 502c 2064  to SETTING_UP, d
+0000edc0: 7572 696e 6720 7468 6520 7365 7475 7020  uring the setup 
+0000edd0: 6973 2072 756e 6e69 6e67 2c0a 2020 2020  is running,.    
+0000ede0: 2020 2020 2020 2020 2320 616e 6420 7468          # and th
+0000edf0: 6520 6a6f 6220 6361 6e20 6265 2063 616e  e job can be can
+0000ee00: 6365 6c6c 6564 2064 7572 696e 6720 7468  celled during th
+0000ee10: 6520 7365 7475 702e 0a20 2020 2020 2020  e setup..       
+0000ee20: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
+0000ee30: 7565 7565 207b 6e61 6d65 7d29 2026 2620  ueue {name}) && 
+0000ee40: 7072 696e 7466 2022 2473 2220 2626 2028  printf "$s" && (
+0000ee50: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+0000ee60: 207b 6e61 6d65 7d2d 3420 7c20 6772 6570   {name}-4 | grep
+0000ee70: 2053 4554 5449 4e47 5f55 5029 272c 0a20   SETTING_UP)',. 
+0000ee80: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000ee90: 2063 616e 6365 6c20 2d79 207b 6e61 6d65   cancel -y {name
+0000eea0: 7d20 3427 2c0a 2020 2020 2020 2020 2020  } 4',.          
+0000eeb0: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
+0000eec0: 6520 7b6e 616d 657d 2920 2626 2070 7269  e {name}) && pri
+0000eed0: 6e74 6620 2224 7322 2026 2620 2865 6368  ntf "$s" && (ech
+0000eee0: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
+0000eef0: 616d 657d 2d34 207c 2067 7265 7020 4341  ame}-4 | grep CA
+0000ef00: 4e43 454c 4c45 4429 272c 0a20 2020 2020  NCELLED)',.     
+0000ef10: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0000ef20: 6320 7b6e 616d 657d 202d 2d67 7075 7320  c {name} --gpus 
+0000ef30: 7631 3030 3a30 2e32 2022 5b5b 205c 2453  v100:0.2 "[[ \$S
+0000ef40: 4b59 5049 4c4f 545f 4e55 4d5f 4750 5553  KYPILOT_NUM_GPUS
+0000ef50: 5f50 4552 5f4e 4f44 4520 2d65 7120 3120  _PER_NODE -eq 1 
+0000ef60: 5d5d 207c 7c20 6578 6974 2031 2227 2c0a  ]] || exit 1"',.
+0000ef70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000ef80: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
+0000ef90: 6770 7573 2076 3130 303a 302e 3220 2d2d  gpus v100:0.2 --
+0000efa0: 6e75 6d2d 6e6f 6465 7320 3220 225b 5b20  num-nodes 2 "[[ 
+0000efb0: 5c24 534b 5950 494c 4f54 5f4e 554d 5f47  \$SKYPILOT_NUM_G
+0000efc0: 5055 535f 5045 525f 4e4f 4445 202d 6571  PUS_PER_NODE -eq
+0000efd0: 2031 205d 5d20 7c7c 2065 7869 7420 3122   1 ]] || exit 1"
+0000efe0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000eff0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+0000f000: 202d 2d67 7075 7320 7631 3030 3a31 202d   --gpus v100:1 -
+0000f010: 2d6e 756d 2d6e 6f64 6573 2032 2022 5b5b  -num-nodes 2 "[[
+0000f020: 205c 2453 4b59 5049 4c4f 545f 4e55 4d5f   \$SKYPILOT_NUM_
+0000f030: 4750 5553 5f50 4552 5f4e 4f44 4520 2d65  GPUS_PER_NODE -e
+0000f040: 7120 3120 5d5d 207c 7c20 6578 6974 2031  q 1 ]] || exit 1
+0000f050: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0000f060: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+0000f070: 7d20 3520 2d2d 7374 6174 7573 272c 0a20  } 5 --status',. 
+0000f080: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000f090: 206c 6f67 7320 7b6e 616d 657d 2036 202d   logs {name} 6 -
+0000f0a0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+0000f0b0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+0000f0c0: 207b 6e61 6d65 7d20 3720 2d2d 7374 6174   {name} 7 --stat
+0000f0d0: 7573 272c 0a20 2020 2020 2020 205d 2c0a  us',.        ],.
+0000f0e0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+0000f0f0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+0000f100: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+0000f110: 3020 2a20 3630 2c20 2023 2032 3020 6d69  0 * 60,  # 20 mi
+0000f120: 6e73 0a20 2020 2029 0a20 2020 2072 756e  ns.    ).    run
+0000f130: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+0000f140: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2044  ..# ---------- D
+0000f150: 6f63 6b65 7220 7769 7468 2070 7265 696e  ocker with prein
+0000f160: 7374 616c 6c65 6420 7061 636b 6167 652e  stalled package.
+0000f170: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
+0000f180: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
+0000f190: 6473 7461 636b 2020 2320 446f 6573 6e27  dstack  # Doesn'
+0000f1a0: 7420 7375 7070 6f72 7420 466c 7569 6473  t support Fluids
+0000f1b0: 7461 636b 2066 6f72 206e 6f77 0a40 7079  tack for now.@py
+0000f1c0: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
+0000f1d0: 6264 615f 636c 6f75 6420 2023 2044 6f65  bda_cloud  # Doe
+0000f1e0: 736e 2774 2073 7570 706f 7274 204c 616d  sn't support Lam
+0000f1f0: 6264 6120 436c 6f75 6420 666f 7220 6e6f  bda Cloud for no
+0000f200: 770a 4070 7974 6573 742e 6d61 726b 2e6e  w.@pytest.mark.n
+0000f210: 6f5f 6962 6d20 2023 2044 6f65 736e 2774  o_ibm  # Doesn't
+0000f220: 2073 7570 706f 7274 2049 424d 2043 6c6f   support IBM Clo
+0000f230: 7564 2066 6f72 206e 6f77 0a40 7079 7465  ud for now.@pyte
+0000f240: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
+0000f250: 2320 446f 6573 6e27 7420 7375 7070 6f72  # Doesn't suppor
+0000f260: 7420 5343 5020 666f 7220 6e6f 770a 4070  t SCP for now.@p
+0000f270: 7974 6573 742e 6d61 726b 2e6e 6f5f 6f63  ytest.mark.no_oc
+0000f280: 6920 2023 2044 6f65 736e 2774 2073 7570  i  # Doesn't sup
+0000f290: 706f 7274 204f 4349 2066 6f72 206e 6f77  port OCI for now
+0000f2a0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+0000f2b0: 5f6b 7562 6572 6e65 7465 7320 2023 2044  _kubernetes  # D
+0000f2c0: 6f65 736e 2774 2073 7570 706f 7274 204b  oesn't support K
+0000f2d0: 7562 6572 6e65 7465 7320 666f 7220 6e6f  ubernetes for no
+0000f2e0: 770a 2320 544f 444f 287a 6877 7529 3a20  w.# TODO(zhwu): 
+0000f2f0: 7765 2073 686f 756c 6420 6669 7820 7468  we should fix th
+0000f300: 6973 2066 6f72 206b 7562 6572 6e65 7465  is for kubernete
+0000f310: 730a 6465 6620 7465 7374 5f64 6f63 6b65  s.def test_docke
+0000f320: 725f 7072 6569 6e73 7461 6c6c 6564 5f70  r_preinstalled_p
+0000f330: 6163 6b61 6765 2867 656e 6572 6963 5f63  ackage(generic_c
+0000f340: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+0000f350: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+0000f360: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+0000f370: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+0000f380: 2020 2020 2764 6f63 6b65 725f 7769 7468      'docker_with
+0000f390: 5f70 7265 696e 7374 616c 6c65 645f 7061  _preinstalled_pa
+0000f3a0: 636b 6167 6527 2c0a 2020 2020 2020 2020  ckage',.        
+0000f3b0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+0000f3c0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+0000f3d0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+0000f3e0: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+0000f3f0: 2d2d 696d 6167 652d 6964 2064 6f63 6b65  --image-id docke
+0000f400: 723a 6e67 696e 7827 2c0a 2020 2020 2020  r:nginx',.      
+0000f410: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+0000f420: 207b 6e61 6d65 7d20 226e 6769 6e78 202d   {name} "nginx -
+0000f430: 5622 272c 0a20 2020 2020 2020 2020 2020  V"',.           
+0000f440: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+0000f450: 657d 2031 202d 2d73 7461 7475 7327 2c0a  e} 1 --status',.
+0000f460: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000f470: 7920 6578 6563 207b 6e61 6d65 7d20 7768  y exec {name} wh
+0000f480: 6f61 6d69 207c 2067 7265 7020 726f 6f74  oami | grep root
+0000f490: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+0000f4a0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+0000f4b0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+0000f4c0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+0000f4d0: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+0000f4e0: 2d2d 2d2d 2d2d 2d2d 2053 7562 6d69 7474  -------- Submitt
+0000f4f0: 696e 6720 6d75 6c74 6970 6c65 2074 6173  ing multiple tas
+0000f500: 6b73 2074 6f20 7468 6520 7361 6d65 2063  ks to the same c
+0000f510: 6c75 7374 6572 2e20 2d2d 2d2d 2d2d 2d2d  luster. --------
+0000f520: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
+0000f530: 6e6f 5f66 6c75 6964 7374 6163 6b20 2023  no_fluidstack  #
+0000f540: 2046 6c75 6964 5374 6163 6b20 4443 2068   FluidStack DC h
+0000f550: 6173 206c 6f77 2061 7661 696c 6162 696c  as low availabil
+0000f560: 6974 7920 6f66 2054 3420 4750 5573 0a40  ity of T4 GPUs.@
+0000f570: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6c  pytest.mark.no_l
+0000f580: 616d 6264 615f 636c 6f75 6420 2023 204c  ambda_cloud  # L
+0000f590: 616d 6264 6120 436c 6f75 6420 646f 6573  ambda Cloud does
+0000f5a0: 206e 6f74 2068 6176 6520 5434 2067 7075   not have T4 gpu
+0000f5b0: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
+0000f5c0: 6f5f 7061 7065 7273 7061 6365 2020 2320  o_paperspace  # 
+0000f5d0: 5061 7065 7273 7061 6365 2064 6f65 7320  Paperspace does 
+0000f5e0: 6e6f 7420 6861 7665 2054 3420 6770 7573  not have T4 gpus
+0000f5f0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+0000f600: 5f69 626d 2020 2320 4942 4d20 436c 6f75  _ibm  # IBM Clou
+0000f610: 6420 646f 6573 206e 6f74 2068 6176 6520  d does not have 
+0000f620: 5434 2067 7075 730a 4070 7974 6573 742e  T4 gpus.@pytest.
+0000f630: 6d61 726b 2e6e 6f5f 7363 7020 2023 2053  mark.no_scp  # S
+0000f640: 4350 2064 6f65 7320 6e6f 7420 7375 7070  CP does not supp
+0000f650: 6f72 7420 6e75 6d5f 6e6f 6465 7320 3e20  ort num_nodes > 
+0000f660: 3120 7965 740a 4070 7974 6573 742e 6d61  1 yet.@pytest.ma
+0000f670: 726b 2e6e 6f5f 6f63 6920 2023 204f 4349  rk.no_oci  # OCI
+0000f680: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
+0000f690: 6861 7665 2054 3420 6770 7573 0a64 6566  have T4 gpus.def
+0000f6a0: 2074 6573 745f 6d75 6c74 695f 6563 686f   test_multi_echo
+0000f6b0: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
+0000f6c0: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
+0000f6d0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+0000f6e0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+0000f6f0: 5465 7374 280a 2020 2020 2020 2020 276d  Test(.        'm
+0000f700: 756c 7469 5f65 6368 6f27 2c0a 2020 2020  ulti_echo',.    
+0000f710: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+0000f720: 2020 6627 7079 7468 6f6e 2065 7861 6d70    f'python examp
+0000f730: 6c65 732f 6d75 6c74 695f 6563 686f 2e70  les/multi_echo.p
+0000f740: 7920 7b6e 616d 657d 207b 6765 6e65 7269  y {name} {generi
+0000f750: 635f 636c 6f75 647d 272c 0a20 2020 2020  c_cloud}',.     
+0000f760: 2020 2020 2020 2027 736c 6565 7020 3132         'sleep 12
+0000f770: 3027 2c0a 2020 2020 2020 2020 5d20 2b0a  0',.        ] +.
+0000f780: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
+0000f790: 206a 6f62 7320 7375 6363 6565 6465 642e   jobs succeeded.
+0000f7a0: 0a20 2020 2020 2020 205b 6627 736b 7920  .        [f'sky 
+0000f7b0: 6c6f 6773 207b 6e61 6d65 7d20 7b69 202b  logs {name} {i +
+0000f7c0: 2031 7d20 2d2d 7374 6174 7573 2720 666f   1} --status' fo
+0000f7d0: 7220 6920 696e 2072 616e 6765 2833 3229  r i in range(32)
+0000f7e0: 5d20 2b0a 2020 2020 2020 2020 2320 456e  ] +.        # En
+0000f7f0: 7375 7265 206d 6f6e 6974 6f72 2f61 7574  sure monitor/aut
+0000f800: 6f73 6361 6c65 7220 6469 646e 2774 2063  oscaler didn't c
+0000f810: 7261 7368 206f 6e20 7468 6520 2761 7373  rash on the 'ass
+0000f820: 6572 7420 6e6f 740a 2020 2020 2020 2020  ert not.        
+0000f830: 2320 756e 6675 6c66 696c 6c65 6427 2065  # unfulfilled' e
+0000f840: 7272 6f72 2e20 2049 6620 7072 6f63 6573  rror.  If proces
+0000f850: 7320 6e6f 7420 666f 756e 642c 2067 7265  s not found, gre
+0000f860: 702d 3e73 7368 2072 6574 7572 6e73 2031  p->ssh returns 1
+0000f870: 2e0a 2020 2020 2020 2020 5b66 2773 7368  ..        [f'ssh
+0000f880: 207b 6e61 6d65 7d20 5c27 7073 2061 7578   {name} \'ps aux
+0000f890: 207c 2067 7265 7020 225b 2f5d 226d 6f6e   | grep "[/]"mon
+0000f8a0: 6974 6f72 2e70 795c 2727 5d2c 0a20 2020  itor.py\''],.   
+0000f8b0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+0000f8c0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+0000f8d0: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
+0000f8e0: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+0000f8f0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0000f900: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
+0000f910: 2054 6173 6b3a 2031 206e 6f64 6520 7472   Task: 1 node tr
+0000f920: 6169 6e69 6e67 2e20 2d2d 2d2d 2d2d 2d2d  aining. --------
+0000f930: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
+0000f940: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
+0000f950: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
+0000f960: 646f 6573 206e 6f74 2068 6176 6520 5631  does not have V1
+0000f970: 3030 2067 7075 730a 4070 7974 6573 742e  00 gpus.@pytest.
+0000f980: 6d61 726b 2e6e 6f5f 6962 6d20 2023 2049  mark.no_ibm  # I
+0000f990: 424d 2063 6c6f 7564 2063 7572 7265 6e74  BM cloud current
+0000f9a0: 6c79 2064 6f65 736e 2774 2070 726f 7669  ly doesn't provi
+0000f9b0: 6465 2070 7562 6c69 6320 696d 6167 6520  de public image 
+0000f9c0: 7769 7468 2043 5544 410a 4070 7974 6573  with CUDA.@pytes
+0000f9d0: 742e 6d61 726b 2e6e 6f5f 7363 7020 2023  t.mark.no_scp  #
+0000f9e0: 2053 4350 2064 6f65 7320 6e6f 7420 6861   SCP does not ha
+0000f9f0: 7665 2056 3130 3020 2831 3647 4229 2047  ve V100 (16GB) G
+0000fa00: 5055 732e 2052 756e 2074 6573 745f 7363  PUs. Run test_sc
+0000fa10: 705f 6875 6767 696e 6766 6163 6520 696e  p_huggingface in
+0000fa20: 7374 6561 642e 0a64 6566 2074 6573 745f  stead..def test_
+0000fa30: 6875 6767 696e 6766 6163 6528 6765 6e65  huggingface(gene
+0000fa40: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
+0000fa50: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+0000fa60: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+0000fa70: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+0000fa80: 0a20 2020 2020 2020 2027 6875 6767 696e  .        'huggin
+0000fa90: 6766 6163 655f 676c 7565 5f69 6d64 625f  gface_glue_imdb_
+0000faa0: 6170 7027 2c0a 2020 2020 2020 2020 5b0a  app',.        [.
+0000fab0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000fac0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+0000fad0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+0000fae0: 656e 6572 6963 5f63 6c6f 7564 7d20 6578  eneric_cloud} ex
+0000faf0: 616d 706c 6573 2f68 7567 6769 6e67 6661  amples/huggingfa
+0000fb00: 6365 5f67 6c75 655f 696d 6462 5f61 7070  ce_glue_imdb_app
+0000fb10: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+0000fb20: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0000fb30: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+0000fb40: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+0000fb50: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+0000fb60: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000fb70: 7920 6578 6563 207b 6e61 6d65 7d20 6578  y exec {name} ex
+0000fb80: 616d 706c 6573 2f68 7567 6769 6e67 6661  amples/huggingfa
+0000fb90: 6365 5f67 6c75 655f 696d 6462 5f61 7070  ce_glue_imdb_app
+0000fba0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+0000fbb0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0000fbc0: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
+0000fbd0: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+0000fbe0: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+0000fbf0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+0000fc00: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+0000fc10: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
+0000fc20: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+0000fc30: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+0000fc40: 2e6d 6172 6b2e 6c61 6d62 6461 5f63 6c6f  .mark.lambda_clo
+0000fc50: 7564 0a64 6566 2074 6573 745f 6c61 6d62  ud.def test_lamb
+0000fc60: 6461 5f68 7567 6769 6e67 6661 6365 2867  da_huggingface(g
+0000fc70: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
+0000fc80: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
+0000fc90: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+0000fca0: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+0000fcb0: 7374 280a 2020 2020 2020 2020 276c 616d  st(.        'lam
+0000fcc0: 6264 615f 6875 6767 696e 6766 6163 655f  bda_huggingface_
+0000fcd0: 676c 7565 5f69 6d64 625f 6170 7027 2c0a  glue_imdb_app',.
+0000fce0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+0000fcf0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+0000fd00: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
+0000fd10: 7b4c 414d 4244 415f 5459 5045 7d20 6578  {LAMBDA_TYPE} ex
+0000fd20: 616d 706c 6573 2f68 7567 6769 6e67 6661  amples/huggingfa
+0000fd30: 6365 5f67 6c75 655f 696d 6462 5f61 7070  ce_glue_imdb_app
+0000fd40: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+0000fd50: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0000fd60: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+0000fd70: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+0000fd80: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+0000fd90: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000fda0: 7920 6578 6563 207b 6e61 6d65 7d20 7b4c  y exec {name} {L
+0000fdb0: 414d 4244 415f 5459 5045 7d20 6578 616d  AMBDA_TYPE} exam
+0000fdc0: 706c 6573 2f68 7567 6769 6e67 6661 6365  ples/huggingface
+0000fdd0: 5f67 6c75 655f 696d 6462 5f61 7070 2e79  _glue_imdb_app.y
+0000fde0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0000fdf0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+0000fe00: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
+0000fe10: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+0000fe20: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+0000fe30: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+0000fe40: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+0000fe50: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+0000fe60: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0000fe70: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+0000fe80: 6172 6b2e 7363 700a 6465 6620 7465 7374  ark.scp.def test
+0000fe90: 5f73 6370 5f68 7567 6769 6e67 6661 6365  _scp_huggingface
+0000fea0: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
+0000feb0: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
+0000fec0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+0000fed0: 6d65 2829 0a20 2020 206e 756d 5f6f 665f  me().    num_of_
+0000fee0: 6770 755f 6c61 756e 6368 203d 2031 0a20  gpu_launch = 1. 
+0000fef0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+0000ff00: 2020 2020 2020 2020 2753 4350 5f68 7567          'SCP_hug
+0000ff10: 6769 6e67 6661 6365 5f67 6c75 655f 696d  gingface_glue_im
+0000ff20: 6462 5f61 7070 272c 0a20 2020 2020 2020  db_app',.       
+0000ff30: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+0000ff40: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+0000ff50: 6320 7b6e 616d 657d 207b 5343 505f 5459  c {name} {SCP_TY
+0000ff60: 5045 7d20 7b53 4350 5f47 5055 5f56 3130  PE} {SCP_GPU_V10
+0000ff70: 307d 3a7b 6e75 6d5f 6f66 5f67 7075 5f6c  0}:{num_of_gpu_l
+0000ff80: 6175 6e63 687d 2065 7861 6d70 6c65 732f  aunch} examples/
+0000ff90: 6875 6767 696e 6766 6163 655f 676c 7565  huggingface_glue
+0000ffa0: 5f69 6d64 625f 6170 702e 7961 6d6c 272c  _imdb_app.yaml',
+0000ffb0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000ffc0: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+0000ffd0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+0000ffe0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+0000fff0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+00010000: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00010010: 7b6e 616d 657d 207b 5343 505f 5459 5045  {name} {SCP_TYPE
+00010020: 7d20 7b53 4350 5f47 5055 5f56 3130 307d  } {SCP_GPU_V100}
+00010030: 3a7b 6e75 6d5f 6f66 5f67 7075 5f6c 6175  :{num_of_gpu_lau
+00010040: 6e63 687d 2065 7861 6d70 6c65 732f 6875  nch} examples/hu
+00010050: 6767 696e 6766 6163 655f 676c 7565 5f69  ggingface_glue_i
+00010060: 6d64 625f 6170 702e 7961 6d6c 272c 0a20  mdb_app.yaml',. 
+00010070: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00010080: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
+00010090: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+000100a0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+000100b0: 6565 6465 642e 0a20 2020 2020 2020 205d  eeded..        ]
+000100c0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+000100d0: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+000100e0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+000100f0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00010100: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2049 6e66  # ---------- Inf
+00010110: 6572 656e 7469 612e 202d 2d2d 2d2d 2d2d  erentia. -------
+00010120: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
+00010130: 2e61 7773 0a64 6566 2074 6573 745f 696e  .aws.def test_in
+00010140: 6665 7265 6e74 6961 2829 3a0a 2020 2020  ferentia():.    
+00010150: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00010160: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+00010170: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00010180: 2020 2020 2774 6573 745f 696e 6665 7265      'test_infere
+00010190: 6e74 6961 272c 0a20 2020 2020 2020 205b  ntia',.        [
+000101a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000101b0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+000101c0: 7b6e 616d 657d 202d 7420 696e 6632 2e78  {name} -t inf2.x
+000101d0: 6c61 7267 6520 2d2d 2065 6368 6f20 6869  large -- echo hi
+000101e0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000101f0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00010200: 202d 2d67 7075 7320 496e 6665 7265 6e74   --gpus Inferent
+00010210: 6961 3a31 2065 6368 6f20 6869 272c 0a20  ia:1 echo hi',. 
+00010220: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00010230: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+00010240: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+00010250: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+00010260: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
+00010270: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00010280: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
+00010290: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+000102a0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+000102b0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+000102c0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+000102d0: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+000102e0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+000102f0: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+00010300: 2d2d 2d2d 2054 5055 2e20 2d2d 2d2d 2d2d  ---- TPU. ------
+00010310: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
+00010320: 6b2e 6763 700a 4070 7974 6573 742e 6d61  k.gcp.@pytest.ma
+00010330: 726b 2e74 7075 0a64 6566 2074 6573 745f  rk.tpu.def test_
+00010340: 7470 7528 293a 0a20 2020 206e 616d 6520  tpu():.    name 
+00010350: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00010360: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+00010370: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+00010380: 7470 755f 6170 7027 2c0a 2020 2020 2020  tpu_app',.      
+00010390: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+000103a0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+000103b0: 2d63 207b 6e61 6d65 7d20 6578 616d 706c  -c {name} exampl
+000103c0: 6573 2f74 7075 2f74 7075 5f61 7070 2e79  es/tpu/tpu_app.y
+000103d0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+000103e0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+000103f0: 6d65 7d20 3127 2c20 2023 2045 6e73 7572  me} 1',  # Ensur
+00010400: 6520 7468 6520 6a6f 6220 6669 6e69 7368  e the job finish
+00010410: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00010420: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00010430: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
+00010440: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+00010450: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+00010460: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+00010470: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+00010480: 7d20 6578 616d 706c 6573 2f74 7075 2f74  } examples/tpu/t
+00010490: 7075 5f61 7070 2e79 616d 6c20 7c20 6772  pu_app.yaml | gr
+000104a0: 6570 2022 5450 5520 2e2a 2061 6c72 6561  ep "TPU .* alrea
+000104b0: 6479 2065 7869 7374 7322 272c 2020 2320  dy exists"',  # 
+000104c0: 456e 7375 7265 2073 6b79 206c 6175 6e63  Ensure sky launc
+000104d0: 6820 776f 6e27 7420 6372 6561 7465 2061  h won't create a
+000104e0: 6e6f 7468 6572 2054 5055 2e0a 2020 2020  nother TPU..    
+000104f0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+00010500: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+00010510: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
+00010520: 6d65 6f75 743d 3330 202a 2036 302c 2020  meout=30 * 60,  
+00010530: 2320 6361 6e20 7461 6b65 203e 3230 206d  # can take >20 m
+00010540: 696e 730a 2020 2020 290a 2020 2020 7275  ins.    ).    ru
+00010550: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00010560: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
+00010570: 5450 5520 564d 2e20 2d2d 2d2d 2d2d 2d2d  TPU VM. --------
+00010580: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
+00010590: 6763 700a 4070 7974 6573 742e 6d61 726b  gcp.@pytest.mark
+000105a0: 2e74 7075 0a64 6566 2074 6573 745f 7470  .tpu.def test_tp
+000105b0: 755f 766d 2829 3a0a 2020 2020 6e61 6d65  u_vm():.    name
+000105c0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+000105d0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+000105e0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+000105f0: 2774 7075 5f76 6d5f 6170 7027 2c0a 2020  'tpu_vm_app',.  
+00010600: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00010610: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00010620: 202d 7920 2d63 207b 6e61 6d65 7d20 6578   -y -c {name} ex
+00010630: 616d 706c 6573 2f74 7075 2f74 7075 766d  amples/tpu/tpuvm
+00010640: 5f6d 6e69 7374 2e79 616d 6c27 2c0a 2020  _mnist.yaml',.  
+00010650: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00010660: 6c6f 6773 207b 6e61 6d65 7d20 3127 2c20  logs {name} 1', 
+00010670: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+00010680: 6220 6669 6e69 7368 6564 2e0a 2020 2020  b finished..    
+00010690: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+000106a0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+000106b0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+000106c0: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+000106d0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+000106e0: 6627 736b 7920 7374 6f70 202d 7920 7b6e  f'sky stop -y {n
+000106f0: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
+00010700: 2020 2066 2773 3d24 2873 6b79 2073 7461     f's=$(sky sta
+00010710: 7475 7320 7b6e 616d 657d 202d 2d72 6566  tus {name} --ref
+00010720: 7265 7368 293b 2065 6368 6f20 2224 7322  resh); echo "$s"
+00010730: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
+00010740: 686f 2022 2473 2220 207c 2067 7265 7020  ho "$s"  | grep 
+00010750: 7b6e 616d 657d 207c 2067 7265 7020 5354  {name} | grep ST
+00010760: 4f50 5045 4427 2c20 2023 2045 6e73 7572  OPPED',  # Ensur
+00010770: 6520 7468 6520 636c 7573 7465 7220 6973  e the cluster is
+00010780: 2053 544f 5050 4544 2e0a 2020 2020 2020   STOPPED..      
+00010790: 2020 2020 2020 2320 5573 6520 7265 7472        # Use retr
+000107a0: 793a 2067 7561 7264 2061 6761 696e 7374  y: guard against
+000107b0: 2074 7261 6e73 6965 6e74 2065 7272 6f72   transient error
+000107c0: 7320 6f62 7365 7276 6564 2066 6f72 0a20  s observed for. 
+000107d0: 2020 2020 2020 2020 2020 2023 206a 7573             # jus
+000107e0: 742d 7374 6f70 7065 6420 5450 5520 564d  t-stopped TPU VM
+000107f0: 7320 2823 3936 3229 2e0a 2020 2020 2020  s (#962)..      
+00010800: 2020 2020 2020 6627 736b 7920 7374 6172        f'sky star
+00010810: 7420 2d2d 7265 7472 792d 756e 7469 6c2d  t --retry-until-
+00010820: 7570 202d 7920 7b6e 616d 657d 272c 0a20  up -y {name}',. 
+00010830: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00010840: 2065 7865 6320 7b6e 616d 657d 2065 7861   exec {name} exa
+00010850: 6d70 6c65 732f 7470 752f 7470 7576 6d5f  mples/tpu/tpuvm_
+00010860: 6d6e 6973 742e 7961 6d6c 272c 0a20 2020  mnist.yaml',.   
+00010870: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00010880: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
+00010890: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+000108a0: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
+000108b0: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
+000108c0: 2066 2773 6b79 2073 746f 7020 2d79 207b   f'sky stop -y {
+000108d0: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
+000108e0: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+000108f0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+00010900: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+00010910: 743d 3330 202a 2036 302c 2020 2320 6361  t=30 * 60,  # ca
+00010920: 6e20 7461 6b65 2033 3020 6d69 6e73 0a20  n take 30 mins. 
+00010930: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00010940: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+00010950: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 5055 2056  ---------- TPU V
+00010960: 4d20 506f 642e 202d 2d2d 2d2d 2d2d 2d2d  M Pod. ---------
+00010970: 2d0a 4070 7974 6573 742e 6d61 726b 2e67  -.@pytest.mark.g
+00010980: 6370 0a40 7079 7465 7374 2e6d 6172 6b2e  cp.@pytest.mark.
+00010990: 7470 750a 6465 6620 7465 7374 5f74 7075  tpu.def test_tpu
+000109a0: 5f76 6d5f 706f 6428 293a 0a20 2020 206e  _vm_pod():.    n
+000109b0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+000109c0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+000109d0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+000109e0: 2020 2027 7470 755f 706f 6427 2c0a 2020     'tpu_pod',.  
+000109f0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00010a00: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00010a10: 202d 7920 2d63 207b 6e61 6d65 7d20 6578   -y -c {name} ex
+00010a20: 616d 706c 6573 2f74 7075 2f74 7075 766d  amples/tpu/tpuvm
+00010a30: 5f6d 6e69 7374 2e79 616d 6c20 2d2d 6770  _mnist.yaml --gp
+00010a40: 7573 2074 7075 2d76 322d 3332 202d 2d75  us tpu-v2-32 --u
+00010a50: 7365 2d73 706f 7420 2d2d 7a6f 6e65 2065  se-spot --zone e
+00010a60: 7572 6f70 652d 7765 7374 342d 6127 2c0a  urope-west4-a',.
+00010a70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00010a80: 7920 6c6f 6773 207b 6e61 6d65 7d20 3127  y logs {name} 1'
+00010a90: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+00010aa0: 6a6f 6220 6669 6e69 7368 6564 2e0a 2020  job finished..  
+00010ab0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00010ac0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+00010ad0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+00010ae0: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
+00010af0: 6564 6564 2e0a 2020 2020 2020 2020 5d2c  eded..        ],
+00010b00: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+00010b10: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+00010b20: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00010b30: 3330 202a 2036 302c 2020 2320 6361 6e20  30 * 60,  # can 
+00010b40: 7461 6b65 2033 3020 6d69 6e73 0a20 2020  take 30 mins.   
+00010b50: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00010b60: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+00010b70: 2d2d 2d2d 2d2d 2d2d 2053 696d 706c 6520  -------- Simple 
+00010b80: 6170 7073 2e20 2d2d 2d2d 2d2d 2d2d 2d2d  apps. ----------
+00010b90: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00010ba0: 5f73 6370 2020 2320 5343 5020 646f 6573  _scp  # SCP does
+00010bb0: 206e 6f74 2073 7570 706f 7274 206e 756d   not support num
+00010bc0: 5f6e 6f64 6573 203e 2031 2079 6574 0a64  _nodes > 1 yet.d
+00010bd0: 6566 2074 6573 745f 6d75 6c74 695f 686f  ef test_multi_ho
+00010be0: 7374 6e61 6d65 2867 656e 6572 6963 5f63  stname(generic_c
+00010bf0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+00010c00: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00010c10: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+00010c20: 6f74 616c 5f74 696d 656f 7574 5f6d 696e  otal_timeout_min
+00010c30: 7574 6573 203d 2032 3520 6966 2067 656e  utes = 25 if gen
+00010c40: 6572 6963 5f63 6c6f 7564 203d 3d20 2761  eric_cloud == 'a
+00010c50: 7a75 7265 2720 656c 7365 2031 350a 2020  zure' else 15.  
+00010c60: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00010c70: 2020 2020 2020 2027 6d75 6c74 695f 686f         'multi_ho
+00010c80: 7374 6e61 6d65 272c 0a20 2020 2020 2020  stname',.       
+00010c90: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00010ca0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00010cb0: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+00010cc0: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
+00010cd0: 2065 7861 6d70 6c65 732f 6d75 6c74 695f   examples/multi_
+00010ce0: 686f 7374 6e61 6d65 2e79 616d 6c27 2c0a  hostname.yaml',.
+00010cf0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00010d00: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+00010d10: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
+00010d20: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
+00010d30: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+00010d40: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00010d50: 6e61 6d65 7d20 3120 7c20 6772 6570 2022  name} 1 | grep "
+00010d60: 4d79 2068 6f73 746e 616d 653a 2220 7c20  My hostname:" | 
+00010d70: 7763 202d 6c20 7c20 6772 6570 2032 272c  wc -l | grep 2',
+00010d80: 2020 2320 456e 7375 7265 2074 6865 7265    # Ensure there
+00010d90: 2061 7265 2032 2068 6f73 7473 2e0a 2020   are 2 hosts..  
+00010da0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00010db0: 6578 6563 207b 6e61 6d65 7d20 6578 616d  exec {name} exam
+00010dc0: 706c 6573 2f6d 756c 7469 5f68 6f73 746e  ples/multi_hostn
+00010dd0: 616d 652e 7961 6d6c 272c 0a20 2020 2020  ame.yaml',.     
+00010de0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00010df0: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
+00010e00: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+00010e10: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+00010e20: 642e 0a20 2020 2020 2020 205d 2c0a 2020  d..        ],.  
+00010e30: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00010e40: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00010e50: 2020 2020 2074 696d 656f 7574 3d5f 6765       timeout=_ge
+00010e60: 745f 7469 6d65 6f75 7428 6765 6e65 7269  t_timeout(generi
+00010e70: 635f 636c 6f75 642c 2074 6f74 616c 5f74  c_cloud, total_t
+00010e80: 696d 656f 7574 5f6d 696e 7574 6573 202a  imeout_minutes *
+00010e90: 2036 3029 2c0a 2020 2020 290a 2020 2020   60),.    ).    
+00010ea0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00010eb0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00010ec0: 6b2e 6e6f 5f73 6370 2020 2320 5343 5020  k.no_scp  # SCP 
+00010ed0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+00010ee0: 206e 756d 5f6e 6f64 6573 203e 2031 2079   num_nodes > 1 y
+00010ef0: 6574 0a64 6566 2074 6573 745f 6d75 6c74  et.def test_mult
+00010f00: 695f 6e6f 6465 5f66 6169 6c75 7265 2867  i_node_failure(g
+00010f10: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
+00010f20: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
+00010f30: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+00010f40: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+00010f50: 7374 280a 2020 2020 2020 2020 276d 756c  st(.        'mul
+00010f60: 7469 5f6e 6f64 655f 6661 696c 7572 6527  ti_node_failure'
+00010f70: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00010f80: 2020 2020 2020 2020 2320 544f 444f 287a          # TODO(z
+00010f90: 6877 7529 3a20 7765 2075 7365 206d 756c  hwu): we use mul
+00010fa0: 7469 2d74 6872 6561 6420 746f 2072 756e  ti-thread to run
+00010fb0: 2074 6865 2063 6f6d 6d61 6e64 7320 696e   the commands in
+00010fc0: 2073 6574 7570 0a20 2020 2020 2020 2020   setup.         
+00010fd0: 2020 2023 2063 6f6d 6d61 6e64 7320 696e     # commands in
+00010fe0: 2070 6172 616c 6c65 6c2c 2077 6869 6368   parallel, which
+00010ff0: 206d 616b 6573 2069 7420 696d 706f 7373   makes it imposs
+00011000: 6962 6c65 2074 6f20 6661 696c 2066 6173  ible to fail fas
+00011010: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
+00011020: 7768 656e 206f 6e65 206f 6620 7468 6520  when one of the 
+00011030: 6e6f 6465 7320 6661 696c 732e 2057 6520  nodes fails. We 
+00011040: 7368 6f75 6c64 2066 6978 2074 6869 7320  should fix this 
+00011050: 696e 2074 6865 2066 7574 7572 652e 0a20  in the future.. 
+00011060: 2020 2020 2020 2020 2020 2023 2054 6865             # The
+00011070: 202d 2d64 6574 6163 682d 7365 7475 7020   --detach-setup 
+00011080: 7665 7273 696f 6e20 6361 6e20 6661 696c  version can fail
+00011090: 2066 6173 742c 2061 7320 7468 6520 7365   fast, as the se
+000110a0: 7475 7020 6973 0a20 2020 2020 2020 2020  tup is.         
+000110b0: 2020 2023 2073 7562 6d69 7474 6564 2074     # submitted t
+000110c0: 6f20 7468 6520 7265 6d6f 7465 206d 6163  o the remote mac
+000110d0: 6869 6e65 2c20 7768 6963 6820 646f 6573  hine, which does
+000110e0: 206e 6f74 2075 7365 206d 756c 7469 2d74   not use multi-t
+000110f0: 6872 6561 642e 0a20 2020 2020 2020 2020  hread..         
+00011100: 2020 2023 2052 6566 6572 2074 6f20 7468     # Refer to th
+00011110: 6520 636f 6d6d 656e 7420 696e 2060 7375  e comment in `su
+00011120: 6270 726f 6365 7373 5f75 7469 6c73 2e72  bprocess_utils.r
+00011130: 756e 5f69 6e5f 7061 7261 6c6c 656c 602e  un_in_parallel`.
+00011140: 0a20 2020 2020 2020 2020 2020 2023 2066  .            # f
+00011150: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00011160: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+00011170: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
+00011180: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+00011190: 732f 6661 696c 6564 5f77 6f72 6b65 725f  s/failed_worker_
+000111a0: 7365 7475 702e 7961 6d6c 2026 2620 6578  setup.yaml && ex
+000111b0: 6974 2031 272c 2020 2320 456e 7375 7265  it 1',  # Ensure
+000111c0: 2074 6865 206a 6f62 2073 6574 7570 2066   the job setup f
+000111d0: 6169 6c65 642e 0a20 2020 2020 2020 2020  ailed..         
+000111e0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+000111f0: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
+00011200: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+00011210: 6f75 647d 202d 2d64 6574 6163 682d 7365  oud} --detach-se
+00011220: 7475 7020 7465 7374 732f 7465 7374 5f79  tup tests/test_y
+00011230: 616d 6c73 2f66 6169 6c65 645f 776f 726b  amls/failed_work
+00011240: 6572 5f73 6574 7570 2e79 616d 6c27 2c0a  er_setup.yaml',.
+00011250: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00011260: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+00011270: 2d2d 7374 6174 7573 207c 2067 7265 7020  --status | grep 
+00011280: 4641 494c 4544 5f53 4554 5550 272c 2020  FAILED_SETUP',  
+00011290: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+000112a0: 2073 6574 7570 2066 6169 6c65 642e 0a20   setup failed.. 
+000112b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000112c0: 2065 7865 6320 7b6e 616d 657d 2074 6573   exec {name} tes
+000112d0: 7473 2f74 6573 745f 7961 6d6c 732f 6661  ts/test_yamls/fa
+000112e0: 696c 6564 5f77 6f72 6b65 725f 7275 6e2e  iled_worker_run.
+000112f0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00011300: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00011310: 616d 657d 2032 202d 2d73 7461 7475 7320  ame} 2 --status 
+00011320: 7c20 6772 6570 2046 4149 4c45 4427 2c20  | grep FAILED', 
+00011330: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+00011340: 6220 6661 696c 6564 2e0a 2020 2020 2020  b failed..      
+00011350: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00011360: 207b 6e61 6d65 7d20 3220 7c20 6772 6570   {name} 2 | grep
+00011370: 2022 4d79 2068 6f73 746e 616d 653a 2220   "My hostname:" 
+00011380: 7c20 7763 202d 6c20 7c20 6772 6570 2032  | wc -l | grep 2
+00011390: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+000113a0: 7265 2032 206f 6620 7468 6520 686f 7374  re 2 of the host
+000113b0: 7320 7072 696e 7465 6420 7468 6569 7220  s printed their 
+000113c0: 686f 7374 6e61 6d65 2e0a 2020 2020 2020  hostname..      
+000113d0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+000113e0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+000113f0: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
+00011400: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00011410: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
+00011420: 5765 6220 6170 7073 2077 6974 6820 6375  Web apps with cu
+00011430: 7374 6f6d 2070 6f72 7473 206f 6e20 4743  stom ports on GC
+00011440: 502e 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  P. ----------.@p
+00011450: 7974 6573 742e 6d61 726b 2e67 6370 0a64  ytest.mark.gcp.d
+00011460: 6566 2074 6573 745f 6763 705f 6874 7470  ef test_gcp_http
+00011470: 5f73 6572 7665 725f 7769 7468 5f63 7573  _server_with_cus
+00011480: 746f 6d5f 706f 7274 7328 293a 0a20 2020  tom_ports():.   
+00011490: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+000114a0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+000114b0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+000114c0: 2020 2020 2027 6763 705f 6874 7470 5f73       'gcp_http_s
+000114d0: 6572 7665 725f 7769 7468 5f63 7573 746f  erver_with_custo
+000114e0: 6d5f 706f 7274 7327 2c0a 2020 2020 2020  m_ports',.      
+000114f0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00011500: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00011510: 2d64 202d 6320 7b6e 616d 657d 202d 2d63  -d -c {name} --c
+00011520: 6c6f 7564 2067 6370 2065 7861 6d70 6c65  loud gcp example
+00011530: 732f 6874 7470 5f73 6572 7665 725f 7769  s/http_server_wi
+00011540: 7468 5f63 7573 746f 6d5f 706f 7274 732f  th_custom_ports/
+00011550: 7461 736b 2e79 616d 6c27 2c0a 2020 2020  task.yaml',.    
+00011560: 2020 2020 2020 2020 6627 756e 7469 6c20          f'until 
+00011570: 534b 5950 494c 4f54 5f44 4542 5547 3d30  SKYPILOT_DEBUG=0
+00011580: 2073 6b79 2073 7461 7475 7320 2d2d 656e   sky status --en
+00011590: 6470 6f69 6e74 2033 3338 3238 207b 6e61  dpoint 33828 {na
+000115a0: 6d65 7d3b 2064 6f20 736c 6565 7020 3130  me}; do sleep 10
+000115b0: 3b20 646f 6e65 272c 0a20 2020 2020 2020  ; done',.       
+000115c0: 2020 2020 2023 2052 6574 7279 2061 2066       # Retry a f
+000115d0: 6577 2074 696d 6573 2074 6f20 6176 6f69  ew times to avoi
+000115e0: 6420 666c 616b 696e 6573 7320 696e 2070  d flakiness in p
+000115f0: 6f72 7473 2062 6569 6e67 206f 7065 6e2e  orts being open.
+00011600: 0a20 2020 2020 2020 2020 2020 2066 2769  .            f'i
+00011610: 703d 2428 534b 5950 494c 4f54 5f44 4542  p=$(SKYPILOT_DEB
+00011620: 5547 3d30 2073 6b79 2073 7461 7475 7320  UG=0 sky status 
+00011630: 2d2d 656e 6470 6f69 6e74 2033 3338 3238  --endpoint 33828
+00011640: 207b 6e61 6d65 7d29 3b20 7375 6363 6573   {name}); succes
+00011650: 733d 6661 6c73 653b 2066 6f72 2069 2069  s=false; for i i
+00011660: 6e20 2428 7365 7120 3120 3529 3b20 646f  n $(seq 1 5); do
+00011670: 2069 6620 6375 726c 2024 6970 207c 2067   if curl $ip | g
+00011680: 7265 7020 223c 6831 3e54 6869 7320 6973  rep "<h1>This is
+00011690: 2061 2064 656d 6f20 4854 4d4c 2070 6167   a demo HTML pag
+000116a0: 652e 3c2f 6831 3e22 3b20 7468 656e 2073  e.</h1>"; then s
+000116b0: 7563 6365 7373 3d74 7275 653b 2062 7265  uccess=true; bre
+000116c0: 616b 3b20 6669 3b20 736c 6565 7020 3130  ak; fi; sleep 10
+000116d0: 3b20 646f 6e65 3b20 6966 205b 2022 2473  ; done; if [ "$s
+000116e0: 7563 6365 7373 2220 3d20 6661 6c73 6520  uccess" = false 
+000116f0: 5d3b 2074 6865 6e20 6578 6974 2031 3b20  ]; then exit 1; 
+00011700: 6669 272c 0a20 2020 2020 2020 205d 2c0a  fi',.        ],.
+00011710: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+00011720: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+00011730: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00011740: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+00011750: 2d2d 2d2d 2d2d 2d2d 2d2d 2057 6562 2061  ---------- Web a
+00011760: 7070 7320 7769 7468 2063 7573 746f 6d20  pps with custom 
+00011770: 706f 7274 7320 6f6e 2041 5753 2e20 2d2d  ports on AWS. --
+00011780: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
+00011790: 2e6d 6172 6b2e 6177 730a 6465 6620 7465  .mark.aws.def te
+000117a0: 7374 5f61 7773 5f68 7474 705f 7365 7276  st_aws_http_serv
+000117b0: 6572 5f77 6974 685f 6375 7374 6f6d 5f70  er_with_custom_p
+000117c0: 6f72 7473 2829 3a0a 2020 2020 6e61 6d65  orts():.    name
+000117d0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+000117e0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+000117f0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00011800: 2761 7773 5f68 7474 705f 7365 7276 6572  'aws_http_server
+00011810: 5f77 6974 685f 6375 7374 6f6d 5f70 6f72  _with_custom_por
+00011820: 7473 272c 0a20 2020 2020 2020 205b 0a20  ts',.        [. 
+00011830: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00011840: 206c 6175 6e63 6820 2d79 202d 6420 2d63   launch -y -d -c
+00011850: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00011860: 6177 7320 6578 616d 706c 6573 2f68 7474  aws examples/htt
+00011870: 705f 7365 7276 6572 5f77 6974 685f 6375  p_server_with_cu
+00011880: 7374 6f6d 5f70 6f72 7473 2f74 6173 6b2e  stom_ports/task.
+00011890: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+000118a0: 2020 2066 2775 6e74 696c 2053 4b59 5049     f'until SKYPI
+000118b0: 4c4f 545f 4445 4255 473d 3020 736b 7920  LOT_DEBUG=0 sky 
+000118c0: 7374 6174 7573 202d 2d65 6e64 706f 696e  status --endpoin
+000118d0: 7420 3333 3832 3820 7b6e 616d 657d 3b20  t 33828 {name}; 
+000118e0: 646f 2073 6c65 6570 2031 303b 2064 6f6e  do sleep 10; don
+000118f0: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
+00011900: 2320 5265 7472 7920 6120 6665 7720 7469  # Retry a few ti
+00011910: 6d65 7320 746f 2061 766f 6964 2066 6c61  mes to avoid fla
+00011920: 6b69 6e65 7373 2069 6e20 706f 7274 7320  kiness in ports 
+00011930: 6265 696e 6720 6f70 656e 2e0a 2020 2020  being open..    
+00011940: 2020 2020 2020 2020 6627 6970 3d24 2853          f'ip=$(S
+00011950: 4b59 5049 4c4f 545f 4445 4255 473d 3020  KYPILOT_DEBUG=0 
+00011960: 736b 7920 7374 6174 7573 202d 2d65 6e64  sky status --end
+00011970: 706f 696e 7420 3333 3832 3820 7b6e 616d  point 33828 {nam
+00011980: 657d 293b 2073 7563 6365 7373 3d66 616c  e}); success=fal
+00011990: 7365 3b20 666f 7220 6920 696e 2024 2873  se; for i in $(s
+000119a0: 6571 2031 2035 293b 2064 6f20 6966 2063  eq 1 5); do if c
+000119b0: 7572 6c20 2469 7020 7c20 6772 6570 2022  url $ip | grep "
+000119c0: 3c68 313e 5468 6973 2069 7320 6120 6465  <h1>This is a de
+000119d0: 6d6f 2048 544d 4c20 7061 6765 2e3c 2f68  mo HTML page.</h
+000119e0: 313e 223b 2074 6865 6e20 7375 6363 6573  1>"; then succes
+000119f0: 733d 7472 7565 3b20 6272 6561 6b3b 2066  s=true; break; f
+00011a00: 693b 2073 6c65 6570 2031 303b 2064 6f6e  i; sleep 10; don
+00011a10: 653b 2069 6620 5b20 2224 7375 6363 6573  e; if [ "$succes
+00011a20: 7322 203d 2066 616c 7365 205d 3b20 7468  s" = false ]; th
+00011a30: 656e 2065 7869 7420 313b 2066 6927 0a20  en exit 1; fi'. 
+00011a40: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00011a50: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00011a60: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00011a70: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00011a80: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+00011a90: 2d2d 2d2d 2057 6562 2061 7070 7320 7769  ---- Web apps wi
+00011aa0: 7468 2063 7573 746f 6d20 706f 7274 7320  th custom ports 
+00011ab0: 6f6e 2041 7a75 7265 2e20 2d2d 2d2d 2d2d  on Azure. ------
+00011ac0: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
+00011ad0: 6b2e 617a 7572 650a 6465 6620 7465 7374  k.azure.def test
+00011ae0: 5f61 7a75 7265 5f68 7474 705f 7365 7276  _azure_http_serv
+00011af0: 6572 5f77 6974 685f 6375 7374 6f6d 5f70  er_with_custom_p
+00011b00: 6f72 7473 2829 3a0a 2020 2020 6e61 6d65  orts():.    name
+00011b10: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00011b20: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+00011b30: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00011b40: 2761 7a75 7265 5f68 7474 705f 7365 7276  'azure_http_serv
+00011b50: 6572 5f77 6974 685f 6375 7374 6f6d 5f70  er_with_custom_p
+00011b60: 6f72 7473 272c 0a20 2020 2020 2020 205b  orts',.        [
+00011b70: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00011b80: 6b79 206c 6175 6e63 6820 2d79 202d 6420  ky launch -y -d 
+00011b90: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
+00011ba0: 6420 617a 7572 6520 6578 616d 706c 6573  d azure examples
+00011bb0: 2f68 7474 705f 7365 7276 6572 5f77 6974  /http_server_wit
+00011bc0: 685f 6375 7374 6f6d 5f70 6f72 7473 2f74  h_custom_ports/t
+00011bd0: 6173 6b2e 7961 6d6c 272c 0a20 2020 2020  ask.yaml',.     
+00011be0: 2020 2020 2020 2066 2775 6e74 696c 2053         f'until S
+00011bf0: 4b59 5049 4c4f 545f 4445 4255 473d 3020  KYPILOT_DEBUG=0 
+00011c00: 736b 7920 7374 6174 7573 202d 2d65 6e64  sky status --end
+00011c10: 706f 696e 7420 3333 3832 3820 7b6e 616d  point 33828 {nam
+00011c20: 657d 3b20 646f 2073 6c65 6570 2031 303b  e}; do sleep 10;
+00011c30: 2064 6f6e 6527 2c0a 2020 2020 2020 2020   done',.        
+00011c40: 2020 2020 2320 5265 7472 7920 6120 6665      # Retry a fe
+00011c50: 7720 7469 6d65 7320 746f 2061 766f 6964  w times to avoid
+00011c60: 2066 6c61 6b69 6e65 7373 2069 6e20 706f   flakiness in po
+00011c70: 7274 7320 6265 696e 6720 6f70 656e 2e0a  rts being open..
+00011c80: 2020 2020 2020 2020 2020 2020 6627 6970              f'ip
+00011c90: 3d24 2853 4b59 5049 4c4f 545f 4445 4255  =$(SKYPILOT_DEBU
+00011ca0: 473d 3020 736b 7920 7374 6174 7573 202d  G=0 sky status -
+00011cb0: 2d65 6e64 706f 696e 7420 3333 3832 3820  -endpoint 33828 
+00011cc0: 7b6e 616d 657d 293b 2073 7563 6365 7373  {name}); success
+00011cd0: 3d66 616c 7365 3b20 666f 7220 6920 696e  =false; for i in
+00011ce0: 2024 2873 6571 2031 2035 293b 2064 6f20   $(seq 1 5); do 
+00011cf0: 6966 2063 7572 6c20 2469 7020 7c20 6772  if curl $ip | gr
+00011d00: 6570 2022 3c68 313e 5468 6973 2069 7320  ep "<h1>This is 
+00011d10: 6120 6465 6d6f 2048 544d 4c20 7061 6765  a demo HTML page
+00011d20: 2e3c 2f68 313e 223b 2074 6865 6e20 7375  .</h1>"; then su
+00011d30: 6363 6573 733d 7472 7565 3b20 6272 6561  ccess=true; brea
+00011d40: 6b3b 2066 693b 2073 6c65 6570 2031 303b  k; fi; sleep 10;
+00011d50: 2064 6f6e 653b 2069 6620 5b20 2224 7375   done; if [ "$su
+00011d60: 6363 6573 7322 203d 2066 616c 7365 205d  ccess" = false ]
+00011d70: 3b20 7468 656e 2065 7869 7420 313b 2066  ; then exit 1; f
+00011d80: 6927 0a20 2020 2020 2020 205d 2c0a 2020  i'.        ],.  
+00011d90: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00011da0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00011db0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00011dc0: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+00011dd0: 2d2d 2d2d 2d2d 2d2d 2057 6562 2061 7070  -------- Web app
+00011de0: 7320 7769 7468 2063 7573 746f 6d20 706f  s with custom po
+00011df0: 7274 7320 6f6e 204b 7562 6572 6e65 7465  rts on Kubernete
+00011e00: 732e 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  s. ----------.@p
+00011e10: 7974 6573 742e 6d61 726b 2e6b 7562 6572  ytest.mark.kuber
+00011e20: 6e65 7465 730a 6465 6620 7465 7374 5f6b  netes.def test_k
+00011e30: 7562 6572 6e65 7465 735f 6874 7470 5f73  ubernetes_http_s
+00011e40: 6572 7665 725f 7769 7468 5f63 7573 746f  erver_with_custo
+00011e50: 6d5f 706f 7274 7328 293a 0a20 2020 206e  m_ports():.    n
+00011e60: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00011e70: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+00011e80: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00011e90: 2020 2027 6b75 6265 726e 6574 6573 5f68     'kubernetes_h
+00011ea0: 7474 705f 7365 7276 6572 5f77 6974 685f  ttp_server_with_
+00011eb0: 6375 7374 6f6d 5f70 6f72 7473 272c 0a20  custom_ports',. 
+00011ec0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00011ed0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00011ee0: 6820 2d79 202d 6420 2d63 207b 6e61 6d65  h -y -d -c {name
+00011ef0: 7d20 2d2d 636c 6f75 6420 6b75 6265 726e  } --cloud kubern
+00011f00: 6574 6573 2065 7861 6d70 6c65 732f 6874  etes examples/ht
+00011f10: 7470 5f73 6572 7665 725f 7769 7468 5f63  tp_server_with_c
+00011f20: 7573 746f 6d5f 706f 7274 732f 7461 736b  ustom_ports/task
+00011f30: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00011f40: 2020 2020 6627 756e 7469 6c20 534b 5950      f'until SKYP
+00011f50: 494c 4f54 5f44 4542 5547 3d30 2073 6b79  ILOT_DEBUG=0 sky
+00011f60: 2073 7461 7475 7320 2d2d 656e 6470 6f69   status --endpoi
+00011f70: 6e74 2033 3338 3238 207b 6e61 6d65 7d3b  nt 33828 {name};
+00011f80: 2064 6f20 736c 6565 7020 3130 3b20 646f   do sleep 10; do
+00011f90: 6e65 272c 0a20 2020 2020 2020 2020 2020  ne',.           
+00011fa0: 2023 2052 6574 7279 2061 2066 6577 2074   # Retry a few t
+00011fb0: 696d 6573 2074 6f20 6176 6f69 6420 666c  imes to avoid fl
+00011fc0: 616b 696e 6573 7320 696e 2070 6f72 7473  akiness in ports
+00011fd0: 2062 6569 6e67 206f 7065 6e2e 0a20 2020   being open..   
+00011fe0: 2020 2020 2020 2020 2066 2769 703d 2428           f'ip=$(
+00011ff0: 534b 5950 494c 4f54 5f44 4542 5547 3d30  SKYPILOT_DEBUG=0
+00012000: 2073 6b79 2073 7461 7475 7320 2d2d 656e   sky status --en
+00012010: 6470 6f69 6e74 2033 3338 3238 207b 6e61  dpoint 33828 {na
+00012020: 6d65 7d29 3b20 7375 6363 6573 733d 6661  me}); success=fa
+00012030: 6c73 653b 2066 6f72 2069 2069 6e20 2428  lse; for i in $(
+00012040: 7365 7120 3120 3130 3029 3b20 646f 2069  seq 1 100); do i
+00012050: 6620 6375 726c 2024 6970 207c 2067 7265  f curl $ip | gre
+00012060: 7020 223c 6831 3e54 6869 7320 6973 2061  p "<h1>This is a
+00012070: 2064 656d 6f20 4854 4d4c 2070 6167 652e   demo HTML page.
+00012080: 3c2f 6831 3e22 3b20 7468 656e 2073 7563  </h1>"; then suc
+00012090: 6365 7373 3d74 7275 653b 2062 7265 616b  cess=true; break
+000120a0: 3b20 6669 3b20 736c 6565 7020 353b 2064  ; fi; sleep 5; d
+000120b0: 6f6e 653b 2069 6620 5b20 2224 7375 6363  one; if [ "$succ
+000120c0: 6573 7322 203d 2066 616c 7365 205d 3b20  ess" = false ]; 
+000120d0: 7468 656e 2065 7869 7420 313b 2066 6927  then exit 1; fi'
+000120e0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+000120f0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00012100: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
+00012110: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00012120: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+00012130: 2d2d 2d2d 2d2d 2057 6562 2061 7070 7320  ------ Web apps 
+00012140: 7769 7468 2063 7573 746f 6d20 706f 7274  with custom port
+00012150: 7320 6f6e 2050 6170 6572 7370 6163 652e  s on Paperspace.
+00012160: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
+00012170: 6573 742e 6d61 726b 2e70 6170 6572 7370  est.mark.papersp
+00012180: 6163 650a 6465 6620 7465 7374 5f70 6170  ace.def test_pap
+00012190: 6572 7370 6163 655f 6874 7470 5f73 6572  erspace_http_ser
+000121a0: 7665 725f 7769 7468 5f63 7573 746f 6d5f  ver_with_custom_
+000121b0: 706f 7274 7328 293a 0a20 2020 206e 616d  ports():.    nam
+000121c0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+000121d0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+000121e0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+000121f0: 2027 7061 7065 7273 7061 6365 5f68 7474   'paperspace_htt
+00012200: 705f 7365 7276 6572 5f77 6974 685f 6375  p_server_with_cu
+00012210: 7374 6f6d 5f70 6f72 7473 272c 0a20 2020  stom_ports',.   
+00012220: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00012230: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00012240: 2d79 202d 6420 2d63 207b 6e61 6d65 7d20  -y -d -c {name} 
+00012250: 2d2d 636c 6f75 6420 7061 7065 7273 7061  --cloud paperspa
+00012260: 6365 2065 7861 6d70 6c65 732f 6874 7470  ce examples/http
+00012270: 5f73 6572 7665 725f 7769 7468 5f63 7573  _server_with_cus
+00012280: 746f 6d5f 706f 7274 732f 7461 736b 2e79  tom_ports/task.y
+00012290: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+000122a0: 2020 6627 756e 7469 6c20 534b 5950 494c    f'until SKYPIL
+000122b0: 4f54 5f44 4542 5547 3d30 2073 6b79 2073  OT_DEBUG=0 sky s
+000122c0: 7461 7475 7320 2d2d 656e 6470 6f69 6e74  tatus --endpoint
+000122d0: 2033 3338 3238 207b 6e61 6d65 7d3b 2064   33828 {name}; d
+000122e0: 6f20 736c 6565 7020 3130 3b20 646f 6e65  o sleep 10; done
+000122f0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+00012300: 2052 6574 7279 2061 2066 6577 2074 696d   Retry a few tim
+00012310: 6573 2074 6f20 6176 6f69 6420 666c 616b  es to avoid flak
+00012320: 696e 6573 7320 696e 2070 6f72 7473 2062  iness in ports b
+00012330: 6569 6e67 206f 7065 6e2e 0a20 2020 2020  eing open..     
+00012340: 2020 2020 2020 2066 2769 703d 2428 534b         f'ip=$(SK
+00012350: 5950 494c 4f54 5f44 4542 5547 3d30 2073  YPILOT_DEBUG=0 s
+00012360: 6b79 2073 7461 7475 7320 2d2d 656e 6470  ky status --endp
+00012370: 6f69 6e74 2033 3338 3238 207b 6e61 6d65  oint 33828 {name
+00012380: 7d29 3b20 7375 6363 6573 733d 6661 6c73  }); success=fals
+00012390: 653b 2066 6f72 2069 2069 6e20 2428 7365  e; for i in $(se
+000123a0: 7120 3120 3529 3b20 646f 2069 6620 6375  q 1 5); do if cu
+000123b0: 726c 2024 6970 207c 2067 7265 7020 223c  rl $ip | grep "<
+000123c0: 6831 3e54 6869 7320 6973 2061 2064 656d  h1>This is a dem
+000123d0: 6f20 4854 4d4c 2070 6167 652e 3c2f 6831  o HTML page.</h1
+000123e0: 3e22 3b20 7468 656e 2073 7563 6365 7373  >"; then success
+000123f0: 3d74 7275 653b 2062 7265 616b 3b20 6669  =true; break; fi
+00012400: 3b20 736c 6565 7020 3130 3b20 646f 6e65  ; sleep 10; done
+00012410: 3b20 6966 205b 2022 2473 7563 6365 7373  ; if [ "$success
+00012420: 2220 3d20 6661 6c73 6520 5d3b 2074 6865  " = false ]; the
+00012430: 6e20 6578 6974 2031 3b20 6669 272c 0a20  n exit 1; fi',. 
+00012440: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00012450: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00012460: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00012470: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00012480: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+00012490: 2d2d 2d2d 204c 6162 656c 7320 6672 6f6d  ---- Labels from
+000124a0: 2074 6173 6b20 6f6e 2041 5753 2028 696e   task on AWS (in
+000124b0: 7374 616e 6365 5f74 6167 7329 202d 2d2d  stance_tags) ---
+000124c0: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
+000124d0: 6d61 726b 2e61 7773 0a64 6566 2074 6573  mark.aws.def tes
+000124e0: 745f 7461 736b 5f6c 6162 656c 735f 6177  t_task_labels_aw
+000124f0: 7328 293a 0a20 2020 206e 616d 6520 3d20  s():.    name = 
+00012500: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00012510: 6528 290a 2020 2020 7465 6d70 6c61 7465  e().    template
+00012520: 5f73 7472 203d 2070 6174 686c 6962 2e50  _str = pathlib.P
+00012530: 6174 6828 0a20 2020 2020 2020 2027 7465  ath(.        'te
+00012540: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
+00012550: 6573 745f 6c61 6265 6c73 2e79 616d 6c2e  est_labels.yaml.
+00012560: 6a32 2729 2e72 6561 645f 7465 7874 2829  j2').read_text()
+00012570: 0a20 2020 2074 656d 706c 6174 6520 3d20  .    template = 
+00012580: 6a69 6e6a 6132 2e54 656d 706c 6174 6528  jinja2.Template(
+00012590: 7465 6d70 6c61 7465 5f73 7472 290a 2020  template_str).  
+000125a0: 2020 636f 6e74 656e 7420 3d20 7465 6d70    content = temp
+000125b0: 6c61 7465 2e72 656e 6465 7228 636c 6f75  late.render(clou
+000125c0: 643d 2761 7773 272c 2072 6567 696f 6e3d  d='aws', region=
+000125d0: 2775 732d 6561 7374 2d31 2729 0a20 2020  'us-east-1').   
+000125e0: 2077 6974 6820 7465 6d70 6669 6c65 2e4e   with tempfile.N
+000125f0: 616d 6564 5465 6d70 6f72 6172 7946 696c  amedTemporaryFil
+00012600: 6528 7375 6666 6978 3d27 2e79 616d 6c27  e(suffix='.yaml'
+00012610: 2c20 6d6f 6465 3d27 7727 2920 6173 2066  , mode='w') as f
+00012620: 3a0a 2020 2020 2020 2020 662e 7772 6974  :.        f.writ
+00012630: 6528 636f 6e74 656e 7429 0a20 2020 2020  e(content).     
+00012640: 2020 2066 2e66 6c75 7368 2829 0a20 2020     f.flush().   
+00012650: 2020 2020 2066 696c 655f 7061 7468 203d       file_path =
+00012660: 2066 2e6e 616d 650a 2020 2020 2020 2020   f.name.        
+00012670: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00012680: 2020 2020 2020 2020 2027 7461 736b 5f6c           'task_l
+00012690: 6162 656c 735f 6177 7327 2c0a 2020 2020  abels_aws',.    
+000126a0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+000126b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000126c0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+000126d0: 6d65 7d20 7b66 696c 655f 7061 7468 7d27  me} {file_path}'
+000126e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000126f0: 2020 2320 5665 7269 6679 2077 6974 6820    # Verify with 
+00012700: 6177 7320 636c 6920 7468 6174 2074 6865  aws cli that the
+00012710: 2074 6167 7320 6172 6520 7365 742e 0a20   tags are set.. 
+00012720: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00012730: 6177 7320 6563 3220 6465 7363 7269 6265  aws ec2 describe
+00012740: 2d69 6e73 7461 6e63 6573 2027 0a20 2020  -instances '.   
+00012750: 2020 2020 2020 2020 2020 2020 2027 2d2d               '--
+00012760: 7175 6572 7920 2252 6573 6572 7661 7469  query "Reservati
+00012770: 6f6e 735b 2a5d 2e49 6e73 7461 6e63 6573  ons[*].Instances
+00012780: 5b2a 5d2e 496e 7374 616e 6365 4964 2220  [*].InstanceId" 
+00012790: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+000127a0: 2020 272d 2d66 696c 7465 7273 2022 4e61    '--filters "Na
+000127b0: 6d65 3d69 6e73 7461 6e63 652d 7374 6174  me=instance-stat
+000127c0: 652d 6e61 6d65 2c56 616c 7565 733d 7275  e-name,Values=ru
+000127d0: 6e6e 696e 6722 2027 0a20 2020 2020 2020  nning" '.       
+000127e0: 2020 2020 2020 2020 2066 272d 2d66 696c           f'--fil
+000127f0: 7465 7273 2022 4e61 6d65 3d74 6167 3a73  ters "Name=tag:s
+00012800: 6b79 7069 6c6f 742d 636c 7573 7465 722d  kypilot-cluster-
+00012810: 6e61 6d65 2c56 616c 7565 733d 7b6e 616d  name,Values={nam
+00012820: 657d 2a22 2027 0a20 2020 2020 2020 2020  e}*" '.         
+00012830: 2020 2020 2020 2027 2d2d 6669 6c74 6572         '--filter
+00012840: 7320 224e 616d 653d 7461 673a 696e 6c69  s "Name=tag:inli
+00012850: 6e65 6c61 6265 6c31 2c56 616c 7565 733d  nelabel1,Values=
+00012860: 696e 6c69 6e65 7661 6c75 6531 2220 270a  inlinevalue1" '.
+00012870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012880: 272d 2d66 696c 7465 7273 2022 4e61 6d65  '--filters "Name
+00012890: 3d74 6167 3a69 6e6c 696e 656c 6162 656c  =tag:inlinelabel
+000128a0: 322c 5661 6c75 6573 3d69 6e6c 696e 6576  2,Values=inlinev
+000128b0: 616c 7565 3222 2027 0a20 2020 2020 2020  alue2" '.       
+000128c0: 2020 2020 2020 2020 2027 2d2d 7265 6769           '--regi
+000128d0: 6f6e 2075 732d 6561 7374 2d31 202d 2d6f  on us-east-1 --o
+000128e0: 7574 7075 7420 7465 7874 272c 0a20 2020  utput text',.   
+000128f0: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
+00012900: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+00012910: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+00012920: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00012930: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00012940: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
+00012950: 2d2d 204c 6162 656c 7320 6672 6f6d 2074  -- Labels from t
+00012960: 6173 6b20 6f6e 2047 4350 2028 6c61 6265  ask on GCP (labe
+00012970: 6c73 2920 2d2d 2d2d 2d2d 2d2d 2d2d 0a40  ls) ----------.@
+00012980: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
+00012990: 6465 6620 7465 7374 5f74 6173 6b5f 6c61  def test_task_la
+000129a0: 6265 6c73 5f67 6370 2829 3a0a 2020 2020  bels_gcp():.    
+000129b0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+000129c0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+000129d0: 656d 706c 6174 655f 7374 7220 3d20 7061  emplate_str = pa
+000129e0: 7468 6c69 622e 5061 7468 280a 2020 2020  thlib.Path(.    
+000129f0: 2020 2020 2774 6573 7473 2f74 6573 745f      'tests/test_
+00012a00: 7961 6d6c 732f 7465 7374 5f6c 6162 656c  yamls/test_label
+00012a10: 732e 7961 6d6c 2e6a 3227 292e 7265 6164  s.yaml.j2').read
+00012a20: 5f74 6578 7428 290a 2020 2020 7465 6d70  _text().    temp
+00012a30: 6c61 7465 203d 206a 696e 6a61 322e 5465  late = jinja2.Te
+00012a40: 6d70 6c61 7465 2874 656d 706c 6174 655f  mplate(template_
+00012a50: 7374 7229 0a20 2020 2063 6f6e 7465 6e74  str).    content
+00012a60: 203d 2074 656d 706c 6174 652e 7265 6e64   = template.rend
+00012a70: 6572 2863 6c6f 7564 3d27 6763 7027 290a  er(cloud='gcp').
+00012a80: 2020 2020 7769 7468 2074 656d 7066 696c      with tempfil
+00012a90: 652e 4e61 6d65 6454 656d 706f 7261 7279  e.NamedTemporary
+00012aa0: 4669 6c65 2873 7566 6669 783d 272e 7961  File(suffix='.ya
+00012ab0: 6d6c 272c 206d 6f64 653d 2777 2729 2061  ml', mode='w') a
+00012ac0: 7320 663a 0a20 2020 2020 2020 2066 2e77  s f:.        f.w
+00012ad0: 7269 7465 2863 6f6e 7465 6e74 290a 2020  rite(content).  
+00012ae0: 2020 2020 2020 662e 666c 7573 6828 290a        f.flush().
+00012af0: 2020 2020 2020 2020 6669 6c65 5f70 6174          file_pat
+00012b00: 6820 3d20 662e 6e61 6d65 0a20 2020 2020  h = f.name.     
+00012b10: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00012b20: 2020 2020 2020 2020 2020 2020 2774 6173              'tas
+00012b30: 6b5f 6c61 6265 6c73 5f67 6370 272c 0a20  k_labels_gcp',. 
+00012b40: 2020 2020 2020 2020 2020 205b 0a20 2020             [.   
+00012b50: 2020 2020 2020 2020 2020 2020 2066 2773               f's
+00012b60: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00012b70: 7b6e 616d 657d 207b 6669 6c65 5f70 6174  {name} {file_pat
+00012b80: 687d 272c 0a20 2020 2020 2020 2020 2020  h}',.           
+00012b90: 2020 2020 2023 2056 6572 6966 7920 7769       # Verify wi
+00012ba0: 7468 2067 636c 6f75 6420 636c 6920 7468  th gcloud cli th
+00012bb0: 6174 2074 6865 2074 6167 7320 6172 6520  at the tags are 
+00012bc0: 7365 740a 2020 2020 2020 2020 2020 2020  set.            
+00012bd0: 2020 2020 6627 6763 6c6f 7564 2063 6f6d      f'gcloud com
+00012be0: 7075 7465 2069 6e73 7461 6e63 6573 206c  pute instances l
+00012bf0: 6973 7420 2d2d 6669 6c74 6572 3d22 6e61  ist --filter="na
+00012c00: 6d65 7e5c 275e 7b6e 616d 657d 5c27 2041  me~\'^{name}\' A
+00012c10: 4e44 2027 0a20 2020 2020 2020 2020 2020  ND '.           
+00012c20: 2020 2020 2027 6c61 6265 6c73 2e69 6e6c       'labels.inl
+00012c30: 696e 656c 6162 656c 313d 5c27 696e 6c69  inelabel1=\'inli
+00012c40: 6e65 7661 6c75 6531 5c27 2041 4e44 2027  nevalue1\' AND '
+00012c50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012c60: 2027 6c61 6265 6c73 2e69 6e6c 696e 656c   'labels.inlinel
+00012c70: 6162 656c 323d 5c27 696e 6c69 6e65 7661  abel2=\'inlineva
+00012c80: 6c75 6532 5c27 2220 270a 2020 2020 2020  lue2\'" '.      
+00012c90: 2020 2020 2020 2020 2020 272d 2d66 6f72            '--for
+00012ca0: 6d61 743d 2276 616c 7565 286e 616d 6529  mat="value(name)
+00012cb0: 2220 7c20 6772 6570 202e 272c 0a20 2020  " | grep .',.   
+00012cc0: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
+00012cd0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+00012ce0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+00012cf0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00012d00: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00012d10: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
+00012d20: 2d2d 204c 6162 656c 7320 6672 6f6d 2074  -- Labels from t
+00012d30: 6173 6b20 6f6e 204b 7562 6572 6e65 7465  ask on Kubernete
+00012d40: 7320 286c 6162 656c 7329 202d 2d2d 2d2d  s (labels) -----
+00012d50: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
+00012d60: 726b 2e6b 7562 6572 6e65 7465 730a 6465  rk.kubernetes.de
+00012d70: 6620 7465 7374 5f74 6173 6b5f 6c61 6265  f test_task_labe
+00012d80: 6c73 5f6b 7562 6572 6e65 7465 7328 293a  ls_kubernetes():
+00012d90: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00012da0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00012db0: 2020 2020 7465 6d70 6c61 7465 5f73 7472      template_str
+00012dc0: 203d 2070 6174 686c 6962 2e50 6174 6828   = pathlib.Path(
+00012dd0: 0a20 2020 2020 2020 2027 7465 7374 732f  .        'tests/
+00012de0: 7465 7374 5f79 616d 6c73 2f74 6573 745f  test_yamls/test_
+00012df0: 6c61 6265 6c73 2e79 616d 6c2e 6a32 2729  labels.yaml.j2')
+00012e00: 2e72 6561 645f 7465 7874 2829 0a20 2020  .read_text().   
+00012e10: 2074 656d 706c 6174 6520 3d20 6a69 6e6a   template = jinj
+00012e20: 6132 2e54 656d 706c 6174 6528 7465 6d70  a2.Template(temp
+00012e30: 6c61 7465 5f73 7472 290a 2020 2020 636f  late_str).    co
+00012e40: 6e74 656e 7420 3d20 7465 6d70 6c61 7465  ntent = template
+00012e50: 2e72 656e 6465 7228 636c 6f75 643d 276b  .render(cloud='k
+00012e60: 7562 6572 6e65 7465 7327 290a 2020 2020  ubernetes').    
+00012e70: 7769 7468 2074 656d 7066 696c 652e 4e61  with tempfile.Na
+00012e80: 6d65 6454 656d 706f 7261 7279 4669 6c65  medTemporaryFile
+00012e90: 2873 7566 6669 783d 272e 7961 6d6c 272c  (suffix='.yaml',
+00012ea0: 206d 6f64 653d 2777 2729 2061 7320 663a   mode='w') as f:
+00012eb0: 0a20 2020 2020 2020 2066 2e77 7269 7465  .        f.write
+00012ec0: 2863 6f6e 7465 6e74 290a 2020 2020 2020  (content).      
+00012ed0: 2020 662e 666c 7573 6828 290a 2020 2020    f.flush().    
+00012ee0: 2020 2020 6669 6c65 5f70 6174 6820 3d20      file_path = 
+00012ef0: 662e 6e61 6d65 0a20 2020 2020 2020 2074  f.name.        t
+00012f00: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00012f10: 2020 2020 2020 2020 2774 6173 6b5f 6c61          'task_la
+00012f20: 6265 6c73 5f6b 7562 6572 6e65 7465 7327  bels_kubernetes'
+00012f30: 2c0a 2020 2020 2020 2020 2020 2020 5b0a  ,.            [.
+00012f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012f50: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00012f60: 2d63 207b 6e61 6d65 7d20 7b66 696c 655f  -c {name} {file_
+00012f70: 7061 7468 7d27 2c0a 2020 2020 2020 2020  path}',.        
+00012f80: 2020 2020 2020 2020 2320 5665 7269 6679          # Verify
+00012f90: 2077 6974 6820 6b75 6265 6374 6c20 7468   with kubectl th
+00012fa0: 6174 2074 6865 206c 6162 656c 7320 6172  at the labels ar
+00012fb0: 6520 7365 742e 0a20 2020 2020 2020 2020  e set..         
+00012fc0: 2020 2020 2020 2027 6b75 6265 6374 6c20         'kubectl 
+00012fd0: 6765 7420 706f 6473 2027 0a20 2020 2020  get pods '.     
+00012fe0: 2020 2020 2020 2020 2020 2027 2d2d 7365             '--se
+00012ff0: 6c65 6374 6f72 2069 6e6c 696e 656c 6162  lector inlinelab
+00013000: 656c 313d 696e 6c69 6e65 7661 6c75 6531  el1=inlinevalue1
+00013010: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00013020: 2020 2027 2d2d 7365 6c65 6374 6f72 2069     '--selector i
+00013030: 6e6c 696e 656c 6162 656c 323d 696e 6c69  nlinelabel2=inli
+00013040: 6e65 7661 6c75 6532 2027 0a20 2020 2020  nevalue2 '.     
+00013050: 2020 2020 2020 2020 2020 2027 2d6f 206a             '-o j
+00013060: 736f 6e70 6174 683d 5c27 7b2e 6974 656d  sonpath=\'{.item
+00013070: 735b 2a5d 2e6d 6574 6164 6174 612e 6e61  s[*].metadata.na
+00013080: 6d65 7d5c 2720 7c20 270a 2020 2020 2020  me}\' | '.      
+00013090: 2020 2020 2020 2020 2020 6627 6772 6570            f'grep
+000130a0: 205c 275e 7b6e 616d 657d 5c27 270a 2020   \'^{name}\''.  
+000130b0: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
+000130c0: 2020 2020 2020 2020 2066 2773 6b79 2064           f'sky d
+000130d0: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+000130e0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000130f0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00013100: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
+00013110: 2d2d 2d20 5461 736b 3a20 6e3d 3220 6e6f  --- Task: n=2 no
+00013120: 6465 7320 7769 7468 2073 6574 7570 732e  des with setups.
+00013130: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
+00013140: 6573 742e 6d61 726b 2e6e 6f5f 6c61 6d62  est.mark.no_lamb
+00013150: 6461 5f63 6c6f 7564 2020 2320 4c61 6d62  da_cloud  # Lamb
+00013160: 6461 2043 6c6f 7564 2064 6f65 7320 6e6f  da Cloud does no
+00013170: 7420 6861 7665 2056 3130 3020 6770 7573  t have V100 gpus
+00013180: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00013190: 5f69 626d 2020 2320 4942 4d20 636c 6f75  _ibm  # IBM clou
+000131a0: 6420 6375 7272 656e 746c 7920 646f 6573  d currently does
+000131b0: 6e27 7420 7072 6f76 6964 6520 7075 626c  n't provide publ
+000131c0: 6963 2069 6d61 6765 2077 6974 6820 4355  ic image with CU
+000131d0: 4441 0a40 7079 7465 7374 2e6d 6172 6b2e  DA.@pytest.mark.
+000131e0: 6e6f 5f73 6370 2020 2320 5343 5020 646f  no_scp  # SCP do
+000131f0: 6573 206e 6f74 2073 7570 706f 7274 206e  es not support n
+00013200: 756d 5f6e 6f64 6573 203e 2031 2079 6574  um_nodes > 1 yet
+00013210: 0a40 7079 7465 7374 2e6d 6172 6b2e 736b  .@pytest.mark.sk
+00013220: 6970 280a 2020 2020 7265 6173 6f6e 3d0a  ip(.    reason=.
+00013230: 2020 2020 2754 6865 2072 6573 6e65 745f      'The resnet_
+00013240: 6469 7374 7269 6275 7465 645f 7466 5f61  distributed_tf_a
+00013250: 7070 2069 7320 666c 616b 792c 2064 7565  pp is flaky, due
+00013260: 2074 6f20 6974 2066 6169 6c69 6e67 2074   to it failing t
+00013270: 6f20 6465 7465 6374 2047 5055 732e 2729  o detect GPUs.')
+00013280: 0a64 6566 2074 6573 745f 6469 7374 7269  .def test_distri
+00013290: 6275 7465 645f 7466 2867 656e 6572 6963  buted_tf(generic
+000132a0: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
+000132b0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+000132c0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+000132d0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+000132e0: 2020 2020 2020 2772 6573 6e65 745f 6469        'resnet_di
+000132f0: 7374 7269 6275 7465 645f 7466 5f61 7070  stributed_tf_app
+00013300: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00013310: 2020 2020 2020 2020 2023 204e 4f54 453a           # NOTE:
+00013320: 2072 756e 6e69 6e67 2069 7420 7477 6963   running it twic
+00013330: 6520 7769 6c6c 2068 616e 6720 2873 6f6d  e will hang (som
+00013340: 6574 696d 6573 3f29 202d 2061 6e20 6170  etimes?) - an ap
+00013350: 702d 6c65 7665 6c20 6275 672e 0a20 2020  p-level bug..   
+00013360: 2020 2020 2020 2020 2066 2770 7974 686f           f'pytho
+00013370: 6e20 6578 616d 706c 6573 2f72 6573 6e65  n examples/resne
+00013380: 745f 6469 7374 7269 6275 7465 645f 7466  t_distributed_tf
+00013390: 5f61 7070 2e70 7920 7b6e 616d 657d 207b  _app.py {name} {
+000133a0: 6765 6e65 7269 635f 636c 6f75 647d 272c  generic_cloud}',
+000133b0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000133c0: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+000133d0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+000133e0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+000133f0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+00013400: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+00013410: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00013420: 272c 0a20 2020 2020 2020 2074 696d 656f  ',.        timeo
+00013430: 7574 3d32 3520 2a20 3630 2c20 2023 2032  ut=25 * 60,  # 2
+00013440: 3520 6d69 6e73 2028 6974 2074 616b 6573  5 mins (it takes
+00013450: 2061 726f 756e 6420 7e31 3920 6d69 6e73   around ~19 mins
+00013460: 290a 2020 2020 290a 2020 2020 7275 6e5f  ).    ).    run_
+00013470: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00013480: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
+00013490: 7374 696e 6720 4743 5020 7374 6172 7420  sting GCP start 
+000134a0: 616e 6420 7374 6f70 2069 6e73 7461 6e63  and stop instanc
+000134b0: 6573 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  es ----------.@p
+000134c0: 7974 6573 742e 6d61 726b 2e67 6370 0a64  ytest.mark.gcp.d
+000134d0: 6566 2074 6573 745f 6763 705f 7374 6172  ef test_gcp_star
+000134e0: 745f 7374 6f70 2829 3a0a 2020 2020 6e61  t_stop():.    na
+000134f0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00013500: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+00013510: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00013520: 2020 2767 6370 2d73 7461 7274 2d73 746f    'gcp-start-sto
+00013530: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
+00013540: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00013550: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+00013560: 6d65 7d20 6578 616d 706c 6573 2f67 6370  me} examples/gcp
+00013570: 5f73 7461 7274 5f73 746f 702e 7961 6d6c  _start_stop.yaml
+00013580: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00013590: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+000135a0: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
+000135b0: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+000135c0: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+000135d0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+000135e0: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
+000135f0: 732f 6763 705f 7374 6172 745f 7374 6f70  s/gcp_start_stop
+00013600: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00013610: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00013620: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
+00013630: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+00013640: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+00013650: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00013660: 7920 6578 6563 207b 6e61 6d65 7d20 2270  y exec {name} "p
+00013670: 726c 696d 6974 202d 6e20 2d2d 7069 643d  rlimit -n --pid=
+00013680: 5c24 2870 6772 6570 202d 6620 5c27 7261  \$(pgrep -f \'ra
+00013690: 796c 6574 2f72 6179 6c65 7420 2d2d 7261  ylet/raylet --ra
+000136a0: 796c 6574 5f73 6f63 6b65 745f 6e61 6d65  ylet_socket_name
+000136b0: 5c27 2920 7c20 6772 6570 205c 2722 5c27  \') | grep \'"\'
+000136c0: 3130 3438 3537 3620 3130 3438 3537 365c  1048576 1048576\
+000136d0: 2722 5c27 2227 2c20 2023 2045 6e73 7572  '"\'"',  # Ensur
+000136e0: 6520 7468 6520 7261 796c 6574 2070 726f  e the raylet pro
+000136f0: 6365 7373 2068 6173 2074 6865 2063 6f72  cess has the cor
+00013700: 7265 6374 2066 696c 6520 6465 7363 7269  rect file descri
+00013710: 7074 6f72 206c 696d 6974 2e0a 2020 2020  ptor limit..    
+00013720: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00013730: 6773 207b 6e61 6d65 7d20 3320 2d2d 7374  gs {name} 3 --st
+00013740: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+00013750: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+00013760: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00013770: 6627 736b 7920 7374 6f70 202d 7920 7b6e  f'sky stop -y {n
+00013780: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
+00013790: 2020 2066 2773 6c65 6570 2032 3027 2c0a     f'sleep 20',.
+000137a0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000137b0: 7920 7374 6172 7420 2d79 207b 6e61 6d65  y start -y {name
+000137c0: 7d20 2d69 2031 272c 0a20 2020 2020 2020  } -i 1',.       
+000137d0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+000137e0: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
+000137f0: 6763 705f 7374 6172 745f 7374 6f70 2e79  gcp_start_stop.y
+00013800: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00013810: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00013820: 6d65 7d20 3420 2d2d 7374 6174 7573 272c  me} 4 --status',
+00013830: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+00013840: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+00013850: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+00013860: 2031 3830 272c 0a20 2020 2020 2020 2020   180',.         
+00013870: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
+00013880: 2d72 207b 6e61 6d65 7d20 7c20 6772 6570  -r {name} | grep
+00013890: 2022 494e 4954 5c7c 5354 4f50 5045 4422   "INIT\|STOPPED"
+000138a0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+000138b0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+000138c0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+000138d0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+000138e0: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+000138f0: 2d2d 2d2d 2d2d 2d2d 2054 6573 7469 6e67  -------- Testing
+00013900: 2041 7a75 7265 2073 7461 7274 2061 6e64   Azure start and
+00013910: 2073 746f 7020 696e 7374 616e 6365 7320   stop instances 
+00013920: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
+00013930: 7374 2e6d 6172 6b2e 617a 7572 650a 6465  st.mark.azure.de
+00013940: 6620 7465 7374 5f61 7a75 7265 5f73 7461  f test_azure_sta
+00013950: 7274 5f73 746f 7028 293a 0a20 2020 206e  rt_stop():.    n
+00013960: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00013970: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+00013980: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00013990: 2020 2027 617a 7572 652d 7374 6172 742d     'azure-start-
+000139a0: 7374 6f70 272c 0a20 2020 2020 2020 205b  stop',.        [
+000139b0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000139c0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+000139d0: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
+000139e0: 617a 7572 655f 7374 6172 745f 7374 6f70  azure_start_stop
+000139f0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00013a00: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+00013a10: 6e61 6d65 7d20 6578 616d 706c 6573 2f61  name} examples/a
+00013a20: 7a75 7265 5f73 7461 7274 5f73 746f 702e  zure_start_stop.
+00013a30: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00013a40: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00013a50: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+00013a60: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+00013a70: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+00013a80: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00013a90: 2065 7865 6320 7b6e 616d 657d 2022 7072   exec {name} "pr
+00013aa0: 6c69 6d69 7420 2d6e 202d 2d70 6964 3d5c  limit -n --pid=\
+00013ab0: 2428 7067 7265 7020 2d66 205c 2772 6179  $(pgrep -f \'ray
+00013ac0: 6c65 742f 7261 796c 6574 202d 2d72 6179  let/raylet --ray
+00013ad0: 6c65 745f 736f 636b 6574 5f6e 616d 655c  let_socket_name\
+00013ae0: 2729 207c 2067 7265 7020 5c27 225c 2731  ') | grep \'"\'1
+00013af0: 3034 3835 3736 2031 3034 3835 3736 5c27  048576 1048576\'
+00013b00: 225c 2722 272c 2020 2320 456e 7375 7265  "\'"',  # Ensure
+00013b10: 2074 6865 2072 6179 6c65 7420 7072 6f63   the raylet proc
+00013b20: 6573 7320 6861 7320 7468 6520 636f 7272  ess has the corr
+00013b30: 6563 7420 6669 6c65 2064 6573 6372 6970  ect file descrip
+00013b40: 746f 7220 6c69 6d69 742e 0a20 2020 2020  tor limit..     
+00013b50: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00013b60: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
+00013b70: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+00013b80: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+00013b90: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
+00013ba0: 2773 6b79 2073 746f 7020 2d79 207b 6e61  'sky stop -y {na
+00013bb0: 6d65 7d27 2c0a 2020 2020 2020 2020 2020  me}',.          
+00013bc0: 2020 6627 736b 7920 7374 6172 7420 2d79    f'sky start -y
+00013bd0: 207b 6e61 6d65 7d20 2d69 2031 272c 0a20   {name} -i 1',. 
+00013be0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00013bf0: 2065 7865 6320 7b6e 616d 657d 2065 7861   exec {name} exa
+00013c00: 6d70 6c65 732f 617a 7572 655f 7374 6172  mples/azure_star
+00013c10: 745f 7374 6f70 2e79 616d 6c27 2c0a 2020  t_stop.yaml',.  
+00013c20: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00013c30: 6c6f 6773 207b 6e61 6d65 7d20 3320 2d2d  logs {name} 3 --
+00013c40: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+00013c50: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
+00013c60: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
+00013c70: 2020 2773 6c65 6570 2032 3630 272c 0a20    'sleep 260',. 
+00013c80: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+00013c90: 2873 6b79 2073 7461 7475 7320 2d72 207b  (sky status -r {
+00013ca0: 6e61 6d65 7d29 2026 2620 6563 686f 2022  name}) && echo "
+00013cb0: 2473 2220 2626 2065 6368 6f20 2224 7322  $s" && echo "$s"
+00013cc0: 207c 2067 7265 7020 2249 4e49 545c 7c53   | grep "INIT\|S
+00013cd0: 544f 5050 4544 2227 0a20 2020 2020 2020  TOPPED"'.       
+00013ce0: 2020 2020 2066 277c 7c20 7b7b 2073 7368       f'|| {{ ssh
+00013cf0: 207b 6e61 6d65 7d20 2263 6174 207e 2f2e   {name} "cat ~/.
+00013d00: 736b 792f 736b 796c 6574 2e6c 6f67 223b  sky/skylet.log";
+00013d10: 2065 7869 7420 313b 207d 7d27 0a20 2020   exit 1; }}'.   
+00013d20: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00013d30: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+00013d40: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
+00013d50: 696d 656f 7574 3d33 3020 2a20 3630 2c20  imeout=30 * 60, 
+00013d60: 2023 2033 3020 6d69 6e73 0a20 2020 2029   # 30 mins.    )
+00013d70: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00013d80: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+00013d90: 2d2d 2d2d 2d2d 2054 6573 7469 6e67 2041  ------ Testing A
+00013da0: 7574 6f73 746f 7070 696e 6720 2d2d 2d2d  utostopping ----
+00013db0: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
+00013dc0: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
+00013dd0: 6b20 2023 2046 6c75 6964 5374 6163 6b20  k  # FluidStack 
+00013de0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+00013df0: 2073 746f 7070 696e 6720 696e 2053 6b79   stopping in Sky
+00013e00: 5069 6c6f 7420 696d 706c 656d 656e 7461  Pilot implementa
+00013e10: 7469 6f6e 0a40 7079 7465 7374 2e6d 6172  tion.@pytest.mar
+00013e20: 6b2e 6e6f 5f6c 616d 6264 615f 636c 6f75  k.no_lambda_clou
+00013e30: 6420 2023 204c 616d 6264 6120 436c 6f75  d  # Lambda Clou
+00013e40: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
+00013e50: 7274 2073 746f 7070 696e 6720 696e 7374  rt stopping inst
+00013e60: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+00013e70: 726b 2e6e 6f5f 6962 6d20 2023 2046 4958  rk.no_ibm  # FIX
+00013e80: 2849 424d 2920 7370 6f72 6164 6963 616c  (IBM) sporadical
+00013e90: 6c79 2066 6169 6c73 2c20 6173 2072 6573  ly fails, as res
+00013ea0: 7461 7274 6564 2077 6f72 6b65 7273 2073  tarted workers s
+00013eb0: 7461 7920 756e 696e 6974 6961 6c69 7a65  tay uninitialize
+00013ec0: 6420 696e 6465 6669 6e69 7465 6c79 0a40  d indefinitely.@
+00013ed0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f73  pytest.mark.no_s
+00013ee0: 6370 2020 2320 5343 5020 646f 6573 206e  cp  # SCP does n
+00013ef0: 6f74 2073 7570 706f 7274 206e 756d 5f6e  ot support num_n
+00013f00: 6f64 6573 203e 2031 2079 6574 0a40 7079  odes > 1 yet.@py
+00013f10: 7465 7374 2e6d 6172 6b2e 6e6f 5f6b 7562  test.mark.no_kub
+00013f20: 6572 6e65 7465 7320 2023 204b 7562 6572  ernetes  # Kuber
+00013f30: 6e65 7465 7320 646f 6573 206e 6f74 2061  netes does not a
+00013f40: 7574 6f73 746f 7020 7965 740a 6465 6620  utostop yet.def 
+00013f50: 7465 7374 5f61 7574 6f73 746f 7028 6765  test_autostop(ge
+00013f60: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+00013f70: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+00013f80: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+00013f90: 290a 2020 2020 2320 417a 7572 6520 7461  ).    # Azure ta
+00013fa0: 6b65 7320 7e20 376d 3135 7320 2834 3335  kes ~ 7m15s (435
+00013fb0: 7329 2074 6f20 6175 746f 7374 6f70 2061  s) to autostop a
+00013fc0: 2056 4d2c 2073 6f20 6865 7265 2077 6520   VM, so here we 
+00013fd0: 7573 6520 3630 3020 746f 2065 6e73 7572  use 600 to ensur
+00013fe0: 650a 2020 2020 2320 7468 6520 564d 2069  e.    # the VM i
+00013ff0: 7320 7374 6f70 7065 642e 0a20 2020 2061  s stopped..    a
+00014000: 7574 6f73 746f 705f 7469 6d65 6f75 7420  utostop_timeout 
+00014010: 3d20 3630 3020 6966 2067 656e 6572 6963  = 600 if generic
+00014020: 5f63 6c6f 7564 203d 3d20 2761 7a75 7265  _cloud == 'azure
+00014030: 2720 656c 7365 2032 3530 0a20 2020 2023  ' else 250.    #
+00014040: 204c 6175 6e63 6869 6e67 2061 6e64 2073   Launching and s
+00014050: 7461 7274 696e 6720 417a 7572 6520 636c  tarting Azure cl
+00014060: 7573 7465 7273 2063 616e 2074 616b 6520  usters can take 
+00014070: 6120 6c6f 6e67 2074 696d 6520 746f 6f2e  a long time too.
+00014080: 2065 2e67 2e2c 2072 6573 7461 7274 0a20   e.g., restart. 
+00014090: 2020 2023 2061 2073 746f 7070 6564 2041     # a stopped A
+000140a0: 7a75 7265 2063 6c75 7374 6572 2063 616e  zure cluster can
+000140b0: 2074 616b 6520 376d 2e20 536f 2077 6520   take 7m. So we 
+000140c0: 7365 7420 7468 6520 746f 7461 6c20 7469  set the total ti
+000140d0: 6d65 6f75 7420 746f 2037 306d 2e0a 2020  meout to 70m..  
+000140e0: 2020 746f 7461 6c5f 7469 6d65 6f75 745f    total_timeout_
+000140f0: 6d69 6e75 7465 7320 3d20 3730 2069 6620  minutes = 70 if 
+00014100: 6765 6e65 7269 635f 636c 6f75 6420 3d3d  generic_cloud ==
+00014110: 2027 617a 7572 6527 2065 6c73 6520 3230   'azure' else 20
+00014120: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00014130: 280a 2020 2020 2020 2020 2761 7574 6f73  (.        'autos
+00014140: 746f 7027 2c0a 2020 2020 2020 2020 5b0a  top',.        [.
+00014150: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00014160: 7920 6c61 756e 6368 202d 7920 2d64 202d  y launch -y -d -
+00014170: 6320 7b6e 616d 657d 202d 2d6e 756d 2d6e  c {name} --num-n
+00014180: 6f64 6573 2032 202d 2d63 6c6f 7564 207b  odes 2 --cloud {
+00014190: 6765 6e65 7269 635f 636c 6f75 647d 2074  generic_cloud} t
+000141a0: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+000141b0: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
+000141c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000141d0: 2061 7574 6f73 746f 7020 2d79 207b 6e61   autostop -y {na
+000141e0: 6d65 7d20 2d69 2031 272c 0a0a 2020 2020  me} -i 1',..    
+000141f0: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
+00014200: 2061 7574 6f73 746f 7020 6973 2073 6574   autostop is set
+00014210: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00014220: 736b 7920 7374 6174 7573 207c 2067 7265  sky status | gre
+00014230: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
+00014240: 2231 6d22 272c 0a0a 2020 2020 2020 2020  "1m"',..        
+00014250: 2020 2020 2320 456e 7375 7265 2074 6865      # Ensure the
+00014260: 2063 6c75 7374 6572 2069 7320 6e6f 7420   cluster is not 
+00014270: 7374 6f70 7065 6420 6561 726c 792e 0a20  stopped early.. 
+00014280: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00014290: 7020 3430 272c 0a20 2020 2020 2020 2020  p 40',.         
+000142a0: 2020 2066 2773 3d24 2873 6b79 2073 7461     f's=$(sky sta
+000142b0: 7475 7320 7b6e 616d 657d 202d 2d72 6566  tus {name} --ref
+000142c0: 7265 7368 293b 2065 6368 6f20 2224 7322  resh); echo "$s"
+000142d0: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
+000142e0: 686f 2022 2473 2220 207c 2067 7265 7020  ho "$s"  | grep 
+000142f0: 7b6e 616d 657d 207c 2067 7265 7020 5550  {name} | grep UP
+00014300: 272c 0a0a 2020 2020 2020 2020 2020 2020  ',..            
+00014310: 2320 456e 7375 7265 2074 6865 2063 6c75  # Ensure the clu
+00014320: 7374 6572 2069 7320 5354 4f50 5045 442e  ster is STOPPED.
+00014330: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00014340: 6c65 6570 207b 6175 746f 7374 6f70 5f74  leep {autostop_t
+00014350: 696d 656f 7574 7d27 2c0a 2020 2020 2020  imeout}',.      
+00014360: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
+00014370: 7374 6174 7573 207b 6e61 6d65 7d20 2d2d  status {name} --
+00014380: 7265 6672 6573 6829 3b20 6563 686f 2022  refresh); echo "
+00014390: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
+000143a0: 2065 6368 6f20 2224 7322 2020 7c20 6772   echo "$s"  | gr
+000143b0: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
+000143c0: 2053 544f 5050 4544 272c 0a0a 2020 2020   STOPPED',..    
+000143d0: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
+000143e0: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
+000143f0: 5550 2061 6e64 2074 6865 2061 7574 6f73  UP and the autos
+00014400: 746f 7020 7365 7474 696e 6720 6973 2072  top setting is r
+00014410: 6573 6574 2028 272d 2729 2e0a 2020 2020  eset ('-')..    
+00014420: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+00014430: 6172 7420 2d79 207b 6e61 6d65 7d27 2c0a  art -y {name}',.
+00014440: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00014450: 7920 7374 6174 7573 207c 2067 7265 7020  y status | grep 
+00014460: 7b6e 616d 657d 207c 2067 7265 7020 2d45  {name} | grep -E
+00014470: 2022 5550 5c73 2b2d 2227 2c0a 0a20 2020   "UP\s+-"',..   
+00014480: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
+00014490: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
+000144a0: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
+000144b0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+000144c0: 657d 2074 6573 7473 2f74 6573 745f 7961  e} tests/test_ya
+000144d0: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
+000144e0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000144f0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00014500: 2032 202d 2d73 7461 7475 7327 2c0a 0a20   2 --status',.. 
+00014510: 2020 2020 2020 2020 2020 2023 2054 6573             # Tes
+00014520: 7420 7265 7374 6172 7469 6e67 2074 6865  t restarting the
+00014530: 2069 646c 656e 6573 7320 7469 6d65 7220   idleness timer 
+00014540: 7669 6120 7265 7365 743a 0a20 2020 2020  via reset:.     
+00014550: 2020 2020 2020 2066 2773 6b79 2061 7574         f'sky aut
+00014560: 6f73 746f 7020 2d79 207b 6e61 6d65 7d20  ostop -y {name} 
+00014570: 2d69 2031 272c 2020 2320 4964 6c65 6e65  -i 1',  # Idlene
+00014580: 7373 2073 7461 7274 7320 636f 756e 7469  ss starts counti
+00014590: 6e67 2e0a 2020 2020 2020 2020 2020 2020  ng..            
+000145a0: 2773 6c65 6570 2034 3027 2c20 2023 2041  'sleep 40',  # A
+000145b0: 6c6d 6f73 7420 7265 6163 6865 6420 7468  lmost reached th
+000145c0: 6520 7468 7265 7368 6f6c 642e 0a20 2020  e threshold..   
+000145d0: 2020 2020 2020 2020 2066 2773 6b79 2061           f'sky a
+000145e0: 7574 6f73 746f 7020 2d79 207b 6e61 6d65  utostop -y {name
+000145f0: 7d20 2d69 2031 272c 2020 2320 5368 6f75  } -i 1',  # Shou
+00014600: 6c64 2072 6573 7461 7274 2074 6865 2074  ld restart the t
+00014610: 696d 6572 2e0a 2020 2020 2020 2020 2020  imer..          
+00014620: 2020 2773 6c65 6570 2034 3027 2c0a 2020    'sleep 40',.  
+00014630: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+00014640: 736b 7920 7374 6174 7573 207b 6e61 6d65  sky status {name
+00014650: 7d20 2d2d 7265 6672 6573 6829 3b20 6563  } --refresh); ec
+00014660: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
+00014670: 6368 6f3b 2065 6368 6f20 2224 7322 207c  cho; echo "$s" |
+00014680: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
+00014690: 7265 7020 5550 272c 0a20 2020 2020 2020  rep UP',.       
+000146a0: 2020 2020 2066 2773 6c65 6570 207b 6175       f'sleep {au
+000146b0: 746f 7374 6f70 5f74 696d 656f 7574 7d27  tostop_timeout}'
+000146c0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000146d0: 733d 2428 736b 7920 7374 6174 7573 207b  s=$(sky status {
+000146e0: 6e61 6d65 7d20 2d2d 7265 6672 6573 6829  name} --refresh)
+000146f0: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
+00014700: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
+00014710: 7322 2020 7c20 6772 6570 207b 6e61 6d65  s"  | grep {name
+00014720: 7d20 7c20 6772 6570 2053 544f 5050 4544  } | grep STOPPED
+00014730: 272c 0a0a 2020 2020 2020 2020 2020 2020  ',..            
+00014740: 2320 5465 7374 2072 6573 7461 7274 696e  # Test restartin
+00014750: 6720 7468 6520 6964 6c65 6e65 7373 2074  g the idleness t
+00014760: 696d 6572 2076 6961 2065 7865 633a 0a20  imer via exec:. 
+00014770: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00014780: 2073 7461 7274 202d 7920 7b6e 616d 657d   start -y {name}
+00014790: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000147a0: 2773 6b79 2073 7461 7475 7320 7c20 6772  'sky status | gr
+000147b0: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
+000147c0: 202d 4520 2255 505c 732b 2d22 272c 0a20   -E "UP\s+-"',. 
+000147d0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000147e0: 2061 7574 6f73 746f 7020 2d79 207b 6e61   autostop -y {na
+000147f0: 6d65 7d20 2d69 2031 272c 2020 2320 4964  me} -i 1',  # Id
+00014800: 6c65 6e65 7373 2073 7461 7274 7320 636f  leness starts co
+00014810: 756e 7469 6e67 2e0a 2020 2020 2020 2020  unting..        
+00014820: 2020 2020 2773 6c65 6570 2034 3527 2c20      'sleep 45', 
+00014830: 2023 2041 6c6d 6f73 7420 7265 6163 6865   # Almost reache
+00014840: 6420 7468 6520 7468 7265 7368 6f6c 642e  d the threshold.
+00014850: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00014860: 6b79 2065 7865 6320 7b6e 616d 657d 2065  ky exec {name} e
+00014870: 6368 6f20 6869 272c 2020 2320 5368 6f75  cho hi',  # Shou
+00014880: 6c64 2072 6573 7461 7274 2074 6865 2074  ld restart the t
+00014890: 696d 6572 2e0a 2020 2020 2020 2020 2020  imer..          
+000148a0: 2020 2773 6c65 6570 2034 3527 2c0a 2020    'sleep 45',.  
+000148b0: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+000148c0: 736b 7920 7374 6174 7573 207b 6e61 6d65  sky status {name
+000148d0: 7d20 2d2d 7265 6672 6573 6829 3b20 6563  } --refresh); ec
+000148e0: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
+000148f0: 6368 6f3b 2065 6368 6f20 2224 7322 2020  cho; echo "$s"  
+00014900: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+00014910: 6772 6570 2055 5027 2c0a 2020 2020 2020  grep UP',.      
+00014920: 2020 2020 2020 6627 736c 6565 7020 7b61        f'sleep {a
+00014930: 7574 6f73 746f 705f 7469 6d65 6f75 747d  utostop_timeout}
+00014940: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00014950: 2773 3d24 2873 6b79 2073 7461 7475 7320  's=$(sky status 
+00014960: 7b6e 616d 657d 202d 2d72 6566 7265 7368  {name} --refresh
+00014970: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
+00014980: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
+00014990: 2473 2220 207c 2067 7265 7020 7b6e 616d  $s"  | grep {nam
+000149a0: 657d 207c 2067 7265 7020 5354 4f50 5045  e} | grep STOPPE
+000149b0: 4427 2c0a 2020 2020 2020 2020 5d2c 0a20  D',.        ],. 
+000149c0: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+000149d0: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+000149e0: 2020 2020 2020 7469 6d65 6f75 743d 746f        timeout=to
+000149f0: 7461 6c5f 7469 6d65 6f75 745f 6d69 6e75  tal_timeout_minu
+00014a00: 7465 7320 2a20 3630 2c0a 2020 2020 290a  tes * 60,.    ).
+00014a10: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00014a20: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
+00014a30: 2d2d 2d2d 2d20 5465 7374 696e 6720 4175  ----- Testing Au
+00014a40: 746f 646f 776e 696e 6720 2d2d 2d2d 2d2d  todowning ------
+00014a50: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
+00014a60: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b20  k.no_fluidstack 
+00014a70: 2023 2046 6c75 6964 5374 6163 6b20 646f   # FluidStack do
+00014a80: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
+00014a90: 746f 7070 696e 6720 696e 2053 6b79 5069  topping in SkyPi
+00014aa0: 6c6f 7420 696d 706c 656d 656e 7461 7469  lot implementati
+00014ab0: 6f6e 0a40 7079 7465 7374 2e6d 6172 6b2e  on.@pytest.mark.
+00014ac0: 6e6f 5f73 6370 2020 2320 5343 5020 646f  no_scp  # SCP do
+00014ad0: 6573 206e 6f74 2073 7570 706f 7274 206e  es not support n
+00014ae0: 756d 5f6e 6f64 6573 203e 2031 2079 6574  um_nodes > 1 yet
+00014af0: 2e20 5275 6e20 7465 7374 5f73 6370 5f61  . Run test_scp_a
+00014b00: 7574 6f64 6f77 6e20 696e 7374 6561 642e  utodown instead.
+00014b10: 0a64 6566 2074 6573 745f 6175 746f 646f  .def test_autodo
+00014b20: 776e 2867 656e 6572 6963 5f63 6c6f 7564  wn(generic_cloud
+00014b30: 3a20 7374 7229 3a0a 2020 2020 6e61 6d65  : str):.    name
+00014b40: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00014b50: 6e61 6d65 2829 0a20 2020 2023 2041 7a75  name().    # Azu
+00014b60: 7265 2074 616b 6573 207e 2031 336d 3330  re takes ~ 13m30
+00014b70: 7320 2838 3130 7329 2074 6f20 6175 746f  s (810s) to auto
+00014b80: 646f 776e 2061 2056 4d2c 2073 6f20 6865  down a VM, so he
+00014b90: 7265 2077 6520 7573 6520 3930 3020 746f  re we use 900 to
+00014ba0: 2065 6e73 7572 650a 2020 2020 2320 7468   ensure.    # th
+00014bb0: 6520 564d 2069 7320 7465 726d 696e 6174  e VM is terminat
+00014bc0: 6564 2e0a 2020 2020 6175 746f 646f 776e  ed..    autodown
+00014bd0: 5f74 696d 656f 7574 203d 2039 3030 2069  _timeout = 900 i
+00014be0: 6620 6765 6e65 7269 635f 636c 6f75 6420  f generic_cloud 
+00014bf0: 3d3d 2027 617a 7572 6527 2065 6c73 6520  == 'azure' else 
+00014c00: 3234 300a 2020 2020 746f 7461 6c5f 7469  240.    total_ti
+00014c10: 6d65 6f75 745f 6d69 6e75 7465 7320 3d20  meout_minutes = 
+00014c20: 3930 2069 6620 6765 6e65 7269 635f 636c  90 if generic_cl
+00014c30: 6f75 6420 3d3d 2027 617a 7572 6527 2065  oud == 'azure' e
+00014c40: 6c73 6520 3230 0a20 2020 2074 6573 7420  lse 20.    test 
+00014c50: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00014c60: 2761 7574 6f64 6f77 6e27 2c0a 2020 2020  'autodown',.    
+00014c70: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00014c80: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00014c90: 7920 2d64 202d 6320 7b6e 616d 657d 202d  y -d -c {name} -
+00014ca0: 2d6e 756d 2d6e 6f64 6573 2032 202d 2d63  -num-nodes 2 --c
+00014cb0: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+00014cc0: 6f75 647d 2074 6573 7473 2f74 6573 745f  oud} tests/test_
+00014cd0: 7961 6d6c 732f 6d69 6e69 6d61 6c2e 7961  yamls/minimal.ya
+00014ce0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00014cf0: 2066 2773 6b79 2061 7574 6f73 746f 7020   f'sky autostop 
+00014d00: 2d79 207b 6e61 6d65 7d20 2d2d 646f 776e  -y {name} --down
+00014d10: 202d 6920 3127 2c0a 2020 2020 2020 2020   -i 1',.        
+00014d20: 2020 2020 2320 456e 7375 7265 2061 7574      # Ensure aut
+00014d30: 6f73 746f 7020 6973 2073 6574 2e0a 2020  ostop is set..  
+00014d40: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00014d50: 7374 6174 7573 207c 2067 7265 7020 7b6e  status | grep {n
+00014d60: 616d 657d 207c 2067 7265 7020 2231 6d20  ame} | grep "1m 
+00014d70: 2864 6f77 6e29 2227 2c0a 2020 2020 2020  (down)"',.      
+00014d80: 2020 2020 2020 2320 456e 7375 7265 2074        # Ensure t
+00014d90: 6865 2063 6c75 7374 6572 2069 7320 6e6f  he cluster is no
+00014da0: 7420 7465 726d 696e 6174 6564 2065 6172  t terminated ear
+00014db0: 6c79 2e0a 2020 2020 2020 2020 2020 2020  ly..            
+00014dc0: 2773 6c65 6570 2034 3027 2c0a 2020 2020  'sleep 40',.    
+00014dd0: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
+00014de0: 7920 7374 6174 7573 207b 6e61 6d65 7d20  y status {name} 
+00014df0: 2d2d 7265 6672 6573 6829 3b20 6563 686f  --refresh); echo
+00014e00: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
+00014e10: 6f3b 2065 6368 6f20 2224 7322 2020 7c20  o; echo "$s"  | 
+00014e20: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
+00014e30: 6570 2055 5027 2c0a 2020 2020 2020 2020  ep UP',.        
+00014e40: 2020 2020 2320 456e 7375 7265 2074 6865      # Ensure the
+00014e50: 2063 6c75 7374 6572 2069 7320 7465 726d   cluster is term
+00014e60: 696e 6174 6564 2e0a 2020 2020 2020 2020  inated..        
+00014e70: 2020 2020 6627 736c 6565 7020 7b61 7574      f'sleep {aut
+00014e80: 6f64 6f77 6e5f 7469 6d65 6f75 747d 272c  odown_timeout}',
+00014e90: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00014ea0: 3d24 2853 4b59 5049 4c4f 545f 4445 4255  =$(SKYPILOT_DEBU
+00014eb0: 473d 3020 736b 7920 7374 6174 7573 207b  G=0 sky status {
+00014ec0: 6e61 6d65 7d20 2d2d 7265 6672 6573 6829  name} --refresh)
+00014ed0: 2026 2620 6563 686f 2022 2473 2220 2626   && echo "$s" &&
+00014ee0: 207b 7b20 6563 686f 2022 2473 2220 7c20   {{ echo "$s" | 
+00014ef0: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
+00014f00: 6570 2022 4175 746f 646f 776e 6564 2063  ep "Autodowned c
+00014f10: 6c75 7374 6572 5c7c 7465 726d 696e 6174  luster\|terminat
+00014f20: 6564 206f 6e20 7468 6520 636c 6f75 6422  ed on the cloud"
+00014f30: 3b20 7d7d 207c 7c20 7b7b 2065 6368 6f20  ; }} || {{ echo 
+00014f40: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+00014f50: 657d 2026 2620 6578 6974 2031 207c 7c20  e} && exit 1 || 
+00014f60: 6578 6974 2030 3b20 7d7d 272c 0a20 2020  exit 0; }}',.   
+00014f70: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00014f80: 6175 6e63 6820 2d79 202d 6420 2d63 207b  aunch -y -d -c {
+00014f90: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+00014fa0: 656e 6572 6963 5f63 6c6f 7564 7d20 2d2d  eneric_cloud} --
+00014fb0: 6e75 6d2d 6e6f 6465 7320 3220 2d2d 646f  num-nodes 2 --do
+00014fc0: 776e 2074 6573 7473 2f74 6573 745f 7961  wn tests/test_ya
+00014fd0: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
+00014fe0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00014ff0: 2773 6b79 2073 7461 7475 7320 7c20 6772  'sky status | gr
+00015000: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
+00015010: 2055 5027 2c20 2023 2045 6e73 7572 6520   UP',  # Ensure 
+00015020: 7468 6520 636c 7573 7465 7220 6973 2055  the cluster is U
+00015030: 502e 0a20 2020 2020 2020 2020 2020 2066  P..            f
+00015040: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00015050: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+00015060: 635f 636c 6f75 647d 2074 6573 7473 2f74  c_cloud} tests/t
+00015070: 6573 745f 7961 6d6c 732f 6d69 6e69 6d61  est_yamls/minima
+00015080: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
+00015090: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
+000150a0: 7320 7c20 6772 6570 207b 6e61 6d65 7d20  s | grep {name} 
+000150b0: 7c20 6772 6570 2022 316d 2028 646f 776e  | grep "1m (down
+000150c0: 2922 272c 0a20 2020 2020 2020 2020 2020  )"',.           
+000150d0: 2066 2773 6c65 6570 207b 6175 746f 646f   f'sleep {autodo
+000150e0: 776e 5f74 696d 656f 7574 7d27 2c0a 2020  wn_timeout}',.  
+000150f0: 2020 2020 2020 2020 2020 2320 456e 7375            # Ensu
+00015100: 7265 2074 6865 2063 6c75 7374 6572 2069  re the cluster i
+00015110: 7320 7465 726d 696e 6174 6564 2e0a 2020  s terminated..  
+00015120: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+00015130: 534b 5950 494c 4f54 5f44 4542 5547 3d30  SKYPILOT_DEBUG=0
+00015140: 2073 6b79 2073 7461 7475 7320 7b6e 616d   sky status {nam
+00015150: 657d 202d 2d72 6566 7265 7368 2920 2626  e} --refresh) &&
+00015160: 2065 6368 6f20 2224 7322 2026 2620 7b7b   echo "$s" && {{
+00015170: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+00015180: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
+00015190: 2241 7574 6f64 6f77 6e65 6420 636c 7573  "Autodowned clus
+000151a0: 7465 725c 7c74 6572 6d69 6e61 7465 6420  ter\|terminated 
+000151b0: 6f6e 2074 6865 2063 6c6f 7564 223b 207d  on the cloud"; }
+000151c0: 7d20 7c7c 207b 7b20 6563 686f 2022 2473  } || {{ echo "$s
+000151d0: 2220 7c20 6772 6570 207b 6e61 6d65 7d20  " | grep {name} 
+000151e0: 2626 2065 7869 7420 3120 7c7c 2065 7869  && exit 1 || exi
+000151f0: 7420 303b 207d 7d27 2c0a 2020 2020 2020  t 0; }}',.      
+00015200: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00015210: 6368 202d 7920 2d64 202d 6320 7b6e 616d  ch -y -d -c {nam
+00015220: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
+00015230: 7269 635f 636c 6f75 647d 202d 2d6e 756d  ric_cloud} --num
+00015240: 2d6e 6f64 6573 2032 202d 2d64 6f77 6e20  -nodes 2 --down 
+00015250: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+00015260: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
+00015270: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00015280: 7920 6175 746f 7374 6f70 202d 7920 7b6e  y autostop -y {n
+00015290: 616d 657d 202d 2d63 616e 6365 6c27 2c0a  ame} --cancel',.
+000152a0: 2020 2020 2020 2020 2020 2020 6627 736c              f'sl
+000152b0: 6565 7020 7b61 7574 6f64 6f77 6e5f 7469  eep {autodown_ti
+000152c0: 6d65 6f75 747d 272c 0a20 2020 2020 2020  meout}',.       
+000152d0: 2020 2020 2023 2045 6e73 7572 6520 7468       # Ensure th
+000152e0: 6520 636c 7573 7465 7220 6973 2073 7469  e cluster is sti
+000152f0: 6c6c 2055 502e 0a20 2020 2020 2020 2020  ll UP..         
+00015300: 2020 2066 2773 3d24 2853 4b59 5049 4c4f     f's=$(SKYPILO
+00015310: 545f 4445 4255 473d 3020 736b 7920 7374  T_DEBUG=0 sky st
+00015320: 6174 7573 207b 6e61 6d65 7d20 2d2d 7265  atus {name} --re
+00015330: 6672 6573 6829 2026 2620 6563 686f 2022  fresh) && echo "
+00015340: 2473 2220 2626 2065 6368 6f20 2224 7322  $s" && echo "$s"
+00015350: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+00015360: 2067 7265 7020 5550 272c 0a20 2020 2020   grep UP',.     
+00015370: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+00015380: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+00015390: 657d 272c 0a20 2020 2020 2020 2074 696d  e}',.        tim
+000153a0: 656f 7574 3d74 6f74 616c 5f74 696d 656f  eout=total_timeo
+000153b0: 7574 5f6d 696e 7574 6573 202a 2036 302c  ut_minutes * 60,
+000153c0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+000153d0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+000153e0: 4070 7974 6573 742e 6d61 726b 2e73 6370  @pytest.mark.scp
+000153f0: 0a64 6566 2074 6573 745f 7363 705f 6175  .def test_scp_au
+00015400: 746f 646f 776e 2829 3a0a 2020 2020 6e61  todown():.    na
+00015410: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00015420: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+00015430: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00015440: 2020 2753 4350 5f61 7574 6f64 6f77 6e27    'SCP_autodown'
+00015450: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00015460: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+00015470: 756e 6368 202d 7920 2d64 202d 6320 7b6e  unch -y -d -c {n
+00015480: 616d 657d 207b 5343 505f 5459 5045 7d20  ame} {SCP_TYPE} 
+00015490: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+000154a0: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
+000154b0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000154c0: 7920 6175 746f 7374 6f70 202d 7920 7b6e  y autostop -y {n
+000154d0: 616d 657d 202d 2d64 6f77 6e20 2d69 2031  ame} --down -i 1
+000154e0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+000154f0: 2045 6e73 7572 6520 6175 746f 7374 6f70   Ensure autostop
+00015500: 2069 7320 7365 742e 0a20 2020 2020 2020   is set..       
+00015510: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
+00015520: 7320 7c20 6772 6570 207b 6e61 6d65 7d20  s | grep {name} 
+00015530: 7c20 6772 6570 2022 316d 2028 646f 776e  | grep "1m (down
+00015540: 2922 272c 0a20 2020 2020 2020 2020 2020  )"',.           
+00015550: 2023 2045 6e73 7572 6520 7468 6520 636c   # Ensure the cl
+00015560: 7573 7465 7220 6973 206e 6f74 2074 6572  uster is not ter
+00015570: 6d69 6e61 7465 6420 6561 726c 792e 0a20  minated early.. 
+00015580: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00015590: 7020 3435 272c 0a20 2020 2020 2020 2020  p 45',.         
+000155a0: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
+000155b0: 2d2d 7265 6672 6573 6820 7c20 6772 6570  --refresh | grep
+000155c0: 207b 6e61 6d65 7d20 7c20 6772 6570 2055   {name} | grep U
+000155d0: 5027 2c0a 2020 2020 2020 2020 2020 2020  P',.            
+000155e0: 2320 456e 7375 7265 2074 6865 2063 6c75  # Ensure the clu
+000155f0: 7374 6572 2069 7320 7465 726d 696e 6174  ster is terminat
+00015600: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00015610: 2773 6c65 6570 2032 3030 272c 0a20 2020  'sleep 200',.   
+00015620: 2020 2020 2020 2020 2066 2773 3d24 2853           f's=$(S
+00015630: 4b59 5049 4c4f 545f 4445 4255 473d 3020  KYPILOT_DEBUG=0 
+00015640: 736b 7920 7374 6174 7573 202d 2d72 6566  sky status --ref
+00015650: 7265 7368 2920 2626 2070 7269 6e74 6620  resh) && printf 
+00015660: 2224 7322 2026 2620 7b7b 2065 6368 6f20  "$s" && {{ echo 
+00015670: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+00015680: 657d 207c 2067 7265 7020 2241 7574 6f64  e} | grep "Autod
+00015690: 6f77 6e65 6420 636c 7573 7465 725c 7c74  owned cluster\|t
+000156a0: 6572 6d69 6e61 7465 6420 6f6e 2074 6865  erminated on the
+000156b0: 2063 6c6f 7564 223b 207d 7d20 7c7c 207b   cloud"; }} || {
+000156c0: 7b20 6563 686f 2022 2473 2220 7c20 6772  { echo "$s" | gr
+000156d0: 6570 207b 6e61 6d65 7d20 2626 2065 7869  ep {name} && exi
+000156e0: 7420 3120 7c7c 2065 7869 7420 303b 207d  t 1 || exit 0; }
+000156f0: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+00015700: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00015710: 2d64 202d 6320 7b6e 616d 657d 207b 5343  -d -c {name} {SC
+00015720: 505f 5459 5045 7d20 2d2d 646f 776e 2074  P_TYPE} --down t
+00015730: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+00015740: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
+00015750: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00015760: 2073 7461 7475 7320 7c20 6772 6570 207b   status | grep {
+00015770: 6e61 6d65 7d20 7c20 6772 6570 2055 5027  name} | grep UP'
+00015780: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+00015790: 636c 7573 7465 7220 6973 2055 502e 0a20  cluster is UP.. 
+000157a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000157b0: 2065 7865 6320 7b6e 616d 657d 207b 5343   exec {name} {SC
+000157c0: 505f 5459 5045 7d20 7465 7374 732f 7465  P_TYPE} tests/te
+000157d0: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
+000157e0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+000157f0: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
+00015800: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+00015810: 2067 7265 7020 2231 6d20 2864 6f77 6e29   grep "1m (down)
+00015820: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00015830: 2773 6c65 6570 2032 3030 272c 0a20 2020  'sleep 200',.   
+00015840: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
+00015850: 6520 7468 6520 636c 7573 7465 7220 6973  e the cluster is
+00015860: 2074 6572 6d69 6e61 7465 642e 0a20 2020   terminated..   
+00015870: 2020 2020 2020 2020 2066 2773 3d24 2853           f's=$(S
+00015880: 4b59 5049 4c4f 545f 4445 4255 473d 3020  KYPILOT_DEBUG=0 
+00015890: 736b 7920 7374 6174 7573 202d 2d72 6566  sky status --ref
+000158a0: 7265 7368 2920 2626 2070 7269 6e74 6620  resh) && printf 
+000158b0: 2224 7322 2026 2620 7b7b 2065 6368 6f20  "$s" && {{ echo 
+000158c0: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+000158d0: 657d 207c 2067 7265 7020 2241 7574 6f64  e} | grep "Autod
+000158e0: 6f77 6e65 6420 636c 7573 7465 725c 7c74  owned cluster\|t
+000158f0: 6572 6d69 6e61 7465 6420 6f6e 2074 6865  erminated on the
+00015900: 2063 6c6f 7564 223b 207d 7d20 7c7c 207b   cloud"; }} || {
+00015910: 7b20 6563 686f 2022 2473 2220 7c20 6772  { echo "$s" | gr
+00015920: 6570 207b 6e61 6d65 7d20 2626 2065 7869  ep {name} && exi
+00015930: 7420 3120 7c7c 2065 7869 7420 303b 207d  t 1 || exit 0; }
+00015940: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+00015950: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00015960: 2d64 202d 6320 7b6e 616d 657d 207b 5343  -d -c {name} {SC
+00015970: 505f 5459 5045 7d20 2d2d 646f 776e 2074  P_TYPE} --down t
+00015980: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+00015990: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
+000159a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000159b0: 2061 7574 6f73 746f 7020 2d79 207b 6e61   autostop -y {na
+000159c0: 6d65 7d20 2d2d 6361 6e63 656c 272c 0a20  me} --cancel',. 
+000159d0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+000159e0: 7020 3230 3027 2c0a 2020 2020 2020 2020  p 200',.        
+000159f0: 2020 2020 2320 456e 7375 7265 2074 6865      # Ensure the
+00015a00: 2063 6c75 7374 6572 2069 7320 7374 696c   cluster is stil
+00015a10: 6c20 5550 2e0a 2020 2020 2020 2020 2020  l UP..          
+00015a20: 2020 6627 733d 2428 534b 5950 494c 4f54    f's=$(SKYPILOT
+00015a30: 5f44 4542 5547 3d30 2073 6b79 2073 7461  _DEBUG=0 sky sta
+00015a40: 7475 7320 2d2d 7265 6672 6573 6829 2026  tus --refresh) &
+00015a50: 2620 7072 696e 7466 2022 2473 2220 2626  & printf "$s" &&
+00015a60: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+00015a70: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
+00015a80: 5550 272c 0a20 2020 2020 2020 205d 2c0a  UP',.        ],.
+00015a90: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+00015aa0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+00015ab0: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+00015ac0: 3520 2a20 3630 2c0a 2020 2020 290a 2020  5 * 60,.    ).  
+00015ad0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00015ae0: 6573 7429 0a0a 0a64 6566 205f 6765 745f  est)...def _get_
+00015af0: 6361 6e63 656c 5f74 6173 6b5f 7769 7468  cancel_task_with
+00015b00: 5f63 6c6f 7564 286e 616d 652c 2063 6c6f  _cloud(name, clo
+00015b10: 7564 2c20 7469 6d65 6f75 743d 3135 202a  ud, timeout=15 *
+00015b20: 2036 3029 3a0a 2020 2020 7465 7374 203d   60):.    test =
+00015b30: 2054 6573 7428 0a20 2020 2020 2020 2066   Test(.        f
+00015b40: 277b 636c 6f75 647d 2d63 616e 6365 6c2d  '{cloud}-cancel-
+00015b50: 7461 736b 272c 0a20 2020 2020 2020 205b  task',.        [
+00015b60: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00015b70: 6b79 206c 6175 6e63 6820 2d63 207b 6e61  ky launch -c {na
+00015b80: 6d65 7d20 6578 616d 706c 6573 2f72 6573  me} examples/res
+00015b90: 6e65 745f 6170 702e 7961 6d6c 202d 2d63  net_app.yaml --c
+00015ba0: 6c6f 7564 207b 636c 6f75 647d 202d 7920  loud {cloud} -y 
+00015bb0: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
+00015bc0: 2023 2057 6169 7420 7468 6520 4750 5520   # Wait the GPU 
+00015bd0: 7072 6f63 6573 7320 746f 2073 7461 7274  process to start
+00015be0: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
+00015bf0: 6c65 6570 2036 3027 2c0a 2020 2020 2020  leep 60',.      
+00015c00: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00015c10: 207b 6e61 6d65 7d20 226e 7669 6469 612d   {name} "nvidia-
+00015c20: 736d 6920 7c20 6772 6570 2070 7974 686f  smi | grep pytho
+00015c30: 6e22 272c 0a20 2020 2020 2020 2020 2020  n"',.           
+00015c40: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00015c50: 657d 2032 202d 2d73 7461 7475 7327 2c20  e} 2 --status', 
+00015c60: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+00015c70: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
+00015c80: 2020 2020 2020 2020 2066 2773 6b79 2063           f'sky c
+00015c90: 616e 6365 6c20 2d79 207b 6e61 6d65 7d20  ancel -y {name} 
+00015ca0: 3127 2c0a 2020 2020 2020 2020 2020 2020  1',.            
+00015cb0: 2773 6c65 6570 2036 3027 2c0a 2020 2020  'sleep 60',.    
+00015cc0: 2020 2020 2020 2020 2320 6368 6563 6b20          # check 
+00015cd0: 6966 2074 6865 2070 7974 686f 6e20 6a6f  if the python jo
+00015ce0: 6220 6973 2067 6f6e 652e 0a20 2020 2020  b is gone..     
+00015cf0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00015d00: 6320 7b6e 616d 657d 2022 2120 6e76 6964  c {name} "! nvid
+00015d10: 6961 2d73 6d69 207c 2067 7265 7020 7079  ia-smi | grep py
+00015d20: 7468 6f6e 2227 2c0a 2020 2020 2020 2020  thon"',.        
+00015d30: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00015d40: 6e61 6d65 7d20 3320 2d2d 7374 6174 7573  name} 3 --status
+00015d50: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+00015d60: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+00015d70: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00015d80: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+00015d90: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
+00015da0: 2020 7469 6d65 6f75 743d 7469 6d65 6f75    timeout=timeou
+00015db0: 742c 0a20 2020 2029 0a20 2020 2072 6574  t,.    ).    ret
+00015dc0: 7572 6e20 7465 7374 0a0a 0a23 202d 2d2d  urn test...# ---
+00015dd0: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
+00015de0: 6073 6b79 2063 616e 6365 6c60 202d 2d2d  `sky cancel` ---
+00015df0: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
+00015e00: 6d61 726b 2e61 7773 0a40 7079 7465 7374  mark.aws.@pytest
+00015e10: 2e6d 6172 6b2e 736b 6970 280a 2020 2020  .mark.skip(.    
+00015e20: 7265 6173 6f6e 3d27 5468 6520 7265 736e  reason='The resn
+00015e30: 6574 5f61 7070 2069 7320 666c 616b 792c  et_app is flaky,
+00015e40: 2064 7565 2074 6f20 5446 2066 6169 6c69   due to TF faili
+00015e50: 6e67 2074 6f20 6465 7465 6374 2047 5055  ng to detect GPU
+00015e60: 732e 2729 0a64 6566 2074 6573 745f 6361  s.').def test_ca
+00015e70: 6e63 656c 5f61 7773 2829 3a0a 2020 2020  ncel_aws():.    
+00015e80: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00015e90: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+00015ea0: 6573 7420 3d20 5f67 6574 5f63 616e 6365  est = _get_cance
+00015eb0: 6c5f 7461 736b 5f77 6974 685f 636c 6f75  l_task_with_clou
+00015ec0: 6428 6e61 6d65 2c20 2761 7773 2729 0a20  d(name, 'aws'). 
+00015ed0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00015ee0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00015ef0: 6d61 726b 2e67 6370 0a40 7079 7465 7374  mark.gcp.@pytest
+00015f00: 2e6d 6172 6b2e 736b 6970 280a 2020 2020  .mark.skip(.    
+00015f10: 7265 6173 6f6e 3d27 5468 6520 7265 736e  reason='The resn
+00015f20: 6574 5f61 7070 2069 7320 666c 616b 792c  et_app is flaky,
+00015f30: 2064 7565 2074 6f20 5446 2066 6169 6c69   due to TF faili
+00015f40: 6e67 2074 6f20 6465 7465 6374 2047 5055  ng to detect GPU
+00015f50: 732e 2729 0a64 6566 2074 6573 745f 6361  s.').def test_ca
+00015f60: 6e63 656c 5f67 6370 2829 3a0a 2020 2020  ncel_gcp():.    
+00015f70: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00015f80: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+00015f90: 6573 7420 3d20 5f67 6574 5f63 616e 6365  est = _get_cance
+00015fa0: 6c5f 7461 736b 5f77 6974 685f 636c 6f75  l_task_with_clou
+00015fb0: 6428 6e61 6d65 2c20 2767 6370 2729 0a20  d(name, 'gcp'). 
+00015fc0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00015fd0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00015fe0: 6d61 726b 2e61 7a75 7265 0a40 7079 7465  mark.azure.@pyte
+00015ff0: 7374 2e6d 6172 6b2e 736b 6970 280a 2020  st.mark.skip(.  
+00016000: 2020 7265 6173 6f6e 3d27 5468 6520 7265    reason='The re
+00016010: 736e 6574 5f61 7070 2069 7320 666c 616b  snet_app is flak
+00016020: 792c 2064 7565 2074 6f20 5446 2066 6169  y, due to TF fai
+00016030: 6c69 6e67 2074 6f20 6465 7465 6374 2047  ling to detect G
+00016040: 5055 732e 2729 0a64 6566 2074 6573 745f  PUs.').def test_
+00016050: 6361 6e63 656c 5f61 7a75 7265 2829 3a0a  cancel_azure():.
+00016060: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00016070: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00016080: 2020 2074 6573 7420 3d20 5f67 6574 5f63     test = _get_c
+00016090: 616e 6365 6c5f 7461 736b 5f77 6974 685f  ancel_task_with_
+000160a0: 636c 6f75 6428 6e61 6d65 2c20 2761 7a75  cloud(name, 'azu
+000160b0: 7265 272c 2074 696d 656f 7574 3d33 3020  re', timeout=30 
+000160c0: 2a20 3630 290a 2020 2020 7275 6e5f 6f6e  * 60).    run_on
+000160d0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+000160e0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6c  pytest.mark.no_l
+000160f0: 616d 6264 615f 636c 6f75 6420 2023 204c  ambda_cloud  # L
+00016100: 616d 6264 6120 436c 6f75 6420 646f 6573  ambda Cloud does
+00016110: 206e 6f74 2068 6176 6520 5631 3030 2067   not have V100 g
+00016120: 7075 730a 4070 7974 6573 742e 6d61 726b  pus.@pytest.mark
+00016130: 2e6e 6f5f 6962 6d20 2023 2049 424d 2063  .no_ibm  # IBM c
+00016140: 6c6f 7564 2063 7572 7265 6e74 6c79 2064  loud currently d
+00016150: 6f65 736e 2774 2070 726f 7669 6465 2070  oesn't provide p
+00016160: 7562 6c69 6320 696d 6167 6520 7769 7468  ublic image with
+00016170: 2043 5544 410a 4070 7974 6573 742e 6d61   CUDA.@pytest.ma
+00016180: 726b 2e6e 6f5f 7061 7065 7273 7061 6365  rk.no_paperspace
+00016190: 2020 2320 5061 7065 7273 7061 6365 2068    # Paperspace h
+000161a0: 6173 2060 676e 6f6d 652d 7368 656c 6c60  as `gnome-shell`
+000161b0: 206f 6e20 6e76 6964 6961 2d73 6d69 0a40   on nvidia-smi.@
+000161c0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f73  pytest.mark.no_s
+000161d0: 6370 2020 2320 5343 5020 646f 6573 206e  cp  # SCP does n
+000161e0: 6f74 2073 7570 706f 7274 206e 756d 5f6e  ot support num_n
+000161f0: 6f64 6573 203e 2031 2079 6574 0a64 6566  odes > 1 yet.def
+00016200: 2074 6573 745f 6361 6e63 656c 5f70 7974   test_cancel_pyt
+00016210: 6f72 6368 2867 656e 6572 6963 5f63 6c6f  orch(generic_clo
+00016220: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
+00016230: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00016240: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+00016250: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00016260: 2020 2763 616e 6365 6c2d 7079 746f 7263    'cancel-pytorc
+00016270: 6827 2c0a 2020 2020 2020 2020 5b0a 2020  h',.        [.  
+00016280: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00016290: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
+000162a0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+000162b0: 635f 636c 6f75 647d 2065 7861 6d70 6c65  c_cloud} example
+000162c0: 732f 7265 736e 6574 5f64 6973 7472 6962  s/resnet_distrib
+000162d0: 7574 6564 5f74 6f72 6368 2e79 616d 6c20  uted_torch.yaml 
+000162e0: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
+000162f0: 2020 2020 2320 5761 6974 2074 6865 2047      # Wait the G
+00016300: 5055 2070 726f 6365 7373 2074 6f20 7374  PU process to st
+00016310: 6172 742e 0a20 2020 2020 2020 2020 2020  art..           
+00016320: 2027 736c 6565 7020 3930 272c 0a20 2020   'sleep 90',.   
+00016330: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+00016340: 7865 6320 7b6e 616d 657d 2022 286e 7669  xec {name} "(nvi
+00016350: 6469 612d 736d 6920 7c20 6772 6570 2070  dia-smi | grep p
+00016360: 7974 686f 6e29 207c 7c20 270a 2020 2020  ython) || '.    
+00016370: 2020 2020 2020 2020 2320 5768 656e 2072          # When r
+00016380: 756e 2069 6e73 6964 6520 636f 6e74 6169  un inside contai
+00016390: 6e65 722f 6b38 732c 206e 7669 6469 612d  ner/k8s, nvidia-
+000163a0: 736d 6920 6361 6e6e 6f74 2073 686f 7720  smi cannot show 
+000163b0: 7072 6f63 6573 7320 6964 732e 0a20 2020  process ids..   
+000163c0: 2020 2020 2020 2020 2023 2053 6565 2068           # See h
+000163d0: 7474 7073 3a2f 2f67 6974 6875 622e 636f  ttps://github.co
+000163e0: 6d2f 4e56 4944 4941 2f6e 7669 6469 612d  m/NVIDIA/nvidia-
+000163f0: 646f 636b 6572 2f69 7373 7565 732f 3137  docker/issues/17
+00016400: 390a 2020 2020 2020 2020 2020 2020 2320  9.            # 
+00016410: 546f 2077 6f72 6b20 6172 6f75 6e64 2c20  To work around, 
+00016420: 7765 2063 6865 636b 2069 6620 4750 5520  we check if GPU 
+00016430: 7574 696c 697a 6174 696f 6e20 6973 2067  utilization is g
+00016440: 7265 6174 6572 2074 6861 6e20 302e 0a20  reater than 0.. 
+00016450: 2020 2020 2020 2020 2020 2066 275b 205c             f'[ \
+00016460: 2428 6e76 6964 6961 2d73 6d69 202d 2d71  $(nvidia-smi --q
+00016470: 7565 7279 2d67 7075 3d75 7469 6c69 7a61  uery-gpu=utiliza
+00016480: 7469 6f6e 2e67 7075 202d 2d66 6f72 6d61  tion.gpu --forma
+00016490: 743d 6373 762c 6e6f 6865 6164 6572 2c6e  t=csv,noheader,n
+000164a0: 6f75 6e69 7473 2920 2d67 7420 3020 5d22  ounits) -gt 0 ]"
+000164b0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000164c0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+000164d0: 2032 202d 2d73 7461 7475 7327 2c20 2023   2 --status',  #
+000164e0: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+000164f0: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+00016500: 2020 2020 2020 2066 2773 6b79 2063 616e         f'sky can
+00016510: 6365 6c20 2d79 207b 6e61 6d65 7d20 3127  cel -y {name} 1'
+00016520: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+00016530: 6c65 6570 2036 3027 2c0a 2020 2020 2020  leep 60',.      
+00016540: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00016550: 207b 6e61 6d65 7d20 2228 6e76 6964 6961   {name} "(nvidia
+00016560: 2d73 6d69 207c 2067 7265 7020 5c27 4e6f  -smi | grep \'No
+00016570: 2072 756e 6e69 6e67 2070 726f 6365 7373   running process
+00016580: 5c27 2920 7c7c 2027 0a20 2020 2020 2020  \') || '.       
+00016590: 2020 2020 2023 2045 6e73 7572 6520 586f       # Ensure Xo
+000165a0: 7267 2069 7320 7468 6520 6f6e 6c79 2070  rg is the only p
+000165b0: 726f 6365 7373 2072 756e 6e69 6e67 2e0a  rocess running..
+000165c0: 2020 2020 2020 2020 2020 2020 275b 205c              '[ \
+000165d0: 2428 6e76 6964 6961 2d73 6d69 207c 2067  $(nvidia-smi | g
+000165e0: 7265 7020 2d41 2031 3020 5072 6f63 6573  rep -A 10 Proces
+000165f0: 7365 7320 7c20 6772 6570 202d 4120 3130  ses | grep -A 10
+00016600: 203d 3d3d 207c 2067 7265 7020 2d76 2058   === | grep -v X
+00016610: 6f72 6729 202d 6571 2032 205d 2227 2c0a  org) -eq 2 ]"',.
+00016620: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00016630: 7920 6c6f 6773 207b 6e61 6d65 7d20 3320  y logs {name} 3 
+00016640: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
+00016650: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
+00016660: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+00016670: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+00016680: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+00016690: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+000166a0: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
+000166b0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+000166c0: 7428 7465 7374 290a 0a0a 2320 6361 6e27  t(test)...# can'
+000166d0: 7420 7573 6520 605f 6765 745f 6361 6e63  t use `_get_canc
+000166e0: 656c 5f74 6173 6b5f 7769 7468 5f63 6c6f  el_task_with_clo
+000166f0: 7564 2829 602c 2061 7320 636f 6d6d 616e  ud()`, as comman
+00016700: 6420 606e 7669 6469 612d 736d 6960 0a23  d `nvidia-smi`.#
+00016710: 2072 6571 7569 7265 7320 6120 4355 4441   requires a CUDA
+00016720: 2070 7562 6c69 6320 696d 6167 652c 2077   public image, w
+00016730: 6869 6368 2049 424d 2064 6f65 736e 2774  hich IBM doesn't
+00016740: 206f 6666 6572 0a40 7079 7465 7374 2e6d   offer.@pytest.m
+00016750: 6172 6b2e 6962 6d0a 6465 6620 7465 7374  ark.ibm.def test
+00016760: 5f63 616e 6365 6c5f 6962 6d28 293a 0a20  _cancel_ibm():. 
+00016770: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00016780: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00016790: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+000167a0: 2020 2020 2020 2027 6962 6d2d 6361 6e63         'ibm-canc
+000167b0: 656c 2d74 6173 6b27 2c0a 2020 2020 2020  el-task',.      
+000167c0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+000167d0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+000167e0: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
+000167f0: 6420 6962 6d20 6578 616d 706c 6573 2f6d  d ibm examples/m
+00016800: 696e 696d 616c 2e79 616d 6c27 2c0a 2020  inimal.yaml',.  
+00016810: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00016820: 6578 6563 207b 6e61 6d65 7d20 2d6e 207b  exec {name} -n {
+00016830: 6e61 6d65 7d2d 3120 2d64 2020 2277 6869  name}-1 -d  "whi
+00016840: 6c65 2074 7275 653b 2064 6f20 6563 686f  le true; do echo
+00016850: 205c 2748 656c 6c6f 2053 6b79 5069 6c6f   \'Hello SkyPilo
+00016860: 745c 273b 2073 6c65 6570 2032 3b20 646f  t\'; sleep 2; do
+00016870: 6e65 2227 2c0a 2020 2020 2020 2020 2020  ne"',.          
+00016880: 2020 2773 6c65 6570 2032 3027 2c0a 2020    'sleep 20',.  
+00016890: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000168a0: 7175 6575 6520 7b6e 616d 657d 207c 2067  queue {name} | g
+000168b0: 7265 7020 7b6e 616d 657d 2d31 207c 2067  rep {name}-1 | g
+000168c0: 7265 7020 5255 4e4e 494e 4727 2c0a 2020  rep RUNNING',.  
+000168d0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000168e0: 6361 6e63 656c 202d 7920 7b6e 616d 657d  cancel -y {name}
+000168f0: 2032 272c 0a20 2020 2020 2020 2020 2020   2',.           
+00016900: 2066 2773 6c65 6570 2035 272c 0a20 2020   f'sleep 5',.   
+00016910: 2020 2020 2020 2020 2066 2773 6b79 2071           f'sky q
+00016920: 7565 7565 207b 6e61 6d65 7d20 7c20 6772  ueue {name} | gr
+00016930: 6570 207b 6e61 6d65 7d2d 3120 7c20 6772  ep {name}-1 | gr
+00016940: 6570 2043 414e 4345 4c4c 4544 272c 0a20  ep CANCELLED',. 
+00016950: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00016960: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00016970: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00016980: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00016990: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+000169a0: 2d2d 2d2d 2054 6573 7469 6e67 2075 7365  ---- Testing use
+000169b0: 2d73 706f 7420 6f70 7469 6f6e 202d 2d2d  -spot option ---
+000169c0: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
+000169d0: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
+000169e0: 636b 2020 2320 466c 7569 6453 7461 636b  ck  # FluidStack
+000169f0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+00016a00: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
+00016a10: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00016a20: 5f61 7a75 7265 2020 2320 417a 7572 6520  _azure  # Azure 
+00016a30: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+00016a40: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
+00016a50: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00016a60: 6c61 6d62 6461 5f63 6c6f 7564 2020 2320  lambda_cloud  # 
+00016a70: 4c61 6d62 6461 2043 6c6f 7564 2064 6f65  Lambda Cloud doe
+00016a80: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
+00016a90: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
+00016aa0: 7465 7374 2e6d 6172 6b2e 6e6f 5f70 6170  test.mark.no_pap
+00016ab0: 6572 7370 6163 6520 2023 2050 6170 6572  erspace  # Paper
+00016ac0: 7370 6163 6520 646f 6573 206e 6f74 2073  space does not s
+00016ad0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+00016ae0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+00016af0: 726b 2e6e 6f5f 6962 6d20 2023 2049 424d  rk.no_ibm  # IBM
+00016b00: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
+00016b10: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
+00016b20: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+00016b30: 6172 6b2e 6e6f 5f73 6370 2020 2320 5343  ark.no_scp  # SC
+00016b40: 5020 646f 6573 206e 6f74 2073 7570 706f  P does not suppo
+00016b50: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
+00016b60: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
+00016b70: 6f5f 6b75 6265 726e 6574 6573 2020 2320  o_kubernetes  # 
+00016b80: 4b75 6265 726e 6574 6573 2064 6f65 7320  Kubernetes does 
+00016b90: 6e6f 7420 6861 7665 2061 206e 6f74 696f  not have a notio
+00016ba0: 6e20 6f66 2073 706f 7420 696e 7374 616e  n of spot instan
+00016bb0: 6365 730a 6465 6620 7465 7374 5f75 7365  ces.def test_use
+00016bc0: 5f73 706f 7428 6765 6e65 7269 635f 636c  _spot(generic_cl
+00016bd0: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
+00016be0: 2222 5465 7374 2075 7365 2d73 706f 7420  ""Test use-spot 
+00016bf0: 616e 6420 736b 7920 6578 6563 2e22 2222  and sky exec."""
+00016c00: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00016c10: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00016c20: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00016c30: 0a20 2020 2020 2020 2027 7573 652d 7370  .        'use-sp
+00016c40: 6f74 272c 0a20 2020 2020 2020 205b 0a20  ot',.        [. 
+00016c50: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00016c60: 206c 6175 6e63 6820 2d63 207b 6e61 6d65   launch -c {name
+00016c70: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+00016c80: 6963 5f63 6c6f 7564 7d20 7465 7374 732f  ic_cloud} tests/
+00016c90: 7465 7374 5f79 616d 6c73 2f6d 696e 696d  test_yamls/minim
+00016ca0: 616c 2e79 616d 6c20 2d2d 7573 652d 7370  al.yaml --use-sp
+00016cb0: 6f74 202d 7927 2c0a 2020 2020 2020 2020  ot -y',.        
+00016cc0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00016cd0: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+00016ce0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00016cf0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00016d00: 2065 6368 6f20 6869 272c 0a20 2020 2020   echo hi',.     
+00016d10: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00016d20: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
+00016d30: 7475 7327 2c0a 2020 2020 2020 2020 5d2c  tus',.        ],
+00016d40: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+00016d50: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+00016d60: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00016d70: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+00016d80: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
+00016d90: 6465 6620 7465 7374 5f73 746f 705f 6763  def test_stop_gc
+00016da0: 705f 7370 6f74 2829 3a0a 2020 2020 2222  p_spot():.    ""
+00016db0: 2254 6573 7420 4743 5020 7370 6f74 2063  "Test GCP spot c
+00016dc0: 616e 2062 6520 7374 6f70 7065 642c 2061  an be stopped, a
+00016dd0: 7574 6f73 746f 7070 6564 2c20 7265 7374  utostopped, rest
+00016de0: 6172 7465 642e 2222 220a 2020 2020 6e61  arted.""".    na
+00016df0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00016e00: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+00016e10: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00016e20: 2020 2773 746f 705f 6763 705f 7370 6f74    'stop_gcp_spot
+00016e30: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00016e40: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00016e50: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
+00016e60: 2d2d 636c 6f75 6420 6763 7020 2d2d 7573  --cloud gcp --us
+00016e70: 652d 7370 6f74 202d 2d63 7075 7320 322b  e-spot --cpus 2+
+00016e80: 202d 7920 2d2d 2074 6f75 6368 206d 7966   -y -- touch myf
+00016e90: 696c 6527 2c0a 2020 2020 2020 2020 2020  ile',.          
+00016ea0: 2020 2320 7374 6f70 2073 686f 756c 6420    # stop should 
+00016eb0: 676f 2074 6872 6f75 6768 3a0a 2020 2020  go through:.    
+00016ec0: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+00016ed0: 6f70 207b 6e61 6d65 7d20 2d79 272c 0a20  op {name} -y',. 
+00016ee0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00016ef0: 2073 7461 7274 207b 6e61 6d65 7d20 2d79   start {name} -y
+00016f00: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00016f10: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00016f20: 202d 2d20 6c73 206d 7966 696c 6527 2c0a   -- ls myfile',.
+00016f30: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00016f40: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
+00016f50: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+00016f60: 2020 2020 2020 2066 2773 6b79 2061 7574         f'sky aut
+00016f70: 6f73 746f 7020 7b6e 616d 657d 202d 6930  ostop {name} -i0
+00016f80: 202d 7927 2c0a 2020 2020 2020 2020 2020   -y',.          
+00016f90: 2020 2773 6c65 6570 2039 3027 2c0a 2020    'sleep 90',.  
+00016fa0: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+00016fb0: 736b 7920 7374 6174 7573 207b 6e61 6d65  sky status {name
+00016fc0: 7d20 2d2d 7265 6672 6573 6829 3b20 6563  } --refresh); ec
+00016fd0: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
+00016fe0: 6368 6f3b 2065 6368 6f20 2224 7322 2020  cho; echo "$s"  
+00016ff0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+00017000: 6772 6570 2053 544f 5050 4544 272c 0a20  grep STOPPED',. 
+00017010: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00017020: 2073 7461 7274 207b 6e61 6d65 7d20 2d79   start {name} -y
+00017030: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00017040: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00017050: 202d 2d20 6c73 206d 7966 696c 6527 2c0a   -- ls myfile',.
+00017060: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00017070: 7920 6c6f 6773 207b 6e61 6d65 7d20 3320  y logs {name} 3 
+00017080: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+00017090: 2020 2020 2020 2023 202d 6920 6f70 7469         # -i opti
+000170a0: 6f6e 2061 7420 6c61 756e 6368 2073 686f  on at launch sho
+000170b0: 756c 6420 676f 2074 6872 6f75 6768 3a0a  uld go through:.
+000170c0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000170d0: 7920 6c61 756e 6368 202d 6320 7b6e 616d  y launch -c {nam
+000170e0: 657d 202d 6930 202d 7927 2c0a 2020 2020  e} -i0 -y',.    
+000170f0: 2020 2020 2020 2020 2773 6c65 6570 2031          'sleep 1
+00017100: 3230 272c 0a20 2020 2020 2020 2020 2020  20',.           
+00017110: 2066 2773 3d24 2873 6b79 2073 7461 7475   f's=$(sky statu
+00017120: 7320 7b6e 616d 657d 202d 2d72 6566 7265  s {name} --refre
+00017130: 7368 293b 2065 6368 6f20 2224 7322 3b20  sh); echo "$s"; 
+00017140: 6563 686f 3b20 6563 686f 3b20 6563 686f  echo; echo; echo
+00017150: 2022 2473 2220 207c 2067 7265 7020 7b6e   "$s"  | grep {n
+00017160: 616d 657d 207c 2067 7265 7020 5354 4f50  ame} | grep STOP
+00017170: 5045 4427 2c0a 2020 2020 2020 2020 5d2c  PED',.        ],
+00017180: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+00017190: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+000171a0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+000171b0: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
+000171c0: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374   ---------- Test
+000171d0: 696e 6720 6d61 6e61 6765 6420 6a6f 6220  ing managed job 
+000171e0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
+000171f0: 7374 2e6d 6172 6b2e 6d61 6e61 6765 645f  st.mark.managed_
+00017200: 6a6f 6273 0a64 6566 2074 6573 745f 6d61  jobs.def test_ma
+00017210: 6e61 6765 645f 6a6f 6273 2867 656e 6572  naged_jobs(gener
+00017220: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+00017230: 2020 2020 2222 2254 6573 7420 7468 6520      """Test the 
+00017240: 6d61 6e61 6765 6420 6a6f 6273 2079 616d  managed jobs yam
+00017250: 6c2e 2222 220a 2020 2020 6e61 6d65 203d  l.""".    name =
+00017260: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00017270: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00017280: 5465 7374 280a 2020 2020 2020 2020 276d  Test(.        'm
+00017290: 616e 6167 6564 2d6a 6f62 7327 2c0a 2020  anaged-jobs',.  
+000172a0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+000172b0: 2020 2020 6627 736b 7920 6a6f 6273 206c      f'sky jobs l
+000172c0: 6175 6e63 6820 2d6e 207b 6e61 6d65 7d2d  aunch -n {name}-
+000172d0: 3120 2d2d 636c 6f75 6420 7b67 656e 6572  1 --cloud {gener
+000172e0: 6963 5f63 6c6f 7564 7d20 6578 616d 706c  ic_cloud} exampl
+000172f0: 6573 2f6d 616e 6167 6564 5f6a 6f62 2e79  es/managed_job.y
+00017300: 616d 6c20 2d79 202d 6427 2c0a 2020 2020  aml -y -d',.    
+00017310: 2020 2020 2020 2020 6627 736b 7920 6a6f          f'sky jo
+00017320: 6273 206c 6175 6e63 6820 2d6e 207b 6e61  bs launch -n {na
+00017330: 6d65 7d2d 3220 2d2d 636c 6f75 6420 7b67  me}-2 --cloud {g
+00017340: 656e 6572 6963 5f63 6c6f 7564 7d20 6578  eneric_cloud} ex
+00017350: 616d 706c 6573 2f6d 616e 6167 6564 5f6a  amples/managed_j
+00017360: 6f62 2e79 616d 6c20 2d79 202d 6427 2c0a  ob.yaml -y -d',.
+00017370: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00017380: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
+00017390: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+000173a0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+000173b0: 6d65 7d2d 3120 7c20 6865 6164 202d 6e31  me}-1 | head -n1
+000173c0: 207c 2067 7265 7020 2253 5441 5254 494e   | grep "STARTIN
+000173d0: 475c 7c52 554e 4e49 4e47 2227 2c0a 2020  G\|RUNNING"',.  
+000173e0: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
+000173f0: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
+00017400: 7265 7020 7b6e 616d 657d 2d32 207c 2068  rep {name}-2 | h
+00017410: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
+00017420: 5354 4152 5449 4e47 5c7c 5255 4e4e 494e  STARTING\|RUNNIN
+00017430: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+00017440: 205f 4a4f 425f 4341 4e43 454c 5f57 4149   _JOB_CANCEL_WAI
+00017450: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
+00017460: 653d 6627 7b6e 616d 657d 2d31 2729 2c0a  e=f'{name}-1'),.
+00017470: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00017480: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
+00017490: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+000174a0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+000174b0: 6d65 7d2d 3120 7c20 6865 6164 202d 6e31  me}-1 | head -n1
+000174c0: 207c 2067 7265 7020 2243 414e 4345 4c4c   | grep "CANCELL
+000174d0: 494e 475c 7c43 414e 4345 4c4c 4544 2227  ING\|CANCELLED"'
+000174e0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+000174f0: 6c65 6570 2032 3030 272c 0a20 2020 2020  leep 200',.     
+00017500: 2020 2020 2020 2066 277b 5f4a 4f42 5f51         f'{_JOB_Q
+00017510: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+00017520: 207b 6e61 6d65 7d2d 3120 7c20 6865 6164   {name}-1 | head
+00017530: 202d 6e31 207c 2067 7265 7020 4341 4e43   -n1 | grep CANC
+00017540: 454c 4c45 4427 2c0a 2020 2020 2020 2020  ELLED',.        
+00017550: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+00017560: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+00017570: 616d 657d 2d32 207c 2068 6561 6420 2d6e  ame}-2 | head -n
+00017580: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
+00017590: 475c 7c53 5543 4345 4544 4544 2227 2c0a  G\|SUCCEEDED"',.
+000175a0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+000175b0: 2020 2023 2054 4f44 4f28 7a68 7775 293a     # TODO(zhwu):
+000175c0: 2043 6861 6e67 6520 746f 205f 4a4f 425f   Change to _JOB_
+000175d0: 4341 4e43 454c 5f57 4149 542e 666f 726d  CANCEL_WAIT.form
+000175e0: 6174 286a 6f62 5f6e 616d 653d 6627 7b6e  at(job_name=f'{n
+000175f0: 616d 657d 2d31 202d 6e20 7b6e 616d 657d  ame}-1 -n {name}
+00017600: 2d32 2729 2077 6865 6e0a 2020 2020 2020  -2') when.      
+00017610: 2020 2320 6361 6e63 656c 696e 6720 6d75    # canceling mu
+00017620: 6c74 6970 6c65 206a 6f62 206e 616d 6573  ltiple job names
+00017630: 2069 7320 7375 7070 6f72 7465 642e 0a20   is supported.. 
+00017640: 2020 2020 2020 2028 5f4a 4f42 5f43 414e         (_JOB_CAN
+00017650: 4345 4c5f 5741 4954 2e66 6f72 6d61 7428  CEL_WAIT.format(
+00017660: 6a6f 625f 6e61 6d65 3d66 277b 6e61 6d65  job_name=f'{name
+00017670: 7d2d 3127 2920 2b20 273b 2027 202b 0a20  }-1') + '; ' +. 
+00017680: 2020 2020 2020 2020 5f4a 4f42 5f43 414e          _JOB_CAN
+00017690: 4345 4c5f 5741 4954 2e66 6f72 6d61 7428  CEL_WAIT.format(
+000176a0: 6a6f 625f 6e61 6d65 3d66 277b 6e61 6d65  job_name=f'{name
+000176b0: 7d2d 3227 2929 2c0a 2020 2020 2020 2020  }-2')),.        
+000176c0: 2320 496e 6372 6561 7365 2074 696d 656f  # Increase timeo
+000176d0: 7574 2073 696e 6365 2073 6b79 206a 6f62  ut since sky job
+000176e0: 7320 7175 6575 6520 2d72 2063 616e 2062  s queue -r can b
+000176f0: 6520 626c 6f63 6b65 6420 6279 206f 7468  e blocked by oth
+00017700: 6572 2073 706f 7420 7465 7374 732e 0a20  er spot tests.. 
+00017710: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+00017720: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
+00017730: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00017740: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00017750: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
+00017760: 6b20 2023 666c 7569 6473 7461 636b 2064  k  #fluidstack d
+00017770: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+00017780: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
+00017790: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f61  pytest.mark.no_a
+000177a0: 7a75 7265 2020 2320 417a 7572 6520 646f  zure  # Azure do
+000177b0: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
+000177c0: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
+000177d0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6c61  ytest.mark.no_la
+000177e0: 6d62 6461 5f63 6c6f 7564 2020 2320 4c61  mbda_cloud  # La
+000177f0: 6d62 6461 2043 6c6f 7564 2064 6f65 7320  mbda Cloud does 
+00017800: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+00017810: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+00017820: 7374 2e6d 6172 6b2e 6e6f 5f69 626d 2020  st.mark.no_ibm  
+00017830: 2320 4942 4d20 436c 6f75 6420 646f 6573  # IBM Cloud does
+00017840: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
+00017850: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
+00017860: 6573 742e 6d61 726b 2e6e 6f5f 7363 7020  est.mark.no_scp 
+00017870: 2023 2053 4350 2064 6f65 7320 6e6f 7420   # SCP does not 
+00017880: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
+00017890: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+000178a0: 6172 6b2e 6e6f 5f70 6170 6572 7370 6163  ark.no_paperspac
+000178b0: 6520 2023 2050 6170 6572 7370 6163 6520  e  # Paperspace 
+000178c0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+000178d0: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
+000178e0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+000178f0: 6b75 6265 726e 6574 6573 2020 2320 4b75  kubernetes  # Ku
+00017900: 6265 726e 6574 6573 2064 6f65 7320 6e6f  bernetes does no
+00017910: 7420 6861 7665 2061 206e 6f74 696f 6e20  t have a notion 
+00017920: 6f66 2073 706f 7420 696e 7374 616e 6365  of spot instance
+00017930: 730a 4070 7974 6573 742e 6d61 726b 2e6d  s.@pytest.mark.m
+00017940: 616e 6167 6564 5f6a 6f62 730a 6465 6620  anaged_jobs.def 
+00017950: 7465 7374 5f6a 6f62 5f70 6970 656c 696e  test_job_pipelin
+00017960: 6528 6765 6e65 7269 635f 636c 6f75 643a  e(generic_cloud:
+00017970: 2073 7472 293a 0a20 2020 2022 2222 5465   str):.    """Te
+00017980: 7374 2061 206a 6f62 2070 6970 656c 696e  st a job pipelin
+00017990: 652e 2222 220a 2020 2020 6e61 6d65 203d  e.""".    name =
+000179a0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+000179b0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+000179c0: 5465 7374 280a 2020 2020 2020 2020 2773  Test(.        's
+000179d0: 706f 742d 7069 7065 6c69 6e65 272c 0a20  pot-pipeline',. 
+000179e0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+000179f0: 2020 2020 2066 2773 6b79 206a 6f62 7320       f'sky jobs 
+00017a00: 6c61 756e 6368 202d 6e20 7b6e 616d 657d  launch -n {name}
+00017a10: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+00017a20: 732f 7069 7065 6c69 6e65 2e79 616d 6c20  s/pipeline.yaml 
+00017a30: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
+00017a40: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
+00017a50: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
+00017a60: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
+00017a70: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
+00017a80: 6164 202d 6e31 207c 2067 7265 7020 2253  ad -n1 | grep "S
+00017a90: 5441 5254 494e 475c 7c52 554e 4e49 4e47  TARTING\|RUNNING
+00017aa0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00017ab0: 2320 6067 7265 7020 2d41 2034 207b 6e61  # `grep -A 4 {na
+00017ac0: 6d65 7d60 2066 696e 6473 2074 6865 206a  me}` finds the j
+00017ad0: 6f62 2077 6974 6820 7b6e 616d 657d 2061  ob with {name} a
+00017ae0: 6e64 2074 6865 2034 206c 696e 6573 0a20  nd the 4 lines. 
+00017af0: 2020 2020 2020 2020 2020 2023 2061 6674             # aft
+00017b00: 6572 2069 742c 2069 2e65 2e20 7468 6520  er it, i.e. the 
+00017b10: 3420 7461 736b 7320 7769 7468 696e 2074  4 tasks within t
+00017b20: 6865 206a 6f62 2e0a 2020 2020 2020 2020  he job..        
+00017b30: 2020 2020 2320 6073 6564 202d 6e20 3270      # `sed -n 2p
+00017b40: 6020 6765 7473 2074 6865 2073 6563 6f6e  ` gets the secon
+00017b50: 6420 6c69 6e65 206f 6620 7468 6520 3420  d line of the 4 
+00017b60: 6c69 6e65 732c 2069 2e65 2e20 7468 6520  lines, i.e. the 
+00017b70: 6669 7273 740a 2020 2020 2020 2020 2020  first.          
+00017b80: 2020 2320 7461 736b 2077 6974 6869 6e20    # task within 
+00017b90: 7468 6520 6a6f 622e 0a20 2020 2020 2020  the job..       
+00017ba0: 2020 2020 2066 277b 5f4a 4f42 5f51 5545       f'{_JOB_QUE
+00017bb0: 5545 5f57 4149 547d 7c20 6772 6570 202d  UE_WAIT}| grep -
+00017bc0: 4120 3420 7b6e 616d 657d 7c20 7365 6420  A 4 {name}| sed 
+00017bd0: 2d6e 2032 7020 7c20 6772 6570 2022 5354  -n 2p | grep "ST
+00017be0: 4152 5449 4e47 5c7c 5255 4e4e 494e 4722  ARTING\|RUNNING"
+00017bf0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00017c00: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
+00017c10: 547d 7c20 6772 6570 202d 4120 3420 7b6e  T}| grep -A 4 {n
+00017c20: 616d 657d 7c20 7365 6420 2d6e 2033 7020  ame}| sed -n 3p 
+00017c30: 7c20 6772 6570 2022 5045 4e44 494e 4722  | grep "PENDING"
+00017c40: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
+00017c50: 4a4f 425f 4341 4e43 454c 5f57 4149 542e  JOB_CANCEL_WAIT.
+00017c60: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
+00017c70: 6627 7b6e 616d 657d 2729 2c0a 2020 2020  f'{name}'),.    
+00017c80: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
 00017c90: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
 00017ca0: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
 00017cb0: 547d 7c20 6772 6570 202d 4120 3420 7b6e  T}| grep -A 4 {n
 00017cc0: 616d 657d 7c20 7365 6420 2d6e 2032 7020  ame}| sed -n 2p 
-00017cd0: 7c20 6772 6570 2022 4341 4e43 454c 4c45  | grep "CANCELLE
-00017ce0: 4422 272c 0a20 2020 2020 2020 2020 2020  D"',.           
-00017cf0: 2066 277b 5f4a 4f42 5f51 5545 5545 5f57   f'{_JOB_QUEUE_W
-00017d00: 4149 547d 7c20 6772 6570 202d 4120 3420  AIT}| grep -A 4 
-00017d10: 7b6e 616d 657d 7c20 7365 6420 2d6e 2033  {name}| sed -n 3
-00017d20: 7020 7c20 6772 6570 2022 4341 4e43 454c  p | grep "CANCEL
-00017d30: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
-00017d40: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
-00017d50: 5f57 4149 547d 7c20 6772 6570 202d 4120  _WAIT}| grep -A 
-00017d60: 3420 7b6e 616d 657d 7c20 7365 6420 2d6e  4 {name}| sed -n
-00017d70: 2034 7020 7c20 6772 6570 2022 4341 4e43   4p | grep "CANC
-00017d80: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
-00017d90: 2020 2020 2066 277b 5f4a 4f42 5f51 5545       f'{_JOB_QUE
-00017da0: 5545 5f57 4149 547d 7c20 6772 6570 202d  UE_WAIT}| grep -
-00017db0: 4120 3420 7b6e 616d 657d 7c20 7365 6420  A 4 {name}| sed 
-00017dc0: 2d6e 2035 7020 7c20 6772 6570 2022 4341  -n 5p | grep "CA
-00017dd0: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
-00017de0: 2020 205d 2c0a 2020 2020 2020 2020 5f4a     ],.        _J
-00017df0: 4f42 5f43 414e 4345 4c5f 5741 4954 2e66  OB_CANCEL_WAIT.f
-00017e00: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d66  ormat(job_name=f
-00017e10: 277b 6e61 6d65 7d27 292c 0a20 2020 2020  '{name}'),.     
-00017e20: 2020 2023 2049 6e63 7265 6173 6520 7469     # Increase ti
-00017e30: 6d65 6f75 7420 7369 6e63 6520 736b 7920  meout since sky 
-00017e40: 6a6f 6273 2071 7565 7565 202d 7220 6361  jobs queue -r ca
-00017e50: 6e20 6265 2062 6c6f 636b 6564 2062 7920  n be blocked by 
-00017e60: 6f74 6865 7220 7370 6f74 2074 6573 7473  other spot tests
-00017e70: 2e0a 2020 2020 2020 2020 7469 6d65 6f75  ..        timeou
-00017e80: 743d 3330 202a 2036 302c 0a20 2020 2029  t=30 * 60,.    )
-00017e90: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00017ea0: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00017eb0: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
-00017ec0: 7461 636b 2020 2366 6c75 6964 7374 6163  tack  #fluidstac
-00017ed0: 6b20 646f 6573 206e 6f74 2073 7570 706f  k does not suppo
-00017ee0: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
-00017ef0: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
-00017f00: 6f5f 617a 7572 6520 2023 2041 7a75 7265  o_azure  # Azure
-00017f10: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00017f20: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-00017f30: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00017f40: 5f6c 616d 6264 615f 636c 6f75 6420 2023  _lambda_cloud  #
-00017f50: 204c 616d 6264 6120 436c 6f75 6420 646f   Lambda Cloud do
-00017f60: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-00017f70: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
-00017f80: 7974 6573 742e 6d61 726b 2e6e 6f5f 6962  ytest.mark.no_ib
-00017f90: 6d20 2023 2049 424d 2043 6c6f 7564 2064  m  # IBM Cloud d
-00017fa0: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-00017fb0: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-00017fc0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f73  pytest.mark.no_s
-00017fd0: 6370 2020 2320 5343 5020 646f 6573 206e  cp  # SCP does n
-00017fe0: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-00017ff0: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-00018000: 742e 6d61 726b 2e6e 6f5f 7061 7065 7273  t.mark.no_papers
-00018010: 7061 6365 2020 2320 5061 7065 7273 7061  pace  # Paperspa
-00018020: 6365 2064 6f65 7320 6e6f 7420 7375 7070  ce does not supp
-00018030: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
-00018040: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-00018050: 6e6f 5f6b 7562 6572 6e65 7465 7320 2023  no_kubernetes  #
-00018060: 204b 7562 6572 6e65 7465 7320 646f 6573   Kubernetes does
-00018070: 206e 6f74 2068 6176 6520 6120 6e6f 7469   not have a noti
-00018080: 6f6e 206f 6620 7370 6f74 2069 6e73 7461  on of spot insta
-00018090: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-000180a0: 6b2e 6d61 6e61 6765 645f 6a6f 6273 0a64  k.managed_jobs.d
-000180b0: 6566 2074 6573 745f 6d61 6e61 6765 645f  ef test_managed_
-000180c0: 6a6f 6273 5f66 6169 6c65 645f 7365 7475  jobs_failed_setu
-000180d0: 7028 6765 6e65 7269 635f 636c 6f75 643a  p(generic_cloud:
-000180e0: 2073 7472 293a 0a20 2020 2022 2222 5465   str):.    """Te
-000180f0: 7374 206d 616e 6167 6564 206a 6f62 2077  st managed job w
-00018100: 6974 6820 6661 696c 6564 2073 6574 7570  ith failed setup
-00018110: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
-00018120: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00018130: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00018140: 6573 7428 0a20 2020 2020 2020 2027 6d61  est(.        'ma
-00018150: 6e61 6765 645f 6a6f 6273 5f66 6169 6c65  naged_jobs_faile
-00018160: 645f 7365 7475 7027 2c0a 2020 2020 2020  d_setup',.      
-00018170: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00018180: 6627 736b 7920 6a6f 6273 206c 6175 6e63  f'sky jobs launc
-00018190: 6820 2d6e 207b 6e61 6d65 7d20 2d2d 636c  h -n {name} --cl
-000181a0: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-000181b0: 7564 7d20 2d79 202d 6420 7465 7374 732f  ud} -y -d tests/
-000181c0: 7465 7374 5f79 616d 6c73 2f66 6169 6c65  test_yamls/faile
-000181d0: 645f 7365 7475 702e 7961 6d6c 272c 0a20  d_setup.yaml',. 
-000181e0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-000181f0: 7020 3333 3027 2c0a 2020 2020 2020 2020  p 330',.        
-00018200: 2020 2020 2320 4d61 6b65 2073 7572 6520      # Make sure 
-00018210: 7468 6520 6a6f 6220 6661 696c 6564 2071  the job failed q
-00018220: 7569 636b 6c79 2e0a 2020 2020 2020 2020  uickly..        
-00018230: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
-00018240: 455f 5741 4954 7d20 7c20 6772 6570 207b  E_WAIT} | grep {
-00018250: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
-00018260: 207c 2067 7265 7020 2246 4149 4c45 445f   | grep "FAILED_
-00018270: 5345 5455 5022 272c 0a20 2020 2020 2020  SETUP"',.       
-00018280: 205d 2c0a 2020 2020 2020 2020 5f4a 4f42   ],.        _JOB
-00018290: 5f43 414e 4345 4c5f 5741 4954 2e66 6f72  _CANCEL_WAIT.for
-000182a0: 6d61 7428 6a6f 625f 6e61 6d65 3d6e 616d  mat(job_name=nam
-000182b0: 6529 2c0a 2020 2020 2020 2020 2320 496e  e),.        # In
-000182c0: 6372 6561 7365 2074 696d 656f 7574 2073  crease timeout s
-000182d0: 696e 6365 2073 6b79 206a 6f62 7320 7175  ince sky jobs qu
-000182e0: 6575 6520 2d72 2063 616e 2062 6520 626c  eue -r can be bl
-000182f0: 6f63 6b65 6420 6279 206f 7468 6572 2073  ocked by other s
-00018300: 706f 7420 7465 7374 732e 0a20 2020 2020  pot tests..     
-00018310: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
-00018320: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-00018330: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00018340: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00018350: 6e6f 5f66 6c75 6964 7374 6163 6b20 2023  no_fluidstack  #
-00018360: 666c 7569 6473 7461 636b 2064 6f65 7320  fluidstack does 
-00018370: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-00018380: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-00018390: 7374 2e6d 6172 6b2e 6e6f 5f61 7a75 7265  st.mark.no_azure
-000183a0: 2020 2320 417a 7572 6520 646f 6573 206e    # Azure does n
-000183b0: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-000183c0: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-000183d0: 742e 6d61 726b 2e6e 6f5f 6c61 6d62 6461  t.mark.no_lambda
-000183e0: 5f63 6c6f 7564 2020 2320 4c61 6d62 6461  _cloud  # Lambda
-000183f0: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
-00018400: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
-00018410: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
-00018420: 6172 6b2e 6e6f 5f69 626d 2020 2320 4942  ark.no_ibm  # IB
-00018430: 4d20 436c 6f75 6420 646f 6573 206e 6f74  M Cloud does not
-00018440: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-00018450: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-00018460: 6d61 726b 2e6e 6f5f 7363 7020 2023 2053  mark.no_scp  # S
-00018470: 4350 2064 6f65 7320 6e6f 7420 7375 7070  CP does not supp
-00018480: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
-00018490: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-000184a0: 6e6f 5f70 6170 6572 7370 6163 6520 2023  no_paperspace  #
-000184b0: 2050 6170 6572 7370 6163 6520 646f 6573   Paperspace does
-000184c0: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
-000184d0: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-000184e0: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
-000184f0: 726e 6574 6573 2020 2320 4b75 6265 726e  rnetes  # Kubern
-00018500: 6574 6573 2064 6f65 7320 6e6f 7420 6861  etes does not ha
-00018510: 7665 2061 206e 6f74 696f 6e20 6f66 2073  ve a notion of s
-00018520: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
-00018530: 7974 6573 742e 6d61 726b 2e6d 616e 6167  ytest.mark.manag
-00018540: 6564 5f6a 6f62 730a 6465 6620 7465 7374  ed_jobs.def test
-00018550: 5f6d 616e 6167 6564 5f6a 6f62 735f 7069  _managed_jobs_pi
-00018560: 7065 6c69 6e65 5f66 6169 6c65 645f 7365  peline_failed_se
-00018570: 7475 7028 6765 6e65 7269 635f 636c 6f75  tup(generic_clou
-00018580: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
-00018590: 5465 7374 206d 616e 6167 6564 206a 6f62  Test managed job
-000185a0: 2077 6974 6820 6661 696c 6564 2073 6574   with failed set
-000185b0: 7570 2066 6f72 2061 2070 6970 656c 696e  up for a pipelin
-000185c0: 652e 2222 220a 2020 2020 6e61 6d65 203d  e.""".    name =
-000185d0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-000185e0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-000185f0: 5465 7374 280a 2020 2020 2020 2020 276d  Test(.        'm
-00018600: 616e 6167 6564 5f6a 6f62 735f 7069 7065  anaged_jobs_pipe
-00018610: 6c69 6e65 5f66 6169 6c65 645f 7365 7475  line_failed_setu
-00018620: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
-00018630: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00018640: 6a6f 6273 206c 6175 6e63 6820 2d6e 207b  jobs launch -n {
-00018650: 6e61 6d65 7d20 2d79 202d 6420 7465 7374  name} -y -d test
-00018660: 732f 7465 7374 5f79 616d 6c73 2f66 6169  s/test_yamls/fai
-00018670: 6c65 645f 7365 7475 705f 7069 7065 6c69  led_setup_pipeli
-00018680: 6e65 2e79 616d 6c27 2c0a 2020 2020 2020  ne.yaml',.      
-00018690: 2020 2020 2020 2773 6c65 6570 2036 3030        'sleep 600
-000186a0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-000186b0: 204d 616b 6520 7375 7265 2074 6865 206a   Make sure the j
-000186c0: 6f62 2066 6169 6c65 6420 7175 6963 6b6c  ob failed quickl
-000186d0: 792e 0a20 2020 2020 2020 2020 2020 2066  y..            f
-000186e0: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
-000186f0: 547d 207c 2067 7265 7020 7b6e 616d 657d  T} | grep {name}
-00018700: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-00018710: 6570 2022 4641 494c 4544 5f53 4554 5550  ep "FAILED_SETUP
-00018720: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00018730: 2320 5461 736b 2030 2073 686f 756c 6420  # Task 0 should 
-00018740: 6265 2053 5543 4345 4544 4544 2e0a 2020  be SUCCEEDED..  
-00018750: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
-00018760: 425f 5155 4555 455f 5741 4954 7d20 7c20  B_QUEUE_WAIT} | 
-00018770: 6772 6570 202d 4120 3420 7b6e 616d 657d  grep -A 4 {name}
-00018780: 7c20 7365 6420 2d6e 2032 7020 7c20 6772  | sed -n 2p | gr
-00018790: 6570 2022 5355 4343 4545 4445 4422 272c  ep "SUCCEEDED"',
-000187a0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-000187b0: 6173 6b20 3120 7368 6f75 6c64 2062 6520  ask 1 should be 
-000187c0: 4641 494c 4544 5f53 4554 5550 2e0a 2020  FAILED_SETUP..  
-000187d0: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
-000187e0: 425f 5155 4555 455f 5741 4954 7d20 7c20  B_QUEUE_WAIT} | 
-000187f0: 6772 6570 202d 4120 3420 7b6e 616d 657d  grep -A 4 {name}
-00018800: 7c20 7365 6420 2d6e 2033 7020 7c20 6772  | sed -n 3p | gr
-00018810: 6570 2022 4641 494c 4544 5f53 4554 5550  ep "FAILED_SETUP
-00018820: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00018830: 2320 5461 736b 2032 2073 686f 756c 6420  # Task 2 should 
-00018840: 6265 2043 414e 4345 4c4c 4544 2e0a 2020  be CANCELLED..  
-00018850: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
-00018860: 425f 5155 4555 455f 5741 4954 7d20 7c20  B_QUEUE_WAIT} | 
-00018870: 6772 6570 202d 4120 3420 7b6e 616d 657d  grep -A 4 {name}
-00018880: 7c20 7365 6420 2d6e 2034 7020 7c20 6772  | sed -n 4p | gr
-00018890: 6570 2022 4341 4e43 454c 4c45 4422 272c  ep "CANCELLED"',
-000188a0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-000188b0: 6173 6b20 3320 7368 6f75 6c64 2062 6520  ask 3 should be 
-000188c0: 4341 4e43 454c 4c45 442e 0a20 2020 2020  CANCELLED..     
-000188d0: 2020 2020 2020 2066 277b 5f4a 4f42 5f51         f'{_JOB_Q
-000188e0: 5545 5545 5f57 4149 547d 207c 2067 7265  UEUE_WAIT} | gre
-000188f0: 7020 2d41 2034 207b 6e61 6d65 7d7c 2073  p -A 4 {name}| s
-00018900: 6564 202d 6e20 3570 207c 2067 7265 7020  ed -n 5p | grep 
-00018910: 2243 414e 4345 4c4c 4544 2227 2c0a 2020  "CANCELLED"',.  
-00018920: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00018930: 205f 4a4f 425f 4341 4e43 454c 5f57 4149   _JOB_CANCEL_WAI
-00018940: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
-00018950: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
-00018960: 2023 2049 6e63 7265 6173 6520 7469 6d65   # Increase time
-00018970: 6f75 7420 7369 6e63 6520 736b 7920 6a6f  out since sky jo
-00018980: 6273 2071 7565 7565 202d 7220 6361 6e20  bs queue -r can 
-00018990: 6265 2062 6c6f 636b 6564 2062 7920 6f74  be blocked by ot
-000189a0: 6865 7220 7370 6f74 2074 6573 7473 2e0a  her spot tests..
-000189b0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-000189c0: 3330 202a 2036 302c 0a20 2020 2029 0a20  30 * 60,.    ). 
-000189d0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-000189e0: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-000189f0: 2d2d 2d2d 2054 6573 7469 6e67 206d 616e  ---- Testing man
-00018a00: 6167 6564 206a 6f62 2072 6563 6f76 6572  aged job recover
-00018a10: 7920 2d2d 2d2d 2d2d 2d2d 2d2d 0a0a 0a40  y ----------...@
-00018a20: 7079 7465 7374 2e6d 6172 6b2e 6177 730a  pytest.mark.aws.
-00018a30: 4070 7974 6573 742e 6d61 726b 2e6d 616e  @pytest.mark.man
-00018a40: 6167 6564 5f6a 6f62 730a 6465 6620 7465  aged_jobs.def te
-00018a50: 7374 5f6d 616e 6167 6564 5f6a 6f62 735f  st_managed_jobs_
-00018a60: 7265 636f 7665 7279 5f61 7773 2861 7773  recovery_aws(aws
-00018a70: 5f63 6f6e 6669 675f 7265 6769 6f6e 293a  _config_region):
-00018a80: 0a20 2020 2022 2222 5465 7374 206d 616e  .    """Test man
-00018a90: 6167 6564 206a 6f62 2072 6563 6f76 6572  aged job recover
-00018aa0: 792e 2222 220a 2020 2020 6e61 6d65 203d  y.""".    name =
-00018ab0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00018ac0: 6d65 2829 0a20 2020 206e 616d 655f 6f6e  me().    name_on
-00018ad0: 5f63 6c6f 7564 203d 2063 6f6d 6d6f 6e5f  _cloud = common_
-00018ae0: 7574 696c 732e 6d61 6b65 5f63 6c75 7374  utils.make_clust
-00018af0: 6572 5f6e 616d 655f 6f6e 5f63 6c6f 7564  er_name_on_cloud
-00018b00: 280a 2020 2020 2020 2020 6e61 6d65 2c20  (.        name, 
-00018b10: 6a6f 6273 2e4a 4f42 535f 434c 5553 5445  jobs.JOBS_CLUSTE
-00018b20: 525f 4e41 4d45 5f50 5245 4649 585f 4c45  R_NAME_PREFIX_LE
-00018b30: 4e47 5448 2c20 6164 645f 7573 6572 5f68  NGTH, add_user_h
-00018b40: 6173 683d 4661 6c73 6529 0a20 2020 2072  ash=False).    r
-00018b50: 6567 696f 6e20 3d20 6177 735f 636f 6e66  egion = aws_conf
-00018b60: 6967 5f72 6567 696f 6e0a 2020 2020 7465  ig_region.    te
-00018b70: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00018b80: 2020 2027 6d61 6e61 6765 645f 6a6f 6273     'managed_jobs
-00018b90: 5f72 6563 6f76 6572 795f 6177 7327 2c0a  _recovery_aws',.
-00018ba0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00018bb0: 2020 2020 2020 6627 736b 7920 6a6f 6273        f'sky jobs
-00018bc0: 206c 6175 6e63 6820 2d2d 636c 6f75 6420   launch --cloud 
-00018bd0: 6177 7320 2d2d 7265 6769 6f6e 207b 7265  aws --region {re
-00018be0: 6769 6f6e 7d20 2d2d 7573 652d 7370 6f74  gion} --use-spot
-00018bf0: 202d 6e20 7b6e 616d 657d 2022 6563 686f   -n {name} "echo
-00018c00: 2053 4b59 5049 4c4f 545f 5441 534b 5f49   SKYPILOT_TASK_I
-00018c10: 443a 205c 2453 4b59 5049 4c4f 545f 5441  D: \$SKYPILOT_TA
-00018c20: 534b 5f49 443b 2073 6c65 6570 2031 3830  SK_ID; sleep 180
-00018c30: 3022 2020 2d79 202d 6427 2c0a 2020 2020  0"  -y -d',.    
-00018c40: 2020 2020 2020 2020 2773 6c65 6570 2033          'sleep 3
-00018c50: 3630 272c 0a20 2020 2020 2020 2020 2020  60',.           
-00018c60: 2066 277b 5f4a 4f42 5f51 5545 5545 5f57   f'{_JOB_QUEUE_W
-00018c70: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-00018c80: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
-00018c90: 7265 7020 2252 554e 4e49 4e47 2227 2c0a  rep "RUNNING"',.
-00018ca0: 2020 2020 2020 2020 2020 2020 6627 5255              f'RU
-00018cb0: 4e5f 4944 3d24 2873 6b79 206a 6f62 7320  N_ID=$(sky jobs 
-00018cc0: 6c6f 6773 202d 6e20 7b6e 616d 657d 202d  logs -n {name} -
-00018cd0: 2d6e 6f2d 666f 6c6c 6f77 207c 2067 7265  -no-follow | gre
-00018ce0: 7020 534b 5950 494c 4f54 5f54 4153 4b5f  p SKYPILOT_TASK_
-00018cf0: 4944 207c 2063 7574 202d 643a 202d 6632  ID | cut -d: -f2
-00018d00: 293b 2065 6368 6f20 2224 5255 4e5f 4944  ); echo "$RUN_ID
-00018d10: 2220 7c20 7465 6520 2f74 6d70 2f7b 6e61  " | tee /tmp/{na
-00018d20: 6d65 7d2d 7275 6e2d 6964 272c 0a20 2020  me}-run-id',.   
-00018d30: 2020 2020 2020 2020 2023 2054 6572 6d69           # Termi
-00018d40: 6e61 7465 2074 6865 2063 6c75 7374 6572  nate the cluster
-00018d50: 206d 616e 7561 6c6c 792e 0a20 2020 2020   manually..     
-00018d60: 2020 2020 2020 2028 6627 6177 7320 6563         (f'aws ec
-00018d70: 3220 7465 726d 696e 6174 652d 696e 7374  2 terminate-inst
-00018d80: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
-00018d90: 7265 6769 6f6e 7d20 2d2d 696e 7374 616e  region} --instan
-00018da0: 6365 2d69 6473 2024 2827 0a20 2020 2020  ce-ids $('.     
-00018db0: 2020 2020 2020 2020 6627 6177 7320 6563          f'aws ec
-00018dc0: 3220 6465 7363 7269 6265 2d69 6e73 7461  2 describe-insta
-00018dd0: 6e63 6573 202d 2d72 6567 696f 6e20 7b72  nces --region {r
-00018de0: 6567 696f 6e7d 2027 0a20 2020 2020 2020  egion} '.       
-00018df0: 2020 2020 2020 6627 2d2d 6669 6c74 6572        f'--filter
-00018e00: 7320 4e61 6d65 3d74 6167 3a72 6179 2d63  s Name=tag:ray-c
-00018e10: 6c75 7374 6572 2d6e 616d 652c 5661 6c75  luster-name,Valu
-00018e20: 6573 3d7b 6e61 6d65 5f6f 6e5f 636c 6f75  es={name_on_clou
-00018e30: 647d 2a20 270a 2020 2020 2020 2020 2020  d}* '.          
-00018e40: 2020 2066 272d 2d71 7565 7279 2052 6573     f'--query Res
-00018e50: 6572 7661 7469 6f6e 735b 5d2e 496e 7374  ervations[].Inst
-00018e60: 616e 6365 735b 5d2e 496e 7374 616e 6365  ances[].Instance
-00018e70: 4964 2027 0a20 2020 2020 2020 2020 2020  Id '.           
-00018e80: 2020 272d 2d6f 7574 7075 7420 7465 7874    '--output text
-00018e90: 2927 292c 0a20 2020 2020 2020 2020 2020  )'),.           
-00018ea0: 2027 736c 6565 7020 3130 3027 2c0a 2020   'sleep 100',.  
-00018eb0: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
-00018ec0: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
-00018ed0: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
-00018ee0: 6420 2d6e 3120 7c20 6772 6570 2022 5245  d -n1 | grep "RE
-00018ef0: 434f 5645 5249 4e47 2227 2c0a 2020 2020  COVERING"',.    
-00018f00: 2020 2020 2020 2020 2773 6c65 6570 2032          'sleep 2
-00018f10: 3030 272c 0a20 2020 2020 2020 2020 2020  00',.           
-00018f20: 2066 277b 5f4a 4f42 5f51 5545 5545 5f57   f'{_JOB_QUEUE_W
-00018f30: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-00018f40: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
-00018f50: 7265 7020 2252 554e 4e49 4e47 2227 2c0a  rep "RUNNING"',.
-00018f60: 2020 2020 2020 2020 2020 2020 6627 5255              f'RU
-00018f70: 4e5f 4944 3d24 2863 6174 202f 746d 702f  N_ID=$(cat /tmp/
-00018f80: 7b6e 616d 657d 2d72 756e 2d69 6429 3b20  {name}-run-id); 
-00018f90: 6563 686f 2022 2452 554e 5f49 4422 3b20  echo "$RUN_ID"; 
-00018fa0: 736b 7920 6a6f 6273 206c 6f67 7320 2d6e  sky jobs logs -n
-00018fb0: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
-00018fc0: 6c6f 7720 7c20 6772 6570 2053 4b59 5049  low | grep SKYPI
-00018fd0: 4c4f 545f 5441 534b 5f49 4420 7c20 6772  LOT_TASK_ID | gr
-00018fe0: 6570 2022 2452 554e 5f49 4422 272c 0a20  ep "$RUN_ID"',. 
-00018ff0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00019000: 2020 5f4a 4f42 5f43 414e 4345 4c5f 5741    _JOB_CANCEL_WA
-00019010: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
-00019020: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
-00019030: 2020 7469 6d65 6f75 743d 3235 202a 2036    timeout=25 * 6
-00019040: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
-00019050: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-00019060: 0a0a 4070 7974 6573 742e 6d61 726b 2e67  ..@pytest.mark.g
-00019070: 6370 0a40 7079 7465 7374 2e6d 6172 6b2e  cp.@pytest.mark.
-00019080: 6d61 6e61 6765 645f 6a6f 6273 0a64 6566  managed_jobs.def
-00019090: 2074 6573 745f 6d61 6e61 6765 645f 6a6f   test_managed_jo
-000190a0: 6273 5f72 6563 6f76 6572 795f 6763 7028  bs_recovery_gcp(
-000190b0: 293a 0a20 2020 2022 2222 5465 7374 206d  ):.    """Test m
-000190c0: 616e 6167 6564 206a 6f62 2072 6563 6f76  anaged job recov
-000190d0: 6572 792e 2222 220a 2020 2020 6e61 6d65  ery.""".    name
-000190e0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-000190f0: 6e61 6d65 2829 0a20 2020 206e 616d 655f  name().    name_
-00019100: 6f6e 5f63 6c6f 7564 203d 2063 6f6d 6d6f  on_cloud = commo
-00019110: 6e5f 7574 696c 732e 6d61 6b65 5f63 6c75  n_utils.make_clu
-00019120: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
-00019130: 7564 280a 2020 2020 2020 2020 6e61 6d65  ud(.        name
-00019140: 2c20 6a6f 6273 2e4a 4f42 535f 434c 5553  , jobs.JOBS_CLUS
-00019150: 5445 525f 4e41 4d45 5f50 5245 4649 585f  TER_NAME_PREFIX_
-00019160: 4c45 4e47 5448 2c20 6164 645f 7573 6572  LENGTH, add_user
-00019170: 5f68 6173 683d 4661 6c73 6529 0a20 2020  _hash=False).   
-00019180: 207a 6f6e 6520 3d20 2775 732d 6561 7374   zone = 'us-east
-00019190: 342d 6227 0a20 2020 2071 7565 7279 5f63  4-b'.    query_c
-000191a0: 6d64 203d 2028 0a20 2020 2020 2020 2066  md = (.        f
-000191b0: 2767 636c 6f75 6420 636f 6d70 7574 6520  'gcloud compute 
-000191c0: 696e 7374 616e 6365 7320 6c69 7374 202d  instances list -
-000191d0: 2d66 696c 7465 723d 270a 2020 2020 2020  -filter='.      
-000191e0: 2020 2320 603a 6020 6d65 616e 7320 7072    # `:` means pr
-000191f0: 6566 6978 206d 6174 6368 2e0a 2020 2020  efix match..    
-00019200: 2020 2020 6627 2228 6c61 6265 6c73 2e72      f'"(labels.r
-00019210: 6179 2d63 6c75 7374 6572 2d6e 616d 653a  ay-cluster-name:
-00019220: 7b6e 616d 655f 6f6e 5f63 6c6f 7564 7d29  {name_on_cloud})
-00019230: 2220 270a 2020 2020 2020 2020 6627 2d2d  " '.        f'--
-00019240: 7a6f 6e65 733d 7b7a 6f6e 657d 202d 2d66  zones={zone} --f
-00019250: 6f72 6d61 743d 2276 616c 7565 286e 616d  ormat="value(nam
-00019260: 6529 2227 290a 2020 2020 7465 726d 696e  e)"').    termin
-00019270: 6174 655f 636d 6420 3d20 2866 2767 636c  ate_cmd = (f'gcl
-00019280: 6f75 6420 636f 6d70 7574 6520 696e 7374  oud compute inst
-00019290: 616e 6365 7320 6465 6c65 7465 202d 2d7a  ances delete --z
-000192a0: 6f6e 653d 7b7a 6f6e 657d 270a 2020 2020  one={zone}'.    
-000192b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000192c0: 2066 2720 2d2d 7175 6965 7420 2428 7b71   f' --quiet $({q
-000192d0: 7565 7279 5f63 6d64 7d29 2729 0a20 2020  uery_cmd})').   
-000192e0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-000192f0: 2020 2020 2020 276d 616e 6167 6564 5f6a        'managed_j
-00019300: 6f62 735f 7265 636f 7665 7279 5f67 6370  obs_recovery_gcp
-00019310: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-00019320: 2020 2020 2020 2020 2066 2773 6b79 206a           f'sky j
-00019330: 6f62 7320 6c61 756e 6368 202d 2d63 6c6f  obs launch --clo
-00019340: 7564 2067 6370 202d 2d7a 6f6e 6520 7b7a  ud gcp --zone {z
-00019350: 6f6e 657d 202d 6e20 7b6e 616d 657d 202d  one} -n {name} -
-00019360: 2d75 7365 2d73 706f 7420 2d2d 6370 7573  -use-spot --cpus
-00019370: 2032 2022 6563 686f 2053 4b59 5049 4c4f   2 "echo SKYPILO
-00019380: 545f 5441 534b 5f49 443a 205c 2453 4b59  T_TASK_ID: \$SKY
-00019390: 5049 4c4f 545f 5441 534b 5f49 443b 2073  PILOT_TASK_ID; s
-000193a0: 6c65 6570 2031 3830 3022 2020 2d79 202d  leep 1800"  -y -
-000193b0: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-000193c0: 2773 6c65 6570 2033 3630 272c 0a20 2020  'sleep 360',.   
-000193d0: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
-000193e0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-000193f0: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
-00019400: 202d 6e31 207c 2067 7265 7020 2252 554e   -n1 | grep "RUN
-00019410: 4e49 4e47 2227 2c0a 2020 2020 2020 2020  NING"',.        
-00019420: 2020 2020 6627 5255 4e5f 4944 3d24 2873      f'RUN_ID=$(s
-00019430: 6b79 206a 6f62 7320 6c6f 6773 202d 6e20  ky jobs logs -n 
-00019440: 7b6e 616d 657d 202d 2d6e 6f2d 666f 6c6c  {name} --no-foll
-00019450: 6f77 207c 2067 7265 7020 534b 5950 494c  ow | grep SKYPIL
-00019460: 4f54 5f54 4153 4b5f 4944 207c 2063 7574  OT_TASK_ID | cut
-00019470: 202d 643a 202d 6632 293b 2065 6368 6f20   -d: -f2); echo 
-00019480: 2224 5255 4e5f 4944 2220 7c20 7465 6520  "$RUN_ID" | tee 
-00019490: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
-000194a0: 6964 272c 0a20 2020 2020 2020 2020 2020  id',.           
-000194b0: 2023 2054 6572 6d69 6e61 7465 2074 6865   # Terminate the
-000194c0: 2063 6c75 7374 6572 206d 616e 7561 6c6c   cluster manuall
-000194d0: 792e 0a20 2020 2020 2020 2020 2020 2074  y..            t
-000194e0: 6572 6d69 6e61 7465 5f63 6d64 2c0a 2020  erminate_cmd,.  
-000194f0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-00019500: 2036 3027 2c0a 2020 2020 2020 2020 2020   60',.          
-00019510: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
-00019520: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
-00019530: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
-00019540: 6772 6570 2022 5245 434f 5645 5249 4e47  grep "RECOVERING
-00019550: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00019560: 2773 6c65 6570 2032 3030 272c 0a20 2020  'sleep 200',.   
-00019570: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
-00019580: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-00019590: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
-000195a0: 202d 6e31 207c 2067 7265 7020 2252 554e   -n1 | grep "RUN
-000195b0: 4e49 4e47 2227 2c0a 2020 2020 2020 2020  NING"',.        
-000195c0: 2020 2020 6627 5255 4e5f 4944 3d24 2863      f'RUN_ID=$(c
-000195d0: 6174 202f 746d 702f 7b6e 616d 657d 2d72  at /tmp/{name}-r
-000195e0: 756e 2d69 6429 3b20 6563 686f 2022 2452  un-id); echo "$R
-000195f0: 554e 5f49 4422 3b20 736b 7920 6a6f 6273  UN_ID"; sky jobs
-00019600: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
-00019610: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
-00019620: 6570 2053 4b59 5049 4c4f 545f 5441 534b  ep SKYPILOT_TASK
-00019630: 5f49 443a 207c 2067 7265 7020 2224 5255  _ID: | grep "$RU
-00019640: 4e5f 4944 2227 2c0a 2020 2020 2020 2020  N_ID"',.        
-00019650: 5d2c 0a20 2020 2020 2020 205f 4a4f 425f  ],.        _JOB_
-00019660: 4341 4e43 454c 5f57 4149 542e 666f 726d  CANCEL_WAIT.form
-00019670: 6174 286a 6f62 5f6e 616d 653d 6e61 6d65  at(job_name=name
-00019680: 292c 0a20 2020 2020 2020 2074 696d 656f  ),.        timeo
-00019690: 7574 3d32 3520 2a20 3630 2c0a 2020 2020  ut=25 * 60,.    
-000196a0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-000196b0: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-000196c0: 7374 2e6d 6172 6b2e 6177 730a 4070 7974  st.mark.aws.@pyt
-000196d0: 6573 742e 6d61 726b 2e6d 616e 6167 6564  est.mark.managed
-000196e0: 5f6a 6f62 730a 6465 6620 7465 7374 5f6d  _jobs.def test_m
-000196f0: 616e 6167 6564 5f6a 6f62 735f 7069 7065  anaged_jobs_pipe
-00019700: 6c69 6e65 5f72 6563 6f76 6572 795f 6177  line_recovery_aw
-00019710: 7328 6177 735f 636f 6e66 6967 5f72 6567  s(aws_config_reg
-00019720: 696f 6e29 3a0a 2020 2020 2222 2254 6573  ion):.    """Tes
-00019730: 7420 6d61 6e61 6765 6420 6a6f 6220 7265  t managed job re
-00019740: 636f 7665 7279 2066 6f72 2061 2070 6970  covery for a pip
-00019750: 656c 696e 652e 2222 220a 2020 2020 6e61  eline.""".    na
-00019760: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00019770: 725f 6e61 6d65 2829 0a20 2020 2075 7365  r_name().    use
-00019780: 725f 6861 7368 203d 2063 6f6d 6d6f 6e5f  r_hash = common_
-00019790: 7574 696c 732e 6765 745f 7573 6572 5f68  utils.get_user_h
-000197a0: 6173 6828 290a 2020 2020 7573 6572 5f68  ash().    user_h
-000197b0: 6173 6820 3d20 7573 6572 5f68 6173 685b  ash = user_hash[
-000197c0: 3a63 6f6d 6d6f 6e5f 7574 696c 732e 5553  :common_utils.US
-000197d0: 4552 5f48 4153 485f 4c45 4e47 5448 5f49  ER_HASH_LENGTH_I
-000197e0: 4e5f 434c 5553 5445 525f 4e41 4d45 5d0a  N_CLUSTER_NAME].
-000197f0: 2020 2020 7265 6769 6f6e 203d 2061 7773      region = aws
-00019800: 5f63 6f6e 6669 675f 7265 6769 6f6e 0a20  _config_region. 
-00019810: 2020 2069 6620 7265 6769 6f6e 2021 3d20     if region != 
-00019820: 2775 732d 6561 7374 2d32 273a 0a20 2020  'us-east-2':.   
-00019830: 2020 2020 2070 7974 6573 742e 736b 6970       pytest.skip
-00019840: 2827 4f6e 6c79 2072 756e 2073 706f 7420  ('Only run spot 
-00019850: 7069 7065 6c69 6e65 2072 6563 6f76 6572  pipeline recover
-00019860: 7920 7465 7374 2069 6e20 7573 2d65 6173  y test in us-eas
-00019870: 742d 3227 290a 2020 2020 7465 7374 203d  t-2').    test =
-00019880: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00019890: 6d61 6e61 6765 645f 6a6f 6273 5f70 6970  managed_jobs_pip
-000198a0: 656c 696e 655f 7265 636f 7665 7279 5f61  eline_recovery_a
-000198b0: 7773 272c 0a20 2020 2020 2020 205b 0a20  ws',.        [. 
-000198c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000198d0: 206a 6f62 7320 6c61 756e 6368 202d 6e20   jobs launch -n 
-000198e0: 7b6e 616d 657d 2074 6573 7473 2f74 6573  {name} tests/tes
-000198f0: 745f 7961 6d6c 732f 7069 7065 6c69 6e65  t_yamls/pipeline
-00019900: 5f61 7773 2e79 616d 6c20 202d 7920 2d64  _aws.yaml  -y -d
-00019910: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00019920: 736c 6565 7020 3430 3027 2c0a 2020 2020  sleep 400',.    
-00019930: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
-00019940: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-00019950: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
-00019960: 2d6e 3120 7c20 6772 6570 2022 5255 4e4e  -n1 | grep "RUNN
-00019970: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
-00019980: 2020 2066 2752 554e 5f49 443d 2428 736b     f'RUN_ID=$(sk
-00019990: 7920 6a6f 6273 206c 6f67 7320 2d6e 207b  y jobs logs -n {
-000199a0: 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f  name} --no-follo
-000199b0: 7720 7c20 6772 6570 2053 4b59 5049 4c4f  w | grep SKYPILO
-000199c0: 545f 5441 534b 5f49 443a 207c 2063 7574  T_TASK_ID: | cut
-000199d0: 202d 643a 202d 6632 293b 2065 6368 6f20   -d: -f2); echo 
-000199e0: 2224 5255 4e5f 4944 2220 7c20 7465 6520  "$RUN_ID" | tee 
-000199f0: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
-00019a00: 6964 272c 0a20 2020 2020 2020 2020 2020  id',.           
-00019a10: 2066 2752 554e 5f49 4453 3d24 2873 6b79   f'RUN_IDS=$(sky
-00019a20: 206a 6f62 7320 6c6f 6773 202d 6e20 7b6e   jobs logs -n {n
-00019a30: 616d 657d 202d 2d6e 6f2d 666f 6c6c 6f77  ame} --no-follow
-00019a40: 207c 2067 7265 7020 2d41 2034 2053 4b59   | grep -A 4 SKY
-00019a50: 5049 4c4f 545f 5441 534b 5f49 4453 207c  PILOT_TASK_IDS |
-00019a60: 2063 7574 202d 6422 2922 202d 6632 293b   cut -d")" -f2);
-00019a70: 2065 6368 6f20 2224 5255 4e5f 4944 5322   echo "$RUN_IDS"
-00019a80: 207c 2074 6565 202f 746d 702f 7b6e 616d   | tee /tmp/{nam
-00019a90: 657d 2d72 756e 2d69 6473 272c 0a20 2020  e}-run-ids',.   
-00019aa0: 2020 2020 2020 2020 2023 2054 6572 6d69           # Termi
-00019ab0: 6e61 7465 2074 6865 2063 6c75 7374 6572  nate the cluster
-00019ac0: 206d 616e 7561 6c6c 792e 0a20 2020 2020   manually..     
-00019ad0: 2020 2020 2020 2023 2054 6865 2060 6361         # The `ca
-00019ae0: 7420 2e2e 2e7c 2072 6576 6020 6973 2074  t ...| rev` is t
-00019af0: 6f20 7265 7472 6965 7665 2074 6865 206a  o retrieve the j
-00019b00: 6f62 5f69 6420 6672 6f6d 2074 6865 0a20  ob_id from the. 
-00019b10: 2020 2020 2020 2020 2020 2023 2053 4b59             # SKY
-00019b20: 5049 4c4f 545f 5441 534b 5f49 442c 2077  PILOT_TASK_ID, w
-00019b30: 6869 6368 2067 6574 7320 7468 6520 7365  hich gets the se
-00019b40: 636f 6e64 2074 6f20 6c61 7374 2066 6965  cond to last fie
-00019b50: 6c64 0a20 2020 2020 2020 2020 2020 2023  ld.            #
-00019b60: 2073 6570 6172 6174 6564 2062 7920 602d   separated by `-
-00019b70: 602e 0a20 2020 2020 2020 2020 2020 2028  `..            (
-00019b80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019b90: 2066 274d 414e 4147 4544 5f4a 4f42 5f49   f'MANAGED_JOB_I
-00019ba0: 443d 6063 6174 202f 746d 702f 7b6e 616d  D=`cat /tmp/{nam
-00019bb0: 657d 2d72 756e 2d69 6420 7c20 7265 7620  e}-run-id | rev 
-00019bc0: 7c20 270a 2020 2020 2020 2020 2020 2020  | '.            
-00019bd0: 2020 2020 2763 7574 202d 645c 275f 5c27      'cut -d\'_\'
-00019be0: 202d 6631 207c 2072 6576 207c 2063 7574   -f1 | rev | cut
-00019bf0: 202d 645c 272d 5c27 202d 6631 603b 270a   -d\'-\' -f1`;'.
-00019c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019c10: 6627 6177 7320 6563 3220 7465 726d 696e  f'aws ec2 termin
-00019c20: 6174 652d 696e 7374 616e 6365 7320 2d2d  ate-instances --
-00019c30: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-00019c40: 2d2d 696e 7374 616e 6365 2d69 6473 2024  --instance-ids $
-00019c50: 2827 0a20 2020 2020 2020 2020 2020 2020  ('.             
-00019c60: 2020 2066 2761 7773 2065 6332 2064 6573     f'aws ec2 des
-00019c70: 6372 6962 652d 696e 7374 616e 6365 7320  cribe-instances 
-00019c80: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
-00019c90: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
-00019ca0: 2020 2020 2320 544f 444f 287a 6877 7529      # TODO(zhwu)
-00019cb0: 3a20 6669 7820 7468 6520 6e61 6d65 2066  : fix the name f
-00019cc0: 6f72 2073 706f 7420 636c 7573 7465 722e  or spot cluster.
-00019cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019ce0: 2027 2d2d 6669 6c74 6572 7320 4e61 6d65   '--filters Name
-00019cf0: 3d74 6167 3a72 6179 2d63 6c75 7374 6572  =tag:ray-cluster
-00019d00: 2d6e 616d 652c 5661 6c75 6573 3d2a 2d24  -name,Values=*-$
-00019d10: 7b4d 414e 4147 4544 5f4a 4f42 5f49 447d  {MANAGED_JOB_ID}
-00019d20: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00019d30: 2020 6627 2d7b 7573 6572 5f68 6173 687d    f'-{user_hash}
-00019d40: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00019d50: 2020 2066 272d 2d71 7565 7279 2052 6573     f'--query Res
-00019d60: 6572 7661 7469 6f6e 735b 5d2e 496e 7374  ervations[].Inst
-00019d70: 616e 6365 735b 5d2e 496e 7374 616e 6365  ances[].Instance
-00019d80: 4964 2027 0a20 2020 2020 2020 2020 2020  Id '.           
-00019d90: 2020 2020 2027 2d2d 6f75 7470 7574 2074       '--output t
-00019da0: 6578 7429 2729 2c0a 2020 2020 2020 2020  ext)'),.        
-00019db0: 2020 2020 2773 6c65 6570 2031 3030 272c      'sleep 100',
-00019dc0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-00019dd0: 5f4a 4f42 5f51 5545 5545 5f57 4149 547d  _JOB_QUEUE_WAIT}
-00019de0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-00019df0: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-00019e00: 2252 4543 4f56 4552 494e 4722 272c 0a20  "RECOVERING"',. 
-00019e10: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00019e20: 7020 3230 3027 2c0a 2020 2020 2020 2020  p 200',.        
-00019e30: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
-00019e40: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-00019e50: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
-00019e60: 7c20 6772 6570 2022 5255 4e4e 494e 4722  | grep "RUNNING"
-00019e70: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00019e80: 2752 554e 5f49 443d 2428 6361 7420 2f74  'RUN_ID=$(cat /t
-00019e90: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
-00019ea0: 293b 2065 6368 6f20 2452 554e 5f49 443b  ); echo $RUN_ID;
-00019eb0: 2073 6b79 206a 6f62 7320 6c6f 6773 202d   sky jobs logs -
-00019ec0: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
-00019ed0: 6c6c 6f77 207c 2067 7265 7020 534b 5950  llow | grep SKYP
-00019ee0: 494c 4f54 5f54 4153 4b5f 4944 3a20 7c20  ILOT_TASK_ID: | 
-00019ef0: 6772 6570 2022 2452 554e 5f49 4422 272c  grep "$RUN_ID"',
-00019f00: 0a20 2020 2020 2020 2020 2020 2066 2752  .            f'R
-00019f10: 554e 5f49 4453 3d24 2873 6b79 206a 6f62  UN_IDS=$(sky job
-00019f20: 7320 6c6f 6773 202d 6e20 7b6e 616d 657d  s logs -n {name}
-00019f30: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
-00019f40: 7265 7020 2d41 2034 2053 4b59 5049 4c4f  rep -A 4 SKYPILO
-00019f50: 545f 5441 534b 5f49 4453 207c 2063 7574  T_TASK_IDS | cut
-00019f60: 202d 6422 2922 202d 6632 293b 2065 6368   -d")" -f2); ech
-00019f70: 6f20 2224 5255 4e5f 4944 5322 207c 2074  o "$RUN_IDS" | t
-00019f80: 6565 202f 746d 702f 7b6e 616d 657d 2d72  ee /tmp/{name}-r
-00019f90: 756e 2d69 6473 2d6e 6577 272c 0a20 2020  un-ids-new',.   
-00019fa0: 2020 2020 2020 2020 2066 2764 6966 6620           f'diff 
-00019fb0: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
-00019fc0: 6964 7320 2f74 6d70 2f7b 6e61 6d65 7d2d  ids /tmp/{name}-
-00019fd0: 7275 6e2d 6964 732d 6e65 7727 2c0a 2020  run-ids-new',.  
-00019fe0: 2020 2020 2020 2020 2020 6627 6361 7420            f'cat 
-00019ff0: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
-0001a000: 6964 7320 7c20 7365 6420 2d6e 2032 7020  ids | sed -n 2p 
-0001a010: 7c20 6772 6570 2060 6361 7420 2f74 6d70  | grep `cat /tmp
-0001a020: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 6027  /{name}-run-id`'
-0001a030: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-0001a040: 2020 2020 205f 4a4f 425f 4341 4e43 454c       _JOB_CANCEL
-0001a050: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
-0001a060: 5f6e 616d 653d 6e61 6d65 292c 0a20 2020  _name=name),.   
-0001a070: 2020 2020 2074 696d 656f 7574 3d32 3520       timeout=25 
-0001a080: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
-0001a090: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0001a0a0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-0001a0b0: 6b2e 6763 700a 4070 7974 6573 742e 6d61  k.gcp.@pytest.ma
-0001a0c0: 726b 2e6d 616e 6167 6564 5f6a 6f62 730a  rk.managed_jobs.
-0001a0d0: 6465 6620 7465 7374 5f6d 616e 6167 6564  def test_managed
-0001a0e0: 5f6a 6f62 735f 7069 7065 6c69 6e65 5f72  _jobs_pipeline_r
-0001a0f0: 6563 6f76 6572 795f 6763 7028 293a 0a20  ecovery_gcp():. 
-0001a100: 2020 2022 2222 5465 7374 206d 616e 6167     """Test manag
-0001a110: 6564 206a 6f62 2072 6563 6f76 6572 7920  ed job recovery 
-0001a120: 666f 7220 6120 7069 7065 6c69 6e65 2e22  for a pipeline."
-0001a130: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
-0001a140: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-0001a150: 290a 2020 2020 7a6f 6e65 203d 2027 7573  ).    zone = 'us
-0001a160: 2d65 6173 7434 2d62 270a 2020 2020 7573  -east4-b'.    us
-0001a170: 6572 5f68 6173 6820 3d20 636f 6d6d 6f6e  er_hash = common
-0001a180: 5f75 7469 6c73 2e67 6574 5f75 7365 725f  _utils.get_user_
-0001a190: 6861 7368 2829 0a20 2020 2075 7365 725f  hash().    user_
-0001a1a0: 6861 7368 203d 2075 7365 725f 6861 7368  hash = user_hash
-0001a1b0: 5b3a 636f 6d6d 6f6e 5f75 7469 6c73 2e55  [:common_utils.U
-0001a1c0: 5345 525f 4841 5348 5f4c 454e 4754 485f  SER_HASH_LENGTH_
-0001a1d0: 494e 5f43 4c55 5354 4552 5f4e 414d 455d  IN_CLUSTER_NAME]
-0001a1e0: 0a20 2020 2071 7565 7279 5f63 6d64 203d  .    query_cmd =
-0001a1f0: 2028 0a20 2020 2020 2020 2027 6763 6c6f   (.        'gclo
-0001a200: 7564 2063 6f6d 7075 7465 2069 6e73 7461  ud compute insta
-0001a210: 6e63 6573 206c 6973 7420 2d2d 6669 6c74  nces list --filt
-0001a220: 6572 3d27 0a20 2020 2020 2020 2066 2722  er='.        f'"
-0001a230: 286c 6162 656c 732e 7261 792d 636c 7573  (labels.ray-clus
-0001a240: 7465 722d 6e61 6d65 3a2a 2d24 7b7b 4d41  ter-name:*-${{MA
-0001a250: 4e41 4745 445f 4a4f 425f 4944 7d7d 2d7b  NAGED_JOB_ID}}-{
-0001a260: 7573 6572 5f68 6173 687d 2922 2027 0a20  user_hash})" '. 
-0001a270: 2020 2020 2020 2066 272d 2d7a 6f6e 6573         f'--zones
-0001a280: 3d7b 7a6f 6e65 7d20 2d2d 666f 726d 6174  ={zone} --format
-0001a290: 3d22 7661 6c75 6528 6e61 6d65 2922 2729  ="value(name)"')
-0001a2a0: 0a20 2020 2074 6572 6d69 6e61 7465 5f63  .    terminate_c
-0001a2b0: 6d64 203d 2028 6627 6763 6c6f 7564 2063  md = (f'gcloud c
-0001a2c0: 6f6d 7075 7465 2069 6e73 7461 6e63 6573  ompute instances
-0001a2d0: 2064 656c 6574 6520 2d2d 7a6f 6e65 3d7b   delete --zone={
-0001a2e0: 7a6f 6e65 7d27 0a20 2020 2020 2020 2020  zone}'.         
-0001a2f0: 2020 2020 2020 2020 2020 2020 6627 202d              f' -
-0001a300: 2d71 7569 6574 2024 287b 7175 6572 795f  -quiet $({query_
-0001a310: 636d 647d 2927 290a 2020 2020 7465 7374  cmd})').    test
-0001a320: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-0001a330: 2027 6d61 6e61 6765 645f 6a6f 6273 5f70   'managed_jobs_p
-0001a340: 6970 656c 696e 655f 7265 636f 7665 7279  ipeline_recovery
-0001a350: 5f67 6370 272c 0a20 2020 2020 2020 205b  _gcp',.        [
-0001a360: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0001a370: 6b79 206a 6f62 7320 6c61 756e 6368 202d  ky jobs launch -
-0001a380: 6e20 7b6e 616d 657d 2074 6573 7473 2f74  n {name} tests/t
-0001a390: 6573 745f 7961 6d6c 732f 7069 7065 6c69  est_yamls/pipeli
-0001a3a0: 6e65 5f67 6370 2e79 616d 6c20 202d 7920  ne_gcp.yaml  -y 
-0001a3b0: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
-0001a3c0: 2027 736c 6565 7020 3430 3027 2c0a 2020   'sleep 400',.  
-0001a3d0: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
-0001a3e0: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
-0001a3f0: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
-0001a400: 6420 2d6e 3120 7c20 6772 6570 2022 5255  d -n1 | grep "RU
-0001a410: 4e4e 494e 4722 272c 0a20 2020 2020 2020  NNING"',.       
-0001a420: 2020 2020 2066 2752 554e 5f49 443d 2428       f'RUN_ID=$(
-0001a430: 736b 7920 6a6f 6273 206c 6f67 7320 2d6e  sky jobs logs -n
-0001a440: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
-0001a450: 6c6f 7720 7c20 6772 6570 2053 4b59 5049  low | grep SKYPI
-0001a460: 4c4f 545f 5441 534b 5f49 443a 207c 2063  LOT_TASK_ID: | c
-0001a470: 7574 202d 643a 202d 6632 293b 2065 6368  ut -d: -f2); ech
-0001a480: 6f20 2224 5255 4e5f 4944 2220 7c20 7465  o "$RUN_ID" | te
-0001a490: 6520 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  e /tmp/{name}-ru
-0001a4a0: 6e2d 6964 272c 0a20 2020 2020 2020 2020  n-id',.         
-0001a4b0: 2020 2066 2752 554e 5f49 4453 3d24 2873     f'RUN_IDS=$(s
-0001a4c0: 6b79 206a 6f62 7320 6c6f 6773 202d 6e20  ky jobs logs -n 
-0001a4d0: 7b6e 616d 657d 202d 2d6e 6f2d 666f 6c6c  {name} --no-foll
-0001a4e0: 6f77 207c 2067 7265 7020 2d41 2034 2053  ow | grep -A 4 S
-0001a4f0: 4b59 5049 4c4f 545f 5441 534b 5f49 4453  KYPILOT_TASK_IDS
-0001a500: 207c 2063 7574 202d 6422 2922 202d 6632   | cut -d")" -f2
-0001a510: 293b 2065 6368 6f20 2224 5255 4e5f 4944  ); echo "$RUN_ID
-0001a520: 5322 207c 2074 6565 202f 746d 702f 7b6e  S" | tee /tmp/{n
-0001a530: 616d 657d 2d72 756e 2d69 6473 272c 0a20  ame}-run-ids',. 
-0001a540: 2020 2020 2020 2020 2020 2023 2054 6572             # Ter
-0001a550: 6d69 6e61 7465 2074 6865 2063 6c75 7374  minate the clust
-0001a560: 6572 206d 616e 7561 6c6c 792e 0a20 2020  er manually..   
-0001a570: 2020 2020 2020 2020 2023 2054 6865 2060           # The `
-0001a580: 6361 7420 2e2e 2e7c 2072 6576 6020 6973  cat ...| rev` is
-0001a590: 2074 6f20 7265 7472 6965 7665 2074 6865   to retrieve the
-0001a5a0: 206a 6f62 5f69 6420 6672 6f6d 2074 6865   job_id from the
-0001a5b0: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
-0001a5c0: 4b59 5049 4c4f 545f 5441 534b 5f49 442c  KYPILOT_TASK_ID,
-0001a5d0: 2077 6869 6368 2067 6574 7320 7468 6520   which gets the 
-0001a5e0: 7365 636f 6e64 2074 6f20 6c61 7374 2066  second to last f
-0001a5f0: 6965 6c64 0a20 2020 2020 2020 2020 2020  ield.           
-0001a600: 2023 2073 6570 6172 6174 6564 2062 7920   # separated by 
-0001a610: 602d 602e 0a20 2020 2020 2020 2020 2020  `-`..           
-0001a620: 2028 6627 4d41 4e41 4745 445f 4a4f 425f   (f'MANAGED_JOB_
-0001a630: 4944 3d60 6361 7420 2f74 6d70 2f7b 6e61  ID=`cat /tmp/{na
-0001a640: 6d65 7d2d 7275 6e2d 6964 207c 2072 6576  me}-run-id | rev
-0001a650: 207c 2027 0a20 2020 2020 2020 2020 2020   | '.           
-0001a660: 2020 6627 6375 7420 2d64 5c27 5f5c 2720    f'cut -d\'_\' 
-0001a670: 2d66 3120 7c20 7265 7620 7c20 6375 7420  -f1 | rev | cut 
-0001a680: 2d64 5c27 2d5c 2720 2d66 3160 3b20 7b74  -d\'-\' -f1`; {t
-0001a690: 6572 6d69 6e61 7465 5f63 6d64 7d27 292c  erminate_cmd}'),
-0001a6a0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0001a6b0: 6565 7020 3630 272c 0a20 2020 2020 2020  eep 60',.       
-0001a6c0: 2020 2020 2066 277b 5f4a 4f42 5f51 5545       f'{_JOB_QUE
-0001a6d0: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-0001a6e0: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
-0001a6f0: 207c 2067 7265 7020 2252 4543 4f56 4552   | grep "RECOVER
-0001a700: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
-0001a710: 2020 2027 736c 6565 7020 3230 3027 2c0a     'sleep 200',.
-0001a720: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-0001a730: 4a4f 425f 5155 4555 455f 5741 4954 7d7c  JOB_QUEUE_WAIT}|
-0001a740: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-0001a750: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-0001a760: 5255 4e4e 494e 4722 272c 0a20 2020 2020  RUNNING"',.     
-0001a770: 2020 2020 2020 2066 2752 554e 5f49 443d         f'RUN_ID=
-0001a780: 2428 6361 7420 2f74 6d70 2f7b 6e61 6d65  $(cat /tmp/{name
-0001a790: 7d2d 7275 6e2d 6964 293b 2065 6368 6f20  }-run-id); echo 
-0001a7a0: 2452 554e 5f49 443b 2073 6b79 206a 6f62  $RUN_ID; sky job
-0001a7b0: 7320 6c6f 6773 202d 6e20 7b6e 616d 657d  s logs -n {name}
-0001a7c0: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
-0001a7d0: 7265 7020 534b 5950 494c 4f54 5f54 4153  rep SKYPILOT_TAS
-0001a7e0: 4b5f 4944 3a20 7c20 6772 6570 2022 2452  K_ID: | grep "$R
-0001a7f0: 554e 5f49 4422 272c 0a20 2020 2020 2020  UN_ID"',.       
-0001a800: 2020 2020 2066 2752 554e 5f49 4453 3d24       f'RUN_IDS=$
-0001a810: 2873 6b79 206a 6f62 7320 6c6f 6773 202d  (sky jobs logs -
-0001a820: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
-0001a830: 6c6c 6f77 207c 2067 7265 7020 2d41 2034  llow | grep -A 4
-0001a840: 2053 4b59 5049 4c4f 545f 5441 534b 5f49   SKYPILOT_TASK_I
-0001a850: 4453 207c 2063 7574 202d 6422 2922 202d  DS | cut -d")" -
-0001a860: 6632 293b 2065 6368 6f20 2224 5255 4e5f  f2); echo "$RUN_
-0001a870: 4944 5322 207c 2074 6565 202f 746d 702f  IDS" | tee /tmp/
-0001a880: 7b6e 616d 657d 2d72 756e 2d69 6473 2d6e  {name}-run-ids-n
-0001a890: 6577 272c 0a20 2020 2020 2020 2020 2020  ew',.           
-0001a8a0: 2066 2764 6966 6620 2f74 6d70 2f7b 6e61   f'diff /tmp/{na
-0001a8b0: 6d65 7d2d 7275 6e2d 6964 7320 2f74 6d70  me}-run-ids /tmp
-0001a8c0: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 732d  /{name}-run-ids-
-0001a8d0: 6e65 7727 2c0a 2020 2020 2020 2020 2020  new',.          
-0001a8e0: 2020 6627 6361 7420 2f74 6d70 2f7b 6e61    f'cat /tmp/{na
-0001a8f0: 6d65 7d2d 7275 6e2d 6964 7320 7c20 7365  me}-run-ids | se
-0001a900: 6420 2d6e 2032 7020 7c20 6772 6570 2060  d -n 2p | grep `
-0001a910: 6361 7420 2f74 6d70 2f7b 6e61 6d65 7d2d  cat /tmp/{name}-
-0001a920: 7275 6e2d 6964 6027 2c0a 2020 2020 2020  run-id`',.      
-0001a930: 2020 5d2c 0a20 2020 2020 2020 205f 4a4f    ],.        _JO
-0001a940: 425f 4341 4e43 454c 5f57 4149 542e 666f  B_CANCEL_WAIT.fo
-0001a950: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
-0001a960: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
-0001a970: 656f 7574 3d32 3520 2a20 3630 2c0a 2020  eout=25 * 60,.  
-0001a980: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-0001a990: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-0001a9a0: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
-0001a9b0: 6964 7374 6163 6b20 2023 2046 6c75 6964  idstack  # Fluid
-0001a9c0: 7374 6163 6b20 646f 6573 206e 6f74 2073  stack does not s
-0001a9d0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-0001a9e0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-0001a9f0: 726b 2e6e 6f5f 617a 7572 6520 2023 2041  rk.no_azure  # A
-0001aa00: 7a75 7265 2064 6f65 7320 6e6f 7420 7375  zure does not su
-0001aa10: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-0001aa20: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-0001aa30: 6b2e 6e6f 5f6c 616d 6264 615f 636c 6f75  k.no_lambda_clou
-0001aa40: 6420 2023 204c 616d 6264 6120 436c 6f75  d  # Lambda Clou
-0001aa50: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
-0001aa60: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
-0001aa70: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
-0001aa80: 6f5f 6962 6d20 2023 2049 424d 2043 6c6f  o_ibm  # IBM Clo
-0001aa90: 7564 2064 6f65 7320 6e6f 7420 7375 7070  ud does not supp
-0001aaa0: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
-0001aab0: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-0001aac0: 6e6f 5f73 6370 2020 2320 5343 5020 646f  no_scp  # SCP do
-0001aad0: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-0001aae0: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
-0001aaf0: 7974 6573 742e 6d61 726b 2e6e 6f5f 7061  ytest.mark.no_pa
-0001ab00: 7065 7273 7061 6365 2020 2320 5061 7065  perspace  # Pape
-0001ab10: 7273 7061 6365 2064 6f65 7320 6e6f 7420  rspace does not 
-0001ab20: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
-0001ab30: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
-0001ab40: 6172 6b2e 6e6f 5f6b 7562 6572 6e65 7465  ark.no_kubernete
-0001ab50: 7320 2023 204b 7562 6572 6e65 7465 7320  s  # Kubernetes 
-0001ab60: 646f 6573 206e 6f74 2068 6176 6520 6120  does not have a 
-0001ab70: 6e6f 7469 6f6e 206f 6620 7370 6f74 2069  notion of spot i
-0001ab80: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
-0001ab90: 2e6d 6172 6b2e 6d61 6e61 6765 645f 6a6f  .mark.managed_jo
-0001aba0: 6273 0a64 6566 2074 6573 745f 6d61 6e61  bs.def test_mana
-0001abb0: 6765 645f 6a6f 6273 5f72 6563 6f76 6572  ged_jobs_recover
-0001abc0: 795f 6465 6661 756c 745f 7265 736f 7572  y_default_resour
-0001abd0: 6365 7328 6765 6e65 7269 635f 636c 6f75  ces(generic_clou
-0001abe0: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
-0001abf0: 5465 7374 206d 616e 6167 6564 206a 6f62  Test managed job
-0001ac00: 2072 6563 6f76 6572 7920 666f 7220 6465   recovery for de
-0001ac10: 6661 756c 7420 7265 736f 7572 6365 732e  fault resources.
-0001ac20: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
-0001ac30: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-0001ac40: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-0001ac50: 7374 280a 2020 2020 2020 2020 276d 616e  st(.        'man
-0001ac60: 6167 6564 2d73 706f 742d 7265 636f 7665  aged-spot-recove
-0001ac70: 7279 2d64 6566 6175 6c74 2d72 6573 6f75  ry-default-resou
-0001ac80: 7263 6573 272c 0a20 2020 2020 2020 205b  rces',.        [
-0001ac90: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0001aca0: 6b79 206a 6f62 7320 6c61 756e 6368 202d  ky jobs launch -
-0001acb0: 6e20 7b6e 616d 657d 202d 2d63 6c6f 7564  n {name} --cloud
-0001acc0: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-0001acd0: 202d 2d75 7365 2d73 706f 7420 2273 6c65   --use-spot "sle
-0001ace0: 6570 2033 3020 2626 2073 7564 6f20 7368  ep 30 && sudo sh
-0001acf0: 7574 646f 776e 206e 6f77 2026 2620 736c  utdown now && sl
-0001ad00: 6565 7020 3130 3030 2220 2d79 202d 6427  eep 1000" -y -d'
-0001ad10: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0001ad20: 6c65 6570 2033 3630 272c 0a20 2020 2020  leep 360',.     
-0001ad30: 2020 2020 2020 2066 277b 5f4a 4f42 5f51         f'{_JOB_Q
-0001ad40: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-0001ad50: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
-0001ad60: 6e31 207c 2067 7265 7020 2252 554e 4e49  n1 | grep "RUNNI
-0001ad70: 4e47 5c7c 5245 434f 5645 5249 4e47 2227  NG\|RECOVERING"'
-0001ad80: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-0001ad90: 2020 2020 205f 4a4f 425f 4341 4e43 454c       _JOB_CANCEL
-0001ada0: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
-0001adb0: 5f6e 616d 653d 6e61 6d65 292c 0a20 2020  _name=name),.   
-0001adc0: 2020 2020 2074 696d 656f 7574 3d32 3520       timeout=25 
-0001add0: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
-0001ade0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0001adf0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-0001ae00: 6b2e 6177 730a 4070 7974 6573 742e 6d61  k.aws.@pytest.ma
-0001ae10: 726b 2e6d 616e 6167 6564 5f6a 6f62 730a  rk.managed_jobs.
-0001ae20: 6465 6620 7465 7374 5f6d 616e 6167 6564  def test_managed
-0001ae30: 5f6a 6f62 735f 7265 636f 7665 7279 5f6d  _jobs_recovery_m
-0001ae40: 756c 7469 5f6e 6f64 655f 6177 7328 6177  ulti_node_aws(aw
-0001ae50: 735f 636f 6e66 6967 5f72 6567 696f 6e29  s_config_region)
-0001ae60: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
-0001ae70: 6e61 6765 6420 6a6f 6220 7265 636f 7665  naged job recove
-0001ae80: 7279 2e22 2222 0a20 2020 206e 616d 6520  ry.""".    name 
-0001ae90: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0001aea0: 616d 6528 290a 2020 2020 6e61 6d65 5f6f  ame().    name_o
-0001aeb0: 6e5f 636c 6f75 6420 3d20 636f 6d6d 6f6e  n_cloud = common
-0001aec0: 5f75 7469 6c73 2e6d 616b 655f 636c 7573  _utils.make_clus
-0001aed0: 7465 725f 6e61 6d65 5f6f 6e5f 636c 6f75  ter_name_on_clou
-0001aee0: 6428 0a20 2020 2020 2020 206e 616d 652c  d(.        name,
-0001aef0: 206a 6f62 732e 4a4f 4253 5f43 4c55 5354   jobs.JOBS_CLUST
-0001af00: 4552 5f4e 414d 455f 5052 4546 4958 5f4c  ER_NAME_PREFIX_L
-0001af10: 454e 4754 482c 2061 6464 5f75 7365 725f  ENGTH, add_user_
-0001af20: 6861 7368 3d46 616c 7365 290a 2020 2020  hash=False).    
-0001af30: 7265 6769 6f6e 203d 2061 7773 5f63 6f6e  region = aws_con
-0001af40: 6669 675f 7265 6769 6f6e 0a20 2020 2074  fig_region.    t
-0001af50: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-0001af60: 2020 2020 276d 616e 6167 6564 5f6a 6f62      'managed_job
-0001af70: 735f 7265 636f 7665 7279 5f6d 756c 7469  s_recovery_multi
-0001af80: 5f6e 6f64 655f 6177 7327 2c0a 2020 2020  _node_aws',.    
-0001af90: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0001afa0: 2020 6627 736b 7920 6a6f 6273 206c 6175    f'sky jobs lau
-0001afb0: 6e63 6820 2d2d 636c 6f75 6420 6177 7320  nch --cloud aws 
-0001afc0: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
-0001afd0: 7d20 2d6e 207b 6e61 6d65 7d20 2d2d 7573  } -n {name} --us
-0001afe0: 652d 7370 6f74 202d 2d6e 756d 2d6e 6f64  e-spot --num-nod
-0001aff0: 6573 2032 2022 6563 686f 2053 4b59 5049  es 2 "echo SKYPI
-0001b000: 4c4f 545f 5441 534b 5f49 443a 205c 2453  LOT_TASK_ID: \$S
-0001b010: 4b59 5049 4c4f 545f 5441 534b 5f49 443b  KYPILOT_TASK_ID;
-0001b020: 2073 6c65 6570 2031 3830 3022 2020 2d79   sleep 1800"  -y
-0001b030: 202d 6427 2c0a 2020 2020 2020 2020 2020   -d',.          
-0001b040: 2020 2773 6c65 6570 2034 3530 272c 0a20    'sleep 450',. 
-0001b050: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
-0001b060: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
-0001b070: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-0001b080: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-0001b090: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
-0001b0a0: 2020 2020 2020 6627 5255 4e5f 4944 3d24        f'RUN_ID=$
-0001b0b0: 2873 6b79 206a 6f62 7320 6c6f 6773 202d  (sky jobs logs -
-0001b0c0: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
-0001b0d0: 6c6c 6f77 207c 2067 7265 7020 534b 5950  llow | grep SKYP
-0001b0e0: 494c 4f54 5f54 4153 4b5f 4944 207c 2063  ILOT_TASK_ID | c
-0001b0f0: 7574 202d 643a 202d 6632 293b 2065 6368  ut -d: -f2); ech
-0001b100: 6f20 2224 5255 4e5f 4944 2220 7c20 7465  o "$RUN_ID" | te
-0001b110: 6520 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  e /tmp/{name}-ru
-0001b120: 6e2d 6964 272c 0a20 2020 2020 2020 2020  n-id',.         
-0001b130: 2020 2023 2054 6572 6d69 6e61 7465 2074     # Terminate t
-0001b140: 6865 2077 6f72 6b65 7220 6d61 6e75 616c  he worker manual
-0001b150: 6c79 2e0a 2020 2020 2020 2020 2020 2020  ly..            
-0001b160: 2866 2761 7773 2065 6332 2074 6572 6d69  (f'aws ec2 termi
-0001b170: 6e61 7465 2d69 6e73 7461 6e63 6573 202d  nate-instances -
-0001b180: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
-0001b190: 202d 2d69 6e73 7461 6e63 652d 6964 7320   --instance-ids 
-0001b1a0: 2428 270a 2020 2020 2020 2020 2020 2020  $('.            
-0001b1b0: 2066 2761 7773 2065 6332 2064 6573 6372   f'aws ec2 descr
-0001b1c0: 6962 652d 696e 7374 616e 6365 7320 2d2d  ibe-instances --
-0001b1d0: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-0001b1e0: 270a 2020 2020 2020 2020 2020 2020 2066  '.             f
-0001b1f0: 272d 2d66 696c 7465 7273 204e 616d 653d  '--filters Name=
-0001b200: 7461 673a 7261 792d 636c 7573 7465 722d  tag:ray-cluster-
-0001b210: 6e61 6d65 2c56 616c 7565 733d 7b6e 616d  name,Values={nam
-0001b220: 655f 6f6e 5f63 6c6f 7564 7d2a 2027 0a20  e_on_cloud}* '. 
-0001b230: 2020 2020 2020 2020 2020 2020 274e 616d              'Nam
-0001b240: 653d 7461 673a 7261 792d 6e6f 6465 2d74  e=tag:ray-node-t
-0001b250: 7970 652c 5661 6c75 6573 3d77 6f72 6b65  ype,Values=worke
-0001b260: 7220 270a 2020 2020 2020 2020 2020 2020  r '.            
-0001b270: 2066 272d 2d71 7565 7279 2052 6573 6572   f'--query Reser
-0001b280: 7661 7469 6f6e 735b 5d2e 496e 7374 616e  vations[].Instan
-0001b290: 6365 735b 5d2e 496e 7374 616e 6365 4964  ces[].InstanceId
-0001b2a0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0001b2b0: 272d 2d6f 7574 7075 7420 7465 7874 2927  '--output text)'
-0001b2c0: 292c 0a20 2020 2020 2020 2020 2020 2027  ),.            '
-0001b2d0: 736c 6565 7020 3530 272c 0a20 2020 2020  sleep 50',.     
-0001b2e0: 2020 2020 2020 2066 277b 5f4a 4f42 5f51         f'{_JOB_Q
-0001b2f0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-0001b300: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
-0001b310: 6e31 207c 2067 7265 7020 2252 4543 4f56  n1 | grep "RECOV
-0001b320: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
-0001b330: 2020 2020 2027 736c 6565 7020 3536 3027       'sleep 560'
-0001b340: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001b350: 7b5f 4a4f 425f 5155 4555 455f 5741 4954  {_JOB_QUEUE_WAIT
-0001b360: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-0001b370: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-0001b380: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
-0001b390: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
-0001b3a0: 443d 2428 6361 7420 2f74 6d70 2f7b 6e61  D=$(cat /tmp/{na
-0001b3b0: 6d65 7d2d 7275 6e2d 6964 293b 2065 6368  me}-run-id); ech
-0001b3c0: 6f20 2452 554e 5f49 443b 2073 6b79 206a  o $RUN_ID; sky j
-0001b3d0: 6f62 7320 6c6f 6773 202d 6e20 7b6e 616d  obs logs -n {nam
-0001b3e0: 657d 202d 2d6e 6f2d 666f 6c6c 6f77 207c  e} --no-follow |
-0001b3f0: 2067 7265 7020 534b 5950 494c 4f54 5f54   grep SKYPILOT_T
-0001b400: 4153 4b5f 4944 207c 2063 7574 202d 643a  ASK_ID | cut -d:
-0001b410: 202d 6632 207c 2067 7265 7020 2224 5255   -f2 | grep "$RU
-0001b420: 4e5f 4944 2227 2c0a 2020 2020 2020 2020  N_ID"',.        
-0001b430: 5d2c 0a20 2020 2020 2020 205f 4a4f 425f  ],.        _JOB_
-0001b440: 4341 4e43 454c 5f57 4149 542e 666f 726d  CANCEL_WAIT.form
-0001b450: 6174 286a 6f62 5f6e 616d 653d 6e61 6d65  at(job_name=name
-0001b460: 292c 0a20 2020 2020 2020 2074 696d 656f  ),.        timeo
-0001b470: 7574 3d33 3020 2a20 3630 2c0a 2020 2020  ut=30 * 60,.    
-0001b480: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-0001b490: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-0001b4a0: 7374 2e6d 6172 6b2e 6763 700a 4070 7974  st.mark.gcp.@pyt
-0001b4b0: 6573 742e 6d61 726b 2e6d 616e 6167 6564  est.mark.managed
-0001b4c0: 5f6a 6f62 730a 6465 6620 7465 7374 5f6d  _jobs.def test_m
-0001b4d0: 616e 6167 6564 5f6a 6f62 735f 7265 636f  anaged_jobs_reco
-0001b4e0: 7665 7279 5f6d 756c 7469 5f6e 6f64 655f  very_multi_node_
-0001b4f0: 6763 7028 293a 0a20 2020 2022 2222 5465  gcp():.    """Te
-0001b500: 7374 206d 616e 6167 6564 206a 6f62 2072  st managed job r
-0001b510: 6563 6f76 6572 792e 2222 220a 2020 2020  ecovery.""".    
-0001b520: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-0001b530: 7465 725f 6e61 6d65 2829 0a20 2020 206e  ter_name().    n
-0001b540: 616d 655f 6f6e 5f63 6c6f 7564 203d 2063  ame_on_cloud = c
-0001b550: 6f6d 6d6f 6e5f 7574 696c 732e 6d61 6b65  ommon_utils.make
-0001b560: 5f63 6c75 7374 6572 5f6e 616d 655f 6f6e  _cluster_name_on
-0001b570: 5f63 6c6f 7564 280a 2020 2020 2020 2020  _cloud(.        
-0001b580: 6e61 6d65 2c20 6a6f 6273 2e4a 4f42 535f  name, jobs.JOBS_
-0001b590: 434c 5553 5445 525f 4e41 4d45 5f50 5245  CLUSTER_NAME_PRE
-0001b5a0: 4649 585f 4c45 4e47 5448 2c20 6164 645f  FIX_LENGTH, add_
-0001b5b0: 7573 6572 5f68 6173 683d 4661 6c73 6529  user_hash=False)
-0001b5c0: 0a20 2020 207a 6f6e 6520 3d20 2775 732d  .    zone = 'us-
-0001b5d0: 7765 7374 322d 6127 0a20 2020 2023 2055  west2-a'.    # U
-0001b5e0: 7365 2027 3a27 2074 6f20 6d61 7463 6820  se ':' to match 
-0001b5f0: 6173 2074 6865 2063 6c75 7374 6572 206e  as the cluster n
-0001b600: 616d 6520 7769 6c6c 2063 6f6e 7461 696e  ame will contain
-0001b610: 2074 6865 2073 7566 6669 7820 7769 7468   the suffix with
-0001b620: 206a 6f62 2069 640a 2020 2020 7175 6572   job id.    quer
-0001b630: 795f 636d 6420 3d20 280a 2020 2020 2020  y_cmd = (.      
-0001b640: 2020 6627 6763 6c6f 7564 2063 6f6d 7075    f'gcloud compu
-0001b650: 7465 2069 6e73 7461 6e63 6573 206c 6973  te instances lis
-0001b660: 7420 2d2d 6669 6c74 6572 3d27 0a20 2020  t --filter='.   
-0001b670: 2020 2020 2066 2722 286c 6162 656c 732e       f'"(labels.
-0001b680: 7261 792d 636c 7573 7465 722d 6e61 6d65  ray-cluster-name
-0001b690: 3a7b 6e61 6d65 5f6f 6e5f 636c 6f75 647d  :{name_on_cloud}
-0001b6a0: 2041 4e44 2027 0a20 2020 2020 2020 2066   AND '.        f
-0001b6b0: 276c 6162 656c 732e 7261 792d 6e6f 6465  'labels.ray-node
-0001b6c0: 2d74 7970 653d 776f 726b 6572 2922 202d  -type=worker)" -
-0001b6d0: 2d7a 6f6e 6573 3d7b 7a6f 6e65 7d20 2d2d  -zones={zone} --
-0001b6e0: 666f 726d 6174 3d22 7661 6c75 6528 6e61  format="value(na
-0001b6f0: 6d65 2922 2729 0a20 2020 2074 6572 6d69  me)"').    termi
-0001b700: 6e61 7465 5f63 6d64 203d 2028 6627 6763  nate_cmd = (f'gc
-0001b710: 6c6f 7564 2063 6f6d 7075 7465 2069 6e73  loud compute ins
-0001b720: 7461 6e63 6573 2064 656c 6574 6520 2d2d  tances delete --
-0001b730: 7a6f 6e65 3d7b 7a6f 6e65 7d27 0a20 2020  zone={zone}'.   
-0001b740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b750: 2020 6627 202d 2d71 7569 6574 2024 287b    f' --quiet $({
-0001b760: 7175 6572 795f 636d 647d 2927 290a 2020  query_cmd})').  
-0001b770: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-0001b780: 2020 2020 2020 2027 6d61 6e61 6765 645f         'managed_
-0001b790: 6a6f 6273 5f72 6563 6f76 6572 795f 6d75  jobs_recovery_mu
-0001b7a0: 6c74 695f 6e6f 6465 5f67 6370 272c 0a20  lti_node_gcp',. 
-0001b7b0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0001b7c0: 2020 2020 2066 2773 6b79 206a 6f62 7320       f'sky jobs 
-0001b7d0: 6c61 756e 6368 202d 2d63 6c6f 7564 2067  launch --cloud g
-0001b7e0: 6370 202d 2d7a 6f6e 6520 7b7a 6f6e 657d  cp --zone {zone}
-0001b7f0: 202d 6e20 7b6e 616d 657d 202d 2d75 7365   -n {name} --use
-0001b800: 2d73 706f 7420 2d2d 6e75 6d2d 6e6f 6465  -spot --num-node
-0001b810: 7320 3220 2265 6368 6f20 534b 5950 494c  s 2 "echo SKYPIL
-0001b820: 4f54 5f54 4153 4b5f 4944 3a20 5c24 534b  OT_TASK_ID: \$SK
-0001b830: 5950 494c 4f54 5f54 4153 4b5f 4944 3b20  YPILOT_TASK_ID; 
-0001b840: 736c 6565 7020 3138 3030 2220 202d 7920  sleep 1800"  -y 
-0001b850: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
-0001b860: 2027 736c 6565 7020 3430 3027 2c0a 2020   'sleep 400',.  
-0001b870: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
-0001b880: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
-0001b890: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
-0001b8a0: 6420 2d6e 3120 7c20 6772 6570 2022 5255  d -n1 | grep "RU
-0001b8b0: 4e4e 494e 4722 272c 0a20 2020 2020 2020  NNING"',.       
-0001b8c0: 2020 2020 2066 2752 554e 5f49 443d 2428       f'RUN_ID=$(
-0001b8d0: 736b 7920 6a6f 6273 206c 6f67 7320 2d6e  sky jobs logs -n
-0001b8e0: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
-0001b8f0: 6c6f 7720 7c20 6772 6570 2053 4b59 5049  low | grep SKYPI
-0001b900: 4c4f 545f 5441 534b 5f49 4420 7c20 6375  LOT_TASK_ID | cu
-0001b910: 7420 2d64 3a20 2d66 3229 3b20 6563 686f  t -d: -f2); echo
-0001b920: 2022 2452 554e 5f49 4422 207c 2074 6565   "$RUN_ID" | tee
-0001b930: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
-0001b940: 2d69 6427 2c0a 2020 2020 2020 2020 2020  -id',.          
-0001b950: 2020 2320 5465 726d 696e 6174 6520 7468    # Terminate th
-0001b960: 6520 776f 726b 6572 206d 616e 7561 6c6c  e worker manuall
-0001b970: 792e 0a20 2020 2020 2020 2020 2020 2074  y..            t
-0001b980: 6572 6d69 6e61 7465 5f63 6d64 2c0a 2020  erminate_cmd,.  
-0001b990: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-0001b9a0: 2035 3027 2c0a 2020 2020 2020 2020 2020   50',.          
-0001b9b0: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
-0001b9c0: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
-0001b9d0: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
-0001b9e0: 6772 6570 2022 5245 434f 5645 5249 4e47  grep "RECOVERING
-0001b9f0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-0001ba00: 2773 6c65 6570 2034 3230 272c 0a20 2020  'sleep 420',.   
-0001ba10: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
-0001ba20: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-0001ba30: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
-0001ba40: 202d 6e31 207c 2067 7265 7020 2252 554e   -n1 | grep "RUN
-0001ba50: 4e49 4e47 2227 2c0a 2020 2020 2020 2020  NING"',.        
-0001ba60: 2020 2020 6627 5255 4e5f 4944 3d24 2863      f'RUN_ID=$(c
-0001ba70: 6174 202f 746d 702f 7b6e 616d 657d 2d72  at /tmp/{name}-r
-0001ba80: 756e 2d69 6429 3b20 6563 686f 2024 5255  un-id); echo $RU
-0001ba90: 4e5f 4944 3b20 736b 7920 6a6f 6273 206c  N_ID; sky jobs l
-0001baa0: 6f67 7320 2d6e 207b 6e61 6d65 7d20 2d2d  ogs -n {name} --
-0001bab0: 6e6f 2d66 6f6c 6c6f 7720 7c20 6772 6570  no-follow | grep
-0001bac0: 2053 4b59 5049 4c4f 545f 5441 534b 5f49   SKYPILOT_TASK_I
-0001bad0: 4420 7c20 6375 7420 2d64 3a20 2d66 3220  D | cut -d: -f2 
-0001bae0: 7c20 6772 6570 2022 2452 554e 5f49 4422  | grep "$RUN_ID"
-0001baf0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-0001bb00: 2020 2020 2020 5f4a 4f42 5f43 414e 4345        _JOB_CANCE
-0001bb10: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
-0001bb20: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
-0001bb30: 2020 2020 2020 7469 6d65 6f75 743d 3235        timeout=25
-0001bb40: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-0001bb50: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-0001bb60: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-0001bb70: 726b 2e61 7773 0a40 7079 7465 7374 2e6d  rk.aws.@pytest.m
-0001bb80: 6172 6b2e 6d61 6e61 6765 645f 6a6f 6273  ark.managed_jobs
-0001bb90: 0a64 6566 2074 6573 745f 6d61 6e61 6765  .def test_manage
-0001bba0: 645f 6a6f 6273 5f63 616e 6365 6c6c 6174  d_jobs_cancellat
-0001bbb0: 696f 6e5f 6177 7328 6177 735f 636f 6e66  ion_aws(aws_conf
-0001bbc0: 6967 5f72 6567 696f 6e29 3a0a 2020 2020  ig_region):.    
-0001bbd0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-0001bbe0: 7465 725f 6e61 6d65 2829 0a20 2020 206e  ter_name().    n
-0001bbf0: 616d 655f 6f6e 5f63 6c6f 7564 203d 2063  ame_on_cloud = c
-0001bc00: 6f6d 6d6f 6e5f 7574 696c 732e 6d61 6b65  ommon_utils.make
-0001bc10: 5f63 6c75 7374 6572 5f6e 616d 655f 6f6e  _cluster_name_on
-0001bc20: 5f63 6c6f 7564 280a 2020 2020 2020 2020  _cloud(.        
-0001bc30: 6e61 6d65 2c20 6a6f 6273 2e4a 4f42 535f  name, jobs.JOBS_
-0001bc40: 434c 5553 5445 525f 4e41 4d45 5f50 5245  CLUSTER_NAME_PRE
-0001bc50: 4649 585f 4c45 4e47 5448 2c20 6164 645f  FIX_LENGTH, add_
-0001bc60: 7573 6572 5f68 6173 683d 4661 6c73 6529  user_hash=False)
-0001bc70: 0a20 2020 206e 616d 655f 325f 6f6e 5f63  .    name_2_on_c
-0001bc80: 6c6f 7564 203d 2063 6f6d 6d6f 6e5f 7574  loud = common_ut
-0001bc90: 696c 732e 6d61 6b65 5f63 6c75 7374 6572  ils.make_cluster
-0001bca0: 5f6e 616d 655f 6f6e 5f63 6c6f 7564 280a  _name_on_cloud(.
-0001bcb0: 2020 2020 2020 2020 6627 7b6e 616d 657d          f'{name}
-0001bcc0: 2d32 272c 206a 6f62 732e 4a4f 4253 5f43  -2', jobs.JOBS_C
-0001bcd0: 4c55 5354 4552 5f4e 414d 455f 5052 4546  LUSTER_NAME_PREF
-0001bce0: 4958 5f4c 454e 4754 482c 2061 6464 5f75  IX_LENGTH, add_u
-0001bcf0: 7365 725f 6861 7368 3d46 616c 7365 290a  ser_hash=False).
-0001bd00: 2020 2020 6e61 6d65 5f33 5f6f 6e5f 636c      name_3_on_cl
-0001bd10: 6f75 6420 3d20 636f 6d6d 6f6e 5f75 7469  oud = common_uti
-0001bd20: 6c73 2e6d 616b 655f 636c 7573 7465 725f  ls.make_cluster_
-0001bd30: 6e61 6d65 5f6f 6e5f 636c 6f75 6428 0a20  name_on_cloud(. 
-0001bd40: 2020 2020 2020 2066 277b 6e61 6d65 7d2d         f'{name}-
-0001bd50: 3327 2c20 6a6f 6273 2e4a 4f42 535f 434c  3', jobs.JOBS_CL
-0001bd60: 5553 5445 525f 4e41 4d45 5f50 5245 4649  USTER_NAME_PREFI
-0001bd70: 585f 4c45 4e47 5448 2c20 6164 645f 7573  X_LENGTH, add_us
-0001bd80: 6572 5f68 6173 683d 4661 6c73 6529 0a20  er_hash=False). 
-0001bd90: 2020 2072 6567 696f 6e20 3d20 6177 735f     region = aws_
-0001bda0: 636f 6e66 6967 5f72 6567 696f 6e0a 2020  config_region.  
-0001bdb0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-0001bdc0: 2020 2020 2020 2027 6d61 6e61 6765 645f         'managed_
-0001bdd0: 6a6f 6273 5f63 616e 6365 6c6c 6174 696f  jobs_cancellatio
-0001bde0: 6e5f 6177 7327 2c0a 2020 2020 2020 2020  n_aws',.        
-0001bdf0: 5b0a 2020 2020 2020 2020 2020 2020 2320  [.            # 
-0001be00: 5465 7374 2063 616e 6365 6c6c 6174 696f  Test cancellatio
-0001be10: 6e20 6475 7269 6e67 2073 706f 7420 636c  n during spot cl
-0001be20: 7573 7465 7220 6265 696e 6720 6c61 756e  uster being laun
-0001be30: 6368 6564 2e0a 2020 2020 2020 2020 2020  ched..          
-0001be40: 2020 6627 736b 7920 6a6f 6273 206c 6175    f'sky jobs lau
-0001be50: 6e63 6820 2d2d 636c 6f75 6420 6177 7320  nch --cloud aws 
-0001be60: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
-0001be70: 7d20 2d6e 207b 6e61 6d65 7d20 2d2d 7573  } -n {name} --us
-0001be80: 652d 7370 6f74 2022 736c 6565 7020 3130  e-spot "sleep 10
-0001be90: 3030 2220 202d 7920 2d64 272c 0a20 2020  00"  -y -d',.   
-0001bea0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-0001beb0: 3630 272c 0a20 2020 2020 2020 2020 2020  60',.           
-0001bec0: 2066 277b 5f4a 4f42 5f51 5545 5545 5f57   f'{_JOB_QUEUE_W
-0001bed0: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-0001bee0: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
-0001bef0: 7265 7020 2253 5441 5254 494e 4722 272c  rep "STARTING"',
-0001bf00: 0a20 2020 2020 2020 2020 2020 205f 4a4f  .            _JO
-0001bf10: 425f 4341 4e43 454c 5f57 4149 542e 666f  B_CANCEL_WAIT.fo
-0001bf20: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
-0001bf30: 6d65 292c 0a20 2020 2020 2020 2020 2020  me),.           
-0001bf40: 2027 736c 6565 7020 3527 2c0a 2020 2020   'sleep 5',.    
-0001bf50: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
-0001bf60: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-0001bf70: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
-0001bf80: 2d6e 3120 7c20 6772 6570 2022 4341 4e43  -n1 | grep "CANC
-0001bf90: 454c 4c49 4e47 5c7c 4341 4e43 454c 4c45  ELLING\|CANCELLE
-0001bfa0: 4422 272c 0a20 2020 2020 2020 2020 2020  D"',.           
-0001bfb0: 2027 736c 6565 7020 3132 3027 2c0a 2020   'sleep 120',.  
-0001bfc0: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
-0001bfd0: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
-0001bfe0: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
-0001bff0: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
-0001c000: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
-0001c010: 2020 2020 2020 2028 6627 733d 2428 6177         (f's=$(aw
-0001c020: 7320 6563 3220 6465 7363 7269 6265 2d69  s ec2 describe-i
-0001c030: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
-0001c040: 6e20 7b72 6567 696f 6e7d 2027 0a20 2020  n {region} '.   
-0001c050: 2020 2020 2020 2020 2020 6627 2d2d 6669            f'--fi
-0001c060: 6c74 6572 7320 4e61 6d65 3d74 6167 3a72  lters Name=tag:r
-0001c070: 6179 2d63 6c75 7374 6572 2d6e 616d 652c  ay-cluster-name,
-0001c080: 5661 6c75 6573 3d7b 6e61 6d65 5f6f 6e5f  Values={name_on_
-0001c090: 636c 6f75 647d 2d2a 2027 0a20 2020 2020  cloud}-* '.     
-0001c0a0: 2020 2020 2020 2020 6627 2d2d 7175 6572          f'--quer
-0001c0b0: 7920 5265 7365 7276 6174 696f 6e73 5b5d  y Reservations[]
-0001c0c0: 2e49 6e73 7461 6e63 6573 5b5d 2e53 7461  .Instances[].Sta
-0001c0d0: 7465 5b5d 2e4e 616d 6520 270a 2020 2020  te[].Name '.    
-0001c0e0: 2020 2020 2020 2020 2027 2d2d 6f75 7470           '--outp
-0001c0f0: 7574 2074 6578 7429 2026 2620 6563 686f  ut text) && echo
-0001c100: 2022 2473 2220 2626 2065 6368 6f3b 205b   "$s" && echo; [
-0001c110: 5b20 2d7a 2022 2473 2220 5d5d 207c 7c20  [ -z "$s" ]] || 
-0001c120: 5b5b 2022 2473 2220 3d20 2274 6572 6d69  [[ "$s" = "termi
-0001c130: 6e61 7465 6422 205d 5d20 7c7c 205b 5b20  nated" ]] || [[ 
-0001c140: 2224 7322 203d 2022 7368 7574 7469 6e67  "$s" = "shutting
-0001c150: 2d64 6f77 6e22 205d 5d27 0a20 2020 2020  -down" ]]'.     
-0001c160: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-0001c170: 2020 2020 2020 2320 5465 7374 2063 616e        # Test can
-0001c180: 6365 6c6c 696e 6720 7468 6520 7370 6f74  celling the spot
-0001c190: 2063 6c75 7374 6572 2064 7572 696e 6720   cluster during 
-0001c1a0: 7370 6f74 206a 6f62 2062 6569 6e67 2073  spot job being s
-0001c1b0: 6574 7570 2e0a 2020 2020 2020 2020 2020  etup..          
-0001c1c0: 2020 6627 736b 7920 6a6f 6273 206c 6175    f'sky jobs lau
-0001c1d0: 6e63 6820 2d2d 636c 6f75 6420 6177 7320  nch --cloud aws 
-0001c1e0: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
-0001c1f0: 7d20 2d6e 207b 6e61 6d65 7d2d 3220 2d2d  } -n {name}-2 --
-0001c200: 7573 652d 7370 6f74 2074 6573 7473 2f74  use-spot tests/t
-0001c210: 6573 745f 7961 6d6c 732f 7465 7374 5f6c  est_yamls/test_l
-0001c220: 6f6e 675f 7365 7475 702e 7961 6d6c 2020  ong_setup.yaml  
-0001c230: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
-0001c240: 2020 2020 2773 6c65 6570 2033 3030 272c      'sleep 300',
-0001c250: 0a20 2020 2020 2020 2020 2020 205f 4a4f  .            _JO
-0001c260: 425f 4341 4e43 454c 5f57 4149 542e 666f  B_CANCEL_WAIT.fo
-0001c270: 726d 6174 286a 6f62 5f6e 616d 653d 6627  rmat(job_name=f'
-0001c280: 7b6e 616d 657d 2d32 2729 2c0a 2020 2020  {name}-2'),.    
-0001c290: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
-0001c2a0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001c2b0: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
-0001c2c0: 547d 7c20 6772 6570 207b 6e61 6d65 7d2d  T}| grep {name}-
-0001c2d0: 3220 7c20 6865 6164 202d 6e31 207c 2067  2 | head -n1 | g
-0001c2e0: 7265 7020 2243 414e 4345 4c4c 494e 475c  rep "CANCELLING\
-0001c2f0: 7c43 414e 4345 4c4c 4544 2227 2c0a 2020  |CANCELLED"',.  
-0001c300: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-0001c310: 2031 3230 272c 0a20 2020 2020 2020 2020   120',.         
-0001c320: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
-0001c330: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-0001c340: 6d65 7d2d 3220 7c20 6865 6164 202d 6e31  me}-2 | head -n1
-0001c350: 207c 2067 7265 7020 2243 414e 4345 4c4c   | grep "CANCELL
-0001c360: 4544 2227 2c0a 2020 2020 2020 2020 2020  ED"',.          
-0001c370: 2020 2866 2773 3d24 2861 7773 2065 6332    (f's=$(aws ec2
-0001c380: 2064 6573 6372 6962 652d 696e 7374 616e   describe-instan
-0001c390: 6365 7320 2d2d 7265 6769 6f6e 207b 7265  ces --region {re
-0001c3a0: 6769 6f6e 7d20 270a 2020 2020 2020 2020  gion} '.        
-0001c3b0: 2020 2020 2066 272d 2d66 696c 7465 7273       f'--filters
-0001c3c0: 204e 616d 653d 7461 673a 7261 792d 636c   Name=tag:ray-cl
-0001c3d0: 7573 7465 722d 6e61 6d65 2c56 616c 7565  uster-name,Value
-0001c3e0: 733d 7b6e 616d 655f 325f 6f6e 5f63 6c6f  s={name_2_on_clo
-0001c3f0: 7564 7d2d 2a20 270a 2020 2020 2020 2020  ud}-* '.        
-0001c400: 2020 2020 2066 272d 2d71 7565 7279 2052       f'--query R
-0001c410: 6573 6572 7661 7469 6f6e 735b 5d2e 496e  eservations[].In
-0001c420: 7374 616e 6365 735b 5d2e 5374 6174 655b  stances[].State[
-0001c430: 5d2e 4e61 6d65 2027 0a20 2020 2020 2020  ].Name '.       
-0001c440: 2020 2020 2020 272d 2d6f 7574 7075 7420        '--output 
-0001c450: 7465 7874 2920 2626 2065 6368 6f20 2224  text) && echo "$
-0001c460: 7322 2026 2620 6563 686f 3b20 5b5b 202d  s" && echo; [[ -
-0001c470: 7a20 2224 7322 205d 5d20 7c7c 205b 5b20  z "$s" ]] || [[ 
-0001c480: 2224 7322 203d 2022 7465 726d 696e 6174  "$s" = "terminat
-0001c490: 6564 2220 5d5d 207c 7c20 5b5b 2022 2473  ed" ]] || [[ "$s
-0001c4a0: 2220 3d20 2273 6875 7474 696e 672d 646f  " = "shutting-do
-0001c4b0: 776e 2220 5d5d 270a 2020 2020 2020 2020  wn" ]]'.        
-0001c4c0: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
-0001c4d0: 2020 2023 2054 6573 7420 6361 6e63 656c     # Test cancel
-0001c4e0: 6c61 7469 6f6e 2064 7572 696e 6720 7370  lation during sp
-0001c4f0: 6f74 206a 6f62 2069 7320 7265 636f 7665  ot job is recove
-0001c500: 7269 6e67 2e0a 2020 2020 2020 2020 2020  ring..          
-0001c510: 2020 6627 736b 7920 6a6f 6273 206c 6175    f'sky jobs lau
-0001c520: 6e63 6820 2d2d 636c 6f75 6420 6177 7320  nch --cloud aws 
-0001c530: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
-0001c540: 7d20 2d6e 207b 6e61 6d65 7d2d 3320 2d2d  } -n {name}-3 --
-0001c550: 7573 652d 7370 6f74 2022 736c 6565 7020  use-spot "sleep 
-0001c560: 3130 3030 2220 202d 7920 2d64 272c 0a20  1000"  -y -d',. 
-0001c570: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-0001c580: 7020 3330 3027 2c0a 2020 2020 2020 2020  p 300',.        
-0001c590: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
-0001c5a0: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-0001c5b0: 616d 657d 2d33 207c 2068 6561 6420 2d6e  ame}-3 | head -n
-0001c5c0: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
-0001c5d0: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
-0001c5e0: 2023 2054 6572 6d69 6e61 7465 2074 6865   # Terminate the
-0001c5f0: 2063 6c75 7374 6572 206d 616e 7561 6c6c   cluster manuall
-0001c600: 792e 0a20 2020 2020 2020 2020 2020 2028  y..            (
-0001c610: 6627 6177 7320 6563 3220 7465 726d 696e  f'aws ec2 termin
-0001c620: 6174 652d 696e 7374 616e 6365 7320 2d2d  ate-instances --
-0001c630: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-0001c640: 2d2d 696e 7374 616e 6365 2d69 6473 2024  --instance-ids $
-0001c650: 2827 0a20 2020 2020 2020 2020 2020 2020  ('.             
-0001c660: 6627 6177 7320 6563 3220 6465 7363 7269  f'aws ec2 descri
-0001c670: 6265 2d69 6e73 7461 6e63 6573 202d 2d72  be-instances --r
-0001c680: 6567 696f 6e20 7b72 6567 696f 6e7d 2027  egion {region} '
-0001c690: 0a20 2020 2020 2020 2020 2020 2020 6627  .             f'
-0001c6a0: 2d2d 6669 6c74 6572 7320 4e61 6d65 3d74  --filters Name=t
-0001c6b0: 6167 3a72 6179 2d63 6c75 7374 6572 2d6e  ag:ray-cluster-n
-0001c6c0: 616d 652c 5661 6c75 6573 3d7b 6e61 6d65  ame,Values={name
-0001c6d0: 5f33 5f6f 6e5f 636c 6f75 647d 2d2a 2027  _3_on_cloud}-* '
-0001c6e0: 0a20 2020 2020 2020 2020 2020 2020 6627  .             f'
-0001c6f0: 2d2d 7175 6572 7920 5265 7365 7276 6174  --query Reservat
-0001c700: 696f 6e73 5b5d 2e49 6e73 7461 6e63 6573  ions[].Instances
-0001c710: 5b5d 2e49 6e73 7461 6e63 6549 6420 270a  [].InstanceId '.
-0001c720: 2020 2020 2020 2020 2020 2020 2027 2d2d               '--
-0001c730: 6f75 7470 7574 2074 6578 7429 2729 2c0a  output text)'),.
-0001c740: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-0001c750: 6570 2031 3230 272c 0a20 2020 2020 2020  ep 120',.       
-0001c760: 2020 2020 2066 277b 5f4a 4f42 5f51 5545       f'{_JOB_QUE
-0001c770: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-0001c780: 6e61 6d65 7d2d 3320 7c20 6865 6164 202d  name}-3 | head -
-0001c790: 6e31 207c 2067 7265 7020 2252 4543 4f56  n1 | grep "RECOV
-0001c7a0: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
-0001c7b0: 2020 2020 205f 4a4f 425f 4341 4e43 454c       _JOB_CANCEL
-0001c7c0: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
-0001c7d0: 5f6e 616d 653d 6627 7b6e 616d 657d 2d33  _name=f'{name}-3
-0001c7e0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-0001c7f0: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
-0001c800: 2020 2020 2020 2066 277b 5f4a 4f42 5f51         f'{_JOB_Q
-0001c810: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-0001c820: 207b 6e61 6d65 7d2d 3320 7c20 6865 6164   {name}-3 | head
-0001c830: 202d 6e31 207c 2067 7265 7020 2243 414e   -n1 | grep "CAN
-0001c840: 4345 4c4c 494e 475c 7c43 414e 4345 4c4c  CELLING\|CANCELL
-0001c850: 4544 2227 2c0a 2020 2020 2020 2020 2020  ED"',.          
-0001c860: 2020 2773 6c65 6570 2031 3230 272c 0a20    'sleep 120',. 
-0001c870: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
-0001c880: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
-0001c890: 6772 6570 207b 6e61 6d65 7d2d 3320 7c20  grep {name}-3 | 
-0001c8a0: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-0001c8b0: 2243 414e 4345 4c4c 4544 2227 2c0a 2020  "CANCELLED"',.  
-0001c8c0: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
-0001c8d0: 636c 7573 7465 7220 7368 6f75 6c64 2062  cluster should b
-0001c8e0: 6520 7465 726d 696e 6174 6564 2028 7368  e terminated (sh
-0001c8f0: 7574 7469 6e67 2d64 6f77 6e29 2061 6674  utting-down) aft
-0001c900: 6572 2063 616e 6365 6c6c 6174 696f 6e2e  er cancellation.
-0001c910: 2057 6520 646f 6e27 7420 7573 6520 7468   We don't use th
-0001c920: 6520 603d 6020 6f70 6572 6174 6f72 2068  e `=` operator h
-0001c930: 6572 6520 6265 6361 7573 650a 2020 2020  ere because.    
-0001c940: 2020 2020 2020 2020 2320 7468 6572 6520          # there 
-0001c950: 6361 6e20 6265 206d 756c 7469 706c 6520  can be multiple 
-0001c960: 564d 2077 6974 6820 7468 6520 7361 6d65  VM with the same
-0001c970: 206e 616d 6520 6475 6520 746f 2074 6865   name due to the
-0001c980: 2072 6563 6f76 6572 792e 0a20 2020 2020   recovery..     
-0001c990: 2020 2020 2020 2028 6627 733d 2428 6177         (f's=$(aw
-0001c9a0: 7320 6563 3220 6465 7363 7269 6265 2d69  s ec2 describe-i
-0001c9b0: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
-0001c9c0: 6e20 7b72 6567 696f 6e7d 2027 0a20 2020  n {region} '.   
-0001c9d0: 2020 2020 2020 2020 2020 6627 2d2d 6669            f'--fi
-0001c9e0: 6c74 6572 7320 4e61 6d65 3d74 6167 3a72  lters Name=tag:r
-0001c9f0: 6179 2d63 6c75 7374 6572 2d6e 616d 652c  ay-cluster-name,
-0001ca00: 5661 6c75 6573 3d7b 6e61 6d65 5f33 5f6f  Values={name_3_o
-0001ca10: 6e5f 636c 6f75 647d 2d2a 2027 0a20 2020  n_cloud}-* '.   
-0001ca20: 2020 2020 2020 2020 2020 6627 2d2d 7175            f'--qu
-0001ca30: 6572 7920 5265 7365 7276 6174 696f 6e73  ery Reservations
-0001ca40: 5b5d 2e49 6e73 7461 6e63 6573 5b5d 2e53  [].Instances[].S
-0001ca50: 7461 7465 5b5d 2e4e 616d 6520 270a 2020  tate[].Name '.  
-0001ca60: 2020 2020 2020 2020 2020 2027 2d2d 6f75             '--ou
-0001ca70: 7470 7574 2074 6578 7429 2026 2620 6563  tput text) && ec
-0001ca80: 686f 2022 2473 2220 2626 2065 6368 6f3b  ho "$s" && echo;
-0001ca90: 205b 5b20 2d7a 2022 2473 2220 5d5d 207c   [[ -z "$s" ]] |
-0001caa0: 7c20 6563 686f 2022 2473 2220 7c20 6772  | echo "$s" | gr
-0001cab0: 6570 202d 7620 2d45 2022 7065 6e64 696e  ep -v -E "pendin
-0001cac0: 677c 7275 6e6e 696e 677c 7374 6f70 7065  g|running|stoppe
-0001cad0: 647c 7374 6f70 7069 6e67 2227 0a20 2020  d|stopping"'.   
-0001cae0: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
-0001caf0: 2020 2020 5d2c 0a20 2020 2020 2020 2074      ],.        t
-0001cb00: 696d 656f 7574 3d32 3520 2a20 3630 290a  imeout=25 * 60).
-0001cb10: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-0001cb20: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-0001cb30: 2e6d 6172 6b2e 6763 700a 4070 7974 6573  .mark.gcp.@pytes
-0001cb40: 742e 6d61 726b 2e6d 616e 6167 6564 5f6a  t.mark.managed_j
-0001cb50: 6f62 730a 6465 6620 7465 7374 5f6d 616e  obs.def test_man
-0001cb60: 6167 6564 5f6a 6f62 735f 6361 6e63 656c  aged_jobs_cancel
-0001cb70: 6c61 7469 6f6e 5f67 6370 2829 3a0a 2020  lation_gcp():.  
-0001cb80: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-0001cb90: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-0001cba0: 206e 616d 655f 3320 3d20 6627 7b6e 616d   name_3 = f'{nam
-0001cbb0: 657d 2d33 270a 2020 2020 6e61 6d65 5f33  e}-3'.    name_3
-0001cbc0: 5f6f 6e5f 636c 6f75 6420 3d20 636f 6d6d  _on_cloud = comm
-0001cbd0: 6f6e 5f75 7469 6c73 2e6d 616b 655f 636c  on_utils.make_cl
-0001cbe0: 7573 7465 725f 6e61 6d65 5f6f 6e5f 636c  uster_name_on_cl
-0001cbf0: 6f75 6428 0a20 2020 2020 2020 206e 616d  oud(.        nam
-0001cc00: 655f 332c 206a 6f62 732e 4a4f 4253 5f43  e_3, jobs.JOBS_C
-0001cc10: 4c55 5354 4552 5f4e 414d 455f 5052 4546  LUSTER_NAME_PREF
-0001cc20: 4958 5f4c 454e 4754 482c 2061 6464 5f75  IX_LENGTH, add_u
-0001cc30: 7365 725f 6861 7368 3d46 616c 7365 290a  ser_hash=False).
-0001cc40: 2020 2020 7a6f 6e65 203d 2027 7573 2d77      zone = 'us-w
-0001cc50: 6573 7433 2d62 270a 2020 2020 7175 6572  est3-b'.    quer
-0001cc60: 795f 7374 6174 655f 636d 6420 3d20 280a  y_state_cmd = (.
-0001cc70: 2020 2020 2020 2020 2767 636c 6f75 6420          'gcloud 
-0001cc80: 636f 6d70 7574 6520 696e 7374 616e 6365  compute instance
-0001cc90: 7320 6c69 7374 2027 0a20 2020 2020 2020  s list '.       
-0001cca0: 2066 272d 2d66 696c 7465 723d 2228 6c61   f'--filter="(la
-0001ccb0: 6265 6c73 2e72 6179 2d63 6c75 7374 6572  bels.ray-cluster
-0001ccc0: 2d6e 616d 653a 7b6e 616d 655f 335f 6f6e  -name:{name_3_on
-0001ccd0: 5f63 6c6f 7564 7d29 2220 270a 2020 2020  _cloud})" '.    
-0001cce0: 2020 2020 272d 2d66 6f72 6d61 743d 2276      '--format="v
-0001ccf0: 616c 7565 2873 7461 7475 7329 2227 290a  alue(status)"').
-0001cd00: 2020 2020 7175 6572 795f 636d 6420 3d20      query_cmd = 
-0001cd10: 2866 2767 636c 6f75 6420 636f 6d70 7574  (f'gcloud comput
-0001cd20: 6520 696e 7374 616e 6365 7320 6c69 7374  e instances list
-0001cd30: 202d 2d66 696c 7465 723d 270a 2020 2020   --filter='.    
-0001cd40: 2020 2020 2020 2020 2020 2020 2066 2722               f'"
-0001cd50: 286c 6162 656c 732e 7261 792d 636c 7573  (labels.ray-clus
-0001cd60: 7465 722d 6e61 6d65 3a7b 6e61 6d65 5f33  ter-name:{name_3
-0001cd70: 5f6f 6e5f 636c 6f75 647d 2922 2027 0a20  _on_cloud})" '. 
-0001cd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cd90: 6627 2d2d 7a6f 6e65 733d 7b7a 6f6e 657d  f'--zones={zone}
-0001cda0: 202d 2d66 6f72 6d61 743d 2276 616c 7565   --format="value
-0001cdb0: 286e 616d 6529 2227 290a 2020 2020 7465  (name)"').    te
-0001cdc0: 726d 696e 6174 655f 636d 6420 3d20 2866  rminate_cmd = (f
-0001cdd0: 2767 636c 6f75 6420 636f 6d70 7574 6520  'gcloud compute 
-0001cde0: 696e 7374 616e 6365 7320 6465 6c65 7465  instances delete
-0001cdf0: 202d 2d7a 6f6e 653d 7b7a 6f6e 657d 270a   --zone={zone}'.
-0001ce00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ce10: 2020 2020 2066 2720 2d2d 7175 6965 7420       f' --quiet 
-0001ce20: 2428 7b71 7565 7279 5f63 6d64 7d29 2729  $({query_cmd})')
-0001ce30: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-0001ce40: 280a 2020 2020 2020 2020 276d 616e 6167  (.        'manag
-0001ce50: 6564 5f6a 6f62 735f 6361 6e63 656c 6c61  ed_jobs_cancella
-0001ce60: 7469 6f6e 5f67 6370 272c 0a20 2020 2020  tion_gcp',.     
-0001ce70: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-0001ce80: 2023 2054 6573 7420 6361 6e63 656c 6c61   # Test cancella
-0001ce90: 7469 6f6e 2064 7572 696e 6720 7370 6f74  tion during spot
-0001cea0: 2063 6c75 7374 6572 2062 6569 6e67 206c   cluster being l
-0001ceb0: 6175 6e63 6865 642e 0a20 2020 2020 2020  aunched..       
-0001cec0: 2020 2020 2066 2773 6b79 206a 6f62 7320       f'sky jobs 
-0001ced0: 6c61 756e 6368 202d 2d63 6c6f 7564 2067  launch --cloud g
-0001cee0: 6370 202d 2d7a 6f6e 6520 7b7a 6f6e 657d  cp --zone {zone}
-0001cef0: 202d 6e20 7b6e 616d 657d 202d 2d75 7365   -n {name} --use
-0001cf00: 2d73 706f 7420 2273 6c65 6570 2031 3030  -spot "sleep 100
-0001cf10: 3022 2020 2d79 202d 6427 2c0a 2020 2020  0"  -y -d',.    
-0001cf20: 2020 2020 2020 2020 2773 6c65 6570 2036          'sleep 6
-0001cf30: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-0001cf40: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
-0001cf50: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-0001cf60: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-0001cf70: 6570 2022 5354 4152 5449 4e47 2227 2c0a  ep "STARTING"',.
-0001cf80: 2020 2020 2020 2020 2020 2020 5f4a 4f42              _JOB
-0001cf90: 5f43 414e 4345 4c5f 5741 4954 2e66 6f72  _CANCEL_WAIT.for
-0001cfa0: 6d61 7428 6a6f 625f 6e61 6d65 3d6e 616d  mat(job_name=nam
-0001cfb0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-0001cfc0: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
-0001cfd0: 2020 2020 2020 2066 277b 5f4a 4f42 5f51         f'{_JOB_Q
-0001cfe0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-0001cff0: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
-0001d000: 6e31 207c 2067 7265 7020 2243 414e 4345  n1 | grep "CANCE
-0001d010: 4c4c 494e 475c 7c43 414e 4345 4c4c 4544  LLING\|CANCELLED
-0001d020: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-0001d030: 2773 6c65 6570 2031 3230 272c 0a20 2020  'sleep 120',.   
-0001d040: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
-0001d050: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-0001d060: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
-0001d070: 202d 6e31 207c 2067 7265 7020 2243 414e   -n1 | grep "CAN
-0001d080: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
-0001d090: 2020 2020 2020 2320 5465 7374 2063 616e        # Test can
-0001d0a0: 6365 6c6c 696e 6720 7468 6520 7370 6f74  celling the spot
-0001d0b0: 2063 6c75 7374 6572 2064 7572 696e 6720   cluster during 
-0001d0c0: 7370 6f74 206a 6f62 2062 6569 6e67 2073  spot job being s
-0001d0d0: 6574 7570 2e0a 2020 2020 2020 2020 2020  etup..          
-0001d0e0: 2020 6627 736b 7920 6a6f 6273 206c 6175    f'sky jobs lau
-0001d0f0: 6e63 6820 2d2d 636c 6f75 6420 6763 7020  nch --cloud gcp 
-0001d100: 2d2d 7a6f 6e65 207b 7a6f 6e65 7d20 2d6e  --zone {zone} -n
-0001d110: 207b 6e61 6d65 7d2d 3220 2d2d 7573 652d   {name}-2 --use-
-0001d120: 7370 6f74 2074 6573 7473 2f74 6573 745f  spot tests/test_
-0001d130: 7961 6d6c 732f 7465 7374 5f6c 6f6e 675f  yamls/test_long_
-0001d140: 7365 7475 702e 7961 6d6c 2020 2d79 202d  setup.yaml  -y -
-0001d150: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-0001d160: 2773 6c65 6570 2033 3030 272c 0a20 2020  'sleep 300',.   
-0001d170: 2020 2020 2020 2020 205f 4a4f 425f 4341           _JOB_CA
-0001d180: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
-0001d190: 286a 6f62 5f6e 616d 653d 6627 7b6e 616d  (job_name=f'{nam
-0001d1a0: 657d 2d32 2729 2c0a 2020 2020 2020 2020  e}-2'),.        
-0001d1b0: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
-0001d1c0: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
-0001d1d0: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
-0001d1e0: 6772 6570 207b 6e61 6d65 7d2d 3220 7c20  grep {name}-2 | 
-0001d1f0: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-0001d200: 2243 414e 4345 4c4c 494e 475c 7c43 414e  "CANCELLING\|CAN
-0001d210: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
-0001d220: 2020 2020 2020 2773 6c65 6570 2031 3230        'sleep 120
-0001d230: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001d240: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
-0001d250: 547d 7c20 6772 6570 207b 6e61 6d65 7d2d  T}| grep {name}-
-0001d260: 3220 7c20 6865 6164 202d 6e31 207c 2067  2 | head -n1 | g
-0001d270: 7265 7020 2243 414e 4345 4c4c 4544 2227  rep "CANCELLED"'
-0001d280: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-0001d290: 5465 7374 2063 616e 6365 6c6c 6174 696f  Test cancellatio
-0001d2a0: 6e20 6475 7269 6e67 2073 706f 7420 6a6f  n during spot jo
-0001d2b0: 6220 6973 2072 6563 6f76 6572 696e 672e  b is recovering.
-0001d2c0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0001d2d0: 6b79 206a 6f62 7320 6c61 756e 6368 202d  ky jobs launch -
-0001d2e0: 2d63 6c6f 7564 2067 6370 202d 2d7a 6f6e  -cloud gcp --zon
-0001d2f0: 6520 7b7a 6f6e 657d 202d 6e20 7b6e 616d  e {zone} -n {nam
-0001d300: 657d 2d33 202d 2d75 7365 2d73 706f 7420  e}-3 --use-spot 
-0001d310: 2273 6c65 6570 2031 3030 3022 2020 2d79  "sleep 1000"  -y
-0001d320: 202d 6427 2c0a 2020 2020 2020 2020 2020   -d',.          
-0001d330: 2020 2773 6c65 6570 2033 3030 272c 0a20    'sleep 300',. 
-0001d340: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
-0001d350: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
-0001d360: 6772 6570 207b 6e61 6d65 7d2d 3320 7c20  grep {name}-3 | 
-0001d370: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-0001d380: 2252 554e 4e49 4e47 2227 2c0a 2020 2020  "RUNNING"',.    
-0001d390: 2020 2020 2020 2020 2320 5465 726d 696e          # Termin
-0001d3a0: 6174 6520 7468 6520 636c 7573 7465 7220  ate the cluster 
-0001d3b0: 6d61 6e75 616c 6c79 2e0a 2020 2020 2020  manually..      
-0001d3c0: 2020 2020 2020 7465 726d 696e 6174 655f        terminate_
-0001d3d0: 636d 642c 0a20 2020 2020 2020 2020 2020  cmd,.           
-0001d3e0: 2027 736c 6565 7020 3830 272c 0a20 2020   'sleep 80',.   
-0001d3f0: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
-0001d400: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-0001d410: 6570 207b 6e61 6d65 7d2d 3320 7c20 6865  ep {name}-3 | he
-0001d420: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-0001d430: 4543 4f56 4552 494e 4722 272c 0a20 2020  ECOVERING"',.   
-0001d440: 2020 2020 2020 2020 205f 4a4f 425f 4341           _JOB_CA
-0001d450: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
-0001d460: 286a 6f62 5f6e 616d 653d 6627 7b6e 616d  (job_name=f'{nam
-0001d470: 657d 2d33 2729 2c0a 2020 2020 2020 2020  e}-3'),.        
-0001d480: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
-0001d490: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
-0001d4a0: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
-0001d4b0: 6772 6570 207b 6e61 6d65 7d2d 3320 7c20  grep {name}-3 | 
-0001d4c0: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-0001d4d0: 2243 414e 4345 4c4c 494e 475c 7c43 414e  "CANCELLING\|CAN
-0001d4e0: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
-0001d4f0: 2020 2020 2020 2773 6c65 6570 2031 3230        'sleep 120
-0001d500: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001d510: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
-0001d520: 547d 7c20 6772 6570 207b 6e61 6d65 7d2d  T}| grep {name}-
-0001d530: 3320 7c20 6865 6164 202d 6e31 207c 2067  3 | head -n1 | g
-0001d540: 7265 7020 2243 414e 4345 4c4c 4544 2227  rep "CANCELLED"'
-0001d550: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-0001d560: 5468 6520 636c 7573 7465 7220 7368 6f75  The cluster shou
-0001d570: 6c64 2062 6520 7465 726d 696e 6174 6564  ld be terminated
-0001d580: 2028 5354 4f50 5049 4e47 2920 6166 7465   (STOPPING) afte
-0001d590: 7220 6361 6e63 656c 6c61 7469 6f6e 2e20  r cancellation. 
-0001d5a0: 5765 2064 6f6e 2774 2075 7365 2074 6865  We don't use the
-0001d5b0: 2060 3d60 206f 7065 7261 746f 7220 6865   `=` operator he
-0001d5c0: 7265 2062 6563 6175 7365 0a20 2020 2020  re because.     
-0001d5d0: 2020 2020 2020 2023 2074 6865 7265 2063         # there c
-0001d5e0: 616e 2062 6520 6d75 6c74 6970 6c65 2056  an be multiple V
-0001d5f0: 4d20 7769 7468 2074 6865 2073 616d 6520  M with the same 
-0001d600: 6e61 6d65 2064 7565 2074 6f20 7468 6520  name due to the 
-0001d610: 7265 636f 7665 7279 2e0a 2020 2020 2020  recovery..      
-0001d620: 2020 2020 2020 2866 2773 3d24 287b 7175        (f's=$({qu
-0001d630: 6572 795f 7374 6174 655f 636d 647d 2920  ery_state_cmd}) 
-0001d640: 2626 2065 6368 6f20 2224 7322 2026 2620  && echo "$s" && 
-0001d650: 6563 686f 3b20 5b5b 202d 7a20 2224 7322  echo; [[ -z "$s"
-0001d660: 205d 5d20 7c7c 2065 6368 6f20 2224 7322   ]] || echo "$s"
-0001d670: 207c 2067 7265 7020 2d76 202d 4520 2250   | grep -v -E "P
-0001d680: 524f 5649 5349 4f4e 494e 477c 5354 4147  ROVISIONING|STAG
-0001d690: 494e 477c 5255 4e4e 494e 477c 5245 5041  ING|RUNNING|REPA
-0001d6a0: 4952 494e 477c 5445 524d 494e 4154 4544  IRING|TERMINATED
-0001d6b0: 7c53 5553 5045 4e44 494e 477c 5355 5350  |SUSPENDING|SUSP
-0001d6c0: 454e 4445 447c 5355 5350 454e 4445 4422  ENDED|SUSPENDED"
-0001d6d0: 270a 2020 2020 2020 2020 2020 2020 292c  '.            ),
-0001d6e0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-0001d6f0: 2020 2020 7469 6d65 6f75 743d 3235 202a      timeout=25 *
-0001d700: 2036 3029 0a20 2020 2072 756e 5f6f 6e65   60).    run_one
-0001d710: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-0001d720: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7469  ---------- Testi
-0001d730: 6e67 2073 746f 7261 6765 2066 6f72 206d  ng storage for m
-0001d740: 616e 6167 6564 206a 6f62 202d 2d2d 2d2d  anaged job -----
-0001d750: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
-0001d760: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
-0001d770: 2020 2320 466c 7569 6473 7461 636b 2064    # Fluidstack d
-0001d780: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-0001d790: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-0001d7a0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f61  pytest.mark.no_a
-0001d7b0: 7a75 7265 2020 2320 417a 7572 6520 646f  zure  # Azure do
-0001d7c0: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-0001d7d0: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
-0001d7e0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6c61  ytest.mark.no_la
-0001d7f0: 6d62 6461 5f63 6c6f 7564 2020 2320 4c61  mbda_cloud  # La
-0001d800: 6d62 6461 2043 6c6f 7564 2064 6f65 7320  mbda Cloud does 
-0001d810: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-0001d820: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-0001d830: 7374 2e6d 6172 6b2e 6e6f 5f69 626d 2020  st.mark.no_ibm  
-0001d840: 2320 4942 4d20 436c 6f75 6420 646f 6573  # IBM Cloud does
-0001d850: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
-0001d860: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-0001d870: 6573 742e 6d61 726b 2e6e 6f5f 7061 7065  est.mark.no_pape
-0001d880: 7273 7061 6365 2020 2320 5061 7065 7273  rspace  # Papers
-0001d890: 7061 6365 2064 6f65 7320 6e6f 7420 7375  pace does not su
-0001d8a0: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-0001d8b0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-0001d8c0: 6b2e 6e6f 5f73 6370 2020 2320 5343 5020  k.no_scp  # SCP 
-0001d8d0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-0001d8e0: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
-0001d8f0: 4070 7974 6573 742e 6d61 726b 2e6d 616e  @pytest.mark.man
-0001d900: 6167 6564 5f6a 6f62 730a 6465 6620 7465  aged_jobs.def te
-0001d910: 7374 5f6d 616e 6167 6564 5f6a 6f62 735f  st_managed_jobs_
-0001d920: 7374 6f72 6167 6528 6765 6e65 7269 635f  storage(generic_
-0001d930: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
-0001d940: 2022 2222 5465 7374 2073 746f 7261 6765   """Test storage
-0001d950: 2077 6974 6820 6d61 6e61 6765 6420 6a6f   with managed jo
-0001d960: 6222 2222 0a20 2020 206e 616d 6520 3d20  b""".    name = 
-0001d970: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-0001d980: 6528 290a 2020 2020 7961 6d6c 5f73 7472  e().    yaml_str
-0001d990: 203d 2070 6174 686c 6962 2e50 6174 6828   = pathlib.Path(
-0001d9a0: 0a20 2020 2020 2020 2027 6578 616d 706c  .        'exampl
-0001d9b0: 6573 2f6d 616e 6167 6564 5f6a 6f62 5f77  es/managed_job_w
-0001d9c0: 6974 685f 7374 6f72 6167 652e 7961 6d6c  ith_storage.yaml
-0001d9d0: 2729 2e72 6561 645f 7465 7874 2829 0a20  ').read_text(). 
-0001d9e0: 2020 2073 746f 7261 6765 5f6e 616d 6520     storage_name 
-0001d9f0: 3d20 6627 736b 792d 7465 7374 2d7b 696e  = f'sky-test-{in
-0001da00: 7428 7469 6d65 2e74 696d 6528 2929 7d27  t(time.time())}'
-0001da10: 0a0a 2020 2020 2320 416c 736f 2070 6572  ..    # Also per
-0001da20: 666f 726d 2072 6567 696f 6e20 7465 7374  form region test
-0001da30: 696e 6720 666f 7220 6275 636b 6574 2063  ing for bucket c
-0001da40: 7265 6174 696f 6e20 746f 2076 616c 6964  reation to valid
-0001da50: 6174 6520 6966 2062 7563 6b65 7473 2061  ate if buckets a
-0001da60: 7265 0a20 2020 2023 2063 7265 6174 6564  re.    # created
-0001da70: 2069 6e20 7468 6520 636f 7272 6563 7420   in the correct 
-0001da80: 7265 6769 6f6e 2061 6e64 2063 6f72 7265  region and corre
-0001da90: 6374 6c79 206d 6f75 6e74 6564 2069 6e20  ctly mounted in 
-0001daa0: 6d61 6e61 6765 6420 6a6f 6273 2e0a 2020  managed jobs..  
-0001dab0: 2020 2320 486f 7765 7665 722c 2077 6520    # However, we 
-0001dac0: 696e 6a65 6374 2074 6869 7320 7465 7374  inject this test
-0001dad0: 696e 6720 6f6e 6c79 2066 6f72 2041 5753  ing only for AWS
-0001dae0: 2061 6e64 2047 4350 2073 696e 6365 2074   and GCP since t
-0001daf0: 6865 7920 6172 6520 7468 650a 2020 2020  hey are the.    
-0001db00: 2320 7375 7070 6f72 7465 6420 6f62 6a65  # supported obje
-0001db10: 6374 2073 746f 7261 6765 2070 726f 7669  ct storage provi
-0001db20: 6465 7273 2069 6e20 536b 7950 696c 6f74  ders in SkyPilot
-0001db30: 2e0a 2020 2020 7265 6769 6f6e 5f66 6c61  ..    region_fla
-0001db40: 6720 3d20 2727 0a20 2020 2072 6567 696f  g = ''.    regio
-0001db50: 6e5f 7661 6c69 6461 7469 6f6e 5f63 6d64  n_validation_cmd
-0001db60: 203d 2027 7472 7565 270a 2020 2020 7573   = 'true'.    us
-0001db70: 655f 7370 6f74 203d 2027 202d 2d75 7365  e_spot = ' --use
-0001db80: 2d73 706f 7427 0a20 2020 2069 6620 6765  -spot'.    if ge
-0001db90: 6e65 7269 635f 636c 6f75 6420 3d3d 2027  neric_cloud == '
-0001dba0: 6177 7327 3a0a 2020 2020 2020 2020 7265  aws':.        re
-0001dbb0: 6769 6f6e 203d 2027 6575 2d63 656e 7472  gion = 'eu-centr
-0001dbc0: 616c 2d31 270a 2020 2020 2020 2020 7265  al-1'.        re
-0001dbd0: 6769 6f6e 5f66 6c61 6720 3d20 6627 202d  gion_flag = f' -
-0001dbe0: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
-0001dbf0: 270a 2020 2020 2020 2020 7265 6769 6f6e  '.        region
-0001dc00: 5f63 6d64 203d 2054 6573 7453 746f 7261  _cmd = TestStora
-0001dc10: 6765 5769 7468 4372 6564 656e 7469 616c  geWithCredential
-0001dc20: 732e 636c 695f 7265 6769 6f6e 5f63 6d64  s.cli_region_cmd
-0001dc30: 280a 2020 2020 2020 2020 2020 2020 7374  (.            st
-0001dc40: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0001dc50: 7970 652e 5333 2c20 7374 6f72 6167 655f  ype.S3, storage_
-0001dc60: 6e61 6d65 290a 2020 2020 2020 2020 7265  name).        re
-0001dc70: 6769 6f6e 5f76 616c 6964 6174 696f 6e5f  gion_validation_
-0001dc80: 636d 6420 3d20 6627 7b72 6567 696f 6e5f  cmd = f'{region_
-0001dc90: 636d 647d 207c 2067 7265 7020 7b72 6567  cmd} | grep {reg
-0001dca0: 696f 6e7d 270a 2020 2020 656c 6966 2067  ion}'.    elif g
-0001dcb0: 656e 6572 6963 5f63 6c6f 7564 203d 3d20  eneric_cloud == 
-0001dcc0: 2767 6370 273a 0a20 2020 2020 2020 2072  'gcp':.        r
-0001dcd0: 6567 696f 6e20 3d20 2775 732d 7765 7374  egion = 'us-west
-0001dce0: 3227 0a20 2020 2020 2020 2072 6567 696f  2'.        regio
-0001dcf0: 6e5f 666c 6167 203d 2066 2720 2d2d 7265  n_flag = f' --re
-0001dd00: 6769 6f6e 207b 7265 6769 6f6e 7d27 0a20  gion {region}'. 
-0001dd10: 2020 2020 2020 2072 6567 696f 6e5f 636d         region_cm
-0001dd20: 6420 3d20 5465 7374 5374 6f72 6167 6557  d = TestStorageW
-0001dd30: 6974 6843 7265 6465 6e74 6961 6c73 2e63  ithCredentials.c
-0001dd40: 6c69 5f72 6567 696f 6e5f 636d 6428 0a20  li_region_cmd(. 
-0001dd50: 2020 2020 2020 2020 2020 2073 746f 7261             stora
-0001dd60: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-0001dd70: 2e47 4353 2c20 7374 6f72 6167 655f 6e61  .GCS, storage_na
-0001dd80: 6d65 290a 2020 2020 2020 2020 7265 6769  me).        regi
-0001dd90: 6f6e 5f76 616c 6964 6174 696f 6e5f 636d  on_validation_cm
-0001dda0: 6420 3d20 6627 7b72 6567 696f 6e5f 636d  d = f'{region_cm
-0001ddb0: 647d 207c 2067 7265 7020 7b72 6567 696f  d} | grep {regio
-0001ddc0: 6e7d 270a 2020 2020 656c 6966 2067 656e  n}'.    elif gen
-0001ddd0: 6572 6963 5f63 6c6f 7564 203d 3d20 276b  eric_cloud == 'k
-0001dde0: 7562 6572 6e65 7465 7327 3a0a 2020 2020  ubernetes':.    
-0001ddf0: 2020 2020 7573 655f 7370 6f74 203d 2027      use_spot = '
-0001de00: 202d 2d6e 6f2d 7573 652d 7370 6f74 270a   --no-use-spot'.
-0001de10: 0a20 2020 2079 616d 6c5f 7374 7220 3d20  .    yaml_str = 
-0001de20: 7961 6d6c 5f73 7472 2e72 6570 6c61 6365  yaml_str.replace
-0001de30: 2827 736b 792d 776f 726b 6469 722d 7a68  ('sky-workdir-zh
-0001de40: 7775 272c 2073 746f 7261 6765 5f6e 616d  wu', storage_nam
-0001de50: 6529 0a20 2020 2077 6974 6820 7465 6d70  e).    with temp
-0001de60: 6669 6c65 2e4e 616d 6564 5465 6d70 6f72  file.NamedTempor
-0001de70: 6172 7946 696c 6528 7375 6666 6978 3d27  aryFile(suffix='
-0001de80: 2e79 616d 6c27 2c20 6d6f 6465 3d27 7727  .yaml', mode='w'
-0001de90: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
-0001dea0: 662e 7772 6974 6528 7961 6d6c 5f73 7472  f.write(yaml_str
-0001deb0: 290a 2020 2020 2020 2020 662e 666c 7573  ).        f.flus
-0001dec0: 6828 290a 2020 2020 2020 2020 6669 6c65  h().        file
-0001ded0: 5f70 6174 6820 3d20 662e 6e61 6d65 0a20  _path = f.name. 
-0001dee0: 2020 2020 2020 2074 6573 7420 3d20 5465         test = Te
-0001def0: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
-0001df00: 276d 616e 6167 6564 5f6a 6f62 735f 7374  'managed_jobs_st
-0001df10: 6f72 6167 6527 2c0a 2020 2020 2020 2020  orage',.        
-0001df20: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0001df30: 2020 2020 2020 2a73 746f 7261 6765 5f73        *storage_s
-0001df40: 6574 7570 5f63 6f6d 6d61 6e64 732c 0a20  etup_commands,. 
-0001df50: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001df60: 2773 6b79 206a 6f62 7320 6c61 756e 6368  'sky jobs launch
-0001df70: 202d 6e20 7b6e 616d 657d 7b75 7365 5f73   -n {name}{use_s
-0001df80: 706f 747d 202d 2d63 6c6f 7564 207b 6765  pot} --cloud {ge
-0001df90: 6e65 7269 635f 636c 6f75 647d 7b72 6567  neric_cloud}{reg
-0001dfa0: 696f 6e5f 666c 6167 7d20 7b66 696c 655f  ion_flag} {file_
-0001dfb0: 7061 7468 7d20 2d79 272c 0a20 2020 2020  path} -y',.     
-0001dfc0: 2020 2020 2020 2020 2020 2072 6567 696f             regio
-0001dfd0: 6e5f 7661 6c69 6461 7469 6f6e 5f63 6d64  n_validation_cmd
-0001dfe0: 2c20 2023 2043 6865 636b 2069 6620 7468  ,  # Check if th
-0001dff0: 6520 6275 636b 6574 2069 7320 6372 6561  e bucket is crea
-0001e000: 7465 6420 696e 2074 6865 2063 6f72 7265  ted in the corre
-0001e010: 6374 2072 6567 696f 6e0a 2020 2020 2020  ct region.      
-0001e020: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-0001e030: 2036 3027 2c20 2023 2057 6169 7420 7468   60',  # Wait th
-0001e040: 6520 7370 6f74 2071 7565 7565 2074 6f20  e spot queue to 
-0001e050: 6265 2075 7064 6174 6564 0a20 2020 2020  be updated.     
-0001e060: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
-0001e070: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
-0001e080: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
-0001e090: 6570 2053 5543 4345 4544 4544 272c 0a20  ep SUCCEEDED',. 
-0001e0a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001e0b0: 275b 2024 2861 7773 2073 3361 7069 206c  '[ $(aws s3api l
-0001e0c0: 6973 742d 6275 636b 6574 7320 2d2d 7175  ist-buckets --qu
-0001e0d0: 6572 7920 2242 7563 6b65 7473 5b3f 636f  ery "Buckets[?co
-0001e0e0: 6e74 6169 6e73 284e 616d 652c 205c 277b  ntains(Name, \'{
-0001e0f0: 7374 6f72 6167 655f 6e61 6d65 7d5c 2729  storage_name}\')
-0001e100: 5d2e 4e61 6d65 2220 2d2d 6f75 7470 7574  ].Name" --output
-0001e110: 2074 6578 7420 7c20 7763 202d 6c29 202d   text | wc -l) -
-0001e120: 6571 2030 205d 270a 2020 2020 2020 2020  eq 0 ]'.        
-0001e130: 2020 2020 5d2c 0a20 2020 2020 2020 2020      ],.         
-0001e140: 2020 205f 4a4f 425f 4341 4e43 454c 5f57     _JOB_CANCEL_W
-0001e150: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
-0001e160: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
-0001e170: 2020 2020 2020 2023 2049 6e63 7265 6173         # Increas
-0001e180: 6520 7469 6d65 6f75 7420 7369 6e63 6520  e timeout since 
-0001e190: 736b 7920 6a6f 6273 2071 7565 7565 202d  sky jobs queue -
-0001e1a0: 7220 6361 6e20 6265 2062 6c6f 636b 6564  r can be blocked
-0001e1b0: 2062 7920 6f74 6865 7220 7370 6f74 2074   by other spot t
-0001e1c0: 6573 7473 2e0a 2020 2020 2020 2020 2020  ests..          
-0001e1d0: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
-0001e1e0: 302c 0a20 2020 2020 2020 2029 0a20 2020  0,.        ).   
-0001e1f0: 2020 2020 2072 756e 5f6f 6e65 5f74 6573       run_one_tes
-0001e200: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
-0001e210: 2d2d 2d2d 2d2d 2054 6573 7469 6e67 2073  ------ Testing s
-0001e220: 706f 7420 5450 5520 2d2d 2d2d 2d2d 2d2d  pot TPU --------
-0001e230: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
-0001e240: 6763 700a 4070 7974 6573 742e 6d61 726b  gcp.@pytest.mark
-0001e250: 2e6d 616e 6167 6564 5f6a 6f62 730a 4070  .managed_jobs.@p
-0001e260: 7974 6573 742e 6d61 726b 2e74 7075 0a64  ytest.mark.tpu.d
-0001e270: 6566 2074 6573 745f 6d61 6e61 6765 645f  ef test_managed_
-0001e280: 6a6f 6273 5f74 7075 2829 3a0a 2020 2020  jobs_tpu():.    
-0001e290: 2222 2254 6573 7420 6d61 6e61 6765 6420  """Test managed 
-0001e2a0: 6a6f 6220 6f6e 2054 5055 2e22 2222 0a20  job on TPU.""". 
-0001e2b0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-0001e2c0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-0001e2d0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-0001e2e0: 2020 2020 2020 2027 7465 7374 2d73 706f         'test-spo
-0001e2f0: 742d 7470 7527 2c0a 2020 2020 2020 2020  t-tpu',.        
-0001e300: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-0001e310: 736b 7920 6a6f 6273 206c 6175 6e63 6820  sky jobs launch 
-0001e320: 2d6e 207b 6e61 6d65 7d20 2d2d 7573 652d  -n {name} --use-
-0001e330: 7370 6f74 2065 7861 6d70 6c65 732f 7470  spot examples/tp
-0001e340: 752f 7470 7576 6d5f 6d6e 6973 742e 7961  u/tpuvm_mnist.ya
-0001e350: 6d6c 202d 7920 2d64 272c 0a20 2020 2020  ml -y -d',.     
-0001e360: 2020 2020 2020 2027 736c 6565 7020 3527         'sleep 5'
-0001e370: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001e380: 7b5f 4a4f 425f 5155 4555 455f 5741 4954  {_JOB_QUEUE_WAIT
-0001e390: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-0001e3a0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-0001e3b0: 2053 5441 5254 494e 4727 2c0a 2020 2020   STARTING',.    
-0001e3c0: 2020 2020 2020 2020 2773 6c65 6570 2039          'sleep 9
-0001e3d0: 3030 272c 2020 2320 5450 5520 7461 6b65  00',  # TPU take
-0001e3e0: 7320 6120 7768 696c 6520 746f 206c 6175  s a while to lau
-0001e3f0: 6e63 680a 2020 2020 2020 2020 2020 2020  nch.            
-0001e400: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
-0001e410: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-0001e420: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-0001e430: 6570 2022 5255 4e4e 494e 475c 7c53 5543  ep "RUNNING\|SUC
-0001e440: 4345 4544 4544 2227 2c0a 2020 2020 2020  CEEDED"',.      
-0001e450: 2020 5d2c 0a20 2020 2020 2020 205f 4a4f    ],.        _JO
-0001e460: 425f 4341 4e43 454c 5f57 4149 542e 666f  B_CANCEL_WAIT.fo
-0001e470: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
-0001e480: 6d65 292c 0a20 2020 2020 2020 2023 2049  me),.        # I
-0001e490: 6e63 7265 6173 6520 7469 6d65 6f75 7420  ncrease timeout 
-0001e4a0: 7369 6e63 6520 736b 7920 6a6f 6273 2071  since sky jobs q
-0001e4b0: 7565 7565 202d 7220 6361 6e20 6265 2062  ueue -r can be b
-0001e4c0: 6c6f 636b 6564 2062 7920 6f74 6865 7220  locked by other 
-0001e4d0: 7370 6f74 2074 6573 7473 2e0a 2020 2020  spot tests..    
-0001e4e0: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
-0001e4f0: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
-0001e500: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-0001e510: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
-0001e520: 2054 6573 7469 6e67 2065 6e76 2066 6f72   Testing env for
-0001e530: 206d 616e 6167 6564 206a 6f62 7320 2d2d   managed jobs --
-0001e540: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
-0001e550: 2e6d 6172 6b2e 6d61 6e61 6765 645f 6a6f  .mark.managed_jo
-0001e560: 6273 0a64 6566 2074 6573 745f 6d61 6e61  bs.def test_mana
-0001e570: 6765 645f 6a6f 6273 5f69 6e6c 696e 655f  ged_jobs_inline_
-0001e580: 656e 7628 6765 6e65 7269 635f 636c 6f75  env(generic_clou
-0001e590: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
-0001e5a0: 5465 7374 206d 616e 6167 6564 206a 6f62  Test managed job
-0001e5b0: 7320 656e 7622 2222 0a20 2020 206e 616d  s env""".    nam
-0001e5c0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-0001e5d0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-0001e5e0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-0001e5f0: 2027 7465 7374 2d6d 616e 6167 6564 2d6a   'test-managed-j
-0001e600: 6f62 732d 696e 6c69 6e65 2d65 6e76 272c  obs-inline-env',
-0001e610: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-0001e620: 2020 2020 2020 2066 2773 6b79 206a 6f62         f'sky job
-0001e630: 7320 6c61 756e 6368 202d 6e20 7b6e 616d  s launch -n {nam
-0001e640: 657d 202d 7920 2d2d 636c 6f75 6420 7b67  e} -y --cloud {g
-0001e650: 656e 6572 6963 5f63 6c6f 7564 7d20 2d2d  eneric_cloud} --
-0001e660: 656e 7620 5445 5354 5f45 4e56 3d22 6865  env TEST_ENV="he
-0001e670: 6c6c 6f20 776f 726c 6422 202d 2d20 2228  llo world" -- "(
-0001e680: 5b5b 2021 202d 7a20 5c5c 225c 2454 4553  [[ ! -z \\"\$TES
-0001e690: 545f 454e 565c 5c22 205d 5d20 2626 205b  T_ENV\\" ]] && [
-0001e6a0: 5b20 2120 2d7a 205c 5c22 5c24 534b 5950  [ ! -z \\"\$SKYP
-0001e6b0: 494c 4f54 5f4e 4f44 455f 4950 535c 5c22  ILOT_NODE_IPS\\"
-0001e6c0: 205d 5d20 2626 205b 5b20 2120 2d7a 205c   ]] && [[ ! -z \
-0001e6d0: 5c22 5c24 534b 5950 494c 4f54 5f4e 4f44  \"\$SKYPILOT_NOD
-0001e6e0: 455f 5241 4e4b 5c5c 2220 5d5d 2920 7c7c  E_RANK\\" ]]) ||
-0001e6f0: 2065 7869 7420 3122 272c 0a20 2020 2020   exit 1"',.     
-0001e700: 2020 2020 2020 2027 736c 6565 7020 3230         'sleep 20
-0001e710: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001e720: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
-0001e730: 547d 207c 2067 7265 7020 7b6e 616d 657d  T} | grep {name}
-0001e740: 207c 2067 7265 7020 5355 4343 4545 4445   | grep SUCCEEDE
-0001e750: 4427 2c0a 2020 2020 2020 2020 5d2c 0a20  D',.        ],. 
-0001e760: 2020 2020 2020 205f 4a4f 425f 4341 4e43         _JOB_CANC
-0001e770: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
-0001e780: 6f62 5f6e 616d 653d 6e61 6d65 292c 0a20  ob_name=name),. 
-0001e790: 2020 2020 2020 2023 2049 6e63 7265 6173         # Increas
-0001e7a0: 6520 7469 6d65 6f75 7420 7369 6e63 6520  e timeout since 
-0001e7b0: 736b 7920 6a6f 6273 2071 7565 7565 202d  sky jobs queue -
-0001e7c0: 7220 6361 6e20 6265 2062 6c6f 636b 6564  r can be blocked
-0001e7d0: 2062 7920 6f74 6865 7220 7370 6f74 2074   by other spot t
-0001e7e0: 6573 7473 2e0a 2020 2020 2020 2020 7469  ests..        ti
-0001e7f0: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
-0001e800: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-0001e810: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-0001e820: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7469  ---------- Testi
-0001e830: 6e67 2065 6e76 202d 2d2d 2d2d 2d2d 2d2d  ng env ---------
-0001e840: 2d0a 6465 6620 7465 7374 5f69 6e6c 696e  -.def test_inlin
-0001e850: 655f 656e 7628 6765 6e65 7269 635f 636c  e_env(generic_cl
-0001e860: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
-0001e870: 2222 5465 7374 2065 6e76 2222 220a 2020  ""Test env""".  
-0001e880: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-0001e890: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-0001e8a0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-0001e8b0: 2020 2020 2020 2774 6573 742d 696e 6c69        'test-inli
-0001e8c0: 6e65 2d65 6e76 272c 0a20 2020 2020 2020  ne-env',.       
-0001e8d0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-0001e8e0: 2773 6b79 206c 6175 6e63 6820 2d63 207b  'sky launch -c {
-0001e8f0: 6e61 6d65 7d20 2d79 202d 2d63 6c6f 7564  name} -y --cloud
-0001e900: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-0001e910: 202d 2d65 6e76 2054 4553 545f 454e 563d   --env TEST_ENV=
-0001e920: 2268 656c 6c6f 2077 6f72 6c64 2220 2d2d  "hello world" --
-0001e930: 2022 285b 5b20 2120 2d7a 205c 5c22 5c24   "([[ ! -z \\"\$
-0001e940: 5445 5354 5f45 4e56 5c5c 2220 5d5d 2026  TEST_ENV\\" ]] &
-0001e950: 2620 5b5b 2021 202d 7a20 5c5c 225c 2453  & [[ ! -z \\"\$S
-0001e960: 4b59 5049 4c4f 545f 4e4f 4445 5f49 5053  KYPILOT_NODE_IPS
-0001e970: 5c5c 2220 5d5d 2026 2620 5b5b 2021 202d  \\" ]] && [[ ! -
-0001e980: 7a20 5c5c 225c 2453 4b59 5049 4c4f 545f  z \\"\$SKYPILOT_
-0001e990: 4e4f 4445 5f52 414e 4b5c 5c22 205d 5d29  NODE_RANK\\" ]])
-0001e9a0: 207c 7c20 6578 6974 2031 2227 2c0a 2020   || exit 1"',.  
-0001e9b0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-0001e9c0: 2032 3027 2c0a 2020 2020 2020 2020 2020   20',.          
-0001e9d0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-0001e9e0: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-0001e9f0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0001ea00: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-0001ea10: 2d65 6e76 2054 4553 545f 454e 5632 3d22  -env TEST_ENV2="
-0001ea20: 7375 6363 6573 7322 2022 285b 5b20 2120  success" "([[ ! 
-0001ea30: 2d7a 205c 5c22 5c24 5445 5354 5f45 4e56  -z \\"\$TEST_ENV
-0001ea40: 325c 5c22 205d 5d20 2626 205b 5b20 2120  2\\" ]] && [[ ! 
-0001ea50: 2d7a 205c 5c22 5c24 534b 5950 494c 4f54  -z \\"\$SKYPILOT
-0001ea60: 5f4e 4f44 455f 4950 535c 5c22 205d 5d20  _NODE_IPS\\" ]] 
-0001ea70: 2626 205b 5b20 2120 2d7a 205c 5c22 5c24  && [[ ! -z \\"\$
-0001ea80: 534b 5950 494c 4f54 5f4e 4f44 455f 5241  SKYPILOT_NODE_RA
-0001ea90: 4e4b 5c5c 2220 5d5d 2920 7c7c 2065 7869  NK\\" ]]) || exi
-0001eaa0: 7420 3122 272c 0a20 2020 2020 2020 2020  t 1"',.         
-0001eab0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-0001eac0: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
-0001ead0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-0001eae0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-0001eaf0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-0001eb00: 2020 2020 5f67 6574 5f74 696d 656f 7574      _get_timeout
-0001eb10: 2867 656e 6572 6963 5f63 6c6f 7564 292c  (generic_cloud),
-0001eb20: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-0001eb30: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-0001eb40: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
-0001eb50: 7469 6e67 2065 6e76 2066 696c 6520 2d2d  ting env file --
-0001eb60: 2d2d 2d2d 2d2d 2d2d 0a64 6566 2074 6573  --------.def tes
-0001eb70: 745f 696e 6c69 6e65 5f65 6e76 5f66 696c  t_inline_env_fil
-0001eb80: 6528 6765 6e65 7269 635f 636c 6f75 643a  e(generic_cloud:
-0001eb90: 2073 7472 293a 0a20 2020 2022 2222 5465   str):.    """Te
-0001eba0: 7374 2065 6e76 2222 220a 2020 2020 6e61  st env""".    na
-0001ebb0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-0001ebc0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-0001ebd0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-0001ebe0: 2020 2774 6573 742d 696e 6c69 6e65 2d65    'test-inline-e
-0001ebf0: 6e76 2d66 696c 6527 2c0a 2020 2020 2020  nv-file',.      
-0001ec00: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-0001ec10: 6627 736b 7920 6c61 756e 6368 202d 6320  f'sky launch -c 
-0001ec20: 7b6e 616d 657d 202d 7920 2d2d 636c 6f75  {name} -y --clou
-0001ec30: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-0001ec40: 7d20 2d2d 656e 7620 5445 5354 5f45 4e56  } --env TEST_ENV
-0001ec50: 3d22 6865 6c6c 6f20 776f 726c 6422 202d  ="hello world" -
-0001ec60: 2d20 2228 5b5b 2021 202d 7a20 5c5c 225c  - "([[ ! -z \\"\
-0001ec70: 2454 4553 545f 454e 565c 5c22 205d 5d20  $TEST_ENV\\" ]] 
-0001ec80: 2626 205b 5b20 2120 2d7a 205c 5c22 5c24  && [[ ! -z \\"\$
-0001ec90: 534b 5950 494c 4f54 5f4e 4f44 455f 4950  SKYPILOT_NODE_IP
-0001eca0: 535c 5c22 205d 5d20 2626 205b 5b20 2120  S\\" ]] && [[ ! 
-0001ecb0: 2d7a 205c 5c22 5c24 534b 5950 494c 4f54  -z \\"\$SKYPILOT
-0001ecc0: 5f4e 4f44 455f 5241 4e4b 5c5c 2220 5d5d  _NODE_RANK\\" ]]
-0001ecd0: 2920 7c7c 2065 7869 7420 3122 272c 0a20  ) || exit 1"',. 
-0001ece0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0001ecf0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-0001ed00: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-0001ed10: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-0001ed20: 207b 6e61 6d65 7d20 2d2d 656e 762d 6669   {name} --env-fi
-0001ed30: 6c65 2065 7861 6d70 6c65 732f 7361 6d70  le examples/samp
-0001ed40: 6c65 5f64 6f74 656e 7620 2228 5b5b 2021  le_dotenv "([[ !
-0001ed50: 202d 7a20 5c5c 225c 2454 4553 545f 454e   -z \\"\$TEST_EN
-0001ed60: 5632 5c5c 2220 5d5d 2026 2620 5b5b 2021  V2\\" ]] && [[ !
-0001ed70: 202d 7a20 5c5c 225c 2453 4b59 5049 4c4f   -z \\"\$SKYPILO
-0001ed80: 545f 4e4f 4445 5f49 5053 5c5c 2220 5d5d  T_NODE_IPS\\" ]]
-0001ed90: 2026 2620 5b5b 2021 202d 7a20 5c5c 225c   && [[ ! -z \\"\
-0001eda0: 2453 4b59 5049 4c4f 545f 4e4f 4445 5f52  $SKYPILOT_NODE_R
-0001edb0: 414e 4b5c 5c22 205d 5d29 207c 7c20 6578  ANK\\" ]]) || ex
-0001edc0: 6974 2031 2227 2c0a 2020 2020 2020 2020  it 1"',.        
-0001edd0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-0001ede0: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
-0001edf0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-0001ee00: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-0001ee10: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-0001ee20: 2020 2020 205f 6765 745f 7469 6d65 6f75       _get_timeou
-0001ee30: 7428 6765 6e65 7269 635f 636c 6f75 6429  t(generic_cloud)
-0001ee40: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-0001ee50: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-0001ee60: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
-0001ee70: 7374 696e 6720 6375 7374 6f6d 2069 6d61  sting custom ima
-0001ee80: 6765 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  ge ----------.@p
-0001ee90: 7974 6573 742e 6d61 726b 2e61 7773 0a64  ytest.mark.aws.d
-0001eea0: 6566 2074 6573 745f 6177 735f 6375 7374  ef test_aws_cust
-0001eeb0: 6f6d 5f69 6d61 6765 2829 3a0a 2020 2020  om_image():.    
-0001eec0: 2222 2254 6573 7420 4157 5320 6375 7374  """Test AWS cust
-0001eed0: 6f6d 2069 6d61 6765 2222 220a 2020 2020  om image""".    
-0001eee0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-0001eef0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-0001ef00: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-0001ef10: 2020 2020 2774 6573 742d 6177 732d 6375      'test-aws-cu
-0001ef20: 7374 6f6d 2d69 6d61 6765 272c 0a20 2020  stom-image',.   
-0001ef30: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-0001ef40: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-0001ef50: 2d63 207b 6e61 6d65 7d20 2d2d 7265 7472  -c {name} --retr
-0001ef60: 792d 756e 7469 6c2d 7570 202d 7920 7465  y-until-up -y te
-0001ef70: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
-0001ef80: 6573 745f 6375 7374 6f6d 5f69 6d61 6765  est_custom_image
-0001ef90: 2e79 616d 6c20 2d2d 636c 6f75 6420 6177  .yaml --cloud aw
-0001efa0: 7320 2d2d 7265 6769 6f6e 2075 732d 6561  s --region us-ea
-0001efb0: 7374 2d32 202d 2d69 6d61 6765 2d69 6420  st-2 --image-id 
-0001efc0: 616d 692d 3036 3264 6464 3930 6662 3666  ami-062ddd90fb6f
-0001efd0: 3832 3637 6127 2c20 2023 204e 7669 6469  8267a',  # Nvidi
-0001efe0: 6120 696d 6167 650a 2020 2020 2020 2020  a image.        
-0001eff0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-0001f000: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
-0001f010: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-0001f020: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-0001f030: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-0001f040: 2020 2020 2074 696d 656f 7574 3d33 3020       timeout=30 
-0001f050: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
-0001f060: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0001f070: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-0001f080: 6b2e 6b75 6265 726e 6574 6573 0a40 7079  k.kubernetes.@py
-0001f090: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
-0001f0a0: 7472 697a 6528 0a20 2020 2027 696d 6167  trize(.    'imag
-0001f0b0: 655f 6964 272c 0a20 2020 205b 0a20 2020  e_id',.    [.   
-0001f0c0: 2020 2020 2027 646f 636b 6572 3a6e 7669       'docker:nvi
-0001f0d0: 6469 612f 6375 6461 3a31 312e 382e 302d  dia/cuda:11.8.0-
-0001f0e0: 6465 7665 6c2d 7562 756e 7475 3138 2e30  devel-ubuntu18.0
-0001f0f0: 3427 2c0a 2020 2020 2020 2020 2764 6f63  4',.        'doc
-0001f100: 6b65 723a 7562 756e 7475 3a31 382e 3034  ker:ubuntu:18.04
-0001f110: 272c 0a20 2020 2020 2020 2023 2054 6573  ',.        # Tes
-0001f120: 7420 6c61 7465 7374 2069 6d61 6765 2077  t latest image w
-0001f130: 6974 6820 7079 7468 6f6e 2033 2e31 3120  ith python 3.11 
-0001f140: 696e 7374 616c 6c65 6420 6279 2064 6566  installed by def
-0001f150: 6175 6c74 2e0a 2020 2020 2020 2020 2320  ault..        # 
-0001f160: 446f 6573 206e 6f74 2077 6f72 6b20 666f  Does not work fo
-0001f170: 7220 7079 7468 6f6e 2033 2e31 3220 6475  r python 3.12 du
-0001f180: 6520 746f 2072 6179 2773 2072 6571 7569  e to ray's requi
-0001f190: 7265 6d65 6e74 2066 6f72 2033 2e31 312e  rement for 3.11.
-0001f1a0: 0a20 2020 2020 2020 2027 646f 636b 6572  .        'docker
-0001f1b0: 3a63 6f6e 7469 6e75 756d 696f 2f6d 696e  :continuumio/min
-0001f1c0: 6963 6f6e 6461 333a 3234 2e31 2e32 2d30  iconda3:24.1.2-0
-0001f1d0: 272c 0a20 2020 205d 290a 6465 6620 7465  ',.    ]).def te
-0001f1e0: 7374 5f6b 7562 6572 6e65 7465 735f 6375  st_kubernetes_cu
-0001f1f0: 7374 6f6d 5f69 6d61 6765 2869 6d61 6765  stom_image(image
-0001f200: 5f69 6429 3a0a 2020 2020 2222 2254 6573  _id):.    """Tes
-0001f210: 7420 4b75 6265 726e 6574 6573 2063 7573  t Kubernetes cus
-0001f220: 746f 6d20 696d 6167 6522 2222 0a20 2020  tom image""".   
-0001f230: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-0001f240: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-0001f250: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-0001f260: 2020 2020 2027 7465 7374 2d6b 7562 6572       'test-kuber
-0001f270: 6e65 7465 732d 6375 7374 6f6d 2d69 6d61  netes-custom-ima
-0001f280: 6765 272c 0a20 2020 2020 2020 205b 0a20  ge',.        [. 
-0001f290: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0001f2a0: 206c 6175 6e63 6820 2d63 207b 6e61 6d65   launch -c {name
-0001f2b0: 7d20 2d2d 7265 7472 792d 756e 7469 6c2d  } --retry-until-
-0001f2c0: 7570 202d 7920 7465 7374 732f 7465 7374  up -y tests/test
-0001f2d0: 5f79 616d 6c73 2f74 6573 745f 6375 7374  _yamls/test_cust
-0001f2e0: 6f6d 5f69 6d61 6765 2e79 616d 6c20 2d2d  om_image.yaml --
-0001f2f0: 636c 6f75 6420 6b75 6265 726e 6574 6573  cloud kubernetes
-0001f300: 202d 2d69 6d61 6765 2d69 6420 7b69 6d61   --image-id {ima
-0001f310: 6765 5f69 647d 202d 2d72 6567 696f 6e20  ge_id} --region 
-0001f320: 4e6f 6e65 202d 2d67 7075 7320 5434 3a31  None --gpus T4:1
-0001f330: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001f340: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0001f350: 2031 202d 2d73 7461 7475 7327 2c0a 2020   1 --status',.  
-0001f360: 2020 2020 2020 2020 2020 2320 5472 7920            # Try 
-0001f370: 6578 6563 2074 6f20 7275 6e20 6167 6169  exec to run agai
-0001f380: 6e20 616e 6420 6368 6563 6b20 6966 2074  n and check if t
-0001f390: 6865 206c 6f67 7320 6172 6520 7072 696e  he logs are prin
-0001f3a0: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
-0001f3b0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-0001f3c0: 7d20 7465 7374 732f 7465 7374 5f79 616d  } tests/test_yam
-0001f3d0: 6c73 2f74 6573 745f 6375 7374 6f6d 5f69  ls/test_custom_i
-0001f3e0: 6d61 6765 2e79 616d 6c20 2d2d 636c 6f75  mage.yaml --clou
-0001f3f0: 6420 6b75 6265 726e 6574 6573 202d 2d69  d kubernetes --i
-0001f400: 6d61 6765 2d69 6420 7b69 6d61 6765 5f69  mage-id {image_i
-0001f410: 647d 202d 2d72 6567 696f 6e20 4e6f 6e65  d} --region None
-0001f420: 202d 2d67 7075 7320 5434 3a31 207c 2067   --gpus T4:1 | g
-0001f430: 7265 7020 2248 656c 6c6f 2031 3030 2227  rep "Hello 100"'
-0001f440: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-0001f450: 4d61 6b65 2073 7572 6520 7373 6820 6973  Make sure ssh is
-0001f460: 2077 6f72 6b69 6e67 2077 6974 6820 6375   working with cu
-0001f470: 7374 6f6d 2075 7365 726e 616d 650a 2020  stom username.  
-0001f480: 2020 2020 2020 2020 2020 6627 7373 6820            f'ssh 
-0001f490: 7b6e 616d 657d 2065 6368 6f20 6869 207c  {name} echo hi |
-0001f4a0: 2067 7265 7020 6869 272c 0a20 2020 2020   grep hi',.     
-0001f4b0: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-0001f4c0: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-0001f4d0: 657d 272c 0a20 2020 2020 2020 2074 696d  e}',.        tim
-0001f4e0: 656f 7574 3d33 3020 2a20 3630 2c0a 2020  eout=30 * 60,.  
-0001f4f0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-0001f500: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-0001f510: 7465 7374 2e6d 6172 6b2e 736c 6f77 0a64  test.mark.slow.d
-0001f520: 6566 2074 6573 745f 617a 7572 655f 7374  ef test_azure_st
-0001f530: 6172 745f 7374 6f70 5f74 776f 5f6e 6f64  art_stop_two_nod
-0001f540: 6573 2829 3a0a 2020 2020 6e61 6d65 203d  es():.    name =
-0001f550: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-0001f560: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-0001f570: 5465 7374 280a 2020 2020 2020 2020 2761  Test(.        'a
-0001f580: 7a75 7265 2d73 7461 7274 2d73 746f 702d  zure-start-stop-
-0001f590: 7477 6f2d 6e6f 6465 7327 2c0a 2020 2020  two-nodes',.    
-0001f5a0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0001f5b0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-0001f5c0: 2d6e 756d 2d6e 6f64 6573 3d32 202d 7920  -num-nodes=2 -y 
-0001f5d0: 2d63 207b 6e61 6d65 7d20 6578 616d 706c  -c {name} exampl
-0001f5e0: 6573 2f61 7a75 7265 5f73 7461 7274 5f73  es/azure_start_s
-0001f5f0: 746f 702e 7961 6d6c 272c 0a20 2020 2020  top.yaml',.     
-0001f600: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-0001f610: 6320 2d2d 6e75 6d2d 6e6f 6465 733d 3220  c --num-nodes=2 
-0001f620: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
-0001f630: 617a 7572 655f 7374 6172 745f 7374 6f70  azure_start_stop
-0001f640: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-0001f650: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-0001f660: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
-0001f670: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-0001f680: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
-0001f690: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0001f6a0: 7920 7374 6f70 202d 7920 7b6e 616d 657d  y stop -y {name}
-0001f6b0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001f6c0: 2773 6b79 2073 7461 7274 202d 7920 7b6e  'sky start -y {n
-0001f6d0: 616d 657d 202d 6920 3127 2c0a 2020 2020  ame} -i 1',.    
-0001f6e0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-0001f6f0: 6563 202d 2d6e 756d 2d6e 6f64 6573 3d32  ec --num-nodes=2
-0001f700: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
-0001f710: 2f61 7a75 7265 5f73 7461 7274 5f73 746f  /azure_start_sto
-0001f720: 702e 7961 6d6c 272c 0a20 2020 2020 2020  p.yaml',.       
-0001f730: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-0001f740: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
-0001f750: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-0001f760: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-0001f770: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0001f780: 6565 7020 3230 3027 2c0a 2020 2020 2020  eep 200',.      
-0001f790: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
-0001f7a0: 7374 6174 7573 202d 7220 7b6e 616d 657d  status -r {name}
-0001f7b0: 2920 2626 2065 6368 6f20 2224 7322 2026  ) && echo "$s" &
-0001f7c0: 2620 6563 686f 2022 2473 2220 7c20 6772  & echo "$s" | gr
-0001f7d0: 6570 2022 494e 4954 5c7c 5354 4f50 5045  ep "INIT\|STOPPE
-0001f7e0: 4422 270a 2020 2020 2020 2020 2020 2020  D"'.            
-0001f7f0: 6627 7c7c 207b 7b20 7373 6820 7b6e 616d  f'|| {{ ssh {nam
-0001f800: 657d 2022 6361 7420 7e2f 2e73 6b79 2f73  e} "cat ~/.sky/s
-0001f810: 6b79 6c65 742e 6c6f 6722 3b20 6578 6974  kylet.log"; exit
-0001f820: 2031 3b20 7d7d 270a 2020 2020 2020 2020   1; }}'.        
-0001f830: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-0001f840: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-0001f850: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-0001f860: 743d 3330 202a 2036 302c 2020 2320 3330  t=30 * 60,  # 30
-0001f870: 206d 696e 7320 2028 6974 2074 616b 6573   mins  (it takes
-0001f880: 2061 726f 756e 6420 7e32 3320 6d69 6e73   around ~23 mins
-0001f890: 290a 2020 2020 290a 2020 2020 7275 6e5f  ).    ).    run_
-0001f8a0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-0001f8b0: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
-0001f8c0: 7374 696e 6720 656e 7620 666f 7220 6469  sting env for di
-0001f8d0: 736b 2074 6965 7220 2d2d 2d2d 2d2d 2d2d  sk tier --------
-0001f8e0: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
-0001f8f0: 6177 730a 6465 6620 7465 7374 5f61 7773  aws.def test_aws
-0001f900: 5f64 6973 6b5f 7469 6572 2829 3a0a 0a20  _disk_tier():.. 
-0001f910: 2020 2064 6566 205f 6765 745f 6177 735f     def _get_aws_
-0001f920: 7175 6572 795f 636f 6d6d 616e 6428 7265  query_command(re
-0001f930: 6769 6f6e 2c20 696e 7374 616e 6365 5f69  gion, instance_i
-0001f940: 642c 2066 6965 6c64 2c20 6578 7065 6374  d, field, expect
-0001f950: 6564 293a 0a20 2020 2020 2020 2072 6574  ed):.        ret
-0001f960: 7572 6e20 2866 2761 7773 2065 6332 2064  urn (f'aws ec2 d
-0001f970: 6573 6372 6962 652d 766f 6c75 6d65 7320  escribe-volumes 
-0001f980: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
-0001f990: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
-0001f9a0: 2020 2020 6627 2d2d 6669 6c74 6572 7320      f'--filters 
-0001f9b0: 4e61 6d65 3d61 7474 6163 686d 656e 742e  Name=attachment.
-0001f9c0: 696e 7374 616e 6365 2d69 642c 5661 6c75  instance-id,Valu
-0001f9d0: 6573 3d7b 696e 7374 616e 6365 5f69 647d  es={instance_id}
-0001f9e0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0001f9f0: 2020 2066 272d 2d71 7565 7279 2056 6f6c     f'--query Vol
-0001fa00: 756d 6573 5b2a 5d2e 7b66 6965 6c64 7d20  umes[*].{field} 
-0001fa10: 7c20 6772 6570 207b 6578 7065 6374 6564  | grep {expected
-0001fa20: 7d20 3b20 2729 0a0a 2020 2020 666f 7220  } ; ')..    for 
-0001fa30: 6469 736b 5f74 6965 7220 696e 206c 6973  disk_tier in lis
-0001fa40: 7428 7265 736f 7572 6365 735f 7574 696c  t(resources_util
-0001fa50: 732e 4469 736b 5469 6572 293a 0a20 2020  s.DiskTier):.   
-0001fa60: 2020 2020 2073 7065 6373 203d 2041 5753       specs = AWS
-0001fa70: 2e5f 6765 745f 6469 736b 5f73 7065 6373  ._get_disk_specs
-0001fa80: 2864 6973 6b5f 7469 6572 290a 2020 2020  (disk_tier).    
-0001fa90: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-0001faa0: 636c 7573 7465 725f 6e61 6d65 2829 202b  cluster_name() +
-0001fab0: 2027 2d27 202b 2064 6973 6b5f 7469 6572   '-' + disk_tier
-0001fac0: 2e76 616c 7565 0a20 2020 2020 2020 206e  .value.        n
-0001fad0: 616d 655f 6f6e 5f63 6c6f 7564 203d 2063  ame_on_cloud = c
-0001fae0: 6f6d 6d6f 6e5f 7574 696c 732e 6d61 6b65  ommon_utils.make
-0001faf0: 5f63 6c75 7374 6572 5f6e 616d 655f 6f6e  _cluster_name_on
-0001fb00: 5f63 6c6f 7564 280a 2020 2020 2020 2020  _cloud(.        
-0001fb10: 2020 2020 6e61 6d65 2c20 736b 792e 4157      name, sky.AW
-0001fb20: 532e 6d61 785f 636c 7573 7465 725f 6e61  S.max_cluster_na
-0001fb30: 6d65 5f6c 656e 6774 6828 2929 0a20 2020  me_length()).   
-0001fb40: 2020 2020 2072 6567 696f 6e20 3d20 2775       region = 'u
-0001fb50: 732d 6561 7374 2d32 270a 2020 2020 2020  s-east-2'.      
-0001fb60: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-0001fb70: 2020 2020 2020 2020 2020 2027 6177 732d             'aws-
-0001fb80: 6469 736b 2d74 6965 722d 2720 2b20 6469  disk-tier-' + di
-0001fb90: 736b 5f74 6965 722e 7661 6c75 652c 0a20  sk_tier.value,. 
-0001fba0: 2020 2020 2020 2020 2020 205b 0a20 2020             [.   
-0001fbb0: 2020 2020 2020 2020 2020 2020 2066 2773               f's
-0001fbc0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-0001fbd0: 7b6e 616d 657d 202d 2d63 6c6f 7564 2061  {name} --cloud a
-0001fbe0: 7773 202d 2d72 6567 696f 6e20 7b72 6567  ws --region {reg
-0001fbf0: 696f 6e7d 2027 0a20 2020 2020 2020 2020  ion} '.         
-0001fc00: 2020 2020 2020 2066 272d 2d64 6973 6b2d         f'--disk-
-0001fc10: 7469 6572 207b 6469 736b 5f74 6965 722e  tier {disk_tier.
-0001fc20: 7661 6c75 657d 2065 6368 6f20 2268 656c  value} echo "hel
-0001fc30: 6c6f 2073 6b79 2227 2c0a 2020 2020 2020  lo sky"',.      
-0001fc40: 2020 2020 2020 2020 2020 6627 6964 3d60            f'id=`
-0001fc50: 6177 7320 6563 3220 6465 7363 7269 6265  aws ec2 describe
-0001fc60: 2d69 6e73 7461 6e63 6573 202d 2d72 6567  -instances --reg
-0001fc70: 696f 6e20 7b72 6567 696f 6e7d 202d 2d66  ion {region} --f
-0001fc80: 696c 7465 7273 2027 0a20 2020 2020 2020  ilters '.       
-0001fc90: 2020 2020 2020 2020 2066 274e 616d 653d           f'Name=
-0001fca0: 7461 673a 7261 792d 636c 7573 7465 722d  tag:ray-cluster-
-0001fcb0: 6e61 6d65 2c56 616c 7565 733d 7b6e 616d  name,Values={nam
-0001fcc0: 655f 6f6e 5f63 6c6f 7564 7d20 2d2d 7175  e_on_cloud} --qu
-0001fcd0: 6572 7920 270a 2020 2020 2020 2020 2020  ery '.          
-0001fce0: 2020 2020 2020 6627 5265 7365 7276 6174        f'Reservat
-0001fcf0: 696f 6e73 5b5d 2e49 6e73 7461 6e63 6573  ions[].Instances
-0001fd00: 5b5d 2e49 6e73 7461 6e63 6549 6420 2d2d  [].InstanceId --
-0001fd10: 6f75 7470 7574 2074 6578 7460 3b20 2720  output text`; ' 
-0001fd20: 2b0a 2020 2020 2020 2020 2020 2020 2020  +.              
-0001fd30: 2020 5f67 6574 5f61 7773 5f71 7565 7279    _get_aws_query
-0001fd40: 5f63 6f6d 6d61 6e64 2872 6567 696f 6e2c  _command(region,
-0001fd50: 2027 2469 6427 2c20 2756 6f6c 756d 6554   '$id', 'VolumeT
-0001fd60: 7970 6527 2c0a 2020 2020 2020 2020 2020  ype',.          
-0001fd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fd80: 2020 2020 2020 2020 2020 2020 2073 7065               spe
-0001fd90: 6373 5b27 6469 736b 5f74 6965 7227 5d29  cs['disk_tier'])
-0001fda0: 202b 0a20 2020 2020 2020 2020 2020 2020   +.             
-0001fdb0: 2020 2028 2727 2069 6620 6469 736b 5f74     ('' if disk_t
-0001fdc0: 6965 7220 3d3d 2072 6573 6f75 7263 6573  ier == resources
-0001fdd0: 5f75 7469 6c73 2e44 6973 6b54 6965 722e  _utils.DiskTier.
-0001fde0: 4c4f 5720 656c 7365 0a20 2020 2020 2020  LOW else.       
-0001fdf0: 2020 2020 2020 2020 2020 285f 6765 745f            (_get_
-0001fe00: 6177 735f 7175 6572 795f 636f 6d6d 616e  aws_query_comman
-0001fe10: 6428 7265 6769 6f6e 2c20 2724 6964 272c  d(region, '$id',
-0001fe20: 2027 496f 7073 272c 0a20 2020 2020 2020   'Iops',.       
-0001fe30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fe40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fe50: 2020 7370 6563 735b 2764 6973 6b5f 696f    specs['disk_io
-0001fe60: 7073 275d 2920 2b0a 2020 2020 2020 2020  ps']) +.        
-0001fe70: 2020 2020 2020 2020 2020 5f67 6574 5f61            _get_a
-0001fe80: 7773 5f71 7565 7279 5f63 6f6d 6d61 6e64  ws_query_command
-0001fe90: 2872 6567 696f 6e2c 2027 2469 6427 2c20  (region, '$id', 
-0001fea0: 2754 6872 6f75 6768 7075 7427 2c0a 2020  'Throughput',.  
-0001feb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fed0: 2020 2020 2020 2073 7065 6373 5b27 6469         specs['di
-0001fee0: 736b 5f74 6872 6f75 6768 7075 7427 5d29  sk_throughput'])
-0001fef0: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-0001ff00: 5d2c 0a20 2020 2020 2020 2020 2020 2066  ],.            f
-0001ff10: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-0001ff20: 6d65 7d27 2c0a 2020 2020 2020 2020 2020  me}',.          
-0001ff30: 2020 7469 6d65 6f75 743d 3130 202a 2036    timeout=10 * 6
-0001ff40: 302c 2020 2320 3130 206d 696e 7320 2028  0,  # 10 mins  (
-0001ff50: 6974 2074 616b 6573 2061 726f 756e 6420  it takes around 
-0001ff60: 7e36 206d 696e 7329 0a20 2020 2020 2020  ~6 mins).       
-0001ff70: 2029 0a20 2020 2020 2020 2072 756e 5f6f   ).        run_o
-0001ff80: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-0001ff90: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
-0001ffa0: 0a64 6566 2074 6573 745f 6763 705f 6469  .def test_gcp_di
-0001ffb0: 736b 5f74 6965 7228 293a 0a20 2020 2066  sk_tier():.    f
-0001ffc0: 6f72 2064 6973 6b5f 7469 6572 2069 6e20  or disk_tier in 
-0001ffd0: 6c69 7374 2872 6573 6f75 7263 6573 5f75  list(resources_u
-0001ffe0: 7469 6c73 2e44 6973 6b54 6965 7229 3a0a  tils.DiskTier):.
-0001fff0: 2020 2020 2020 2020 7479 7065 203d 2047          type = G
-00020000: 4350 2e5f 6765 745f 6469 736b 5f74 7970  CP._get_disk_typ
-00020010: 6528 6469 736b 5f74 6965 7229 0a20 2020  e(disk_tier).   
-00020020: 2020 2020 206e 616d 6520 3d20 5f67 6574       name = _get
-00020030: 5f63 6c75 7374 6572 5f6e 616d 6528 2920  _cluster_name() 
-00020040: 2b20 272d 2720 2b20 6469 736b 5f74 6965  + '-' + disk_tie
-00020050: 722e 7661 6c75 650a 2020 2020 2020 2020  r.value.        
-00020060: 6e61 6d65 5f6f 6e5f 636c 6f75 6420 3d20  name_on_cloud = 
-00020070: 636f 6d6d 6f6e 5f75 7469 6c73 2e6d 616b  common_utils.mak
-00020080: 655f 636c 7573 7465 725f 6e61 6d65 5f6f  e_cluster_name_o
-00020090: 6e5f 636c 6f75 6428 0a20 2020 2020 2020  n_cloud(.       
-000200a0: 2020 2020 206e 616d 652c 2073 6b79 2e47       name, sky.G
-000200b0: 4350 2e6d 6178 5f63 6c75 7374 6572 5f6e  CP.max_cluster_n
-000200c0: 616d 655f 6c65 6e67 7468 2829 290a 2020  ame_length()).  
-000200d0: 2020 2020 2020 7265 6769 6f6e 203d 2027        region = '
-000200e0: 7573 2d77 6573 7432 270a 2020 2020 2020  us-west2'.      
-000200f0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00020100: 2020 2020 2020 2020 2020 2027 6763 702d             'gcp-
-00020110: 6469 736b 2d74 6965 722d 2720 2b20 6469  disk-tier-' + di
-00020120: 736b 5f74 6965 722e 7661 6c75 652c 0a20  sk_tier.value,. 
-00020130: 2020 2020 2020 2020 2020 205b 0a20 2020             [.   
-00020140: 2020 2020 2020 2020 2020 2020 2066 2773               f's
-00020150: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-00020160: 7b6e 616d 657d 202d 2d63 6c6f 7564 2067  {name} --cloud g
-00020170: 6370 202d 2d72 6567 696f 6e20 7b72 6567  cp --region {reg
-00020180: 696f 6e7d 2027 0a20 2020 2020 2020 2020  ion} '.         
-00020190: 2020 2020 2020 2066 272d 2d64 6973 6b2d         f'--disk-
-000201a0: 7469 6572 207b 6469 736b 5f74 6965 722e  tier {disk_tier.
-000201b0: 7661 6c75 657d 2065 6368 6f20 2268 656c  value} echo "hel
-000201c0: 6c6f 2073 6b79 2227 2c0a 2020 2020 2020  lo sky"',.      
-000201d0: 2020 2020 2020 2020 2020 6627 6e61 6d65            f'name
-000201e0: 3d60 6763 6c6f 7564 2063 6f6d 7075 7465  =`gcloud compute
-000201f0: 2069 6e73 7461 6e63 6573 206c 6973 7420   instances list 
-00020200: 2d2d 6669 6c74 6572 3d27 0a20 2020 2020  --filter='.     
-00020210: 2020 2020 2020 2020 2020 2066 2722 6c61             f'"la
-00020220: 6265 6c73 2e72 6179 2d63 6c75 7374 6572  bels.ray-cluster
-00020230: 2d6e 616d 653a 7b6e 616d 655f 6f6e 5f63  -name:{name_on_c
-00020240: 6c6f 7564 7d22 2027 0a20 2020 2020 2020  loud}" '.       
-00020250: 2020 2020 2020 2020 2027 2d2d 666f 726d           '--form
-00020260: 6174 3d22 7661 6c75 6528 6e61 6d65 2922  at="value(name)"
-00020270: 603b 2027 0a20 2020 2020 2020 2020 2020  `; '.           
-00020280: 2020 2020 2066 2767 636c 6f75 6420 636f       f'gcloud co
-00020290: 6d70 7574 6520 6469 736b 7320 6c69 7374  mpute disks list
-000202a0: 202d 2d66 696c 7465 723d 226e 616d 653d   --filter="name=
-000202b0: 246e 616d 6522 2027 0a20 2020 2020 2020  $name" '.       
-000202c0: 2020 2020 2020 2020 2066 272d 2d66 6f72           f'--for
-000202d0: 6d61 743d 2276 616c 7565 2874 7970 6529  mat="value(type)
-000202e0: 2220 7c20 6772 6570 207b 7479 7065 7d20  " | grep {type} 
-000202f0: 270a 2020 2020 2020 2020 2020 2020 5d2c  '.            ],
-00020300: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00020310: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00020320: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-00020330: 7469 6d65 6f75 743d 3620 2a20 3630 2c20  timeout=6 * 60, 
-00020340: 2023 2036 206d 696e 7320 2028 6974 2074   # 6 mins  (it t
-00020350: 616b 6573 2061 726f 756e 6420 7e33 206d  akes around ~3 m
-00020360: 696e 7329 0a20 2020 2020 2020 2029 0a20  ins).        ). 
-00020370: 2020 2020 2020 2072 756e 5f6f 6e65 5f74         run_one_t
-00020380: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-00020390: 6573 742e 6d61 726b 2e61 7a75 7265 0a64  est.mark.azure.d
-000203a0: 6566 2074 6573 745f 617a 7572 655f 6469  ef test_azure_di
-000203b0: 736b 5f74 6965 7228 293a 0a20 2020 2066  sk_tier():.    f
-000203c0: 6f72 2064 6973 6b5f 7469 6572 2069 6e20  or disk_tier in 
-000203d0: 6c69 7374 2872 6573 6f75 7263 6573 5f75  list(resources_u
-000203e0: 7469 6c73 2e44 6973 6b54 6965 7229 3a0a  tils.DiskTier):.
-000203f0: 2020 2020 2020 2020 6966 2064 6973 6b5f          if disk_
-00020400: 7469 6572 203d 3d20 7265 736f 7572 6365  tier == resource
-00020410: 735f 7574 696c 732e 4469 736b 5469 6572  s_utils.DiskTier
-00020420: 2e48 4947 483a 0a20 2020 2020 2020 2020  .HIGH:.         
-00020430: 2020 2023 2041 7a75 7265 2064 6f65 7320     # Azure does 
-00020440: 6e6f 7420 7375 7070 6f72 7420 6869 6768  not support high
-00020450: 2064 6973 6b20 7469 6572 2e0a 2020 2020   disk tier..    
-00020460: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-00020470: 0a20 2020 2020 2020 2074 7970 6520 3d20  .        type = 
-00020480: 417a 7572 652e 5f67 6574 5f64 6973 6b5f  Azure._get_disk_
-00020490: 7479 7065 2864 6973 6b5f 7469 6572 290a  type(disk_tier).
-000204a0: 2020 2020 2020 2020 6e61 6d65 203d 205f          name = _
-000204b0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-000204c0: 2829 202b 2027 2d27 202b 2064 6973 6b5f  () + '-' + disk_
-000204d0: 7469 6572 2e76 616c 7565 0a20 2020 2020  tier.value.     
-000204e0: 2020 206e 616d 655f 6f6e 5f63 6c6f 7564     name_on_cloud
-000204f0: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
-00020500: 6d61 6b65 5f63 6c75 7374 6572 5f6e 616d  make_cluster_nam
-00020510: 655f 6f6e 5f63 6c6f 7564 280a 2020 2020  e_on_cloud(.    
-00020520: 2020 2020 2020 2020 6e61 6d65 2c20 736b          name, sk
-00020530: 792e 417a 7572 652e 6d61 785f 636c 7573  y.Azure.max_clus
-00020540: 7465 725f 6e61 6d65 5f6c 656e 6774 6828  ter_name_length(
-00020550: 2929 0a20 2020 2020 2020 2072 6567 696f  )).        regio
-00020560: 6e20 3d20 2777 6573 7475 7332 270a 2020  n = 'westus2'.  
-00020570: 2020 2020 2020 7465 7374 203d 2054 6573        test = Tes
-00020580: 7428 0a20 2020 2020 2020 2020 2020 2027  t(.            '
-00020590: 617a 7572 652d 6469 736b 2d74 6965 722d  azure-disk-tier-
-000205a0: 2720 2b20 6469 736b 5f74 6965 722e 7661  ' + disk_tier.va
-000205b0: 6c75 652c 0a20 2020 2020 2020 2020 2020  lue,.           
-000205c0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-000205d0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-000205e0: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
-000205f0: 6c6f 7564 2061 7a75 7265 202d 2d72 6567  loud azure --reg
-00020600: 696f 6e20 7b72 6567 696f 6e7d 2027 0a20  ion {region} '. 
-00020610: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00020620: 272d 2d64 6973 6b2d 7469 6572 207b 6469  '--disk-tier {di
-00020630: 736b 5f74 6965 722e 7661 6c75 657d 2065  sk_tier.value} e
-00020640: 6368 6f20 2268 656c 6c6f 2073 6b79 2227  cho "hello sky"'
-00020650: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00020660: 2020 6627 617a 2072 6573 6f75 7263 6520    f'az resource 
-00020670: 6c69 7374 202d 2d74 6167 2072 6179 2d63  list --tag ray-c
-00020680: 6c75 7374 6572 2d6e 616d 653d 7b6e 616d  luster-name={nam
-00020690: 655f 6f6e 5f63 6c6f 7564 7d20 2d2d 7175  e_on_cloud} --qu
-000206a0: 6572 7920 270a 2020 2020 2020 2020 2020  ery '.          
-000206b0: 2020 2020 2020 6627 225b 3f74 7970 653d        f'"[?type=
-000206c0: 3d5c 274d 6963 726f 736f 6674 2e43 6f6d  =\'Microsoft.Com
-000206d0: 7075 7465 2f64 6973 6b73 5c27 5d2e 736b  pute/disks\'].sk
-000206e0: 752e 6e61 6d65 2220 270a 2020 2020 2020  u.name" '.      
-000206f0: 2020 2020 2020 2020 2020 6627 2d2d 6f75            f'--ou
-00020700: 7470 7574 2074 7376 207c 2067 7265 7020  tput tsv | grep 
-00020710: 7b74 7970 657d 270a 2020 2020 2020 2020  {type}'.        
-00020720: 2020 2020 5d2c 0a20 2020 2020 2020 2020      ],.         
-00020730: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-00020740: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
-00020750: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
-00020760: 202a 2036 302c 2020 2320 3230 206d 696e   * 60,  # 20 min
-00020770: 7320 2028 6974 2074 616b 6573 2061 726f  s  (it takes aro
-00020780: 756e 6420 7e31 3220 6d69 6e73 290a 2020  und ~12 mins).  
-00020790: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000207a0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-000207b0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-000207c0: 6b2e 617a 7572 650a 6465 6620 7465 7374  k.azure.def test
-000207d0: 5f61 7a75 7265 5f62 6573 745f 7469 6572  _azure_best_tier
-000207e0: 5f66 6169 6c6f 7665 7228 293a 0a20 2020  _failover():.   
-000207f0: 2074 7970 6520 3d20 417a 7572 652e 5f67   type = Azure._g
-00020800: 6574 5f64 6973 6b5f 7479 7065 2872 6573  et_disk_type(res
-00020810: 6f75 7263 6573 5f75 7469 6c73 2e44 6973  ources_utils.Dis
-00020820: 6b54 6965 722e 4c4f 5729 0a20 2020 206e  kTier.LOW).    n
-00020830: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00020840: 6572 5f6e 616d 6528 290a 2020 2020 6e61  er_name().    na
-00020850: 6d65 5f6f 6e5f 636c 6f75 6420 3d20 636f  me_on_cloud = co
-00020860: 6d6d 6f6e 5f75 7469 6c73 2e6d 616b 655f  mmon_utils.make_
-00020870: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
-00020880: 636c 6f75 6428 0a20 2020 2020 2020 206e  cloud(.        n
-00020890: 616d 652c 2073 6b79 2e41 7a75 7265 2e6d  ame, sky.Azure.m
-000208a0: 6178 5f63 6c75 7374 6572 5f6e 616d 655f  ax_cluster_name_
-000208b0: 6c65 6e67 7468 2829 290a 2020 2020 7265  length()).    re
-000208c0: 6769 6f6e 203d 2027 7765 7374 7573 3227  gion = 'westus2'
-000208d0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-000208e0: 280a 2020 2020 2020 2020 2761 7a75 7265  (.        'azure
-000208f0: 2d62 6573 742d 7469 6572 2d66 6169 6c6f  -best-tier-failo
-00020900: 7665 7227 2c0a 2020 2020 2020 2020 5b0a  ver',.        [.
-00020910: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00020920: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-00020930: 6e61 6d65 7d20 2d2d 636c 6f75 6420 617a  name} --cloud az
-00020940: 7572 6520 2d2d 7265 6769 6f6e 207b 7265  ure --region {re
-00020950: 6769 6f6e 7d20 270a 2020 2020 2020 2020  gion} '.        
-00020960: 2020 2020 6627 2d2d 6469 736b 2d74 6965      f'--disk-tie
-00020970: 7220 6265 7374 202d 2d69 6e73 7461 6e63  r best --instanc
-00020980: 652d 7479 7065 2053 7461 6e64 6172 645f  e-type Standard_
-00020990: 4438 5f76 3520 6563 686f 2022 6865 6c6c  D8_v5 echo "hell
-000209a0: 6f20 736b 7922 272c 0a20 2020 2020 2020  o sky"',.       
-000209b0: 2020 2020 2066 2761 7a20 7265 736f 7572       f'az resour
-000209c0: 6365 206c 6973 7420 2d2d 7461 6720 7261  ce list --tag ra
-000209d0: 792d 636c 7573 7465 722d 6e61 6d65 3d7b  y-cluster-name={
-000209e0: 6e61 6d65 5f6f 6e5f 636c 6f75 647d 202d  name_on_cloud} -
-000209f0: 2d71 7565 7279 2027 0a20 2020 2020 2020  -query '.       
-00020a00: 2020 2020 2066 2722 5b3f 7479 7065 3d3d       f'"[?type==
-00020a10: 5c27 4d69 6372 6f73 6f66 742e 436f 6d70  \'Microsoft.Comp
-00020a20: 7574 652f 6469 736b 735c 275d 2e73 6b75  ute/disks\'].sku
-00020a30: 2e6e 616d 6522 2027 0a20 2020 2020 2020  .name" '.       
-00020a40: 2020 2020 2066 272d 2d6f 7574 7075 7420       f'--output 
-00020a50: 7473 7620 7c20 6772 6570 207b 7479 7065  tsv | grep {type
-00020a60: 7d27 2c0a 2020 2020 2020 2020 5d2c 0a20  }',.        ],. 
-00020a70: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-00020a80: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-00020a90: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
-00020aa0: 202a 2036 302c 2020 2320 3230 206d 696e   * 60,  # 20 min
-00020ab0: 7320 2028 6974 2074 616b 6573 2061 726f  s  (it takes aro
-00020ac0: 756e 6420 7e31 3220 6d69 6e73 290a 2020  und ~12 mins).  
-00020ad0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00020ae0: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
-00020af0: 2d2d 2d2d 2d20 5465 7374 696e 6720 5a65  ----- Testing Ze
-00020b00: 726f 2051 756f 7461 2046 6169 6c6f 7665  ro Quota Failove
-00020b10: 7220 2d2d 2d2d 2d2d 0a40 7079 7465 7374  r ------.@pytest
-00020b20: 2e6d 6172 6b2e 6177 730a 6465 6620 7465  .mark.aws.def te
-00020b30: 7374 5f61 7773 5f7a 6572 6f5f 7175 6f74  st_aws_zero_quot
-00020b40: 615f 6661 696c 6f76 6572 2829 3a0a 0a20  a_failover():.. 
-00020b50: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-00020b60: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-00020b70: 2020 7265 6769 6f6e 203d 2067 6574 5f61    region = get_a
-00020b80: 7773 5f72 6567 696f 6e5f 666f 725f 7175  ws_region_for_qu
-00020b90: 6f74 615f 6661 696c 6f76 6572 2829 0a0a  ota_failover()..
-00020ba0: 2020 2020 6966 206e 6f74 2072 6567 696f      if not regio
-00020bb0: 6e3a 0a20 2020 2020 2020 2070 7974 6573  n:.        pytes
-00020bc0: 742e 7866 6169 6c28 0a20 2020 2020 2020  t.xfail(.       
-00020bd0: 2020 2020 2027 556e 6162 6c65 2074 6f20       'Unable to 
-00020be0: 7465 7374 207a 6572 6f20 7175 6f74 6120  test zero quota 
-00020bf0: 6661 696c 6f76 6572 206f 7074 696d 697a  failover optimiz
-00020c00: 6174 696f 6e20 e280 9420 7175 6f74 6173  ation ... quotas
-00020c10: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-00020c20: 666f 7220 4543 3220 5033 2069 6e73 7461  for EC2 P3 insta
-00020c30: 6e63 6573 2077 6572 6520 666f 756e 6420  nces were found 
-00020c40: 6f6e 2061 6c6c 2041 5753 2072 6567 696f  on all AWS regio
-00020c50: 6e73 2e20 4973 2074 6869 7320 270a 2020  ns. Is this '.  
-00020c60: 2020 2020 2020 2020 2020 2765 7870 6563            'expec
-00020c70: 7465 6420 666f 7220 796f 7572 2061 6363  ted for your acc
-00020c80: 6f75 6e74 3f27 290a 2020 2020 2020 2020  ount?').        
-00020c90: 7265 7475 726e 0a0a 2020 2020 7465 7374  return..    test
-00020ca0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00020cb0: 2027 6177 732d 7a65 726f 2d71 756f 7461   'aws-zero-quota
-00020cc0: 2d66 6169 6c6f 7665 7227 2c0a 2020 2020  -failover',.    
-00020cd0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00020ce0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00020cf0: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
-00020d00: 6f75 6420 6177 7320 2d2d 7265 6769 6f6e  oud aws --region
-00020d10: 207b 7265 6769 6f6e 7d20 2d2d 6770 7573   {region} --gpus
-00020d20: 2056 3130 303a 3820 2d2d 7573 652d 7370   V100:8 --use-sp
-00020d30: 6f74 207c 2067 7265 7020 2246 6f75 6e64  ot | grep "Found
-00020d40: 206e 6f20 7175 6f74 6122 272c 0a20 2020   no quota"',.   
-00020d50: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00020d60: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-00020d70: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
-00020d80: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00020d90: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00020da0: 726b 2e67 6370 0a64 6566 2074 6573 745f  rk.gcp.def test_
-00020db0: 6763 705f 7a65 726f 5f71 756f 7461 5f66  gcp_zero_quota_f
-00020dc0: 6169 6c6f 7665 7228 293a 0a0a 2020 2020  ailover():..    
-00020dd0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-00020de0: 7465 725f 6e61 6d65 2829 0a20 2020 2072  ter_name().    r
-00020df0: 6567 696f 6e20 3d20 6765 745f 6763 705f  egion = get_gcp_
-00020e00: 7265 6769 6f6e 5f66 6f72 5f71 756f 7461  region_for_quota
-00020e10: 5f66 6169 6c6f 7665 7228 290a 0a20 2020  _failover()..   
-00020e20: 2069 6620 6e6f 7420 7265 6769 6f6e 3a0a   if not region:.
-00020e30: 2020 2020 2020 2020 7079 7465 7374 2e78          pytest.x
-00020e40: 6661 696c 280a 2020 2020 2020 2020 2020  fail(.          
-00020e50: 2020 2755 6e61 626c 6520 746f 2074 6573    'Unable to tes
-00020e60: 7420 7a65 726f 2071 756f 7461 2066 6169  t zero quota fai
-00020e70: 6c6f 7665 7220 6f70 7469 6d69 7a61 7469  lover optimizati
-00020e80: 6f6e 20e2 8094 2071 756f 7461 7320 270a  on ... quotas '.
-00020e90: 2020 2020 2020 2020 2020 2020 2766 6f72              'for
-00020ea0: 2041 3130 302d 3830 4742 2047 5055 7320   A100-80GB GPUs 
-00020eb0: 7765 7265 2066 6f75 6e64 206f 6e20 616c  were found on al
-00020ec0: 6c20 4743 5020 7265 6769 6f6e 732e 2049  l GCP regions. I
-00020ed0: 7320 7468 6973 2027 0a20 2020 2020 2020  s this '.       
-00020ee0: 2020 2020 2027 6578 7065 6374 6564 2066       'expected f
-00020ef0: 6f72 2079 6f75 7220 6163 636f 756e 743f  or your account?
-00020f00: 2729 0a20 2020 2020 2020 2072 6574 7572  ').        retur
-00020f10: 6e0a 0a20 2020 2074 6573 7420 3d20 5465  n..    test = Te
-00020f20: 7374 280a 2020 2020 2020 2020 2767 6370  st(.        'gcp
-00020f30: 2d7a 6572 6f2d 7175 6f74 612d 6661 696c  -zero-quota-fail
-00020f40: 6f76 6572 272c 0a20 2020 2020 2020 205b  over',.        [
-00020f50: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00020f60: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-00020f70: 7b6e 616d 657d 202d 2d63 6c6f 7564 2067  {name} --cloud g
-00020f80: 6370 202d 2d72 6567 696f 6e20 7b72 6567  cp --region {reg
-00020f90: 696f 6e7d 202d 2d67 7075 7320 4131 3030  ion} --gpus A100
-00020fa0: 2d38 3047 423a 3120 2d2d 7573 652d 7370  -80GB:1 --use-sp
-00020fb0: 6f74 207c 2067 7265 7020 2246 6f75 6e64  ot | grep "Found
-00020fc0: 206e 6f20 7175 6f74 6122 272c 0a20 2020   no quota"',.   
-00020fd0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00020fe0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-00020ff0: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
-00021000: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00021010: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
-00021020: 2d2d 2054 6573 7469 6e67 2073 6b79 7365  -- Testing skyse
-00021030: 7276 6520 2d2d 2d2d 2d2d 2d2d 2d2d 0a0a  rve ----------..
-00021040: 0a64 6566 205f 6765 745f 7365 7276 6963  .def _get_servic
-00021050: 655f 6e61 6d65 2829 202d 3e20 7374 723a  e_name() -> str:
-00021060: 0a20 2020 2022 2222 5265 7475 726e 7320  .    """Returns 
-00021070: 6120 7573 6572 2d75 6e69 7175 6520 7365  a user-unique se
-00021080: 7276 6963 6520 6e61 6d65 2066 6f72 2065  rvice name for e
-00021090: 6163 6820 7465 7374 5f73 6b79 7365 7276  ach test_skyserv
-000210a0: 655f 3c6e 616d 653e 2829 2e0a 0a20 2020  e_<name>()...   
-000210b0: 204d 7573 7420 6265 2063 616c 6c65 6420   Must be called 
-000210c0: 6672 6f6d 2065 6163 6820 7465 7374 5f73  from each test_s
-000210d0: 6b79 7365 7276 655f 3c6e 616d 653e 2829  kyserve_<name>()
-000210e0: 2e0a 2020 2020 2222 220a 2020 2020 6361  ..    """.    ca
-000210f0: 6c6c 6572 5f66 756e 635f 6e61 6d65 203d  ller_func_name =
-00021100: 2069 6e73 7065 6374 2e73 7461 636b 2829   inspect.stack()
-00021110: 5b31 5d5b 335d 0a20 2020 2074 6573 745f  [1][3].    test_
-00021120: 6e61 6d65 203d 2063 616c 6c65 725f 6675  name = caller_fu
-00021130: 6e63 5f6e 616d 652e 7265 706c 6163 6528  nc_name.replace(
-00021140: 275f 272c 2027 2d27 292e 7265 706c 6163  '_', '-').replac
-00021150: 6528 2774 6573 742d 272c 2027 742d 2729  e('test-', 't-')
-00021160: 0a20 2020 2074 6573 745f 6e61 6d65 203d  .    test_name =
-00021170: 2074 6573 745f 6e61 6d65 2e72 6570 6c61   test_name.repla
-00021180: 6365 2827 736b 7973 6572 7665 2d27 2c20  ce('skyserve-', 
-00021190: 2773 732d 2729 0a20 2020 2074 6573 745f  'ss-').    test_
-000211a0: 6e61 6d65 203d 2063 6f6d 6d6f 6e5f 7574  name = common_ut
-000211b0: 696c 732e 6d61 6b65 5f63 6c75 7374 6572  ils.make_cluster
-000211c0: 5f6e 616d 655f 6f6e 5f63 6c6f 7564 2874  _name_on_cloud(t
-000211d0: 6573 745f 6e61 6d65 2c20 3234 290a 2020  est_name, 24).  
-000211e0: 2020 7265 7475 726e 2066 277b 7465 7374    return f'{test
-000211f0: 5f6e 616d 657d 2d7b 7465 7374 5f69 647d  _name}-{test_id}
-00021200: 270a 0a0a 2320 5765 2063 6865 636b 2074  '...# We check t
-00021210: 6865 206f 7574 7075 7420 6f66 2074 6865  he output of the
-00021220: 2073 6b79 7365 7276 6520 7365 7276 6963   skyserve servic
-00021230: 6520 746f 2073 6565 2069 6620 6974 2069  e to see if it i
-00021240: 7320 7265 6164 792e 204f 7574 7075 7420  s ready. Output 
-00021250: 6f66 0a23 2060 5245 504c 4943 4153 6020  of.# `REPLICAS` 
-00021260: 6973 2069 6e20 7468 6520 666f 726d 206f  is in the form o
-00021270: 6620 6031 2f32 6020 7768 6572 6520 7468  f `1/2` where th
-00021280: 6520 6669 7273 7420 6e75 6d62 6572 2069  e first number i
-00021290: 7320 7468 6520 6e75 6d62 6572 206f 660a  s the number of.
-000212a0: 2320 7265 6164 7920 7265 706c 6963 6173  # ready replicas
-000212b0: 2061 6e64 2074 6865 2073 6563 6f6e 6420   and the second 
-000212c0: 6e75 6d62 6572 2069 7320 7468 6520 6e75  number is the nu
-000212d0: 6d62 6572 206f 6620 746f 7461 6c20 7265  mber of total re
-000212e0: 706c 6963 6173 2e20 5765 0a23 2067 7265  plicas. We.# gre
-000212f0: 7020 7375 6368 2066 6f72 6d61 7420 746f  p such format to
-00021300: 2065 6e73 7572 6520 7468 6174 2074 6865   ensure that the
-00021310: 2073 6572 7669 6365 2069 7320 7265 6164   service is read
-00021320: 792c 2061 6e64 2065 6172 6c79 2065 7869  y, and early exi
-00021330: 7420 6966 2061 6e79 0a23 2066 6169 6c75  t if any.# failu
-00021340: 7265 2064 6574 6563 7465 642e 2049 6e20  re detected. In 
-00021350: 7468 6520 656e 6420 7765 2073 6c65 6570  the end we sleep
-00021360: 2066 6f72 0a23 2073 6572 7665 2e4c 425f   for.# serve.LB_
-00021370: 434f 4e54 524f 4c4c 4552 5f53 594e 435f  CONTROLLER_SYNC_
-00021380: 494e 5445 5256 414c 5f53 4543 4f4e 4453  INTERVAL_SECONDS
-00021390: 2074 6f20 6d61 6b65 2073 7572 6520 6c6f   to make sure lo
-000213a0: 6164 2062 616c 616e 6365 7220 6861 7665  ad balancer have
-000213b0: 0a23 2065 6e6f 7567 6820 7469 6d65 2074  .# enough time t
-000213c0: 6f20 7379 6e63 2077 6974 6820 7468 6520  o sync with the 
-000213d0: 636f 6e74 726f 6c6c 6572 2061 6e64 2067  controller and g
-000213e0: 6574 2061 6c6c 2072 6561 6479 2072 6570  et all ready rep
-000213f0: 6c69 6361 2049 5073 2e0a 5f53 4552 5645  lica IPs.._SERVE
-00021400: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
-00021410: 5920 3d20 280a 2020 2020 277b 7b20 7768  Y = (.    '{{ wh
-00021420: 696c 6520 7472 7565 3b20 646f 270a 2020  ile true; do'.  
-00021430: 2020 2720 2020 2020 733d 2428 736b 7920    '     s=$(sky 
-00021440: 7365 7276 6520 7374 6174 7573 207b 6e61  serve status {na
-00021450: 6d65 7d29 3b20 6563 686f 2022 2473 223b  me}); echo "$s";
-00021460: 270a 2020 2020 2720 2020 2020 6563 686f  '.    '     echo
-00021470: 2022 2473 2220 7c20 6772 6570 202d 7120   "$s" | grep -q 
-00021480: 227b 7265 706c 6963 615f 6e75 6d7d 2f7b  "{replica_num}/{
-00021490: 7265 706c 6963 615f 6e75 6d7d 2220 2626  replica_num}" &&
-000214a0: 2062 7265 616b 3b27 0a20 2020 2027 2020   break;'.    '  
-000214b0: 2020 2065 6368 6f20 2224 7322 207c 2067     echo "$s" | g
-000214c0: 7265 7020 2d71 2022 4641 494c 4544 2220  rep -q "FAILED" 
-000214d0: 2626 2065 7869 7420 313b 270a 2020 2020  && exit 1;'.    
-000214e0: 2720 2020 2020 736c 6565 7020 3130 3b27  '     sleep 10;'
-000214f0: 0a20 2020 2027 2064 6f6e 653b 207d 7d3b  .    ' done; }};
-00021500: 2065 6368 6f20 2247 6f74 2073 6572 7669   echo "Got servi
-00021510: 6365 2073 7461 7475 7320 2473 223b 270a  ce status $s";'.
-00021520: 2020 2020 6627 736c 6565 7020 7b73 6572      f'sleep {ser
-00021530: 7665 2e4c 425f 434f 4e54 524f 4c4c 4552  ve.LB_CONTROLLER
-00021540: 5f53 594e 435f 494e 5445 5256 414c 5f53  _SYNC_INTERVAL_S
-00021550: 4543 4f4e 4453 202b 2032 7d3b 2729 0a5f  ECONDS + 2};')._
-00021560: 4950 5f52 4547 4558 203d 2072 2728 5b30  IP_REGEX = r'([0
-00021570: 2d39 5d7b 312c 337d 5c2e 297b 337d 5b30  -9]{1,3}\.){3}[0
-00021580: 2d39 5d7b 312c 337d 270a 5f41 574b 5f41  -9]{1,3}'._AWK_A
-00021590: 4c4c 5f4c 494e 4553 5f42 454c 4f57 5f52  LL_LINES_BELOW_R
-000215a0: 4550 4c49 4341 5320 3d20 7227 2f52 6570  EPLICAS = r'/Rep
-000215b0: 6c69 6361 732f 7b66 6c61 673d 313b 206e  licas/{flag=1; n
-000215c0: 6578 747d 2066 6c61 6727 0a5f 5345 5256  ext} flag'._SERV
-000215d0: 4943 455f 4c41 554e 4348 494e 475f 5354  ICE_LAUNCHING_ST
-000215e0: 4154 5553 5f52 4547 4558 203d 2027 5052  ATUS_REGEX = 'PR
-000215f0: 4f56 4953 494f 4e49 4e47 5c7c 5354 4152  OVISIONING\|STAR
-00021600: 5449 4e47 270a 2320 5369 6e63 6520 7765  TING'.# Since we
-00021610: 2064 6f6e 2774 2061 6c6c 6f77 2074 6572   don't allow ter
-00021620: 6d69 6e61 7465 2074 6865 2073 6572 7669  minate the servi
-00021630: 6365 2069 6620 7468 6520 636f 6e74 726f  ce if the contro
-00021640: 6c6c 6572 2069 7320 494e 4954 2c0a 2320  ller is INIT,.# 
-00021650: 7768 6963 6820 6973 2063 6f6d 6d6f 6e20  which is common 
-00021660: 666f 7220 7369 6d75 6c74 616e 656f 7573  for simultaneous
-00021670: 2070 7974 6573 742c 2077 6520 6e65 6564   pytest, we need
-00021680: 2074 6f20 7761 6974 2075 6e74 696c 2074   to wait until t
-00021690: 6865 0a23 2063 6f6e 7472 6f6c 6c65 7220  he.# controller 
-000216a0: 6973 2055 5020 6265 666f 7265 2077 6520  is UP before we 
-000216b0: 6361 6e20 7465 726d 696e 6174 6520 7468  can terminate th
-000216c0: 6520 7365 7276 6963 652e 0a23 2054 6865  e service..# The
-000216d0: 2074 6561 7264 6f77 6e20 636f 6d6d 616e   teardown comman
-000216e0: 6420 6861 7320 6120 3130 2d6d 696e 7320  d has a 10-mins 
-000216f0: 7469 6d65 6f75 742c 2073 6f20 7765 2064  timeout, so we d
-00021700: 6f6e 2774 206e 6565 6420 746f 2064 6f0a  on't need to do.
-00021710: 2320 7468 6520 7469 6d65 6f75 7420 6865  # the timeout he
-00021720: 7265 2e20 5365 6520 696d 706c 656d 656e  re. See implemen
-00021730: 7461 7469 6f6e 206f 6620 7275 6e5f 6f6e  tation of run_on
-00021740: 655f 7465 7374 2829 2066 6f72 2064 6574  e_test() for det
-00021750: 6169 6c73 2e0a 5f54 4541 5244 4f57 4e5f  ails.._TEARDOWN_
-00021760: 5345 5256 4943 4520 3d20 280a 2020 2020  SERVICE = (.    
-00021770: 2728 666f 7220 6920 696e 2060 7365 7120  '(for i in `seq 
-00021780: 3120 3230 603b 2064 6f27 0a20 2020 2027  1 20`; do'.    '
-00021790: 2020 2020 2073 3d24 2873 6b79 2073 6572       s=$(sky ser
-000217a0: 7665 2064 6f77 6e20 2d79 207b 6e61 6d65  ve down -y {name
-000217b0: 7d29 3b27 0a20 2020 2027 2020 2020 2065  });'.    '     e
-000217c0: 6368 6f20 2254 7279 696e 6720 746f 2074  cho "Trying to t
-000217d0: 6572 6d69 6e61 7465 207b 6e61 6d65 7d22  erminate {name}"
-000217e0: 3b27 0a20 2020 2027 2020 2020 2065 6368  ;'.    '     ech
-000217f0: 6f20 2224 7322 3b27 0a20 2020 2027 2020  o "$s";'.    '  
-00021800: 2020 2065 6368 6f20 2224 7322 207c 2067     echo "$s" | g
-00021810: 7265 7020 2d71 2022 7363 6865 6475 6c65  rep -q "schedule
-00021820: 6420 746f 2062 6520 7465 726d 696e 6174  d to be terminat
-00021830: 6564 5c7c 4e6f 2073 6572 7669 6365 2074  ed\|No service t
-00021840: 6f20 7465 726d 696e 6174 6522 2026 2620  o terminate" && 
-00021850: 6272 6561 6b3b 270a 2020 2020 2720 2020  break;'.    '   
-00021860: 2020 736c 6565 7020 3130 3b27 0a20 2020    sleep 10;'.   
-00021870: 2027 2020 2020 205b 2024 6920 2d65 7120   '     [ $i -eq 
-00021880: 3230 205d 2026 2620 6563 686f 2022 4661  20 ] && echo "Fa
-00021890: 696c 6564 2074 6f20 7465 726d 696e 6174  iled to terminat
-000218a0: 6520 7365 7276 6963 6520 7b6e 616d 657d  e service {name}
-000218b0: 223b 270a 2020 2020 2764 6f6e 6529 2729  ";'.    'done)')
-000218c0: 0a0a 5f53 4552 5645 5f45 4e44 504f 494e  .._SERVE_ENDPOIN
-000218d0: 545f 5741 4954 203d 2028 0a20 2020 2027  T_WAIT = (.    '
-000218e0: 6578 706f 7274 204f 5249 4749 4e5f 534b  export ORIGIN_SK
-000218f0: 5950 494c 4f54 5f44 4542 5547 3d24 534b  YPILOT_DEBUG=$SK
-00021900: 5950 494c 4f54 5f44 4542 5547 3b20 6578  YPILOT_DEBUG; ex
-00021910: 706f 7274 2053 4b59 5049 4c4f 545f 4445  port SKYPILOT_DE
-00021920: 4255 473d 303b 2027 0a20 2020 2027 656e  BUG=0; '.    'en
-00021930: 6470 6f69 6e74 3d24 2873 6b79 2073 6572  dpoint=$(sky ser
-00021940: 7665 2073 7461 7475 7320 2d2d 656e 6470  ve status --endp
-00021950: 6f69 6e74 207b 6e61 6d65 7d29 3b20 270a  oint {name}); '.
-00021960: 2020 2020 2775 6e74 696c 2021 2065 6368      'until ! ech
-00021970: 6f20 2224 656e 6470 6f69 6e74 2220 7c20  o "$endpoint" | 
-00021980: 6772 6570 2022 436f 6e74 726f 6c6c 6572  grep "Controller
-00021990: 2069 7320 696e 6974 6961 6c69 7a69 6e67   is initializing
-000219a0: 223b 2027 0a20 2020 2027 646f 2065 6368  "; '.    'do ech
-000219b0: 6f20 2257 6169 7469 6e67 2066 6f72 2073  o "Waiting for s
-000219c0: 6572 7665 2065 6e64 706f 696e 7420 746f  erve endpoint to
-000219d0: 2062 6520 7265 6164 792e 2e2e 223b 2027   be ready..."; '
-000219e0: 0a20 2020 2027 736c 6565 7020 353b 2065  .    'sleep 5; e
-000219f0: 6e64 706f 696e 743d 2428 736b 7920 7365  ndpoint=$(sky se
-00021a00: 7276 6520 7374 6174 7573 202d 2d65 6e64  rve status --end
-00021a10: 706f 696e 7420 7b6e 616d 657d 293b 2064  point {name}); d
-00021a20: 6f6e 653b 2027 0a20 2020 2027 6578 706f  one; '.    'expo
-00021a30: 7274 2053 4b59 5049 4c4f 545f 4445 4255  rt SKYPILOT_DEBU
-00021a40: 473d 244f 5249 4749 4e5f 534b 5950 494c  G=$ORIGIN_SKYPIL
-00021a50: 4f54 5f44 4542 5547 3b20 6563 686f 2022  OT_DEBUG; echo "
-00021a60: 2465 6e64 706f 696e 7422 2729 0a0a 5f53  $endpoint"').._S
-00021a70: 4552 5645 5f53 5441 5455 535f 5741 4954  ERVE_STATUS_WAIT
-00021a80: 203d 2028 2773 3d24 2873 6b79 2073 6572   = ('s=$(sky ser
-00021a90: 7665 2073 7461 7475 7320 7b6e 616d 657d  ve status {name}
-00021aa0: 293b 2027 0a20 2020 2020 2020 2020 2020  ); '.           
-00021ab0: 2020 2020 2020 2020 2020 2027 756e 7469             'unti
-00021ac0: 6c20 2120 6563 686f 2022 2473 2220 7c20  l ! echo "$s" | 
-00021ad0: 6772 6570 2022 436f 6e74 726f 6c6c 6572  grep "Controller
-00021ae0: 2069 7320 696e 6974 6961 6c69 7a69 6e67   is initializing
-00021af0: 2e22 3b20 270a 2020 2020 2020 2020 2020  ."; '.          
-00021b00: 2020 2020 2020 2020 2020 2020 2764 6f20              'do 
-00021b10: 6563 686f 2022 5761 6974 696e 6720 666f  echo "Waiting fo
-00021b20: 7220 7365 7276 6520 7374 6174 7573 2074  r serve status t
-00021b30: 6f20 6265 2072 6561 6479 2e2e 2e22 3b20  o be ready..."; 
-00021b40: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00021b50: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
-00021b60: 3b20 733d 2428 736b 7920 7365 7276 6520  ; s=$(sky serve 
-00021b70: 7374 6174 7573 207b 6e61 6d65 7d29 3b20  status {name}); 
-00021b80: 646f 6e65 3b20 6563 686f 2022 2473 2227  done; echo "$s"'
-00021b90: 290a 0a0a 6465 6620 5f67 6574 5f72 6570  )...def _get_rep
-00021ba0: 6c69 6361 5f69 7028 6e61 6d65 3a20 7374  lica_ip(name: st
-00021bb0: 722c 2072 6570 6c69 6361 5f69 643a 2069  r, replica_id: i
-00021bc0: 6e74 2920 2d3e 2073 7472 3a0a 2020 2020  nt) -> str:.    
-00021bd0: 7265 7475 726e 2028 6627 6970 7b72 6570  return (f'ip{rep
-00021be0: 6c69 6361 5f69 647d 3d24 2865 6368 6f20  lica_id}=$(echo 
-00021bf0: 2224 7322 207c 2027 0a20 2020 2020 2020  "$s" | '.       
-00021c00: 2020 2020 2066 2761 776b 2022 7b5f 4157       f'awk "{_AW
-00021c10: 4b5f 414c 4c5f 4c49 4e45 535f 4245 4c4f  K_ALL_LINES_BELO
-00021c20: 575f 5245 504c 4943 4153 7d22 207c 2027  W_REPLICAS}" | '
-00021c30: 0a20 2020 2020 2020 2020 2020 2066 2767  .            f'g
-00021c40: 7265 7020 2d45 2022 7b6e 616d 657d 5c73  rep -E "{name}\s
-00021c50: 2b7b 7265 706c 6963 615f 6964 7d22 207c  +{replica_id}" |
-00021c60: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
-00021c70: 2767 7265 7020 2d45 6f20 227b 5f49 505f  'grep -Eo "{_IP_
-00021c80: 5245 4745 587d 2229 2729 0a0a 0a64 6566  REGEX}")')...def
-00021c90: 205f 6765 745f 736b 7973 6572 7665 5f68   _get_skyserve_h
-00021ca0: 7474 705f 7465 7374 286e 616d 653a 2073  ttp_test(name: s
-00021cb0: 7472 2c20 636c 6f75 643a 2073 7472 2c0a  tr, cloud: str,.
-00021cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021cd0: 2020 2020 2020 2020 2020 2020 7469 6d65              time
-00021ce0: 6f75 745f 6d69 6e75 7465 733a 2069 6e74  out_minutes: int
-00021cf0: 2920 2d3e 2054 6573 743a 0a20 2020 2074  ) -> Test:.    t
-00021d00: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-00021d10: 2020 2020 6627 7465 7374 2d73 6b79 7365      f'test-skyse
-00021d20: 7276 652d 7b63 6c6f 7564 2e72 6570 6c61  rve-{cloud.repla
-00021d30: 6365 2822 5f22 2c20 222d 2229 7d27 2c0a  ce("_", "-")}',.
-00021d40: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00021d50: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
-00021d60: 6520 7570 202d 6e20 7b6e 616d 657d 202d  e up -n {name} -
-00021d70: 7920 7465 7374 732f 736b 7973 6572 7665  y tests/skyserve
-00021d80: 2f68 7474 702f 7b63 6c6f 7564 7d2e 7961  /http/{cloud}.ya
-00021d90: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00021da0: 205f 5345 5256 455f 5741 4954 5f55 4e54   _SERVE_WAIT_UNT
-00021db0: 494c 5f52 4541 4459 2e66 6f72 6d61 7428  IL_READY.format(
-00021dc0: 6e61 6d65 3d6e 616d 652c 2072 6570 6c69  name=name, repli
-00021dd0: 6361 5f6e 756d 3d32 292c 0a20 2020 2020  ca_num=2),.     
-00021de0: 2020 2020 2020 2066 277b 5f53 4552 5645         f'{_SERVE
-00021df0: 5f45 4e44 504f 494e 545f 5741 4954 2e66  _ENDPOINT_WAIT.f
-00021e00: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
-00021e10: 7d3b 2027 0a20 2020 2020 2020 2020 2020  }; '.           
-00021e20: 2027 6375 726c 2068 7474 703a 2f2f 2465   'curl http://$e
-00021e30: 6e64 706f 696e 7420 7c20 6772 6570 2022  ndpoint | grep "
-00021e40: 4869 2c20 536b 7950 696c 6f74 2068 6572  Hi, SkyPilot her
-00021e50: 6522 272c 0a20 2020 2020 2020 205d 2c0a  e"',.        ],.
-00021e60: 2020 2020 2020 2020 5f54 4541 5244 4f57          _TEARDOW
-00021e70: 4e5f 5345 5256 4943 452e 666f 726d 6174  N_SERVICE.format
-00021e80: 286e 616d 653d 6e61 6d65 292c 0a20 2020  (name=name),.   
-00021e90: 2020 2020 2074 696d 656f 7574 3d74 696d       timeout=tim
-00021ea0: 656f 7574 5f6d 696e 7574 6573 202a 2036  eout_minutes * 6
-00021eb0: 302c 0a20 2020 2029 0a20 2020 2072 6574  0,.    ).    ret
-00021ec0: 7572 6e20 7465 7374 0a0a 0a64 6566 205f  urn test...def _
-00021ed0: 6368 6563 6b5f 7265 706c 6963 615f 696e  check_replica_in
-00021ee0: 5f73 7461 7475 7328 6e61 6d65 3a20 7374  _status(name: st
-00021ef0: 722c 2063 6865 636b 5f74 7570 6c65 733a  r, check_tuples:
-00021f00: 204c 6973 745b 5475 706c 655b 696e 742c   List[Tuple[int,
-00021f10: 2062 6f6f 6c2c 0a20 2020 2020 2020 2020   bool,.         
-00021f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021f50: 2020 2020 2020 2020 7374 725d 5d29 202d          str]]) -
-00021f60: 3e20 7374 723a 0a20 2020 2022 2222 4368  > str:.    """Ch
-00021f70: 6563 6b20 7265 706c 6963 6173 2720 7374  eck replicas' st
-00021f80: 6174 7573 2061 6e64 2063 6f75 6e74 2069  atus and count i
-00021f90: 6e20 736b 7920 7365 7276 6520 7374 6174  n sky serve stat
-00021fa0: 7573 0a0a 2020 2020 5765 2077 696c 6c20  us..    We will 
-00021fb0: 6368 6563 6b20 7643 5055 3d32 2c20 6173  check vCPU=2, as
-00021fc0: 2061 6c6c 206f 7572 2074 6573 7473 2075   all our tests u
-00021fd0: 7365 2076 4350 553d 322e 0a20 2020 200a  se vCPU=2..    .
-00021fe0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-00021ff0: 2020 6e61 6d65 3a20 7468 6520 6e61 6d65    name: the name
-00022000: 206f 6620 7468 6520 7365 7276 6963 650a   of the service.
-00022010: 2020 2020 2020 2020 6368 6563 6b5f 7475          check_tu
-00022020: 706c 6573 3a20 4120 6c69 7374 206f 6620  ples: A list of 
-00022030: 7265 706c 6963 6120 7072 6f70 6572 7479  replica property
-00022040: 2074 6f20 6368 6563 6b2e 2045 6163 6820   to check. Each 
-00022050: 7475 706c 6520 6973 0a20 2020 2020 2020  tuple is.       
-00022060: 2020 2020 2028 636f 756e 742c 2069 735f       (count, is_
-00022070: 7370 6f74 2c20 7374 6174 7573 290a 2020  spot, status).  
-00022080: 2020 2222 220a 2020 2020 6368 6563 6b5f    """.    check_
-00022090: 636d 6420 3d20 2727 0a20 2020 2066 6f72  cmd = ''.    for
-000220a0: 2063 6865 636b 5f74 7570 6c65 2069 6e20   check_tuple in 
-000220b0: 6368 6563 6b5f 7475 706c 6573 3a0a 2020  check_tuples:.  
-000220c0: 2020 2020 2020 636f 756e 742c 2069 735f        count, is_
-000220d0: 7370 6f74 2c20 7374 6174 7573 203d 2063  spot, status = c
-000220e0: 6865 636b 5f74 7570 6c65 0a20 2020 2020  heck_tuple.     
-000220f0: 2020 2072 6573 6f75 7263 655f 7374 7220     resource_str 
-00022100: 3d20 2727 0a20 2020 2020 2020 2069 6620  = ''.        if 
-00022110: 7374 6174 7573 206e 6f74 2069 6e20 5b27  status not in ['
-00022120: 5045 4e44 494e 4727 2c20 2753 4855 5454  PENDING', 'SHUTT
-00022130: 494e 475f 444f 574e 270a 2020 2020 2020  ING_DOWN'.      
-00022140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022150: 2020 205d 2061 6e64 206e 6f74 2073 7461     ] and not sta
-00022160: 7475 732e 7374 6172 7473 7769 7468 2827  tus.startswith('
-00022170: 4641 494c 4544 2729 3a0a 2020 2020 2020  FAILED'):.      
-00022180: 2020 2020 2020 7370 6f74 5f73 7472 203d        spot_str =
-00022190: 2027 270a 2020 2020 2020 2020 2020 2020   ''.            
-000221a0: 6966 2069 735f 7370 6f74 3a0a 2020 2020  if is_spot:.    
-000221b0: 2020 2020 2020 2020 2020 2020 7370 6f74              spot
-000221c0: 5f73 7472 203d 2027 5c5b 5370 6f74 5c5d  _str = '\[Spot\]
-000221d0: 270a 2020 2020 2020 2020 2020 2020 7265  '.            re
-000221e0: 736f 7572 6365 5f73 7472 203d 2066 2728  source_str = f'(
-000221f0: 7b73 706f 745f 7374 727d 7643 5055 3d32  {spot_str}vCPU=2
-00022200: 2927 0a20 2020 2020 2020 2063 6865 636b  )'.        check
-00022210: 5f63 6d64 202b 3d20 2866 2720 6563 686f  _cmd += (f' echo
-00022220: 2022 2473 2220 7c20 6772 6570 2022 7b72   "$s" | grep "{r
-00022230: 6573 6f75 7263 655f 7374 727d 2220 7c20  esource_str}" | 
-00022240: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00022250: 2020 2020 2020 2020 6627 6772 6570 2022          f'grep "
-00022260: 7b73 7461 7475 737d 2220 7c20 7763 202d  {status}" | wc -
-00022270: 6c20 7c20 6772 6570 207b 636f 756e 747d  l | grep {count}
-00022280: 207c 7c20 6578 6974 2031 3b27 290a 2020   || exit 1;').  
-00022290: 2020 7265 7475 726e 2028 6627 7b5f 5345    return (f'{_SE
-000222a0: 5256 455f 5354 4154 5553 5f57 4149 542e  RVE_STATUS_WAIT.
-000222b0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-000222c0: 297d 3b20 6563 686f 2022 2473 223b 2027  )}; echo "$s"; '
-000222d0: 202b 2063 6865 636b 5f63 6d64 290a 0a0a   + check_cmd)...
-000222e0: 6465 6620 5f63 6865 636b 5f73 6572 7669  def _check_servi
-000222f0: 6365 5f76 6572 7369 6f6e 2873 6572 7669  ce_version(servi
-00022300: 6365 5f6e 616d 653a 2073 7472 2c20 7665  ce_name: str, ve
-00022310: 7273 696f 6e3a 2073 7472 2920 2d3e 2073  rsion: str) -> s
-00022320: 7472 3a0a 2020 2020 2320 4772 6570 2074  tr:.    # Grep t
-00022330: 6865 206c 696e 6573 2062 6566 6f72 6520  he lines before 
-00022340: 2753 6572 7669 6365 2052 6570 6c69 6361  'Service Replica
-00022350: 7327 2061 6e64 2063 6865 636b 2069 6620  s' and check if 
-00022360: 7468 6520 7365 7276 6963 6520 7665 7273  the service vers
-00022370: 696f 6e0a 2020 2020 2320 6973 2063 6f72  ion.    # is cor
-00022380: 7265 6374 2e0a 2020 2020 7265 7475 726e  rect..    return
-00022390: 2028 6627 6563 686f 2022 2473 2220 7c20   (f'echo "$s" | 
-000223a0: 6772 6570 202d 4231 3030 3020 2253 6572  grep -B1000 "Ser
-000223b0: 7669 6365 2052 6570 6c69 6361 7322 207c  vice Replicas" |
-000223c0: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
-000223d0: 2767 7265 7020 2d45 2022 7b73 6572 7669  'grep -E "{servi
-000223e0: 6365 5f6e 616d 657d 5c73 2b7b 7665 7273  ce_name}\s+{vers
-000223f0: 696f 6e7d 2220 7c7c 2065 7869 7420 313b  ion}" || exit 1;
-00022400: 2027 290a 0a0a 4070 7974 6573 742e 6d61   ')...@pytest.ma
-00022410: 726b 2e67 6370 0a40 7079 7465 7374 2e6d  rk.gcp.@pytest.m
-00022420: 6172 6b2e 7365 7276 650a 6465 6620 7465  ark.serve.def te
-00022430: 7374 5f73 6b79 7365 7276 655f 6763 705f  st_skyserve_gcp_
-00022440: 6874 7470 2829 3a0a 2020 2020 2222 2254  http():.    """T
-00022450: 6573 7420 736b 7973 6572 7665 206f 6e20  est skyserve on 
-00022460: 4743 5022 2222 0a20 2020 206e 616d 6520  GCP""".    name 
-00022470: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
-00022480: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-00022490: 205f 6765 745f 736b 7973 6572 7665 5f68   _get_skyserve_h
-000224a0: 7474 705f 7465 7374 286e 616d 652c 2027  ttp_test(name, '
-000224b0: 6763 7027 2c20 3230 290a 2020 2020 7275  gcp', 20).    ru
-000224c0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-000224d0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-000224e0: 6177 730a 4070 7974 6573 742e 6d61 726b  aws.@pytest.mark
-000224f0: 2e73 6572 7665 0a64 6566 2074 6573 745f  .serve.def test_
-00022500: 736b 7973 6572 7665 5f61 7773 5f68 7474  skyserve_aws_htt
-00022510: 7028 293a 0a20 2020 2022 2222 5465 7374  p():.    """Test
-00022520: 2073 6b79 7365 7276 6520 6f6e 2041 5753   skyserve on AWS
-00022530: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
-00022540: 6765 745f 7365 7276 6963 655f 6e61 6d65  get_service_name
-00022550: 2829 0a20 2020 2074 6573 7420 3d20 5f67  ().    test = _g
-00022560: 6574 5f73 6b79 7365 7276 655f 6874 7470  et_skyserve_http
-00022570: 5f74 6573 7428 6e61 6d65 2c20 2761 7773  _test(name, 'aws
-00022580: 272c 2032 3029 0a20 2020 2072 756e 5f6f  ', 20).    run_o
-00022590: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-000225a0: 4070 7974 6573 742e 6d61 726b 2e61 7a75  @pytest.mark.azu
-000225b0: 7265 0a40 7079 7465 7374 2e6d 6172 6b2e  re.@pytest.mark.
-000225c0: 7365 7276 650a 6465 6620 7465 7374 5f73  serve.def test_s
-000225d0: 6b79 7365 7276 655f 617a 7572 655f 6874  kyserve_azure_ht
-000225e0: 7470 2829 3a0a 2020 2020 2222 2254 6573  tp():.    """Tes
-000225f0: 7420 736b 7973 6572 7665 206f 6e20 417a  t skyserve on Az
-00022600: 7572 6522 2222 0a20 2020 206e 616d 6520  ure""".    name 
-00022610: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
-00022620: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-00022630: 205f 6765 745f 736b 7973 6572 7665 5f68   _get_skyserve_h
-00022640: 7474 705f 7465 7374 286e 616d 652c 2027  ttp_test(name, '
-00022650: 617a 7572 6527 2c20 3330 290a 2020 2020  azure', 30).    
-00022660: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00022670: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00022680: 6b2e 6b75 6265 726e 6574 6573 0a40 7079  k.kubernetes.@py
-00022690: 7465 7374 2e6d 6172 6b2e 7365 7276 650a  test.mark.serve.
-000226a0: 6465 6620 7465 7374 5f73 6b79 7365 7276  def test_skyserv
-000226b0: 655f 6b75 6265 726e 6574 6573 5f68 7474  e_kubernetes_htt
-000226c0: 7028 293a 0a20 2020 2022 2222 5465 7374  p():.    """Test
-000226d0: 2073 6b79 7365 7276 6520 6f6e 204b 7562   skyserve on Kub
-000226e0: 6572 6e65 7465 7322 2222 0a20 2020 206e  ernetes""".    n
-000226f0: 616d 6520 3d20 5f67 6574 5f73 6572 7669  ame = _get_servi
-00022700: 6365 5f6e 616d 6528 290a 2020 2020 7465  ce_name().    te
-00022710: 7374 203d 205f 6765 745f 736b 7973 6572  st = _get_skyser
-00022720: 7665 5f68 7474 705f 7465 7374 286e 616d  ve_http_test(nam
-00022730: 652c 2027 6b75 6265 726e 6574 6573 272c  e, 'kubernetes',
-00022740: 2033 3029 0a20 2020 2072 756e 5f6f 6e65   30).    run_one
-00022750: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-00022760: 7974 6573 742e 6d61 726b 2e73 6572 7665  ytest.mark.serve
-00022770: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
-00022780: 7665 5f6c 6c6d 2867 656e 6572 6963 5f63  ve_llm(generic_c
-00022790: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-000227a0: 2222 2254 6573 7420 736b 7973 6572 7665  """Test skyserve
-000227b0: 2077 6974 6820 7265 616c 204c 4c4d 2075   with real LLM u
-000227c0: 7365 6361 7365 2222 220a 2020 2020 6e61  secase""".    na
-000227d0: 6d65 203d 205f 6765 745f 7365 7276 6963  me = _get_servic
-000227e0: 655f 6e61 6d65 2829 0a0a 2020 2020 6465  e_name()..    de
-000227f0: 6620 6765 6e65 7261 7465 5f6c 6c6d 5f74  f generate_llm_t
-00022800: 6573 745f 636f 6d6d 616e 6428 7072 6f6d  est_command(prom
-00022810: 7074 3a20 7374 722c 2065 7870 6563 7465  pt: str, expecte
-00022820: 645f 6f75 7470 7574 3a20 7374 7229 202d  d_output: str) -
-00022830: 3e20 7374 723a 0a20 2020 2020 2020 2070  > str:.        p
-00022840: 726f 6d70 7420 3d20 7368 6c65 782e 7175  rompt = shlex.qu
-00022850: 6f74 6528 7072 6f6d 7074 290a 2020 2020  ote(prompt).    
-00022860: 2020 2020 6578 7065 6374 6564 5f6f 7574      expected_out
-00022870: 7075 7420 3d20 7368 6c65 782e 7175 6f74  put = shlex.quot
-00022880: 6528 6578 7065 6374 6564 5f6f 7574 7075  e(expected_outpu
-00022890: 7429 0a20 2020 2020 2020 2072 6574 7572  t).        retur
-000228a0: 6e20 280a 2020 2020 2020 2020 2020 2020  n (.            
-000228b0: 6627 7b5f 5345 5256 455f 454e 4450 4f49  f'{_SERVE_ENDPOI
-000228c0: 4e54 5f57 4149 542e 666f 726d 6174 286e  NT_WAIT.format(n
-000228d0: 616d 653d 6e61 6d65 297d 3b20 270a 2020  ame=name)}; '.  
-000228e0: 2020 2020 2020 2020 2020 2770 7974 686f            'pytho
-000228f0: 6e20 7465 7374 732f 736b 7973 6572 7665  n tests/skyserve
-00022900: 2f6c 6c6d 2f67 6574 5f72 6573 706f 6e73  /llm/get_respons
-00022910: 652e 7079 202d 2d65 6e64 706f 696e 7420  e.py --endpoint 
-00022920: 2465 6e64 706f 696e 7420 270a 2020 2020  $endpoint '.    
-00022930: 2020 2020 2020 2020 6627 2d2d 7072 6f6d          f'--prom
-00022940: 7074 207b 7072 6f6d 7074 7d20 7c20 6772  pt {prompt} | gr
-00022950: 6570 207b 6578 7065 6374 6564 5f6f 7574  ep {expected_out
-00022960: 7075 747d 2729 0a0a 2020 2020 7769 7468  put}')..    with
-00022970: 206f 7065 6e28 2774 6573 7473 2f73 6b79   open('tests/sky
-00022980: 7365 7276 652f 6c6c 6d2f 7072 6f6d 7074  serve/llm/prompt
-00022990: 5f6f 7574 7075 742e 6a73 6f6e 272c 2027  _output.json', '
-000229a0: 7227 2c0a 2020 2020 2020 2020 2020 2020  r',.            
-000229b0: 2020 656e 636f 6469 6e67 3d27 7574 662d    encoding='utf-
-000229c0: 3827 2920 6173 2066 3a0a 2020 2020 2020  8') as f:.      
-000229d0: 2020 7072 6f6d 7074 326f 7574 7075 7420    prompt2output 
-000229e0: 3d20 6a73 6f6e 2e6c 6f61 6428 6629 0a0a  = json.load(f)..
-000229f0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00022a00: 0a20 2020 2020 2020 2066 2774 6573 742d  .        f'test-
-00022a10: 736b 7973 6572 7665 2d6c 6c6d 272c 0a20  skyserve-llm',. 
-00022a20: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00022a30: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
-00022a40: 2075 7020 2d6e 207b 6e61 6d65 7d20 2d2d   up -n {name} --
-00022a50: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-00022a60: 6c6f 7564 7d20 2d79 2074 6573 7473 2f73  loud} -y tests/s
-00022a70: 6b79 7365 7276 652f 6c6c 6d2f 7365 7276  kyserve/llm/serv
-00022a80: 6963 652e 7961 6d6c 272c 0a20 2020 2020  ice.yaml',.     
-00022a90: 2020 2020 2020 205f 5345 5256 455f 5741         _SERVE_WA
-00022aa0: 4954 5f55 4e54 494c 5f52 4541 4459 2e66  IT_UNTIL_READY.f
-00022ab0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 652c  ormat(name=name,
-00022ac0: 2072 6570 6c69 6361 5f6e 756d 3d31 292c   replica_num=1),
-00022ad0: 0a20 2020 2020 2020 2020 2020 202a 5b0a  .            *[.
-00022ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022af0: 6765 6e65 7261 7465 5f6c 6c6d 5f74 6573  generate_llm_tes
-00022b00: 745f 636f 6d6d 616e 6428 7072 6f6d 7074  t_command(prompt
-00022b10: 2c20 6f75 7470 7574 290a 2020 2020 2020  , output).      
-00022b20: 2020 2020 2020 2020 2020 666f 7220 7072            for pr
-00022b30: 6f6d 7074 2c20 6f75 7470 7574 2069 6e20  ompt, output in 
-00022b40: 7072 6f6d 7074 326f 7574 7075 742e 6974  prompt2output.it
-00022b50: 656d 7328 290a 2020 2020 2020 2020 2020  ems().          
-00022b60: 2020 5d2c 0a20 2020 2020 2020 205d 2c0a    ],.        ],.
-00022b70: 2020 2020 2020 2020 5f54 4541 5244 4f57          _TEARDOW
-00022b80: 4e5f 5345 5256 4943 452e 666f 726d 6174  N_SERVICE.format
-00022b90: 286e 616d 653d 6e61 6d65 292c 0a20 2020  (name=name),.   
-00022ba0: 2020 2020 2074 696d 656f 7574 3d34 3020       timeout=40 
-00022bb0: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
-00022bc0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00022bd0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00022be0: 6b2e 6763 700a 4070 7974 6573 742e 6d61  k.gcp.@pytest.ma
-00022bf0: 726b 2e73 6572 7665 0a64 6566 2074 6573  rk.serve.def tes
-00022c00: 745f 736b 7973 6572 7665 5f73 706f 745f  t_skyserve_spot_
-00022c10: 7265 636f 7665 7279 2829 3a0a 2020 2020  recovery():.    
-00022c20: 6e61 6d65 203d 205f 6765 745f 7365 7276  name = _get_serv
-00022c30: 6963 655f 6e61 6d65 2829 0a20 2020 207a  ice_name().    z
-00022c40: 6f6e 6520 3d20 2775 732d 6365 6e74 7261  one = 'us-centra
-00022c50: 6c31 2d61 270a 0a20 2020 2074 6573 7420  l1-a'..    test 
-00022c60: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00022c70: 6627 7465 7374 2d73 6b79 7365 7276 652d  f'test-skyserve-
-00022c80: 7370 6f74 2d72 6563 6f76 6572 792d 6763  spot-recovery-gc
-00022c90: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
-00022ca0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00022cb0: 7365 7276 6520 7570 202d 6e20 7b6e 616d  serve up -n {nam
-00022cc0: 657d 202d 7920 7465 7374 732f 736b 7973  e} -y tests/skys
-00022cd0: 6572 7665 2f73 706f 742f 7265 636f 7665  erve/spot/recove
-00022ce0: 7279 2e79 616d 6c27 2c0a 2020 2020 2020  ry.yaml',.      
-00022cf0: 2020 2020 2020 5f53 4552 5645 5f57 4149        _SERVE_WAI
-00022d00: 545f 554e 5449 4c5f 5245 4144 592e 666f  T_UNTIL_READY.fo
-00022d10: 726d 6174 286e 616d 653d 6e61 6d65 2c20  rmat(name=name, 
-00022d20: 7265 706c 6963 615f 6e75 6d3d 3129 2c0a  replica_num=1),.
-00022d30: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00022d40: 5345 5256 455f 454e 4450 4f49 4e54 5f57  SERVE_ENDPOINT_W
-00022d50: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
-00022d60: 6e61 6d65 297d 3b20 270a 2020 2020 2020  name)}; '.      
-00022d70: 2020 2020 2020 2772 6571 7565 7374 5f6f        'request_o
-00022d80: 7574 7075 743d 2428 6375 726c 2068 7474  utput=$(curl htt
-00022d90: 703a 2f2f 2465 6e64 706f 696e 7429 3b20  p://$endpoint); 
-00022da0: 6563 686f 2022 2472 6571 7565 7374 5f6f  echo "$request_o
-00022db0: 7574 7075 7422 3b20 6563 686f 2022 2472  utput"; echo "$r
-00022dc0: 6571 7565 7374 5f6f 7574 7075 7422 207c  equest_output" |
-00022dd0: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
-00022de0: 6c6f 7420 6865 7265 2227 2c0a 2020 2020  lot here"',.    
-00022df0: 2020 2020 2020 2020 5f74 6572 6d69 6e61          _termina
-00022e00: 7465 5f67 6370 5f72 6570 6c69 6361 286e  te_gcp_replica(n
-00022e10: 616d 652c 207a 6f6e 652c 2031 292c 0a20  ame, zone, 1),. 
-00022e20: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
-00022e30: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
-00022e40: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
-00022e50: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
-00022e60: 3d31 292c 0a20 2020 2020 2020 2020 2020  =1),.           
-00022e70: 2066 277b 5f53 4552 5645 5f45 4e44 504f   f'{_SERVE_ENDPO
-00022e80: 494e 545f 5741 4954 2e66 6f72 6d61 7428  INT_WAIT.format(
-00022e90: 6e61 6d65 3d6e 616d 6529 7d3b 2027 0a20  name=name)}; '. 
-00022ea0: 2020 2020 2020 2020 2020 2027 7265 7175             'requ
-00022eb0: 6573 745f 6f75 7470 7574 3d24 2863 7572  est_output=$(cur
-00022ec0: 6c20 6874 7470 3a2f 2f24 656e 6470 6f69  l http://$endpoi
-00022ed0: 6e74 293b 2065 6368 6f20 2224 7265 7175  nt); echo "$requ
-00022ee0: 6573 745f 6f75 7470 7574 223b 2065 6368  est_output"; ech
-00022ef0: 6f20 2224 7265 7175 6573 745f 6f75 7470  o "$request_outp
-00022f00: 7574 2220 7c20 6772 6570 2022 4869 2c20  ut" | grep "Hi, 
-00022f10: 536b 7950 696c 6f74 2068 6572 6522 272c  SkyPilot here"',
-00022f20: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00022f30: 2020 2020 5f54 4541 5244 4f57 4e5f 5345      _TEARDOWN_SE
-00022f40: 5256 4943 452e 666f 726d 6174 286e 616d  RVICE.format(nam
-00022f50: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
-00022f60: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
-00022f70: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00022f80: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00022f90: 0a40 7079 7465 7374 2e6d 6172 6b2e 7365  .@pytest.mark.se
-00022fa0: 7276 650a 4070 7974 6573 742e 6d61 726b  rve.@pytest.mark
-00022fb0: 2e6e 6f5f 6b75 6265 726e 6574 6573 0a64  .no_kubernetes.d
-00022fc0: 6566 2074 6573 745f 736b 7973 6572 7665  ef test_skyserve
-00022fd0: 5f62 6173 655f 6f6e 6465 6d61 6e64 5f66  _base_ondemand_f
-00022fe0: 616c 6c62 6163 6b28 6765 6e65 7269 635f  allback(generic_
-00022ff0: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
-00023000: 206e 616d 6520 3d20 5f67 6574 5f73 6572   name = _get_ser
-00023010: 7669 6365 5f6e 616d 6528 290a 2020 2020  vice_name().    
-00023020: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00023030: 2020 2020 2066 2774 6573 742d 736b 7973       f'test-skys
-00023040: 6572 7665 2d62 6173 652d 6f6e 6465 6d61  erve-base-ondema
-00023050: 6e64 2d66 616c 6c62 6163 6b27 2c0a 2020  nd-fallback',.  
-00023060: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00023070: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
-00023080: 7570 202d 6e20 7b6e 616d 657d 202d 2d63  up -n {name} --c
-00023090: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-000230a0: 6f75 647d 202d 7920 7465 7374 732f 736b  oud} -y tests/sk
-000230b0: 7973 6572 7665 2f73 706f 742f 6261 7365  yserve/spot/base
-000230c0: 5f6f 6e64 656d 616e 645f 6661 6c6c 6261  _ondemand_fallba
-000230d0: 636b 2e79 616d 6c27 2c0a 2020 2020 2020  ck.yaml',.      
-000230e0: 2020 2020 2020 5f53 4552 5645 5f57 4149        _SERVE_WAI
-000230f0: 545f 554e 5449 4c5f 5245 4144 592e 666f  T_UNTIL_READY.fo
-00023100: 726d 6174 286e 616d 653d 6e61 6d65 2c20  rmat(name=name, 
-00023110: 7265 706c 6963 615f 6e75 6d3d 3229 2c0a  replica_num=2),.
-00023120: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
-00023130: 636b 5f72 6570 6c69 6361 5f69 6e5f 7374  ck_replica_in_st
-00023140: 6174 7573 286e 616d 652c 205b 2831 2c20  atus(name, [(1, 
-00023150: 5472 7565 2c20 2752 4541 4459 2729 2c0a  True, 'READY'),.
-00023160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023180: 2020 2020 2020 2020 2020 2020 2831 2c20              (1, 
-00023190: 4661 6c73 652c 2027 5245 4144 5927 295d  False, 'READY')]
-000231a0: 292c 0a20 2020 2020 2020 205d 2c0a 2020  ),.        ],.  
-000231b0: 2020 2020 2020 5f54 4541 5244 4f57 4e5f        _TEARDOWN_
-000231c0: 5345 5256 4943 452e 666f 726d 6174 286e  SERVICE.format(n
-000231d0: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
-000231e0: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
-000231f0: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-00023200: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00023210: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00023220: 6763 700a 4070 7974 6573 742e 6d61 726b  gcp.@pytest.mark
-00023230: 2e73 6572 7665 0a64 6566 2074 6573 745f  .serve.def test_
-00023240: 736b 7973 6572 7665 5f64 796e 616d 6963  skyserve_dynamic
-00023250: 5f6f 6e64 656d 616e 645f 6661 6c6c 6261  _ondemand_fallba
-00023260: 636b 2829 3a0a 2020 2020 6e61 6d65 203d  ck():.    name =
-00023270: 205f 6765 745f 7365 7276 6963 655f 6e61   _get_service_na
-00023280: 6d65 2829 0a20 2020 207a 6f6e 6520 3d20  me().    zone = 
-00023290: 2775 732d 6365 6e74 7261 6c31 2d61 270a  'us-central1-a'.
-000232a0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-000232b0: 280a 2020 2020 2020 2020 6627 7465 7374  (.        f'test
-000232c0: 2d73 6b79 7365 7276 652d 6479 6e61 6d69  -skyserve-dynami
-000232d0: 632d 6f6e 6465 6d61 6e64 2d66 616c 6c62  c-ondemand-fallb
-000232e0: 6163 6b27 2c0a 2020 2020 2020 2020 5b0a  ack',.        [.
-000232f0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00023300: 7920 7365 7276 6520 7570 202d 6e20 7b6e  y serve up -n {n
-00023310: 616d 657d 202d 2d63 6c6f 7564 2067 6370  ame} --cloud gcp
-00023320: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
-00023330: 7665 2f73 706f 742f 6479 6e61 6d69 635f  ve/spot/dynamic_
-00023340: 6f6e 6465 6d61 6e64 5f66 616c 6c62 6163  ondemand_fallbac
-00023350: 6b2e 7961 6d6c 272c 0a20 2020 2020 2020  k.yaml',.       
-00023360: 2020 2020 2066 2773 6c65 6570 2034 3027       f'sleep 40'
-00023370: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00023380: 3220 6f6e 2d64 656d 616e 6420 2870 726f  2 on-demand (pro
-00023390: 7669 7369 6f6e 696e 6729 202b 2032 2053  visioning) + 2 S
-000233a0: 706f 7420 2870 726f 7669 7369 6f6e 696e  pot (provisionin
-000233b0: 6729 2e0a 2020 2020 2020 2020 2020 2020  g)..            
-000233c0: 6627 7b5f 5345 5256 455f 5354 4154 5553  f'{_SERVE_STATUS
-000233d0: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
-000233e0: 653d 6e61 6d65 297d 3b20 6563 686f 2022  e=name)}; echo "
-000233f0: 2473 223b 270a 2020 2020 2020 2020 2020  $s";'.          
-00023400: 2020 2765 6368 6f20 2224 7322 207c 2067    'echo "$s" | g
-00023410: 7265 7020 2d71 2022 302f 3422 207c 7c20  rep -q "0/4" || 
-00023420: 6578 6974 2031 272c 0a20 2020 2020 2020  exit 1',.       
-00023430: 2020 2020 2023 2057 6169 7420 666f 7220       # Wait for 
-00023440: 7468 6520 7072 6f76 6973 696f 6e69 6e67  the provisioning
-00023450: 2073 7461 7274 730a 2020 2020 2020 2020   starts.        
-00023460: 2020 2020 6627 736c 6565 7020 3430 272c      f'sleep 40',
-00023470: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
-00023480: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
-00023490: 7461 7475 7328 6e61 6d65 2c20 5b0a 2020  tatus(name, [.  
-000234a0: 2020 2020 2020 2020 2020 2020 2020 2832                (2
-000234b0: 2c20 5472 7565 2c20 5f53 4552 5649 4345  , True, _SERVICE
-000234c0: 5f4c 4155 4e43 4849 4e47 5f53 5441 5455  _LAUNCHING_STATU
-000234d0: 535f 5245 4745 5820 2b20 275c 7c52 4541  S_REGEX + '\|REA
-000234e0: 4459 2729 2c0a 2020 2020 2020 2020 2020  DY'),.          
-000234f0: 2020 2020 2020 2832 2c20 4661 6c73 652c        (2, False,
-00023500: 205f 5345 5256 4943 455f 4c41 554e 4348   _SERVICE_LAUNCH
-00023510: 494e 475f 5354 4154 5553 5f52 4547 4558  ING_STATUS_REGEX
-00023520: 202b 2027 5c7c 5348 5554 5449 4e47 5f44   + '\|SHUTTING_D
-00023530: 4f57 4e27 290a 2020 2020 2020 2020 2020  OWN').          
-00023540: 2020 5d29 2c0a 0a20 2020 2020 2020 2020    ]),..         
-00023550: 2020 2023 2057 6169 7420 756e 7469 6c20     # Wait until 
-00023560: 3220 7370 6f74 2069 6e73 7461 6e63 6573  2 spot instances
-00023570: 2061 7265 2072 6561 6479 2e0a 2020 2020   are ready..    
-00023580: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
-00023590: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
-000235a0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-000235b0: 2c20 7265 706c 6963 615f 6e75 6d3d 3229  , replica_num=2)
-000235c0: 2c0a 2020 2020 2020 2020 2020 2020 5f63  ,.            _c
-000235d0: 6865 636b 5f72 6570 6c69 6361 5f69 6e5f  heck_replica_in_
-000235e0: 7374 6174 7573 286e 616d 652c 205b 2832  status(name, [(2
-000235f0: 2c20 5472 7565 2c20 2752 4541 4459 2729  , True, 'READY')
-00023600: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00023610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023620: 2020 2020 2020 2020 2020 2020 2020 2830                (0
-00023630: 2c20 4661 6c73 652c 2027 2729 5d29 2c0a  , False, '')]),.
-00023640: 2020 2020 2020 2020 2020 2020 5f74 6572              _ter
-00023650: 6d69 6e61 7465 5f67 6370 5f72 6570 6c69  minate_gcp_repli
-00023660: 6361 286e 616d 652c 207a 6f6e 652c 2031  ca(name, zone, 1
-00023670: 292c 0a20 2020 2020 2020 2020 2020 2066  ),.            f
-00023680: 2773 6c65 6570 2034 3027 2c0a 2020 2020  'sleep 40',.    
-00023690: 2020 2020 2020 2020 2320 3120 6f6e 2d64          # 1 on-d
-000236a0: 656d 616e 6420 2870 726f 7669 7369 6f6e  emand (provision
-000236b0: 696e 6729 202b 2031 2053 706f 7420 2872  ing) + 1 Spot (r
-000236c0: 6561 6479 2920 2b20 3120 7370 6f74 2028  eady) + 1 spot (
-000236d0: 7072 6f76 6973 696f 6e69 6e67 292e 0a20  provisioning).. 
-000236e0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-000236f0: 4552 5645 5f53 5441 5455 535f 5741 4954  ERVE_STATUS_WAIT
-00023700: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-00023710: 6529 7d3b 2027 0a20 2020 2020 2020 2020  e)}; '.         
-00023720: 2020 2027 6563 686f 2022 2473 2220 7c20     'echo "$s" | 
-00023730: 6772 6570 202d 7120 2231 2f33 2227 2c0a  grep -q "1/3"',.
-00023740: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
-00023750: 636b 5f72 6570 6c69 6361 5f69 6e5f 7374  ck_replica_in_st
-00023760: 6174 7573 280a 2020 2020 2020 2020 2020  atus(.          
-00023770: 2020 2020 2020 6e61 6d65 2c20 5b28 312c        name, [(1,
-00023780: 2054 7275 652c 2027 5245 4144 5927 292c   True, 'READY'),
-00023790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000237a0: 2020 2020 2020 2020 2831 2c20 5472 7565          (1, True
-000237b0: 2c20 5f53 4552 5649 4345 5f4c 4155 4e43  , _SERVICE_LAUNC
-000237c0: 4849 4e47 5f53 5441 5455 535f 5245 4745  HING_STATUS_REGE
-000237d0: 5829 2c0a 2020 2020 2020 2020 2020 2020  X),.            
-000237e0: 2020 2020 2020 2020 2020 2028 312c 2046             (1, F
-000237f0: 616c 7365 2c20 5f53 4552 5649 4345 5f4c  alse, _SERVICE_L
-00023800: 4155 4e43 4849 4e47 5f53 5441 5455 535f  AUNCHING_STATUS_
-00023810: 5245 4745 5829 5d29 2c0a 0a20 2020 2020  REGEX)]),..     
-00023820: 2020 2020 2020 2023 2057 6169 7420 756e         # Wait un
-00023830: 7469 6c20 3220 7370 6f74 2069 6e73 7461  til 2 spot insta
-00023840: 6e63 6573 2061 7265 2072 6561 6479 2e0a  nces are ready..
-00023850: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
-00023860: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
-00023870: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
-00023880: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
-00023890: 6d3d 3229 2c0a 2020 2020 2020 2020 2020  m=2),.          
-000238a0: 2020 5f63 6865 636b 5f72 6570 6c69 6361    _check_replica
-000238b0: 5f69 6e5f 7374 6174 7573 286e 616d 652c  _in_status(name,
-000238c0: 205b 2832 2c20 5472 7565 2c20 2752 4541   [(2, True, 'REA
-000238d0: 4459 2729 2c0a 2020 2020 2020 2020 2020  DY'),.          
-000238e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000238f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023900: 2020 2830 2c20 4661 6c73 652c 2027 2729    (0, False, '')
-00023910: 5d29 2c0a 2020 2020 2020 2020 5d2c 0a20  ]),.        ],. 
-00023920: 2020 2020 2020 205f 5445 4152 444f 574e         _TEARDOWN
-00023930: 5f53 4552 5649 4345 2e66 6f72 6d61 7428  _SERVICE.format(
-00023940: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
-00023950: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
-00023960: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
-00023970: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00023980: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00023990: 2e73 6572 7665 0a64 6566 2074 6573 745f  .serve.def test_
-000239a0: 736b 7973 6572 7665 5f75 7365 725f 6275  skyserve_user_bu
-000239b0: 675f 7265 7374 6172 7428 6765 6e65 7269  g_restart(generi
-000239c0: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-000239d0: 2020 2022 2222 5465 7374 7320 7468 6174     """Tests that
-000239e0: 2077 6520 7265 7374 6172 7420 7468 6520   we restart the 
-000239f0: 7365 7276 6963 6520 6166 7465 7220 7573  service after us
-00023a00: 6572 2062 7567 2e22 2222 0a20 2020 2023  er bug.""".    #
-00023a10: 2054 4f44 4f28 7a68 7775 293a 2074 6869   TODO(zhwu): thi
-00023a20: 7320 6265 6861 7669 6f72 206e 6565 6473  s behavior needs
-00023a30: 2073 6f6d 6520 7265 7468 696e 6b69 6e67   some rethinking
-00023a40: 2e0a 2020 2020 6e61 6d65 203d 205f 6765  ..    name = _ge
-00023a50: 745f 7365 7276 6963 655f 6e61 6d65 2829  t_service_name()
-00023a60: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00023a70: 280a 2020 2020 2020 2020 6627 7465 7374  (.        f'test
-00023a80: 2d73 6b79 7365 7276 652d 7573 6572 2d62  -skyserve-user-b
-00023a90: 7567 2d72 6573 7461 7274 272c 0a20 2020  ug-restart',.   
-00023aa0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00023ab0: 2020 2066 2773 6b79 2073 6572 7665 2075     f'sky serve u
-00023ac0: 7020 2d6e 207b 6e61 6d65 7d20 2d2d 636c  p -n {name} --cl
-00023ad0: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-00023ae0: 7564 7d20 2d79 2074 6573 7473 2f73 6b79  ud} -y tests/sky
-00023af0: 7365 7276 652f 7265 7374 6172 742f 7573  serve/restart/us
-00023b00: 6572 5f62 7567 2e79 616d 6c27 2c0a 2020  er_bug.yaml',.  
-00023b10: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-00023b20: 736b 7920 7365 7276 6520 7374 6174 7573  sky serve status
-00023b30: 207b 6e61 6d65 7d29 3b20 6563 686f 2022   {name}); echo "
-00023b40: 2473 223b 270a 2020 2020 2020 2020 2020  $s";'.          
-00023b50: 2020 2775 6e74 696c 2065 6368 6f20 2224    'until echo "$
-00023b60: 7322 207c 2067 7265 7020 2d41 2031 3030  s" | grep -A 100
-00023b70: 2022 5365 7276 6963 6520 5265 706c 6963   "Service Replic
-00023b80: 6173 2220 7c20 6772 6570 2022 5348 5554  as" | grep "SHUT
-00023b90: 5449 4e47 5f44 4f57 4e22 3b20 270a 2020  TING_DOWN"; '.  
-00023ba0: 2020 2020 2020 2020 2020 2764 6f20 6563            'do ec
-00023bb0: 686f 2022 5761 6974 696e 6720 666f 7220  ho "Waiting for 
-00023bc0: 6669 7273 7420 7365 7276 6963 6520 746f  first service to
-00023bd0: 2062 6520 5348 5554 5449 4e47 2044 4f57   be SHUTTING DOW
-00023be0: 4e2e 2e2e 223b 2027 0a20 2020 2020 2020  N..."; '.       
-00023bf0: 2020 2020 2066 2773 6c65 6570 2035 3b20       f'sleep 5; 
-00023c00: 733d 2428 736b 7920 7365 7276 6520 7374  s=$(sky serve st
-00023c10: 6174 7573 207b 6e61 6d65 7d29 3b20 6563  atus {name}); ec
-00023c20: 686f 2022 2473 223b 2064 6f6e 653b 2027  ho "$s"; done; '
-00023c30: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00023c40: 733d 2428 736b 7920 7365 7276 6520 7374  s=$(sky serve st
-00023c50: 6174 7573 207b 6e61 6d65 7d29 3b20 6563  atus {name}); ec
-00023c60: 686f 2022 2473 223b 270a 2020 2020 2020  ho "$s";'.      
-00023c70: 2020 2020 2020 2775 6e74 696c 2065 6368        'until ech
-00023c80: 6f20 2224 7322 207c 2067 7265 7020 2d41  o "$s" | grep -A
-00023c90: 2031 3030 2022 5365 7276 6963 6520 5265   100 "Service Re
-00023ca0: 706c 6963 6173 2220 7c20 6772 6570 2022  plicas" | grep "
-00023cb0: 4641 494c 4544 223b 2027 0a20 2020 2020  FAILED"; '.     
-00023cc0: 2020 2020 2020 2027 646f 2065 6368 6f20         'do echo 
-00023cd0: 2257 6169 7469 6e67 2066 6f72 2066 6972  "Waiting for fir
-00023ce0: 7374 2073 6572 7669 6365 2074 6f20 6265  st service to be
-00023cf0: 2046 4149 4c45 442e 2e2e 223b 2027 0a20   FAILED..."; '. 
-00023d00: 2020 2020 2020 2020 2020 2066 2773 6c65             f'sle
-00023d10: 6570 2035 3b20 733d 2428 736b 7920 7365  ep 5; s=$(sky se
-00023d20: 7276 6520 7374 6174 7573 207b 6e61 6d65  rve status {name
-00023d30: 7d29 3b20 6563 686f 2022 2473 223b 2064  }); echo "$s"; d
-00023d40: 6f6e 653b 2065 6368 6f20 2224 7322 3b20  one; echo "$s"; 
-00023d50: 270a 2020 2020 2020 2020 2020 2020 2b20  '.            + 
-00023d60: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
-00023d70: 6e5f 7374 6174 7573 286e 616d 652c 205b  n_status(name, [
-00023d80: 2831 2c20 5472 7565 2c20 2746 4149 4c45  (1, True, 'FAILE
-00023d90: 4427 295d 2920 2b0a 2020 2020 2020 2020  D')]) +.        
-00023da0: 2020 2020 2320 5573 6572 2062 7567 2066      # User bug f
-00023db0: 6169 6c75 7265 2077 696c 6c20 6361 7573  ailure will caus
-00023dc0: 6520 6e6f 2066 7572 7468 6572 2073 6361  e no further sca
-00023dd0: 6c69 6e67 2e0a 2020 2020 2020 2020 2020  ling..          
-00023de0: 2020 6627 6563 686f 2022 2473 2220 7c20    f'echo "$s" | 
-00023df0: 6772 6570 202d 4120 3130 3020 2253 6572  grep -A 100 "Ser
-00023e00: 7669 6365 2052 6570 6c69 6361 7322 207c  vice Replicas" |
-00023e10: 2067 7265 7020 227b 6e61 6d65 7d22 207c   grep "{name}" |
-00023e20: 2077 6320 2d6c 207c 2067 7265 7020 313b   wc -l | grep 1;
-00023e30: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
-00023e40: 2765 6368 6f20 2224 7322 207c 2067 7265  'echo "$s" | gre
-00023e50: 7020 2d42 2031 3030 2022 4e4f 5f52 4550  p -B 100 "NO_REP
-00023e60: 4c49 4341 2220 7c20 6772 6570 2022 302f  LICA" | grep "0/
-00023e70: 3022 272c 0a20 2020 2020 2020 2020 2020  0"',.           
-00023e80: 2066 2773 6b79 2073 6572 7665 2075 7064   f'sky serve upd
-00023e90: 6174 6520 7b6e 616d 657d 202d 2d63 6c6f  ate {name} --clo
-00023ea0: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
-00023eb0: 647d 202d 7920 7465 7374 732f 736b 7973  d} -y tests/skys
-00023ec0: 6572 7665 2f61 7574 6f5f 7265 7374 6172  erve/auto_restar
-00023ed0: 742e 7961 6d6c 272c 0a20 2020 2020 2020  t.yaml',.       
-00023ee0: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
-00023ef0: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
-00023f00: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
-00023f10: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-00023f20: 756e 7469 6c20 6375 726c 2068 7474 703a  until curl http:
-00023f30: 2f2f 2465 6e64 706f 696e 7420 7c20 6772  //$endpoint | gr
-00023f40: 6570 2022 4869 2c20 536b 7950 696c 6f74  ep "Hi, SkyPilot
-00023f50: 2068 6572 6521 223b 2064 6f20 736c 6565   here!"; do slee
-00023f60: 7020 323b 2064 6f6e 653b 2073 6c65 6570  p 2; done; sleep
-00023f70: 2032 3b20 270a 2020 2020 2020 2020 2020   2; '.          
-00023f80: 2020 2b20 5f63 6865 636b 5f72 6570 6c69    + _check_repli
-00023f90: 6361 5f69 6e5f 7374 6174 7573 286e 616d  ca_in_status(nam
-00023fa0: 652c 205b 2831 2c20 4661 6c73 652c 2027  e, [(1, False, '
-00023fb0: 5245 4144 5927 292c 0a20 2020 2020 2020  READY'),.       
-00023fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023fe0: 2020 2020 2020 2028 312c 2046 616c 7365         (1, False
-00023ff0: 2c20 2746 4149 4c45 4427 295d 292c 0a20  , 'FAILED')]),. 
-00024000: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00024010: 2020 5f54 4541 5244 4f57 4e5f 5345 5256    _TEARDOWN_SERV
-00024020: 4943 452e 666f 726d 6174 286e 616d 653d  ICE.format(name=
-00024030: 6e61 6d65 292c 0a20 2020 2020 2020 2074  name),.        t
-00024040: 696d 656f 7574 3d32 3020 2a20 3630 2c0a  imeout=20 * 60,.
-00024050: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00024060: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00024070: 7079 7465 7374 2e6d 6172 6b2e 7365 7276  pytest.mark.serv
-00024080: 650a 4070 7974 6573 742e 6d61 726b 2e6e  e.@pytest.mark.n
-00024090: 6f5f 6b75 6265 726e 6574 6573 2020 2320  o_kubernetes  # 
-000240a0: 5265 706c 6963 6173 206f 6e20 6b38 7320  Replicas on k8s 
-000240b0: 6d61 7920 6265 2072 756e 6e69 6e67 206f  may be running o
-000240c0: 6e20 7468 6520 7361 6d65 206e 6f64 6520  n the same node 
-000240d0: 616e 6420 6861 7665 2074 6865 2073 616d  and have the sam
-000240e0: 6520 7075 626c 6963 2049 500a 6465 6620  e public IP.def 
-000240f0: 7465 7374 5f73 6b79 7365 7276 655f 6c6f  test_skyserve_lo
-00024100: 6164 5f62 616c 616e 6365 7228 6765 6e65  ad_balancer(gene
-00024110: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
-00024120: 0a20 2020 2022 2222 5465 7374 2073 6b79  .    """Test sky
-00024130: 7365 7276 6520 6c6f 6164 2062 616c 616e  serve load balan
-00024140: 6365 7220 726f 756e 642d 726f 6269 6e20  cer round-robin 
-00024150: 706f 6c69 6379 2222 220a 2020 2020 6e61  policy""".    na
-00024160: 6d65 203d 205f 6765 745f 7365 7276 6963  me = _get_servic
-00024170: 655f 6e61 6d65 2829 0a20 2020 2074 6573  e_name().    tes
-00024180: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00024190: 2020 6627 7465 7374 2d73 6b79 7365 7276    f'test-skyserv
-000241a0: 652d 6c6f 6164 2d62 616c 616e 6365 7227  e-load-balancer'
-000241b0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-000241c0: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
-000241d0: 7276 6520 7570 202d 6e20 7b6e 616d 657d  rve up -n {name}
-000241e0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-000241f0: 635f 636c 6f75 647d 202d 7920 7465 7374  c_cloud} -y test
-00024200: 732f 736b 7973 6572 7665 2f6c 6f61 645f  s/skyserve/load_
-00024210: 6261 6c61 6e63 6572 2f73 6572 7669 6365  balancer/service
-00024220: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00024230: 2020 2020 5f53 4552 5645 5f57 4149 545f      _SERVE_WAIT_
-00024240: 554e 5449 4c5f 5245 4144 592e 666f 726d  UNTIL_READY.form
-00024250: 6174 286e 616d 653d 6e61 6d65 2c20 7265  at(name=name, re
-00024260: 706c 6963 615f 6e75 6d3d 3329 2c0a 2020  plica_num=3),.  
-00024270: 2020 2020 2020 2020 2020 6627 7b5f 5345            f'{_SE
-00024280: 5256 455f 454e 4450 4f49 4e54 5f57 4149  RVE_ENDPOINT_WAI
-00024290: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
-000242a0: 6d65 297d 3b20 270a 2020 2020 2020 2020  me)}; '.        
-000242b0: 2020 2020 6627 7b5f 5345 5256 455f 5354      f'{_SERVE_ST
-000242c0: 4154 5553 5f57 4149 542e 666f 726d 6174  ATUS_WAIT.format
-000242d0: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
-000242e0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-000242f0: 6765 745f 7265 706c 6963 615f 6970 286e  get_replica_ip(n
-00024300: 616d 652c 2031 297d 3b20 270a 2020 2020  ame, 1)}; '.    
-00024310: 2020 2020 2020 2020 6627 7b5f 6765 745f          f'{_get_
-00024320: 7265 706c 6963 615f 6970 286e 616d 652c  replica_ip(name,
-00024330: 2032 297d 3b20 7b5f 6765 745f 7265 706c   2)}; {_get_repl
-00024340: 6963 615f 6970 286e 616d 652c 2033 297d  ica_ip(name, 3)}
-00024350: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-00024360: 2770 7974 686f 6e20 7465 7374 732f 736b  'python tests/sk
-00024370: 7973 6572 7665 2f6c 6f61 645f 6261 6c61  yserve/load_bala
-00024380: 6e63 6572 2f74 6573 745f 726f 756e 645f  ncer/test_round_
-00024390: 726f 6269 6e2e 7079 2027 0a20 2020 2020  robin.py '.     
-000243a0: 2020 2020 2020 2027 2d2d 656e 6470 6f69         '--endpoi
-000243b0: 6e74 2024 656e 6470 6f69 6e74 202d 2d72  nt $endpoint --r
-000243c0: 6570 6c69 6361 2d6e 756d 2033 202d 2d72  eplica-num 3 --r
-000243d0: 6570 6c69 6361 2d69 7073 2024 6970 3120  eplica-ips $ip1 
-000243e0: 2469 7032 2024 6970 3327 2c0a 2020 2020  $ip2 $ip3',.    
-000243f0: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
-00024400: 5445 4152 444f 574e 5f53 4552 5649 4345  TEARDOWN_SERVICE
-00024410: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-00024420: 6529 2c0a 2020 2020 2020 2020 7469 6d65  e),.        time
-00024430: 6f75 743d 3230 202a 2036 302c 0a20 2020  out=20 * 60,.   
-00024440: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00024450: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-00024460: 6573 742e 6d61 726b 2e67 6370 0a40 7079  est.mark.gcp.@py
-00024470: 7465 7374 2e6d 6172 6b2e 7365 7276 650a  test.mark.serve.
-00024480: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00024490: 6b75 6265 726e 6574 6573 0a64 6566 2074  kubernetes.def t
-000244a0: 6573 745f 736b 7973 6572 7665 5f61 7574  est_skyserve_aut
-000244b0: 6f5f 7265 7374 6172 7428 293a 0a20 2020  o_restart():.   
-000244c0: 2022 2222 5465 7374 2073 6b79 7365 7276   """Test skyserv
-000244d0: 6520 7769 7468 2061 7574 6f20 7265 7374  e with auto rest
-000244e0: 6172 7422 2222 0a20 2020 206e 616d 6520  art""".    name 
-000244f0: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
-00024500: 616d 6528 290a 2020 2020 7a6f 6e65 203d  ame().    zone =
-00024510: 2027 7573 2d63 656e 7472 616c 312d 6127   'us-central1-a'
-00024520: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00024530: 280a 2020 2020 2020 2020 6627 7465 7374  (.        f'test
-00024540: 2d73 6b79 7365 7276 652d 6175 746f 2d72  -skyserve-auto-r
-00024550: 6573 7461 7274 272c 0a20 2020 2020 2020  estart',.       
-00024560: 205b 0a20 2020 2020 2020 2020 2020 2023   [.            #
-00024570: 2054 4f44 4f28 7469 616e 293a 2077 6520   TODO(tian): we 
-00024580: 6361 6e20 6479 6e61 6d69 6361 6c6c 7920  can dynamically 
-00024590: 6765 6e65 7261 7465 2059 414d 4c20 6672  generate YAML fr
-000245a0: 6f6d 2074 656d 706c 6174 6520 746f 0a20  om template to. 
-000245b0: 2020 2020 2020 2020 2020 2023 2061 766f             # avo
-000245c0: 6964 206d 6169 6e74 6169 6e69 6e67 2074  id maintaining t
-000245d0: 6f6f 206d 616e 7920 5941 4d4c 2066 696c  oo many YAML fil
-000245e0: 6573 0a20 2020 2020 2020 2020 2020 2066  es.            f
-000245f0: 2773 6b79 2073 6572 7665 2075 7020 2d6e  'sky serve up -n
-00024600: 207b 6e61 6d65 7d20 2d79 2074 6573 7473   {name} -y tests
-00024610: 2f73 6b79 7365 7276 652f 6175 746f 5f72  /skyserve/auto_r
-00024620: 6573 7461 7274 2e79 616d 6c27 2c0a 2020  estart.yaml',.  
-00024630: 2020 2020 2020 2020 2020 5f53 4552 5645            _SERVE
-00024640: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
-00024650: 592e 666f 726d 6174 286e 616d 653d 6e61  Y.format(name=na
-00024660: 6d65 2c20 7265 706c 6963 615f 6e75 6d3d  me, replica_num=
-00024670: 3129 2c0a 2020 2020 2020 2020 2020 2020  1),.            
-00024680: 6627 7b5f 5345 5256 455f 454e 4450 4f49  f'{_SERVE_ENDPOI
-00024690: 4e54 5f57 4149 542e 666f 726d 6174 286e  NT_WAIT.format(n
-000246a0: 616d 653d 6e61 6d65 297d 3b20 270a 2020  ame=name)}; '.  
-000246b0: 2020 2020 2020 2020 2020 2772 6571 7565            'reque
-000246c0: 7374 5f6f 7574 7075 743d 2428 6375 726c  st_output=$(curl
-000246d0: 2068 7474 703a 2f2f 2465 6e64 706f 696e   http://$endpoin
-000246e0: 7429 3b20 6563 686f 2022 2472 6571 7565  t); echo "$reque
-000246f0: 7374 5f6f 7574 7075 7422 3b20 6563 686f  st_output"; echo
-00024700: 2022 2472 6571 7565 7374 5f6f 7574 7075   "$request_outpu
-00024710: 7422 207c 2067 7265 7020 2248 692c 2053  t" | grep "Hi, S
-00024720: 6b79 5069 6c6f 7420 6865 7265 2227 2c0a  kyPilot here"',.
-00024730: 2020 2020 2020 2020 2020 2020 2320 736c              # sl
-00024740: 6565 7020 666f 7220 3230 2073 6563 6f6e  eep for 20 secon
-00024750: 6473 2028 696e 6974 6961 6c20 6465 6c61  ds (initial dela
-00024760: 7929 2074 6f20 6d61 6b65 2073 7572 6520  y) to make sure 
-00024770: 6974 2077 696c 6c0a 2020 2020 2020 2020  it will.        
-00024780: 2020 2020 2320 6265 2072 6573 7461 7274      # be restart
-00024790: 6564 0a20 2020 2020 2020 2020 2020 2066  ed.            f
-000247a0: 2773 6c65 6570 2032 3027 2c0a 2020 2020  'sleep 20',.    
-000247b0: 2020 2020 2020 2020 5f74 6572 6d69 6e61          _termina
-000247c0: 7465 5f67 6370 5f72 6570 6c69 6361 286e  te_gcp_replica(n
-000247d0: 616d 652c 207a 6f6e 652c 2031 292c 0a20  ame, zone, 1),. 
-000247e0: 2020 2020 2020 2020 2020 2023 2057 6169             # Wai
-000247f0: 7420 666f 7220 636f 6e73 6563 7574 6976  t for consecutiv
-00024800: 6520 6661 696c 7572 6520 7469 6d65 6f75  e failure timeou
-00024810: 7420 7061 7373 6564 2e0a 2020 2020 2020  t passed..      
-00024820: 2020 2020 2020 2320 4966 2074 6865 2063        # If the c
-00024830: 6c75 7374 6572 2069 7320 6e6f 7420 7573  luster is not us
-00024840: 696e 6720 7370 6f74 2c20 6974 2077 6f6e  ing spot, it won
-00024850: 2774 2063 6865 636b 2074 6865 2063 6c75  't check the clu
-00024860: 7374 6572 2073 7461 7475 730a 2020 2020  ster status.    
-00024870: 2020 2020 2020 2020 2320 6f6e 2074 6865          # on the
-00024880: 2063 6c6f 7564 2028 7369 6e63 6520 6d61   cloud (since ma
-00024890: 6e75 616c 2073 6875 7464 6f77 6e20 6973  nual shutdown is
-000248a0: 206e 6f74 2061 2063 6f6d 6d6f 6e20 6265   not a common be
-000248b0: 6861 7669 6f72 2061 6e64 2073 7563 680a  havior and such.
-000248c0: 2020 2020 2020 2020 2020 2020 2320 7175              # qu
-000248d0: 6572 6965 7320 7461 6b65 7320 6120 6c6f  eries takes a lo
-000248e0: 7420 6f66 2074 696d 6529 2e20 496e 7374  t of time). Inst
-000248f0: 6561 642c 2077 6520 7468 696e 6b20 636f  ead, we think co
-00024900: 6e74 696e 756f 7573 2033 206d 696e 2070  ntinuous 3 min p
-00024910: 726f 6265 0a20 2020 2020 2020 2020 2020  robe.           
-00024920: 2023 2066 6169 6c75 7265 2069 7320 6e6f   # failure is no
-00024930: 7420 6120 7465 6d70 6f72 6172 7920 7072  t a temporary pr
-00024940: 6f62 6c65 6d20 6275 7420 696e 6465 6564  oblem but indeed
-00024950: 2061 2066 6169 6c75 7265 2e0a 2020 2020   a failure..    
-00024960: 2020 2020 2020 2020 2773 6c65 6570 2031          'sleep 1
-00024970: 3830 272c 0a20 2020 2020 2020 2020 2020  80',.           
-00024980: 2023 2057 6520 6361 6e6e 6f74 2075 7365   # We cannot use
-00024990: 205f 5345 5256 455f 5741 4954 5f55 4e54   _SERVE_WAIT_UNT
-000249a0: 494c 5f52 4541 4459 3b20 7468 6572 6520  IL_READY; there 
-000249b0: 7769 6c6c 2062 6520 6120 696e 7465 726d  will be a interm
-000249c0: 6564 6961 7465 2074 696d 650a 2020 2020  ediate time.    
-000249d0: 2020 2020 2020 2020 2320 7468 6174 2074          # that t
-000249e0: 6865 206f 7574 7075 7420 6f66 2060 736b  he output of `sk
-000249f0: 7920 7365 7276 6520 7374 6174 7573 6020  y serve status` 
-00024a00: 7368 6f77 7320 4641 494c 4544 2061 6e64  shows FAILED and
-00024a10: 2074 6869 7320 7374 6174 7573 2077 696c   this status wil
-00024a20: 6c0a 2020 2020 2020 2020 2020 2020 2320  l.            # 
-00024a30: 6361 7573 6520 5f53 4552 5645 5f57 4149  cause _SERVE_WAI
-00024a40: 545f 554e 5449 4c5f 5245 4144 5920 746f  T_UNTIL_READY to
-00024a50: 2065 6172 6c79 2071 7569 742e 0a20 2020   early quit..   
-00024a60: 2020 2020 2020 2020 2027 2877 6869 6c65           '(while
-00024a70: 2074 7275 653b 2064 6f27 0a20 2020 2020   true; do'.     
-00024a80: 2020 2020 2020 2066 2720 2020 206f 7574         f'    out
-00024a90: 7075 743d 2428 736b 7920 7365 7276 6520  put=$(sky serve 
-00024aa0: 7374 6174 7573 207b 6e61 6d65 7d29 3b27  status {name});'
-00024ab0: 0a20 2020 2020 2020 2020 2020 2027 2020  .            '  
-00024ac0: 2020 2065 6368 6f20 2224 6f75 7470 7574     echo "$output
-00024ad0: 2220 7c20 6772 6570 202d 7120 2231 2f31  " | grep -q "1/1
-00024ae0: 2220 2626 2062 7265 616b 3b27 0a20 2020  " && break;'.   
-00024af0: 2020 2020 2020 2020 2027 2020 2020 2073           '     s
-00024b00: 6c65 6570 2031 303b 270a 2020 2020 2020  leep 10;'.      
-00024b10: 2020 2020 2020 6627 646f 6e65 293b 2073        f'done); s
-00024b20: 6c65 6570 207b 7365 7276 652e 4c42 5f43  leep {serve.LB_C
-00024b30: 4f4e 5452 4f4c 4c45 525f 5359 4e43 5f49  ONTROLLER_SYNC_I
-00024b40: 4e54 4552 5641 4c5f 5345 434f 4e44 537d  NTERVAL_SECONDS}
-00024b50: 3b27 2c0a 2020 2020 2020 2020 2020 2020  ;',.            
-00024b60: 6627 7b5f 5345 5256 455f 454e 4450 4f49  f'{_SERVE_ENDPOI
-00024b70: 4e54 5f57 4149 542e 666f 726d 6174 286e  NT_WAIT.format(n
-00024b80: 616d 653d 6e61 6d65 297d 3b20 270a 2020  ame=name)}; '.  
-00024b90: 2020 2020 2020 2020 2020 2772 6571 7565            'reque
-00024ba0: 7374 5f6f 7574 7075 743d 2428 6375 726c  st_output=$(curl
-00024bb0: 2068 7474 703a 2f2f 2465 6e64 706f 696e   http://$endpoin
-00024bc0: 7429 3b20 6563 686f 2022 2472 6571 7565  t); echo "$reque
-00024bd0: 7374 5f6f 7574 7075 7422 3b20 6563 686f  st_output"; echo
-00024be0: 2022 2472 6571 7565 7374 5f6f 7574 7075   "$request_outpu
-00024bf0: 7422 207c 2067 7265 7020 2248 692c 2053  t" | grep "Hi, S
-00024c00: 6b79 5069 6c6f 7420 6865 7265 2227 2c0a  kyPilot here"',.
-00024c10: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00024c20: 2020 205f 5445 4152 444f 574e 5f53 4552     _TEARDOWN_SER
-00024c30: 5649 4345 2e66 6f72 6d61 7428 6e61 6d65  VICE.format(name
-00024c40: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
-00024c50: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
-00024c60: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00024c70: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00024c80: 4070 7974 6573 742e 6d61 726b 2e73 6572  @pytest.mark.ser
-00024c90: 7665 0a64 6566 2074 6573 745f 736b 7973  ve.def test_skys
-00024ca0: 6572 7665 5f63 616e 6365 6c28 6765 6e65  erve_cancel(gene
-00024cb0: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
-00024cc0: 0a20 2020 2022 2222 5465 7374 2073 6b79  .    """Test sky
-00024cd0: 7365 7276 6520 7769 7468 2063 616e 6365  serve with cance
-00024ce0: 6c22 2222 0a20 2020 206e 616d 6520 3d20  l""".    name = 
-00024cf0: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
-00024d00: 6528 290a 0a20 2020 2074 6573 7420 3d20  e()..    test = 
-00024d10: 5465 7374 280a 2020 2020 2020 2020 6627  Test(.        f'
-00024d20: 7465 7374 2d73 6b79 7365 7276 652d 6361  test-skyserve-ca
-00024d30: 6e63 656c 272c 0a20 2020 2020 2020 205b  ncel',.        [
-00024d40: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00024d50: 6b79 2073 6572 7665 2075 7020 2d6e 207b  ky serve up -n {
-00024d60: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
-00024d70: 656e 6572 6963 5f63 6c6f 7564 7d20 2d79  eneric_cloud} -y
-00024d80: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
-00024d90: 6361 6e63 656c 2f63 616e 6365 6c2e 7961  cancel/cancel.ya
-00024da0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00024db0: 205f 5345 5256 455f 5741 4954 5f55 4e54   _SERVE_WAIT_UNT
-00024dc0: 494c 5f52 4541 4459 2e66 6f72 6d61 7428  IL_READY.format(
-00024dd0: 6e61 6d65 3d6e 616d 652c 2072 6570 6c69  name=name, repli
-00024de0: 6361 5f6e 756d 3d31 292c 0a20 2020 2020  ca_num=1),.     
-00024df0: 2020 2020 2020 2066 277b 5f53 4552 5645         f'{_SERVE
-00024e00: 5f45 4e44 504f 494e 545f 5741 4954 2e66  _ENDPOINT_WAIT.f
-00024e10: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
-00024e20: 7d3b 2070 7974 686f 6e33 2027 0a20 2020  }; python3 '.   
-00024e30: 2020 2020 2020 2020 2027 7465 7374 732f           'tests/
-00024e40: 736b 7973 6572 7665 2f63 616e 6365 6c2f  skyserve/cancel/
-00024e50: 7365 6e64 5f63 616e 6365 6c5f 7265 7175  send_cancel_requ
-00024e60: 6573 742e 7079 2027 0a20 2020 2020 2020  est.py '.       
-00024e70: 2020 2020 2027 2d2d 656e 6470 6f69 6e74       '--endpoint
-00024e80: 2024 656e 6470 6f69 6e74 207c 2067 7265   $endpoint | gre
-00024e90: 7020 2252 6571 7565 7374 2077 6173 2063  p "Request was c
-00024ea0: 616e 6365 6c6c 6564 2227 2c0a 2020 2020  ancelled"',.    
-00024eb0: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-00024ec0: 7920 7365 7276 6520 6c6f 6773 207b 6e61  y serve logs {na
-00024ed0: 6d65 7d20 3120 2d2d 6e6f 2d66 6f6c 6c6f  me} 1 --no-follo
-00024ee0: 7729 3b20 270a 2020 2020 2020 2020 2020  w); '.          
-00024ef0: 2020 2775 6e74 696c 2021 2065 6368 6f20    'until ! echo 
-00024f00: 2224 7322 207c 2067 7265 7020 2250 6c65  "$s" | grep "Ple
-00024f10: 6173 6520 7761 6974 2066 6f72 2074 6865  ase wait for the
-00024f20: 2063 6f6e 7472 6f6c 6c65 7220 746f 2062   controller to b
-00024f30: 6522 3b20 270a 2020 2020 2020 2020 2020  e"; '.          
-00024f40: 2020 2764 6f20 6563 686f 2022 5761 6974    'do echo "Wait
-00024f50: 696e 6720 666f 7220 7365 7276 6520 6c6f  ing for serve lo
-00024f60: 6773 223b 2073 6c65 6570 2031 303b 2027  gs"; sleep 10; '
-00024f70: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00024f80: 3d24 2873 6b79 2073 6572 7665 206c 6f67  =$(sky serve log
-00024f90: 7320 7b6e 616d 657d 2031 202d 2d6e 6f2d  s {name} 1 --no-
-00024fa0: 666f 6c6c 6f77 293b 2064 6f6e 653b 2027  follow); done; '
-00024fb0: 0a20 2020 2020 2020 2020 2020 2027 6563  .            'ec
-00024fc0: 686f 2022 2473 223b 2065 6368 6f20 2224  ho "$s"; echo "$
-00024fd0: 7322 207c 2067 7265 7020 2243 6c69 656e  s" | grep "Clien
-00024fe0: 7420 6469 7363 6f6e 6e65 6374 6564 2c20  t disconnected, 
-00024ff0: 7374 6f70 7069 6e67 2063 6f6d 7075 7461  stopping computa
-00025000: 7469 6f6e 2227 2c0a 2020 2020 2020 2020  tion"',.        
-00025010: 5d2c 0a20 2020 2020 2020 205f 5445 4152  ],.        _TEAR
-00025020: 444f 574e 5f53 4552 5649 4345 2e66 6f72  DOWN_SERVICE.for
-00025030: 6d61 7428 6e61 6d65 3d6e 616d 6529 2c0a  mat(name=name),.
-00025040: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-00025050: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
-00025060: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00025070: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00025080: 6d61 726b 2e73 6572 7665 0a64 6566 2074  mark.serve.def t
-00025090: 6573 745f 736b 7973 6572 7665 5f73 7472  est_skyserve_str
-000250a0: 6561 6d69 6e67 2867 656e 6572 6963 5f63  eaming(generic_c
-000250b0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-000250c0: 2222 2254 6573 7420 736b 7973 6572 7665  """Test skyserve
-000250d0: 2077 6974 6820 7374 7265 616d 696e 6722   with streaming"
-000250e0: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
-000250f0: 6574 5f73 6572 7669 6365 5f6e 616d 6528  et_service_name(
-00025100: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-00025110: 7428 0a20 2020 2020 2020 2066 2774 6573  t(.        f'tes
-00025120: 742d 736b 7973 6572 7665 2d73 7472 6561  t-skyserve-strea
-00025130: 6d69 6e67 272c 0a20 2020 2020 2020 205b  ming',.        [
-00025140: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00025150: 6b79 2073 6572 7665 2075 7020 2d6e 207b  ky serve up -n {
-00025160: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
-00025170: 656e 6572 6963 5f63 6c6f 7564 7d20 2d79  eneric_cloud} -y
-00025180: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
-00025190: 7374 7265 616d 696e 672f 7374 7265 616d  streaming/stream
-000251a0: 696e 672e 7961 6d6c 272c 0a20 2020 2020  ing.yaml',.     
-000251b0: 2020 2020 2020 205f 5345 5256 455f 5741         _SERVE_WA
-000251c0: 4954 5f55 4e54 494c 5f52 4541 4459 2e66  IT_UNTIL_READY.f
-000251d0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 652c  ormat(name=name,
-000251e0: 2072 6570 6c69 6361 5f6e 756d 3d31 292c   replica_num=1),
-000251f0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-00025200: 5f53 4552 5645 5f45 4e44 504f 494e 545f  _SERVE_ENDPOINT_
-00025210: 5741 4954 2e66 6f72 6d61 7428 6e61 6d65  WAIT.format(name
-00025220: 3d6e 616d 6529 7d3b 2027 0a20 2020 2020  =name)}; '.     
-00025230: 2020 2020 2020 2027 7079 7468 6f6e 3320         'python3 
-00025240: 7465 7374 732f 736b 7973 6572 7665 2f73  tests/skyserve/s
-00025250: 7472 6561 6d69 6e67 2f73 656e 645f 7374  treaming/send_st
-00025260: 7265 616d 696e 675f 7265 7175 6573 742e  reaming_request.
-00025270: 7079 2027 0a20 2020 2020 2020 2020 2020  py '.           
-00025280: 2027 2d2d 656e 6470 6f69 6e74 2024 656e   '--endpoint $en
-00025290: 6470 6f69 6e74 207c 2067 7265 7020 2253  dpoint | grep "S
-000252a0: 7472 6561 6d69 6e67 2074 6573 7420 7061  treaming test pa
-000252b0: 7373 6564 2227 2c0a 2020 2020 2020 2020  ssed"',.        
-000252c0: 5d2c 0a20 2020 2020 2020 205f 5445 4152  ],.        _TEAR
-000252d0: 444f 574e 5f53 4552 5649 4345 2e66 6f72  DOWN_SERVICE.for
-000252e0: 6d61 7428 6e61 6d65 3d6e 616d 6529 2c0a  mat(name=name),.
-000252f0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-00025300: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
-00025310: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00025320: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00025330: 6d61 726b 2e73 6572 7665 0a64 6566 2074  mark.serve.def t
-00025340: 6573 745f 736b 7973 6572 7665 5f75 7064  est_skyserve_upd
-00025350: 6174 6528 6765 6e65 7269 635f 636c 6f75  ate(generic_clou
-00025360: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
-00025370: 5465 7374 2073 6b79 7365 7276 6520 7769  Test skyserve wi
-00025380: 7468 2075 7064 6174 6522 2222 0a20 2020  th update""".   
-00025390: 206e 616d 6520 3d20 5f67 6574 5f73 6572   name = _get_ser
-000253a0: 7669 6365 5f6e 616d 6528 290a 2020 2020  vice_name().    
-000253b0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-000253c0: 2020 2020 2066 2774 6573 742d 736b 7973       f'test-skys
-000253d0: 6572 7665 2d75 7064 6174 6527 2c0a 2020  erve-update',.  
-000253e0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-000253f0: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
-00025400: 7570 202d 6e20 7b6e 616d 657d 202d 2d63  up -n {name} --c
-00025410: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-00025420: 6f75 647d 202d 7920 7465 7374 732f 736b  oud} -y tests/sk
-00025430: 7973 6572 7665 2f75 7064 6174 652f 6f6c  yserve/update/ol
-00025440: 642e 7961 6d6c 272c 0a20 2020 2020 2020  d.yaml',.       
-00025450: 2020 2020 205f 5345 5256 455f 5741 4954       _SERVE_WAIT
-00025460: 5f55 4e54 494c 5f52 4541 4459 2e66 6f72  _UNTIL_READY.for
-00025470: 6d61 7428 6e61 6d65 3d6e 616d 652c 2072  mat(name=name, r
-00025480: 6570 6c69 6361 5f6e 756d 3d32 292c 0a20  eplica_num=2),. 
-00025490: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-000254a0: 4552 5645 5f45 4e44 504f 494e 545f 5741  ERVE_ENDPOINT_WA
-000254b0: 4954 2e66 6f72 6d61 7428 6e61 6d65 3d6e  IT.format(name=n
-000254c0: 616d 6529 7d3b 2063 7572 6c20 6874 7470  ame)}; curl http
-000254d0: 3a2f 2f24 656e 6470 6f69 6e74 207c 2067  ://$endpoint | g
-000254e0: 7265 7020 2248 692c 2053 6b79 5069 6c6f  rep "Hi, SkyPilo
-000254f0: 7420 6865 7265 2227 2c0a 2020 2020 2020  t here"',.      
-00025500: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
-00025510: 6520 7570 6461 7465 207b 6e61 6d65 7d20  e update {name} 
-00025520: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-00025530: 5f63 6c6f 7564 7d20 2d2d 6d6f 6465 2062  _cloud} --mode b
-00025540: 6c75 655f 6772 6565 6e20 2d79 2074 6573  lue_green -y tes
-00025550: 7473 2f73 6b79 7365 7276 652f 7570 6461  ts/skyserve/upda
-00025560: 7465 2f6e 6577 2e79 616d 6c27 2c0a 2020  te/new.yaml',.  
-00025570: 2020 2020 2020 2020 2020 2320 736c 6565            # slee
-00025580: 7020 6265 666f 7265 2075 7064 6174 6520  p before update 
-00025590: 6973 2072 6567 6973 7465 7265 642e 0a20  is registered.. 
-000255a0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-000255b0: 7020 3230 272c 0a20 2020 2020 2020 2020  p 20',.         
-000255c0: 2020 2066 277b 5f53 4552 5645 5f45 4e44     f'{_SERVE_END
-000255d0: 504f 494e 545f 5741 4954 2e66 6f72 6d61  POINT_WAIT.forma
-000255e0: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2027  t(name=name)}; '
-000255f0: 0a20 2020 2020 2020 2020 2020 2027 756e  .            'un
-00025600: 7469 6c20 6375 726c 2068 7474 703a 2f2f  til curl http://
-00025610: 2465 6e64 706f 696e 7420 7c20 6772 6570  $endpoint | grep
-00025620: 2022 4869 2c20 6e65 7720 536b 7950 696c   "Hi, new SkyPil
-00025630: 6f74 2068 6572 6521 223b 2064 6f20 736c  ot here!"; do sl
-00025640: 6565 7020 323b 2064 6f6e 653b 270a 2020  eep 2; done;'.  
-00025650: 2020 2020 2020 2020 2020 2320 4d61 6b65            # Make
-00025660: 2073 7572 6520 7468 6520 7472 6166 6669   sure the traffi
-00025670: 6320 6973 206e 6f74 206d 6978 6564 0a20  c is not mixed. 
-00025680: 2020 2020 2020 2020 2020 2027 6375 726c             'curl
-00025690: 2068 7474 703a 2f2f 2465 6e64 706f 696e   http://$endpoin
-000256a0: 7420 7c20 6772 6570 2022 4869 2c20 6e65  t | grep "Hi, ne
-000256b0: 7720 536b 7950 696c 6f74 2068 6572 6522  w SkyPilot here"
-000256c0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-000256d0: 2054 6865 206c 6174 6573 7420 3220 7665   The latest 2 ve
-000256e0: 7273 696f 6e20 7368 6f75 6c64 2062 6520  rsion should be 
-000256f0: 5245 4144 5920 616e 6420 7468 6520 6f6c  READY and the ol
-00025700: 6465 7220 7665 7273 696f 6e73 2073 686f  der versions sho
-00025710: 756c 6420 6265 2073 6875 7474 696e 6720  uld be shutting 
-00025720: 646f 776e 0a20 2020 2020 2020 2020 2020  down.           
-00025730: 2028 5f63 6865 636b 5f72 6570 6c69 6361   (_check_replica
-00025740: 5f69 6e5f 7374 6174 7573 286e 616d 652c  _in_status(name,
-00025750: 205b 2832 2c20 4661 6c73 652c 2027 5245   [(2, False, 'RE
-00025760: 4144 5927 292c 0a20 2020 2020 2020 2020  ADY'),.         
-00025770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025790: 2020 2020 2832 2c20 4661 6c73 652c 2027      (2, False, '
-000257a0: 5348 5554 5449 4e47 5f44 4f57 4e27 295d  SHUTTING_DOWN')]
-000257b0: 2920 2b0a 2020 2020 2020 2020 2020 2020  ) +.            
-000257c0: 205f 6368 6563 6b5f 7365 7276 6963 655f   _check_service_
-000257d0: 7665 7273 696f 6e28 6e61 6d65 2c20 2232  version(name, "2
-000257e0: 2229 292c 0a20 2020 2020 2020 205d 2c0a  ")),.        ],.
-000257f0: 2020 2020 2020 2020 5f54 4541 5244 4f57          _TEARDOW
-00025800: 4e5f 5345 5256 4943 452e 666f 726d 6174  N_SERVICE.format
-00025810: 286e 616d 653d 6e61 6d65 292c 0a20 2020  (name=name),.   
-00025820: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
-00025830: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
-00025840: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00025850: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00025860: 6b2e 7365 7276 650a 6465 6620 7465 7374  k.serve.def test
-00025870: 5f73 6b79 7365 7276 655f 726f 6c6c 696e  _skyserve_rollin
-00025880: 675f 7570 6461 7465 2867 656e 6572 6963  g_update(generic
-00025890: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
-000258a0: 2020 2222 2254 6573 7420 736b 7973 6572    """Test skyser
-000258b0: 7665 2077 6974 6820 726f 6c6c 696e 6720  ve with rolling 
-000258c0: 7570 6461 7465 2222 220a 2020 2020 6e61  update""".    na
-000258d0: 6d65 203d 205f 6765 745f 7365 7276 6963  me = _get_servic
-000258e0: 655f 6e61 6d65 2829 0a20 2020 2073 696e  e_name().    sin
-000258f0: 676c 655f 6e65 775f 7265 706c 6963 6120  gle_new_replica 
-00025900: 3d20 5f63 6865 636b 5f72 6570 6c69 6361  = _check_replica
-00025910: 5f69 6e5f 7374 6174 7573 280a 2020 2020  _in_status(.    
-00025920: 2020 2020 6e61 6d65 2c20 5b28 322c 2046      name, [(2, F
-00025930: 616c 7365 2c20 2752 4541 4459 2729 2c20  alse, 'READY'), 
-00025940: 2831 2c20 4661 6c73 652c 205f 5345 5256  (1, False, _SERV
-00025950: 4943 455f 4c41 554e 4348 494e 475f 5354  ICE_LAUNCHING_ST
-00025960: 4154 5553 5f52 4547 4558 292c 0a20 2020  ATUS_REGEX),.   
-00025970: 2020 2020 2020 2020 2020 2020 2831 2c20              (1, 
-00025980: 4661 6c73 652c 2027 5348 5554 5449 4e47  False, 'SHUTTING
-00025990: 5f44 4f57 4e27 295d 290a 2020 2020 7465  _DOWN')]).    te
-000259a0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-000259b0: 2020 2066 2774 6573 742d 736b 7973 6572     f'test-skyser
-000259c0: 7665 2d72 6f6c 6c69 6e67 2d75 7064 6174  ve-rolling-updat
-000259d0: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
-000259e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000259f0: 7365 7276 6520 7570 202d 6e20 7b6e 616d  serve up -n {nam
-00025a00: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
-00025a10: 7269 635f 636c 6f75 647d 202d 7920 7465  ric_cloud} -y te
-00025a20: 7374 732f 736b 7973 6572 7665 2f75 7064  sts/skyserve/upd
-00025a30: 6174 652f 6f6c 642e 7961 6d6c 272c 0a20  ate/old.yaml',. 
-00025a40: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
-00025a50: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
-00025a60: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
-00025a70: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
-00025a80: 3d32 292c 0a20 2020 2020 2020 2020 2020  =2),.           
-00025a90: 2066 277b 5f53 4552 5645 5f45 4e44 504f   f'{_SERVE_ENDPO
-00025aa0: 494e 545f 5741 4954 2e66 6f72 6d61 7428  INT_WAIT.format(
-00025ab0: 6e61 6d65 3d6e 616d 6529 7d3b 2063 7572  name=name)}; cur
-00025ac0: 6c20 6874 7470 3a2f 2f24 656e 6470 6f69  l http://$endpoi
-00025ad0: 6e74 207c 2067 7265 7020 2248 692c 2053  nt | grep "Hi, S
-00025ae0: 6b79 5069 6c6f 7420 6865 7265 2227 2c0a  kyPilot here"',.
-00025af0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00025b00: 7920 7365 7276 6520 7570 6461 7465 207b  y serve update {
-00025b10: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
-00025b20: 656e 6572 6963 5f63 6c6f 7564 7d20 2d79  eneric_cloud} -y
-00025b30: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
-00025b40: 7570 6461 7465 2f6e 6577 2e79 616d 6c27  update/new.yaml'
-00025b50: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00025b60: 4d61 6b65 2073 7572 6520 7468 6520 7472  Make sure the tr
-00025b70: 6166 6669 6320 6973 206d 6978 6564 2061  affic is mixed a
-00025b80: 6372 6f73 7320 7477 6f20 7665 7273 696f  cross two versio
-00025b90: 6e73 2c20 7468 6520 7265 706c 6963 6173  ns, the replicas
-00025ba0: 0a20 2020 2020 2020 2020 2020 2023 2077  .            # w
-00025bb0: 6974 6820 6576 656e 2069 6420 7769 6c6c  ith even id will
-00025bc0: 2073 6c65 6570 2036 3020 7365 636f 6e64   sleep 60 second
-00025bd0: 7320 6265 666f 7265 2062 6569 6e67 2072  s before being r
-00025be0: 6561 6479 2c20 736f 2077 650a 2020 2020  eady, so we.    
-00025bf0: 2020 2020 2020 2020 2320 7368 6f75 6c64          # should
-00025c00: 2062 6520 6162 6c65 2074 6f20 6765 7420   be able to get 
-00025c10: 6f62 7365 7276 6520 7468 6520 7065 7269  observe the peri
-00025c20: 6f64 2074 6861 7420 7468 6520 7472 6166  od that the traf
-00025c30: 6669 6320 6973 206d 6978 6564 0a20 2020  fic is mixed.   
-00025c40: 2020 2020 2020 2020 2023 2061 6372 6f73           # acros
-00025c50: 7320 7477 6f20 7665 7273 696f 6e73 2e0a  s two versions..
-00025c60: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00025c70: 5345 5256 455f 454e 4450 4f49 4e54 5f57  SERVE_ENDPOINT_W
-00025c80: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
-00025c90: 6e61 6d65 297d 3b20 270a 2020 2020 2020  name)}; '.      
-00025ca0: 2020 2020 2020 2775 6e74 696c 2063 7572        'until cur
-00025cb0: 6c20 6874 7470 3a2f 2f24 656e 6470 6f69  l http://$endpoi
-00025cc0: 6e74 207c 2067 7265 7020 2248 692c 206e  nt | grep "Hi, n
-00025cd0: 6577 2053 6b79 5069 6c6f 7420 6865 7265  ew SkyPilot here
-00025ce0: 2122 3b20 646f 2073 6c65 6570 2032 3b20  !"; do sleep 2; 
-00025cf0: 646f 6e65 3b20 736c 6565 7020 323b 2027  done; sleep 2; '
-00025d00: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00025d10: 6865 206c 6174 6573 7420 7665 7273 696f  he latest versio
-00025d20: 6e20 7368 6f75 6c64 2068 6176 6520 6f6e  n should have on
-00025d30: 6520 5245 4144 5920 616e 6420 7468 6520  e READY and the 
-00025d40: 6f6e 6520 6f66 2074 6865 206f 6c64 6572  one of the older
-00025d50: 2076 6572 7369 6f6e 7320 7368 6f75 6c64   versions should
-00025d60: 2062 6520 7368 7574 7469 6e67 2064 6f77   be shutting dow
-00025d70: 6e0a 2020 2020 2020 2020 2020 2020 6627  n.            f'
-00025d80: 7b73 696e 676c 655f 6e65 775f 7265 706c  {single_new_repl
-00025d90: 6963 617d 207b 5f63 6865 636b 5f73 6572  ica} {_check_ser
-00025da0: 7669 6365 5f76 6572 7369 6f6e 286e 616d  vice_version(nam
-00025db0: 652c 2022 312c 3222 297d 2027 0a20 2020  e, "1,2")} '.   
-00025dc0: 2020 2020 2020 2020 2023 2043 6865 636b           # Check
-00025dd0: 2074 6865 206f 7574 7075 7420 6672 6f6d   the output from
-00025de0: 2074 6865 206f 6c64 2076 6572 7369 6f6e   the old version
-00025df0: 2c20 696d 6d65 6469 6174 656c 7920 6166  , immediately af
-00025e00: 7465 7220 7468 650a 2020 2020 2020 2020  ter the.        
-00025e10: 2020 2020 2320 6f75 7470 7574 2066 726f      # output fro
-00025e20: 6d20 7468 6520 6e65 7720 7665 7273 696f  m the new versio
-00025e30: 6e20 6170 7065 6172 732e 2054 6869 7320  n appears. This 
-00025e40: 6973 2067 7561 7261 6e74 6565 6420 6279  is guaranteed by
-00025e50: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
-00025e60: 2023 2072 6f75 6e64 2072 6f62 696e 206c   # round robin l
-00025e70: 6f61 6420 6261 6c61 6e63 696e 6720 706f  oad balancing po
-00025e80: 6c69 6379 2e0a 2020 2020 2020 2020 2020  licy..          
-00025e90: 2020 2320 544f 444f 287a 6877 7529 3a20    # TODO(zhwu): 
-00025ea0: 7765 2073 686f 756c 6420 6861 7665 2061  we should have a
-00025eb0: 206d 6f72 6520 6765 6e65 7261 6c69 7a65   more generalize
-00025ec0: 6420 7761 7920 666f 7220 6368 6563 6b69  d way for checki
-00025ed0: 6e67 2074 6865 0a20 2020 2020 2020 2020  ng the.         
-00025ee0: 2020 2023 206d 6978 6564 2076 6572 7369     # mixed versi
-00025ef0: 6f6e 206f 6620 7265 706c 6963 6173 2074  on of replicas t
-00025f00: 6f20 6176 6f69 6420 6465 7065 6e64 696e  o avoid dependin
-00025f10: 6720 6f6e 2074 6865 2073 7065 6369 6669  g on the specifi
-00025f20: 630a 2020 2020 2020 2020 2020 2020 2320  c.            # 
-00025f30: 726f 756e 6420 726f 6269 6e20 6c6f 6164  round robin load
-00025f40: 2062 616c 616e 6369 6e67 2070 6f6c 6963   balancing polic
-00025f50: 792e 0a20 2020 2020 2020 2020 2020 2027  y..            '
-00025f60: 6375 726c 2068 7474 703a 2f2f 2465 6e64  curl http://$end
-00025f70: 706f 696e 7420 7c20 6772 6570 2022 4869  point | grep "Hi
-00025f80: 2c20 536b 7950 696c 6f74 2068 6572 6522  , SkyPilot here"
-00025f90: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-00025fa0: 2020 2020 2020 5f54 4541 5244 4f57 4e5f        _TEARDOWN_
-00025fb0: 5345 5256 4943 452e 666f 726d 6174 286e  SERVICE.format(n
-00025fc0: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
-00025fd0: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
-00025fe0: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-00025ff0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00026000: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00026010: 7365 7276 650a 6465 6620 7465 7374 5f73  serve.def test_s
-00026020: 6b79 7365 7276 655f 6661 7374 5f75 7064  kyserve_fast_upd
-00026030: 6174 6528 6765 6e65 7269 635f 636c 6f75  ate(generic_clou
-00026040: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
-00026050: 5465 7374 2073 6b79 7365 7276 6520 7769  Test skyserve wi
-00026060: 7468 2066 6173 7420 7570 6461 7465 2028  th fast update (
-00026070: 496e 6372 656d 656e 7420 7665 7273 696f  Increment versio
-00026080: 6e20 6f66 206f 6c64 2072 6570 6c69 6361  n of old replica
-00026090: 7329 2222 220a 2020 2020 6e61 6d65 203d  s)""".    name =
-000260a0: 205f 6765 745f 7365 7276 6963 655f 6e61   _get_service_na
-000260b0: 6d65 2829 0a0a 2020 2020 7465 7374 203d  me()..    test =
-000260c0: 2054 6573 7428 0a20 2020 2020 2020 2066   Test(.        f
-000260d0: 2774 6573 742d 736b 7973 6572 7665 2d66  'test-skyserve-f
-000260e0: 6173 742d 7570 6461 7465 272c 0a20 2020  ast-update',.   
-000260f0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00026100: 2020 2066 2773 6b79 2073 6572 7665 2075     f'sky serve u
-00026110: 7020 2d6e 207b 6e61 6d65 7d20 2d79 202d  p -n {name} -y -
-00026120: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-00026130: 636c 6f75 647d 2074 6573 7473 2f73 6b79  cloud} tests/sky
-00026140: 7365 7276 652f 7570 6461 7465 2f62 756d  serve/update/bum
-00026150: 705f 7665 7273 696f 6e5f 6265 666f 7265  p_version_before
-00026160: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00026170: 2020 2020 5f53 4552 5645 5f57 4149 545f      _SERVE_WAIT_
-00026180: 554e 5449 4c5f 5245 4144 592e 666f 726d  UNTIL_READY.form
-00026190: 6174 286e 616d 653d 6e61 6d65 2c20 7265  at(name=name, re
-000261a0: 706c 6963 615f 6e75 6d3d 3229 2c0a 2020  plica_num=2),.  
-000261b0: 2020 2020 2020 2020 2020 6627 7b5f 5345            f'{_SE
-000261c0: 5256 455f 454e 4450 4f49 4e54 5f57 4149  RVE_ENDPOINT_WAI
-000261d0: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
-000261e0: 6d65 297d 3b20 6375 726c 2068 7474 703a  me)}; curl http:
-000261f0: 2f2f 2465 6e64 706f 696e 7420 7c20 6772  //$endpoint | gr
-00026200: 6570 2022 4869 2c20 536b 7950 696c 6f74  ep "Hi, SkyPilot
-00026210: 2068 6572 6522 272c 0a20 2020 2020 2020   here"',.       
-00026220: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
-00026230: 2075 7064 6174 6520 7b6e 616d 657d 202d   update {name} -
-00026240: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-00026250: 636c 6f75 647d 202d 2d6d 6f64 6520 626c  cloud} --mode bl
-00026260: 7565 5f67 7265 656e 202d 7920 7465 7374  ue_green -y test
-00026270: 732f 736b 7973 6572 7665 2f75 7064 6174  s/skyserve/updat
-00026280: 652f 6275 6d70 5f76 6572 7369 6f6e 5f61  e/bump_version_a
-00026290: 6674 6572 2e79 616d 6c27 2c0a 2020 2020  fter.yaml',.    
-000262a0: 2020 2020 2020 2020 2320 736c 6565 7020          # sleep 
-000262b0: 746f 2077 6169 7420 666f 7220 7570 6461  to wait for upda
-000262c0: 7465 2074 6f20 6265 2072 6567 6973 7465  te to be registe
-000262d0: 7265 642e 0a20 2020 2020 2020 2020 2020  red..           
-000262e0: 2027 736c 6565 7020 3330 272c 0a20 2020   'sleep 30',.   
-000262f0: 2020 2020 2020 2020 2023 2032 206f 6e2d           # 2 on-
-00026300: 6465 616d 6e64 2028 7265 6164 7929 202b  deamnd (ready) +
-00026310: 2031 206f 6e2d 6465 6d61 6e64 2028 7072   1 on-demand (pr
-00026320: 6f76 6973 696f 6e69 6e67 292e 0a20 2020  ovisioning)..   
-00026330: 2020 2020 2020 2020 2028 0a20 2020 2020           (.     
-00026340: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
-00026350: 6b5f 7265 706c 6963 615f 696e 5f73 7461  k_replica_in_sta
-00026360: 7475 7328 0a20 2020 2020 2020 2020 2020  tus(.           
-00026370: 2020 2020 2020 2020 206e 616d 652c 205b           name, [
-00026380: 2832 2c20 4661 6c73 652c 2027 5245 4144  (2, False, 'READ
-00026390: 5927 292c 0a20 2020 2020 2020 2020 2020  Y'),.           
-000263a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000263b0: 2831 2c20 4661 6c73 652c 205f 5345 5256  (1, False, _SERV
-000263c0: 4943 455f 4c41 554e 4348 494e 475f 5354  ICE_LAUNCHING_ST
-000263d0: 4154 5553 5f52 4547 4558 295d 2920 2b0a  ATUS_REGEX)]) +.
-000263e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000263f0: 2320 4661 7374 2075 7064 6174 6520 7769  # Fast update wi
-00026400: 6c6c 2064 6972 6563 746c 7920 6861 7665  ll directly have
-00026410: 2074 6865 206c 6174 6573 7420 7665 7273   the latest vers
-00026420: 696f 6e20 7265 6164 792e 0a20 2020 2020  ion ready..     
-00026430: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
-00026440: 6b5f 7365 7276 6963 655f 7665 7273 696f  k_service_versio
-00026450: 6e28 6e61 6d65 2c20 2232 2229 292c 0a20  n(name, "2")),. 
-00026460: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
-00026470: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
-00026480: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
-00026490: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
-000264a0: 3d33 2920 2b0a 2020 2020 2020 2020 2020  =3) +.          
-000264b0: 2020 5f63 6865 636b 5f73 6572 7669 6365    _check_service
-000264c0: 5f76 6572 7369 6f6e 286e 616d 652c 2022  _version(name, "
-000264d0: 3222 292c 0a20 2020 2020 2020 2020 2020  2"),.           
-000264e0: 2066 277b 5f53 4552 5645 5f45 4e44 504f   f'{_SERVE_ENDPO
-000264f0: 494e 545f 5741 4954 2e66 6f72 6d61 7428  INT_WAIT.format(
-00026500: 6e61 6d65 3d6e 616d 6529 7d3b 2063 7572  name=name)}; cur
-00026510: 6c20 6874 7470 3a2f 2f24 656e 6470 6f69  l http://$endpoi
-00026520: 6e74 207c 2067 7265 7020 2248 692c 2053  nt | grep "Hi, S
-00026530: 6b79 5069 6c6f 7420 6865 7265 2227 2c0a  kyPilot here"',.
-00026540: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
-00026550: 7374 2072 6f6c 6c69 6e67 2075 7064 6174  st rolling updat
-00026560: 650a 2020 2020 2020 2020 2020 2020 6627  e.            f'
-00026570: 736b 7920 7365 7276 6520 7570 6461 7465  sky serve update
-00026580: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-00026590: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
-000265a0: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
-000265b0: 652f 7570 6461 7465 2f62 756d 705f 7665  e/update/bump_ve
-000265c0: 7273 696f 6e5f 6265 666f 7265 2e79 616d  rsion_before.yam
-000265d0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-000265e0: 2320 736c 6565 7020 746f 2077 6169 7420  # sleep to wait 
-000265f0: 666f 7220 7570 6461 7465 2074 6f20 6265  for update to be
-00026600: 2072 6567 6973 7465 7265 642e 0a20 2020   registered..   
-00026610: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00026620: 3135 272c 0a20 2020 2020 2020 2020 2020  15',.           
-00026630: 2023 2032 206f 6e2d 6465 616d 6e64 2028   # 2 on-deamnd (
-00026640: 7265 6164 7929 202b 2031 206f 6e2d 6465  ready) + 1 on-de
-00026650: 6d61 6e64 2028 7368 7574 7469 6e67 2064  mand (shutting d
-00026660: 6f77 6e29 2e0a 2020 2020 2020 2020 2020  own)..          
-00026670: 2020 5f63 6865 636b 5f72 6570 6c69 6361    _check_replica
-00026680: 5f69 6e5f 7374 6174 7573 286e 616d 652c  _in_status(name,
-00026690: 205b 2832 2c20 4661 6c73 652c 2027 5245   [(2, False, 'RE
-000266a0: 4144 5927 292c 0a20 2020 2020 2020 2020  ADY'),.         
-000266b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000266c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000266d0: 2020 2028 312c 2046 616c 7365 2c20 2753     (1, False, 'S
-000266e0: 4855 5454 494e 475f 444f 574e 2729 5d29  HUTTING_DOWN')])
-000266f0: 2c0a 2020 2020 2020 2020 2020 2020 5f53  ,.            _S
-00026700: 4552 5645 5f57 4149 545f 554e 5449 4c5f  ERVE_WAIT_UNTIL_
-00026710: 5245 4144 592e 666f 726d 6174 286e 616d  READY.format(nam
-00026720: 653d 6e61 6d65 2c20 7265 706c 6963 615f  e=name, replica_
-00026730: 6e75 6d3d 3229 202b 0a20 2020 2020 2020  num=2) +.       
-00026740: 2020 2020 205f 6368 6563 6b5f 7365 7276       _check_serv
-00026750: 6963 655f 7665 7273 696f 6e28 6e61 6d65  ice_version(name
-00026760: 2c20 2233 2229 2c0a 2020 2020 2020 2020  , "3"),.        
-00026770: 2020 2020 6627 7b5f 5345 5256 455f 454e      f'{_SERVE_EN
-00026780: 4450 4f49 4e54 5f57 4149 542e 666f 726d  DPOINT_WAIT.form
-00026790: 6174 286e 616d 653d 6e61 6d65 297d 3b20  at(name=name)}; 
-000267a0: 6375 726c 2068 7474 703a 2f2f 2465 6e64  curl http://$end
-000267b0: 706f 696e 7420 7c20 6772 6570 2022 4869  point | grep "Hi
-000267c0: 2c20 536b 7950 696c 6f74 2068 6572 6522  , SkyPilot here"
-000267d0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-000267e0: 2020 2020 2020 5f54 4541 5244 4f57 4e5f        _TEARDOWN_
-000267f0: 5345 5256 4943 452e 666f 726d 6174 286e  SERVICE.format(n
-00026800: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
-00026810: 2020 2074 696d 656f 7574 3d33 3020 2a20     timeout=30 * 
-00026820: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-00026830: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00026840: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00026850: 7365 7276 650a 6465 6620 7465 7374 5f73  serve.def test_s
-00026860: 6b79 7365 7276 655f 7570 6461 7465 5f61  kyserve_update_a
-00026870: 7574 6f73 6361 6c65 2867 656e 6572 6963  utoscale(generic
-00026880: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
-00026890: 2020 2222 2254 6573 7420 736b 7973 6572    """Test skyser
-000268a0: 7665 2075 7064 6174 6520 7769 7468 2061  ve update with a
-000268b0: 7574 6f73 6361 6c65 2222 220a 2020 2020  utoscale""".    
-000268c0: 6e61 6d65 203d 205f 6765 745f 7365 7276  name = _get_serv
-000268d0: 6963 655f 6e61 6d65 2829 0a20 2020 2074  ice_name().    t
-000268e0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-000268f0: 2020 2020 6627 7465 7374 2d73 6b79 7365      f'test-skyse
-00026900: 7276 652d 7570 6461 7465 2d61 7574 6f73  rve-update-autos
-00026910: 6361 6c65 272c 0a20 2020 2020 2020 205b  cale',.        [
-00026920: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00026930: 6b79 2073 6572 7665 2075 7020 2d6e 207b  ky serve up -n {
-00026940: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
-00026950: 656e 6572 6963 5f63 6c6f 7564 7d20 2d79  eneric_cloud} -y
-00026960: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
-00026970: 7570 6461 7465 2f6e 756d 5f6d 696e 5f74  update/num_min_t
-00026980: 776f 2e79 616d 6c27 2c0a 2020 2020 2020  wo.yaml',.      
-00026990: 2020 2020 2020 5f53 4552 5645 5f57 4149        _SERVE_WAI
-000269a0: 545f 554e 5449 4c5f 5245 4144 592e 666f  T_UNTIL_READY.fo
-000269b0: 726d 6174 286e 616d 653d 6e61 6d65 2c20  rmat(name=name, 
-000269c0: 7265 706c 6963 615f 6e75 6d3d 3229 202b  replica_num=2) +
-000269d0: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
-000269e0: 6563 6b5f 7365 7276 6963 655f 7665 7273  eck_service_vers
-000269f0: 696f 6e28 6e61 6d65 2c20 2231 2229 2c0a  ion(name, "1"),.
-00026a00: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00026a10: 5345 5256 455f 454e 4450 4f49 4e54 5f57  SERVE_ENDPOINT_W
-00026a20: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
-00026a30: 6e61 6d65 297d 3b20 270a 2020 2020 2020  name)}; '.      
-00026a40: 2020 2020 2020 2763 7572 6c20 6874 7470        'curl http
-00026a50: 3a2f 2f24 656e 6470 6f69 6e74 207c 2067  ://$endpoint | g
-00026a60: 7265 7020 2248 692c 2053 6b79 5069 6c6f  rep "Hi, SkyPilo
-00026a70: 7420 6865 7265 2227 2c0a 2020 2020 2020  t here"',.      
-00026a80: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
-00026a90: 6520 7570 6461 7465 207b 6e61 6d65 7d20  e update {name} 
-00026aa0: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-00026ab0: 5f63 6c6f 7564 7d20 2d2d 6d6f 6465 2062  _cloud} --mode b
-00026ac0: 6c75 655f 6772 6565 6e20 2d79 2074 6573  lue_green -y tes
-00026ad0: 7473 2f73 6b79 7365 7276 652f 7570 6461  ts/skyserve/upda
-00026ae0: 7465 2f6e 756d 5f6d 696e 5f6f 6e65 2e79  te/num_min_one.y
-00026af0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00026b00: 2020 2320 736c 6565 7020 6265 666f 7265    # sleep before
-00026b10: 2075 7064 6174 6520 6973 2072 6567 6973   update is regis
-00026b20: 7465 7265 642e 0a20 2020 2020 2020 2020  tered..         
-00026b30: 2020 2027 736c 6565 7020 3230 272c 0a20     'sleep 20',. 
-00026b40: 2020 2020 2020 2020 2020 2023 2054 696d             # Tim
-00026b50: 656f 7574 2077 696c 6c20 6265 2074 7269  eout will be tri
-00026b60: 6767 6572 6564 2077 6865 6e20 7570 6461  ggered when upda
-00026b70: 7465 2066 6169 6c73 2e0a 2020 2020 2020  te fails..      
-00026b80: 2020 2020 2020 5f53 4552 5645 5f57 4149        _SERVE_WAI
-00026b90: 545f 554e 5449 4c5f 5245 4144 592e 666f  T_UNTIL_READY.fo
-00026ba0: 726d 6174 286e 616d 653d 6e61 6d65 2c20  rmat(name=name, 
-00026bb0: 7265 706c 6963 615f 6e75 6d3d 3129 202b  replica_num=1) +
-00026bc0: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
-00026bd0: 6563 6b5f 7365 7276 6963 655f 7665 7273  eck_service_vers
-00026be0: 696f 6e28 6e61 6d65 2c20 2232 2229 2c0a  ion(name, "2"),.
-00026bf0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00026c00: 5345 5256 455f 454e 4450 4f49 4e54 5f57  SERVE_ENDPOINT_W
-00026c10: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
-00026c20: 6e61 6d65 297d 3b20 270a 2020 2020 2020  name)}; '.      
-00026c30: 2020 2020 2020 2763 7572 6c20 6874 7470        'curl http
-00026c40: 3a2f 2f24 656e 6470 6f69 6e74 207c 2067  ://$endpoint | g
-00026c50: 7265 7020 2248 692c 2053 6b79 5069 6c6f  rep "Hi, SkyPilo
-00026c60: 7420 6865 7265 2122 272c 0a20 2020 2020  t here!"',.     
-00026c70: 2020 2020 2020 2023 2052 6f6c 6c69 6e67         # Rolling
-00026c80: 2055 7064 6174 650a 2020 2020 2020 2020   Update.        
-00026c90: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
-00026ca0: 7570 6461 7465 207b 6e61 6d65 7d20 2d2d  update {name} --
-00026cb0: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-00026cc0: 6c6f 7564 7d20 2d79 2074 6573 7473 2f73  loud} -y tests/s
-00026cd0: 6b79 7365 7276 652f 7570 6461 7465 2f6e  kyserve/update/n
-00026ce0: 756d 5f6d 696e 5f74 776f 2e79 616d 6c27  um_min_two.yaml'
-00026cf0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00026d00: 736c 6565 7020 6265 666f 7265 2075 7064  sleep before upd
-00026d10: 6174 6520 6973 2072 6567 6973 7465 7265  ate is registere
-00026d20: 642e 0a20 2020 2020 2020 2020 2020 2027  d..            '
-00026d30: 736c 6565 7020 3230 272c 0a20 2020 2020  sleep 20',.     
-00026d40: 2020 2020 2020 2023 2054 696d 656f 7574         # Timeout
-00026d50: 2077 696c 6c20 6265 2074 7269 6767 6572   will be trigger
-00026d60: 6564 2077 6865 6e20 7570 6461 7465 2066  ed when update f
-00026d70: 6169 6c73 2e0a 2020 2020 2020 2020 2020  ails..          
-00026d80: 2020 5f53 4552 5645 5f57 4149 545f 554e    _SERVE_WAIT_UN
-00026d90: 5449 4c5f 5245 4144 592e 666f 726d 6174  TIL_READY.format
-00026da0: 286e 616d 653d 6e61 6d65 2c20 7265 706c  (name=name, repl
-00026db0: 6963 615f 6e75 6d3d 3229 202b 0a20 2020  ica_num=2) +.   
-00026dc0: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
-00026dd0: 7365 7276 6963 655f 7665 7273 696f 6e28  service_version(
-00026de0: 6e61 6d65 2c20 2233 2229 2c0a 2020 2020  name, "3"),.    
-00026df0: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
-00026e00: 455f 454e 4450 4f49 4e54 5f57 4149 542e  E_ENDPOINT_WAIT.
-00026e10: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-00026e20: 297d 3b20 270a 2020 2020 2020 2020 2020  )}; '.          
-00026e30: 2020 2763 7572 6c20 6874 7470 3a2f 2f24    'curl http://$
-00026e40: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
-00026e50: 2248 692c 2053 6b79 5069 6c6f 7420 6865  "Hi, SkyPilot he
-00026e60: 7265 2122 272c 0a20 2020 2020 2020 205d  re!"',.        ]
-00026e70: 2c0a 2020 2020 2020 2020 5f54 4541 5244  ,.        _TEARD
-00026e80: 4f57 4e5f 5345 5256 4943 452e 666f 726d  OWN_SERVICE.form
-00026e90: 6174 286e 616d 653d 6e61 6d65 292c 0a20  at(name=name),. 
-00026ea0: 2020 2020 2020 2074 696d 656f 7574 3d33         timeout=3
-00026eb0: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
-00026ec0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00026ed0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-00026ee0: 6172 6b2e 7365 7276 650a 4070 7974 6573  ark.serve.@pytes
-00026ef0: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
-00026f00: 6574 6573 2020 2320 5370 6f74 2069 6e73  etes  # Spot ins
-00026f10: 7461 6e63 6573 2061 7265 206e 6f74 2073  tances are not s
-00026f20: 7570 706f 7274 6564 2069 6e20 4b75 6265  upported in Kube
-00026f30: 726e 6574 6573 0a40 7079 7465 7374 2e6d  rnetes.@pytest.m
-00026f40: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
-00026f50: 276d 6f64 6527 2c20 5b27 726f 6c6c 696e  'mode', ['rollin
-00026f60: 6727 2c20 2762 6c75 655f 6772 6565 6e27  g', 'blue_green'
-00026f70: 5d29 0a64 6566 2074 6573 745f 736b 7973  ]).def test_skys
-00026f80: 6572 7665 5f6e 6577 5f61 7574 6f73 6361  erve_new_autosca
-00026f90: 6c65 725f 7570 6461 7465 286d 6f64 653a  ler_update(mode:
-00026fa0: 2073 7472 2c20 6765 6e65 7269 635f 636c   str, generic_cl
-00026fb0: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
-00026fc0: 2222 5465 7374 2073 6b79 7365 7276 6520  ""Test skyserve 
-00026fd0: 7769 7468 2075 7064 6174 6520 7468 6174  with update that
-00026fe0: 2063 6861 6e67 6573 2061 7574 6f73 6361   changes autosca
-00026ff0: 6c65 7222 2222 0a20 2020 206e 616d 6520  ler""".    name 
-00027000: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
-00027010: 616d 6528 2920 2b20 6d6f 6465 0a0a 2020  ame() + mode..  
-00027020: 2020 666f 7572 5f73 706f 745f 7570 5f63    four_spot_up_c
-00027030: 6d64 203d 205f 6368 6563 6b5f 7265 706c  md = _check_repl
-00027040: 6963 615f 696e 5f73 7461 7475 7328 6e61  ica_in_status(na
-00027050: 6d65 2c20 5b28 342c 2054 7275 652c 2027  me, [(4, True, '
-00027060: 5245 4144 5927 295d 290a 2020 2020 7570  READY')]).    up
-00027070: 6461 7465 5f63 6865 636b 203d 205b 6627  date_check = [f'
-00027080: 756e 7469 6c20 287b 666f 7572 5f73 706f  until ({four_spo
-00027090: 745f 7570 5f63 6d64 7d29 3b20 646f 2073  t_up_cmd}); do s
-000270a0: 6c65 6570 2035 3b20 646f 6e65 3b20 736c  leep 5; done; sl
-000270b0: 6565 7020 3130 3b27 5d0a 2020 2020 6966  eep 10;'].    if
-000270c0: 206d 6f64 6520 3d3d 2027 726f 6c6c 696e   mode == 'rollin
-000270d0: 6727 3a0a 2020 2020 2020 2020 2320 4368  g':.        # Ch
-000270e0: 6563 6b20 726f 6c6c 696e 6720 7570 6461  eck rolling upda
-000270f0: 7465 2c20 6974 2077 696c 6c20 7465 726d  te, it will term
-00027100: 696e 6174 6520 6f6e 6520 6f66 2074 6865  inate one of the
-00027110: 206f 6c64 206f 6e2d 6465 6d61 6e64 0a20   old on-demand. 
-00027120: 2020 2020 2020 2023 2069 6e73 7461 6e63         # instanc
-00027130: 6573 2c20 6f6e 6365 2074 6865 7265 2061  es, once there a
-00027140: 7265 2034 2073 706f 7420 696e 7374 616e  re 4 spot instan
-00027150: 6365 2072 6561 6479 2e0a 2020 2020 2020  ce ready..      
-00027160: 2020 7570 6461 7465 5f63 6865 636b 202b    update_check +
-00027170: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-00027180: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
-00027190: 6e5f 7374 6174 7573 280a 2020 2020 2020  n_status(.      
-000271a0: 2020 2020 2020 2020 2020 6e61 6d65 2c20            name, 
-000271b0: 5b28 312c 2046 616c 7365 2c20 5f53 4552  [(1, False, _SER
-000271c0: 5649 4345 5f4c 4155 4e43 4849 4e47 5f53  VICE_LAUNCHING_S
-000271d0: 5441 5455 535f 5245 4745 5829 2c0a 2020  TATUS_REGEX),.  
-000271e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000271f0: 2020 2020 2028 312c 2046 616c 7365 2c20       (1, False, 
-00027200: 2753 4855 5454 494e 475f 444f 574e 2729  'SHUTTING_DOWN')
-00027210: 2c20 2831 2c20 4661 6c73 652c 2027 5245  , (1, False, 'RE
-00027220: 4144 5927 295d 2920 2b0a 2020 2020 2020  ADY')]) +.      
-00027230: 2020 2020 2020 5f63 6865 636b 5f73 6572        _check_ser
-00027240: 7669 6365 5f76 6572 7369 6f6e 286e 616d  vice_version(nam
-00027250: 652c 2022 312c 3222 292c 0a20 2020 2020  e, "1,2"),.     
-00027260: 2020 205d 0a20 2020 2065 6c73 653a 0a20     ].    else:. 
-00027270: 2020 2020 2020 2023 2043 6865 636b 2062         # Check b
-00027280: 6c75 6520 6772 6565 6e20 7570 6461 7465  lue green update
-00027290: 2c20 6974 2077 696c 6c20 6b65 6570 2062  , it will keep b
-000272a0: 6f74 6820 6f6c 6420 6f6e 2d64 656d 616e  oth old on-deman
-000272b0: 6420 696e 7374 616e 6365 730a 2020 2020  d instances.    
-000272c0: 2020 2020 2320 7275 6e6e 696e 672c 206f      # running, o
-000272d0: 6e63 6520 7468 6572 6520 6172 6520 3420  nce there are 4 
-000272e0: 7370 6f74 2069 6e73 7461 6e63 6520 7265  spot instance re
-000272f0: 6164 792e 0a20 2020 2020 2020 2075 7064  ady..        upd
-00027300: 6174 655f 6368 6563 6b20 2b3d 205b 0a20  ate_check += [. 
-00027310: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
-00027320: 6b5f 7265 706c 6963 615f 696e 5f73 7461  k_replica_in_sta
-00027330: 7475 7328 0a20 2020 2020 2020 2020 2020  tus(.           
-00027340: 2020 2020 206e 616d 652c 205b 2831 2c20       name, [(1, 
-00027350: 4661 6c73 652c 205f 5345 5256 4943 455f  False, _SERVICE_
-00027360: 4c41 554e 4348 494e 475f 5354 4154 5553  LAUNCHING_STATUS
-00027370: 5f52 4547 4558 292c 0a20 2020 2020 2020  _REGEX),.       
-00027380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027390: 2832 2c20 4661 6c73 652c 2027 5245 4144  (2, False, 'READ
-000273a0: 5927 295d 2920 2b0a 2020 2020 2020 2020  Y')]) +.        
-000273b0: 2020 2020 5f63 6865 636b 5f73 6572 7669      _check_servi
-000273c0: 6365 5f76 6572 7369 6f6e 286e 616d 652c  ce_version(name,
-000273d0: 2022 3122 292c 0a20 2020 2020 2020 205d   "1"),.        ]
-000273e0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-000273f0: 280a 2020 2020 2020 2020 2774 6573 742d  (.        'test-
-00027400: 736b 7973 6572 7665 2d6e 6577 2d61 7574  skyserve-new-aut
-00027410: 6f73 6361 6c65 722d 7570 6461 7465 272c  oscaler-update',
-00027420: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-00027430: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
-00027440: 7665 2075 7020 2d6e 207b 6e61 6d65 7d20  ve up -n {name} 
-00027450: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-00027460: 5f63 6c6f 7564 7d20 2d79 2074 6573 7473  _cloud} -y tests
-00027470: 2f73 6b79 7365 7276 652f 7570 6461 7465  /skyserve/update
-00027480: 2f6e 6577 5f61 7574 6f73 6361 6c65 725f  /new_autoscaler_
-00027490: 6265 666f 7265 2e79 616d 6c27 2c0a 2020  before.yaml',.  
-000274a0: 2020 2020 2020 2020 2020 5f53 4552 5645            _SERVE
-000274b0: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
-000274c0: 592e 666f 726d 6174 286e 616d 653d 6e61  Y.format(name=na
-000274d0: 6d65 2c20 7265 706c 6963 615f 6e75 6d3d  me, replica_num=
-000274e0: 3229 202b 0a20 2020 2020 2020 2020 2020  2) +.           
-000274f0: 205f 6368 6563 6b5f 7365 7276 6963 655f   _check_service_
-00027500: 7665 7273 696f 6e28 6e61 6d65 2c20 2231  version(name, "1
-00027510: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-00027520: 6627 7b5f 5345 5256 455f 454e 4450 4f49  f'{_SERVE_ENDPOI
-00027530: 4e54 5f57 4149 542e 666f 726d 6174 286e  NT_WAIT.format(n
-00027540: 616d 653d 6e61 6d65 297d 3b20 270a 2020  ame=name)}; '.  
-00027550: 2020 2020 2020 2020 2020 2773 3d24 2863            's=$(c
-00027560: 7572 6c20 6874 7470 3a2f 2f24 656e 6470  url http://$endp
-00027570: 6f69 6e74 293b 2065 6368 6f20 2224 7322  oint); echo "$s"
-00027580: 3b20 6563 686f 2022 2473 2220 7c20 6772  ; echo "$s" | gr
-00027590: 6570 2022 4869 2c20 536b 7950 696c 6f74  ep "Hi, SkyPilot
-000275a0: 2068 6572 6522 272c 0a20 2020 2020 2020   here"',.       
-000275b0: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
-000275c0: 2075 7064 6174 6520 7b6e 616d 657d 202d   update {name} -
-000275d0: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-000275e0: 636c 6f75 647d 202d 2d6d 6f64 6520 7b6d  cloud} --mode {m
-000275f0: 6f64 657d 202d 7920 7465 7374 732f 736b  ode} -y tests/sk
-00027600: 7973 6572 7665 2f75 7064 6174 652f 6e65  yserve/update/ne
-00027610: 775f 6175 746f 7363 616c 6572 5f61 6674  w_autoscaler_aft
-00027620: 6572 2e79 616d 6c27 2c0a 2020 2020 2020  er.yaml',.      
-00027630: 2020 2020 2020 2320 5761 6974 2066 6f72        # Wait for
-00027640: 2075 7064 6174 6520 746f 2062 6520 7265   update to be re
-00027650: 6769 7374 6572 6564 0a20 2020 2020 2020  gistered.       
-00027660: 2020 2020 2066 2773 6c65 6570 2031 3230       f'sleep 120
-00027670: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
-00027680: 6368 6563 6b5f 7265 706c 6963 615f 696e  check_replica_in
-00027690: 5f73 7461 7475 7328 0a20 2020 2020 2020  _status(.       
-000276a0: 2020 2020 2020 2020 206e 616d 652c 205b           name, [
-000276b0: 2834 2c20 5472 7565 2c20 5f53 4552 5649  (4, True, _SERVI
-000276c0: 4345 5f4c 4155 4e43 4849 4e47 5f53 5441  CE_LAUNCHING_STA
-000276d0: 5455 535f 5245 4745 5820 2b20 275c 7c52  TUS_REGEX + '\|R
-000276e0: 4541 4459 2729 2c0a 2020 2020 2020 2020  EADY'),.        
-000276f0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00027700: 312c 2046 616c 7365 2c20 5f53 4552 5649  1, False, _SERVI
-00027710: 4345 5f4c 4155 4e43 4849 4e47 5f53 5441  CE_LAUNCHING_STA
-00027720: 5455 535f 5245 4745 5829 2c0a 2020 2020  TUS_REGEX),.    
-00027730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027740: 2020 2028 322c 2046 616c 7365 2c20 2752     (2, False, 'R
-00027750: 4541 4459 2729 5d29 2c0a 2020 2020 2020  EADY')]),.      
-00027760: 2020 2020 2020 2a75 7064 6174 655f 6368        *update_ch
-00027770: 6563 6b2c 0a20 2020 2020 2020 2020 2020  eck,.           
-00027780: 205f 5345 5256 455f 5741 4954 5f55 4e54   _SERVE_WAIT_UNT
-00027790: 494c 5f52 4541 4459 2e66 6f72 6d61 7428  IL_READY.format(
-000277a0: 6e61 6d65 3d6e 616d 652c 2072 6570 6c69  name=name, repli
-000277b0: 6361 5f6e 756d 3d35 292c 0a20 2020 2020  ca_num=5),.     
-000277c0: 2020 2020 2020 2066 277b 5f53 4552 5645         f'{_SERVE
-000277d0: 5f45 4e44 504f 494e 545f 5741 4954 2e66  _ENDPOINT_WAIT.f
-000277e0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
-000277f0: 7d3b 2027 0a20 2020 2020 2020 2020 2020  }; '.           
-00027800: 2027 6375 726c 2068 7474 703a 2f2f 2465   'curl http://$e
-00027810: 6e64 706f 696e 7420 7c20 6772 6570 2022  ndpoint | grep "
-00027820: 4869 2c20 536b 7950 696c 6f74 2068 6572  Hi, SkyPilot her
-00027830: 6522 272c 0a20 2020 2020 2020 2020 2020  e"',.           
-00027840: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
-00027850: 696e 5f73 7461 7475 7328 6e61 6d65 2c20  in_status(name, 
-00027860: 5b28 342c 2054 7275 652c 2027 5245 4144  [(4, True, 'READ
-00027870: 5927 292c 0a20 2020 2020 2020 2020 2020  Y'),.           
+00017cd0: 7c20 6772 6570 2022 4341 4e43 454c 4c49  | grep "CANCELLI
+00017ce0: 4e47 5c7c 4341 4e43 454c 4c45 4422 272c  NG\|CANCELLED"',
+00017cf0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00017d00: 5f4a 4f42 5f51 5545 5545 5f57 4149 547d  _JOB_QUEUE_WAIT}
+00017d10: 7c20 6772 6570 202d 4120 3420 7b6e 616d  | grep -A 4 {nam
+00017d20: 657d 7c20 7365 6420 2d6e 2033 7020 7c20  e}| sed -n 3p | 
+00017d30: 6772 6570 2022 4341 4e43 454c 4c49 4e47  grep "CANCELLING
+00017d40: 5c7c 4341 4e43 454c 4c45 4422 272c 0a20  \|CANCELLED"',. 
+00017d50: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
+00017d60: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
+00017d70: 6772 6570 202d 4120 3420 7b6e 616d 657d  grep -A 4 {name}
+00017d80: 7c20 7365 6420 2d6e 2034 7020 7c20 6772  | sed -n 4p | gr
+00017d90: 6570 2022 4341 4e43 454c 4c49 4e47 5c7c  ep "CANCELLING\|
+00017da0: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
+00017db0: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
+00017dc0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+00017dd0: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
+00017de0: 7365 6420 2d6e 2035 7020 7c20 6772 6570  sed -n 5p | grep
+00017df0: 2022 4341 4e43 454c 4c49 4e47 5c7c 4341   "CANCELLING\|CA
+00017e00: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
+00017e10: 2020 2020 2020 2027 736c 6565 7020 3230         'sleep 20
+00017e20: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00017e30: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
+00017e40: 4954 7d7c 2067 7265 7020 2d41 2034 207b  IT}| grep -A 4 {
+00017e50: 6e61 6d65 7d7c 2073 6564 202d 6e20 3270  name}| sed -n 2p
+00017e60: 207c 2067 7265 7020 2243 414e 4345 4c4c   | grep "CANCELL
+00017e70: 4544 2227 2c0a 2020 2020 2020 2020 2020  ED"',.          
+00017e80: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
+00017e90: 5741 4954 7d7c 2067 7265 7020 2d41 2034  WAIT}| grep -A 4
+00017ea0: 207b 6e61 6d65 7d7c 2073 6564 202d 6e20   {name}| sed -n 
+00017eb0: 3370 207c 2067 7265 7020 2243 414e 4345  3p | grep "CANCE
+00017ec0: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
+00017ed0: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+00017ee0: 455f 5741 4954 7d7c 2067 7265 7020 2d41  E_WAIT}| grep -A
+00017ef0: 2034 207b 6e61 6d65 7d7c 2073 6564 202d   4 {name}| sed -
+00017f00: 6e20 3470 207c 2067 7265 7020 2243 414e  n 4p | grep "CAN
+00017f10: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
+00017f20: 2020 2020 2020 6627 7b5f 4a4f 425f 5155        f'{_JOB_QU
+00017f30: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+00017f40: 2d41 2034 207b 6e61 6d65 7d7c 2073 6564  -A 4 {name}| sed
+00017f50: 202d 6e20 3570 207c 2067 7265 7020 2243   -n 5p | grep "C
+00017f60: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
+00017f70: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
+00017f80: 4a4f 425f 4341 4e43 454c 5f57 4149 542e  JOB_CANCEL_WAIT.
+00017f90: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
+00017fa0: 6627 7b6e 616d 657d 2729 2c0a 2020 2020  f'{name}'),.    
+00017fb0: 2020 2020 2320 496e 6372 6561 7365 2074      # Increase t
+00017fc0: 696d 656f 7574 2073 696e 6365 2073 6b79  imeout since sky
+00017fd0: 206a 6f62 7320 7175 6575 6520 2d72 2063   jobs queue -r c
+00017fe0: 616e 2062 6520 626c 6f63 6b65 6420 6279  an be blocked by
+00017ff0: 206f 7468 6572 2073 706f 7420 7465 7374   other spot test
+00018000: 732e 0a20 2020 2020 2020 2074 696d 656f  s..        timeo
+00018010: 7574 3d33 3020 2a20 3630 2c0a 2020 2020  ut=30 * 60,.    
+00018020: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00018030: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+00018040: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
+00018050: 7374 6163 6b20 2023 666c 7569 6473 7461  stack  #fluidsta
+00018060: 636b 2064 6f65 7320 6e6f 7420 7375 7070  ck does not supp
+00018070: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
+00018080: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
+00018090: 6e6f 5f61 7a75 7265 2020 2320 417a 7572  no_azure  # Azur
+000180a0: 6520 646f 6573 206e 6f74 2073 7570 706f  e does not suppo
+000180b0: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
+000180c0: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
+000180d0: 6f5f 6c61 6d62 6461 5f63 6c6f 7564 2020  o_lambda_cloud  
+000180e0: 2320 4c61 6d62 6461 2043 6c6f 7564 2064  # Lambda Cloud d
+000180f0: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+00018100: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
+00018110: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f69  pytest.mark.no_i
+00018120: 626d 2020 2320 4942 4d20 436c 6f75 6420  bm  # IBM Cloud 
+00018130: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+00018140: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
+00018150: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00018160: 7363 7020 2023 2053 4350 2064 6f65 7320  scp  # SCP does 
+00018170: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+00018180: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+00018190: 7374 2e6d 6172 6b2e 6e6f 5f70 6170 6572  st.mark.no_paper
+000181a0: 7370 6163 6520 2023 2050 6170 6572 7370  space  # Papersp
+000181b0: 6163 6520 646f 6573 206e 6f74 2073 7570  ace does not sup
+000181c0: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
+000181d0: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+000181e0: 2e6e 6f5f 6b75 6265 726e 6574 6573 2020  .no_kubernetes  
+000181f0: 2320 4b75 6265 726e 6574 6573 2064 6f65  # Kubernetes doe
+00018200: 7320 6e6f 7420 6861 7665 2061 206e 6f74  s not have a not
+00018210: 696f 6e20 6f66 2073 706f 7420 696e 7374  ion of spot inst
+00018220: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+00018230: 726b 2e6d 616e 6167 6564 5f6a 6f62 730a  rk.managed_jobs.
+00018240: 6465 6620 7465 7374 5f6d 616e 6167 6564  def test_managed
+00018250: 5f6a 6f62 735f 6661 696c 6564 5f73 6574  _jobs_failed_set
+00018260: 7570 2867 656e 6572 6963 5f63 6c6f 7564  up(generic_cloud
+00018270: 3a20 7374 7229 3a0a 2020 2020 2222 2254  : str):.    """T
+00018280: 6573 7420 6d61 6e61 6765 6420 6a6f 6220  est managed job 
+00018290: 7769 7468 2066 6169 6c65 6420 7365 7475  with failed setu
+000182a0: 702e 2222 220a 2020 2020 6e61 6d65 203d  p.""".    name =
+000182b0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+000182c0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+000182d0: 5465 7374 280a 2020 2020 2020 2020 276d  Test(.        'm
+000182e0: 616e 6167 6564 5f6a 6f62 735f 6661 696c  anaged_jobs_fail
+000182f0: 6564 5f73 6574 7570 272c 0a20 2020 2020  ed_setup',.     
+00018300: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00018310: 2066 2773 6b79 206a 6f62 7320 6c61 756e   f'sky jobs laun
+00018320: 6368 202d 6e20 7b6e 616d 657d 202d 2d63  ch -n {name} --c
+00018330: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+00018340: 6f75 647d 202d 7920 2d64 2074 6573 7473  oud} -y -d tests
+00018350: 2f74 6573 745f 7961 6d6c 732f 6661 696c  /test_yamls/fail
+00018360: 6564 5f73 6574 7570 2e79 616d 6c27 2c0a  ed_setup.yaml',.
+00018370: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00018380: 6570 2033 3330 272c 0a20 2020 2020 2020  ep 330',.       
+00018390: 2020 2020 2023 204d 616b 6520 7375 7265       # Make sure
+000183a0: 2074 6865 206a 6f62 2066 6169 6c65 6420   the job failed 
+000183b0: 7175 6963 6b6c 792e 0a20 2020 2020 2020  quickly..       
+000183c0: 2020 2020 2066 277b 5f4a 4f42 5f51 5545       f'{_JOB_QUE
+000183d0: 5545 5f57 4149 547d 207c 2067 7265 7020  UE_WAIT} | grep 
+000183e0: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+000183f0: 3120 7c20 6772 6570 2022 4641 494c 4544  1 | grep "FAILED
+00018400: 5f53 4554 5550 2227 2c0a 2020 2020 2020  _SETUP"',.      
+00018410: 2020 5d2c 0a20 2020 2020 2020 205f 4a4f    ],.        _JO
+00018420: 425f 4341 4e43 454c 5f57 4149 542e 666f  B_CANCEL_WAIT.fo
+00018430: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
+00018440: 6d65 292c 0a20 2020 2020 2020 2023 2049  me),.        # I
+00018450: 6e63 7265 6173 6520 7469 6d65 6f75 7420  ncrease timeout 
+00018460: 7369 6e63 6520 736b 7920 6a6f 6273 2071  since sky jobs q
+00018470: 7565 7565 202d 7220 6361 6e20 6265 2062  ueue -r can be b
+00018480: 6c6f 636b 6564 2062 7920 6f74 6865 7220  locked by other 
+00018490: 7370 6f74 2074 6573 7473 2e0a 2020 2020  spot tests..    
+000184a0: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
+000184b0: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+000184c0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+000184d0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+000184e0: 2e6e 6f5f 666c 7569 6473 7461 636b 2020  .no_fluidstack  
+000184f0: 2366 6c75 6964 7374 6163 6b20 646f 6573  #fluidstack does
+00018500: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
+00018510: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
+00018520: 6573 742e 6d61 726b 2e6e 6f5f 617a 7572  est.mark.no_azur
+00018530: 6520 2023 2041 7a75 7265 2064 6f65 7320  e  # Azure does 
+00018540: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+00018550: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+00018560: 7374 2e6d 6172 6b2e 6e6f 5f6c 616d 6264  st.mark.no_lambd
+00018570: 615f 636c 6f75 6420 2023 204c 616d 6264  a_cloud  # Lambd
+00018580: 6120 436c 6f75 6420 646f 6573 206e 6f74  a Cloud does not
+00018590: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
+000185a0: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
+000185b0: 6d61 726b 2e6e 6f5f 6962 6d20 2023 2049  mark.no_ibm  # I
+000185c0: 424d 2043 6c6f 7564 2064 6f65 7320 6e6f  BM Cloud does no
+000185d0: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
+000185e0: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
+000185f0: 2e6d 6172 6b2e 6e6f 5f73 6370 2020 2320  .mark.no_scp  # 
+00018600: 5343 5020 646f 6573 206e 6f74 2073 7570  SCP does not sup
+00018610: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
+00018620: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+00018630: 2e6e 6f5f 7061 7065 7273 7061 6365 2020  .no_paperspace  
+00018640: 2320 5061 7065 7273 7061 6365 2064 6f65  # Paperspace doe
+00018650: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
+00018660: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
+00018670: 7465 7374 2e6d 6172 6b2e 6e6f 5f6b 7562  test.mark.no_kub
+00018680: 6572 6e65 7465 7320 2023 204b 7562 6572  ernetes  # Kuber
+00018690: 6e65 7465 7320 646f 6573 206e 6f74 2068  netes does not h
+000186a0: 6176 6520 6120 6e6f 7469 6f6e 206f 6620  ave a notion of 
+000186b0: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
+000186c0: 7079 7465 7374 2e6d 6172 6b2e 6d61 6e61  pytest.mark.mana
+000186d0: 6765 645f 6a6f 6273 0a64 6566 2074 6573  ged_jobs.def tes
+000186e0: 745f 6d61 6e61 6765 645f 6a6f 6273 5f70  t_managed_jobs_p
+000186f0: 6970 656c 696e 655f 6661 696c 6564 5f73  ipeline_failed_s
+00018700: 6574 7570 2867 656e 6572 6963 5f63 6c6f  etup(generic_clo
+00018710: 7564 3a20 7374 7229 3a0a 2020 2020 2222  ud: str):.    ""
+00018720: 2254 6573 7420 6d61 6e61 6765 6420 6a6f  "Test managed jo
+00018730: 6220 7769 7468 2066 6169 6c65 6420 7365  b with failed se
+00018740: 7475 7020 666f 7220 6120 7069 7065 6c69  tup for a pipeli
+00018750: 6e65 2e22 2222 0a20 2020 206e 616d 6520  ne.""".    name 
+00018760: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00018770: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+00018780: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+00018790: 6d61 6e61 6765 645f 6a6f 6273 5f70 6970  managed_jobs_pip
+000187a0: 656c 696e 655f 6661 696c 6564 5f73 6574  eline_failed_set
+000187b0: 7570 272c 0a20 2020 2020 2020 205b 0a20  up',.        [. 
+000187c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000187d0: 206a 6f62 7320 6c61 756e 6368 202d 6e20   jobs launch -n 
+000187e0: 7b6e 616d 657d 202d 7920 2d64 2074 6573  {name} -y -d tes
+000187f0: 7473 2f74 6573 745f 7961 6d6c 732f 6661  ts/test_yamls/fa
+00018800: 696c 6564 5f73 6574 7570 5f70 6970 656c  iled_setup_pipel
+00018810: 696e 652e 7961 6d6c 272c 0a20 2020 2020  ine.yaml',.     
+00018820: 2020 2020 2020 2027 736c 6565 7020 3630         'sleep 60
+00018830: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00018840: 2320 4d61 6b65 2073 7572 6520 7468 6520  # Make sure the 
+00018850: 6a6f 6220 6661 696c 6564 2071 7569 636b  job failed quick
+00018860: 6c79 2e0a 2020 2020 2020 2020 2020 2020  ly..            
+00018870: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
+00018880: 4954 7d20 7c20 6772 6570 207b 6e61 6d65  IT} | grep {name
+00018890: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
+000188a0: 7265 7020 2246 4149 4c45 445f 5345 5455  rep "FAILED_SETU
+000188b0: 5022 272c 0a20 2020 2020 2020 2020 2020  P"',.           
+000188c0: 2023 2054 6173 6b20 3020 7368 6f75 6c64   # Task 0 should
+000188d0: 2062 6520 5355 4343 4545 4445 442e 0a20   be SUCCEEDED.. 
+000188e0: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
+000188f0: 4f42 5f51 5545 5545 5f57 4149 547d 207c  OB_QUEUE_WAIT} |
+00018900: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
+00018910: 7d7c 2073 6564 202d 6e20 3270 207c 2067  }| sed -n 2p | g
+00018920: 7265 7020 2253 5543 4345 4544 4544 2227  rep "SUCCEEDED"'
+00018930: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00018940: 5461 736b 2031 2073 686f 756c 6420 6265  Task 1 should be
+00018950: 2046 4149 4c45 445f 5345 5455 502e 0a20   FAILED_SETUP.. 
+00018960: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
+00018970: 4f42 5f51 5545 5545 5f57 4149 547d 207c  OB_QUEUE_WAIT} |
+00018980: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
+00018990: 7d7c 2073 6564 202d 6e20 3370 207c 2067  }| sed -n 3p | g
+000189a0: 7265 7020 2246 4149 4c45 445f 5345 5455  rep "FAILED_SETU
+000189b0: 5022 272c 0a20 2020 2020 2020 2020 2020  P"',.           
+000189c0: 2023 2054 6173 6b20 3220 7368 6f75 6c64   # Task 2 should
+000189d0: 2062 6520 4341 4e43 454c 4c45 442e 0a20   be CANCELLED.. 
+000189e0: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
+000189f0: 4f42 5f51 5545 5545 5f57 4149 547d 207c  OB_QUEUE_WAIT} |
+00018a00: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
+00018a10: 7d7c 2073 6564 202d 6e20 3470 207c 2067  }| sed -n 4p | g
+00018a20: 7265 7020 2243 414e 4345 4c4c 4544 2227  rep "CANCELLED"'
+00018a30: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00018a40: 5461 736b 2033 2073 686f 756c 6420 6265  Task 3 should be
+00018a50: 2043 414e 4345 4c4c 4544 2e0a 2020 2020   CANCELLED..    
+00018a60: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
+00018a70: 5155 4555 455f 5741 4954 7d20 7c20 6772  QUEUE_WAIT} | gr
+00018a80: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
+00018a90: 7365 6420 2d6e 2035 7020 7c20 6772 6570  sed -n 5p | grep
+00018aa0: 2022 4341 4e43 454c 4c45 4422 272c 0a20   "CANCELLED"',. 
+00018ab0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00018ac0: 2020 5f4a 4f42 5f43 414e 4345 4c5f 5741    _JOB_CANCEL_WA
+00018ad0: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
+00018ae0: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
+00018af0: 2020 2320 496e 6372 6561 7365 2074 696d    # Increase tim
+00018b00: 656f 7574 2073 696e 6365 2073 6b79 206a  eout since sky j
+00018b10: 6f62 7320 7175 6575 6520 2d72 2063 616e  obs queue -r can
+00018b20: 2062 6520 626c 6f63 6b65 6420 6279 206f   be blocked by o
+00018b30: 7468 6572 2073 706f 7420 7465 7374 732e  ther spot tests.
+00018b40: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+00018b50: 3d33 3020 2a20 3630 2c0a 2020 2020 290a  =30 * 60,.    ).
+00018b60: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00018b70: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
+00018b80: 2d2d 2d2d 2d20 5465 7374 696e 6720 6d61  ----- Testing ma
+00018b90: 6e61 6765 6420 6a6f 6220 7265 636f 7665  naged job recove
+00018ba0: 7279 202d 2d2d 2d2d 2d2d 2d2d 2d0a 0a0a  ry ----------...
+00018bb0: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
+00018bc0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
+00018bd0: 6e61 6765 645f 6a6f 6273 0a64 6566 2074  naged_jobs.def t
+00018be0: 6573 745f 6d61 6e61 6765 645f 6a6f 6273  est_managed_jobs
+00018bf0: 5f72 6563 6f76 6572 795f 6177 7328 6177  _recovery_aws(aw
+00018c00: 735f 636f 6e66 6967 5f72 6567 696f 6e29  s_config_region)
+00018c10: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
+00018c20: 6e61 6765 6420 6a6f 6220 7265 636f 7665  naged job recove
+00018c30: 7279 2e22 2222 0a20 2020 206e 616d 6520  ry.""".    name 
+00018c40: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00018c50: 616d 6528 290a 2020 2020 6e61 6d65 5f6f  ame().    name_o
+00018c60: 6e5f 636c 6f75 6420 3d20 636f 6d6d 6f6e  n_cloud = common
+00018c70: 5f75 7469 6c73 2e6d 616b 655f 636c 7573  _utils.make_clus
+00018c80: 7465 725f 6e61 6d65 5f6f 6e5f 636c 6f75  ter_name_on_clou
+00018c90: 6428 0a20 2020 2020 2020 206e 616d 652c  d(.        name,
+00018ca0: 206a 6f62 732e 4a4f 4253 5f43 4c55 5354   jobs.JOBS_CLUST
+00018cb0: 4552 5f4e 414d 455f 5052 4546 4958 5f4c  ER_NAME_PREFIX_L
+00018cc0: 454e 4754 482c 2061 6464 5f75 7365 725f  ENGTH, add_user_
+00018cd0: 6861 7368 3d46 616c 7365 290a 2020 2020  hash=False).    
+00018ce0: 7265 6769 6f6e 203d 2061 7773 5f63 6f6e  region = aws_con
+00018cf0: 6669 675f 7265 6769 6f6e 0a20 2020 2074  fig_region.    t
+00018d00: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00018d10: 2020 2020 276d 616e 6167 6564 5f6a 6f62      'managed_job
+00018d20: 735f 7265 636f 7665 7279 5f61 7773 272c  s_recovery_aws',
+00018d30: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00018d40: 2020 2020 2020 2066 2773 6b79 206a 6f62         f'sky job
+00018d50: 7320 6c61 756e 6368 202d 2d63 6c6f 7564  s launch --cloud
+00018d60: 2061 7773 202d 2d72 6567 696f 6e20 7b72   aws --region {r
+00018d70: 6567 696f 6e7d 202d 2d75 7365 2d73 706f  egion} --use-spo
+00018d80: 7420 2d6e 207b 6e61 6d65 7d20 2265 6368  t -n {name} "ech
+00018d90: 6f20 534b 5950 494c 4f54 5f54 4153 4b5f  o SKYPILOT_TASK_
+00018da0: 4944 3a20 5c24 534b 5950 494c 4f54 5f54  ID: \$SKYPILOT_T
+00018db0: 4153 4b5f 4944 3b20 736c 6565 7020 3138  ASK_ID; sleep 18
+00018dc0: 3030 2220 202d 7920 2d64 272c 0a20 2020  00"  -y -d',.   
+00018dd0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00018de0: 3336 3027 2c0a 2020 2020 2020 2020 2020  360',.          
+00018df0: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
+00018e00: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
+00018e10: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
+00018e20: 6772 6570 2022 5255 4e4e 494e 4722 272c  grep "RUNNING"',
+00018e30: 0a20 2020 2020 2020 2020 2020 2066 2752  .            f'R
+00018e40: 554e 5f49 443d 2428 736b 7920 6a6f 6273  UN_ID=$(sky jobs
+00018e50: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
+00018e60: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
+00018e70: 6570 2053 4b59 5049 4c4f 545f 5441 534b  ep SKYPILOT_TASK
+00018e80: 5f49 4420 7c20 6375 7420 2d64 3a20 2d66  _ID | cut -d: -f
+00018e90: 3229 3b20 6563 686f 2022 2452 554e 5f49  2); echo "$RUN_I
+00018ea0: 4422 207c 2074 6565 202f 746d 702f 7b6e  D" | tee /tmp/{n
+00018eb0: 616d 657d 2d72 756e 2d69 6427 2c0a 2020  ame}-run-id',.  
+00018ec0: 2020 2020 2020 2020 2020 2320 5465 726d            # Term
+00018ed0: 696e 6174 6520 7468 6520 636c 7573 7465  inate the cluste
+00018ee0: 7220 6d61 6e75 616c 6c79 2e0a 2020 2020  r manually..    
+00018ef0: 2020 2020 2020 2020 2866 2761 7773 2065          (f'aws e
+00018f00: 6332 2074 6572 6d69 6e61 7465 2d69 6e73  c2 terminate-ins
+00018f10: 7461 6e63 6573 202d 2d72 6567 696f 6e20  tances --region 
+00018f20: 7b72 6567 696f 6e7d 202d 2d69 6e73 7461  {region} --insta
+00018f30: 6e63 652d 6964 7320 2428 270a 2020 2020  nce-ids $('.    
+00018f40: 2020 2020 2020 2020 2066 2761 7773 2065           f'aws e
+00018f50: 6332 2064 6573 6372 6962 652d 696e 7374  c2 describe-inst
+00018f60: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
+00018f70: 7265 6769 6f6e 7d20 270a 2020 2020 2020  region} '.      
+00018f80: 2020 2020 2020 2066 272d 2d66 696c 7465         f'--filte
+00018f90: 7273 204e 616d 653d 7461 673a 7261 792d  rs Name=tag:ray-
+00018fa0: 636c 7573 7465 722d 6e61 6d65 2c56 616c  cluster-name,Val
+00018fb0: 7565 733d 7b6e 616d 655f 6f6e 5f63 6c6f  ues={name_on_clo
+00018fc0: 7564 7d2a 2027 0a20 2020 2020 2020 2020  ud}* '.         
+00018fd0: 2020 2020 6627 2d2d 7175 6572 7920 5265      f'--query Re
+00018fe0: 7365 7276 6174 696f 6e73 5b5d 2e49 6e73  servations[].Ins
+00018ff0: 7461 6e63 6573 5b5d 2e49 6e73 7461 6e63  tances[].Instanc
+00019000: 6549 6420 270a 2020 2020 2020 2020 2020  eId '.          
+00019010: 2020 2027 2d2d 6f75 7470 7574 2074 6578     '--output tex
+00019020: 7429 2729 2c0a 2020 2020 2020 2020 2020  t)'),.          
+00019030: 2020 2773 6c65 6570 2031 3030 272c 0a20    'sleep 100',. 
+00019040: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
+00019050: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
+00019060: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
+00019070: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
+00019080: 4543 4f56 4552 494e 4722 272c 0a20 2020  ECOVERING"',.   
+00019090: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+000190a0: 3230 3027 2c0a 2020 2020 2020 2020 2020  200',.          
+000190b0: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
+000190c0: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
+000190d0: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
+000190e0: 6772 6570 2022 5255 4e4e 494e 4722 272c  grep "RUNNING"',
+000190f0: 0a20 2020 2020 2020 2020 2020 2066 2752  .            f'R
+00019100: 554e 5f49 443d 2428 6361 7420 2f74 6d70  UN_ID=$(cat /tmp
+00019110: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 293b  /{name}-run-id);
+00019120: 2065 6368 6f20 2224 5255 4e5f 4944 223b   echo "$RUN_ID";
+00019130: 2073 6b79 206a 6f62 7320 6c6f 6773 202d   sky jobs logs -
+00019140: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
+00019150: 6c6c 6f77 207c 2067 7265 7020 534b 5950  llow | grep SKYP
+00019160: 494c 4f54 5f54 4153 4b5f 4944 207c 2067  ILOT_TASK_ID | g
+00019170: 7265 7020 2224 5255 4e5f 4944 2227 2c0a  rep "$RUN_ID"',.
+00019180: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00019190: 2020 205f 4a4f 425f 4341 4e43 454c 5f57     _JOB_CANCEL_W
+000191a0: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
+000191b0: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
+000191c0: 2020 2074 696d 656f 7574 3d32 3520 2a20     timeout=25 * 
+000191d0: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
+000191e0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+000191f0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00019200: 6763 700a 4070 7974 6573 742e 6d61 726b  gcp.@pytest.mark
+00019210: 2e6d 616e 6167 6564 5f6a 6f62 730a 6465  .managed_jobs.de
+00019220: 6620 7465 7374 5f6d 616e 6167 6564 5f6a  f test_managed_j
+00019230: 6f62 735f 7265 636f 7665 7279 5f67 6370  obs_recovery_gcp
+00019240: 2829 3a0a 2020 2020 2222 2254 6573 7420  ():.    """Test 
+00019250: 6d61 6e61 6765 6420 6a6f 6220 7265 636f  managed job reco
+00019260: 7665 7279 2e22 2222 0a20 2020 206e 616d  very.""".    nam
+00019270: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00019280: 5f6e 616d 6528 290a 2020 2020 6e61 6d65  _name().    name
+00019290: 5f6f 6e5f 636c 6f75 6420 3d20 636f 6d6d  _on_cloud = comm
+000192a0: 6f6e 5f75 7469 6c73 2e6d 616b 655f 636c  on_utils.make_cl
+000192b0: 7573 7465 725f 6e61 6d65 5f6f 6e5f 636c  uster_name_on_cl
+000192c0: 6f75 6428 0a20 2020 2020 2020 206e 616d  oud(.        nam
+000192d0: 652c 206a 6f62 732e 4a4f 4253 5f43 4c55  e, jobs.JOBS_CLU
+000192e0: 5354 4552 5f4e 414d 455f 5052 4546 4958  STER_NAME_PREFIX
+000192f0: 5f4c 454e 4754 482c 2061 6464 5f75 7365  _LENGTH, add_use
+00019300: 725f 6861 7368 3d46 616c 7365 290a 2020  r_hash=False).  
+00019310: 2020 7a6f 6e65 203d 2027 7573 2d65 6173    zone = 'us-eas
+00019320: 7434 2d62 270a 2020 2020 7175 6572 795f  t4-b'.    query_
+00019330: 636d 6420 3d20 280a 2020 2020 2020 2020  cmd = (.        
+00019340: 6627 6763 6c6f 7564 2063 6f6d 7075 7465  f'gcloud compute
+00019350: 2069 6e73 7461 6e63 6573 206c 6973 7420   instances list 
+00019360: 2d2d 6669 6c74 6572 3d27 0a20 2020 2020  --filter='.     
+00019370: 2020 2023 2060 3a60 206d 6561 6e73 2070     # `:` means p
+00019380: 7265 6669 7820 6d61 7463 682e 0a20 2020  refix match..   
+00019390: 2020 2020 2066 2722 286c 6162 656c 732e       f'"(labels.
+000193a0: 7261 792d 636c 7573 7465 722d 6e61 6d65  ray-cluster-name
+000193b0: 3a7b 6e61 6d65 5f6f 6e5f 636c 6f75 647d  :{name_on_cloud}
+000193c0: 2922 2027 0a20 2020 2020 2020 2066 272d  )" '.        f'-
+000193d0: 2d7a 6f6e 6573 3d7b 7a6f 6e65 7d20 2d2d  -zones={zone} --
+000193e0: 666f 726d 6174 3d22 7661 6c75 6528 6e61  format="value(na
+000193f0: 6d65 2922 2729 0a20 2020 2074 6572 6d69  me)"').    termi
+00019400: 6e61 7465 5f63 6d64 203d 2028 6627 6763  nate_cmd = (f'gc
+00019410: 6c6f 7564 2063 6f6d 7075 7465 2069 6e73  loud compute ins
+00019420: 7461 6e63 6573 2064 656c 6574 6520 2d2d  tances delete --
+00019430: 7a6f 6e65 3d7b 7a6f 6e65 7d27 0a20 2020  zone={zone}'.   
+00019440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019450: 2020 6627 202d 2d71 7569 6574 2024 287b    f' --quiet $({
+00019460: 7175 6572 795f 636d 647d 2927 290a 2020  query_cmd})').  
+00019470: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00019480: 2020 2020 2020 2027 6d61 6e61 6765 645f         'managed_
+00019490: 6a6f 6273 5f72 6563 6f76 6572 795f 6763  jobs_recovery_gc
+000194a0: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
+000194b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000194c0: 6a6f 6273 206c 6175 6e63 6820 2d2d 636c  jobs launch --cl
+000194d0: 6f75 6420 6763 7020 2d2d 7a6f 6e65 207b  oud gcp --zone {
+000194e0: 7a6f 6e65 7d20 2d6e 207b 6e61 6d65 7d20  zone} -n {name} 
+000194f0: 2d2d 7573 652d 7370 6f74 202d 2d63 7075  --use-spot --cpu
+00019500: 7320 3220 2265 6368 6f20 534b 5950 494c  s 2 "echo SKYPIL
+00019510: 4f54 5f54 4153 4b5f 4944 3a20 5c24 534b  OT_TASK_ID: \$SK
+00019520: 5950 494c 4f54 5f54 4153 4b5f 4944 3b20  YPILOT_TASK_ID; 
+00019530: 736c 6565 7020 3138 3030 2220 202d 7920  sleep 1800"  -y 
+00019540: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
+00019550: 2027 736c 6565 7020 3336 3027 2c0a 2020   'sleep 360',.  
+00019560: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
+00019570: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
+00019580: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
+00019590: 6420 2d6e 3120 7c20 6772 6570 2022 5255  d -n1 | grep "RU
+000195a0: 4e4e 494e 4722 272c 0a20 2020 2020 2020  NNING"',.       
+000195b0: 2020 2020 2066 2752 554e 5f49 443d 2428       f'RUN_ID=$(
+000195c0: 736b 7920 6a6f 6273 206c 6f67 7320 2d6e  sky jobs logs -n
+000195d0: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
+000195e0: 6c6f 7720 7c20 6772 6570 2053 4b59 5049  low | grep SKYPI
+000195f0: 4c4f 545f 5441 534b 5f49 4420 7c20 6375  LOT_TASK_ID | cu
+00019600: 7420 2d64 3a20 2d66 3229 3b20 6563 686f  t -d: -f2); echo
+00019610: 2022 2452 554e 5f49 4422 207c 2074 6565   "$RUN_ID" | tee
+00019620: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+00019630: 2d69 6427 2c0a 2020 2020 2020 2020 2020  -id',.          
+00019640: 2020 2320 5465 726d 696e 6174 6520 7468    # Terminate th
+00019650: 6520 636c 7573 7465 7220 6d61 6e75 616c  e cluster manual
+00019660: 6c79 2e0a 2020 2020 2020 2020 2020 2020  ly..            
+00019670: 7465 726d 696e 6174 655f 636d 642c 0a20  terminate_cmd,. 
+00019680: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00019690: 7020 3630 272c 0a20 2020 2020 2020 2020  p 60',.         
+000196a0: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+000196b0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+000196c0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+000196d0: 2067 7265 7020 2252 4543 4f56 4552 494e   grep "RECOVERIN
+000196e0: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+000196f0: 2027 736c 6565 7020 3230 3027 2c0a 2020   'sleep 200',.  
+00019700: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
+00019710: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
+00019720: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
+00019730: 6420 2d6e 3120 7c20 6772 6570 2022 5255  d -n1 | grep "RU
+00019740: 4e4e 494e 4722 272c 0a20 2020 2020 2020  NNING"',.       
+00019750: 2020 2020 2066 2752 554e 5f49 443d 2428       f'RUN_ID=$(
+00019760: 6361 7420 2f74 6d70 2f7b 6e61 6d65 7d2d  cat /tmp/{name}-
+00019770: 7275 6e2d 6964 293b 2065 6368 6f20 2224  run-id); echo "$
+00019780: 5255 4e5f 4944 223b 2073 6b79 206a 6f62  RUN_ID"; sky job
+00019790: 7320 6c6f 6773 202d 6e20 7b6e 616d 657d  s logs -n {name}
+000197a0: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
+000197b0: 7265 7020 534b 5950 494c 4f54 5f54 4153  rep SKYPILOT_TAS
+000197c0: 4b5f 4944 3a20 7c20 6772 6570 2022 2452  K_ID: | grep "$R
+000197d0: 554e 5f49 4422 272c 0a20 2020 2020 2020  UN_ID"',.       
+000197e0: 205d 2c0a 2020 2020 2020 2020 5f4a 4f42   ],.        _JOB
+000197f0: 5f43 414e 4345 4c5f 5741 4954 2e66 6f72  _CANCEL_WAIT.for
+00019800: 6d61 7428 6a6f 625f 6e61 6d65 3d6e 616d  mat(job_name=nam
+00019810: 6529 2c0a 2020 2020 2020 2020 7469 6d65  e),.        time
+00019820: 6f75 743d 3235 202a 2036 302c 0a20 2020  out=25 * 60,.   
+00019830: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00019840: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+00019850: 6573 742e 6d61 726b 2e61 7773 0a40 7079  est.mark.aws.@py
+00019860: 7465 7374 2e6d 6172 6b2e 6d61 6e61 6765  test.mark.manage
+00019870: 645f 6a6f 6273 0a64 6566 2074 6573 745f  d_jobs.def test_
+00019880: 6d61 6e61 6765 645f 6a6f 6273 5f70 6970  managed_jobs_pip
+00019890: 656c 696e 655f 7265 636f 7665 7279 5f61  eline_recovery_a
+000198a0: 7773 2861 7773 5f63 6f6e 6669 675f 7265  ws(aws_config_re
+000198b0: 6769 6f6e 293a 0a20 2020 2022 2222 5465  gion):.    """Te
+000198c0: 7374 206d 616e 6167 6564 206a 6f62 2072  st managed job r
+000198d0: 6563 6f76 6572 7920 666f 7220 6120 7069  ecovery for a pi
+000198e0: 7065 6c69 6e65 2e22 2222 0a20 2020 206e  peline.""".    n
+000198f0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00019900: 6572 5f6e 616d 6528 290a 2020 2020 7573  er_name().    us
+00019910: 6572 5f68 6173 6820 3d20 636f 6d6d 6f6e  er_hash = common
+00019920: 5f75 7469 6c73 2e67 6574 5f75 7365 725f  _utils.get_user_
+00019930: 6861 7368 2829 0a20 2020 2075 7365 725f  hash().    user_
+00019940: 6861 7368 203d 2075 7365 725f 6861 7368  hash = user_hash
+00019950: 5b3a 636f 6d6d 6f6e 5f75 7469 6c73 2e55  [:common_utils.U
+00019960: 5345 525f 4841 5348 5f4c 454e 4754 485f  SER_HASH_LENGTH_
+00019970: 494e 5f43 4c55 5354 4552 5f4e 414d 455d  IN_CLUSTER_NAME]
+00019980: 0a20 2020 2072 6567 696f 6e20 3d20 6177  .    region = aw
+00019990: 735f 636f 6e66 6967 5f72 6567 696f 6e0a  s_config_region.
+000199a0: 2020 2020 6966 2072 6567 696f 6e20 213d      if region !=
+000199b0: 2027 7573 2d65 6173 742d 3227 3a0a 2020   'us-east-2':.  
+000199c0: 2020 2020 2020 7079 7465 7374 2e73 6b69        pytest.ski
+000199d0: 7028 274f 6e6c 7920 7275 6e20 7370 6f74  p('Only run spot
+000199e0: 2070 6970 656c 696e 6520 7265 636f 7665   pipeline recove
+000199f0: 7279 2074 6573 7420 696e 2075 732d 6561  ry test in us-ea
+00019a00: 7374 2d32 2729 0a20 2020 2074 6573 7420  st-2').    test 
+00019a10: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00019a20: 276d 616e 6167 6564 5f6a 6f62 735f 7069  'managed_jobs_pi
+00019a30: 7065 6c69 6e65 5f72 6563 6f76 6572 795f  peline_recovery_
+00019a40: 6177 7327 2c0a 2020 2020 2020 2020 5b0a  aws',.        [.
+00019a50: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00019a60: 7920 6a6f 6273 206c 6175 6e63 6820 2d6e  y jobs launch -n
+00019a70: 207b 6e61 6d65 7d20 7465 7374 732f 7465   {name} tests/te
+00019a80: 7374 5f79 616d 6c73 2f70 6970 656c 696e  st_yamls/pipelin
+00019a90: 655f 6177 732e 7961 6d6c 2020 2d79 202d  e_aws.yaml  -y -
+00019aa0: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
+00019ab0: 2773 6c65 6570 2034 3030 272c 0a20 2020  'sleep 400',.   
+00019ac0: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
+00019ad0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+00019ae0: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
+00019af0: 202d 6e31 207c 2067 7265 7020 2252 554e   -n1 | grep "RUN
+00019b00: 4e49 4e47 2227 2c0a 2020 2020 2020 2020  NING"',.        
+00019b10: 2020 2020 6627 5255 4e5f 4944 3d24 2873      f'RUN_ID=$(s
+00019b20: 6b79 206a 6f62 7320 6c6f 6773 202d 6e20  ky jobs logs -n 
+00019b30: 7b6e 616d 657d 202d 2d6e 6f2d 666f 6c6c  {name} --no-foll
+00019b40: 6f77 207c 2067 7265 7020 534b 5950 494c  ow | grep SKYPIL
+00019b50: 4f54 5f54 4153 4b5f 4944 3a20 7c20 6375  OT_TASK_ID: | cu
+00019b60: 7420 2d64 3a20 2d66 3229 3b20 6563 686f  t -d: -f2); echo
+00019b70: 2022 2452 554e 5f49 4422 207c 2074 6565   "$RUN_ID" | tee
+00019b80: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+00019b90: 2d69 6427 2c0a 2020 2020 2020 2020 2020  -id',.          
+00019ba0: 2020 6627 5255 4e5f 4944 533d 2428 736b    f'RUN_IDS=$(sk
+00019bb0: 7920 6a6f 6273 206c 6f67 7320 2d6e 207b  y jobs logs -n {
+00019bc0: 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f  name} --no-follo
+00019bd0: 7720 7c20 6772 6570 202d 4120 3420 534b  w | grep -A 4 SK
+00019be0: 5950 494c 4f54 5f54 4153 4b5f 4944 5320  YPILOT_TASK_IDS 
+00019bf0: 7c20 6375 7420 2d64 2229 2220 2d66 3229  | cut -d")" -f2)
+00019c00: 3b20 6563 686f 2022 2452 554e 5f49 4453  ; echo "$RUN_IDS
+00019c10: 2220 7c20 7465 6520 2f74 6d70 2f7b 6e61  " | tee /tmp/{na
+00019c20: 6d65 7d2d 7275 6e2d 6964 7327 2c0a 2020  me}-run-ids',.  
+00019c30: 2020 2020 2020 2020 2020 2320 5465 726d            # Term
+00019c40: 696e 6174 6520 7468 6520 636c 7573 7465  inate the cluste
+00019c50: 7220 6d61 6e75 616c 6c79 2e0a 2020 2020  r manually..    
+00019c60: 2020 2020 2020 2020 2320 5468 6520 6063          # The `c
+00019c70: 6174 202e 2e2e 7c20 7265 7660 2069 7320  at ...| rev` is 
+00019c80: 746f 2072 6574 7269 6576 6520 7468 6520  to retrieve the 
+00019c90: 6a6f 625f 6964 2066 726f 6d20 7468 650a  job_id from the.
+00019ca0: 2020 2020 2020 2020 2020 2020 2320 534b              # SK
+00019cb0: 5950 494c 4f54 5f54 4153 4b5f 4944 2c20  YPILOT_TASK_ID, 
+00019cc0: 7768 6963 6820 6765 7473 2074 6865 2073  which gets the s
+00019cd0: 6563 6f6e 6420 746f 206c 6173 7420 6669  econd to last fi
+00019ce0: 656c 640a 2020 2020 2020 2020 2020 2020  eld.            
+00019cf0: 2320 7365 7061 7261 7465 6420 6279 2060  # separated by `
+00019d00: 2d60 2e0a 2020 2020 2020 2020 2020 2020  -`..            
+00019d10: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00019d20: 2020 6627 4d41 4e41 4745 445f 4a4f 425f    f'MANAGED_JOB_
+00019d30: 4944 3d60 6361 7420 2f74 6d70 2f7b 6e61  ID=`cat /tmp/{na
+00019d40: 6d65 7d2d 7275 6e2d 6964 207c 2072 6576  me}-run-id | rev
+00019d50: 207c 2027 0a20 2020 2020 2020 2020 2020   | '.           
+00019d60: 2020 2020 2027 6375 7420 2d64 5c27 5f5c       'cut -d\'_\
+00019d70: 2720 2d66 3120 7c20 7265 7620 7c20 6375  ' -f1 | rev | cu
+00019d80: 7420 2d64 5c27 2d5c 2720 2d66 3160 3b27  t -d\'-\' -f1`;'
+00019d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019da0: 2066 2761 7773 2065 6332 2074 6572 6d69   f'aws ec2 termi
+00019db0: 6e61 7465 2d69 6e73 7461 6e63 6573 202d  nate-instances -
+00019dc0: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
+00019dd0: 202d 2d69 6e73 7461 6e63 652d 6964 7320   --instance-ids 
+00019de0: 2428 270a 2020 2020 2020 2020 2020 2020  $('.            
+00019df0: 2020 2020 6627 6177 7320 6563 3220 6465      f'aws ec2 de
+00019e00: 7363 7269 6265 2d69 6e73 7461 6e63 6573  scribe-instances
+00019e10: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+00019e20: 6e7d 2027 0a20 2020 2020 2020 2020 2020  n} '.           
+00019e30: 2020 2020 2023 2054 4f44 4f28 7a68 7775       # TODO(zhwu
+00019e40: 293a 2066 6978 2074 6865 206e 616d 6520  ): fix the name 
+00019e50: 666f 7220 7370 6f74 2063 6c75 7374 6572  for spot cluster
+00019e60: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00019e70: 2020 272d 2d66 696c 7465 7273 204e 616d    '--filters Nam
+00019e80: 653d 7461 673a 7261 792d 636c 7573 7465  e=tag:ray-cluste
+00019e90: 722d 6e61 6d65 2c56 616c 7565 733d 2a2d  r-name,Values=*-
+00019ea0: 247b 4d41 4e41 4745 445f 4a4f 425f 4944  ${MANAGED_JOB_ID
+00019eb0: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
+00019ec0: 2020 2066 272d 7b75 7365 725f 6861 7368     f'-{user_hash
+00019ed0: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
+00019ee0: 2020 2020 6627 2d2d 7175 6572 7920 5265      f'--query Re
+00019ef0: 7365 7276 6174 696f 6e73 5b5d 2e49 6e73  servations[].Ins
+00019f00: 7461 6e63 6573 5b5d 2e49 6e73 7461 6e63  tances[].Instanc
+00019f10: 6549 6420 270a 2020 2020 2020 2020 2020  eId '.          
+00019f20: 2020 2020 2020 272d 2d6f 7574 7075 7420        '--output 
+00019f30: 7465 7874 2927 292c 0a20 2020 2020 2020  text)'),.       
+00019f40: 2020 2020 2027 736c 6565 7020 3130 3027       'sleep 100'
+00019f50: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00019f60: 7b5f 4a4f 425f 5155 4555 455f 5741 4954  {_JOB_QUEUE_WAIT
+00019f70: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+00019f80: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00019f90: 2022 5245 434f 5645 5249 4e47 2227 2c0a   "RECOVERING"',.
+00019fa0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00019fb0: 6570 2032 3030 272c 0a20 2020 2020 2020  ep 200',.       
+00019fc0: 2020 2020 2066 277b 5f4a 4f42 5f51 5545       f'{_JOB_QUE
+00019fd0: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+00019fe0: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
+00019ff0: 207c 2067 7265 7020 2252 554e 4e49 4e47   | grep "RUNNING
+0001a000: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0001a010: 6627 5255 4e5f 4944 3d24 2863 6174 202f  f'RUN_ID=$(cat /
+0001a020: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
+0001a030: 6429 3b20 6563 686f 2024 5255 4e5f 4944  d); echo $RUN_ID
+0001a040: 3b20 736b 7920 6a6f 6273 206c 6f67 7320  ; sky jobs logs 
+0001a050: 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f 2d66  -n {name} --no-f
+0001a060: 6f6c 6c6f 7720 7c20 6772 6570 2053 4b59  ollow | grep SKY
+0001a070: 5049 4c4f 545f 5441 534b 5f49 443a 207c  PILOT_TASK_ID: |
+0001a080: 2067 7265 7020 2224 5255 4e5f 4944 2227   grep "$RUN_ID"'
+0001a090: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001a0a0: 5255 4e5f 4944 533d 2428 736b 7920 6a6f  RUN_IDS=$(sky jo
+0001a0b0: 6273 206c 6f67 7320 2d6e 207b 6e61 6d65  bs logs -n {name
+0001a0c0: 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  } --no-follow | 
+0001a0d0: 6772 6570 202d 4120 3420 534b 5950 494c  grep -A 4 SKYPIL
+0001a0e0: 4f54 5f54 4153 4b5f 4944 5320 7c20 6375  OT_TASK_IDS | cu
+0001a0f0: 7420 2d64 2229 2220 2d66 3229 3b20 6563  t -d")" -f2); ec
+0001a100: 686f 2022 2452 554e 5f49 4453 2220 7c20  ho "$RUN_IDS" | 
+0001a110: 7465 6520 2f74 6d70 2f7b 6e61 6d65 7d2d  tee /tmp/{name}-
+0001a120: 7275 6e2d 6964 732d 6e65 7727 2c0a 2020  run-ids-new',.  
+0001a130: 2020 2020 2020 2020 2020 6627 6469 6666            f'diff
+0001a140: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+0001a150: 2d69 6473 202f 746d 702f 7b6e 616d 657d  -ids /tmp/{name}
+0001a160: 2d72 756e 2d69 6473 2d6e 6577 272c 0a20  -run-ids-new',. 
+0001a170: 2020 2020 2020 2020 2020 2066 2763 6174             f'cat
+0001a180: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+0001a190: 2d69 6473 207c 2073 6564 202d 6e20 3270  -ids | sed -n 2p
+0001a1a0: 207c 2067 7265 7020 6063 6174 202f 746d   | grep `cat /tm
+0001a1b0: 702f 7b6e 616d 657d 2d72 756e 2d69 6460  p/{name}-run-id`
+0001a1c0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+0001a1d0: 2020 2020 2020 5f4a 4f42 5f43 414e 4345        _JOB_CANCE
+0001a1e0: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+0001a1f0: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
+0001a200: 2020 2020 2020 7469 6d65 6f75 743d 3235        timeout=25
+0001a210: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
+0001a220: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+0001a230: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+0001a240: 726b 2e67 6370 0a40 7079 7465 7374 2e6d  rk.gcp.@pytest.m
+0001a250: 6172 6b2e 6d61 6e61 6765 645f 6a6f 6273  ark.managed_jobs
+0001a260: 0a64 6566 2074 6573 745f 6d61 6e61 6765  .def test_manage
+0001a270: 645f 6a6f 6273 5f70 6970 656c 696e 655f  d_jobs_pipeline_
+0001a280: 7265 636f 7665 7279 5f67 6370 2829 3a0a  recovery_gcp():.
+0001a290: 2020 2020 2222 2254 6573 7420 6d61 6e61      """Test mana
+0001a2a0: 6765 6420 6a6f 6220 7265 636f 7665 7279  ged job recovery
+0001a2b0: 2066 6f72 2061 2070 6970 656c 696e 652e   for a pipeline.
+0001a2c0: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
+0001a2d0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+0001a2e0: 2829 0a20 2020 207a 6f6e 6520 3d20 2775  ().    zone = 'u
+0001a2f0: 732d 6561 7374 342d 6227 0a20 2020 2075  s-east4-b'.    u
+0001a300: 7365 725f 6861 7368 203d 2063 6f6d 6d6f  ser_hash = commo
+0001a310: 6e5f 7574 696c 732e 6765 745f 7573 6572  n_utils.get_user
+0001a320: 5f68 6173 6828 290a 2020 2020 7573 6572  _hash().    user
+0001a330: 5f68 6173 6820 3d20 7573 6572 5f68 6173  _hash = user_has
+0001a340: 685b 3a63 6f6d 6d6f 6e5f 7574 696c 732e  h[:common_utils.
+0001a350: 5553 4552 5f48 4153 485f 4c45 4e47 5448  USER_HASH_LENGTH
+0001a360: 5f49 4e5f 434c 5553 5445 525f 4e41 4d45  _IN_CLUSTER_NAME
+0001a370: 5d0a 2020 2020 7175 6572 795f 636d 6420  ].    query_cmd 
+0001a380: 3d20 280a 2020 2020 2020 2020 2767 636c  = (.        'gcl
+0001a390: 6f75 6420 636f 6d70 7574 6520 696e 7374  oud compute inst
+0001a3a0: 616e 6365 7320 6c69 7374 202d 2d66 696c  ances list --fil
+0001a3b0: 7465 723d 270a 2020 2020 2020 2020 6627  ter='.        f'
+0001a3c0: 2228 6c61 6265 6c73 2e72 6179 2d63 6c75  "(labels.ray-clu
+0001a3d0: 7374 6572 2d6e 616d 653a 2a2d 247b 7b4d  ster-name:*-${{M
+0001a3e0: 414e 4147 4544 5f4a 4f42 5f49 447d 7d2d  ANAGED_JOB_ID}}-
+0001a3f0: 7b75 7365 725f 6861 7368 7d29 2220 270a  {user_hash})" '.
+0001a400: 2020 2020 2020 2020 6627 2d2d 7a6f 6e65          f'--zone
+0001a410: 733d 7b7a 6f6e 657d 202d 2d66 6f72 6d61  s={zone} --forma
+0001a420: 743d 2276 616c 7565 286e 616d 6529 2227  t="value(name)"'
+0001a430: 290a 2020 2020 7465 726d 696e 6174 655f  ).    terminate_
+0001a440: 636d 6420 3d20 2866 2767 636c 6f75 6420  cmd = (f'gcloud 
+0001a450: 636f 6d70 7574 6520 696e 7374 616e 6365  compute instance
+0001a460: 7320 6465 6c65 7465 202d 2d7a 6f6e 653d  s delete --zone=
+0001a470: 7b7a 6f6e 657d 270a 2020 2020 2020 2020  {zone}'.        
+0001a480: 2020 2020 2020 2020 2020 2020 2066 2720               f' 
+0001a490: 2d2d 7175 6965 7420 2428 7b71 7565 7279  --quiet $({query
+0001a4a0: 5f63 6d64 7d29 2729 0a20 2020 2074 6573  _cmd})').    tes
+0001a4b0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+0001a4c0: 2020 276d 616e 6167 6564 5f6a 6f62 735f    'managed_jobs_
+0001a4d0: 7069 7065 6c69 6e65 5f72 6563 6f76 6572  pipeline_recover
+0001a4e0: 795f 6763 7027 2c0a 2020 2020 2020 2020  y_gcp',.        
+0001a4f0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+0001a500: 736b 7920 6a6f 6273 206c 6175 6e63 6820  sky jobs launch 
+0001a510: 2d6e 207b 6e61 6d65 7d20 7465 7374 732f  -n {name} tests/
+0001a520: 7465 7374 5f79 616d 6c73 2f70 6970 656c  test_yamls/pipel
+0001a530: 696e 655f 6763 702e 7961 6d6c 2020 2d79  ine_gcp.yaml  -y
+0001a540: 202d 6427 2c0a 2020 2020 2020 2020 2020   -d',.          
+0001a550: 2020 2773 6c65 6570 2034 3030 272c 0a20    'sleep 400',. 
+0001a560: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
+0001a570: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
+0001a580: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
+0001a590: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
+0001a5a0: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
+0001a5b0: 2020 2020 2020 6627 5255 4e5f 4944 3d24        f'RUN_ID=$
+0001a5c0: 2873 6b79 206a 6f62 7320 6c6f 6773 202d  (sky jobs logs -
+0001a5d0: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
+0001a5e0: 6c6c 6f77 207c 2067 7265 7020 534b 5950  llow | grep SKYP
+0001a5f0: 494c 4f54 5f54 4153 4b5f 4944 3a20 7c20  ILOT_TASK_ID: | 
+0001a600: 6375 7420 2d64 3a20 2d66 3229 3b20 6563  cut -d: -f2); ec
+0001a610: 686f 2022 2452 554e 5f49 4422 207c 2074  ho "$RUN_ID" | t
+0001a620: 6565 202f 746d 702f 7b6e 616d 657d 2d72  ee /tmp/{name}-r
+0001a630: 756e 2d69 6427 2c0a 2020 2020 2020 2020  un-id',.        
+0001a640: 2020 2020 6627 5255 4e5f 4944 533d 2428      f'RUN_IDS=$(
+0001a650: 736b 7920 6a6f 6273 206c 6f67 7320 2d6e  sky jobs logs -n
+0001a660: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
+0001a670: 6c6f 7720 7c20 6772 6570 202d 4120 3420  low | grep -A 4 
+0001a680: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
+0001a690: 5320 7c20 6375 7420 2d64 2229 2220 2d66  S | cut -d")" -f
+0001a6a0: 3229 3b20 6563 686f 2022 2452 554e 5f49  2); echo "$RUN_I
+0001a6b0: 4453 2220 7c20 7465 6520 2f74 6d70 2f7b  DS" | tee /tmp/{
+0001a6c0: 6e61 6d65 7d2d 7275 6e2d 6964 7327 2c0a  name}-run-ids',.
+0001a6d0: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
+0001a6e0: 726d 696e 6174 6520 7468 6520 636c 7573  rminate the clus
+0001a6f0: 7465 7220 6d61 6e75 616c 6c79 2e0a 2020  ter manually..  
+0001a700: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
+0001a710: 6063 6174 202e 2e2e 7c20 7265 7660 2069  `cat ...| rev` i
+0001a720: 7320 746f 2072 6574 7269 6576 6520 7468  s to retrieve th
+0001a730: 6520 6a6f 625f 6964 2066 726f 6d20 7468  e job_id from th
+0001a740: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
+0001a750: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
+0001a760: 2c20 7768 6963 6820 6765 7473 2074 6865  , which gets the
+0001a770: 2073 6563 6f6e 6420 746f 206c 6173 7420   second to last 
+0001a780: 6669 656c 640a 2020 2020 2020 2020 2020  field.          
+0001a790: 2020 2320 7365 7061 7261 7465 6420 6279    # separated by
+0001a7a0: 2060 2d60 2e0a 2020 2020 2020 2020 2020   `-`..          
+0001a7b0: 2020 2866 274d 414e 4147 4544 5f4a 4f42    (f'MANAGED_JOB
+0001a7c0: 5f49 443d 6063 6174 202f 746d 702f 7b6e  _ID=`cat /tmp/{n
+0001a7d0: 616d 657d 2d72 756e 2d69 6420 7c20 7265  ame}-run-id | re
+0001a7e0: 7620 7c20 270a 2020 2020 2020 2020 2020  v | '.          
+0001a7f0: 2020 2066 2763 7574 202d 645c 275f 5c27     f'cut -d\'_\'
+0001a800: 202d 6631 207c 2072 6576 207c 2063 7574   -f1 | rev | cut
+0001a810: 202d 645c 272d 5c27 202d 6631 603b 207b   -d\'-\' -f1`; {
+0001a820: 7465 726d 696e 6174 655f 636d 647d 2729  terminate_cmd}')
+0001a830: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0001a840: 6c65 6570 2036 3027 2c0a 2020 2020 2020  leep 60',.      
+0001a850: 2020 2020 2020 6627 7b5f 4a4f 425f 5155        f'{_JOB_QU
+0001a860: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+0001a870: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+0001a880: 3120 7c20 6772 6570 2022 5245 434f 5645  1 | grep "RECOVE
+0001a890: 5249 4e47 2227 2c0a 2020 2020 2020 2020  RING"',.        
+0001a8a0: 2020 2020 2773 6c65 6570 2032 3030 272c      'sleep 200',
+0001a8b0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+0001a8c0: 5f4a 4f42 5f51 5545 5545 5f57 4149 547d  _JOB_QUEUE_WAIT}
+0001a8d0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+0001a8e0: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
+0001a8f0: 2252 554e 4e49 4e47 2227 2c0a 2020 2020  "RUNNING"',.    
+0001a900: 2020 2020 2020 2020 6627 5255 4e5f 4944          f'RUN_ID
+0001a910: 3d24 2863 6174 202f 746d 702f 7b6e 616d  =$(cat /tmp/{nam
+0001a920: 657d 2d72 756e 2d69 6429 3b20 6563 686f  e}-run-id); echo
+0001a930: 2024 5255 4e5f 4944 3b20 736b 7920 6a6f   $RUN_ID; sky jo
+0001a940: 6273 206c 6f67 7320 2d6e 207b 6e61 6d65  bs logs -n {name
+0001a950: 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  } --no-follow | 
+0001a960: 6772 6570 2053 4b59 5049 4c4f 545f 5441  grep SKYPILOT_TA
+0001a970: 534b 5f49 443a 207c 2067 7265 7020 2224  SK_ID: | grep "$
+0001a980: 5255 4e5f 4944 2227 2c0a 2020 2020 2020  RUN_ID"',.      
+0001a990: 2020 2020 2020 6627 5255 4e5f 4944 533d        f'RUN_IDS=
+0001a9a0: 2428 736b 7920 6a6f 6273 206c 6f67 7320  $(sky jobs logs 
+0001a9b0: 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f 2d66  -n {name} --no-f
+0001a9c0: 6f6c 6c6f 7720 7c20 6772 6570 202d 4120  ollow | grep -A 
+0001a9d0: 3420 534b 5950 494c 4f54 5f54 4153 4b5f  4 SKYPILOT_TASK_
+0001a9e0: 4944 5320 7c20 6375 7420 2d64 2229 2220  IDS | cut -d")" 
+0001a9f0: 2d66 3229 3b20 6563 686f 2022 2452 554e  -f2); echo "$RUN
+0001aa00: 5f49 4453 2220 7c20 7465 6520 2f74 6d70  _IDS" | tee /tmp
+0001aa10: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 732d  /{name}-run-ids-
+0001aa20: 6e65 7727 2c0a 2020 2020 2020 2020 2020  new',.          
+0001aa30: 2020 6627 6469 6666 202f 746d 702f 7b6e    f'diff /tmp/{n
+0001aa40: 616d 657d 2d72 756e 2d69 6473 202f 746d  ame}-run-ids /tm
+0001aa50: 702f 7b6e 616d 657d 2d72 756e 2d69 6473  p/{name}-run-ids
+0001aa60: 2d6e 6577 272c 0a20 2020 2020 2020 2020  -new',.         
+0001aa70: 2020 2066 2763 6174 202f 746d 702f 7b6e     f'cat /tmp/{n
+0001aa80: 616d 657d 2d72 756e 2d69 6473 207c 2073  ame}-run-ids | s
+0001aa90: 6564 202d 6e20 3270 207c 2067 7265 7020  ed -n 2p | grep 
+0001aaa0: 6063 6174 202f 746d 702f 7b6e 616d 657d  `cat /tmp/{name}
+0001aab0: 2d72 756e 2d69 6460 272c 0a20 2020 2020  -run-id`',.     
+0001aac0: 2020 205d 2c0a 2020 2020 2020 2020 5f4a     ],.        _J
+0001aad0: 4f42 5f43 414e 4345 4c5f 5741 4954 2e66  OB_CANCEL_WAIT.f
+0001aae0: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d6e  ormat(job_name=n
+0001aaf0: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
+0001ab00: 6d65 6f75 743d 3235 202a 2036 302c 0a20  meout=25 * 60,. 
+0001ab10: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+0001ab20: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+0001ab30: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
+0001ab40: 7569 6473 7461 636b 2020 2320 466c 7569  uidstack  # Flui
+0001ab50: 6473 7461 636b 2064 6f65 7320 6e6f 7420  dstack does not 
+0001ab60: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
+0001ab70: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+0001ab80: 6172 6b2e 6e6f 5f61 7a75 7265 2020 2320  ark.no_azure  # 
+0001ab90: 417a 7572 6520 646f 6573 206e 6f74 2073  Azure does not s
+0001aba0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+0001abb0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+0001abc0: 726b 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f  rk.no_lambda_clo
+0001abd0: 7564 2020 2320 4c61 6d62 6461 2043 6c6f  ud  # Lambda Clo
+0001abe0: 7564 2064 6f65 7320 6e6f 7420 7375 7070  ud does not supp
+0001abf0: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
+0001ac00: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
+0001ac10: 6e6f 5f69 626d 2020 2320 4942 4d20 436c  no_ibm  # IBM Cl
+0001ac20: 6f75 6420 646f 6573 206e 6f74 2073 7570  oud does not sup
+0001ac30: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
+0001ac40: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+0001ac50: 2e6e 6f5f 7363 7020 2023 2053 4350 2064  .no_scp  # SCP d
+0001ac60: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+0001ac70: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
+0001ac80: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f70  pytest.mark.no_p
+0001ac90: 6170 6572 7370 6163 6520 2023 2050 6170  aperspace  # Pap
+0001aca0: 6572 7370 6163 6520 646f 6573 206e 6f74  erspace does not
+0001acb0: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
+0001acc0: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
+0001acd0: 6d61 726b 2e6e 6f5f 6b75 6265 726e 6574  mark.no_kubernet
+0001ace0: 6573 2020 2320 4b75 6265 726e 6574 6573  es  # Kubernetes
+0001acf0: 2064 6f65 7320 6e6f 7420 6861 7665 2061   does not have a
+0001ad00: 206e 6f74 696f 6e20 6f66 2073 706f 7420   notion of spot 
+0001ad10: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+0001ad20: 742e 6d61 726b 2e6d 616e 6167 6564 5f6a  t.mark.managed_j
+0001ad30: 6f62 730a 6465 6620 7465 7374 5f6d 616e  obs.def test_man
+0001ad40: 6167 6564 5f6a 6f62 735f 7265 636f 7665  aged_jobs_recove
+0001ad50: 7279 5f64 6566 6175 6c74 5f72 6573 6f75  ry_default_resou
+0001ad60: 7263 6573 2867 656e 6572 6963 5f63 6c6f  rces(generic_clo
+0001ad70: 7564 3a20 7374 7229 3a0a 2020 2020 2222  ud: str):.    ""
+0001ad80: 2254 6573 7420 6d61 6e61 6765 6420 6a6f  "Test managed jo
+0001ad90: 6220 7265 636f 7665 7279 2066 6f72 2064  b recovery for d
+0001ada0: 6566 6175 6c74 2072 6573 6f75 7263 6573  efault resources
+0001adb0: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
+0001adc0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+0001add0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+0001ade0: 6573 7428 0a20 2020 2020 2020 2027 6d61  est(.        'ma
+0001adf0: 6e61 6765 642d 7370 6f74 2d72 6563 6f76  naged-spot-recov
+0001ae00: 6572 792d 6465 6661 756c 742d 7265 736f  ery-default-reso
+0001ae10: 7572 6365 7327 2c0a 2020 2020 2020 2020  urces',.        
+0001ae20: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+0001ae30: 736b 7920 6a6f 6273 206c 6175 6e63 6820  sky jobs launch 
+0001ae40: 2d6e 207b 6e61 6d65 7d20 2d2d 636c 6f75  -n {name} --clou
+0001ae50: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+0001ae60: 7d20 2d2d 7573 652d 7370 6f74 2022 736c  } --use-spot "sl
+0001ae70: 6565 7020 3330 2026 2620 7375 646f 2073  eep 30 && sudo s
+0001ae80: 6875 7464 6f77 6e20 6e6f 7720 2626 2073  hutdown now && s
+0001ae90: 6c65 6570 2031 3030 3022 202d 7920 2d64  leep 1000" -y -d
+0001aea0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+0001aeb0: 736c 6565 7020 3336 3027 2c0a 2020 2020  sleep 360',.    
+0001aec0: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
+0001aed0: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+0001aee0: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
+0001aef0: 2d6e 3120 7c20 6772 6570 2022 5255 4e4e  -n1 | grep "RUNN
+0001af00: 494e 475c 7c52 4543 4f56 4552 494e 4722  ING\|RECOVERING"
+0001af10: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+0001af20: 2020 2020 2020 5f4a 4f42 5f43 414e 4345        _JOB_CANCE
+0001af30: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+0001af40: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
+0001af50: 2020 2020 2020 7469 6d65 6f75 743d 3235        timeout=25
+0001af60: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
+0001af70: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+0001af80: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+0001af90: 726b 2e61 7773 0a40 7079 7465 7374 2e6d  rk.aws.@pytest.m
+0001afa0: 6172 6b2e 6d61 6e61 6765 645f 6a6f 6273  ark.managed_jobs
+0001afb0: 0a64 6566 2074 6573 745f 6d61 6e61 6765  .def test_manage
+0001afc0: 645f 6a6f 6273 5f72 6563 6f76 6572 795f  d_jobs_recovery_
+0001afd0: 6d75 6c74 695f 6e6f 6465 5f61 7773 2861  multi_node_aws(a
+0001afe0: 7773 5f63 6f6e 6669 675f 7265 6769 6f6e  ws_config_region
+0001aff0: 293a 0a20 2020 2022 2222 5465 7374 206d  ):.    """Test m
+0001b000: 616e 6167 6564 206a 6f62 2072 6563 6f76  anaged job recov
+0001b010: 6572 792e 2222 220a 2020 2020 6e61 6d65  ery.""".    name
+0001b020: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+0001b030: 6e61 6d65 2829 0a20 2020 206e 616d 655f  name().    name_
+0001b040: 6f6e 5f63 6c6f 7564 203d 2063 6f6d 6d6f  on_cloud = commo
+0001b050: 6e5f 7574 696c 732e 6d61 6b65 5f63 6c75  n_utils.make_clu
+0001b060: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
+0001b070: 7564 280a 2020 2020 2020 2020 6e61 6d65  ud(.        name
+0001b080: 2c20 6a6f 6273 2e4a 4f42 535f 434c 5553  , jobs.JOBS_CLUS
+0001b090: 5445 525f 4e41 4d45 5f50 5245 4649 585f  TER_NAME_PREFIX_
+0001b0a0: 4c45 4e47 5448 2c20 6164 645f 7573 6572  LENGTH, add_user
+0001b0b0: 5f68 6173 683d 4661 6c73 6529 0a20 2020  _hash=False).   
+0001b0c0: 2072 6567 696f 6e20 3d20 6177 735f 636f   region = aws_co
+0001b0d0: 6e66 6967 5f72 6567 696f 6e0a 2020 2020  nfig_region.    
+0001b0e0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+0001b0f0: 2020 2020 2027 6d61 6e61 6765 645f 6a6f       'managed_jo
+0001b100: 6273 5f72 6563 6f76 6572 795f 6d75 6c74  bs_recovery_mult
+0001b110: 695f 6e6f 6465 5f61 7773 272c 0a20 2020  i_node_aws',.   
+0001b120: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+0001b130: 2020 2066 2773 6b79 206a 6f62 7320 6c61     f'sky jobs la
+0001b140: 756e 6368 202d 2d63 6c6f 7564 2061 7773  unch --cloud aws
+0001b150: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+0001b160: 6e7d 202d 6e20 7b6e 616d 657d 202d 2d75  n} -n {name} --u
+0001b170: 7365 2d73 706f 7420 2d2d 6e75 6d2d 6e6f  se-spot --num-no
+0001b180: 6465 7320 3220 2265 6368 6f20 534b 5950  des 2 "echo SKYP
+0001b190: 494c 4f54 5f54 4153 4b5f 4944 3a20 5c24  ILOT_TASK_ID: \$
+0001b1a0: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
+0001b1b0: 3b20 736c 6565 7020 3138 3030 2220 202d  ; sleep 1800"  -
+0001b1c0: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
+0001b1d0: 2020 2027 736c 6565 7020 3435 3027 2c0a     'sleep 450',.
+0001b1e0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+0001b1f0: 4a4f 425f 5155 4555 455f 5741 4954 7d7c  JOB_QUEUE_WAIT}|
+0001b200: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
+0001b210: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
+0001b220: 5255 4e4e 494e 4722 272c 0a20 2020 2020  RUNNING"',.     
+0001b230: 2020 2020 2020 2066 2752 554e 5f49 443d         f'RUN_ID=
+0001b240: 2428 736b 7920 6a6f 6273 206c 6f67 7320  $(sky jobs logs 
+0001b250: 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f 2d66  -n {name} --no-f
+0001b260: 6f6c 6c6f 7720 7c20 6772 6570 2053 4b59  ollow | grep SKY
+0001b270: 5049 4c4f 545f 5441 534b 5f49 4420 7c20  PILOT_TASK_ID | 
+0001b280: 6375 7420 2d64 3a20 2d66 3229 3b20 6563  cut -d: -f2); ec
+0001b290: 686f 2022 2452 554e 5f49 4422 207c 2074  ho "$RUN_ID" | t
+0001b2a0: 6565 202f 746d 702f 7b6e 616d 657d 2d72  ee /tmp/{name}-r
+0001b2b0: 756e 2d69 6427 2c0a 2020 2020 2020 2020  un-id',.        
+0001b2c0: 2020 2020 2320 5465 726d 696e 6174 6520      # Terminate 
+0001b2d0: 7468 6520 776f 726b 6572 206d 616e 7561  the worker manua
+0001b2e0: 6c6c 792e 0a20 2020 2020 2020 2020 2020  lly..           
+0001b2f0: 2028 6627 6177 7320 6563 3220 7465 726d   (f'aws ec2 term
+0001b300: 696e 6174 652d 696e 7374 616e 6365 7320  inate-instances 
+0001b310: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
+0001b320: 7d20 2d2d 696e 7374 616e 6365 2d69 6473  } --instance-ids
+0001b330: 2024 2827 0a20 2020 2020 2020 2020 2020   $('.           
+0001b340: 2020 6627 6177 7320 6563 3220 6465 7363    f'aws ec2 desc
+0001b350: 7269 6265 2d69 6e73 7461 6e63 6573 202d  ribe-instances -
+0001b360: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
+0001b370: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0001b380: 6627 2d2d 6669 6c74 6572 7320 4e61 6d65  f'--filters Name
+0001b390: 3d74 6167 3a72 6179 2d63 6c75 7374 6572  =tag:ray-cluster
+0001b3a0: 2d6e 616d 652c 5661 6c75 6573 3d7b 6e61  -name,Values={na
+0001b3b0: 6d65 5f6f 6e5f 636c 6f75 647d 2a20 270a  me_on_cloud}* '.
+0001b3c0: 2020 2020 2020 2020 2020 2020 2027 4e61               'Na
+0001b3d0: 6d65 3d74 6167 3a72 6179 2d6e 6f64 652d  me=tag:ray-node-
+0001b3e0: 7479 7065 2c56 616c 7565 733d 776f 726b  type,Values=work
+0001b3f0: 6572 2027 0a20 2020 2020 2020 2020 2020  er '.           
+0001b400: 2020 6627 2d2d 7175 6572 7920 5265 7365    f'--query Rese
+0001b410: 7276 6174 696f 6e73 5b5d 2e49 6e73 7461  rvations[].Insta
+0001b420: 6e63 6573 5b5d 2e49 6e73 7461 6e63 6549  nces[].InstanceI
+0001b430: 6420 270a 2020 2020 2020 2020 2020 2020  d '.            
+0001b440: 2027 2d2d 6f75 7470 7574 2074 6578 7429   '--output text)
+0001b450: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+0001b460: 2773 6c65 6570 2035 3027 2c0a 2020 2020  'sleep 50',.    
+0001b470: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
+0001b480: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+0001b490: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
+0001b4a0: 2d6e 3120 7c20 6772 6570 2022 5245 434f  -n1 | grep "RECO
+0001b4b0: 5645 5249 4e47 2227 2c0a 2020 2020 2020  VERING"',.      
+0001b4c0: 2020 2020 2020 2773 6c65 6570 2035 3630        'sleep 560
+0001b4d0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001b4e0: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
+0001b4f0: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
+0001b500: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+0001b510: 7020 2252 554e 4e49 4e47 2227 2c0a 2020  p "RUNNING"',.  
+0001b520: 2020 2020 2020 2020 2020 6627 5255 4e5f            f'RUN_
+0001b530: 4944 3d24 2863 6174 202f 746d 702f 7b6e  ID=$(cat /tmp/{n
+0001b540: 616d 657d 2d72 756e 2d69 6429 3b20 6563  ame}-run-id); ec
+0001b550: 686f 2024 5255 4e5f 4944 3b20 736b 7920  ho $RUN_ID; sky 
+0001b560: 6a6f 6273 206c 6f67 7320 2d6e 207b 6e61  jobs logs -n {na
+0001b570: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
+0001b580: 7c20 6772 6570 2053 4b59 5049 4c4f 545f  | grep SKYPILOT_
+0001b590: 5441 534b 5f49 4420 7c20 6375 7420 2d64  TASK_ID | cut -d
+0001b5a0: 3a20 2d66 3220 7c20 6772 6570 2022 2452  : -f2 | grep "$R
+0001b5b0: 554e 5f49 4422 272c 0a20 2020 2020 2020  UN_ID"',.       
+0001b5c0: 205d 2c0a 2020 2020 2020 2020 5f4a 4f42   ],.        _JOB
+0001b5d0: 5f43 414e 4345 4c5f 5741 4954 2e66 6f72  _CANCEL_WAIT.for
+0001b5e0: 6d61 7428 6a6f 625f 6e61 6d65 3d6e 616d  mat(job_name=nam
+0001b5f0: 6529 2c0a 2020 2020 2020 2020 7469 6d65  e),.        time
+0001b600: 6f75 743d 3330 202a 2036 302c 0a20 2020  out=30 * 60,.   
+0001b610: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+0001b620: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+0001b630: 6573 742e 6d61 726b 2e67 6370 0a40 7079  est.mark.gcp.@py
+0001b640: 7465 7374 2e6d 6172 6b2e 6d61 6e61 6765  test.mark.manage
+0001b650: 645f 6a6f 6273 0a64 6566 2074 6573 745f  d_jobs.def test_
+0001b660: 6d61 6e61 6765 645f 6a6f 6273 5f72 6563  managed_jobs_rec
+0001b670: 6f76 6572 795f 6d75 6c74 695f 6e6f 6465  overy_multi_node
+0001b680: 5f67 6370 2829 3a0a 2020 2020 2222 2254  _gcp():.    """T
+0001b690: 6573 7420 6d61 6e61 6765 6420 6a6f 6220  est managed job 
+0001b6a0: 7265 636f 7665 7279 2e22 2222 0a20 2020  recovery.""".   
+0001b6b0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+0001b6c0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+0001b6d0: 6e61 6d65 5f6f 6e5f 636c 6f75 6420 3d20  name_on_cloud = 
+0001b6e0: 636f 6d6d 6f6e 5f75 7469 6c73 2e6d 616b  common_utils.mak
+0001b6f0: 655f 636c 7573 7465 725f 6e61 6d65 5f6f  e_cluster_name_o
+0001b700: 6e5f 636c 6f75 6428 0a20 2020 2020 2020  n_cloud(.       
+0001b710: 206e 616d 652c 206a 6f62 732e 4a4f 4253   name, jobs.JOBS
+0001b720: 5f43 4c55 5354 4552 5f4e 414d 455f 5052  _CLUSTER_NAME_PR
+0001b730: 4546 4958 5f4c 454e 4754 482c 2061 6464  EFIX_LENGTH, add
+0001b740: 5f75 7365 725f 6861 7368 3d46 616c 7365  _user_hash=False
+0001b750: 290a 2020 2020 7a6f 6e65 203d 2027 7573  ).    zone = 'us
+0001b760: 2d77 6573 7432 2d61 270a 2020 2020 2320  -west2-a'.    # 
+0001b770: 5573 6520 273a 2720 746f 206d 6174 6368  Use ':' to match
+0001b780: 2061 7320 7468 6520 636c 7573 7465 7220   as the cluster 
+0001b790: 6e61 6d65 2077 696c 6c20 636f 6e74 6169  name will contai
+0001b7a0: 6e20 7468 6520 7375 6666 6978 2077 6974  n the suffix wit
+0001b7b0: 6820 6a6f 6220 6964 0a20 2020 2071 7565  h job id.    que
+0001b7c0: 7279 5f63 6d64 203d 2028 0a20 2020 2020  ry_cmd = (.     
+0001b7d0: 2020 2066 2767 636c 6f75 6420 636f 6d70     f'gcloud comp
+0001b7e0: 7574 6520 696e 7374 616e 6365 7320 6c69  ute instances li
+0001b7f0: 7374 202d 2d66 696c 7465 723d 270a 2020  st --filter='.  
+0001b800: 2020 2020 2020 6627 2228 6c61 6265 6c73        f'"(labels
+0001b810: 2e72 6179 2d63 6c75 7374 6572 2d6e 616d  .ray-cluster-nam
+0001b820: 653a 7b6e 616d 655f 6f6e 5f63 6c6f 7564  e:{name_on_cloud
+0001b830: 7d20 414e 4420 270a 2020 2020 2020 2020  } AND '.        
+0001b840: 6627 6c61 6265 6c73 2e72 6179 2d6e 6f64  f'labels.ray-nod
+0001b850: 652d 7479 7065 3d77 6f72 6b65 7229 2220  e-type=worker)" 
+0001b860: 2d2d 7a6f 6e65 733d 7b7a 6f6e 657d 202d  --zones={zone} -
+0001b870: 2d66 6f72 6d61 743d 2276 616c 7565 286e  -format="value(n
+0001b880: 616d 6529 2227 290a 2020 2020 7465 726d  ame)"').    term
+0001b890: 696e 6174 655f 636d 6420 3d20 2866 2767  inate_cmd = (f'g
+0001b8a0: 636c 6f75 6420 636f 6d70 7574 6520 696e  cloud compute in
+0001b8b0: 7374 616e 6365 7320 6465 6c65 7465 202d  stances delete -
+0001b8c0: 2d7a 6f6e 653d 7b7a 6f6e 657d 270a 2020  -zone={zone}'.  
+0001b8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b8e0: 2020 2066 2720 2d2d 7175 6965 7420 2428     f' --quiet $(
+0001b8f0: 7b71 7565 7279 5f63 6d64 7d29 2729 0a20  {query_cmd})'). 
+0001b900: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+0001b910: 2020 2020 2020 2020 276d 616e 6167 6564          'managed
+0001b920: 5f6a 6f62 735f 7265 636f 7665 7279 5f6d  _jobs_recovery_m
+0001b930: 756c 7469 5f6e 6f64 655f 6763 7027 2c0a  ulti_node_gcp',.
+0001b940: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+0001b950: 2020 2020 2020 6627 736b 7920 6a6f 6273        f'sky jobs
+0001b960: 206c 6175 6e63 6820 2d2d 636c 6f75 6420   launch --cloud 
+0001b970: 6763 7020 2d2d 7a6f 6e65 207b 7a6f 6e65  gcp --zone {zone
+0001b980: 7d20 2d6e 207b 6e61 6d65 7d20 2d2d 7573  } -n {name} --us
+0001b990: 652d 7370 6f74 202d 2d6e 756d 2d6e 6f64  e-spot --num-nod
+0001b9a0: 6573 2032 2022 6563 686f 2053 4b59 5049  es 2 "echo SKYPI
+0001b9b0: 4c4f 545f 5441 534b 5f49 443a 205c 2453  LOT_TASK_ID: \$S
+0001b9c0: 4b59 5049 4c4f 545f 5441 534b 5f49 443b  KYPILOT_TASK_ID;
+0001b9d0: 2073 6c65 6570 2031 3830 3022 2020 2d79   sleep 1800"  -y
+0001b9e0: 202d 6427 2c0a 2020 2020 2020 2020 2020   -d',.          
+0001b9f0: 2020 2773 6c65 6570 2034 3030 272c 0a20    'sleep 400',. 
+0001ba00: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
+0001ba10: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
+0001ba20: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
+0001ba30: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
+0001ba40: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
+0001ba50: 2020 2020 2020 6627 5255 4e5f 4944 3d24        f'RUN_ID=$
+0001ba60: 2873 6b79 206a 6f62 7320 6c6f 6773 202d  (sky jobs logs -
+0001ba70: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
+0001ba80: 6c6c 6f77 207c 2067 7265 7020 534b 5950  llow | grep SKYP
+0001ba90: 494c 4f54 5f54 4153 4b5f 4944 207c 2063  ILOT_TASK_ID | c
+0001baa0: 7574 202d 643a 202d 6632 293b 2065 6368  ut -d: -f2); ech
+0001bab0: 6f20 2224 5255 4e5f 4944 2220 7c20 7465  o "$RUN_ID" | te
+0001bac0: 6520 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  e /tmp/{name}-ru
+0001bad0: 6e2d 6964 272c 0a20 2020 2020 2020 2020  n-id',.         
+0001bae0: 2020 2023 2054 6572 6d69 6e61 7465 2074     # Terminate t
+0001baf0: 6865 2077 6f72 6b65 7220 6d61 6e75 616c  he worker manual
+0001bb00: 6c79 2e0a 2020 2020 2020 2020 2020 2020  ly..            
+0001bb10: 7465 726d 696e 6174 655f 636d 642c 0a20  terminate_cmd,. 
+0001bb20: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0001bb30: 7020 3530 272c 0a20 2020 2020 2020 2020  p 50',.         
+0001bb40: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+0001bb50: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+0001bb60: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+0001bb70: 2067 7265 7020 2252 4543 4f56 4552 494e   grep "RECOVERIN
+0001bb80: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+0001bb90: 2027 736c 6565 7020 3432 3027 2c0a 2020   'sleep 420',.  
+0001bba0: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
+0001bbb0: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
+0001bbc0: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
+0001bbd0: 6420 2d6e 3120 7c20 6772 6570 2022 5255  d -n1 | grep "RU
+0001bbe0: 4e4e 494e 4722 272c 0a20 2020 2020 2020  NNING"',.       
+0001bbf0: 2020 2020 2066 2752 554e 5f49 443d 2428       f'RUN_ID=$(
+0001bc00: 6361 7420 2f74 6d70 2f7b 6e61 6d65 7d2d  cat /tmp/{name}-
+0001bc10: 7275 6e2d 6964 293b 2065 6368 6f20 2452  run-id); echo $R
+0001bc20: 554e 5f49 443b 2073 6b79 206a 6f62 7320  UN_ID; sky jobs 
+0001bc30: 6c6f 6773 202d 6e20 7b6e 616d 657d 202d  logs -n {name} -
+0001bc40: 2d6e 6f2d 666f 6c6c 6f77 207c 2067 7265  -no-follow | gre
+0001bc50: 7020 534b 5950 494c 4f54 5f54 4153 4b5f  p SKYPILOT_TASK_
+0001bc60: 4944 207c 2063 7574 202d 643a 202d 6632  ID | cut -d: -f2
+0001bc70: 207c 2067 7265 7020 2224 5255 4e5f 4944   | grep "$RUN_ID
+0001bc80: 2227 2c0a 2020 2020 2020 2020 5d2c 0a20  "',.        ],. 
+0001bc90: 2020 2020 2020 205f 4a4f 425f 4341 4e43         _JOB_CANC
+0001bca0: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
+0001bcb0: 6f62 5f6e 616d 653d 6e61 6d65 292c 0a20  ob_name=name),. 
+0001bcc0: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+0001bcd0: 3520 2a20 3630 2c0a 2020 2020 290a 2020  5 * 60,.    ).  
+0001bce0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0001bcf0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+0001bd00: 6172 6b2e 6177 730a 4070 7974 6573 742e  ark.aws.@pytest.
+0001bd10: 6d61 726b 2e6d 616e 6167 6564 5f6a 6f62  mark.managed_job
+0001bd20: 730a 6465 6620 7465 7374 5f6d 616e 6167  s.def test_manag
+0001bd30: 6564 5f6a 6f62 735f 6361 6e63 656c 6c61  ed_jobs_cancella
+0001bd40: 7469 6f6e 5f61 7773 2861 7773 5f63 6f6e  tion_aws(aws_con
+0001bd50: 6669 675f 7265 6769 6f6e 293a 0a20 2020  fig_region):.   
+0001bd60: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+0001bd70: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+0001bd80: 6e61 6d65 5f6f 6e5f 636c 6f75 6420 3d20  name_on_cloud = 
+0001bd90: 636f 6d6d 6f6e 5f75 7469 6c73 2e6d 616b  common_utils.mak
+0001bda0: 655f 636c 7573 7465 725f 6e61 6d65 5f6f  e_cluster_name_o
+0001bdb0: 6e5f 636c 6f75 6428 0a20 2020 2020 2020  n_cloud(.       
+0001bdc0: 206e 616d 652c 206a 6f62 732e 4a4f 4253   name, jobs.JOBS
+0001bdd0: 5f43 4c55 5354 4552 5f4e 414d 455f 5052  _CLUSTER_NAME_PR
+0001bde0: 4546 4958 5f4c 454e 4754 482c 2061 6464  EFIX_LENGTH, add
+0001bdf0: 5f75 7365 725f 6861 7368 3d46 616c 7365  _user_hash=False
+0001be00: 290a 2020 2020 6e61 6d65 5f32 5f6f 6e5f  ).    name_2_on_
+0001be10: 636c 6f75 6420 3d20 636f 6d6d 6f6e 5f75  cloud = common_u
+0001be20: 7469 6c73 2e6d 616b 655f 636c 7573 7465  tils.make_cluste
+0001be30: 725f 6e61 6d65 5f6f 6e5f 636c 6f75 6428  r_name_on_cloud(
+0001be40: 0a20 2020 2020 2020 2066 277b 6e61 6d65  .        f'{name
+0001be50: 7d2d 3227 2c20 6a6f 6273 2e4a 4f42 535f  }-2', jobs.JOBS_
+0001be60: 434c 5553 5445 525f 4e41 4d45 5f50 5245  CLUSTER_NAME_PRE
+0001be70: 4649 585f 4c45 4e47 5448 2c20 6164 645f  FIX_LENGTH, add_
+0001be80: 7573 6572 5f68 6173 683d 4661 6c73 6529  user_hash=False)
+0001be90: 0a20 2020 206e 616d 655f 335f 6f6e 5f63  .    name_3_on_c
+0001bea0: 6c6f 7564 203d 2063 6f6d 6d6f 6e5f 7574  loud = common_ut
+0001beb0: 696c 732e 6d61 6b65 5f63 6c75 7374 6572  ils.make_cluster
+0001bec0: 5f6e 616d 655f 6f6e 5f63 6c6f 7564 280a  _name_on_cloud(.
+0001bed0: 2020 2020 2020 2020 6627 7b6e 616d 657d          f'{name}
+0001bee0: 2d33 272c 206a 6f62 732e 4a4f 4253 5f43  -3', jobs.JOBS_C
+0001bef0: 4c55 5354 4552 5f4e 414d 455f 5052 4546  LUSTER_NAME_PREF
+0001bf00: 4958 5f4c 454e 4754 482c 2061 6464 5f75  IX_LENGTH, add_u
+0001bf10: 7365 725f 6861 7368 3d46 616c 7365 290a  ser_hash=False).
+0001bf20: 2020 2020 7265 6769 6f6e 203d 2061 7773      region = aws
+0001bf30: 5f63 6f6e 6669 675f 7265 6769 6f6e 0a20  _config_region. 
+0001bf40: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+0001bf50: 2020 2020 2020 2020 276d 616e 6167 6564          'managed
+0001bf60: 5f6a 6f62 735f 6361 6e63 656c 6c61 7469  _jobs_cancellati
+0001bf70: 6f6e 5f61 7773 272c 0a20 2020 2020 2020  on_aws',.       
+0001bf80: 205b 0a20 2020 2020 2020 2020 2020 2023   [.            #
+0001bf90: 2054 6573 7420 6361 6e63 656c 6c61 7469   Test cancellati
+0001bfa0: 6f6e 2064 7572 696e 6720 7370 6f74 2063  on during spot c
+0001bfb0: 6c75 7374 6572 2062 6569 6e67 206c 6175  luster being lau
+0001bfc0: 6e63 6865 642e 0a20 2020 2020 2020 2020  nched..         
+0001bfd0: 2020 2066 2773 6b79 206a 6f62 7320 6c61     f'sky jobs la
+0001bfe0: 756e 6368 202d 2d63 6c6f 7564 2061 7773  unch --cloud aws
+0001bff0: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+0001c000: 6e7d 202d 6e20 7b6e 616d 657d 202d 2d75  n} -n {name} --u
+0001c010: 7365 2d73 706f 7420 2273 6c65 6570 2031  se-spot "sleep 1
+0001c020: 3030 3022 2020 2d79 202d 6427 2c0a 2020  000"  -y -d',.  
+0001c030: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001c040: 2036 3027 2c0a 2020 2020 2020 2020 2020   60',.          
+0001c050: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
+0001c060: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
+0001c070: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
+0001c080: 6772 6570 2022 5354 4152 5449 4e47 2227  grep "STARTING"'
+0001c090: 2c0a 2020 2020 2020 2020 2020 2020 5f4a  ,.            _J
+0001c0a0: 4f42 5f43 414e 4345 4c5f 5741 4954 2e66  OB_CANCEL_WAIT.f
+0001c0b0: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d6e  ormat(job_name=n
+0001c0c0: 616d 6529 2c0a 2020 2020 2020 2020 2020  ame),.          
+0001c0d0: 2020 2773 6c65 6570 2035 272c 0a20 2020    'sleep 5',.   
+0001c0e0: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
+0001c0f0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+0001c100: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
+0001c110: 202d 6e31 207c 2067 7265 7020 2243 414e   -n1 | grep "CAN
+0001c120: 4345 4c4c 494e 475c 7c43 414e 4345 4c4c  CELLING\|CANCELL
+0001c130: 4544 2227 2c0a 2020 2020 2020 2020 2020  ED"',.          
+0001c140: 2020 2773 6c65 6570 2031 3230 272c 0a20    'sleep 120',. 
+0001c150: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
+0001c160: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
+0001c170: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
+0001c180: 6164 202d 6e31 207c 2067 7265 7020 2243  ad -n1 | grep "C
+0001c190: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
+0001c1a0: 2020 2020 2020 2020 2866 2773 3d24 2861          (f's=$(a
+0001c1b0: 7773 2065 6332 2064 6573 6372 6962 652d  ws ec2 describe-
+0001c1c0: 696e 7374 616e 6365 7320 2d2d 7265 6769  instances --regi
+0001c1d0: 6f6e 207b 7265 6769 6f6e 7d20 270a 2020  on {region} '.  
+0001c1e0: 2020 2020 2020 2020 2020 2066 272d 2d66             f'--f
+0001c1f0: 696c 7465 7273 204e 616d 653d 7461 673a  ilters Name=tag:
+0001c200: 7261 792d 636c 7573 7465 722d 6e61 6d65  ray-cluster-name
+0001c210: 2c56 616c 7565 733d 7b6e 616d 655f 6f6e  ,Values={name_on
+0001c220: 5f63 6c6f 7564 7d2d 2a20 270a 2020 2020  _cloud}-* '.    
+0001c230: 2020 2020 2020 2020 2066 272d 2d71 7565           f'--que
+0001c240: 7279 2052 6573 6572 7661 7469 6f6e 735b  ry Reservations[
+0001c250: 5d2e 496e 7374 616e 6365 735b 5d2e 5374  ].Instances[].St
+0001c260: 6174 655b 5d2e 4e61 6d65 2027 0a20 2020  ate[].Name '.   
+0001c270: 2020 2020 2020 2020 2020 272d 2d6f 7574            '--out
+0001c280: 7075 7420 7465 7874 2920 2626 2065 6368  put text) && ech
+0001c290: 6f20 2224 7322 2026 2620 6563 686f 3b20  o "$s" && echo; 
+0001c2a0: 5b5b 202d 7a20 2224 7322 205d 5d20 7c7c  [[ -z "$s" ]] ||
+0001c2b0: 205b 5b20 2224 7322 203d 2022 7465 726d   [[ "$s" = "term
+0001c2c0: 696e 6174 6564 2220 5d5d 207c 7c20 5b5b  inated" ]] || [[
+0001c2d0: 2022 2473 2220 3d20 2273 6875 7474 696e   "$s" = "shuttin
+0001c2e0: 672d 646f 776e 2220 5d5d 270a 2020 2020  g-down" ]]'.    
+0001c2f0: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
+0001c300: 2020 2020 2020 2023 2054 6573 7420 6361         # Test ca
+0001c310: 6e63 656c 6c69 6e67 2074 6865 2073 706f  ncelling the spo
+0001c320: 7420 636c 7573 7465 7220 6475 7269 6e67  t cluster during
+0001c330: 2073 706f 7420 6a6f 6220 6265 696e 6720   spot job being 
+0001c340: 7365 7475 702e 0a20 2020 2020 2020 2020  setup..         
+0001c350: 2020 2066 2773 6b79 206a 6f62 7320 6c61     f'sky jobs la
+0001c360: 756e 6368 202d 2d63 6c6f 7564 2061 7773  unch --cloud aws
+0001c370: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+0001c380: 6e7d 202d 6e20 7b6e 616d 657d 2d32 202d  n} -n {name}-2 -
+0001c390: 2d75 7365 2d73 706f 7420 7465 7374 732f  -use-spot tests/
+0001c3a0: 7465 7374 5f79 616d 6c73 2f74 6573 745f  test_yamls/test_
+0001c3b0: 6c6f 6e67 5f73 6574 7570 2e79 616d 6c20  long_setup.yaml 
+0001c3c0: 202d 7920 2d64 272c 0a20 2020 2020 2020   -y -d',.       
+0001c3d0: 2020 2020 2027 736c 6565 7020 3330 3027       'sleep 300'
+0001c3e0: 2c0a 2020 2020 2020 2020 2020 2020 5f4a  ,.            _J
+0001c3f0: 4f42 5f43 414e 4345 4c5f 5741 4954 2e66  OB_CANCEL_WAIT.f
+0001c400: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d66  ormat(job_name=f
+0001c410: 277b 6e61 6d65 7d2d 3227 292c 0a20 2020  '{name}-2'),.   
+0001c420: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001c430: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
+0001c440: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
+0001c450: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+0001c460: 2d32 207c 2068 6561 6420 2d6e 3120 7c20  -2 | head -n1 | 
+0001c470: 6772 6570 2022 4341 4e43 454c 4c49 4e47  grep "CANCELLING
+0001c480: 5c7c 4341 4e43 454c 4c45 4422 272c 0a20  \|CANCELLED"',. 
+0001c490: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0001c4a0: 7020 3132 3027 2c0a 2020 2020 2020 2020  p 120',.        
+0001c4b0: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+0001c4c0: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001c4d0: 616d 657d 2d32 207c 2068 6561 6420 2d6e  ame}-2 | head -n
+0001c4e0: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
+0001c4f0: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
+0001c500: 2020 2028 6627 733d 2428 6177 7320 6563     (f's=$(aws ec
+0001c510: 3220 6465 7363 7269 6265 2d69 6e73 7461  2 describe-insta
+0001c520: 6e63 6573 202d 2d72 6567 696f 6e20 7b72  nces --region {r
+0001c530: 6567 696f 6e7d 2027 0a20 2020 2020 2020  egion} '.       
+0001c540: 2020 2020 2020 6627 2d2d 6669 6c74 6572        f'--filter
+0001c550: 7320 4e61 6d65 3d74 6167 3a72 6179 2d63  s Name=tag:ray-c
+0001c560: 6c75 7374 6572 2d6e 616d 652c 5661 6c75  luster-name,Valu
+0001c570: 6573 3d7b 6e61 6d65 5f32 5f6f 6e5f 636c  es={name_2_on_cl
+0001c580: 6f75 647d 2d2a 2027 0a20 2020 2020 2020  oud}-* '.       
+0001c590: 2020 2020 2020 6627 2d2d 7175 6572 7920        f'--query 
+0001c5a0: 5265 7365 7276 6174 696f 6e73 5b5d 2e49  Reservations[].I
+0001c5b0: 6e73 7461 6e63 6573 5b5d 2e53 7461 7465  nstances[].State
+0001c5c0: 5b5d 2e4e 616d 6520 270a 2020 2020 2020  [].Name '.      
+0001c5d0: 2020 2020 2020 2027 2d2d 6f75 7470 7574         '--output
+0001c5e0: 2074 6578 7429 2026 2620 6563 686f 2022   text) && echo "
+0001c5f0: 2473 2220 2626 2065 6368 6f3b 205b 5b20  $s" && echo; [[ 
+0001c600: 2d7a 2022 2473 2220 5d5d 207c 7c20 5b5b  -z "$s" ]] || [[
+0001c610: 2022 2473 2220 3d20 2274 6572 6d69 6e61   "$s" = "termina
+0001c620: 7465 6422 205d 5d20 7c7c 205b 5b20 2224  ted" ]] || [[ "$
+0001c630: 7322 203d 2022 7368 7574 7469 6e67 2d64  s" = "shutting-d
+0001c640: 6f77 6e22 205d 5d27 0a20 2020 2020 2020  own" ]]'.       
+0001c650: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+0001c660: 2020 2020 2320 5465 7374 2063 616e 6365      # Test cance
+0001c670: 6c6c 6174 696f 6e20 6475 7269 6e67 2073  llation during s
+0001c680: 706f 7420 6a6f 6220 6973 2072 6563 6f76  pot job is recov
+0001c690: 6572 696e 672e 0a20 2020 2020 2020 2020  ering..         
+0001c6a0: 2020 2066 2773 6b79 206a 6f62 7320 6c61     f'sky jobs la
+0001c6b0: 756e 6368 202d 2d63 6c6f 7564 2061 7773  unch --cloud aws
+0001c6c0: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+0001c6d0: 6e7d 202d 6e20 7b6e 616d 657d 2d33 202d  n} -n {name}-3 -
+0001c6e0: 2d75 7365 2d73 706f 7420 2273 6c65 6570  -use-spot "sleep
+0001c6f0: 2031 3030 3022 2020 2d79 202d 6427 2c0a   1000"  -y -d',.
+0001c700: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0001c710: 6570 2033 3030 272c 0a20 2020 2020 2020  ep 300',.       
+0001c720: 2020 2020 2066 277b 5f4a 4f42 5f51 5545       f'{_JOB_QUE
+0001c730: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+0001c740: 6e61 6d65 7d2d 3320 7c20 6865 6164 202d  name}-3 | head -
+0001c750: 6e31 207c 2067 7265 7020 2252 554e 4e49  n1 | grep "RUNNI
+0001c760: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
+0001c770: 2020 2320 5465 726d 696e 6174 6520 7468    # Terminate th
+0001c780: 6520 636c 7573 7465 7220 6d61 6e75 616c  e cluster manual
+0001c790: 6c79 2e0a 2020 2020 2020 2020 2020 2020  ly..            
+0001c7a0: 2866 2761 7773 2065 6332 2074 6572 6d69  (f'aws ec2 termi
+0001c7b0: 6e61 7465 2d69 6e73 7461 6e63 6573 202d  nate-instances -
+0001c7c0: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
+0001c7d0: 202d 2d69 6e73 7461 6e63 652d 6964 7320   --instance-ids 
+0001c7e0: 2428 270a 2020 2020 2020 2020 2020 2020  $('.            
+0001c7f0: 2066 2761 7773 2065 6332 2064 6573 6372   f'aws ec2 descr
+0001c800: 6962 652d 696e 7374 616e 6365 7320 2d2d  ibe-instances --
+0001c810: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
+0001c820: 270a 2020 2020 2020 2020 2020 2020 2066  '.             f
+0001c830: 272d 2d66 696c 7465 7273 204e 616d 653d  '--filters Name=
+0001c840: 7461 673a 7261 792d 636c 7573 7465 722d  tag:ray-cluster-
+0001c850: 6e61 6d65 2c56 616c 7565 733d 7b6e 616d  name,Values={nam
+0001c860: 655f 335f 6f6e 5f63 6c6f 7564 7d2d 2a20  e_3_on_cloud}-* 
+0001c870: 270a 2020 2020 2020 2020 2020 2020 2066  '.             f
+0001c880: 272d 2d71 7565 7279 2052 6573 6572 7661  '--query Reserva
+0001c890: 7469 6f6e 735b 5d2e 496e 7374 616e 6365  tions[].Instance
+0001c8a0: 735b 5d2e 496e 7374 616e 6365 4964 2027  s[].InstanceId '
+0001c8b0: 0a20 2020 2020 2020 2020 2020 2020 272d  .             '-
+0001c8c0: 2d6f 7574 7075 7420 7465 7874 2927 292c  -output text)'),
+0001c8d0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0001c8e0: 6565 7020 3132 3027 2c0a 2020 2020 2020  eep 120',.      
+0001c8f0: 2020 2020 2020 6627 7b5f 4a4f 425f 5155        f'{_JOB_QU
+0001c900: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+0001c910: 7b6e 616d 657d 2d33 207c 2068 6561 6420  {name}-3 | head 
+0001c920: 2d6e 3120 7c20 6772 6570 2022 5245 434f  -n1 | grep "RECO
+0001c930: 5645 5249 4e47 2227 2c0a 2020 2020 2020  VERING"',.      
+0001c940: 2020 2020 2020 5f4a 4f42 5f43 414e 4345        _JOB_CANCE
+0001c950: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+0001c960: 625f 6e61 6d65 3d66 277b 6e61 6d65 7d2d  b_name=f'{name}-
+0001c970: 3327 292c 0a20 2020 2020 2020 2020 2020  3'),.           
+0001c980: 2027 736c 6565 7020 3527 2c0a 2020 2020   'sleep 5',.    
+0001c990: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
+0001c9a0: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+0001c9b0: 7020 7b6e 616d 657d 2d33 207c 2068 6561  p {name}-3 | hea
+0001c9c0: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
+0001c9d0: 4e43 454c 4c49 4e47 5c7c 4341 4e43 454c  NCELLING\|CANCEL
+0001c9e0: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
+0001c9f0: 2020 2027 736c 6565 7020 3132 3027 2c0a     'sleep 120',.
+0001ca00: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+0001ca10: 4a4f 425f 5155 4555 455f 5741 4954 7d7c  JOB_QUEUE_WAIT}|
+0001ca20: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
+0001ca30: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+0001ca40: 2022 4341 4e43 454c 4c45 4422 272c 0a20   "CANCELLED"',. 
+0001ca50: 2020 2020 2020 2020 2020 2023 2054 6865             # The
+0001ca60: 2063 6c75 7374 6572 2073 686f 756c 6420   cluster should 
+0001ca70: 6265 2074 6572 6d69 6e61 7465 6420 2873  be terminated (s
+0001ca80: 6875 7474 696e 672d 646f 776e 2920 6166  hutting-down) af
+0001ca90: 7465 7220 6361 6e63 656c 6c61 7469 6f6e  ter cancellation
+0001caa0: 2e20 5765 2064 6f6e 2774 2075 7365 2074  . We don't use t
+0001cab0: 6865 2060 3d60 206f 7065 7261 746f 7220  he `=` operator 
+0001cac0: 6865 7265 2062 6563 6175 7365 0a20 2020  here because.   
+0001cad0: 2020 2020 2020 2020 2023 2074 6865 7265           # there
+0001cae0: 2063 616e 2062 6520 6d75 6c74 6970 6c65   can be multiple
+0001caf0: 2056 4d20 7769 7468 2074 6865 2073 616d   VM with the sam
+0001cb00: 6520 6e61 6d65 2064 7565 2074 6f20 7468  e name due to th
+0001cb10: 6520 7265 636f 7665 7279 2e0a 2020 2020  e recovery..    
+0001cb20: 2020 2020 2020 2020 2866 2773 3d24 2861          (f's=$(a
+0001cb30: 7773 2065 6332 2064 6573 6372 6962 652d  ws ec2 describe-
+0001cb40: 696e 7374 616e 6365 7320 2d2d 7265 6769  instances --regi
+0001cb50: 6f6e 207b 7265 6769 6f6e 7d20 270a 2020  on {region} '.  
+0001cb60: 2020 2020 2020 2020 2020 2066 272d 2d66             f'--f
+0001cb70: 696c 7465 7273 204e 616d 653d 7461 673a  ilters Name=tag:
+0001cb80: 7261 792d 636c 7573 7465 722d 6e61 6d65  ray-cluster-name
+0001cb90: 2c56 616c 7565 733d 7b6e 616d 655f 335f  ,Values={name_3_
+0001cba0: 6f6e 5f63 6c6f 7564 7d2d 2a20 270a 2020  on_cloud}-* '.  
+0001cbb0: 2020 2020 2020 2020 2020 2066 272d 2d71             f'--q
+0001cbc0: 7565 7279 2052 6573 6572 7661 7469 6f6e  uery Reservation
+0001cbd0: 735b 5d2e 496e 7374 616e 6365 735b 5d2e  s[].Instances[].
+0001cbe0: 5374 6174 655b 5d2e 4e61 6d65 2027 0a20  State[].Name '. 
+0001cbf0: 2020 2020 2020 2020 2020 2020 272d 2d6f              '--o
+0001cc00: 7574 7075 7420 7465 7874 2920 2626 2065  utput text) && e
+0001cc10: 6368 6f20 2224 7322 2026 2620 6563 686f  cho "$s" && echo
+0001cc20: 3b20 5b5b 202d 7a20 2224 7322 205d 5d20  ; [[ -z "$s" ]] 
+0001cc30: 7c7c 2065 6368 6f20 2224 7322 207c 2067  || echo "$s" | g
+0001cc40: 7265 7020 2d76 202d 4520 2270 656e 6469  rep -v -E "pendi
+0001cc50: 6e67 7c72 756e 6e69 6e67 7c73 746f 7070  ng|running|stopp
+0001cc60: 6564 7c73 746f 7070 696e 6722 270a 2020  ed|stopping"'.  
+0001cc70: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+0001cc80: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+0001cc90: 7469 6d65 6f75 743d 3235 202a 2036 3029  timeout=25 * 60)
+0001cca0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+0001ccb0: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+0001ccc0: 742e 6d61 726b 2e67 6370 0a40 7079 7465  t.mark.gcp.@pyte
+0001ccd0: 7374 2e6d 6172 6b2e 6d61 6e61 6765 645f  st.mark.managed_
+0001cce0: 6a6f 6273 0a64 6566 2074 6573 745f 6d61  jobs.def test_ma
+0001ccf0: 6e61 6765 645f 6a6f 6273 5f63 616e 6365  naged_jobs_cance
+0001cd00: 6c6c 6174 696f 6e5f 6763 7028 293a 0a20  llation_gcp():. 
+0001cd10: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+0001cd20: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+0001cd30: 2020 6e61 6d65 5f33 203d 2066 277b 6e61    name_3 = f'{na
+0001cd40: 6d65 7d2d 3327 0a20 2020 206e 616d 655f  me}-3'.    name_
+0001cd50: 335f 6f6e 5f63 6c6f 7564 203d 2063 6f6d  3_on_cloud = com
+0001cd60: 6d6f 6e5f 7574 696c 732e 6d61 6b65 5f63  mon_utils.make_c
+0001cd70: 6c75 7374 6572 5f6e 616d 655f 6f6e 5f63  luster_name_on_c
+0001cd80: 6c6f 7564 280a 2020 2020 2020 2020 6e61  loud(.        na
+0001cd90: 6d65 5f33 2c20 6a6f 6273 2e4a 4f42 535f  me_3, jobs.JOBS_
+0001cda0: 434c 5553 5445 525f 4e41 4d45 5f50 5245  CLUSTER_NAME_PRE
+0001cdb0: 4649 585f 4c45 4e47 5448 2c20 6164 645f  FIX_LENGTH, add_
+0001cdc0: 7573 6572 5f68 6173 683d 4661 6c73 6529  user_hash=False)
+0001cdd0: 0a20 2020 207a 6f6e 6520 3d20 2775 732d  .    zone = 'us-
+0001cde0: 7765 7374 332d 6227 0a20 2020 2071 7565  west3-b'.    que
+0001cdf0: 7279 5f73 7461 7465 5f63 6d64 203d 2028  ry_state_cmd = (
+0001ce00: 0a20 2020 2020 2020 2027 6763 6c6f 7564  .        'gcloud
+0001ce10: 2063 6f6d 7075 7465 2069 6e73 7461 6e63   compute instanc
+0001ce20: 6573 206c 6973 7420 270a 2020 2020 2020  es list '.      
+0001ce30: 2020 6627 2d2d 6669 6c74 6572 3d22 286c    f'--filter="(l
+0001ce40: 6162 656c 732e 7261 792d 636c 7573 7465  abels.ray-cluste
+0001ce50: 722d 6e61 6d65 3a7b 6e61 6d65 5f33 5f6f  r-name:{name_3_o
+0001ce60: 6e5f 636c 6f75 647d 2922 2027 0a20 2020  n_cloud})" '.   
+0001ce70: 2020 2020 2027 2d2d 666f 726d 6174 3d22       '--format="
+0001ce80: 7661 6c75 6528 7374 6174 7573 2922 2729  value(status)"')
+0001ce90: 0a20 2020 2071 7565 7279 5f63 6d64 203d  .    query_cmd =
+0001cea0: 2028 6627 6763 6c6f 7564 2063 6f6d 7075   (f'gcloud compu
+0001ceb0: 7465 2069 6e73 7461 6e63 6573 206c 6973  te instances lis
+0001cec0: 7420 2d2d 6669 6c74 6572 3d27 0a20 2020  t --filter='.   
+0001ced0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0001cee0: 2228 6c61 6265 6c73 2e72 6179 2d63 6c75  "(labels.ray-clu
+0001cef0: 7374 6572 2d6e 616d 653a 7b6e 616d 655f  ster-name:{name_
+0001cf00: 335f 6f6e 5f63 6c6f 7564 7d29 2220 270a  3_on_cloud})" '.
+0001cf10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cf20: 2066 272d 2d7a 6f6e 6573 3d7b 7a6f 6e65   f'--zones={zone
+0001cf30: 7d20 2d2d 666f 726d 6174 3d22 7661 6c75  } --format="valu
+0001cf40: 6528 6e61 6d65 2922 2729 0a20 2020 2074  e(name)"').    t
+0001cf50: 6572 6d69 6e61 7465 5f63 6d64 203d 2028  erminate_cmd = (
+0001cf60: 6627 6763 6c6f 7564 2063 6f6d 7075 7465  f'gcloud compute
+0001cf70: 2069 6e73 7461 6e63 6573 2064 656c 6574   instances delet
+0001cf80: 6520 2d2d 7a6f 6e65 3d7b 7a6f 6e65 7d27  e --zone={zone}'
+0001cf90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cfa0: 2020 2020 2020 6627 202d 2d71 7569 6574        f' --quiet
+0001cfb0: 2024 287b 7175 6572 795f 636d 647d 2927   $({query_cmd})'
+0001cfc0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+0001cfd0: 7428 0a20 2020 2020 2020 2027 6d61 6e61  t(.        'mana
+0001cfe0: 6765 645f 6a6f 6273 5f63 616e 6365 6c6c  ged_jobs_cancell
+0001cff0: 6174 696f 6e5f 6763 7027 2c0a 2020 2020  ation_gcp',.    
+0001d000: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+0001d010: 2020 2320 5465 7374 2063 616e 6365 6c6c    # Test cancell
+0001d020: 6174 696f 6e20 6475 7269 6e67 2073 706f  ation during spo
+0001d030: 7420 636c 7573 7465 7220 6265 696e 6720  t cluster being 
+0001d040: 6c61 756e 6368 6564 2e0a 2020 2020 2020  launched..      
+0001d050: 2020 2020 2020 6627 736b 7920 6a6f 6273        f'sky jobs
+0001d060: 206c 6175 6e63 6820 2d2d 636c 6f75 6420   launch --cloud 
+0001d070: 6763 7020 2d2d 7a6f 6e65 207b 7a6f 6e65  gcp --zone {zone
+0001d080: 7d20 2d6e 207b 6e61 6d65 7d20 2d2d 7573  } -n {name} --us
+0001d090: 652d 7370 6f74 2022 736c 6565 7020 3130  e-spot "sleep 10
+0001d0a0: 3030 2220 202d 7920 2d64 272c 0a20 2020  00"  -y -d',.   
+0001d0b0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001d0c0: 3630 272c 0a20 2020 2020 2020 2020 2020  60',.           
+0001d0d0: 2066 277b 5f4a 4f42 5f51 5545 5545 5f57   f'{_JOB_QUEUE_W
+0001d0e0: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+0001d0f0: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
+0001d100: 7265 7020 2253 5441 5254 494e 4722 272c  rep "STARTING"',
+0001d110: 0a20 2020 2020 2020 2020 2020 205f 4a4f  .            _JO
+0001d120: 425f 4341 4e43 454c 5f57 4149 542e 666f  B_CANCEL_WAIT.fo
+0001d130: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
+0001d140: 6d65 292c 0a20 2020 2020 2020 2020 2020  me),.           
+0001d150: 2027 736c 6565 7020 3527 2c0a 2020 2020   'sleep 5',.    
+0001d160: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
+0001d170: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+0001d180: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
+0001d190: 2d6e 3120 7c20 6772 6570 2022 4341 4e43  -n1 | grep "CANC
+0001d1a0: 454c 4c49 4e47 5c7c 4341 4e43 454c 4c45  ELLING\|CANCELLE
+0001d1b0: 4422 272c 0a20 2020 2020 2020 2020 2020  D"',.           
+0001d1c0: 2027 736c 6565 7020 3132 3027 2c0a 2020   'sleep 120',.  
+0001d1d0: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
+0001d1e0: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
+0001d1f0: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
+0001d200: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
+0001d210: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
+0001d220: 2020 2020 2020 2023 2054 6573 7420 6361         # Test ca
+0001d230: 6e63 656c 6c69 6e67 2074 6865 2073 706f  ncelling the spo
+0001d240: 7420 636c 7573 7465 7220 6475 7269 6e67  t cluster during
+0001d250: 2073 706f 7420 6a6f 6220 6265 696e 6720   spot job being 
+0001d260: 7365 7475 702e 0a20 2020 2020 2020 2020  setup..         
+0001d270: 2020 2066 2773 6b79 206a 6f62 7320 6c61     f'sky jobs la
+0001d280: 756e 6368 202d 2d63 6c6f 7564 2067 6370  unch --cloud gcp
+0001d290: 202d 2d7a 6f6e 6520 7b7a 6f6e 657d 202d   --zone {zone} -
+0001d2a0: 6e20 7b6e 616d 657d 2d32 202d 2d75 7365  n {name}-2 --use
+0001d2b0: 2d73 706f 7420 7465 7374 732f 7465 7374  -spot tests/test
+0001d2c0: 5f79 616d 6c73 2f74 6573 745f 6c6f 6e67  _yamls/test_long
+0001d2d0: 5f73 6574 7570 2e79 616d 6c20 202d 7920  _setup.yaml  -y 
+0001d2e0: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
+0001d2f0: 2027 736c 6565 7020 3330 3027 2c0a 2020   'sleep 300',.  
+0001d300: 2020 2020 2020 2020 2020 5f4a 4f42 5f43            _JOB_C
+0001d310: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
+0001d320: 7428 6a6f 625f 6e61 6d65 3d66 277b 6e61  t(job_name=f'{na
+0001d330: 6d65 7d2d 3227 292c 0a20 2020 2020 2020  me}-2'),.       
+0001d340: 2020 2020 2027 736c 6565 7020 3527 2c0a       'sleep 5',.
+0001d350: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+0001d360: 4a4f 425f 5155 4555 455f 5741 4954 7d7c  JOB_QUEUE_WAIT}|
+0001d370: 2067 7265 7020 7b6e 616d 657d 2d32 207c   grep {name}-2 |
+0001d380: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+0001d390: 2022 4341 4e43 454c 4c49 4e47 5c7c 4341   "CANCELLING\|CA
+0001d3a0: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
+0001d3b0: 2020 2020 2020 2027 736c 6565 7020 3132         'sleep 12
+0001d3c0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+0001d3d0: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
+0001d3e0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+0001d3f0: 2d32 207c 2068 6561 6420 2d6e 3120 7c20  -2 | head -n1 | 
+0001d400: 6772 6570 2022 4341 4e43 454c 4c45 4422  grep "CANCELLED"
+0001d410: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+0001d420: 2054 6573 7420 6361 6e63 656c 6c61 7469   Test cancellati
+0001d430: 6f6e 2064 7572 696e 6720 7370 6f74 206a  on during spot j
+0001d440: 6f62 2069 7320 7265 636f 7665 7269 6e67  ob is recovering
+0001d450: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+0001d460: 736b 7920 6a6f 6273 206c 6175 6e63 6820  sky jobs launch 
+0001d470: 2d2d 636c 6f75 6420 6763 7020 2d2d 7a6f  --cloud gcp --zo
+0001d480: 6e65 207b 7a6f 6e65 7d20 2d6e 207b 6e61  ne {zone} -n {na
+0001d490: 6d65 7d2d 3320 2d2d 7573 652d 7370 6f74  me}-3 --use-spot
+0001d4a0: 2022 736c 6565 7020 3130 3030 2220 202d   "sleep 1000"  -
+0001d4b0: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
+0001d4c0: 2020 2027 736c 6565 7020 3330 3027 2c0a     'sleep 300',.
+0001d4d0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+0001d4e0: 4a4f 425f 5155 4555 455f 5741 4954 7d7c  JOB_QUEUE_WAIT}|
+0001d4f0: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
+0001d500: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+0001d510: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
+0001d520: 2020 2020 2020 2020 2023 2054 6572 6d69           # Termi
+0001d530: 6e61 7465 2074 6865 2063 6c75 7374 6572  nate the cluster
+0001d540: 206d 616e 7561 6c6c 792e 0a20 2020 2020   manually..     
+0001d550: 2020 2020 2020 2074 6572 6d69 6e61 7465         terminate
+0001d560: 5f63 6d64 2c0a 2020 2020 2020 2020 2020  _cmd,.          
+0001d570: 2020 2773 6c65 6570 2038 3027 2c0a 2020    'sleep 80',.  
+0001d580: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
+0001d590: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
+0001d5a0: 7265 7020 7b6e 616d 657d 2d33 207c 2068  rep {name}-3 | h
+0001d5b0: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
+0001d5c0: 5245 434f 5645 5249 4e47 2227 2c0a 2020  RECOVERING"',.  
+0001d5d0: 2020 2020 2020 2020 2020 5f4a 4f42 5f43            _JOB_C
+0001d5e0: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
+0001d5f0: 7428 6a6f 625f 6e61 6d65 3d66 277b 6e61  t(job_name=f'{na
+0001d600: 6d65 7d2d 3327 292c 0a20 2020 2020 2020  me}-3'),.       
+0001d610: 2020 2020 2027 736c 6565 7020 3527 2c0a       'sleep 5',.
+0001d620: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+0001d630: 4a4f 425f 5155 4555 455f 5741 4954 7d7c  JOB_QUEUE_WAIT}|
+0001d640: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
+0001d650: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+0001d660: 2022 4341 4e43 454c 4c49 4e47 5c7c 4341   "CANCELLING\|CA
+0001d670: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
+0001d680: 2020 2020 2020 2027 736c 6565 7020 3132         'sleep 12
+0001d690: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+0001d6a0: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
+0001d6b0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+0001d6c0: 2d33 207c 2068 6561 6420 2d6e 3120 7c20  -3 | head -n1 | 
+0001d6d0: 6772 6570 2022 4341 4e43 454c 4c45 4422  grep "CANCELLED"
+0001d6e0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+0001d6f0: 2054 6865 2063 6c75 7374 6572 2073 686f   The cluster sho
+0001d700: 756c 6420 6265 2074 6572 6d69 6e61 7465  uld be terminate
+0001d710: 6420 2853 544f 5050 494e 4729 2061 6674  d (STOPPING) aft
+0001d720: 6572 2063 616e 6365 6c6c 6174 696f 6e2e  er cancellation.
+0001d730: 2057 6520 646f 6e27 7420 7573 6520 7468   We don't use th
+0001d740: 6520 603d 6020 6f70 6572 6174 6f72 2068  e `=` operator h
+0001d750: 6572 6520 6265 6361 7573 650a 2020 2020  ere because.    
+0001d760: 2020 2020 2020 2020 2320 7468 6572 6520          # there 
+0001d770: 6361 6e20 6265 206d 756c 7469 706c 6520  can be multiple 
+0001d780: 564d 2077 6974 6820 7468 6520 7361 6d65  VM with the same
+0001d790: 206e 616d 6520 6475 6520 746f 2074 6865   name due to the
+0001d7a0: 2072 6563 6f76 6572 792e 0a20 2020 2020   recovery..     
+0001d7b0: 2020 2020 2020 2028 6627 733d 2428 7b71         (f's=$({q
+0001d7c0: 7565 7279 5f73 7461 7465 5f63 6d64 7d29  uery_state_cmd})
+0001d7d0: 2026 2620 6563 686f 2022 2473 2220 2626   && echo "$s" &&
+0001d7e0: 2065 6368 6f3b 205b 5b20 2d7a 2022 2473   echo; [[ -z "$s
+0001d7f0: 2220 5d5d 207c 7c20 6563 686f 2022 2473  " ]] || echo "$s
+0001d800: 2220 7c20 6772 6570 202d 7620 2d45 2022  " | grep -v -E "
+0001d810: 5052 4f56 4953 494f 4e49 4e47 7c53 5441  PROVISIONING|STA
+0001d820: 4749 4e47 7c52 554e 4e49 4e47 7c52 4550  GING|RUNNING|REP
+0001d830: 4149 5249 4e47 7c54 4552 4d49 4e41 5445  AIRING|TERMINATE
+0001d840: 447c 5355 5350 454e 4449 4e47 7c53 5553  D|SUSPENDING|SUS
+0001d850: 5045 4e44 4544 7c53 5553 5045 4e44 4544  PENDED|SUSPENDED
+0001d860: 2227 0a20 2020 2020 2020 2020 2020 2029  "'.            )
+0001d870: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+0001d880: 2020 2020 2074 696d 656f 7574 3d32 3520       timeout=25 
+0001d890: 2a20 3630 290a 2020 2020 7275 6e5f 6f6e  * 60).    run_on
+0001d8a0: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
+0001d8b0: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374   ---------- Test
+0001d8c0: 696e 6720 7374 6f72 6167 6520 666f 7220  ing storage for 
+0001d8d0: 6d61 6e61 6765 6420 6a6f 6220 2d2d 2d2d  managed job ----
+0001d8e0: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
+0001d8f0: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
+0001d900: 6b20 2023 2046 6c75 6964 7374 6163 6b20  k  # Fluidstack 
+0001d910: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+0001d920: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
+0001d930: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+0001d940: 617a 7572 6520 2023 2041 7a75 7265 2064  azure  # Azure d
+0001d950: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+0001d960: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
+0001d970: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6c  pytest.mark.no_l
+0001d980: 616d 6264 615f 636c 6f75 6420 2023 204c  ambda_cloud  # L
+0001d990: 616d 6264 6120 436c 6f75 6420 646f 6573  ambda Cloud does
+0001d9a0: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
+0001d9b0: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
+0001d9c0: 6573 742e 6d61 726b 2e6e 6f5f 6962 6d20  est.mark.no_ibm 
+0001d9d0: 2023 2049 424d 2043 6c6f 7564 2064 6f65   # IBM Cloud doe
+0001d9e0: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
+0001d9f0: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
+0001da00: 7465 7374 2e6d 6172 6b2e 6e6f 5f70 6170  test.mark.no_pap
+0001da10: 6572 7370 6163 6520 2023 2050 6170 6572  erspace  # Paper
+0001da20: 7370 6163 6520 646f 6573 206e 6f74 2073  space does not s
+0001da30: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+0001da40: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+0001da50: 726b 2e6e 6f5f 7363 7020 2023 2053 4350  rk.no_scp  # SCP
+0001da60: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+0001da70: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
+0001da80: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
+0001da90: 6e61 6765 645f 6a6f 6273 0a64 6566 2074  naged_jobs.def t
+0001daa0: 6573 745f 6d61 6e61 6765 645f 6a6f 6273  est_managed_jobs
+0001dab0: 5f73 746f 7261 6765 2867 656e 6572 6963  _storage(generic
+0001dac0: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
+0001dad0: 2020 2222 2254 6573 7420 7374 6f72 6167    """Test storag
+0001dae0: 6520 7769 7468 206d 616e 6167 6564 206a  e with managed j
+0001daf0: 6f62 2222 220a 2020 2020 6e61 6d65 203d  ob""".    name =
+0001db00: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+0001db10: 6d65 2829 0a20 2020 2079 616d 6c5f 7374  me().    yaml_st
+0001db20: 7220 3d20 7061 7468 6c69 622e 5061 7468  r = pathlib.Path
+0001db30: 280a 2020 2020 2020 2020 2765 7861 6d70  (.        'examp
+0001db40: 6c65 732f 6d61 6e61 6765 645f 6a6f 625f  les/managed_job_
+0001db50: 7769 7468 5f73 746f 7261 6765 2e79 616d  with_storage.yam
+0001db60: 6c27 292e 7265 6164 5f74 6578 7428 290a  l').read_text().
+0001db70: 2020 2020 7374 6f72 6167 655f 6e61 6d65      storage_name
+0001db80: 203d 2066 2773 6b79 2d74 6573 742d 7b69   = f'sky-test-{i
+0001db90: 6e74 2874 696d 652e 7469 6d65 2829 297d  nt(time.time())}
+0001dba0: 270a 0a20 2020 2023 2041 6c73 6f20 7065  '..    # Also pe
+0001dbb0: 7266 6f72 6d20 7265 6769 6f6e 2074 6573  rform region tes
+0001dbc0: 7469 6e67 2066 6f72 2062 7563 6b65 7420  ting for bucket 
+0001dbd0: 6372 6561 7469 6f6e 2074 6f20 7661 6c69  creation to vali
+0001dbe0: 6461 7465 2069 6620 6275 636b 6574 7320  date if buckets 
+0001dbf0: 6172 650a 2020 2020 2320 6372 6561 7465  are.    # create
+0001dc00: 6420 696e 2074 6865 2063 6f72 7265 6374  d in the correct
+0001dc10: 2072 6567 696f 6e20 616e 6420 636f 7272   region and corr
+0001dc20: 6563 746c 7920 6d6f 756e 7465 6420 696e  ectly mounted in
+0001dc30: 206d 616e 6167 6564 206a 6f62 732e 0a20   managed jobs.. 
+0001dc40: 2020 2023 2048 6f77 6576 6572 2c20 7765     # However, we
+0001dc50: 2069 6e6a 6563 7420 7468 6973 2074 6573   inject this tes
+0001dc60: 7469 6e67 206f 6e6c 7920 666f 7220 4157  ting only for AW
+0001dc70: 5320 616e 6420 4743 5020 7369 6e63 6520  S and GCP since 
+0001dc80: 7468 6579 2061 7265 2074 6865 0a20 2020  they are the.   
+0001dc90: 2023 2073 7570 706f 7274 6564 206f 626a   # supported obj
+0001dca0: 6563 7420 7374 6f72 6167 6520 7072 6f76  ect storage prov
+0001dcb0: 6964 6572 7320 696e 2053 6b79 5069 6c6f  iders in SkyPilo
+0001dcc0: 742e 0a20 2020 2072 6567 696f 6e5f 666c  t..    region_fl
+0001dcd0: 6167 203d 2027 270a 2020 2020 7265 6769  ag = ''.    regi
+0001dce0: 6f6e 5f76 616c 6964 6174 696f 6e5f 636d  on_validation_cm
+0001dcf0: 6420 3d20 2774 7275 6527 0a20 2020 2075  d = 'true'.    u
+0001dd00: 7365 5f73 706f 7420 3d20 2720 2d2d 7573  se_spot = ' --us
+0001dd10: 652d 7370 6f74 270a 2020 2020 6966 2067  e-spot'.    if g
+0001dd20: 656e 6572 6963 5f63 6c6f 7564 203d 3d20  eneric_cloud == 
+0001dd30: 2761 7773 273a 0a20 2020 2020 2020 2072  'aws':.        r
+0001dd40: 6567 696f 6e20 3d20 2765 752d 6365 6e74  egion = 'eu-cent
+0001dd50: 7261 6c2d 3127 0a20 2020 2020 2020 2072  ral-1'.        r
+0001dd60: 6567 696f 6e5f 666c 6167 203d 2066 2720  egion_flag = f' 
+0001dd70: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
+0001dd80: 7d27 0a20 2020 2020 2020 2072 6567 696f  }'.        regio
+0001dd90: 6e5f 636d 6420 3d20 5465 7374 5374 6f72  n_cmd = TestStor
+0001dda0: 6167 6557 6974 6843 7265 6465 6e74 6961  ageWithCredentia
+0001ddb0: 6c73 2e63 6c69 5f72 6567 696f 6e5f 636d  ls.cli_region_cm
+0001ddc0: 6428 0a20 2020 2020 2020 2020 2020 2073  d(.            s
+0001ddd0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+0001dde0: 5479 7065 2e53 332c 2073 746f 7261 6765  Type.S3, storage
+0001ddf0: 5f6e 616d 6529 0a20 2020 2020 2020 2072  _name).        r
+0001de00: 6567 696f 6e5f 7661 6c69 6461 7469 6f6e  egion_validation
+0001de10: 5f63 6d64 203d 2066 277b 7265 6769 6f6e  _cmd = f'{region
+0001de20: 5f63 6d64 7d20 7c20 6772 6570 207b 7265  _cmd} | grep {re
+0001de30: 6769 6f6e 7d27 0a20 2020 2065 6c69 6620  gion}'.    elif 
+0001de40: 6765 6e65 7269 635f 636c 6f75 6420 3d3d  generic_cloud ==
+0001de50: 2027 6763 7027 3a0a 2020 2020 2020 2020   'gcp':.        
+0001de60: 7265 6769 6f6e 203d 2027 7573 2d77 6573  region = 'us-wes
+0001de70: 7432 270a 2020 2020 2020 2020 7265 6769  t2'.        regi
+0001de80: 6f6e 5f66 6c61 6720 3d20 6627 202d 2d72  on_flag = f' --r
+0001de90: 6567 696f 6e20 7b72 6567 696f 6e7d 270a  egion {region}'.
+0001dea0: 2020 2020 2020 2020 7265 6769 6f6e 5f63          region_c
+0001deb0: 6d64 203d 2054 6573 7453 746f 7261 6765  md = TestStorage
+0001dec0: 5769 7468 4372 6564 656e 7469 616c 732e  WithCredentials.
+0001ded0: 636c 695f 7265 6769 6f6e 5f63 6d64 280a  cli_region_cmd(.
+0001dee0: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+0001def0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0001df00: 652e 4743 532c 2073 746f 7261 6765 5f6e  e.GCS, storage_n
+0001df10: 616d 6529 0a20 2020 2020 2020 2072 6567  ame).        reg
+0001df20: 696f 6e5f 7661 6c69 6461 7469 6f6e 5f63  ion_validation_c
+0001df30: 6d64 203d 2066 277b 7265 6769 6f6e 5f63  md = f'{region_c
+0001df40: 6d64 7d20 7c20 6772 6570 207b 7265 6769  md} | grep {regi
+0001df50: 6f6e 7d27 0a20 2020 2065 6c69 6620 6765  on}'.    elif ge
+0001df60: 6e65 7269 635f 636c 6f75 6420 3d3d 2027  neric_cloud == '
+0001df70: 6b75 6265 726e 6574 6573 273a 0a20 2020  kubernetes':.   
+0001df80: 2020 2020 2075 7365 5f73 706f 7420 3d20       use_spot = 
+0001df90: 2720 2d2d 6e6f 2d75 7365 2d73 706f 7427  ' --no-use-spot'
+0001dfa0: 0a0a 2020 2020 7961 6d6c 5f73 7472 203d  ..    yaml_str =
+0001dfb0: 2079 616d 6c5f 7374 722e 7265 706c 6163   yaml_str.replac
+0001dfc0: 6528 2773 6b79 2d77 6f72 6b64 6972 2d7a  e('sky-workdir-z
+0001dfd0: 6877 7527 2c20 7374 6f72 6167 655f 6e61  hwu', storage_na
+0001dfe0: 6d65 290a 2020 2020 7769 7468 2074 656d  me).    with tem
+0001dff0: 7066 696c 652e 4e61 6d65 6454 656d 706f  pfile.NamedTempo
+0001e000: 7261 7279 4669 6c65 2873 7566 6669 783d  raryFile(suffix=
+0001e010: 272e 7961 6d6c 272c 206d 6f64 653d 2777  '.yaml', mode='w
+0001e020: 2729 2061 7320 663a 0a20 2020 2020 2020  ') as f:.       
+0001e030: 2066 2e77 7269 7465 2879 616d 6c5f 7374   f.write(yaml_st
+0001e040: 7229 0a20 2020 2020 2020 2066 2e66 6c75  r).        f.flu
+0001e050: 7368 2829 0a20 2020 2020 2020 2066 696c  sh().        fil
+0001e060: 655f 7061 7468 203d 2066 2e6e 616d 650a  e_path = f.name.
+0001e070: 2020 2020 2020 2020 7465 7374 203d 2054          test = T
+0001e080: 6573 7428 0a20 2020 2020 2020 2020 2020  est(.           
+0001e090: 2027 6d61 6e61 6765 645f 6a6f 6273 5f73   'managed_jobs_s
+0001e0a0: 746f 7261 6765 272c 0a20 2020 2020 2020  torage',.       
+0001e0b0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+0001e0c0: 2020 2020 2020 202a 7374 6f72 6167 655f         *storage_
+0001e0d0: 7365 7475 705f 636f 6d6d 616e 6473 2c0a  setup_commands,.
+0001e0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e0f0: 6627 736b 7920 6a6f 6273 206c 6175 6e63  f'sky jobs launc
+0001e100: 6820 2d6e 207b 6e61 6d65 7d7b 7573 655f  h -n {name}{use_
+0001e110: 7370 6f74 7d20 2d2d 636c 6f75 6420 7b67  spot} --cloud {g
+0001e120: 656e 6572 6963 5f63 6c6f 7564 7d7b 7265  eneric_cloud}{re
+0001e130: 6769 6f6e 5f66 6c61 677d 207b 6669 6c65  gion_flag} {file
+0001e140: 5f70 6174 687d 202d 7927 2c0a 2020 2020  _path} -y',.    
+0001e150: 2020 2020 2020 2020 2020 2020 7265 6769              regi
+0001e160: 6f6e 5f76 616c 6964 6174 696f 6e5f 636d  on_validation_cm
+0001e170: 642c 2020 2320 4368 6563 6b20 6966 2074  d,  # Check if t
+0001e180: 6865 2062 7563 6b65 7420 6973 2063 7265  he bucket is cre
+0001e190: 6174 6564 2069 6e20 7468 6520 636f 7272  ated in the corr
+0001e1a0: 6563 7420 7265 6769 6f6e 0a20 2020 2020  ect region.     
+0001e1b0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0001e1c0: 7020 3630 272c 2020 2320 5761 6974 2074  p 60',  # Wait t
+0001e1d0: 6865 2073 706f 7420 7175 6575 6520 746f  he spot queue to
+0001e1e0: 2062 6520 7570 6461 7465 640a 2020 2020   be updated.    
+0001e1f0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+0001e200: 4a4f 425f 5155 4555 455f 5741 4954 7d7c  JOB_QUEUE_WAIT}|
+0001e210: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
+0001e220: 7265 7020 5355 4343 4545 4445 4427 2c0a  rep SUCCEEDED',.
+0001e230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e240: 6627 5b20 2428 6177 7320 7333 6170 6920  f'[ $(aws s3api 
+0001e250: 6c69 7374 2d62 7563 6b65 7473 202d 2d71  list-buckets --q
+0001e260: 7565 7279 2022 4275 636b 6574 735b 3f63  uery "Buckets[?c
+0001e270: 6f6e 7461 696e 7328 4e61 6d65 2c20 5c27  ontains(Name, \'
+0001e280: 7b73 746f 7261 6765 5f6e 616d 657d 5c27  {storage_name}\'
+0001e290: 295d 2e4e 616d 6522 202d 2d6f 7574 7075  )].Name" --outpu
+0001e2a0: 7420 7465 7874 207c 2077 6320 2d6c 2920  t text | wc -l) 
+0001e2b0: 2d65 7120 3020 5d27 0a20 2020 2020 2020  -eq 0 ]'.       
+0001e2c0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+0001e2d0: 2020 2020 5f4a 4f42 5f43 414e 4345 4c5f      _JOB_CANCEL_
+0001e2e0: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
+0001e2f0: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
+0001e300: 2020 2020 2020 2020 2320 496e 6372 6561          # Increa
+0001e310: 7365 2074 696d 656f 7574 2073 696e 6365  se timeout since
+0001e320: 2073 6b79 206a 6f62 7320 7175 6575 6520   sky jobs queue 
+0001e330: 2d72 2063 616e 2062 6520 626c 6f63 6b65  -r can be blocke
+0001e340: 6420 6279 206f 7468 6572 2073 706f 7420  d by other spot 
+0001e350: 7465 7374 732e 0a20 2020 2020 2020 2020  tests..         
+0001e360: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
+0001e370: 3630 2c0a 2020 2020 2020 2020 290a 2020  60,.        ).  
+0001e380: 2020 2020 2020 7275 6e5f 6f6e 655f 7465        run_one_te
+0001e390: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
+0001e3a0: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
+0001e3b0: 7370 6f74 2054 5055 202d 2d2d 2d2d 2d2d  spot TPU -------
+0001e3c0: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
+0001e3d0: 2e67 6370 0a40 7079 7465 7374 2e6d 6172  .gcp.@pytest.mar
+0001e3e0: 6b2e 6d61 6e61 6765 645f 6a6f 6273 0a40  k.managed_jobs.@
+0001e3f0: 7079 7465 7374 2e6d 6172 6b2e 7470 750a  pytest.mark.tpu.
+0001e400: 6465 6620 7465 7374 5f6d 616e 6167 6564  def test_managed
+0001e410: 5f6a 6f62 735f 7470 7528 293a 0a20 2020  _jobs_tpu():.   
+0001e420: 2022 2222 5465 7374 206d 616e 6167 6564   """Test managed
+0001e430: 206a 6f62 206f 6e20 5450 552e 2222 220a   job on TPU.""".
+0001e440: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+0001e450: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+0001e460: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+0001e470: 2020 2020 2020 2020 2774 6573 742d 7370          'test-sp
+0001e480: 6f74 2d74 7075 272c 0a20 2020 2020 2020  ot-tpu',.       
+0001e490: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+0001e4a0: 2773 6b79 206a 6f62 7320 6c61 756e 6368  'sky jobs launch
+0001e4b0: 202d 6e20 7b6e 616d 657d 202d 2d75 7365   -n {name} --use
+0001e4c0: 2d73 706f 7420 6578 616d 706c 6573 2f74  -spot examples/t
+0001e4d0: 7075 2f74 7075 766d 5f6d 6e69 7374 2e79  pu/tpuvm_mnist.y
+0001e4e0: 616d 6c20 2d79 202d 6427 2c0a 2020 2020  aml -y -d',.    
+0001e4f0: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
+0001e500: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001e510: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
+0001e520: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
+0001e530: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+0001e540: 7020 5354 4152 5449 4e47 272c 0a20 2020  p STARTING',.   
+0001e550: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001e560: 3930 3027 2c20 2023 2054 5055 2074 616b  900',  # TPU tak
+0001e570: 6573 2061 2077 6869 6c65 2074 6f20 6c61  es a while to la
+0001e580: 756e 6368 0a20 2020 2020 2020 2020 2020  unch.           
+0001e590: 2066 277b 5f4a 4f42 5f51 5545 5545 5f57   f'{_JOB_QUEUE_W
+0001e5a0: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+0001e5b0: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
+0001e5c0: 7265 7020 2252 554e 4e49 4e47 5c7c 5355  rep "RUNNING\|SU
+0001e5d0: 4343 4545 4445 4422 272c 0a20 2020 2020  CCEEDED"',.     
+0001e5e0: 2020 205d 2c0a 2020 2020 2020 2020 5f4a     ],.        _J
+0001e5f0: 4f42 5f43 414e 4345 4c5f 5741 4954 2e66  OB_CANCEL_WAIT.f
+0001e600: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d6e  ormat(job_name=n
+0001e610: 616d 6529 2c0a 2020 2020 2020 2020 2320  ame),.        # 
+0001e620: 496e 6372 6561 7365 2074 696d 656f 7574  Increase timeout
+0001e630: 2073 696e 6365 2073 6b79 206a 6f62 7320   since sky jobs 
+0001e640: 7175 6575 6520 2d72 2063 616e 2062 6520  queue -r can be 
+0001e650: 626c 6f63 6b65 6420 6279 206f 7468 6572  blocked by other
+0001e660: 2073 706f 7420 7465 7374 732e 0a20 2020   spot tests..   
+0001e670: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
+0001e680: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
+0001e690: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+0001e6a0: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
+0001e6b0: 2d20 5465 7374 696e 6720 656e 7620 666f  - Testing env fo
+0001e6c0: 7220 6d61 6e61 6765 6420 6a6f 6273 202d  r managed jobs -
+0001e6d0: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
+0001e6e0: 742e 6d61 726b 2e6d 616e 6167 6564 5f6a  t.mark.managed_j
+0001e6f0: 6f62 730a 6465 6620 7465 7374 5f6d 616e  obs.def test_man
+0001e700: 6167 6564 5f6a 6f62 735f 696e 6c69 6e65  aged_jobs_inline
+0001e710: 5f65 6e76 2867 656e 6572 6963 5f63 6c6f  _env(generic_clo
+0001e720: 7564 3a20 7374 7229 3a0a 2020 2020 2222  ud: str):.    ""
+0001e730: 2254 6573 7420 6d61 6e61 6765 6420 6a6f  "Test managed jo
+0001e740: 6273 2065 6e76 2222 220a 2020 2020 6e61  bs env""".    na
+0001e750: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+0001e760: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+0001e770: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+0001e780: 2020 2774 6573 742d 6d61 6e61 6765 642d    'test-managed-
+0001e790: 6a6f 6273 2d69 6e6c 696e 652d 656e 7627  jobs-inline-env'
+0001e7a0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+0001e7b0: 2020 2020 2020 2020 6627 736b 7920 6a6f          f'sky jo
+0001e7c0: 6273 206c 6175 6e63 6820 2d6e 207b 6e61  bs launch -n {na
+0001e7d0: 6d65 7d20 2d79 202d 2d63 6c6f 7564 207b  me} -y --cloud {
+0001e7e0: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
+0001e7f0: 2d65 6e76 2054 4553 545f 454e 563d 2268  -env TEST_ENV="h
+0001e800: 656c 6c6f 2077 6f72 6c64 2220 2d2d 2022  ello world" -- "
+0001e810: 285b 5b20 2120 2d7a 205c 5c22 5c24 5445  ([[ ! -z \\"\$TE
+0001e820: 5354 5f45 4e56 5c5c 2220 5d5d 2026 2620  ST_ENV\\" ]] && 
+0001e830: 5b5b 2021 202d 7a20 5c5c 225c 2453 4b59  [[ ! -z \\"\$SKY
+0001e840: 5049 4c4f 545f 4e4f 4445 5f49 5053 5c5c  PILOT_NODE_IPS\\
+0001e850: 2220 5d5d 2026 2620 5b5b 2021 202d 7a20  " ]] && [[ ! -z 
+0001e860: 5c5c 225c 2453 4b59 5049 4c4f 545f 4e4f  \\"\$SKYPILOT_NO
+0001e870: 4445 5f52 414e 4b5c 5c22 205d 5d29 207c  DE_RANK\\" ]]) |
+0001e880: 7c20 6578 6974 2031 2227 2c0a 2020 2020  | exit 1"',.    
+0001e890: 2020 2020 2020 2020 2773 6c65 6570 2032          'sleep 2
+0001e8a0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+0001e8b0: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
+0001e8c0: 4954 7d20 7c20 6772 6570 207b 6e61 6d65  IT} | grep {name
+0001e8d0: 7d20 7c20 6772 6570 2053 5543 4345 4544  } | grep SUCCEED
+0001e8e0: 4544 272c 0a20 2020 2020 2020 205d 2c0a  ED',.        ],.
+0001e8f0: 2020 2020 2020 2020 5f4a 4f42 5f43 414e          _JOB_CAN
+0001e900: 4345 4c5f 5741 4954 2e66 6f72 6d61 7428  CEL_WAIT.format(
+0001e910: 6a6f 625f 6e61 6d65 3d6e 616d 6529 2c0a  job_name=name),.
+0001e920: 2020 2020 2020 2020 2320 496e 6372 6561          # Increa
+0001e930: 7365 2074 696d 656f 7574 2073 696e 6365  se timeout since
+0001e940: 2073 6b79 206a 6f62 7320 7175 6575 6520   sky jobs queue 
+0001e950: 2d72 2063 616e 2062 6520 626c 6f63 6b65  -r can be blocke
+0001e960: 6420 6279 206f 7468 6572 2073 706f 7420  d by other spot 
+0001e970: 7465 7374 732e 0a20 2020 2020 2020 2074  tests..        t
+0001e980: 696d 656f 7574 3d32 3020 2a20 3630 2c0a  imeout=20 * 60,.
+0001e990: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+0001e9a0: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
+0001e9b0: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374   ---------- Test
+0001e9c0: 696e 6720 656e 7620 2d2d 2d2d 2d2d 2d2d  ing env --------
+0001e9d0: 2d2d 0a64 6566 2074 6573 745f 696e 6c69  --.def test_inli
+0001e9e0: 6e65 5f65 6e76 2867 656e 6572 6963 5f63  ne_env(generic_c
+0001e9f0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+0001ea00: 2222 2254 6573 7420 656e 7622 2222 0a20  """Test env""". 
+0001ea10: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+0001ea20: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+0001ea30: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+0001ea40: 2020 2020 2020 2027 7465 7374 2d69 6e6c         'test-inl
+0001ea50: 696e 652d 656e 7627 2c0a 2020 2020 2020  ine-env',.      
+0001ea60: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+0001ea70: 6627 736b 7920 6c61 756e 6368 202d 6320  f'sky launch -c 
+0001ea80: 7b6e 616d 657d 202d 7920 2d2d 636c 6f75  {name} -y --clou
+0001ea90: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+0001eaa0: 7d20 2d2d 656e 7620 5445 5354 5f45 4e56  } --env TEST_ENV
+0001eab0: 3d22 6865 6c6c 6f20 776f 726c 6422 202d  ="hello world" -
+0001eac0: 2d20 2228 5b5b 2021 202d 7a20 5c5c 225c  - "([[ ! -z \\"\
+0001ead0: 2454 4553 545f 454e 565c 5c22 205d 5d20  $TEST_ENV\\" ]] 
+0001eae0: 2626 205b 5b20 2120 2d7a 205c 5c22 5c24  && [[ ! -z \\"\$
+0001eaf0: 534b 5950 494c 4f54 5f4e 4f44 455f 4950  SKYPILOT_NODE_IP
+0001eb00: 535c 5c22 205d 5d20 2626 205b 5b20 2120  S\\" ]] && [[ ! 
+0001eb10: 2d7a 205c 5c22 5c24 534b 5950 494c 4f54  -z \\"\$SKYPILOT
+0001eb20: 5f4e 4f44 455f 5241 4e4b 5c5c 2220 5d5d  _NODE_RANK\\" ]]
+0001eb30: 2920 7c7c 2065 7869 7420 3122 272c 0a20  ) || exit 1"',. 
+0001eb40: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0001eb50: 7020 3230 272c 0a20 2020 2020 2020 2020  p 20',.         
+0001eb60: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+0001eb70: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+0001eb80: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001eb90: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+0001eba0: 2d2d 656e 7620 5445 5354 5f45 4e56 323d  --env TEST_ENV2=
+0001ebb0: 2273 7563 6365 7373 2220 2228 5b5b 2021  "success" "([[ !
+0001ebc0: 202d 7a20 5c5c 225c 2454 4553 545f 454e   -z \\"\$TEST_EN
+0001ebd0: 5632 5c5c 2220 5d5d 2026 2620 5b5b 2021  V2\\" ]] && [[ !
+0001ebe0: 202d 7a20 5c5c 225c 2453 4b59 5049 4c4f   -z \\"\$SKYPILO
+0001ebf0: 545f 4e4f 4445 5f49 5053 5c5c 2220 5d5d  T_NODE_IPS\\" ]]
+0001ec00: 2026 2620 5b5b 2021 202d 7a20 5c5c 225c   && [[ ! -z \\"\
+0001ec10: 2453 4b59 5049 4c4f 545f 4e4f 4445 5f52  $SKYPILOT_NODE_R
+0001ec20: 414e 4b5c 5c22 205d 5d29 207c 7c20 6578  ANK\\" ]]) || ex
+0001ec30: 6974 2031 2227 2c0a 2020 2020 2020 2020  it 1"',.        
+0001ec40: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0001ec50: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
+0001ec60: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+0001ec70: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+0001ec80: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+0001ec90: 2020 2020 205f 6765 745f 7469 6d65 6f75       _get_timeou
+0001eca0: 7428 6765 6e65 7269 635f 636c 6f75 6429  t(generic_cloud)
+0001ecb0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+0001ecc0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+0001ecd0: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
+0001ece0: 7374 696e 6720 656e 7620 6669 6c65 202d  sting env file -
+0001ecf0: 2d2d 2d2d 2d2d 2d2d 2d0a 6465 6620 7465  ---------.def te
+0001ed00: 7374 5f69 6e6c 696e 655f 656e 765f 6669  st_inline_env_fi
+0001ed10: 6c65 2867 656e 6572 6963 5f63 6c6f 7564  le(generic_cloud
+0001ed20: 3a20 7374 7229 3a0a 2020 2020 2222 2254  : str):.    """T
+0001ed30: 6573 7420 656e 7622 2222 0a20 2020 206e  est env""".    n
+0001ed40: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+0001ed50: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+0001ed60: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+0001ed70: 2020 2027 7465 7374 2d69 6e6c 696e 652d     'test-inline-
+0001ed80: 656e 762d 6669 6c65 272c 0a20 2020 2020  env-file',.     
+0001ed90: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+0001eda0: 2066 2773 6b79 206c 6175 6e63 6820 2d63   f'sky launch -c
+0001edb0: 207b 6e61 6d65 7d20 2d79 202d 2d63 6c6f   {name} -y --clo
+0001edc0: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
+0001edd0: 647d 202d 2d65 6e76 2054 4553 545f 454e  d} --env TEST_EN
+0001ede0: 563d 2268 656c 6c6f 2077 6f72 6c64 2220  V="hello world" 
+0001edf0: 2d2d 2022 285b 5b20 2120 2d7a 205c 5c22  -- "([[ ! -z \\"
+0001ee00: 5c24 5445 5354 5f45 4e56 5c5c 2220 5d5d  \$TEST_ENV\\" ]]
+0001ee10: 2026 2620 5b5b 2021 202d 7a20 5c5c 225c   && [[ ! -z \\"\
+0001ee20: 2453 4b59 5049 4c4f 545f 4e4f 4445 5f49  $SKYPILOT_NODE_I
+0001ee30: 5053 5c5c 2220 5d5d 2026 2620 5b5b 2021  PS\\" ]] && [[ !
+0001ee40: 202d 7a20 5c5c 225c 2453 4b59 5049 4c4f   -z \\"\$SKYPILO
+0001ee50: 545f 4e4f 4445 5f52 414e 4b5c 5c22 205d  T_NODE_RANK\\" ]
+0001ee60: 5d29 207c 7c20 6578 6974 2031 2227 2c0a  ]) || exit 1"',.
+0001ee70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0001ee80: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+0001ee90: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+0001eea0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0001eeb0: 6320 7b6e 616d 657d 202d 2d65 6e76 2d66  c {name} --env-f
+0001eec0: 696c 6520 6578 616d 706c 6573 2f73 616d  ile examples/sam
+0001eed0: 706c 655f 646f 7465 6e76 2022 285b 5b20  ple_dotenv "([[ 
+0001eee0: 2120 2d7a 205c 5c22 5c24 5445 5354 5f45  ! -z \\"\$TEST_E
+0001eef0: 4e56 325c 5c22 205d 5d20 2626 205b 5b20  NV2\\" ]] && [[ 
+0001ef00: 2120 2d7a 205c 5c22 5c24 534b 5950 494c  ! -z \\"\$SKYPIL
+0001ef10: 4f54 5f4e 4f44 455f 4950 535c 5c22 205d  OT_NODE_IPS\\" ]
+0001ef20: 5d20 2626 205b 5b20 2120 2d7a 205c 5c22  ] && [[ ! -z \\"
+0001ef30: 5c24 534b 5950 494c 4f54 5f4e 4f44 455f  \$SKYPILOT_NODE_
+0001ef40: 5241 4e4b 5c5c 2220 5d5d 2920 7c7c 2065  RANK\\" ]]) || e
+0001ef50: 7869 7420 3122 272c 0a20 2020 2020 2020  xit 1"',.       
+0001ef60: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+0001ef70: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
+0001ef80: 7327 2c0a 2020 2020 2020 2020 5d2c 0a20  s',.        ],. 
+0001ef90: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+0001efa0: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+0001efb0: 2020 2020 2020 5f67 6574 5f74 696d 656f        _get_timeo
+0001efc0: 7574 2867 656e 6572 6963 5f63 6c6f 7564  ut(generic_cloud
+0001efd0: 292c 0a20 2020 2029 0a20 2020 2072 756e  ),.    ).    run
+0001efe0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+0001eff0: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
+0001f000: 6573 7469 6e67 2063 7573 746f 6d20 696d  esting custom im
+0001f010: 6167 6520 2d2d 2d2d 2d2d 2d2d 2d2d 0a40  age ----------.@
+0001f020: 7079 7465 7374 2e6d 6172 6b2e 6177 730a  pytest.mark.aws.
+0001f030: 6465 6620 7465 7374 5f61 7773 5f63 7573  def test_aws_cus
+0001f040: 746f 6d5f 696d 6167 6528 293a 0a20 2020  tom_image():.   
+0001f050: 2022 2222 5465 7374 2041 5753 2063 7573   """Test AWS cus
+0001f060: 746f 6d20 696d 6167 6522 2222 0a20 2020  tom image""".   
+0001f070: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+0001f080: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+0001f090: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+0001f0a0: 2020 2020 2027 7465 7374 2d61 7773 2d63       'test-aws-c
+0001f0b0: 7573 746f 6d2d 696d 6167 6527 2c0a 2020  ustom-image',.  
+0001f0c0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+0001f0d0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+0001f0e0: 202d 6320 7b6e 616d 657d 202d 2d72 6574   -c {name} --ret
+0001f0f0: 7279 2d75 6e74 696c 2d75 7020 2d79 2074  ry-until-up -y t
+0001f100: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+0001f110: 7465 7374 5f63 7573 746f 6d5f 696d 6167  test_custom_imag
+0001f120: 652e 7961 6d6c 202d 2d63 6c6f 7564 2061  e.yaml --cloud a
+0001f130: 7773 202d 2d72 6567 696f 6e20 7573 2d65  ws --region us-e
+0001f140: 6173 742d 3220 2d2d 696d 6167 652d 6964  ast-2 --image-id
+0001f150: 2061 6d69 2d30 3632 6464 6439 3066 6236   ami-062ddd90fb6
+0001f160: 6638 3236 3761 272c 2020 2320 4e76 6964  f8267a',  # Nvid
+0001f170: 6961 2069 6d61 6765 0a20 2020 2020 2020  ia image.       
+0001f180: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+0001f190: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+0001f1a0: 7327 2c0a 2020 2020 2020 2020 5d2c 0a20  s',.        ],. 
+0001f1b0: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+0001f1c0: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+0001f1d0: 2020 2020 2020 7469 6d65 6f75 743d 3330        timeout=30
+0001f1e0: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
+0001f1f0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+0001f200: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+0001f210: 726b 2e6b 7562 6572 6e65 7465 730a 4070  rk.kubernetes.@p
+0001f220: 7974 6573 742e 6d61 726b 2e70 6172 616d  ytest.mark.param
+0001f230: 6574 7269 7a65 280a 2020 2020 2769 6d61  etrize(.    'ima
+0001f240: 6765 5f69 6427 2c0a 2020 2020 5b0a 2020  ge_id',.    [.  
+0001f250: 2020 2020 2020 2764 6f63 6b65 723a 6e76        'docker:nv
+0001f260: 6964 6961 2f63 7564 613a 3131 2e38 2e30  idia/cuda:11.8.0
+0001f270: 2d64 6576 656c 2d75 6275 6e74 7531 382e  -devel-ubuntu18.
+0001f280: 3034 272c 0a20 2020 2020 2020 2027 646f  04',.        'do
+0001f290: 636b 6572 3a75 6275 6e74 753a 3138 2e30  cker:ubuntu:18.0
+0001f2a0: 3427 2c0a 2020 2020 2020 2020 2320 5465  4',.        # Te
+0001f2b0: 7374 206c 6174 6573 7420 696d 6167 6520  st latest image 
+0001f2c0: 7769 7468 2070 7974 686f 6e20 332e 3131  with python 3.11
+0001f2d0: 2069 6e73 7461 6c6c 6564 2062 7920 6465   installed by de
+0001f2e0: 6661 756c 742e 0a20 2020 2020 2020 2023  fault..        #
+0001f2f0: 2044 6f65 7320 6e6f 7420 776f 726b 2066   Does not work f
+0001f300: 6f72 2070 7974 686f 6e20 332e 3132 2064  or python 3.12 d
+0001f310: 7565 2074 6f20 7261 7927 7320 7265 7175  ue to ray's requ
+0001f320: 6972 656d 656e 7420 666f 7220 332e 3131  irement for 3.11
+0001f330: 2e0a 2020 2020 2020 2020 2764 6f63 6b65  ..        'docke
+0001f340: 723a 636f 6e74 696e 7575 6d69 6f2f 6d69  r:continuumio/mi
+0001f350: 6e69 636f 6e64 6133 3a32 342e 312e 322d  niconda3:24.1.2-
+0001f360: 3027 2c0a 2020 2020 5d29 0a64 6566 2074  0',.    ]).def t
+0001f370: 6573 745f 6b75 6265 726e 6574 6573 5f63  est_kubernetes_c
+0001f380: 7573 746f 6d5f 696d 6167 6528 696d 6167  ustom_image(imag
+0001f390: 655f 6964 293a 0a20 2020 2022 2222 5465  e_id):.    """Te
+0001f3a0: 7374 204b 7562 6572 6e65 7465 7320 6375  st Kubernetes cu
+0001f3b0: 7374 6f6d 2069 6d61 6765 2222 220a 2020  stom image""".  
+0001f3c0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+0001f3d0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+0001f3e0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+0001f3f0: 2020 2020 2020 2774 6573 742d 6b75 6265        'test-kube
+0001f400: 726e 6574 6573 2d63 7573 746f 6d2d 696d  rnetes-custom-im
+0001f410: 6167 6527 2c0a 2020 2020 2020 2020 5b0a  age',.        [.
+0001f420: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0001f430: 7920 6c61 756e 6368 202d 6320 7b6e 616d  y launch -c {nam
+0001f440: 657d 202d 2d72 6574 7279 2d75 6e74 696c  e} --retry-until
+0001f450: 2d75 7020 2d79 2074 6573 7473 2f74 6573  -up -y tests/tes
+0001f460: 745f 7961 6d6c 732f 7465 7374 5f63 7573  t_yamls/test_cus
+0001f470: 746f 6d5f 696d 6167 652e 7961 6d6c 202d  tom_image.yaml -
+0001f480: 2d63 6c6f 7564 206b 7562 6572 6e65 7465  -cloud kubernete
+0001f490: 7320 2d2d 696d 6167 652d 6964 207b 696d  s --image-id {im
+0001f4a0: 6167 655f 6964 7d20 2d2d 7265 6769 6f6e  age_id} --region
+0001f4b0: 204e 6f6e 6520 2d2d 6770 7573 2054 343a   None --gpus T4:
+0001f4c0: 3127 2c0a 2020 2020 2020 2020 2020 2020  1',.            
+0001f4d0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+0001f4e0: 7d20 3120 2d2d 7374 6174 7573 272c 0a20  } 1 --status',. 
+0001f4f0: 2020 2020 2020 2020 2020 2023 2054 7279             # Try
+0001f500: 2065 7865 6320 746f 2072 756e 2061 6761   exec to run aga
+0001f510: 696e 2061 6e64 2063 6865 636b 2069 6620  in and check if 
+0001f520: 7468 6520 6c6f 6773 2061 7265 2070 7269  the logs are pri
+0001f530: 6e74 6564 0a20 2020 2020 2020 2020 2020  nted.           
+0001f540: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+0001f550: 657d 2074 6573 7473 2f74 6573 745f 7961  e} tests/test_ya
+0001f560: 6d6c 732f 7465 7374 5f63 7573 746f 6d5f  mls/test_custom_
+0001f570: 696d 6167 652e 7961 6d6c 202d 2d63 6c6f  image.yaml --clo
+0001f580: 7564 206b 7562 6572 6e65 7465 7320 2d2d  ud kubernetes --
+0001f590: 696d 6167 652d 6964 207b 696d 6167 655f  image-id {image_
+0001f5a0: 6964 7d20 2d2d 7265 6769 6f6e 204e 6f6e  id} --region Non
+0001f5b0: 6520 2d2d 6770 7573 2054 343a 3120 7c20  e --gpus T4:1 | 
+0001f5c0: 6772 6570 2022 4865 6c6c 6f20 3130 3022  grep "Hello 100"
+0001f5d0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+0001f5e0: 204d 616b 6520 7375 7265 2073 7368 2069   Make sure ssh i
+0001f5f0: 7320 776f 726b 696e 6720 7769 7468 2063  s working with c
+0001f600: 7573 746f 6d20 7573 6572 6e61 6d65 0a20  ustom username. 
+0001f610: 2020 2020 2020 2020 2020 2066 2773 7368             f'ssh
+0001f620: 207b 6e61 6d65 7d20 6563 686f 2068 6920   {name} echo hi 
+0001f630: 7c20 6772 6570 2068 6927 2c0a 2020 2020  | grep hi',.    
+0001f640: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+0001f650: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0001f660: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
+0001f670: 6d65 6f75 743d 3330 202a 2036 302c 0a20  meout=30 * 60,. 
+0001f680: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+0001f690: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+0001f6a0: 7974 6573 742e 6d61 726b 2e73 6c6f 770a  ytest.mark.slow.
+0001f6b0: 6465 6620 7465 7374 5f61 7a75 7265 5f73  def test_azure_s
+0001f6c0: 7461 7274 5f73 746f 705f 7477 6f5f 6e6f  tart_stop_two_no
+0001f6d0: 6465 7328 293a 0a20 2020 206e 616d 6520  des():.    name 
+0001f6e0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+0001f6f0: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+0001f700: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+0001f710: 617a 7572 652d 7374 6172 742d 7374 6f70  azure-start-stop
+0001f720: 2d74 776f 2d6e 6f64 6573 272c 0a20 2020  -two-nodes',.   
+0001f730: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+0001f740: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+0001f750: 2d2d 6e75 6d2d 6e6f 6465 733d 3220 2d79  --num-nodes=2 -y
+0001f760: 202d 6320 7b6e 616d 657d 2065 7861 6d70   -c {name} examp
+0001f770: 6c65 732f 617a 7572 655f 7374 6172 745f  les/azure_start_
+0001f780: 7374 6f70 2e79 616d 6c27 2c0a 2020 2020  stop.yaml',.    
+0001f790: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+0001f7a0: 6563 202d 2d6e 756d 2d6e 6f64 6573 3d32  ec --num-nodes=2
+0001f7b0: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
+0001f7c0: 2f61 7a75 7265 5f73 7461 7274 5f73 746f  /azure_start_sto
+0001f7d0: 702e 7961 6d6c 272c 0a20 2020 2020 2020  p.yaml',.       
+0001f7e0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+0001f7f0: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+0001f800: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+0001f810: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+0001f820: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0001f830: 6b79 2073 746f 7020 2d79 207b 6e61 6d65  ky stop -y {name
+0001f840: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+0001f850: 6627 736b 7920 7374 6172 7420 2d79 207b  f'sky start -y {
+0001f860: 6e61 6d65 7d20 2d69 2031 272c 0a20 2020  name} -i 1',.   
+0001f870: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+0001f880: 7865 6320 2d2d 6e75 6d2d 6e6f 6465 733d  xec --num-nodes=
+0001f890: 3220 7b6e 616d 657d 2065 7861 6d70 6c65  2 {name} example
+0001f8a0: 732f 617a 7572 655f 7374 6172 745f 7374  s/azure_start_st
+0001f8b0: 6f70 2e79 616d 6c27 2c0a 2020 2020 2020  op.yaml',.      
+0001f8c0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+0001f8d0: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
+0001f8e0: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
+0001f8f0: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
+0001f900: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
+0001f910: 6c65 6570 2032 3030 272c 0a20 2020 2020  leep 200',.     
+0001f920: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+0001f930: 2073 7461 7475 7320 2d72 207b 6e61 6d65   status -r {name
+0001f940: 7d29 2026 2620 6563 686f 2022 2473 2220  }) && echo "$s" 
+0001f950: 2626 2065 6368 6f20 2224 7322 207c 2067  && echo "$s" | g
+0001f960: 7265 7020 2249 4e49 545c 7c53 544f 5050  rep "INIT\|STOPP
+0001f970: 4544 2227 0a20 2020 2020 2020 2020 2020  ED"'.           
+0001f980: 2066 277c 7c20 7b7b 2073 7368 207b 6e61   f'|| {{ ssh {na
+0001f990: 6d65 7d20 2263 6174 207e 2f2e 736b 792f  me} "cat ~/.sky/
+0001f9a0: 736b 796c 6574 2e6c 6f67 223b 2065 7869  skylet.log"; exi
+0001f9b0: 7420 313b 207d 7d27 0a20 2020 2020 2020  t 1; }}'.       
+0001f9c0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+0001f9d0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+0001f9e0: 272c 0a20 2020 2020 2020 2074 696d 656f  ',.        timeo
+0001f9f0: 7574 3d33 3020 2a20 3630 2c20 2023 2033  ut=30 * 60,  # 3
+0001fa00: 3020 6d69 6e73 2020 2869 7420 7461 6b65  0 mins  (it take
+0001fa10: 7320 6172 6f75 6e64 207e 3233 206d 696e  s around ~23 min
+0001fa20: 7329 0a20 2020 2029 0a20 2020 2072 756e  s).    ).    run
+0001fa30: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+0001fa40: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
+0001fa50: 6573 7469 6e67 2065 6e76 2066 6f72 2064  esting env for d
+0001fa60: 6973 6b20 7469 6572 202d 2d2d 2d2d 2d2d  isk tier -------
+0001fa70: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
+0001fa80: 2e61 7773 0a64 6566 2074 6573 745f 6177  .aws.def test_aw
+0001fa90: 735f 6469 736b 5f74 6965 7228 293a 0a0a  s_disk_tier():..
+0001faa0: 2020 2020 6465 6620 5f67 6574 5f61 7773      def _get_aws
+0001fab0: 5f71 7565 7279 5f63 6f6d 6d61 6e64 2872  _query_command(r
+0001fac0: 6567 696f 6e2c 2069 6e73 7461 6e63 655f  egion, instance_
+0001fad0: 6964 2c20 6669 656c 642c 2065 7870 6563  id, field, expec
+0001fae0: 7465 6429 3a0a 2020 2020 2020 2020 7265  ted):.        re
+0001faf0: 7475 726e 2028 6627 6177 7320 6563 3220  turn (f'aws ec2 
+0001fb00: 6465 7363 7269 6265 2d76 6f6c 756d 6573  describe-volumes
+0001fb10: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+0001fb20: 6e7d 2027 0a20 2020 2020 2020 2020 2020  n} '.           
+0001fb30: 2020 2020 2066 272d 2d66 696c 7465 7273       f'--filters
+0001fb40: 204e 616d 653d 6174 7461 6368 6d65 6e74   Name=attachment
+0001fb50: 2e69 6e73 7461 6e63 652d 6964 2c56 616c  .instance-id,Val
+0001fb60: 7565 733d 7b69 6e73 7461 6e63 655f 6964  ues={instance_id
+0001fb70: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
+0001fb80: 2020 2020 6627 2d2d 7175 6572 7920 566f      f'--query Vo
+0001fb90: 6c75 6d65 735b 2a5d 2e7b 6669 656c 647d  lumes[*].{field}
+0001fba0: 207c 2067 7265 7020 7b65 7870 6563 7465   | grep {expecte
+0001fbb0: 647d 203b 2027 290a 0a20 2020 2066 6f72  d} ; ')..    for
+0001fbc0: 2064 6973 6b5f 7469 6572 2069 6e20 6c69   disk_tier in li
+0001fbd0: 7374 2872 6573 6f75 7263 6573 5f75 7469  st(resources_uti
+0001fbe0: 6c73 2e44 6973 6b54 6965 7229 3a0a 2020  ls.DiskTier):.  
+0001fbf0: 2020 2020 2020 7370 6563 7320 3d20 4157        specs = AW
+0001fc00: 532e 5f67 6574 5f64 6973 6b5f 7370 6563  S._get_disk_spec
+0001fc10: 7328 6469 736b 5f74 6965 7229 0a20 2020  s(disk_tier).   
+0001fc20: 2020 2020 206e 616d 6520 3d20 5f67 6574       name = _get
+0001fc30: 5f63 6c75 7374 6572 5f6e 616d 6528 2920  _cluster_name() 
+0001fc40: 2b20 272d 2720 2b20 6469 736b 5f74 6965  + '-' + disk_tie
+0001fc50: 722e 7661 6c75 650a 2020 2020 2020 2020  r.value.        
+0001fc60: 6e61 6d65 5f6f 6e5f 636c 6f75 6420 3d20  name_on_cloud = 
+0001fc70: 636f 6d6d 6f6e 5f75 7469 6c73 2e6d 616b  common_utils.mak
+0001fc80: 655f 636c 7573 7465 725f 6e61 6d65 5f6f  e_cluster_name_o
+0001fc90: 6e5f 636c 6f75 6428 0a20 2020 2020 2020  n_cloud(.       
+0001fca0: 2020 2020 206e 616d 652c 2073 6b79 2e41       name, sky.A
+0001fcb0: 5753 2e6d 6178 5f63 6c75 7374 6572 5f6e  WS.max_cluster_n
+0001fcc0: 616d 655f 6c65 6e67 7468 2829 290a 2020  ame_length()).  
+0001fcd0: 2020 2020 2020 7265 6769 6f6e 203d 2027        region = '
+0001fce0: 7573 2d65 6173 742d 3227 0a20 2020 2020  us-east-2'.     
+0001fcf0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+0001fd00: 2020 2020 2020 2020 2020 2020 2761 7773              'aws
+0001fd10: 2d64 6973 6b2d 7469 6572 2d27 202b 2064  -disk-tier-' + d
+0001fd20: 6973 6b5f 7469 6572 2e76 616c 7565 2c0a  isk_tier.value,.
+0001fd30: 2020 2020 2020 2020 2020 2020 5b0a 2020              [.  
+0001fd40: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0001fd50: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+0001fd60: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+0001fd70: 6177 7320 2d2d 7265 6769 6f6e 207b 7265  aws --region {re
+0001fd80: 6769 6f6e 7d20 270a 2020 2020 2020 2020  gion} '.        
+0001fd90: 2020 2020 2020 2020 6627 2d2d 6469 736b          f'--disk
+0001fda0: 2d74 6965 7220 7b64 6973 6b5f 7469 6572  -tier {disk_tier
+0001fdb0: 2e76 616c 7565 7d20 6563 686f 2022 6865  .value} echo "he
+0001fdc0: 6c6c 6f20 736b 7922 272c 0a20 2020 2020  llo sky"',.     
+0001fdd0: 2020 2020 2020 2020 2020 2066 2769 643d             f'id=
+0001fde0: 6061 7773 2065 6332 2064 6573 6372 6962  `aws ec2 describ
+0001fdf0: 652d 696e 7374 616e 6365 7320 2d2d 7265  e-instances --re
+0001fe00: 6769 6f6e 207b 7265 6769 6f6e 7d20 2d2d  gion {region} --
+0001fe10: 6669 6c74 6572 7320 270a 2020 2020 2020  filters '.      
+0001fe20: 2020 2020 2020 2020 2020 6627 4e61 6d65            f'Name
+0001fe30: 3d74 6167 3a72 6179 2d63 6c75 7374 6572  =tag:ray-cluster
+0001fe40: 2d6e 616d 652c 5661 6c75 6573 3d7b 6e61  -name,Values={na
+0001fe50: 6d65 5f6f 6e5f 636c 6f75 647d 202d 2d71  me_on_cloud} --q
+0001fe60: 7565 7279 2027 0a20 2020 2020 2020 2020  uery '.         
+0001fe70: 2020 2020 2020 2066 2752 6573 6572 7661         f'Reserva
+0001fe80: 7469 6f6e 735b 5d2e 496e 7374 616e 6365  tions[].Instance
+0001fe90: 735b 5d2e 496e 7374 616e 6365 4964 202d  s[].InstanceId -
+0001fea0: 2d6f 7574 7075 7420 7465 7874 603b 2027  -output text`; '
+0001feb0: 202b 0a20 2020 2020 2020 2020 2020 2020   +.             
+0001fec0: 2020 205f 6765 745f 6177 735f 7175 6572     _get_aws_quer
+0001fed0: 795f 636f 6d6d 616e 6428 7265 6769 6f6e  y_command(region
+0001fee0: 2c20 2724 6964 272c 2027 566f 6c75 6d65  , '$id', 'Volume
+0001fef0: 5479 7065 272c 0a20 2020 2020 2020 2020  Type',.         
+0001ff00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ff10: 2020 2020 2020 2020 2020 2020 2020 7370                sp
+0001ff20: 6563 735b 2764 6973 6b5f 7469 6572 275d  ecs['disk_tier']
+0001ff30: 2920 2b0a 2020 2020 2020 2020 2020 2020  ) +.            
+0001ff40: 2020 2020 2827 2720 6966 2064 6973 6b5f      ('' if disk_
+0001ff50: 7469 6572 203d 3d20 7265 736f 7572 6365  tier == resource
+0001ff60: 735f 7574 696c 732e 4469 736b 5469 6572  s_utils.DiskTier
+0001ff70: 2e4c 4f57 2065 6c73 650a 2020 2020 2020  .LOW else.      
+0001ff80: 2020 2020 2020 2020 2020 2028 5f67 6574             (_get
+0001ff90: 5f61 7773 5f71 7565 7279 5f63 6f6d 6d61  _aws_query_comma
+0001ffa0: 6e64 2872 6567 696f 6e2c 2027 2469 6427  nd(region, '$id'
+0001ffb0: 2c20 2749 6f70 7327 2c0a 2020 2020 2020  , 'Iops',.      
+0001ffc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ffd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ffe0: 2020 2073 7065 6373 5b27 6469 736b 5f69     specs['disk_i
+0001fff0: 6f70 7327 5d29 202b 0a20 2020 2020 2020  ops']) +.       
+00020000: 2020 2020 2020 2020 2020 205f 6765 745f             _get_
+00020010: 6177 735f 7175 6572 795f 636f 6d6d 616e  aws_query_comman
+00020020: 6428 7265 6769 6f6e 2c20 2724 6964 272c  d(region, '$id',
+00020030: 2027 5468 726f 7567 6870 7574 272c 0a20   'Throughput',. 
+00020040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020060: 2020 2020 2020 2020 7370 6563 735b 2764          specs['d
+00020070: 6973 6b5f 7468 726f 7567 6870 7574 275d  isk_throughput']
+00020080: 2929 292c 0a20 2020 2020 2020 2020 2020  ))),.           
+00020090: 205d 2c0a 2020 2020 2020 2020 2020 2020   ],.            
+000200a0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+000200b0: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
+000200c0: 2020 2074 696d 656f 7574 3d31 3020 2a20     timeout=10 * 
+000200d0: 3630 2c20 2023 2031 3020 6d69 6e73 2020  60,  # 10 mins  
+000200e0: 2869 7420 7461 6b65 7320 6172 6f75 6e64  (it takes around
+000200f0: 207e 3620 6d69 6e73 290a 2020 2020 2020   ~6 mins).      
+00020100: 2020 290a 2020 2020 2020 2020 7275 6e5f    ).        run_
+00020110: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00020120: 0a40 7079 7465 7374 2e6d 6172 6b2e 6763  .@pytest.mark.gc
+00020130: 700a 6465 6620 7465 7374 5f67 6370 5f64  p.def test_gcp_d
+00020140: 6973 6b5f 7469 6572 2829 3a0a 2020 2020  isk_tier():.    
+00020150: 666f 7220 6469 736b 5f74 6965 7220 696e  for disk_tier in
+00020160: 206c 6973 7428 7265 736f 7572 6365 735f   list(resources_
+00020170: 7574 696c 732e 4469 736b 5469 6572 293a  utils.DiskTier):
+00020180: 0a20 2020 2020 2020 2074 7970 6520 3d20  .        type = 
+00020190: 4743 502e 5f67 6574 5f64 6973 6b5f 7479  GCP._get_disk_ty
+000201a0: 7065 2864 6973 6b5f 7469 6572 290a 2020  pe(disk_tier).  
+000201b0: 2020 2020 2020 6e61 6d65 203d 205f 6765        name = _ge
+000201c0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+000201d0: 202b 2027 2d27 202b 2064 6973 6b5f 7469   + '-' + disk_ti
+000201e0: 6572 2e76 616c 7565 0a20 2020 2020 2020  er.value.       
+000201f0: 206e 616d 655f 6f6e 5f63 6c6f 7564 203d   name_on_cloud =
+00020200: 2063 6f6d 6d6f 6e5f 7574 696c 732e 6d61   common_utils.ma
+00020210: 6b65 5f63 6c75 7374 6572 5f6e 616d 655f  ke_cluster_name_
+00020220: 6f6e 5f63 6c6f 7564 280a 2020 2020 2020  on_cloud(.      
+00020230: 2020 2020 2020 6e61 6d65 2c20 736b 792e        name, sky.
+00020240: 4743 502e 6d61 785f 636c 7573 7465 725f  GCP.max_cluster_
+00020250: 6e61 6d65 5f6c 656e 6774 6828 2929 0a20  name_length()). 
+00020260: 2020 2020 2020 2072 6567 696f 6e20 3d20         region = 
+00020270: 2775 732d 7765 7374 3227 0a20 2020 2020  'us-west2'.     
+00020280: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00020290: 2020 2020 2020 2020 2020 2020 2767 6370              'gcp
+000202a0: 2d64 6973 6b2d 7469 6572 2d27 202b 2064  -disk-tier-' + d
+000202b0: 6973 6b5f 7469 6572 2e76 616c 7565 2c0a  isk_tier.value,.
+000202c0: 2020 2020 2020 2020 2020 2020 5b0a 2020              [.  
+000202d0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+000202e0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+000202f0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00020300: 6763 7020 2d2d 7265 6769 6f6e 207b 7265  gcp --region {re
+00020310: 6769 6f6e 7d20 270a 2020 2020 2020 2020  gion} '.        
+00020320: 2020 2020 2020 2020 6627 2d2d 6469 736b          f'--disk
+00020330: 2d74 6965 7220 7b64 6973 6b5f 7469 6572  -tier {disk_tier
+00020340: 2e76 616c 7565 7d20 6563 686f 2022 6865  .value} echo "he
+00020350: 6c6c 6f20 736b 7922 272c 0a20 2020 2020  llo sky"',.     
+00020360: 2020 2020 2020 2020 2020 2066 276e 616d             f'nam
+00020370: 653d 6067 636c 6f75 6420 636f 6d70 7574  e=`gcloud comput
+00020380: 6520 696e 7374 616e 6365 7320 6c69 7374  e instances list
+00020390: 202d 2d66 696c 7465 723d 270a 2020 2020   --filter='.    
+000203a0: 2020 2020 2020 2020 2020 2020 6627 226c              f'"l
+000203b0: 6162 656c 732e 7261 792d 636c 7573 7465  abels.ray-cluste
+000203c0: 722d 6e61 6d65 3a7b 6e61 6d65 5f6f 6e5f  r-name:{name_on_
+000203d0: 636c 6f75 647d 2220 270a 2020 2020 2020  cloud}" '.      
+000203e0: 2020 2020 2020 2020 2020 272d 2d66 6f72            '--for
+000203f0: 6d61 743d 2276 616c 7565 286e 616d 6529  mat="value(name)
+00020400: 2260 3b20 270a 2020 2020 2020 2020 2020  "`; '.          
+00020410: 2020 2020 2020 6627 6763 6c6f 7564 2063        f'gcloud c
+00020420: 6f6d 7075 7465 2064 6973 6b73 206c 6973  ompute disks lis
+00020430: 7420 2d2d 6669 6c74 6572 3d22 6e61 6d65  t --filter="name
+00020440: 3d24 6e61 6d65 2220 270a 2020 2020 2020  =$name" '.      
+00020450: 2020 2020 2020 2020 2020 6627 2d2d 666f            f'--fo
+00020460: 726d 6174 3d22 7661 6c75 6528 7479 7065  rmat="value(type
+00020470: 2922 207c 2067 7265 7020 7b74 7970 657d  )" | grep {type}
+00020480: 2027 0a20 2020 2020 2020 2020 2020 205d   '.            ]
+00020490: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000204a0: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+000204b0: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
+000204c0: 2074 696d 656f 7574 3d36 202a 2036 302c   timeout=6 * 60,
+000204d0: 2020 2320 3620 6d69 6e73 2020 2869 7420    # 6 mins  (it 
+000204e0: 7461 6b65 7320 6172 6f75 6e64 207e 3320  takes around ~3 
+000204f0: 6d69 6e73 290a 2020 2020 2020 2020 290a  mins).        ).
+00020500: 2020 2020 2020 2020 7275 6e5f 6f6e 655f          run_one_
+00020510: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00020520: 7465 7374 2e6d 6172 6b2e 617a 7572 650a  test.mark.azure.
+00020530: 6465 6620 7465 7374 5f61 7a75 7265 5f64  def test_azure_d
+00020540: 6973 6b5f 7469 6572 2829 3a0a 2020 2020  isk_tier():.    
+00020550: 666f 7220 6469 736b 5f74 6965 7220 696e  for disk_tier in
+00020560: 206c 6973 7428 7265 736f 7572 6365 735f   list(resources_
+00020570: 7574 696c 732e 4469 736b 5469 6572 293a  utils.DiskTier):
+00020580: 0a20 2020 2020 2020 2069 6620 6469 736b  .        if disk
+00020590: 5f74 6965 7220 3d3d 2072 6573 6f75 7263  _tier == resourc
+000205a0: 6573 5f75 7469 6c73 2e44 6973 6b54 6965  es_utils.DiskTie
+000205b0: 722e 4849 4748 3a0a 2020 2020 2020 2020  r.HIGH:.        
+000205c0: 2020 2020 2320 417a 7572 6520 646f 6573      # Azure does
+000205d0: 206e 6f74 2073 7570 706f 7274 2068 6967   not support hig
+000205e0: 6820 6469 736b 2074 6965 722e 0a20 2020  h disk tier..   
+000205f0: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
+00020600: 650a 2020 2020 2020 2020 7479 7065 203d  e.        type =
+00020610: 2041 7a75 7265 2e5f 6765 745f 6469 736b   Azure._get_disk
+00020620: 5f74 7970 6528 6469 736b 5f74 6965 7229  _type(disk_tier)
+00020630: 0a20 2020 2020 2020 206e 616d 6520 3d20  .        name = 
+00020640: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00020650: 6528 2920 2b20 272d 2720 2b20 6469 736b  e() + '-' + disk
+00020660: 5f74 6965 722e 7661 6c75 650a 2020 2020  _tier.value.    
+00020670: 2020 2020 6e61 6d65 5f6f 6e5f 636c 6f75      name_on_clou
+00020680: 6420 3d20 636f 6d6d 6f6e 5f75 7469 6c73  d = common_utils
+00020690: 2e6d 616b 655f 636c 7573 7465 725f 6e61  .make_cluster_na
+000206a0: 6d65 5f6f 6e5f 636c 6f75 6428 0a20 2020  me_on_cloud(.   
+000206b0: 2020 2020 2020 2020 206e 616d 652c 2073           name, s
+000206c0: 6b79 2e41 7a75 7265 2e6d 6178 5f63 6c75  ky.Azure.max_clu
+000206d0: 7374 6572 5f6e 616d 655f 6c65 6e67 7468  ster_name_length
+000206e0: 2829 290a 2020 2020 2020 2020 7265 6769  ()).        regi
+000206f0: 6f6e 203d 2027 7765 7374 7573 3227 0a20  on = 'westus2'. 
+00020700: 2020 2020 2020 2074 6573 7420 3d20 5465         test = Te
+00020710: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
+00020720: 2761 7a75 7265 2d64 6973 6b2d 7469 6572  'azure-disk-tier
+00020730: 2d27 202b 2064 6973 6b5f 7469 6572 2e76  -' + disk_tier.v
+00020740: 616c 7565 2c0a 2020 2020 2020 2020 2020  alue,.          
+00020750: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00020760: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00020770: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+00020780: 636c 6f75 6420 617a 7572 6520 2d2d 7265  cloud azure --re
+00020790: 6769 6f6e 207b 7265 6769 6f6e 7d20 270a  gion {region} '.
+000207a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000207b0: 6627 2d2d 6469 736b 2d74 6965 7220 7b64  f'--disk-tier {d
+000207c0: 6973 6b5f 7469 6572 2e76 616c 7565 7d20  isk_tier.value} 
+000207d0: 6563 686f 2022 6865 6c6c 6f20 736b 7922  echo "hello sky"
+000207e0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+000207f0: 2020 2066 2761 7a20 7265 736f 7572 6365     f'az resource
+00020800: 206c 6973 7420 2d2d 7461 6720 7261 792d   list --tag ray-
+00020810: 636c 7573 7465 722d 6e61 6d65 3d7b 6e61  cluster-name={na
+00020820: 6d65 5f6f 6e5f 636c 6f75 647d 202d 2d71  me_on_cloud} --q
+00020830: 7565 7279 2027 0a20 2020 2020 2020 2020  uery '.         
+00020840: 2020 2020 2020 2066 2722 5b3f 7479 7065         f'"[?type
+00020850: 3d3d 5c27 4d69 6372 6f73 6f66 742e 436f  ==\'Microsoft.Co
+00020860: 6d70 7574 652f 6469 736b 735c 275d 2e73  mpute/disks\'].s
+00020870: 6b75 2e6e 616d 6522 2027 0a20 2020 2020  ku.name" '.     
+00020880: 2020 2020 2020 2020 2020 2066 272d 2d6f             f'--o
+00020890: 7574 7075 7420 7473 7620 7c20 6772 6570  utput tsv | grep
+000208a0: 207b 7479 7065 7d27 0a20 2020 2020 2020   {type}'.       
+000208b0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+000208c0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+000208d0: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+000208e0: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+000208f0: 3020 2a20 3630 2c20 2023 2032 3020 6d69  0 * 60,  # 20 mi
+00020900: 6e73 2020 2869 7420 7461 6b65 7320 6172  ns  (it takes ar
+00020910: 6f75 6e64 207e 3132 206d 696e 7329 0a20  ound ~12 mins). 
+00020920: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00020930: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00020940: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00020950: 726b 2e61 7a75 7265 0a64 6566 2074 6573  rk.azure.def tes
+00020960: 745f 617a 7572 655f 6265 7374 5f74 6965  t_azure_best_tie
+00020970: 725f 6661 696c 6f76 6572 2829 3a0a 2020  r_failover():.  
+00020980: 2020 7479 7065 203d 2041 7a75 7265 2e5f    type = Azure._
+00020990: 6765 745f 6469 736b 5f74 7970 6528 7265  get_disk_type(re
+000209a0: 736f 7572 6365 735f 7574 696c 732e 4469  sources_utils.Di
+000209b0: 736b 5469 6572 2e4c 4f57 290a 2020 2020  skTier.LOW).    
+000209c0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+000209d0: 7465 725f 6e61 6d65 2829 0a20 2020 206e  ter_name().    n
+000209e0: 616d 655f 6f6e 5f63 6c6f 7564 203d 2063  ame_on_cloud = c
+000209f0: 6f6d 6d6f 6e5f 7574 696c 732e 6d61 6b65  ommon_utils.make
+00020a00: 5f63 6c75 7374 6572 5f6e 616d 655f 6f6e  _cluster_name_on
+00020a10: 5f63 6c6f 7564 280a 2020 2020 2020 2020  _cloud(.        
+00020a20: 6e61 6d65 2c20 736b 792e 417a 7572 652e  name, sky.Azure.
+00020a30: 6d61 785f 636c 7573 7465 725f 6e61 6d65  max_cluster_name
+00020a40: 5f6c 656e 6774 6828 2929 0a20 2020 2072  _length()).    r
+00020a50: 6567 696f 6e20 3d20 2777 6573 7475 7332  egion = 'westus2
+00020a60: 270a 2020 2020 7465 7374 203d 2054 6573  '.    test = Tes
+00020a70: 7428 0a20 2020 2020 2020 2027 617a 7572  t(.        'azur
+00020a80: 652d 6265 7374 2d74 6965 722d 6661 696c  e-best-tier-fail
+00020a90: 6f76 6572 272c 0a20 2020 2020 2020 205b  over',.        [
+00020aa0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00020ab0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00020ac0: 7b6e 616d 657d 202d 2d63 6c6f 7564 2061  {name} --cloud a
+00020ad0: 7a75 7265 202d 2d72 6567 696f 6e20 7b72  zure --region {r
+00020ae0: 6567 696f 6e7d 2027 0a20 2020 2020 2020  egion} '.       
+00020af0: 2020 2020 2066 272d 2d64 6973 6b2d 7469       f'--disk-ti
+00020b00: 6572 2062 6573 7420 2d2d 696e 7374 616e  er best --instan
+00020b10: 6365 2d74 7970 6520 5374 616e 6461 7264  ce-type Standard
+00020b20: 5f44 385f 7635 2065 6368 6f20 2268 656c  _D8_v5 echo "hel
+00020b30: 6c6f 2073 6b79 2227 2c0a 2020 2020 2020  lo sky"',.      
+00020b40: 2020 2020 2020 6627 617a 2072 6573 6f75        f'az resou
+00020b50: 7263 6520 6c69 7374 202d 2d74 6167 2072  rce list --tag r
+00020b60: 6179 2d63 6c75 7374 6572 2d6e 616d 653d  ay-cluster-name=
+00020b70: 7b6e 616d 655f 6f6e 5f63 6c6f 7564 7d20  {name_on_cloud} 
+00020b80: 2d2d 7175 6572 7920 270a 2020 2020 2020  --query '.      
+00020b90: 2020 2020 2020 6627 225b 3f74 7970 653d        f'"[?type=
+00020ba0: 3d5c 274d 6963 726f 736f 6674 2e43 6f6d  =\'Microsoft.Com
+00020bb0: 7075 7465 2f64 6973 6b73 5c27 5d2e 736b  pute/disks\'].sk
+00020bc0: 752e 6e61 6d65 2220 270a 2020 2020 2020  u.name" '.      
+00020bd0: 2020 2020 2020 6627 2d2d 6f75 7470 7574        f'--output
+00020be0: 2074 7376 207c 2067 7265 7020 7b74 7970   tsv | grep {typ
+00020bf0: 657d 272c 0a20 2020 2020 2020 205d 2c0a  e}',.        ],.
+00020c00: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+00020c10: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+00020c20: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+00020c30: 3020 2a20 3630 2c20 2023 2032 3020 6d69  0 * 60,  # 20 mi
+00020c40: 6e73 2020 2869 7420 7461 6b65 7320 6172  ns  (it takes ar
+00020c50: 6f75 6e64 207e 3132 206d 696e 7329 0a20  ound ~12 mins). 
+00020c60: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00020c70: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+00020c80: 2d2d 2d2d 2d2d 2054 6573 7469 6e67 205a  ------ Testing Z
+00020c90: 6572 6f20 5175 6f74 6120 4661 696c 6f76  ero Quota Failov
+00020ca0: 6572 202d 2d2d 2d2d 2d0a 4070 7974 6573  er ------.@pytes
+00020cb0: 742e 6d61 726b 2e61 7773 0a64 6566 2074  t.mark.aws.def t
+00020cc0: 6573 745f 6177 735f 7a65 726f 5f71 756f  est_aws_zero_quo
+00020cd0: 7461 5f66 6169 6c6f 7665 7228 293a 0a0a  ta_failover():..
+00020ce0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00020cf0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00020d00: 2020 2072 6567 696f 6e20 3d20 6765 745f     region = get_
+00020d10: 6177 735f 7265 6769 6f6e 5f66 6f72 5f71  aws_region_for_q
+00020d20: 756f 7461 5f66 6169 6c6f 7665 7228 290a  uota_failover().
+00020d30: 0a20 2020 2069 6620 6e6f 7420 7265 6769  .    if not regi
+00020d40: 6f6e 3a0a 2020 2020 2020 2020 7079 7465  on:.        pyte
+00020d50: 7374 2e78 6661 696c 280a 2020 2020 2020  st.xfail(.      
+00020d60: 2020 2020 2020 2755 6e61 626c 6520 746f        'Unable to
+00020d70: 2074 6573 7420 7a65 726f 2071 756f 7461   test zero quota
+00020d80: 2066 6169 6c6f 7665 7220 6f70 7469 6d69   failover optimi
+00020d90: 7a61 7469 6f6e 20e2 8094 2071 756f 7461  zation ... quota
+00020da0: 7320 270a 2020 2020 2020 2020 2020 2020  s '.            
+00020db0: 2766 6f72 2045 4332 2050 3320 696e 7374  'for EC2 P3 inst
+00020dc0: 616e 6365 7320 7765 7265 2066 6f75 6e64  ances were found
+00020dd0: 206f 6e20 616c 6c20 4157 5320 7265 6769   on all AWS regi
+00020de0: 6f6e 732e 2049 7320 7468 6973 2027 0a20  ons. Is this '. 
+00020df0: 2020 2020 2020 2020 2020 2027 6578 7065             'expe
+00020e00: 6374 6564 2066 6f72 2079 6f75 7220 6163  cted for your ac
+00020e10: 636f 756e 743f 2729 0a20 2020 2020 2020  count?').       
+00020e20: 2072 6574 7572 6e0a 0a20 2020 2074 6573   return..    tes
+00020e30: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00020e40: 2020 2761 7773 2d7a 6572 6f2d 7175 6f74    'aws-zero-quot
+00020e50: 612d 6661 696c 6f76 6572 272c 0a20 2020  a-failover',.   
+00020e60: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00020e70: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00020e80: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
+00020e90: 6c6f 7564 2061 7773 202d 2d72 6567 696f  loud aws --regio
+00020ea0: 6e20 7b72 6567 696f 6e7d 202d 2d67 7075  n {region} --gpu
+00020eb0: 7320 5631 3030 3a38 202d 2d75 7365 2d73  s V100:8 --use-s
+00020ec0: 706f 7420 7c20 6772 6570 2022 466f 756e  pot | grep "Foun
+00020ed0: 6420 6e6f 2071 756f 7461 2227 2c0a 2020  d no quota"',.  
+00020ee0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00020ef0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00020f00: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+00020f10: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00020f20: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00020f30: 6172 6b2e 6763 700a 6465 6620 7465 7374  ark.gcp.def test
+00020f40: 5f67 6370 5f7a 6572 6f5f 7175 6f74 615f  _gcp_zero_quota_
+00020f50: 6661 696c 6f76 6572 2829 3a0a 0a20 2020  failover():..   
+00020f60: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+00020f70: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+00020f80: 7265 6769 6f6e 203d 2067 6574 5f67 6370  region = get_gcp
+00020f90: 5f72 6567 696f 6e5f 666f 725f 7175 6f74  _region_for_quot
+00020fa0: 615f 6661 696c 6f76 6572 2829 0a0a 2020  a_failover()..  
+00020fb0: 2020 6966 206e 6f74 2072 6567 696f 6e3a    if not region:
+00020fc0: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
+00020fd0: 7866 6169 6c28 0a20 2020 2020 2020 2020  xfail(.         
+00020fe0: 2020 2027 556e 6162 6c65 2074 6f20 7465     'Unable to te
+00020ff0: 7374 207a 6572 6f20 7175 6f74 6120 6661  st zero quota fa
+00021000: 696c 6f76 6572 206f 7074 696d 697a 6174  ilover optimizat
+00021010: 696f 6e20 e280 9420 7175 6f74 6173 2027  ion ... quotas '
+00021020: 0a20 2020 2020 2020 2020 2020 2027 666f  .            'fo
+00021030: 7220 4131 3030 2d38 3047 4220 4750 5573  r A100-80GB GPUs
+00021040: 2077 6572 6520 666f 756e 6420 6f6e 2061   were found on a
+00021050: 6c6c 2047 4350 2072 6567 696f 6e73 2e20  ll GCP regions. 
+00021060: 4973 2074 6869 7320 270a 2020 2020 2020  Is this '.      
+00021070: 2020 2020 2020 2765 7870 6563 7465 6420        'expected 
+00021080: 666f 7220 796f 7572 2061 6363 6f75 6e74  for your account
+00021090: 3f27 290a 2020 2020 2020 2020 7265 7475  ?').        retu
+000210a0: 726e 0a0a 2020 2020 7465 7374 203d 2054  rn..    test = T
+000210b0: 6573 7428 0a20 2020 2020 2020 2027 6763  est(.        'gc
+000210c0: 702d 7a65 726f 2d71 756f 7461 2d66 6169  p-zero-quota-fai
+000210d0: 6c6f 7665 7227 2c0a 2020 2020 2020 2020  lover',.        
+000210e0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+000210f0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00021100: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00021110: 6763 7020 2d2d 7265 6769 6f6e 207b 7265  gcp --region {re
+00021120: 6769 6f6e 7d20 2d2d 6770 7573 2041 3130  gion} --gpus A10
+00021130: 302d 3830 4742 3a31 202d 2d75 7365 2d73  0-80GB:1 --use-s
+00021140: 706f 7420 7c20 6772 6570 2022 466f 756e  pot | grep "Foun
+00021150: 6420 6e6f 2071 756f 7461 2227 2c0a 2020  d no quota"',.  
+00021160: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00021170: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00021180: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+00021190: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+000211a0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
+000211b0: 2d2d 2d20 5465 7374 696e 6720 736b 7973  --- Testing skys
+000211c0: 6572 7665 202d 2d2d 2d2d 2d2d 2d2d 2d0a  erve ----------.
+000211d0: 0a0a 6465 6620 5f67 6574 5f73 6572 7669  ..def _get_servi
+000211e0: 6365 5f6e 616d 6528 2920 2d3e 2073 7472  ce_name() -> str
+000211f0: 3a0a 2020 2020 2222 2252 6574 7572 6e73  :.    """Returns
+00021200: 2061 2075 7365 722d 756e 6971 7565 2073   a user-unique s
+00021210: 6572 7669 6365 206e 616d 6520 666f 7220  ervice name for 
+00021220: 6561 6368 2074 6573 745f 736b 7973 6572  each test_skyser
+00021230: 7665 5f3c 6e61 6d65 3e28 292e 0a0a 2020  ve_<name>()...  
+00021240: 2020 4d75 7374 2062 6520 6361 6c6c 6564    Must be called
+00021250: 2066 726f 6d20 6561 6368 2074 6573 745f   from each test_
+00021260: 736b 7973 6572 7665 5f3c 6e61 6d65 3e28  skyserve_<name>(
+00021270: 292e 0a20 2020 2022 2222 0a20 2020 2063  )..    """.    c
+00021280: 616c 6c65 725f 6675 6e63 5f6e 616d 6520  aller_func_name 
+00021290: 3d20 696e 7370 6563 742e 7374 6163 6b28  = inspect.stack(
+000212a0: 295b 315d 5b33 5d0a 2020 2020 7465 7374  )[1][3].    test
+000212b0: 5f6e 616d 6520 3d20 6361 6c6c 6572 5f66  _name = caller_f
+000212c0: 756e 635f 6e61 6d65 2e72 6570 6c61 6365  unc_name.replace
+000212d0: 2827 5f27 2c20 272d 2729 2e72 6570 6c61  ('_', '-').repla
+000212e0: 6365 2827 7465 7374 2d27 2c20 2774 2d27  ce('test-', 't-'
+000212f0: 290a 2020 2020 7465 7374 5f6e 616d 6520  ).    test_name 
+00021300: 3d20 7465 7374 5f6e 616d 652e 7265 706c  = test_name.repl
+00021310: 6163 6528 2773 6b79 7365 7276 652d 272c  ace('skyserve-',
+00021320: 2027 7373 2d27 290a 2020 2020 7465 7374   'ss-').    test
+00021330: 5f6e 616d 6520 3d20 636f 6d6d 6f6e 5f75  _name = common_u
+00021340: 7469 6c73 2e6d 616b 655f 636c 7573 7465  tils.make_cluste
+00021350: 725f 6e61 6d65 5f6f 6e5f 636c 6f75 6428  r_name_on_cloud(
+00021360: 7465 7374 5f6e 616d 652c 2032 3429 0a20  test_name, 24). 
+00021370: 2020 2072 6574 7572 6e20 6627 7b74 6573     return f'{tes
+00021380: 745f 6e61 6d65 7d2d 7b74 6573 745f 6964  t_name}-{test_id
+00021390: 7d27 0a0a 0a23 2057 6520 6368 6563 6b20  }'...# We check 
+000213a0: 7468 6520 6f75 7470 7574 206f 6620 7468  the output of th
+000213b0: 6520 736b 7973 6572 7665 2073 6572 7669  e skyserve servi
+000213c0: 6365 2074 6f20 7365 6520 6966 2069 7420  ce to see if it 
+000213d0: 6973 2072 6561 6479 2e20 4f75 7470 7574  is ready. Output
+000213e0: 206f 660a 2320 6052 4550 4c49 4341 5360   of.# `REPLICAS`
+000213f0: 2069 7320 696e 2074 6865 2066 6f72 6d20   is in the form 
+00021400: 6f66 2060 312f 3260 2077 6865 7265 2074  of `1/2` where t
+00021410: 6865 2066 6972 7374 206e 756d 6265 7220  he first number 
+00021420: 6973 2074 6865 206e 756d 6265 7220 6f66  is the number of
+00021430: 0a23 2072 6561 6479 2072 6570 6c69 6361  .# ready replica
+00021440: 7320 616e 6420 7468 6520 7365 636f 6e64  s and the second
+00021450: 206e 756d 6265 7220 6973 2074 6865 206e   number is the n
+00021460: 756d 6265 7220 6f66 2074 6f74 616c 2072  umber of total r
+00021470: 6570 6c69 6361 732e 2057 650a 2320 6772  eplicas. We.# gr
+00021480: 6570 2073 7563 6820 666f 726d 6174 2074  ep such format t
+00021490: 6f20 656e 7375 7265 2074 6861 7420 7468  o ensure that th
+000214a0: 6520 7365 7276 6963 6520 6973 2072 6561  e service is rea
+000214b0: 6479 2c20 616e 6420 6561 726c 7920 6578  dy, and early ex
+000214c0: 6974 2069 6620 616e 790a 2320 6661 696c  it if any.# fail
+000214d0: 7572 6520 6465 7465 6374 6564 2e20 496e  ure detected. In
+000214e0: 2074 6865 2065 6e64 2077 6520 736c 6565   the end we slee
+000214f0: 7020 666f 720a 2320 7365 7276 652e 4c42  p for.# serve.LB
+00021500: 5f43 4f4e 5452 4f4c 4c45 525f 5359 4e43  _CONTROLLER_SYNC
+00021510: 5f49 4e54 4552 5641 4c5f 5345 434f 4e44  _INTERVAL_SECOND
+00021520: 5320 746f 206d 616b 6520 7375 7265 206c  S to make sure l
+00021530: 6f61 6420 6261 6c61 6e63 6572 2068 6176  oad balancer hav
+00021540: 650a 2320 656e 6f75 6768 2074 696d 6520  e.# enough time 
+00021550: 746f 2073 796e 6320 7769 7468 2074 6865  to sync with the
+00021560: 2063 6f6e 7472 6f6c 6c65 7220 616e 6420   controller and 
+00021570: 6765 7420 616c 6c20 7265 6164 7920 7265  get all ready re
+00021580: 706c 6963 6120 4950 732e 0a5f 5345 5256  plica IPs.._SERV
+00021590: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
+000215a0: 4459 203d 2028 0a20 2020 2027 7b7b 2077  DY = (.    '{{ w
+000215b0: 6869 6c65 2074 7275 653b 2064 6f27 0a20  hile true; do'. 
+000215c0: 2020 2027 2020 2020 2073 3d24 2873 6b79     '     s=$(sky
+000215d0: 2073 6572 7665 2073 7461 7475 7320 7b6e   serve status {n
+000215e0: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
+000215f0: 3b27 0a20 2020 2027 2020 2020 2065 6368  ;'.    '     ech
+00021600: 6f20 2224 7322 207c 2067 7265 7020 2d71  o "$s" | grep -q
+00021610: 2022 7b72 6570 6c69 6361 5f6e 756d 7d2f   "{replica_num}/
+00021620: 7b72 6570 6c69 6361 5f6e 756d 7d22 2026  {replica_num}" &
+00021630: 2620 6272 6561 6b3b 270a 2020 2020 2720  & break;'.    ' 
+00021640: 2020 2020 6563 686f 2022 2473 2220 7c20      echo "$s" | 
+00021650: 6772 6570 202d 7120 2246 4149 4c45 4422  grep -q "FAILED"
+00021660: 2026 2620 6578 6974 2031 3b27 0a20 2020   && exit 1;'.   
+00021670: 2027 2020 2020 2073 6c65 6570 2031 303b   '     sleep 10;
+00021680: 270a 2020 2020 2720 646f 6e65 3b20 7d7d  '.    ' done; }}
+00021690: 3b20 6563 686f 2022 476f 7420 7365 7276  ; echo "Got serv
+000216a0: 6963 6520 7374 6174 7573 2024 7322 3b27  ice status $s";'
+000216b0: 0a20 2020 2066 2773 6c65 6570 207b 7365  .    f'sleep {se
+000216c0: 7276 652e 4c42 5f43 4f4e 5452 4f4c 4c45  rve.LB_CONTROLLE
+000216d0: 525f 5359 4e43 5f49 4e54 4552 5641 4c5f  R_SYNC_INTERVAL_
+000216e0: 5345 434f 4e44 5320 2b20 327d 3b27 290a  SECONDS + 2};').
+000216f0: 5f49 505f 5245 4745 5820 3d20 7227 285b  _IP_REGEX = r'([
+00021700: 302d 395d 7b31 2c33 7d5c 2e29 7b33 7d5b  0-9]{1,3}\.){3}[
+00021710: 302d 395d 7b31 2c33 7d27 0a5f 4157 4b5f  0-9]{1,3}'._AWK_
+00021720: 414c 4c5f 4c49 4e45 535f 4245 4c4f 575f  ALL_LINES_BELOW_
+00021730: 5245 504c 4943 4153 203d 2072 272f 5265  REPLICAS = r'/Re
+00021740: 706c 6963 6173 2f7b 666c 6167 3d31 3b20  plicas/{flag=1; 
+00021750: 6e65 7874 7d20 666c 6167 270a 5f53 4552  next} flag'._SER
+00021760: 5649 4345 5f4c 4155 4e43 4849 4e47 5f53  VICE_LAUNCHING_S
+00021770: 5441 5455 535f 5245 4745 5820 3d20 2750  TATUS_REGEX = 'P
+00021780: 524f 5649 5349 4f4e 494e 475c 7c53 5441  ROVISIONING\|STA
+00021790: 5254 494e 4727 0a23 2053 696e 6365 2077  RTING'.# Since w
+000217a0: 6520 646f 6e27 7420 616c 6c6f 7720 7465  e don't allow te
+000217b0: 726d 696e 6174 6520 7468 6520 7365 7276  rminate the serv
+000217c0: 6963 6520 6966 2074 6865 2063 6f6e 7472  ice if the contr
+000217d0: 6f6c 6c65 7220 6973 2049 4e49 542c 0a23  oller is INIT,.#
+000217e0: 2077 6869 6368 2069 7320 636f 6d6d 6f6e   which is common
+000217f0: 2066 6f72 2073 696d 756c 7461 6e65 6f75   for simultaneou
+00021800: 7320 7079 7465 7374 2c20 7765 206e 6565  s pytest, we nee
+00021810: 6420 746f 2077 6169 7420 756e 7469 6c20  d to wait until 
+00021820: 7468 650a 2320 636f 6e74 726f 6c6c 6572  the.# controller
+00021830: 2069 7320 5550 2062 6566 6f72 6520 7765   is UP before we
+00021840: 2063 616e 2074 6572 6d69 6e61 7465 2074   can terminate t
+00021850: 6865 2073 6572 7669 6365 2e0a 2320 5468  he service..# Th
+00021860: 6520 7465 6172 646f 776e 2063 6f6d 6d61  e teardown comma
+00021870: 6e64 2068 6173 2061 2031 302d 6d69 6e73  nd has a 10-mins
+00021880: 2074 696d 656f 7574 2c20 736f 2077 6520   timeout, so we 
+00021890: 646f 6e27 7420 6e65 6564 2074 6f20 646f  don't need to do
+000218a0: 0a23 2074 6865 2074 696d 656f 7574 2068  .# the timeout h
+000218b0: 6572 652e 2053 6565 2069 6d70 6c65 6d65  ere. See impleme
+000218c0: 6e74 6174 696f 6e20 6f66 2072 756e 5f6f  ntation of run_o
+000218d0: 6e65 5f74 6573 7428 2920 666f 7220 6465  ne_test() for de
+000218e0: 7461 696c 732e 0a5f 5445 4152 444f 574e  tails.._TEARDOWN
+000218f0: 5f53 4552 5649 4345 203d 2028 0a20 2020  _SERVICE = (.   
+00021900: 2027 2866 6f72 2069 2069 6e20 6073 6571   '(for i in `seq
+00021910: 2031 2032 3060 3b20 646f 270a 2020 2020   1 20`; do'.    
+00021920: 2720 2020 2020 733d 2428 736b 7920 7365  '     s=$(sky se
+00021930: 7276 6520 646f 776e 202d 7920 7b6e 616d  rve down -y {nam
+00021940: 657d 293b 270a 2020 2020 2720 2020 2020  e});'.    '     
+00021950: 6563 686f 2022 5472 7969 6e67 2074 6f20  echo "Trying to 
+00021960: 7465 726d 696e 6174 6520 7b6e 616d 657d  terminate {name}
+00021970: 223b 270a 2020 2020 2720 2020 2020 6563  ";'.    '     ec
+00021980: 686f 2022 2473 223b 270a 2020 2020 2720  ho "$s";'.    ' 
+00021990: 2020 2020 6563 686f 2022 2473 2220 7c20      echo "$s" | 
+000219a0: 6772 6570 202d 7120 2273 6368 6564 756c  grep -q "schedul
+000219b0: 6564 2074 6f20 6265 2074 6572 6d69 6e61  ed to be termina
+000219c0: 7465 645c 7c4e 6f20 7365 7276 6963 6520  ted\|No service 
+000219d0: 746f 2074 6572 6d69 6e61 7465 2220 2626  to terminate" &&
+000219e0: 2062 7265 616b 3b27 0a20 2020 2027 2020   break;'.    '  
+000219f0: 2020 2073 6c65 6570 2031 303b 270a 2020     sleep 10;'.  
+00021a00: 2020 2720 2020 2020 5b20 2469 202d 6571    '     [ $i -eq
+00021a10: 2032 3020 5d20 2626 2065 6368 6f20 2246   20 ] && echo "F
+00021a20: 6169 6c65 6420 746f 2074 6572 6d69 6e61  ailed to termina
+00021a30: 7465 2073 6572 7669 6365 207b 6e61 6d65  te service {name
+00021a40: 7d22 3b27 0a20 2020 2027 646f 6e65 2927  }";'.    'done)'
+00021a50: 290a 0a5f 5345 5256 455f 454e 4450 4f49  ).._SERVE_ENDPOI
+00021a60: 4e54 5f57 4149 5420 3d20 280a 2020 2020  NT_WAIT = (.    
+00021a70: 2765 7870 6f72 7420 4f52 4947 494e 5f53  'export ORIGIN_S
+00021a80: 4b59 5049 4c4f 545f 4445 4255 473d 2453  KYPILOT_DEBUG=$S
+00021a90: 4b59 5049 4c4f 545f 4445 4255 473b 2065  KYPILOT_DEBUG; e
+00021aa0: 7870 6f72 7420 534b 5950 494c 4f54 5f44  xport SKYPILOT_D
+00021ab0: 4542 5547 3d30 3b20 270a 2020 2020 2765  EBUG=0; '.    'e
+00021ac0: 6e64 706f 696e 743d 2428 736b 7920 7365  ndpoint=$(sky se
+00021ad0: 7276 6520 7374 6174 7573 202d 2d65 6e64  rve status --end
+00021ae0: 706f 696e 7420 7b6e 616d 657d 293b 2027  point {name}); '
+00021af0: 0a20 2020 2027 756e 7469 6c20 2120 6563  .    'until ! ec
+00021b00: 686f 2022 2465 6e64 706f 696e 7422 207c  ho "$endpoint" |
+00021b10: 2067 7265 7020 2243 6f6e 7472 6f6c 6c65   grep "Controlle
+00021b20: 7220 6973 2069 6e69 7469 616c 697a 696e  r is initializin
+00021b30: 6722 3b20 270a 2020 2020 2764 6f20 6563  g"; '.    'do ec
+00021b40: 686f 2022 5761 6974 696e 6720 666f 7220  ho "Waiting for 
+00021b50: 7365 7276 6520 656e 6470 6f69 6e74 2074  serve endpoint t
+00021b60: 6f20 6265 2072 6561 6479 2e2e 2e22 3b20  o be ready..."; 
+00021b70: 270a 2020 2020 2773 6c65 6570 2035 3b20  '.    'sleep 5; 
+00021b80: 656e 6470 6f69 6e74 3d24 2873 6b79 2073  endpoint=$(sky s
+00021b90: 6572 7665 2073 7461 7475 7320 2d2d 656e  erve status --en
+00021ba0: 6470 6f69 6e74 207b 6e61 6d65 7d29 3b20  dpoint {name}); 
+00021bb0: 646f 6e65 3b20 270a 2020 2020 2765 7870  done; '.    'exp
+00021bc0: 6f72 7420 534b 5950 494c 4f54 5f44 4542  ort SKYPILOT_DEB
+00021bd0: 5547 3d24 4f52 4947 494e 5f53 4b59 5049  UG=$ORIGIN_SKYPI
+00021be0: 4c4f 545f 4445 4255 473b 2065 6368 6f20  LOT_DEBUG; echo 
+00021bf0: 2224 656e 6470 6f69 6e74 2227 290a 0a5f  "$endpoint"').._
+00021c00: 5345 5256 455f 5354 4154 5553 5f57 4149  SERVE_STATUS_WAI
+00021c10: 5420 3d20 2827 733d 2428 736b 7920 7365  T = ('s=$(sky se
+00021c20: 7276 6520 7374 6174 7573 207b 6e61 6d65  rve status {name
+00021c30: 7d29 3b20 270a 2020 2020 2020 2020 2020  }); '.          
+00021c40: 2020 2020 2020 2020 2020 2020 2775 6e74              'unt
+00021c50: 696c 2021 2065 6368 6f20 2224 7322 207c  il ! echo "$s" |
+00021c60: 2067 7265 7020 2243 6f6e 7472 6f6c 6c65   grep "Controlle
+00021c70: 7220 6973 2069 6e69 7469 616c 697a 696e  r is initializin
+00021c80: 672e 223b 2027 0a20 2020 2020 2020 2020  g."; '.         
+00021c90: 2020 2020 2020 2020 2020 2020 2027 646f               'do
+00021ca0: 2065 6368 6f20 2257 6169 7469 6e67 2066   echo "Waiting f
+00021cb0: 6f72 2073 6572 7665 2073 7461 7475 7320  or serve status 
+00021cc0: 746f 2062 6520 7265 6164 792e 2e2e 223b  to be ready...";
+00021cd0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00021ce0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00021cf0: 353b 2073 3d24 2873 6b79 2073 6572 7665  5; s=$(sky serve
+00021d00: 2073 7461 7475 7320 7b6e 616d 657d 293b   status {name});
+00021d10: 2064 6f6e 653b 2065 6368 6f20 2224 7322   done; echo "$s"
+00021d20: 2729 0a0a 0a64 6566 205f 6765 745f 7265  ')...def _get_re
+00021d30: 706c 6963 615f 6970 286e 616d 653a 2073  plica_ip(name: s
+00021d40: 7472 2c20 7265 706c 6963 615f 6964 3a20  tr, replica_id: 
+00021d50: 696e 7429 202d 3e20 7374 723a 0a20 2020  int) -> str:.   
+00021d60: 2072 6574 7572 6e20 2866 2769 707b 7265   return (f'ip{re
+00021d70: 706c 6963 615f 6964 7d3d 2428 6563 686f  plica_id}=$(echo
+00021d80: 2022 2473 2220 7c20 270a 2020 2020 2020   "$s" | '.      
+00021d90: 2020 2020 2020 6627 6177 6b20 227b 5f41        f'awk "{_A
+00021da0: 574b 5f41 4c4c 5f4c 494e 4553 5f42 454c  WK_ALL_LINES_BEL
+00021db0: 4f57 5f52 4550 4c49 4341 537d 2220 7c20  OW_REPLICAS}" | 
+00021dc0: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+00021dd0: 6772 6570 202d 4520 227b 6e61 6d65 7d5c  grep -E "{name}\
+00021de0: 732b 7b72 6570 6c69 6361 5f69 647d 2220  s+{replica_id}" 
+00021df0: 7c20 270a 2020 2020 2020 2020 2020 2020  | '.            
+00021e00: 6627 6772 6570 202d 456f 2022 7b5f 4950  f'grep -Eo "{_IP
+00021e10: 5f52 4547 4558 7d22 2927 290a 0a0a 6465  _REGEX}")')...de
+00021e20: 6620 5f67 6574 5f73 6b79 7365 7276 655f  f _get_skyserve_
+00021e30: 6874 7470 5f74 6573 7428 6e61 6d65 3a20  http_test(name: 
+00021e40: 7374 722c 2063 6c6f 7564 3a20 7374 722c  str, cloud: str,
+00021e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021e60: 2020 2020 2020 2020 2020 2020 2074 696d               tim
+00021e70: 656f 7574 5f6d 696e 7574 6573 3a20 696e  eout_minutes: in
+00021e80: 7429 202d 3e20 5465 7374 3a0a 2020 2020  t) -> Test:.    
+00021e90: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00021ea0: 2020 2020 2066 2774 6573 742d 736b 7973       f'test-skys
+00021eb0: 6572 7665 2d7b 636c 6f75 642e 7265 706c  erve-{cloud.repl
+00021ec0: 6163 6528 225f 222c 2022 2d22 297d 272c  ace("_", "-")}',
+00021ed0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00021ee0: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
+00021ef0: 7665 2075 7020 2d6e 207b 6e61 6d65 7d20  ve up -n {name} 
+00021f00: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
+00021f10: 652f 6874 7470 2f7b 636c 6f75 647d 2e79  e/http/{cloud}.y
+00021f20: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00021f30: 2020 5f53 4552 5645 5f57 4149 545f 554e    _SERVE_WAIT_UN
+00021f40: 5449 4c5f 5245 4144 592e 666f 726d 6174  TIL_READY.format
+00021f50: 286e 616d 653d 6e61 6d65 2c20 7265 706c  (name=name, repl
+00021f60: 6963 615f 6e75 6d3d 3229 2c0a 2020 2020  ica_num=2),.    
+00021f70: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
+00021f80: 455f 454e 4450 4f49 4e54 5f57 4149 542e  E_ENDPOINT_WAIT.
+00021f90: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00021fa0: 297d 3b20 270a 2020 2020 2020 2020 2020  )}; '.          
+00021fb0: 2020 2763 7572 6c20 6874 7470 3a2f 2f24    'curl http://$
+00021fc0: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
+00021fd0: 2248 692c 2053 6b79 5069 6c6f 7420 6865  "Hi, SkyPilot he
+00021fe0: 7265 2227 2c0a 2020 2020 2020 2020 5d2c  re"',.        ],
+00021ff0: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
+00022000: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
+00022010: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
+00022020: 2020 2020 2020 7469 6d65 6f75 743d 7469        timeout=ti
+00022030: 6d65 6f75 745f 6d69 6e75 7465 7320 2a20  meout_minutes * 
+00022040: 3630 2c0a 2020 2020 290a 2020 2020 7265  60,.    ).    re
+00022050: 7475 726e 2074 6573 740a 0a0a 6465 6620  turn test...def 
+00022060: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
+00022070: 6e5f 7374 6174 7573 286e 616d 653a 2073  n_status(name: s
+00022080: 7472 2c20 6368 6563 6b5f 7475 706c 6573  tr, check_tuples
+00022090: 3a20 4c69 7374 5b54 7570 6c65 5b69 6e74  : List[Tuple[int
+000220a0: 2c20 626f 6f6c 2c0a 2020 2020 2020 2020  , bool,.        
+000220b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000220c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000220d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000220e0: 2020 2020 2020 2020 2073 7472 5d5d 2920           str]]) 
+000220f0: 2d3e 2073 7472 3a0a 2020 2020 2222 2243  -> str:.    """C
+00022100: 6865 636b 2072 6570 6c69 6361 7327 2073  heck replicas' s
+00022110: 7461 7475 7320 616e 6420 636f 756e 7420  tatus and count 
+00022120: 696e 2073 6b79 2073 6572 7665 2073 7461  in sky serve sta
+00022130: 7475 730a 0a20 2020 2057 6520 7769 6c6c  tus..    We will
+00022140: 2063 6865 636b 2076 4350 553d 322c 2061   check vCPU=2, a
+00022150: 7320 616c 6c20 6f75 7220 7465 7374 7320  s all our tests 
+00022160: 7573 6520 7643 5055 3d32 2e0a 2020 2020  use vCPU=2..    
+00022170: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+00022180: 2020 206e 616d 653a 2074 6865 206e 616d     name: the nam
+00022190: 6520 6f66 2074 6865 2073 6572 7669 6365  e of the service
+000221a0: 0a20 2020 2020 2020 2063 6865 636b 5f74  .        check_t
+000221b0: 7570 6c65 733a 2041 206c 6973 7420 6f66  uples: A list of
+000221c0: 2072 6570 6c69 6361 2070 726f 7065 7274   replica propert
+000221d0: 7920 746f 2063 6865 636b 2e20 4561 6368  y to check. Each
+000221e0: 2074 7570 6c65 2069 730a 2020 2020 2020   tuple is.      
+000221f0: 2020 2020 2020 2863 6f75 6e74 2c20 6973        (count, is
+00022200: 5f73 706f 742c 2073 7461 7475 7329 0a20  _spot, status). 
+00022210: 2020 2022 2222 0a20 2020 2063 6865 636b     """.    check
+00022220: 5f63 6d64 203d 2027 270a 2020 2020 666f  _cmd = ''.    fo
+00022230: 7220 6368 6563 6b5f 7475 706c 6520 696e  r check_tuple in
+00022240: 2063 6865 636b 5f74 7570 6c65 733a 0a20   check_tuples:. 
+00022250: 2020 2020 2020 2063 6f75 6e74 2c20 6973         count, is
+00022260: 5f73 706f 742c 2073 7461 7475 7320 3d20  _spot, status = 
+00022270: 6368 6563 6b5f 7475 706c 650a 2020 2020  check_tuple.    
+00022280: 2020 2020 7265 736f 7572 6365 5f73 7472      resource_str
+00022290: 203d 2027 270a 2020 2020 2020 2020 6966   = ''.        if
+000222a0: 2073 7461 7475 7320 6e6f 7420 696e 205b   status not in [
+000222b0: 2750 454e 4449 4e47 272c 2027 5348 5554  'PENDING', 'SHUT
+000222c0: 5449 4e47 5f44 4f57 4e27 0a20 2020 2020  TING_DOWN'.     
+000222d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000222e0: 2020 2020 5d20 616e 6420 6e6f 7420 7374      ] and not st
+000222f0: 6174 7573 2e73 7461 7274 7377 6974 6828  atus.startswith(
+00022300: 2746 4149 4c45 4427 293a 0a20 2020 2020  'FAILED'):.     
+00022310: 2020 2020 2020 2073 706f 745f 7374 7220         spot_str 
+00022320: 3d20 2727 0a20 2020 2020 2020 2020 2020  = ''.           
+00022330: 2069 6620 6973 5f73 706f 743a 0a20 2020   if is_spot:.   
+00022340: 2020 2020 2020 2020 2020 2020 2073 706f               spo
+00022350: 745f 7374 7220 3d20 275c 5b53 706f 745c  t_str = '\[Spot\
+00022360: 5d27 0a20 2020 2020 2020 2020 2020 2072  ]'.            r
+00022370: 6573 6f75 7263 655f 7374 7220 3d20 6627  esource_str = f'
+00022380: 287b 7370 6f74 5f73 7472 7d76 4350 553d  ({spot_str}vCPU=
+00022390: 3229 270a 2020 2020 2020 2020 6368 6563  2)'.        chec
+000223a0: 6b5f 636d 6420 2b3d 2028 6627 2065 6368  k_cmd += (f' ech
+000223b0: 6f20 2224 7322 207c 2067 7265 7020 227b  o "$s" | grep "{
+000223c0: 7265 736f 7572 6365 5f73 7472 7d22 207c  resource_str}" |
+000223d0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+000223e0: 2020 2020 2020 2020 2066 2767 7265 7020           f'grep 
+000223f0: 227b 7374 6174 7573 7d22 207c 2077 6320  "{status}" | wc 
+00022400: 2d6c 207c 2067 7265 7020 7b63 6f75 6e74  -l | grep {count
+00022410: 7d20 7c7c 2065 7869 7420 313b 2729 0a20  } || exit 1;'). 
+00022420: 2020 2072 6574 7572 6e20 2866 277b 5f53     return (f'{_S
+00022430: 4552 5645 5f53 5441 5455 535f 5741 4954  ERVE_STATUS_WAIT
+00022440: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00022450: 6529 7d3b 2065 6368 6f20 2224 7322 3b20  e)}; echo "$s"; 
+00022460: 2720 2b20 6368 6563 6b5f 636d 6429 0a0a  ' + check_cmd)..
+00022470: 0a64 6566 205f 6368 6563 6b5f 7365 7276  .def _check_serv
+00022480: 6963 655f 7665 7273 696f 6e28 7365 7276  ice_version(serv
+00022490: 6963 655f 6e61 6d65 3a20 7374 722c 2076  ice_name: str, v
+000224a0: 6572 7369 6f6e 3a20 7374 7229 202d 3e20  ersion: str) -> 
+000224b0: 7374 723a 0a20 2020 2023 2047 7265 7020  str:.    # Grep 
+000224c0: 7468 6520 6c69 6e65 7320 6265 666f 7265  the lines before
+000224d0: 2027 5365 7276 6963 6520 5265 706c 6963   'Service Replic
+000224e0: 6173 2720 616e 6420 6368 6563 6b20 6966  as' and check if
+000224f0: 2074 6865 2073 6572 7669 6365 2076 6572   the service ver
+00022500: 7369 6f6e 0a20 2020 2023 2069 7320 636f  sion.    # is co
+00022510: 7272 6563 742e 0a20 2020 2072 6574 7572  rrect..    retur
+00022520: 6e20 2866 2765 6368 6f20 2224 7322 207c  n (f'echo "$s" |
+00022530: 2067 7265 7020 2d42 3130 3030 2022 5365   grep -B1000 "Se
+00022540: 7276 6963 6520 5265 706c 6963 6173 2220  rvice Replicas" 
+00022550: 7c20 270a 2020 2020 2020 2020 2020 2020  | '.            
+00022560: 6627 6772 6570 202d 4520 227b 7365 7276  f'grep -E "{serv
+00022570: 6963 655f 6e61 6d65 7d5c 732b 7b76 6572  ice_name}\s+{ver
+00022580: 7369 6f6e 7d22 207c 7c20 6578 6974 2031  sion}" || exit 1
+00022590: 3b20 2729 0a0a 0a40 7079 7465 7374 2e6d  ; ')...@pytest.m
+000225a0: 6172 6b2e 6763 700a 4070 7974 6573 742e  ark.gcp.@pytest.
+000225b0: 6d61 726b 2e73 6572 7665 0a64 6566 2074  mark.serve.def t
+000225c0: 6573 745f 736b 7973 6572 7665 5f67 6370  est_skyserve_gcp
+000225d0: 5f68 7474 7028 293a 0a20 2020 2022 2222  _http():.    """
+000225e0: 5465 7374 2073 6b79 7365 7276 6520 6f6e  Test skyserve on
+000225f0: 2047 4350 2222 220a 2020 2020 6e61 6d65   GCP""".    name
+00022600: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
+00022610: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+00022620: 3d20 5f67 6574 5f73 6b79 7365 7276 655f  = _get_skyserve_
+00022630: 6874 7470 5f74 6573 7428 6e61 6d65 2c20  http_test(name, 
+00022640: 2767 6370 272c 2032 3029 0a20 2020 2072  'gcp', 20).    r
+00022650: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00022660: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+00022670: 2e61 7773 0a40 7079 7465 7374 2e6d 6172  .aws.@pytest.mar
+00022680: 6b2e 7365 7276 650a 6465 6620 7465 7374  k.serve.def test
+00022690: 5f73 6b79 7365 7276 655f 6177 735f 6874  _skyserve_aws_ht
+000226a0: 7470 2829 3a0a 2020 2020 2222 2254 6573  tp():.    """Tes
+000226b0: 7420 736b 7973 6572 7665 206f 6e20 4157  t skyserve on AW
+000226c0: 5322 2222 0a20 2020 206e 616d 6520 3d20  S""".    name = 
+000226d0: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
+000226e0: 6528 290a 2020 2020 7465 7374 203d 205f  e().    test = _
+000226f0: 6765 745f 736b 7973 6572 7665 5f68 7474  get_skyserve_htt
+00022700: 705f 7465 7374 286e 616d 652c 2027 6177  p_test(name, 'aw
+00022710: 7327 2c20 3230 290a 2020 2020 7275 6e5f  s', 20).    run_
+00022720: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00022730: 0a40 7079 7465 7374 2e6d 6172 6b2e 617a  .@pytest.mark.az
+00022740: 7572 650a 4070 7974 6573 742e 6d61 726b  ure.@pytest.mark
+00022750: 2e73 6572 7665 0a64 6566 2074 6573 745f  .serve.def test_
+00022760: 736b 7973 6572 7665 5f61 7a75 7265 5f68  skyserve_azure_h
+00022770: 7474 7028 293a 0a20 2020 2022 2222 5465  ttp():.    """Te
+00022780: 7374 2073 6b79 7365 7276 6520 6f6e 2041  st skyserve on A
+00022790: 7a75 7265 2222 220a 2020 2020 6e61 6d65  zure""".    name
+000227a0: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
+000227b0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+000227c0: 3d20 5f67 6574 5f73 6b79 7365 7276 655f  = _get_skyserve_
+000227d0: 6874 7470 5f74 6573 7428 6e61 6d65 2c20  http_test(name, 
+000227e0: 2761 7a75 7265 272c 2033 3029 0a20 2020  'azure', 30).   
+000227f0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00022800: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00022810: 726b 2e6b 7562 6572 6e65 7465 730a 4070  rk.kubernetes.@p
+00022820: 7974 6573 742e 6d61 726b 2e73 6572 7665  ytest.mark.serve
+00022830: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
+00022840: 7665 5f6b 7562 6572 6e65 7465 735f 6874  ve_kubernetes_ht
+00022850: 7470 2829 3a0a 2020 2020 2222 2254 6573  tp():.    """Tes
+00022860: 7420 736b 7973 6572 7665 206f 6e20 4b75  t skyserve on Ku
+00022870: 6265 726e 6574 6573 2222 220a 2020 2020  bernetes""".    
+00022880: 6e61 6d65 203d 205f 6765 745f 7365 7276  name = _get_serv
+00022890: 6963 655f 6e61 6d65 2829 0a20 2020 2074  ice_name().    t
+000228a0: 6573 7420 3d20 5f67 6574 5f73 6b79 7365  est = _get_skyse
+000228b0: 7276 655f 6874 7470 5f74 6573 7428 6e61  rve_http_test(na
+000228c0: 6d65 2c20 276b 7562 6572 6e65 7465 7327  me, 'kubernetes'
+000228d0: 2c20 3330 290a 2020 2020 7275 6e5f 6f6e  , 30).    run_on
+000228e0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+000228f0: 7079 7465 7374 2e6d 6172 6b2e 7365 7276  pytest.mark.serv
+00022900: 650a 6465 6620 7465 7374 5f73 6b79 7365  e.def test_skyse
+00022910: 7276 655f 6c6c 6d28 6765 6e65 7269 635f  rve_llm(generic_
+00022920: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+00022930: 2022 2222 5465 7374 2073 6b79 7365 7276   """Test skyserv
+00022940: 6520 7769 7468 2072 6561 6c20 4c4c 4d20  e with real LLM 
+00022950: 7573 6563 6173 6522 2222 0a20 2020 206e  usecase""".    n
+00022960: 616d 6520 3d20 5f67 6574 5f73 6572 7669  ame = _get_servi
+00022970: 6365 5f6e 616d 6528 290a 0a20 2020 2064  ce_name()..    d
+00022980: 6566 2067 656e 6572 6174 655f 6c6c 6d5f  ef generate_llm_
+00022990: 7465 7374 5f63 6f6d 6d61 6e64 2870 726f  test_command(pro
+000229a0: 6d70 743a 2073 7472 2c20 6578 7065 6374  mpt: str, expect
+000229b0: 6564 5f6f 7574 7075 743a 2073 7472 2920  ed_output: str) 
+000229c0: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
+000229d0: 7072 6f6d 7074 203d 2073 686c 6578 2e71  prompt = shlex.q
+000229e0: 756f 7465 2870 726f 6d70 7429 0a20 2020  uote(prompt).   
+000229f0: 2020 2020 2065 7870 6563 7465 645f 6f75       expected_ou
+00022a00: 7470 7574 203d 2073 686c 6578 2e71 756f  tput = shlex.quo
+00022a10: 7465 2865 7870 6563 7465 645f 6f75 7470  te(expected_outp
+00022a20: 7574 290a 2020 2020 2020 2020 7265 7475  ut).        retu
+00022a30: 726e 2028 0a20 2020 2020 2020 2020 2020  rn (.           
+00022a40: 2066 277b 5f53 4552 5645 5f45 4e44 504f   f'{_SERVE_ENDPO
+00022a50: 494e 545f 5741 4954 2e66 6f72 6d61 7428  INT_WAIT.format(
+00022a60: 6e61 6d65 3d6e 616d 6529 7d3b 2027 0a20  name=name)}; '. 
+00022a70: 2020 2020 2020 2020 2020 2027 7079 7468             'pyth
+00022a80: 6f6e 2074 6573 7473 2f73 6b79 7365 7276  on tests/skyserv
+00022a90: 652f 6c6c 6d2f 6765 745f 7265 7370 6f6e  e/llm/get_respon
+00022aa0: 7365 2e70 7920 2d2d 656e 6470 6f69 6e74  se.py --endpoint
+00022ab0: 2024 656e 6470 6f69 6e74 2027 0a20 2020   $endpoint '.   
+00022ac0: 2020 2020 2020 2020 2066 272d 2d70 726f           f'--pro
+00022ad0: 6d70 7420 7b70 726f 6d70 747d 207c 2067  mpt {prompt} | g
+00022ae0: 7265 7020 7b65 7870 6563 7465 645f 6f75  rep {expected_ou
+00022af0: 7470 7574 7d27 290a 0a20 2020 2077 6974  tput}')..    wit
+00022b00: 6820 6f70 656e 2827 7465 7374 732f 736b  h open('tests/sk
+00022b10: 7973 6572 7665 2f6c 6c6d 2f70 726f 6d70  yserve/llm/promp
+00022b20: 745f 6f75 7470 7574 2e6a 736f 6e27 2c20  t_output.json', 
+00022b30: 2772 272c 0a20 2020 2020 2020 2020 2020  'r',.           
+00022b40: 2020 2065 6e63 6f64 696e 673d 2775 7466     encoding='utf
+00022b50: 2d38 2729 2061 7320 663a 0a20 2020 2020  -8') as f:.     
+00022b60: 2020 2070 726f 6d70 7432 6f75 7470 7574     prompt2output
+00022b70: 203d 206a 736f 6e2e 6c6f 6164 2866 290a   = json.load(f).
+00022b80: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00022b90: 280a 2020 2020 2020 2020 6627 7465 7374  (.        f'test
+00022ba0: 2d73 6b79 7365 7276 652d 6c6c 6d27 2c0a  -skyserve-llm',.
+00022bb0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00022bc0: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
+00022bd0: 6520 7570 202d 6e20 7b6e 616d 657d 202d  e up -n {name} -
+00022be0: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+00022bf0: 636c 6f75 647d 202d 7920 7465 7374 732f  cloud} -y tests/
+00022c00: 736b 7973 6572 7665 2f6c 6c6d 2f73 6572  skyserve/llm/ser
+00022c10: 7669 6365 2e79 616d 6c27 2c0a 2020 2020  vice.yaml',.    
+00022c20: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
+00022c30: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
+00022c40: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00022c50: 2c20 7265 706c 6963 615f 6e75 6d3d 3129  , replica_num=1)
+00022c60: 2c0a 2020 2020 2020 2020 2020 2020 2a5b  ,.            *[
+00022c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022c80: 2067 656e 6572 6174 655f 6c6c 6d5f 7465   generate_llm_te
+00022c90: 7374 5f63 6f6d 6d61 6e64 2870 726f 6d70  st_command(promp
+00022ca0: 742c 206f 7574 7075 7429 0a20 2020 2020  t, output).     
+00022cb0: 2020 2020 2020 2020 2020 2066 6f72 2070             for p
+00022cc0: 726f 6d70 742c 206f 7574 7075 7420 696e  rompt, output in
+00022cd0: 2070 726f 6d70 7432 6f75 7470 7574 2e69   prompt2output.i
+00022ce0: 7465 6d73 2829 0a20 2020 2020 2020 2020  tems().         
+00022cf0: 2020 205d 2c0a 2020 2020 2020 2020 5d2c     ],.        ],
+00022d00: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
+00022d10: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
+00022d20: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
+00022d30: 2020 2020 2020 7469 6d65 6f75 743d 3430        timeout=40
+00022d40: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
+00022d50: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00022d60: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00022d70: 726b 2e67 6370 0a40 7079 7465 7374 2e6d  rk.gcp.@pytest.m
+00022d80: 6172 6b2e 7365 7276 650a 6465 6620 7465  ark.serve.def te
+00022d90: 7374 5f73 6b79 7365 7276 655f 7370 6f74  st_skyserve_spot
+00022da0: 5f72 6563 6f76 6572 7928 293a 0a20 2020  _recovery():.   
+00022db0: 206e 616d 6520 3d20 5f67 6574 5f73 6572   name = _get_ser
+00022dc0: 7669 6365 5f6e 616d 6528 290a 2020 2020  vice_name().    
+00022dd0: 7a6f 6e65 203d 2027 7573 2d63 656e 7472  zone = 'us-centr
+00022de0: 616c 312d 6127 0a0a 2020 2020 7465 7374  al1-a'..    test
+00022df0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00022e00: 2066 2774 6573 742d 736b 7973 6572 7665   f'test-skyserve
+00022e10: 2d73 706f 742d 7265 636f 7665 7279 2d67  -spot-recovery-g
+00022e20: 6370 272c 0a20 2020 2020 2020 205b 0a20  cp',.        [. 
+00022e30: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00022e40: 2073 6572 7665 2075 7020 2d6e 207b 6e61   serve up -n {na
+00022e50: 6d65 7d20 2d79 2074 6573 7473 2f73 6b79  me} -y tests/sky
+00022e60: 7365 7276 652f 7370 6f74 2f72 6563 6f76  serve/spot/recov
+00022e70: 6572 792e 7961 6d6c 272c 0a20 2020 2020  ery.yaml',.     
+00022e80: 2020 2020 2020 205f 5345 5256 455f 5741         _SERVE_WA
+00022e90: 4954 5f55 4e54 494c 5f52 4541 4459 2e66  IT_UNTIL_READY.f
+00022ea0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 652c  ormat(name=name,
+00022eb0: 2072 6570 6c69 6361 5f6e 756d 3d31 292c   replica_num=1),
+00022ec0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00022ed0: 5f53 4552 5645 5f45 4e44 504f 494e 545f  _SERVE_ENDPOINT_
+00022ee0: 5741 4954 2e66 6f72 6d61 7428 6e61 6d65  WAIT.format(name
+00022ef0: 3d6e 616d 6529 7d3b 2027 0a20 2020 2020  =name)}; '.     
+00022f00: 2020 2020 2020 2027 7265 7175 6573 745f         'request_
+00022f10: 6f75 7470 7574 3d24 2863 7572 6c20 6874  output=$(curl ht
+00022f20: 7470 3a2f 2f24 656e 6470 6f69 6e74 293b  tp://$endpoint);
+00022f30: 2065 6368 6f20 2224 7265 7175 6573 745f   echo "$request_
+00022f40: 6f75 7470 7574 223b 2065 6368 6f20 2224  output"; echo "$
+00022f50: 7265 7175 6573 745f 6f75 7470 7574 2220  request_output" 
+00022f60: 7c20 6772 6570 2022 4869 2c20 536b 7950  | grep "Hi, SkyP
+00022f70: 696c 6f74 2068 6572 6522 272c 0a20 2020  ilot here"',.   
+00022f80: 2020 2020 2020 2020 205f 7465 726d 696e           _termin
+00022f90: 6174 655f 6763 705f 7265 706c 6963 6128  ate_gcp_replica(
+00022fa0: 6e61 6d65 2c20 7a6f 6e65 2c20 3129 2c0a  name, zone, 1),.
+00022fb0: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
+00022fc0: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
+00022fd0: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
+00022fe0: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
+00022ff0: 6d3d 3129 2c0a 2020 2020 2020 2020 2020  m=1),.          
+00023000: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
+00023010: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
+00023020: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
+00023030: 2020 2020 2020 2020 2020 2020 2772 6571              'req
+00023040: 7565 7374 5f6f 7574 7075 743d 2428 6375  uest_output=$(cu
+00023050: 726c 2068 7474 703a 2f2f 2465 6e64 706f  rl http://$endpo
+00023060: 696e 7429 3b20 6563 686f 2022 2472 6571  int); echo "$req
+00023070: 7565 7374 5f6f 7574 7075 7422 3b20 6563  uest_output"; ec
+00023080: 686f 2022 2472 6571 7565 7374 5f6f 7574  ho "$request_out
+00023090: 7075 7422 207c 2067 7265 7020 2248 692c  put" | grep "Hi,
+000230a0: 2053 6b79 5069 6c6f 7420 6865 7265 2227   SkyPilot here"'
+000230b0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+000230c0: 2020 2020 205f 5445 4152 444f 574e 5f53       _TEARDOWN_S
+000230d0: 4552 5649 4345 2e66 6f72 6d61 7428 6e61  ERVICE.format(na
+000230e0: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
+000230f0: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
+00023100: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
+00023110: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00023120: 0a0a 4070 7974 6573 742e 6d61 726b 2e73  ..@pytest.mark.s
+00023130: 6572 7665 0a40 7079 7465 7374 2e6d 6172  erve.@pytest.mar
+00023140: 6b2e 6e6f 5f6b 7562 6572 6e65 7465 730a  k.no_kubernetes.
+00023150: 6465 6620 7465 7374 5f73 6b79 7365 7276  def test_skyserv
+00023160: 655f 6261 7365 5f6f 6e64 656d 616e 645f  e_base_ondemand_
+00023170: 6661 6c6c 6261 636b 2867 656e 6572 6963  fallback(generic
+00023180: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
+00023190: 2020 6e61 6d65 203d 205f 6765 745f 7365    name = _get_se
+000231a0: 7276 6963 655f 6e61 6d65 2829 0a20 2020  rvice_name().   
+000231b0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+000231c0: 2020 2020 2020 6627 7465 7374 2d73 6b79        f'test-sky
+000231d0: 7365 7276 652d 6261 7365 2d6f 6e64 656d  serve-base-ondem
+000231e0: 616e 642d 6661 6c6c 6261 636b 272c 0a20  and-fallback',. 
+000231f0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00023200: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
+00023210: 2075 7020 2d6e 207b 6e61 6d65 7d20 2d2d   up -n {name} --
+00023220: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
+00023230: 6c6f 7564 7d20 2d79 2074 6573 7473 2f73  loud} -y tests/s
+00023240: 6b79 7365 7276 652f 7370 6f74 2f62 6173  kyserve/spot/bas
+00023250: 655f 6f6e 6465 6d61 6e64 5f66 616c 6c62  e_ondemand_fallb
+00023260: 6163 6b2e 7961 6d6c 272c 0a20 2020 2020  ack.yaml',.     
+00023270: 2020 2020 2020 205f 5345 5256 455f 5741         _SERVE_WA
+00023280: 4954 5f55 4e54 494c 5f52 4541 4459 2e66  IT_UNTIL_READY.f
+00023290: 6f72 6d61 7428 6e61 6d65 3d6e 616d 652c  ormat(name=name,
+000232a0: 2072 6570 6c69 6361 5f6e 756d 3d32 292c   replica_num=2),
+000232b0: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
+000232c0: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
+000232d0: 7461 7475 7328 6e61 6d65 2c20 5b28 312c  tatus(name, [(1,
+000232e0: 2054 7275 652c 2027 5245 4144 5927 292c   True, 'READY'),
+000232f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023310: 2020 2020 2020 2020 2020 2020 2028 312c               (1,
+00023320: 2046 616c 7365 2c20 2752 4541 4459 2729   False, 'READY')
+00023330: 5d29 2c0a 2020 2020 2020 2020 5d2c 0a20  ]),.        ],. 
+00023340: 2020 2020 2020 205f 5445 4152 444f 574e         _TEARDOWN
+00023350: 5f53 4552 5649 4345 2e66 6f72 6d61 7428  _SERVICE.format(
+00023360: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
+00023370: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
+00023380: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+00023390: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+000233a0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+000233b0: 2e67 6370 0a40 7079 7465 7374 2e6d 6172  .gcp.@pytest.mar
+000233c0: 6b2e 7365 7276 650a 6465 6620 7465 7374  k.serve.def test
+000233d0: 5f73 6b79 7365 7276 655f 6479 6e61 6d69  _skyserve_dynami
+000233e0: 635f 6f6e 6465 6d61 6e64 5f66 616c 6c62  c_ondemand_fallb
+000233f0: 6163 6b28 293a 0a20 2020 206e 616d 6520  ack():.    name 
+00023400: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
+00023410: 616d 6528 290a 2020 2020 7a6f 6e65 203d  ame().    zone =
+00023420: 2027 7573 2d63 656e 7472 616c 312d 6127   'us-central1-a'
+00023430: 0a0a 2020 2020 7465 7374 203d 2054 6573  ..    test = Tes
+00023440: 7428 0a20 2020 2020 2020 2066 2774 6573  t(.        f'tes
+00023450: 742d 736b 7973 6572 7665 2d64 796e 616d  t-skyserve-dynam
+00023460: 6963 2d6f 6e64 656d 616e 642d 6661 6c6c  ic-ondemand-fall
+00023470: 6261 636b 272c 0a20 2020 2020 2020 205b  back',.        [
+00023480: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00023490: 6b79 2073 6572 7665 2075 7020 2d6e 207b  ky serve up -n {
+000234a0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6763  name} --cloud gc
+000234b0: 7020 2d79 2074 6573 7473 2f73 6b79 7365  p -y tests/skyse
+000234c0: 7276 652f 7370 6f74 2f64 796e 616d 6963  rve/spot/dynamic
+000234d0: 5f6f 6e64 656d 616e 645f 6661 6c6c 6261  _ondemand_fallba
+000234e0: 636b 2e79 616d 6c27 2c0a 2020 2020 2020  ck.yaml',.      
+000234f0: 2020 2020 2020 6627 736c 6565 7020 3430        f'sleep 40
+00023500: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+00023510: 2032 206f 6e2d 6465 6d61 6e64 2028 7072   2 on-demand (pr
+00023520: 6f76 6973 696f 6e69 6e67 2920 2b20 3220  ovisioning) + 2 
+00023530: 5370 6f74 2028 7072 6f76 6973 696f 6e69  Spot (provisioni
+00023540: 6e67 292e 0a20 2020 2020 2020 2020 2020  ng)..           
+00023550: 2066 277b 5f53 4552 5645 5f53 5441 5455   f'{_SERVE_STATU
+00023560: 535f 5741 4954 2e66 6f72 6d61 7428 6e61  S_WAIT.format(na
+00023570: 6d65 3d6e 616d 6529 7d3b 2065 6368 6f20  me=name)}; echo 
+00023580: 2224 7322 3b27 0a20 2020 2020 2020 2020  "$s";'.         
+00023590: 2020 2027 6563 686f 2022 2473 2220 7c20     'echo "$s" | 
+000235a0: 6772 6570 202d 7120 2230 2f34 2220 7c7c  grep -q "0/4" ||
+000235b0: 2065 7869 7420 3127 2c0a 2020 2020 2020   exit 1',.      
+000235c0: 2020 2020 2020 2320 5761 6974 2066 6f72        # Wait for
+000235d0: 2074 6865 2070 726f 7669 7369 6f6e 696e   the provisionin
+000235e0: 6720 7374 6172 7473 0a20 2020 2020 2020  g starts.       
+000235f0: 2020 2020 2066 2773 6c65 6570 2034 3027       f'sleep 40'
+00023600: 2c0a 2020 2020 2020 2020 2020 2020 5f63  ,.            _c
+00023610: 6865 636b 5f72 6570 6c69 6361 5f69 6e5f  heck_replica_in_
+00023620: 7374 6174 7573 286e 616d 652c 205b 0a20  status(name, [. 
+00023630: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00023640: 322c 2054 7275 652c 205f 5345 5256 4943  2, True, _SERVIC
+00023650: 455f 4c41 554e 4348 494e 475f 5354 4154  E_LAUNCHING_STAT
+00023660: 5553 5f52 4547 4558 202b 2027 5c7c 5245  US_REGEX + '\|RE
+00023670: 4144 5927 292c 0a20 2020 2020 2020 2020  ADY'),.         
+00023680: 2020 2020 2020 2028 322c 2046 616c 7365         (2, False
+00023690: 2c20 5f53 4552 5649 4345 5f4c 4155 4e43  , _SERVICE_LAUNC
+000236a0: 4849 4e47 5f53 5441 5455 535f 5245 4745  HING_STATUS_REGE
+000236b0: 5820 2b20 275c 7c53 4855 5454 494e 475f  X + '\|SHUTTING_
+000236c0: 444f 574e 2729 0a20 2020 2020 2020 2020  DOWN').         
+000236d0: 2020 205d 292c 0a0a 2020 2020 2020 2020     ]),..        
+000236e0: 2020 2020 2320 5761 6974 2075 6e74 696c      # Wait until
+000236f0: 2032 2073 706f 7420 696e 7374 616e 6365   2 spot instance
+00023700: 7320 6172 6520 7265 6164 792e 0a20 2020  s are ready..   
+00023710: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
+00023720: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
+00023730: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00023740: 652c 2072 6570 6c69 6361 5f6e 756d 3d32  e, replica_num=2
+00023750: 292c 0a20 2020 2020 2020 2020 2020 205f  ),.            _
+00023760: 6368 6563 6b5f 7265 706c 6963 615f 696e  check_replica_in
+00023770: 5f73 7461 7475 7328 6e61 6d65 2c20 5b28  _status(name, [(
+00023780: 322c 2054 7275 652c 2027 5245 4144 5927  2, True, 'READY'
+00023790: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000237a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000237b0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+000237c0: 302c 2046 616c 7365 2c20 2727 295d 292c  0, False, '')]),
+000237d0: 0a20 2020 2020 2020 2020 2020 205f 7465  .            _te
+000237e0: 726d 696e 6174 655f 6763 705f 7265 706c  rminate_gcp_repl
+000237f0: 6963 6128 6e61 6d65 2c20 7a6f 6e65 2c20  ica(name, zone, 
+00023800: 3129 2c0a 2020 2020 2020 2020 2020 2020  1),.            
+00023810: 6627 736c 6565 7020 3430 272c 0a20 2020  f'sleep 40',.   
+00023820: 2020 2020 2020 2020 2023 2031 206f 6e2d           # 1 on-
+00023830: 6465 6d61 6e64 2028 7072 6f76 6973 696f  demand (provisio
+00023840: 6e69 6e67 2920 2b20 3120 5370 6f74 2028  ning) + 1 Spot (
+00023850: 7265 6164 7929 202b 2031 2073 706f 7420  ready) + 1 spot 
+00023860: 2870 726f 7669 7369 6f6e 696e 6729 2e0a  (provisioning)..
+00023870: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00023880: 5345 5256 455f 5354 4154 5553 5f57 4149  SERVE_STATUS_WAI
+00023890: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
+000238a0: 6d65 297d 3b20 270a 2020 2020 2020 2020  me)}; '.        
+000238b0: 2020 2020 2765 6368 6f20 2224 7322 207c      'echo "$s" |
+000238c0: 2067 7265 7020 2d71 2022 312f 3322 272c   grep -q "1/3"',
+000238d0: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
+000238e0: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
+000238f0: 7461 7475 7328 0a20 2020 2020 2020 2020  tatus(.         
+00023900: 2020 2020 2020 206e 616d 652c 205b 2831         name, [(1
+00023910: 2c20 5472 7565 2c20 2752 4541 4459 2729  , True, 'READY')
+00023920: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00023930: 2020 2020 2020 2020 2028 312c 2054 7275           (1, Tru
+00023940: 652c 205f 5345 5256 4943 455f 4c41 554e  e, _SERVICE_LAUN
+00023950: 4348 494e 475f 5354 4154 5553 5f52 4547  CHING_STATUS_REG
+00023960: 4558 292c 0a20 2020 2020 2020 2020 2020  EX),.           
+00023970: 2020 2020 2020 2020 2020 2020 2831 2c20              (1, 
+00023980: 4661 6c73 652c 205f 5345 5256 4943 455f  False, _SERVICE_
+00023990: 4c41 554e 4348 494e 475f 5354 4154 5553  LAUNCHING_STATUS
+000239a0: 5f52 4547 4558 295d 292c 0a0a 2020 2020  _REGEX)]),..    
+000239b0: 2020 2020 2020 2020 2320 5761 6974 2075          # Wait u
+000239c0: 6e74 696c 2032 2073 706f 7420 696e 7374  ntil 2 spot inst
+000239d0: 616e 6365 7320 6172 6520 7265 6164 792e  ances are ready.
+000239e0: 0a20 2020 2020 2020 2020 2020 205f 5345  .            _SE
+000239f0: 5256 455f 5741 4954 5f55 4e54 494c 5f52  RVE_WAIT_UNTIL_R
+00023a00: 4541 4459 2e66 6f72 6d61 7428 6e61 6d65  EADY.format(name
+00023a10: 3d6e 616d 652c 2072 6570 6c69 6361 5f6e  =name, replica_n
+00023a20: 756d 3d32 292c 0a20 2020 2020 2020 2020  um=2),.         
+00023a30: 2020 205f 6368 6563 6b5f 7265 706c 6963     _check_replic
+00023a40: 615f 696e 5f73 7461 7475 7328 6e61 6d65  a_in_status(name
+00023a50: 2c20 5b28 322c 2054 7275 652c 2027 5245  , [(2, True, 'RE
+00023a60: 4144 5927 292c 0a20 2020 2020 2020 2020  ADY'),.         
+00023a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023a90: 2020 2028 302c 2046 616c 7365 2c20 2727     (0, False, ''
+00023aa0: 295d 292c 0a20 2020 2020 2020 205d 2c0a  )]),.        ],.
+00023ab0: 2020 2020 2020 2020 5f54 4541 5244 4f57          _TEARDOW
+00023ac0: 4e5f 5345 5256 4943 452e 666f 726d 6174  N_SERVICE.format
+00023ad0: 286e 616d 653d 6e61 6d65 292c 0a20 2020  (name=name),.   
+00023ae0: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
+00023af0: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
+00023b00: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00023b10: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00023b20: 6b2e 7365 7276 650a 6465 6620 7465 7374  k.serve.def test
+00023b30: 5f73 6b79 7365 7276 655f 7573 6572 5f62  _skyserve_user_b
+00023b40: 7567 5f72 6573 7461 7274 2867 656e 6572  ug_restart(gener
+00023b50: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+00023b60: 2020 2020 2222 2254 6573 7473 2074 6861      """Tests tha
+00023b70: 7420 7765 2072 6573 7461 7274 2074 6865  t we restart the
+00023b80: 2073 6572 7669 6365 2061 6674 6572 2075   service after u
+00023b90: 7365 7220 6275 672e 2222 220a 2020 2020  ser bug.""".    
+00023ba0: 2320 544f 444f 287a 6877 7529 3a20 7468  # TODO(zhwu): th
+00023bb0: 6973 2062 6568 6176 696f 7220 6e65 6564  is behavior need
+00023bc0: 7320 736f 6d65 2072 6574 6869 6e6b 696e  s some rethinkin
+00023bd0: 672e 0a20 2020 206e 616d 6520 3d20 5f67  g..    name = _g
+00023be0: 6574 5f73 6572 7669 6365 5f6e 616d 6528  et_service_name(
+00023bf0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+00023c00: 7428 0a20 2020 2020 2020 2066 2774 6573  t(.        f'tes
+00023c10: 742d 736b 7973 6572 7665 2d75 7365 722d  t-skyserve-user-
+00023c20: 6275 672d 7265 7374 6172 7427 2c0a 2020  bug-restart',.  
+00023c30: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00023c40: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
+00023c50: 7570 202d 6e20 7b6e 616d 657d 202d 2d63  up -n {name} --c
+00023c60: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+00023c70: 6f75 647d 202d 7920 7465 7374 732f 736b  oud} -y tests/sk
+00023c80: 7973 6572 7665 2f72 6573 7461 7274 2f75  yserve/restart/u
+00023c90: 7365 725f 6275 672e 7961 6d6c 272c 0a20  ser_bug.yaml',. 
+00023ca0: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+00023cb0: 2873 6b79 2073 6572 7665 2073 7461 7475  (sky serve statu
+00023cc0: 7320 7b6e 616d 657d 293b 2065 6368 6f20  s {name}); echo 
+00023cd0: 2224 7322 3b27 0a20 2020 2020 2020 2020  "$s";'.         
+00023ce0: 2020 2027 756e 7469 6c20 6563 686f 2022     'until echo "
+00023cf0: 2473 2220 7c20 6772 6570 202d 4120 3130  $s" | grep -A 10
+00023d00: 3020 2253 6572 7669 6365 2052 6570 6c69  0 "Service Repli
+00023d10: 6361 7322 207c 2067 7265 7020 2253 4855  cas" | grep "SHU
+00023d20: 5454 494e 475f 444f 574e 223b 2027 0a20  TTING_DOWN"; '. 
+00023d30: 2020 2020 2020 2020 2020 2027 646f 2065             'do e
+00023d40: 6368 6f20 2257 6169 7469 6e67 2066 6f72  cho "Waiting for
+00023d50: 2066 6972 7374 2073 6572 7669 6365 2074   first service t
+00023d60: 6f20 6265 2053 4855 5454 494e 4720 444f  o be SHUTTING DO
+00023d70: 574e 2e2e 2e22 3b20 270a 2020 2020 2020  WN..."; '.      
+00023d80: 2020 2020 2020 6627 736c 6565 7020 353b        f'sleep 5;
+00023d90: 2073 3d24 2873 6b79 2073 6572 7665 2073   s=$(sky serve s
+00023da0: 7461 7475 7320 7b6e 616d 657d 293b 2065  tatus {name}); e
+00023db0: 6368 6f20 2224 7322 3b20 646f 6e65 3b20  cho "$s"; done; 
+00023dc0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00023dd0: 2773 3d24 2873 6b79 2073 6572 7665 2073  's=$(sky serve s
+00023de0: 7461 7475 7320 7b6e 616d 657d 293b 2065  tatus {name}); e
+00023df0: 6368 6f20 2224 7322 3b27 0a20 2020 2020  cho "$s";'.     
+00023e00: 2020 2020 2020 2027 756e 7469 6c20 6563         'until ec
+00023e10: 686f 2022 2473 2220 7c20 6772 6570 202d  ho "$s" | grep -
+00023e20: 4120 3130 3020 2253 6572 7669 6365 2052  A 100 "Service R
+00023e30: 6570 6c69 6361 7322 207c 2067 7265 7020  eplicas" | grep 
+00023e40: 2246 4149 4c45 4422 3b20 270a 2020 2020  "FAILED"; '.    
+00023e50: 2020 2020 2020 2020 2764 6f20 6563 686f          'do echo
+00023e60: 2022 5761 6974 696e 6720 666f 7220 6669   "Waiting for fi
+00023e70: 7273 7420 7365 7276 6963 6520 746f 2062  rst service to b
+00023e80: 6520 4641 494c 4544 2e2e 2e22 3b20 270a  e FAILED..."; '.
+00023e90: 2020 2020 2020 2020 2020 2020 6627 736c              f'sl
+00023ea0: 6565 7020 353b 2073 3d24 2873 6b79 2073  eep 5; s=$(sky s
+00023eb0: 6572 7665 2073 7461 7475 7320 7b6e 616d  erve status {nam
+00023ec0: 657d 293b 2065 6368 6f20 2224 7322 3b20  e}); echo "$s"; 
+00023ed0: 646f 6e65 3b20 6563 686f 2022 2473 223b  done; echo "$s";
+00023ee0: 2027 0a20 2020 2020 2020 2020 2020 202b   '.            +
+00023ef0: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
+00023f00: 696e 5f73 7461 7475 7328 6e61 6d65 2c20  in_status(name, 
+00023f10: 5b28 312c 2054 7275 652c 2027 4641 494c  [(1, True, 'FAIL
+00023f20: 4544 2729 5d29 202b 0a20 2020 2020 2020  ED')]) +.       
+00023f30: 2020 2020 2023 2055 7365 7220 6275 6720       # User bug 
+00023f40: 6661 696c 7572 6520 7769 6c6c 2063 6175  failure will cau
+00023f50: 7365 206e 6f20 6675 7274 6865 7220 7363  se no further sc
+00023f60: 616c 696e 672e 0a20 2020 2020 2020 2020  aling..         
+00023f70: 2020 2066 2765 6368 6f20 2224 7322 207c     f'echo "$s" |
+00023f80: 2067 7265 7020 2d41 2031 3030 2022 5365   grep -A 100 "Se
+00023f90: 7276 6963 6520 5265 706c 6963 6173 2220  rvice Replicas" 
+00023fa0: 7c20 6772 6570 2022 7b6e 616d 657d 2220  | grep "{name}" 
+00023fb0: 7c20 7763 202d 6c20 7c20 6772 6570 2031  | wc -l | grep 1
+00023fc0: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+00023fd0: 6627 6563 686f 2022 2473 2220 7c20 6772  f'echo "$s" | gr
+00023fe0: 6570 202d 4220 3130 3020 224e 4f5f 5245  ep -B 100 "NO_RE
+00023ff0: 504c 4943 4122 207c 2067 7265 7020 2230  PLICA" | grep "0
+00024000: 2f30 2227 2c0a 2020 2020 2020 2020 2020  /0"',.          
+00024010: 2020 6627 736b 7920 7365 7276 6520 7570    f'sky serve up
+00024020: 6461 7465 207b 6e61 6d65 7d20 2d2d 636c  date {name} --cl
+00024030: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+00024040: 7564 7d20 2d79 2074 6573 7473 2f73 6b79  ud} -y tests/sky
+00024050: 7365 7276 652f 6175 746f 5f72 6573 7461  serve/auto_resta
+00024060: 7274 2e79 616d 6c27 2c0a 2020 2020 2020  rt.yaml',.      
+00024070: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
+00024080: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
+00024090: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
+000240a0: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+000240b0: 2775 6e74 696c 2063 7572 6c20 6874 7470  'until curl http
+000240c0: 3a2f 2f24 656e 6470 6f69 6e74 207c 2067  ://$endpoint | g
+000240d0: 7265 7020 2248 692c 2053 6b79 5069 6c6f  rep "Hi, SkyPilo
+000240e0: 7420 6865 7265 2122 3b20 646f 2073 6c65  t here!"; do sle
+000240f0: 6570 2032 3b20 646f 6e65 3b20 736c 6565  ep 2; done; slee
+00024100: 7020 323b 2027 0a20 2020 2020 2020 2020  p 2; '.         
+00024110: 2020 202b 205f 6368 6563 6b5f 7265 706c     + _check_repl
+00024120: 6963 615f 696e 5f73 7461 7475 7328 6e61  ica_in_status(na
+00024130: 6d65 2c20 5b28 312c 2046 616c 7365 2c20  me, [(1, False, 
+00024140: 2752 4541 4459 2729 2c0a 2020 2020 2020  'READY'),.      
+00024150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024170: 2020 2020 2020 2020 2831 2c20 4661 6c73          (1, Fals
+00024180: 652c 2027 4641 494c 4544 2729 5d29 2c0a  e, 'FAILED')]),.
+00024190: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+000241a0: 2020 205f 5445 4152 444f 574e 5f53 4552     _TEARDOWN_SER
+000241b0: 5649 4345 2e66 6f72 6d61 7428 6e61 6d65  VICE.format(name
+000241c0: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
+000241d0: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
+000241e0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+000241f0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00024200: 4070 7974 6573 742e 6d61 726b 2e73 6572  @pytest.mark.ser
+00024210: 7665 0a40 7079 7465 7374 2e6d 6172 6b2e  ve.@pytest.mark.
+00024220: 6e6f 5f6b 7562 6572 6e65 7465 7320 2023  no_kubernetes  #
+00024230: 2052 6570 6c69 6361 7320 6f6e 206b 3873   Replicas on k8s
+00024240: 206d 6179 2062 6520 7275 6e6e 696e 6720   may be running 
+00024250: 6f6e 2074 6865 2073 616d 6520 6e6f 6465  on the same node
+00024260: 2061 6e64 2068 6176 6520 7468 6520 7361   and have the sa
+00024270: 6d65 2070 7562 6c69 6320 4950 0a64 6566  me public IP.def
+00024280: 2074 6573 745f 736b 7973 6572 7665 5f6c   test_skyserve_l
+00024290: 6f61 645f 6261 6c61 6e63 6572 2867 656e  oad_balancer(gen
+000242a0: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+000242b0: 3a0a 2020 2020 2222 2254 6573 7420 736b  :.    """Test sk
+000242c0: 7973 6572 7665 206c 6f61 6420 6261 6c61  yserve load bala
+000242d0: 6e63 6572 2072 6f75 6e64 2d72 6f62 696e  ncer round-robin
+000242e0: 2070 6f6c 6963 7922 2222 0a20 2020 206e   policy""".    n
+000242f0: 616d 6520 3d20 5f67 6574 5f73 6572 7669  ame = _get_servi
+00024300: 6365 5f6e 616d 6528 290a 2020 2020 7465  ce_name().    te
+00024310: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00024320: 2020 2066 2774 6573 742d 736b 7973 6572     f'test-skyser
+00024330: 7665 2d6c 6f61 642d 6261 6c61 6e63 6572  ve-load-balancer
+00024340: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00024350: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00024360: 6572 7665 2075 7020 2d6e 207b 6e61 6d65  erve up -n {name
+00024370: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+00024380: 6963 5f63 6c6f 7564 7d20 2d79 2074 6573  ic_cloud} -y tes
+00024390: 7473 2f73 6b79 7365 7276 652f 6c6f 6164  ts/skyserve/load
+000243a0: 5f62 616c 616e 6365 722f 7365 7276 6963  _balancer/servic
+000243b0: 652e 7961 6d6c 272c 0a20 2020 2020 2020  e.yaml',.       
+000243c0: 2020 2020 205f 5345 5256 455f 5741 4954       _SERVE_WAIT
+000243d0: 5f55 4e54 494c 5f52 4541 4459 2e66 6f72  _UNTIL_READY.for
+000243e0: 6d61 7428 6e61 6d65 3d6e 616d 652c 2072  mat(name=name, r
+000243f0: 6570 6c69 6361 5f6e 756d 3d33 292c 0a20  eplica_num=3),. 
+00024400: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+00024410: 4552 5645 5f45 4e44 504f 494e 545f 5741  ERVE_ENDPOINT_WA
+00024420: 4954 2e66 6f72 6d61 7428 6e61 6d65 3d6e  IT.format(name=n
+00024430: 616d 6529 7d3b 2027 0a20 2020 2020 2020  ame)}; '.       
+00024440: 2020 2020 2066 277b 5f53 4552 5645 5f53       f'{_SERVE_S
+00024450: 5441 5455 535f 5741 4954 2e66 6f72 6d61  TATUS_WAIT.forma
+00024460: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2027  t(name=name)}; '
+00024470: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00024480: 5f67 6574 5f72 6570 6c69 6361 5f69 7028  _get_replica_ip(
+00024490: 6e61 6d65 2c20 3129 7d3b 2027 0a20 2020  name, 1)}; '.   
+000244a0: 2020 2020 2020 2020 2066 277b 5f67 6574           f'{_get
+000244b0: 5f72 6570 6c69 6361 5f69 7028 6e61 6d65  _replica_ip(name
+000244c0: 2c20 3229 7d3b 207b 5f67 6574 5f72 6570  , 2)}; {_get_rep
+000244d0: 6c69 6361 5f69 7028 6e61 6d65 2c20 3329  lica_ip(name, 3)
+000244e0: 7d3b 2027 0a20 2020 2020 2020 2020 2020  }; '.           
+000244f0: 2027 7079 7468 6f6e 2074 6573 7473 2f73   'python tests/s
+00024500: 6b79 7365 7276 652f 6c6f 6164 5f62 616c  kyserve/load_bal
+00024510: 616e 6365 722f 7465 7374 5f72 6f75 6e64  ancer/test_round
+00024520: 5f72 6f62 696e 2e70 7920 270a 2020 2020  _robin.py '.    
+00024530: 2020 2020 2020 2020 272d 2d65 6e64 706f          '--endpo
+00024540: 696e 7420 2465 6e64 706f 696e 7420 2d2d  int $endpoint --
+00024550: 7265 706c 6963 612d 6e75 6d20 3320 2d2d  replica-num 3 --
+00024560: 7265 706c 6963 612d 6970 7320 2469 7031  replica-ips $ip1
+00024570: 2024 6970 3220 2469 7033 272c 0a20 2020   $ip2 $ip3',.   
+00024580: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00024590: 5f54 4541 5244 4f57 4e5f 5345 5256 4943  _TEARDOWN_SERVIC
+000245a0: 452e 666f 726d 6174 286e 616d 653d 6e61  E.format(name=na
+000245b0: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
+000245c0: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
+000245d0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+000245e0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+000245f0: 7465 7374 2e6d 6172 6b2e 6763 700a 4070  test.mark.gcp.@p
+00024600: 7974 6573 742e 6d61 726b 2e73 6572 7665  ytest.mark.serve
+00024610: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00024620: 5f6b 7562 6572 6e65 7465 730a 6465 6620  _kubernetes.def 
+00024630: 7465 7374 5f73 6b79 7365 7276 655f 6175  test_skyserve_au
+00024640: 746f 5f72 6573 7461 7274 2829 3a0a 2020  to_restart():.  
+00024650: 2020 2222 2254 6573 7420 736b 7973 6572    """Test skyser
+00024660: 7665 2077 6974 6820 6175 746f 2072 6573  ve with auto res
+00024670: 7461 7274 2222 220a 2020 2020 6e61 6d65  tart""".    name
+00024680: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
+00024690: 6e61 6d65 2829 0a20 2020 207a 6f6e 6520  name().    zone 
+000246a0: 3d20 2775 732d 6365 6e74 7261 6c31 2d61  = 'us-central1-a
+000246b0: 270a 2020 2020 7465 7374 203d 2054 6573  '.    test = Tes
+000246c0: 7428 0a20 2020 2020 2020 2066 2774 6573  t(.        f'tes
+000246d0: 742d 736b 7973 6572 7665 2d61 7574 6f2d  t-skyserve-auto-
+000246e0: 7265 7374 6172 7427 2c0a 2020 2020 2020  restart',.      
+000246f0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00024700: 2320 544f 444f 2874 6961 6e29 3a20 7765  # TODO(tian): we
+00024710: 2063 616e 2064 796e 616d 6963 616c 6c79   can dynamically
+00024720: 2067 656e 6572 6174 6520 5941 4d4c 2066   generate YAML f
+00024730: 726f 6d20 7465 6d70 6c61 7465 2074 6f0a  rom template to.
+00024740: 2020 2020 2020 2020 2020 2020 2320 6176              # av
+00024750: 6f69 6420 6d61 696e 7461 696e 696e 6720  oid maintaining 
+00024760: 746f 6f20 6d61 6e79 2059 414d 4c20 6669  too many YAML fi
+00024770: 6c65 730a 2020 2020 2020 2020 2020 2020  les.            
+00024780: 6627 736b 7920 7365 7276 6520 7570 202d  f'sky serve up -
+00024790: 6e20 7b6e 616d 657d 202d 7920 7465 7374  n {name} -y test
+000247a0: 732f 736b 7973 6572 7665 2f61 7574 6f5f  s/skyserve/auto_
+000247b0: 7265 7374 6172 742e 7961 6d6c 272c 0a20  restart.yaml',. 
+000247c0: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
+000247d0: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
+000247e0: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
+000247f0: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
+00024800: 3d31 292c 0a20 2020 2020 2020 2020 2020  =1),.           
+00024810: 2066 277b 5f53 4552 5645 5f45 4e44 504f   f'{_SERVE_ENDPO
+00024820: 494e 545f 5741 4954 2e66 6f72 6d61 7428  INT_WAIT.format(
+00024830: 6e61 6d65 3d6e 616d 6529 7d3b 2027 0a20  name=name)}; '. 
+00024840: 2020 2020 2020 2020 2020 2027 7265 7175             'requ
+00024850: 6573 745f 6f75 7470 7574 3d24 2863 7572  est_output=$(cur
+00024860: 6c20 6874 7470 3a2f 2f24 656e 6470 6f69  l http://$endpoi
+00024870: 6e74 293b 2065 6368 6f20 2224 7265 7175  nt); echo "$requ
+00024880: 6573 745f 6f75 7470 7574 223b 2065 6368  est_output"; ech
+00024890: 6f20 2224 7265 7175 6573 745f 6f75 7470  o "$request_outp
+000248a0: 7574 2220 7c20 6772 6570 2022 4869 2c20  ut" | grep "Hi, 
+000248b0: 536b 7950 696c 6f74 2068 6572 6522 272c  SkyPilot here"',
+000248c0: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
+000248d0: 6c65 6570 2066 6f72 2032 3020 7365 636f  leep for 20 seco
+000248e0: 6e64 7320 2869 6e69 7469 616c 2064 656c  nds (initial del
+000248f0: 6179 2920 746f 206d 616b 6520 7375 7265  ay) to make sure
+00024900: 2069 7420 7769 6c6c 0a20 2020 2020 2020   it will.       
+00024910: 2020 2020 2023 2062 6520 7265 7374 6172       # be restar
+00024920: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
+00024930: 6627 736c 6565 7020 3230 272c 0a20 2020  f'sleep 20',.   
+00024940: 2020 2020 2020 2020 205f 7465 726d 696e           _termin
+00024950: 6174 655f 6763 705f 7265 706c 6963 6128  ate_gcp_replica(
+00024960: 6e61 6d65 2c20 7a6f 6e65 2c20 3129 2c0a  name, zone, 1),.
+00024970: 2020 2020 2020 2020 2020 2020 2320 5761              # Wa
+00024980: 6974 2066 6f72 2063 6f6e 7365 6375 7469  it for consecuti
+00024990: 7665 2066 6169 6c75 7265 2074 696d 656f  ve failure timeo
+000249a0: 7574 2070 6173 7365 642e 0a20 2020 2020  ut passed..     
+000249b0: 2020 2020 2020 2023 2049 6620 7468 6520         # If the 
+000249c0: 636c 7573 7465 7220 6973 206e 6f74 2075  cluster is not u
+000249d0: 7369 6e67 2073 706f 742c 2069 7420 776f  sing spot, it wo
+000249e0: 6e27 7420 6368 6563 6b20 7468 6520 636c  n't check the cl
+000249f0: 7573 7465 7220 7374 6174 7573 0a20 2020  uster status.   
+00024a00: 2020 2020 2020 2020 2023 206f 6e20 7468           # on th
+00024a10: 6520 636c 6f75 6420 2873 696e 6365 206d  e cloud (since m
+00024a20: 616e 7561 6c20 7368 7574 646f 776e 2069  anual shutdown i
+00024a30: 7320 6e6f 7420 6120 636f 6d6d 6f6e 2062  s not a common b
+00024a40: 6568 6176 696f 7220 616e 6420 7375 6368  ehavior and such
+00024a50: 0a20 2020 2020 2020 2020 2020 2023 2071  .            # q
+00024a60: 7565 7269 6573 2074 616b 6573 2061 206c  ueries takes a l
+00024a70: 6f74 206f 6620 7469 6d65 292e 2049 6e73  ot of time). Ins
+00024a80: 7465 6164 2c20 7765 2074 6869 6e6b 2063  tead, we think c
+00024a90: 6f6e 7469 6e75 6f75 7320 3320 6d69 6e20  ontinuous 3 min 
+00024aa0: 7072 6f62 650a 2020 2020 2020 2020 2020  probe.          
+00024ab0: 2020 2320 6661 696c 7572 6520 6973 206e    # failure is n
+00024ac0: 6f74 2061 2074 656d 706f 7261 7279 2070  ot a temporary p
+00024ad0: 726f 626c 656d 2062 7574 2069 6e64 6565  roblem but indee
+00024ae0: 6420 6120 6661 696c 7572 652e 0a20 2020  d a failure..   
+00024af0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00024b00: 3138 3027 2c0a 2020 2020 2020 2020 2020  180',.          
+00024b10: 2020 2320 5765 2063 616e 6e6f 7420 7573    # We cannot us
+00024b20: 6520 5f53 4552 5645 5f57 4149 545f 554e  e _SERVE_WAIT_UN
+00024b30: 5449 4c5f 5245 4144 593b 2074 6865 7265  TIL_READY; there
+00024b40: 2077 696c 6c20 6265 2061 2069 6e74 6572   will be a inter
+00024b50: 6d65 6469 6174 6520 7469 6d65 0a20 2020  mediate time.   
+00024b60: 2020 2020 2020 2020 2023 2074 6861 7420           # that 
+00024b70: 7468 6520 6f75 7470 7574 206f 6620 6073  the output of `s
+00024b80: 6b79 2073 6572 7665 2073 7461 7475 7360  ky serve status`
+00024b90: 2073 686f 7773 2046 4149 4c45 4420 616e   shows FAILED an
+00024ba0: 6420 7468 6973 2073 7461 7475 7320 7769  d this status wi
+00024bb0: 6c6c 0a20 2020 2020 2020 2020 2020 2023  ll.            #
+00024bc0: 2063 6175 7365 205f 5345 5256 455f 5741   cause _SERVE_WA
+00024bd0: 4954 5f55 4e54 494c 5f52 4541 4459 2074  IT_UNTIL_READY t
+00024be0: 6f20 6561 726c 7920 7175 6974 2e0a 2020  o early quit..  
+00024bf0: 2020 2020 2020 2020 2020 2728 7768 696c            '(whil
+00024c00: 6520 7472 7565 3b20 646f 270a 2020 2020  e true; do'.    
+00024c10: 2020 2020 2020 2020 6627 2020 2020 6f75          f'    ou
+00024c20: 7470 7574 3d24 2873 6b79 2073 6572 7665  tput=$(sky serve
+00024c30: 2073 7461 7475 7320 7b6e 616d 657d 293b   status {name});
+00024c40: 270a 2020 2020 2020 2020 2020 2020 2720  '.            ' 
+00024c50: 2020 2020 6563 686f 2022 246f 7574 7075      echo "$outpu
+00024c60: 7422 207c 2067 7265 7020 2d71 2022 312f  t" | grep -q "1/
+00024c70: 3122 2026 2620 6272 6561 6b3b 270a 2020  1" && break;'.  
+00024c80: 2020 2020 2020 2020 2020 2720 2020 2020            '     
+00024c90: 736c 6565 7020 3130 3b27 0a20 2020 2020  sleep 10;'.     
+00024ca0: 2020 2020 2020 2066 2764 6f6e 6529 3b20         f'done); 
+00024cb0: 736c 6565 7020 7b73 6572 7665 2e4c 425f  sleep {serve.LB_
+00024cc0: 434f 4e54 524f 4c4c 4552 5f53 594e 435f  CONTROLLER_SYNC_
+00024cd0: 494e 5445 5256 414c 5f53 4543 4f4e 4453  INTERVAL_SECONDS
+00024ce0: 7d3b 272c 0a20 2020 2020 2020 2020 2020  };',.           
+00024cf0: 2066 277b 5f53 4552 5645 5f45 4e44 504f   f'{_SERVE_ENDPO
+00024d00: 494e 545f 5741 4954 2e66 6f72 6d61 7428  INT_WAIT.format(
+00024d10: 6e61 6d65 3d6e 616d 6529 7d3b 2027 0a20  name=name)}; '. 
+00024d20: 2020 2020 2020 2020 2020 2027 7265 7175             'requ
+00024d30: 6573 745f 6f75 7470 7574 3d24 2863 7572  est_output=$(cur
+00024d40: 6c20 6874 7470 3a2f 2f24 656e 6470 6f69  l http://$endpoi
+00024d50: 6e74 293b 2065 6368 6f20 2224 7265 7175  nt); echo "$requ
+00024d60: 6573 745f 6f75 7470 7574 223b 2065 6368  est_output"; ech
+00024d70: 6f20 2224 7265 7175 6573 745f 6f75 7470  o "$request_outp
+00024d80: 7574 2220 7c20 6772 6570 2022 4869 2c20  ut" | grep "Hi, 
+00024d90: 536b 7950 696c 6f74 2068 6572 6522 272c  SkyPilot here"',
+00024da0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00024db0: 2020 2020 5f54 4541 5244 4f57 4e5f 5345      _TEARDOWN_SE
+00024dc0: 5256 4943 452e 666f 726d 6174 286e 616d  RVICE.format(nam
+00024dd0: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
+00024de0: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
+00024df0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+00024e00: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00024e10: 0a40 7079 7465 7374 2e6d 6172 6b2e 7365  .@pytest.mark.se
+00024e20: 7276 650a 6465 6620 7465 7374 5f73 6b79  rve.def test_sky
+00024e30: 7365 7276 655f 6361 6e63 656c 2867 656e  serve_cancel(gen
+00024e40: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+00024e50: 3a0a 2020 2020 2222 2254 6573 7420 736b  :.    """Test sk
+00024e60: 7973 6572 7665 2077 6974 6820 6361 6e63  yserve with canc
+00024e70: 656c 2222 220a 2020 2020 6e61 6d65 203d  el""".    name =
+00024e80: 205f 6765 745f 7365 7276 6963 655f 6e61   _get_service_na
+00024e90: 6d65 2829 0a0a 2020 2020 7465 7374 203d  me()..    test =
+00024ea0: 2054 6573 7428 0a20 2020 2020 2020 2066   Test(.        f
+00024eb0: 2774 6573 742d 736b 7973 6572 7665 2d63  'test-skyserve-c
+00024ec0: 616e 6365 6c27 2c0a 2020 2020 2020 2020  ancel',.        
+00024ed0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00024ee0: 736b 7920 7365 7276 6520 7570 202d 6e20  sky serve up -n 
+00024ef0: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
+00024f00: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
+00024f10: 7920 7465 7374 732f 736b 7973 6572 7665  y tests/skyserve
+00024f20: 2f63 616e 6365 6c2f 6361 6e63 656c 2e79  /cancel/cancel.y
+00024f30: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00024f40: 2020 5f53 4552 5645 5f57 4149 545f 554e    _SERVE_WAIT_UN
+00024f50: 5449 4c5f 5245 4144 592e 666f 726d 6174  TIL_READY.format
+00024f60: 286e 616d 653d 6e61 6d65 2c20 7265 706c  (name=name, repl
+00024f70: 6963 615f 6e75 6d3d 3129 2c0a 2020 2020  ica_num=1),.    
+00024f80: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
+00024f90: 455f 454e 4450 4f49 4e54 5f57 4149 542e  E_ENDPOINT_WAIT.
+00024fa0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00024fb0: 297d 3b20 7079 7468 6f6e 3320 270a 2020  )}; python3 '.  
+00024fc0: 2020 2020 2020 2020 2020 2774 6573 7473            'tests
+00024fd0: 2f73 6b79 7365 7276 652f 6361 6e63 656c  /skyserve/cancel
+00024fe0: 2f73 656e 645f 6361 6e63 656c 5f72 6571  /send_cancel_req
+00024ff0: 7565 7374 2e70 7920 270a 2020 2020 2020  uest.py '.      
+00025000: 2020 2020 2020 272d 2d65 6e64 706f 696e        '--endpoin
+00025010: 7420 2465 6e64 706f 696e 7420 7c20 6772  t $endpoint | gr
+00025020: 6570 2022 5265 7175 6573 7420 7761 7320  ep "Request was 
+00025030: 6361 6e63 656c 6c65 6422 272c 0a20 2020  cancelled"',.   
+00025040: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
+00025050: 6b79 2073 6572 7665 206c 6f67 7320 7b6e  ky serve logs {n
+00025060: 616d 657d 2031 202d 2d6e 6f2d 666f 6c6c  ame} 1 --no-foll
+00025070: 6f77 293b 2027 0a20 2020 2020 2020 2020  ow); '.         
+00025080: 2020 2027 756e 7469 6c20 2120 6563 686f     'until ! echo
+00025090: 2022 2473 2220 7c20 6772 6570 2022 506c   "$s" | grep "Pl
+000250a0: 6561 7365 2077 6169 7420 666f 7220 7468  ease wait for th
+000250b0: 6520 636f 6e74 726f 6c6c 6572 2074 6f20  e controller to 
+000250c0: 6265 223b 2027 0a20 2020 2020 2020 2020  be"; '.         
+000250d0: 2020 2027 646f 2065 6368 6f20 2257 6169     'do echo "Wai
+000250e0: 7469 6e67 2066 6f72 2073 6572 7665 206c  ting for serve l
+000250f0: 6f67 7322 3b20 736c 6565 7020 3130 3b20  ogs"; sleep 10; 
+00025100: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+00025110: 733d 2428 736b 7920 7365 7276 6520 6c6f  s=$(sky serve lo
+00025120: 6773 207b 6e61 6d65 7d20 3120 2d2d 6e6f  gs {name} 1 --no
+00025130: 2d66 6f6c 6c6f 7729 3b20 646f 6e65 3b20  -follow); done; 
+00025140: 270a 2020 2020 2020 2020 2020 2020 2765  '.            'e
+00025150: 6368 6f20 2224 7322 3b20 6563 686f 2022  cho "$s"; echo "
+00025160: 2473 2220 7c20 6772 6570 2022 436c 6965  $s" | grep "Clie
+00025170: 6e74 2064 6973 636f 6e6e 6563 7465 642c  nt disconnected,
+00025180: 2073 746f 7070 696e 6720 636f 6d70 7574   stopping comput
+00025190: 6174 696f 6e22 272c 0a20 2020 2020 2020  ation"',.       
+000251a0: 205d 2c0a 2020 2020 2020 2020 5f54 4541   ],.        _TEA
+000251b0: 5244 4f57 4e5f 5345 5256 4943 452e 666f  RDOWN_SERVICE.fo
+000251c0: 726d 6174 286e 616d 653d 6e61 6d65 292c  rmat(name=name),
+000251d0: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+000251e0: 3d32 3020 2a20 3630 2c0a 2020 2020 290a  =20 * 60,.    ).
+000251f0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00025200: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00025210: 2e6d 6172 6b2e 7365 7276 650a 6465 6620  .mark.serve.def 
+00025220: 7465 7374 5f73 6b79 7365 7276 655f 7374  test_skyserve_st
+00025230: 7265 616d 696e 6728 6765 6e65 7269 635f  reaming(generic_
+00025240: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+00025250: 2022 2222 5465 7374 2073 6b79 7365 7276   """Test skyserv
+00025260: 6520 7769 7468 2073 7472 6561 6d69 6e67  e with streaming
+00025270: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
+00025280: 6765 745f 7365 7276 6963 655f 6e61 6d65  get_service_name
+00025290: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+000252a0: 7374 280a 2020 2020 2020 2020 6627 7465  st(.        f'te
+000252b0: 7374 2d73 6b79 7365 7276 652d 7374 7265  st-skyserve-stre
+000252c0: 616d 696e 6727 2c0a 2020 2020 2020 2020  aming',.        
+000252d0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+000252e0: 736b 7920 7365 7276 6520 7570 202d 6e20  sky serve up -n 
+000252f0: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
+00025300: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
+00025310: 7920 7465 7374 732f 736b 7973 6572 7665  y tests/skyserve
+00025320: 2f73 7472 6561 6d69 6e67 2f73 7472 6561  /streaming/strea
+00025330: 6d69 6e67 2e79 616d 6c27 2c0a 2020 2020  ming.yaml',.    
+00025340: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
+00025350: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
+00025360: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00025370: 2c20 7265 706c 6963 615f 6e75 6d3d 3129  , replica_num=1)
+00025380: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00025390: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
+000253a0: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
+000253b0: 653d 6e61 6d65 297d 3b20 270a 2020 2020  e=name)}; '.    
+000253c0: 2020 2020 2020 2020 2770 7974 686f 6e33          'python3
+000253d0: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
+000253e0: 7374 7265 616d 696e 672f 7365 6e64 5f73  streaming/send_s
+000253f0: 7472 6561 6d69 6e67 5f72 6571 7565 7374  treaming_request
+00025400: 2e70 7920 270a 2020 2020 2020 2020 2020  .py '.          
+00025410: 2020 272d 2d65 6e64 706f 696e 7420 2465    '--endpoint $e
+00025420: 6e64 706f 696e 7420 7c20 6772 6570 2022  ndpoint | grep "
+00025430: 5374 7265 616d 696e 6720 7465 7374 2070  Streaming test p
+00025440: 6173 7365 6422 272c 0a20 2020 2020 2020  assed"',.       
+00025450: 205d 2c0a 2020 2020 2020 2020 5f54 4541   ],.        _TEA
+00025460: 5244 4f57 4e5f 5345 5256 4943 452e 666f  RDOWN_SERVICE.fo
+00025470: 726d 6174 286e 616d 653d 6e61 6d65 292c  rmat(name=name),
+00025480: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+00025490: 3d32 3020 2a20 3630 2c0a 2020 2020 290a  =20 * 60,.    ).
+000254a0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+000254b0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+000254c0: 2e6d 6172 6b2e 7365 7276 650a 6465 6620  .mark.serve.def 
+000254d0: 7465 7374 5f73 6b79 7365 7276 655f 7570  test_skyserve_up
+000254e0: 6461 7465 2867 656e 6572 6963 5f63 6c6f  date(generic_clo
+000254f0: 7564 3a20 7374 7229 3a0a 2020 2020 2222  ud: str):.    ""
+00025500: 2254 6573 7420 736b 7973 6572 7665 2077  "Test skyserve w
+00025510: 6974 6820 7570 6461 7465 2222 220a 2020  ith update""".  
+00025520: 2020 6e61 6d65 203d 205f 6765 745f 7365    name = _get_se
+00025530: 7276 6963 655f 6e61 6d65 2829 0a20 2020  rvice_name().   
+00025540: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00025550: 2020 2020 2020 6627 7465 7374 2d73 6b79        f'test-sky
+00025560: 7365 7276 652d 7570 6461 7465 272c 0a20  serve-update',. 
+00025570: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00025580: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
+00025590: 2075 7020 2d6e 207b 6e61 6d65 7d20 2d2d   up -n {name} --
+000255a0: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
+000255b0: 6c6f 7564 7d20 2d79 2074 6573 7473 2f73  loud} -y tests/s
+000255c0: 6b79 7365 7276 652f 7570 6461 7465 2f6f  kyserve/update/o
+000255d0: 6c64 2e79 616d 6c27 2c0a 2020 2020 2020  ld.yaml',.      
+000255e0: 2020 2020 2020 5f53 4552 5645 5f57 4149        _SERVE_WAI
+000255f0: 545f 554e 5449 4c5f 5245 4144 592e 666f  T_UNTIL_READY.fo
+00025600: 726d 6174 286e 616d 653d 6e61 6d65 2c20  rmat(name=name, 
+00025610: 7265 706c 6963 615f 6e75 6d3d 3229 2c0a  replica_num=2),.
+00025620: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00025630: 5345 5256 455f 454e 4450 4f49 4e54 5f57  SERVE_ENDPOINT_W
+00025640: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
+00025650: 6e61 6d65 297d 3b20 6375 726c 2068 7474  name)}; curl htt
+00025660: 703a 2f2f 2465 6e64 706f 696e 7420 7c20  p://$endpoint | 
+00025670: 6772 6570 2022 4869 2c20 536b 7950 696c  grep "Hi, SkyPil
+00025680: 6f74 2068 6572 6522 272c 0a20 2020 2020  ot here"',.     
+00025690: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
+000256a0: 7665 2075 7064 6174 6520 7b6e 616d 657d  ve update {name}
+000256b0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+000256c0: 635f 636c 6f75 647d 202d 2d6d 6f64 6520  c_cloud} --mode 
+000256d0: 626c 7565 5f67 7265 656e 202d 7920 7465  blue_green -y te
+000256e0: 7374 732f 736b 7973 6572 7665 2f75 7064  sts/skyserve/upd
+000256f0: 6174 652f 6e65 772e 7961 6d6c 272c 0a20  ate/new.yaml',. 
+00025700: 2020 2020 2020 2020 2020 2023 2073 6c65             # sle
+00025710: 6570 2062 6566 6f72 6520 7570 6461 7465  ep before update
+00025720: 2069 7320 7265 6769 7374 6572 6564 2e0a   is registered..
+00025730: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00025740: 6570 2032 3027 2c0a 2020 2020 2020 2020  ep 20',.        
+00025750: 2020 2020 6627 7b5f 5345 5256 455f 454e      f'{_SERVE_EN
+00025760: 4450 4f49 4e54 5f57 4149 542e 666f 726d  DPOINT_WAIT.form
+00025770: 6174 286e 616d 653d 6e61 6d65 297d 3b20  at(name=name)}; 
+00025780: 270a 2020 2020 2020 2020 2020 2020 2775  '.            'u
+00025790: 6e74 696c 2063 7572 6c20 6874 7470 3a2f  ntil curl http:/
+000257a0: 2f24 656e 6470 6f69 6e74 207c 2067 7265  /$endpoint | gre
+000257b0: 7020 2248 692c 206e 6577 2053 6b79 5069  p "Hi, new SkyPi
+000257c0: 6c6f 7420 6865 7265 2122 3b20 646f 2073  lot here!"; do s
+000257d0: 6c65 6570 2032 3b20 646f 6e65 3b27 0a20  leep 2; done;'. 
+000257e0: 2020 2020 2020 2020 2020 2023 204d 616b             # Mak
+000257f0: 6520 7375 7265 2074 6865 2074 7261 6666  e sure the traff
+00025800: 6963 2069 7320 6e6f 7420 6d69 7865 640a  ic is not mixed.
+00025810: 2020 2020 2020 2020 2020 2020 2763 7572              'cur
+00025820: 6c20 6874 7470 3a2f 2f24 656e 6470 6f69  l http://$endpoi
+00025830: 6e74 207c 2067 7265 7020 2248 692c 206e  nt | grep "Hi, n
+00025840: 6577 2053 6b79 5069 6c6f 7420 6865 7265  ew SkyPilot here
+00025850: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00025860: 2320 5468 6520 6c61 7465 7374 2032 2076  # The latest 2 v
+00025870: 6572 7369 6f6e 2073 686f 756c 6420 6265  ersion should be
+00025880: 2052 4541 4459 2061 6e64 2074 6865 206f   READY and the o
+00025890: 6c64 6572 2076 6572 7369 6f6e 7320 7368  lder versions sh
+000258a0: 6f75 6c64 2062 6520 7368 7574 7469 6e67  ould be shutting
+000258b0: 2064 6f77 6e0a 2020 2020 2020 2020 2020   down.          
+000258c0: 2020 285f 6368 6563 6b5f 7265 706c 6963    (_check_replic
+000258d0: 615f 696e 5f73 7461 7475 7328 6e61 6d65  a_in_status(name
+000258e0: 2c20 5b28 322c 2046 616c 7365 2c20 2752  , [(2, False, 'R
+000258f0: 4541 4459 2729 2c0a 2020 2020 2020 2020  EADY'),.        
+00025900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025920: 2020 2020 2028 322c 2046 616c 7365 2c20       (2, False, 
+00025930: 2753 4855 5454 494e 475f 444f 574e 2729  'SHUTTING_DOWN')
+00025940: 5d29 202b 0a20 2020 2020 2020 2020 2020  ]) +.           
+00025950: 2020 5f63 6865 636b 5f73 6572 7669 6365    _check_service
+00025960: 5f76 6572 7369 6f6e 286e 616d 652c 2022  _version(name, "
+00025970: 3222 2929 2c0a 2020 2020 2020 2020 5d2c  2")),.        ],
+00025980: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
+00025990: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
+000259a0: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
+000259b0: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
+000259c0: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
+000259d0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+000259e0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+000259f0: 726b 2e73 6572 7665 0a64 6566 2074 6573  rk.serve.def tes
+00025a00: 745f 736b 7973 6572 7665 5f72 6f6c 6c69  t_skyserve_rolli
+00025a10: 6e67 5f75 7064 6174 6528 6765 6e65 7269  ng_update(generi
+00025a20: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+00025a30: 2020 2022 2222 5465 7374 2073 6b79 7365     """Test skyse
+00025a40: 7276 6520 7769 7468 2072 6f6c 6c69 6e67  rve with rolling
+00025a50: 2075 7064 6174 6522 2222 0a20 2020 206e   update""".    n
+00025a60: 616d 6520 3d20 5f67 6574 5f73 6572 7669  ame = _get_servi
+00025a70: 6365 5f6e 616d 6528 290a 2020 2020 7369  ce_name().    si
+00025a80: 6e67 6c65 5f6e 6577 5f72 6570 6c69 6361  ngle_new_replica
+00025a90: 203d 205f 6368 6563 6b5f 7265 706c 6963   = _check_replic
+00025aa0: 615f 696e 5f73 7461 7475 7328 0a20 2020  a_in_status(.   
+00025ab0: 2020 2020 206e 616d 652c 205b 2832 2c20       name, [(2, 
+00025ac0: 4661 6c73 652c 2027 5245 4144 5927 292c  False, 'READY'),
+00025ad0: 2028 312c 2046 616c 7365 2c20 5f53 4552   (1, False, _SER
+00025ae0: 5649 4345 5f4c 4155 4e43 4849 4e47 5f53  VICE_LAUNCHING_S
+00025af0: 5441 5455 535f 5245 4745 5829 2c0a 2020  TATUS_REGEX),.  
+00025b00: 2020 2020 2020 2020 2020 2020 2028 312c               (1,
+00025b10: 2046 616c 7365 2c20 2753 4855 5454 494e   False, 'SHUTTIN
+00025b20: 475f 444f 574e 2729 5d29 0a20 2020 2074  G_DOWN')]).    t
+00025b30: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00025b40: 2020 2020 6627 7465 7374 2d73 6b79 7365      f'test-skyse
+00025b50: 7276 652d 726f 6c6c 696e 672d 7570 6461  rve-rolling-upda
+00025b60: 7465 272c 0a20 2020 2020 2020 205b 0a20  te',.        [. 
+00025b70: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00025b80: 2073 6572 7665 2075 7020 2d6e 207b 6e61   serve up -n {na
+00025b90: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
+00025ba0: 6572 6963 5f63 6c6f 7564 7d20 2d79 2074  eric_cloud} -y t
+00025bb0: 6573 7473 2f73 6b79 7365 7276 652f 7570  ests/skyserve/up
+00025bc0: 6461 7465 2f6f 6c64 2e79 616d 6c27 2c0a  date/old.yaml',.
+00025bd0: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
+00025be0: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
+00025bf0: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
+00025c00: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
+00025c10: 6d3d 3229 2c0a 2020 2020 2020 2020 2020  m=2),.          
+00025c20: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
+00025c30: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
+00025c40: 286e 616d 653d 6e61 6d65 297d 3b20 6375  (name=name)}; cu
+00025c50: 726c 2068 7474 703a 2f2f 2465 6e64 706f  rl http://$endpo
+00025c60: 696e 7420 7c20 6772 6570 2022 4869 2c20  int | grep "Hi, 
+00025c70: 536b 7950 696c 6f74 2068 6572 6522 272c  SkyPilot here"',
+00025c80: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00025c90: 6b79 2073 6572 7665 2075 7064 6174 6520  ky serve update 
+00025ca0: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
+00025cb0: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
+00025cc0: 7920 7465 7374 732f 736b 7973 6572 7665  y tests/skyserve
+00025cd0: 2f75 7064 6174 652f 6e65 772e 7961 6d6c  /update/new.yaml
+00025ce0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+00025cf0: 204d 616b 6520 7375 7265 2074 6865 2074   Make sure the t
+00025d00: 7261 6666 6963 2069 7320 6d69 7865 6420  raffic is mixed 
+00025d10: 6163 726f 7373 2074 776f 2076 6572 7369  across two versi
+00025d20: 6f6e 732c 2074 6865 2072 6570 6c69 6361  ons, the replica
+00025d30: 730a 2020 2020 2020 2020 2020 2020 2320  s.            # 
+00025d40: 7769 7468 2065 7665 6e20 6964 2077 696c  with even id wil
+00025d50: 6c20 736c 6565 7020 3630 2073 6563 6f6e  l sleep 60 secon
+00025d60: 6473 2062 6566 6f72 6520 6265 696e 6720  ds before being 
+00025d70: 7265 6164 792c 2073 6f20 7765 0a20 2020  ready, so we.   
+00025d80: 2020 2020 2020 2020 2023 2073 686f 756c           # shoul
+00025d90: 6420 6265 2061 626c 6520 746f 2067 6574  d be able to get
+00025da0: 206f 6273 6572 7665 2074 6865 2070 6572   observe the per
+00025db0: 696f 6420 7468 6174 2074 6865 2074 7261  iod that the tra
+00025dc0: 6666 6963 2069 7320 6d69 7865 640a 2020  ffic is mixed.  
+00025dd0: 2020 2020 2020 2020 2020 2320 6163 726f            # acro
+00025de0: 7373 2074 776f 2076 6572 7369 6f6e 732e  ss two versions.
+00025df0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00025e00: 5f53 4552 5645 5f45 4e44 504f 494e 545f  _SERVE_ENDPOINT_
+00025e10: 5741 4954 2e66 6f72 6d61 7428 6e61 6d65  WAIT.format(name
+00025e20: 3d6e 616d 6529 7d3b 2027 0a20 2020 2020  =name)}; '.     
+00025e30: 2020 2020 2020 2027 756e 7469 6c20 6375         'until cu
+00025e40: 726c 2068 7474 703a 2f2f 2465 6e64 706f  rl http://$endpo
+00025e50: 696e 7420 7c20 6772 6570 2022 4869 2c20  int | grep "Hi, 
+00025e60: 6e65 7720 536b 7950 696c 6f74 2068 6572  new SkyPilot her
+00025e70: 6521 223b 2064 6f20 736c 6565 7020 323b  e!"; do sleep 2;
+00025e80: 2064 6f6e 653b 2073 6c65 6570 2032 3b20   done; sleep 2; 
+00025e90: 270a 2020 2020 2020 2020 2020 2020 2320  '.            # 
+00025ea0: 5468 6520 6c61 7465 7374 2076 6572 7369  The latest versi
+00025eb0: 6f6e 2073 686f 756c 6420 6861 7665 206f  on should have o
+00025ec0: 6e65 2052 4541 4459 2061 6e64 2074 6865  ne READY and the
+00025ed0: 206f 6e65 206f 6620 7468 6520 6f6c 6465   one of the olde
+00025ee0: 7220 7665 7273 696f 6e73 2073 686f 756c  r versions shoul
+00025ef0: 6420 6265 2073 6875 7474 696e 6720 646f  d be shutting do
+00025f00: 776e 0a20 2020 2020 2020 2020 2020 2066  wn.            f
+00025f10: 277b 7369 6e67 6c65 5f6e 6577 5f72 6570  '{single_new_rep
+00025f20: 6c69 6361 7d20 7b5f 6368 6563 6b5f 7365  lica} {_check_se
+00025f30: 7276 6963 655f 7665 7273 696f 6e28 6e61  rvice_version(na
+00025f40: 6d65 2c20 2231 2c32 2229 7d20 270a 2020  me, "1,2")} '.  
+00025f50: 2020 2020 2020 2020 2020 2320 4368 6563            # Chec
+00025f60: 6b20 7468 6520 6f75 7470 7574 2066 726f  k the output fro
+00025f70: 6d20 7468 6520 6f6c 6420 7665 7273 696f  m the old versio
+00025f80: 6e2c 2069 6d6d 6564 6961 7465 6c79 2061  n, immediately a
+00025f90: 6674 6572 2074 6865 0a20 2020 2020 2020  fter the.       
+00025fa0: 2020 2020 2023 206f 7574 7075 7420 6672       # output fr
+00025fb0: 6f6d 2074 6865 206e 6577 2076 6572 7369  om the new versi
+00025fc0: 6f6e 2061 7070 6561 7273 2e20 5468 6973  on appears. This
+00025fd0: 2069 7320 6775 6172 616e 7465 6564 2062   is guaranteed b
+00025fe0: 7920 7468 650a 2020 2020 2020 2020 2020  y the.          
+00025ff0: 2020 2320 726f 756e 6420 726f 6269 6e20    # round robin 
+00026000: 6c6f 6164 2062 616c 616e 6369 6e67 2070  load balancing p
+00026010: 6f6c 6963 792e 0a20 2020 2020 2020 2020  olicy..         
+00026020: 2020 2023 2054 4f44 4f28 7a68 7775 293a     # TODO(zhwu):
+00026030: 2077 6520 7368 6f75 6c64 2068 6176 6520   we should have 
+00026040: 6120 6d6f 7265 2067 656e 6572 616c 697a  a more generaliz
+00026050: 6564 2077 6179 2066 6f72 2063 6865 636b  ed way for check
+00026060: 696e 6720 7468 650a 2020 2020 2020 2020  ing the.        
+00026070: 2020 2020 2320 6d69 7865 6420 7665 7273      # mixed vers
+00026080: 696f 6e20 6f66 2072 6570 6c69 6361 7320  ion of replicas 
+00026090: 746f 2061 766f 6964 2064 6570 656e 6469  to avoid dependi
+000260a0: 6e67 206f 6e20 7468 6520 7370 6563 6966  ng on the specif
+000260b0: 6963 0a20 2020 2020 2020 2020 2020 2023  ic.            #
+000260c0: 2072 6f75 6e64 2072 6f62 696e 206c 6f61   round robin loa
+000260d0: 6420 6261 6c61 6e63 696e 6720 706f 6c69  d balancing poli
+000260e0: 6379 2e0a 2020 2020 2020 2020 2020 2020  cy..            
+000260f0: 2763 7572 6c20 6874 7470 3a2f 2f24 656e  'curl http://$en
+00026100: 6470 6f69 6e74 207c 2067 7265 7020 2248  dpoint | grep "H
+00026110: 692c 2053 6b79 5069 6c6f 7420 6865 7265  i, SkyPilot here
+00026120: 2227 2c0a 2020 2020 2020 2020 5d2c 0a20  "',.        ],. 
+00026130: 2020 2020 2020 205f 5445 4152 444f 574e         _TEARDOWN
+00026140: 5f53 4552 5649 4345 2e66 6f72 6d61 7428  _SERVICE.format(
+00026150: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
+00026160: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
+00026170: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+00026180: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00026190: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+000261a0: 2e73 6572 7665 0a64 6566 2074 6573 745f  .serve.def test_
+000261b0: 736b 7973 6572 7665 5f66 6173 745f 7570  skyserve_fast_up
+000261c0: 6461 7465 2867 656e 6572 6963 5f63 6c6f  date(generic_clo
+000261d0: 7564 3a20 7374 7229 3a0a 2020 2020 2222  ud: str):.    ""
+000261e0: 2254 6573 7420 736b 7973 6572 7665 2077  "Test skyserve w
+000261f0: 6974 6820 6661 7374 2075 7064 6174 6520  ith fast update 
+00026200: 2849 6e63 7265 6d65 6e74 2076 6572 7369  (Increment versi
+00026210: 6f6e 206f 6620 6f6c 6420 7265 706c 6963  on of old replic
+00026220: 6173 2922 2222 0a20 2020 206e 616d 6520  as)""".    name 
+00026230: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
+00026240: 616d 6528 290a 0a20 2020 2074 6573 7420  ame()..    test 
+00026250: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00026260: 6627 7465 7374 2d73 6b79 7365 7276 652d  f'test-skyserve-
+00026270: 6661 7374 2d75 7064 6174 6527 2c0a 2020  fast-update',.  
+00026280: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00026290: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
+000262a0: 7570 202d 6e20 7b6e 616d 657d 202d 7920  up -n {name} -y 
+000262b0: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+000262c0: 5f63 6c6f 7564 7d20 7465 7374 732f 736b  _cloud} tests/sk
+000262d0: 7973 6572 7665 2f75 7064 6174 652f 6275  yserve/update/bu
+000262e0: 6d70 5f76 6572 7369 6f6e 5f62 6566 6f72  mp_version_befor
+000262f0: 652e 7961 6d6c 272c 0a20 2020 2020 2020  e.yaml',.       
+00026300: 2020 2020 205f 5345 5256 455f 5741 4954       _SERVE_WAIT
+00026310: 5f55 4e54 494c 5f52 4541 4459 2e66 6f72  _UNTIL_READY.for
+00026320: 6d61 7428 6e61 6d65 3d6e 616d 652c 2072  mat(name=name, r
+00026330: 6570 6c69 6361 5f6e 756d 3d32 292c 0a20  eplica_num=2),. 
+00026340: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+00026350: 4552 5645 5f45 4e44 504f 494e 545f 5741  ERVE_ENDPOINT_WA
+00026360: 4954 2e66 6f72 6d61 7428 6e61 6d65 3d6e  IT.format(name=n
+00026370: 616d 6529 7d3b 2063 7572 6c20 6874 7470  ame)}; curl http
+00026380: 3a2f 2f24 656e 6470 6f69 6e74 207c 2067  ://$endpoint | g
+00026390: 7265 7020 2248 692c 2053 6b79 5069 6c6f  rep "Hi, SkyPilo
+000263a0: 7420 6865 7265 2227 2c0a 2020 2020 2020  t here"',.      
+000263b0: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
+000263c0: 6520 7570 6461 7465 207b 6e61 6d65 7d20  e update {name} 
+000263d0: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+000263e0: 5f63 6c6f 7564 7d20 2d2d 6d6f 6465 2062  _cloud} --mode b
+000263f0: 6c75 655f 6772 6565 6e20 2d79 2074 6573  lue_green -y tes
+00026400: 7473 2f73 6b79 7365 7276 652f 7570 6461  ts/skyserve/upda
+00026410: 7465 2f62 756d 705f 7665 7273 696f 6e5f  te/bump_version_
+00026420: 6166 7465 722e 7961 6d6c 272c 0a20 2020  after.yaml',.   
+00026430: 2020 2020 2020 2020 2023 2073 6c65 6570           # sleep
+00026440: 2074 6f20 7761 6974 2066 6f72 2075 7064   to wait for upd
+00026450: 6174 6520 746f 2062 6520 7265 6769 7374  ate to be regist
+00026460: 6572 6564 2e0a 2020 2020 2020 2020 2020  ered..          
+00026470: 2020 2773 6c65 6570 2033 3027 2c0a 2020    'sleep 30',.  
+00026480: 2020 2020 2020 2020 2020 2320 3220 6f6e            # 2 on
+00026490: 2d64 6561 6d6e 6420 2872 6561 6479 2920  -deamnd (ready) 
+000264a0: 2b20 3120 6f6e 2d64 656d 616e 6420 2870  + 1 on-demand (p
+000264b0: 726f 7669 7369 6f6e 696e 6729 2e0a 2020  rovisioning)..  
+000264c0: 2020 2020 2020 2020 2020 280a 2020 2020            (.    
+000264d0: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
+000264e0: 636b 5f72 6570 6c69 6361 5f69 6e5f 7374  ck_replica_in_st
+000264f0: 6174 7573 280a 2020 2020 2020 2020 2020  atus(.          
+00026500: 2020 2020 2020 2020 2020 6e61 6d65 2c20            name, 
+00026510: 5b28 322c 2046 616c 7365 2c20 2752 4541  [(2, False, 'REA
+00026520: 4459 2729 2c0a 2020 2020 2020 2020 2020  DY'),.          
+00026530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026540: 2028 312c 2046 616c 7365 2c20 5f53 4552   (1, False, _SER
+00026550: 5649 4345 5f4c 4155 4e43 4849 4e47 5f53  VICE_LAUNCHING_S
+00026560: 5441 5455 535f 5245 4745 5829 5d29 202b  TATUS_REGEX)]) +
+00026570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00026580: 2023 2046 6173 7420 7570 6461 7465 2077   # Fast update w
+00026590: 696c 6c20 6469 7265 6374 6c79 2068 6176  ill directly hav
+000265a0: 6520 7468 6520 6c61 7465 7374 2076 6572  e the latest ver
+000265b0: 7369 6f6e 2072 6561 6479 2e0a 2020 2020  sion ready..    
+000265c0: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
+000265d0: 636b 5f73 6572 7669 6365 5f76 6572 7369  ck_service_versi
+000265e0: 6f6e 286e 616d 652c 2022 3222 2929 2c0a  on(name, "2")),.
+000265f0: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
+00026600: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
+00026610: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
+00026620: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
+00026630: 6d3d 3329 202b 0a20 2020 2020 2020 2020  m=3) +.         
+00026640: 2020 205f 6368 6563 6b5f 7365 7276 6963     _check_servic
+00026650: 655f 7665 7273 696f 6e28 6e61 6d65 2c20  e_version(name, 
+00026660: 2232 2229 2c0a 2020 2020 2020 2020 2020  "2"),.          
+00026670: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
+00026680: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
+00026690: 286e 616d 653d 6e61 6d65 297d 3b20 6375  (name=name)}; cu
+000266a0: 726c 2068 7474 703a 2f2f 2465 6e64 706f  rl http://$endpo
+000266b0: 696e 7420 7c20 6772 6570 2022 4869 2c20  int | grep "Hi, 
+000266c0: 536b 7950 696c 6f74 2068 6572 6522 272c  SkyPilot here"',
+000266d0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+000266e0: 6573 7420 726f 6c6c 696e 6720 7570 6461  est rolling upda
+000266f0: 7465 0a20 2020 2020 2020 2020 2020 2066  te.            f
+00026700: 2773 6b79 2073 6572 7665 2075 7064 6174  'sky serve updat
+00026710: 6520 7b6e 616d 657d 202d 2d63 6c6f 7564  e {name} --cloud
+00026720: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
+00026730: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
+00026740: 7665 2f75 7064 6174 652f 6275 6d70 5f76  ve/update/bump_v
+00026750: 6572 7369 6f6e 5f62 6566 6f72 652e 7961  ersion_before.ya
+00026760: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00026770: 2023 2073 6c65 6570 2074 6f20 7761 6974   # sleep to wait
+00026780: 2066 6f72 2075 7064 6174 6520 746f 2062   for update to b
+00026790: 6520 7265 6769 7374 6572 6564 2e0a 2020  e registered..  
+000267a0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+000267b0: 2031 3527 2c0a 2020 2020 2020 2020 2020   15',.          
+000267c0: 2020 2320 3220 6f6e 2d64 6561 6d6e 6420    # 2 on-deamnd 
+000267d0: 2872 6561 6479 2920 2b20 3120 6f6e 2d64  (ready) + 1 on-d
+000267e0: 656d 616e 6420 2873 6875 7474 696e 6720  emand (shutting 
+000267f0: 646f 776e 292e 0a20 2020 2020 2020 2020  down)..         
+00026800: 2020 205f 6368 6563 6b5f 7265 706c 6963     _check_replic
+00026810: 615f 696e 5f73 7461 7475 7328 6e61 6d65  a_in_status(name
+00026820: 2c20 5b28 322c 2046 616c 7365 2c20 2752  , [(2, False, 'R
+00026830: 4541 4459 2729 2c0a 2020 2020 2020 2020  EADY'),.        
+00026840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026860: 2020 2020 2831 2c20 4661 6c73 652c 2027      (1, False, '
+00026870: 5348 5554 5449 4e47 5f44 4f57 4e27 295d  SHUTTING_DOWN')]
+00026880: 292c 0a20 2020 2020 2020 2020 2020 205f  ),.            _
+00026890: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
+000268a0: 5f52 4541 4459 2e66 6f72 6d61 7428 6e61  _READY.format(na
+000268b0: 6d65 3d6e 616d 652c 2072 6570 6c69 6361  me=name, replica
+000268c0: 5f6e 756d 3d32 2920 2b0a 2020 2020 2020  _num=2) +.      
+000268d0: 2020 2020 2020 5f63 6865 636b 5f73 6572        _check_ser
+000268e0: 7669 6365 5f76 6572 7369 6f6e 286e 616d  vice_version(nam
+000268f0: 652c 2022 3322 292c 0a20 2020 2020 2020  e, "3"),.       
+00026900: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
+00026910: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
+00026920: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
+00026930: 2063 7572 6c20 6874 7470 3a2f 2f24 656e   curl http://$en
+00026940: 6470 6f69 6e74 207c 2067 7265 7020 2248  dpoint | grep "H
+00026950: 692c 2053 6b79 5069 6c6f 7420 6865 7265  i, SkyPilot here
+00026960: 2227 2c0a 2020 2020 2020 2020 5d2c 0a20  "',.        ],. 
+00026970: 2020 2020 2020 205f 5445 4152 444f 574e         _TEARDOWN
+00026980: 5f53 4552 5649 4345 2e66 6f72 6d61 7428  _SERVICE.format(
+00026990: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
+000269a0: 2020 2020 7469 6d65 6f75 743d 3330 202a      timeout=30 *
+000269b0: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+000269c0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+000269d0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+000269e0: 2e73 6572 7665 0a64 6566 2074 6573 745f  .serve.def test_
+000269f0: 736b 7973 6572 7665 5f75 7064 6174 655f  skyserve_update_
+00026a00: 6175 746f 7363 616c 6528 6765 6e65 7269  autoscale(generi
+00026a10: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+00026a20: 2020 2022 2222 5465 7374 2073 6b79 7365     """Test skyse
+00026a30: 7276 6520 7570 6461 7465 2077 6974 6820  rve update with 
+00026a40: 6175 746f 7363 616c 6522 2222 0a20 2020  autoscale""".   
+00026a50: 206e 616d 6520 3d20 5f67 6574 5f73 6572   name = _get_ser
+00026a60: 7669 6365 5f6e 616d 6528 290a 2020 2020  vice_name().    
+00026a70: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00026a80: 2020 2020 2066 2774 6573 742d 736b 7973       f'test-skys
+00026a90: 6572 7665 2d75 7064 6174 652d 6175 746f  erve-update-auto
+00026aa0: 7363 616c 6527 2c0a 2020 2020 2020 2020  scale',.        
+00026ab0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00026ac0: 736b 7920 7365 7276 6520 7570 202d 6e20  sky serve up -n 
+00026ad0: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
+00026ae0: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
+00026af0: 7920 7465 7374 732f 736b 7973 6572 7665  y tests/skyserve
+00026b00: 2f75 7064 6174 652f 6e75 6d5f 6d69 6e5f  /update/num_min_
+00026b10: 7477 6f2e 7961 6d6c 272c 0a20 2020 2020  two.yaml',.     
+00026b20: 2020 2020 2020 205f 5345 5256 455f 5741         _SERVE_WA
+00026b30: 4954 5f55 4e54 494c 5f52 4541 4459 2e66  IT_UNTIL_READY.f
+00026b40: 6f72 6d61 7428 6e61 6d65 3d6e 616d 652c  ormat(name=name,
+00026b50: 2072 6570 6c69 6361 5f6e 756d 3d32 2920   replica_num=2) 
+00026b60: 2b0a 2020 2020 2020 2020 2020 2020 5f63  +.            _c
+00026b70: 6865 636b 5f73 6572 7669 6365 5f76 6572  heck_service_ver
+00026b80: 7369 6f6e 286e 616d 652c 2022 3122 292c  sion(name, "1"),
+00026b90: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00026ba0: 5f53 4552 5645 5f45 4e44 504f 494e 545f  _SERVE_ENDPOINT_
+00026bb0: 5741 4954 2e66 6f72 6d61 7428 6e61 6d65  WAIT.format(name
+00026bc0: 3d6e 616d 6529 7d3b 2027 0a20 2020 2020  =name)}; '.     
+00026bd0: 2020 2020 2020 2027 6375 726c 2068 7474         'curl htt
+00026be0: 703a 2f2f 2465 6e64 706f 696e 7420 7c20  p://$endpoint | 
+00026bf0: 6772 6570 2022 4869 2c20 536b 7950 696c  grep "Hi, SkyPil
+00026c00: 6f74 2068 6572 6522 272c 0a20 2020 2020  ot here"',.     
+00026c10: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
+00026c20: 7665 2075 7064 6174 6520 7b6e 616d 657d  ve update {name}
+00026c30: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+00026c40: 635f 636c 6f75 647d 202d 2d6d 6f64 6520  c_cloud} --mode 
+00026c50: 626c 7565 5f67 7265 656e 202d 7920 7465  blue_green -y te
+00026c60: 7374 732f 736b 7973 6572 7665 2f75 7064  sts/skyserve/upd
+00026c70: 6174 652f 6e75 6d5f 6d69 6e5f 6f6e 652e  ate/num_min_one.
+00026c80: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00026c90: 2020 2023 2073 6c65 6570 2062 6566 6f72     # sleep befor
+00026ca0: 6520 7570 6461 7465 2069 7320 7265 6769  e update is regi
+00026cb0: 7374 6572 6564 2e0a 2020 2020 2020 2020  stered..        
+00026cc0: 2020 2020 2773 6c65 6570 2032 3027 2c0a      'sleep 20',.
+00026cd0: 2020 2020 2020 2020 2020 2020 2320 5469              # Ti
+00026ce0: 6d65 6f75 7420 7769 6c6c 2062 6520 7472  meout will be tr
+00026cf0: 6967 6765 7265 6420 7768 656e 2075 7064  iggered when upd
+00026d00: 6174 6520 6661 696c 732e 0a20 2020 2020  ate fails..     
+00026d10: 2020 2020 2020 205f 5345 5256 455f 5741         _SERVE_WA
+00026d20: 4954 5f55 4e54 494c 5f52 4541 4459 2e66  IT_UNTIL_READY.f
+00026d30: 6f72 6d61 7428 6e61 6d65 3d6e 616d 652c  ormat(name=name,
+00026d40: 2072 6570 6c69 6361 5f6e 756d 3d31 2920   replica_num=1) 
+00026d50: 2b0a 2020 2020 2020 2020 2020 2020 5f63  +.            _c
+00026d60: 6865 636b 5f73 6572 7669 6365 5f76 6572  heck_service_ver
+00026d70: 7369 6f6e 286e 616d 652c 2022 3222 292c  sion(name, "2"),
+00026d80: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00026d90: 5f53 4552 5645 5f45 4e44 504f 494e 545f  _SERVE_ENDPOINT_
+00026da0: 5741 4954 2e66 6f72 6d61 7428 6e61 6d65  WAIT.format(name
+00026db0: 3d6e 616d 6529 7d3b 2027 0a20 2020 2020  =name)}; '.     
+00026dc0: 2020 2020 2020 2027 6375 726c 2068 7474         'curl htt
+00026dd0: 703a 2f2f 2465 6e64 706f 696e 7420 7c20  p://$endpoint | 
+00026de0: 6772 6570 2022 4869 2c20 536b 7950 696c  grep "Hi, SkyPil
+00026df0: 6f74 2068 6572 6521 2227 2c0a 2020 2020  ot here!"',.    
+00026e00: 2020 2020 2020 2020 2320 526f 6c6c 696e          # Rollin
+00026e10: 6720 5570 6461 7465 0a20 2020 2020 2020  g Update.       
+00026e20: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
+00026e30: 2075 7064 6174 6520 7b6e 616d 657d 202d   update {name} -
+00026e40: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+00026e50: 636c 6f75 647d 202d 7920 7465 7374 732f  cloud} -y tests/
+00026e60: 736b 7973 6572 7665 2f75 7064 6174 652f  skyserve/update/
+00026e70: 6e75 6d5f 6d69 6e5f 7477 6f2e 7961 6d6c  num_min_two.yaml
+00026e80: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+00026e90: 2073 6c65 6570 2062 6566 6f72 6520 7570   sleep before up
+00026ea0: 6461 7465 2069 7320 7265 6769 7374 6572  date is register
+00026eb0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00026ec0: 2773 6c65 6570 2032 3027 2c0a 2020 2020  'sleep 20',.    
+00026ed0: 2020 2020 2020 2020 2320 5469 6d65 6f75          # Timeou
+00026ee0: 7420 7769 6c6c 2062 6520 7472 6967 6765  t will be trigge
+00026ef0: 7265 6420 7768 656e 2075 7064 6174 6520  red when update 
+00026f00: 6661 696c 732e 0a20 2020 2020 2020 2020  fails..         
+00026f10: 2020 205f 5345 5256 455f 5741 4954 5f55     _SERVE_WAIT_U
+00026f20: 4e54 494c 5f52 4541 4459 2e66 6f72 6d61  NTIL_READY.forma
+00026f30: 7428 6e61 6d65 3d6e 616d 652c 2072 6570  t(name=name, rep
+00026f40: 6c69 6361 5f6e 756d 3d32 2920 2b0a 2020  lica_num=2) +.  
+00026f50: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
+00026f60: 5f73 6572 7669 6365 5f76 6572 7369 6f6e  _service_version
+00026f70: 286e 616d 652c 2022 3322 292c 0a20 2020  (name, "3"),.   
+00026f80: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
+00026f90: 5645 5f45 4e44 504f 494e 545f 5741 4954  VE_ENDPOINT_WAIT
+00026fa0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00026fb0: 6529 7d3b 2027 0a20 2020 2020 2020 2020  e)}; '.         
+00026fc0: 2020 2027 6375 726c 2068 7474 703a 2f2f     'curl http://
+00026fd0: 2465 6e64 706f 696e 7420 7c20 6772 6570  $endpoint | grep
+00026fe0: 2022 4869 2c20 536b 7950 696c 6f74 2068   "Hi, SkyPilot h
+00026ff0: 6572 6521 2227 2c0a 2020 2020 2020 2020  ere!"',.        
+00027000: 5d2c 0a20 2020 2020 2020 205f 5445 4152  ],.        _TEAR
+00027010: 444f 574e 5f53 4552 5649 4345 2e66 6f72  DOWN_SERVICE.for
+00027020: 6d61 7428 6e61 6d65 3d6e 616d 6529 2c0a  mat(name=name),.
+00027030: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00027040: 3330 202a 2036 302c 0a20 2020 2029 0a20  30 * 60,.    ). 
+00027050: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00027060: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00027070: 6d61 726b 2e73 6572 7665 0a40 7079 7465  mark.serve.@pyte
+00027080: 7374 2e6d 6172 6b2e 6e6f 5f6b 7562 6572  st.mark.no_kuber
+00027090: 6e65 7465 7320 2023 2053 706f 7420 696e  netes  # Spot in
+000270a0: 7374 616e 6365 7320 6172 6520 6e6f 7420  stances are not 
+000270b0: 7375 7070 6f72 7465 6420 696e 204b 7562  supported in Kub
+000270c0: 6572 6e65 7465 730a 4070 7974 6573 742e  ernetes.@pytest.
+000270d0: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
+000270e0: 2827 6d6f 6465 272c 205b 2772 6f6c 6c69  ('mode', ['rolli
+000270f0: 6e67 272c 2027 626c 7565 5f67 7265 656e  ng', 'blue_green
+00027100: 275d 290a 6465 6620 7465 7374 5f73 6b79  ']).def test_sky
+00027110: 7365 7276 655f 6e65 775f 6175 746f 7363  serve_new_autosc
+00027120: 616c 6572 5f75 7064 6174 6528 6d6f 6465  aler_update(mode
+00027130: 3a20 7374 722c 2067 656e 6572 6963 5f63  : str, generic_c
+00027140: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+00027150: 2222 2254 6573 7420 736b 7973 6572 7665  """Test skyserve
+00027160: 2077 6974 6820 7570 6461 7465 2074 6861   with update tha
+00027170: 7420 6368 616e 6765 7320 6175 746f 7363  t changes autosc
+00027180: 616c 6572 2222 220a 2020 2020 6e61 6d65  aler""".    name
+00027190: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
+000271a0: 6e61 6d65 2829 202b 206d 6f64 650a 0a20  name() + mode.. 
+000271b0: 2020 2066 6f75 725f 7370 6f74 5f75 705f     four_spot_up_
+000271c0: 636d 6420 3d20 5f63 6865 636b 5f72 6570  cmd = _check_rep
+000271d0: 6c69 6361 5f69 6e5f 7374 6174 7573 286e  lica_in_status(n
+000271e0: 616d 652c 205b 2834 2c20 5472 7565 2c20  ame, [(4, True, 
+000271f0: 2752 4541 4459 2729 5d29 0a20 2020 2075  'READY')]).    u
+00027200: 7064 6174 655f 6368 6563 6b20 3d20 5b66  pdate_check = [f
+00027210: 2775 6e74 696c 2028 7b66 6f75 725f 7370  'until ({four_sp
+00027220: 6f74 5f75 705f 636d 647d 293b 2064 6f20  ot_up_cmd}); do 
+00027230: 736c 6565 7020 353b 2064 6f6e 653b 2073  sleep 5; done; s
+00027240: 6c65 6570 2031 303b 275d 0a20 2020 2069  leep 10;'].    i
+00027250: 6620 6d6f 6465 203d 3d20 2772 6f6c 6c69  f mode == 'rolli
+00027260: 6e67 273a 0a20 2020 2020 2020 2023 2043  ng':.        # C
+00027270: 6865 636b 2072 6f6c 6c69 6e67 2075 7064  heck rolling upd
+00027280: 6174 652c 2069 7420 7769 6c6c 2074 6572  ate, it will ter
+00027290: 6d69 6e61 7465 206f 6e65 206f 6620 7468  minate one of th
+000272a0: 6520 6f6c 6420 6f6e 2d64 656d 616e 640a  e old on-demand.
+000272b0: 2020 2020 2020 2020 2320 696e 7374 616e          # instan
+000272c0: 6365 732c 206f 6e63 6520 7468 6572 6520  ces, once there 
+000272d0: 6172 6520 3420 7370 6f74 2069 6e73 7461  are 4 spot insta
+000272e0: 6e63 6520 7265 6164 792e 0a20 2020 2020  nce ready..     
+000272f0: 2020 2075 7064 6174 655f 6368 6563 6b20     update_check 
+00027300: 2b3d 205b 0a20 2020 2020 2020 2020 2020  += [.           
+00027310: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
+00027320: 696e 5f73 7461 7475 7328 0a20 2020 2020  in_status(.     
+00027330: 2020 2020 2020 2020 2020 206e 616d 652c             name,
+00027340: 205b 2831 2c20 4661 6c73 652c 205f 5345   [(1, False, _SE
+00027350: 5256 4943 455f 4c41 554e 4348 494e 475f  RVICE_LAUNCHING_
+00027360: 5354 4154 5553 5f52 4547 4558 292c 0a20  STATUS_REGEX),. 
+00027370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027380: 2020 2020 2020 2831 2c20 4661 6c73 652c        (1, False,
+00027390: 2027 5348 5554 5449 4e47 5f44 4f57 4e27   'SHUTTING_DOWN'
+000273a0: 292c 2028 312c 2046 616c 7365 2c20 2752  ), (1, False, 'R
+000273b0: 4541 4459 2729 5d29 202b 0a20 2020 2020  EADY')]) +.     
+000273c0: 2020 2020 2020 205f 6368 6563 6b5f 7365         _check_se
+000273d0: 7276 6963 655f 7665 7273 696f 6e28 6e61  rvice_version(na
+000273e0: 6d65 2c20 2231 2c32 2229 2c0a 2020 2020  me, "1,2"),.    
+000273f0: 2020 2020 5d0a 2020 2020 656c 7365 3a0a      ].    else:.
+00027400: 2020 2020 2020 2020 2320 4368 6563 6b20          # Check 
+00027410: 626c 7565 2067 7265 656e 2075 7064 6174  blue green updat
+00027420: 652c 2069 7420 7769 6c6c 206b 6565 7020  e, it will keep 
+00027430: 626f 7468 206f 6c64 206f 6e2d 6465 6d61  both old on-dema
+00027440: 6e64 2069 6e73 7461 6e63 6573 0a20 2020  nd instances.   
+00027450: 2020 2020 2023 2072 756e 6e69 6e67 2c20       # running, 
+00027460: 6f6e 6365 2074 6865 7265 2061 7265 2034  once there are 4
+00027470: 2073 706f 7420 696e 7374 616e 6365 2072   spot instance r
+00027480: 6561 6479 2e0a 2020 2020 2020 2020 7570  eady..        up
+00027490: 6461 7465 5f63 6865 636b 202b 3d20 5b0a  date_check += [.
+000274a0: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
+000274b0: 636b 5f72 6570 6c69 6361 5f69 6e5f 7374  ck_replica_in_st
+000274c0: 6174 7573 280a 2020 2020 2020 2020 2020  atus(.          
+000274d0: 2020 2020 2020 6e61 6d65 2c20 5b28 312c        name, [(1,
+000274e0: 2046 616c 7365 2c20 5f53 4552 5649 4345   False, _SERVICE
+000274f0: 5f4c 4155 4e43 4849 4e47 5f53 5441 5455  _LAUNCHING_STATU
+00027500: 535f 5245 4745 5829 2c0a 2020 2020 2020  S_REGEX),.      
+00027510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027520: 2028 322c 2046 616c 7365 2c20 2752 4541   (2, False, 'REA
+00027530: 4459 2729 5d29 202b 0a20 2020 2020 2020  DY')]) +.       
+00027540: 2020 2020 205f 6368 6563 6b5f 7365 7276       _check_serv
+00027550: 6963 655f 7665 7273 696f 6e28 6e61 6d65  ice_version(name
+00027560: 2c20 2231 2229 2c0a 2020 2020 2020 2020  , "1"),.        
+00027570: 5d0a 2020 2020 7465 7374 203d 2054 6573  ].    test = Tes
+00027580: 7428 0a20 2020 2020 2020 2027 7465 7374  t(.        'test
+00027590: 2d73 6b79 7365 7276 652d 6e65 772d 6175  -skyserve-new-au
+000275a0: 746f 7363 616c 6572 2d75 7064 6174 6527  toscaler-update'
+000275b0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+000275c0: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
+000275d0: 7276 6520 7570 202d 6e20 7b6e 616d 657d  rve up -n {name}
+000275e0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+000275f0: 635f 636c 6f75 647d 202d 7920 7465 7374  c_cloud} -y test
+00027600: 732f 736b 7973 6572 7665 2f75 7064 6174  s/skyserve/updat
+00027610: 652f 6e65 775f 6175 746f 7363 616c 6572  e/new_autoscaler
+00027620: 5f62 6566 6f72 652e 7961 6d6c 272c 0a20  _before.yaml',. 
+00027630: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
+00027640: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
+00027650: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
+00027660: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
+00027670: 3d32 2920 2b0a 2020 2020 2020 2020 2020  =2) +.          
+00027680: 2020 5f63 6865 636b 5f73 6572 7669 6365    _check_service
+00027690: 5f76 6572 7369 6f6e 286e 616d 652c 2022  _version(name, "
+000276a0: 3122 292c 0a20 2020 2020 2020 2020 2020  1"),.           
+000276b0: 2066 277b 5f53 4552 5645 5f45 4e44 504f   f'{_SERVE_ENDPO
+000276c0: 494e 545f 5741 4954 2e66 6f72 6d61 7428  INT_WAIT.format(
+000276d0: 6e61 6d65 3d6e 616d 6529 7d3b 2027 0a20  name=name)}; '. 
+000276e0: 2020 2020 2020 2020 2020 2027 733d 2428             's=$(
+000276f0: 6375 726c 2068 7474 703a 2f2f 2465 6e64  curl http://$end
+00027700: 706f 696e 7429 3b20 6563 686f 2022 2473  point); echo "$s
+00027710: 223b 2065 6368 6f20 2224 7322 207c 2067  "; echo "$s" | g
+00027720: 7265 7020 2248 692c 2053 6b79 5069 6c6f  rep "Hi, SkyPilo
+00027730: 7420 6865 7265 2227 2c0a 2020 2020 2020  t here"',.      
+00027740: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
+00027750: 6520 7570 6461 7465 207b 6e61 6d65 7d20  e update {name} 
+00027760: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+00027770: 5f63 6c6f 7564 7d20 2d2d 6d6f 6465 207b  _cloud} --mode {
+00027780: 6d6f 6465 7d20 2d79 2074 6573 7473 2f73  mode} -y tests/s
+00027790: 6b79 7365 7276 652f 7570 6461 7465 2f6e  kyserve/update/n
+000277a0: 6577 5f61 7574 6f73 6361 6c65 725f 6166  ew_autoscaler_af
+000277b0: 7465 722e 7961 6d6c 272c 0a20 2020 2020  ter.yaml',.     
+000277c0: 2020 2020 2020 2023 2057 6169 7420 666f         # Wait fo
+000277d0: 7220 7570 6461 7465 2074 6f20 6265 2072  r update to be r
+000277e0: 6567 6973 7465 7265 640a 2020 2020 2020  egistered.      
+000277f0: 2020 2020 2020 6627 736c 6565 7020 3132        f'sleep 12
+00027800: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00027810: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
+00027820: 6e5f 7374 6174 7573 280a 2020 2020 2020  n_status(.      
+00027830: 2020 2020 2020 2020 2020 6e61 6d65 2c20            name, 
+00027840: 5b28 342c 2054 7275 652c 205f 5345 5256  [(4, True, _SERV
+00027850: 4943 455f 4c41 554e 4348 494e 475f 5354  ICE_LAUNCHING_ST
+00027860: 4154 5553 5f52 4547 4558 202b 2027 5c7c  ATUS_REGEX + '\|
+00027870: 5245 4144 5927 292c 0a20 2020 2020 2020  READY'),.       
 00027880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000278a0: 2028 312c 2046 616c 7365 2c20 2752 4541   (1, False, 'REA
-000278b0: 4459 2729 5d29 2c0a 2020 2020 2020 2020  DY')]),.        
-000278c0: 5d2c 0a20 2020 2020 2020 205f 5445 4152  ],.        _TEAR
-000278d0: 444f 574e 5f53 4552 5649 4345 2e66 6f72  DOWN_SERVICE.for
-000278e0: 6d61 7428 6e61 6d65 3d6e 616d 6529 2c0a  mat(name=name),.
-000278f0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-00027900: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
-00027910: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00027920: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00027930: 6d61 726b 2e73 6572 7665 0a64 6566 2074  mark.serve.def t
-00027940: 6573 745f 736b 7973 6572 7665 5f66 6169  est_skyserve_fai
-00027950: 6c75 7265 7328 6765 6e65 7269 635f 636c  lures(generic_cl
-00027960: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
-00027970: 2222 5465 7374 2072 6570 6c69 6361 2066  ""Test replica f
-00027980: 6169 6c75 7265 2073 7461 7475 7365 7322  ailure statuses"
-00027990: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
-000279a0: 6574 5f73 6572 7669 6365 5f6e 616d 6528  et_service_name(
-000279b0: 290a 0a20 2020 2074 6573 7420 3d20 5465  )..    test = Te
-000279c0: 7374 280a 2020 2020 2020 2020 2774 6573  st(.        'tes
-000279d0: 742d 736b 7973 6572 7665 2d66 6169 6c75  t-skyserve-failu
-000279e0: 7265 7327 2c0a 2020 2020 2020 2020 5b0a  res',.        [.
-000279f0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00027a00: 7920 7365 7276 6520 7570 202d 6e20 7b6e  y serve up -n {n
-00027a10: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
-00027a20: 6e65 7269 635f 636c 6f75 647d 202d 7920  neric_cloud} -y 
-00027a30: 7465 7374 732f 736b 7973 6572 7665 2f66  tests/skyserve/f
-00027a40: 6169 6c75 7265 732f 696e 6974 6961 6c5f  ailures/initial_
-00027a50: 6465 6c61 792e 7961 6d6c 272c 0a20 2020  delay.yaml',.   
-00027a60: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-00027a70: 6b79 2073 6572 7665 2073 7461 7475 7320  ky serve status 
-00027a80: 7b6e 616d 657d 293b 2027 0a20 2020 2020  {name}); '.     
-00027a90: 2020 2020 2020 2066 2775 6e74 696c 2065         f'until e
-00027aa0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-00027ab0: 2246 4149 4c45 445f 494e 4954 4941 4c5f  "FAILED_INITIAL_
-00027ac0: 4445 4c41 5922 3b20 646f 2027 0a20 2020  DELAY"; do '.   
-00027ad0: 2020 2020 2020 2020 2027 6563 686f 2022           'echo "
-00027ae0: 5761 6974 696e 6720 666f 7220 7265 706c  Waiting for repl
-00027af0: 6963 6120 746f 2062 6520 6661 696c 6564  ica to be failed
-00027b00: 2e2e 2e22 3b20 736c 6565 7020 353b 2027  ..."; sleep 5; '
-00027b10: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00027b20: 3d24 2873 6b79 2073 6572 7665 2073 7461  =$(sky serve sta
-00027b30: 7475 7320 7b6e 616d 657d 293b 2065 6368  tus {name}); ech
-00027b40: 6f20 2224 7322 3b20 646f 6e65 3b27 2c0a  o "$s"; done;',.
-00027b50: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-00027b60: 6570 2036 3027 2c0a 2020 2020 2020 2020  ep 60',.        
-00027b70: 2020 2020 6627 7b5f 5345 5256 455f 5354      f'{_SERVE_ST
-00027b80: 4154 5553 5f57 4149 542e 666f 726d 6174  ATUS_WAIT.format
-00027b90: 286e 616d 653d 6e61 6d65 297d 3b20 6563  (name=name)}; ec
-00027ba0: 686f 2022 2473 2220 7c20 6772 6570 2022  ho "$s" | grep "
-00027bb0: 7b6e 616d 657d 2220 7c20 6772 6570 2022  {name}" | grep "
-00027bc0: 4641 494c 4544 5f49 4e49 5449 414c 5f44  FAILED_INITIAL_D
-00027bd0: 454c 4159 2220 7c20 7763 202d 6c20 7c20  ELAY" | wc -l | 
-00027be0: 6772 6570 2032 3b20 270a 2020 2020 2020  grep 2; '.      
-00027bf0: 2020 2020 2020 2320 4d61 6b65 2073 7572        # Make sur
-00027c00: 6520 6e6f 206e 6577 2072 6570 6c69 6361  e no new replica
-00027c10: 7320 6172 6520 7374 6172 7465 6420 666f  s are started fo
-00027c20: 7220 6561 726c 7920 6661 696c 7572 652e  r early failure.
-00027c30: 0a20 2020 2020 2020 2020 2020 2066 2765  .            f'e
-00027c40: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-00027c50: 2d41 2031 3030 2022 5365 7276 6963 6520  -A 100 "Service 
-00027c60: 5265 706c 6963 6173 2220 7c20 6772 6570  Replicas" | grep
-00027c70: 2022 7b6e 616d 657d 2220 7c20 7763 202d   "{name}" | wc -
-00027c80: 6c20 7c20 6772 6570 2032 3b27 2c0a 2020  l | grep 2;',.  
-00027c90: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00027ca0: 7365 7276 6520 7570 6461 7465 207b 6e61  serve update {na
-00027cb0: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-00027cc0: 6572 6963 5f63 6c6f 7564 7d20 2d79 2074  eric_cloud} -y t
-00027cd0: 6573 7473 2f73 6b79 7365 7276 652f 6661  ests/skyserve/fa
-00027ce0: 696c 7572 6573 2f70 726f 6269 6e67 2e79  ilures/probing.y
-00027cf0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00027d00: 2020 6627 733d 2428 736b 7920 7365 7276    f's=$(sky serv
-00027d10: 6520 7374 6174 7573 207b 6e61 6d65 7d29  e status {name})
-00027d20: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-00027d30: 2320 5761 6974 2066 6f72 2072 6570 6c69  # Wait for repli
-00027d40: 6361 2074 6f20 6265 2072 6561 6479 2e0a  ca to be ready..
-00027d50: 2020 2020 2020 2020 2020 2020 6627 756e              f'un
-00027d60: 7469 6c20 6563 686f 2022 2473 2220 7c20  til echo "$s" | 
-00027d70: 6772 6570 2022 5245 4144 5922 3b20 646f  grep "READY"; do
-00027d80: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-00027d90: 6563 686f 2022 5761 6974 696e 6720 666f  echo "Waiting fo
-00027da0: 7220 7265 706c 6963 6120 746f 2062 6520  r replica to be 
-00027db0: 6661 696c 6564 2e2e 2e22 3b20 736c 6565  failed..."; slee
-00027dc0: 7020 353b 2027 0a20 2020 2020 2020 2020  p 5; '.         
-00027dd0: 2020 2066 2773 3d24 2873 6b79 2073 6572     f's=$(sky ser
-00027de0: 7665 2073 7461 7475 7320 7b6e 616d 657d  ve status {name}
-00027df0: 293b 2065 6368 6f20 2224 7322 3b20 646f  ); echo "$s"; do
-00027e00: 6e65 3b27 2c0a 2020 2020 2020 2020 2020  ne;',.          
-00027e10: 2020 2320 5761 6974 2066 6f72 2072 6570    # Wait for rep
-00027e20: 6c69 6361 2074 6f20 6368 616e 6765 2074  lica to change t
-00027e30: 6f20 4641 494c 4544 5f50 524f 4249 4e47  o FAILED_PROBING
-00027e40: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00027e50: 3d24 2873 6b79 2073 6572 7665 2073 7461  =$(sky serve sta
-00027e60: 7475 7320 7b6e 616d 657d 293b 2027 0a20  tus {name}); '. 
-00027e70: 2020 2020 2020 2020 2020 2066 2775 6e74             f'unt
-00027e80: 696c 2065 6368 6f20 2224 7322 207c 2067  il echo "$s" | g
-00027e90: 7265 7020 2246 4149 4c45 445f 5052 4f42  rep "FAILED_PROB
-00027ea0: 494e 4722 3b20 646f 2027 0a20 2020 2020  ING"; do '.     
-00027eb0: 2020 2020 2020 2027 6563 686f 2022 5761         'echo "Wa
-00027ec0: 6974 696e 6720 666f 7220 7265 706c 6963  iting for replic
-00027ed0: 6120 746f 2062 6520 6661 696c 6564 2e2e  a to be failed..
-00027ee0: 2e22 3b20 736c 6565 7020 353b 2027 0a20  ."; sleep 5; '. 
-00027ef0: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-00027f00: 2873 6b79 2073 6572 7665 2073 7461 7475  (sky serve statu
-00027f10: 7320 7b6e 616d 657d 293b 2065 6368 6f20  s {name}); echo 
-00027f20: 2224 7322 3b20 646f 6e65 3b27 202b 0a20  "$s"; done;' +. 
-00027f30: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
-00027f40: 6b5f 7265 706c 6963 615f 696e 5f73 7461  k_replica_in_sta
-00027f50: 7475 7328 0a20 2020 2020 2020 2020 2020  tus(.           
-00027f60: 2020 2020 206e 616d 652c 205b 2831 2c20       name, [(1, 
-00027f70: 4661 6c73 652c 2027 4641 494c 4544 5f50  False, 'FAILED_P
-00027f80: 524f 4249 4e47 2729 2c0a 2020 2020 2020  ROBING'),.      
-00027f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027fa0: 2028 312c 2046 616c 7365 2c20 5f53 4552   (1, False, _SER
-00027fb0: 5649 4345 5f4c 4155 4e43 4849 4e47 5f53  VICE_LAUNCHING_S
-00027fc0: 5441 5455 535f 5245 4745 5829 5d29 2c0a  TATUS_REGEX)]),.
-00027fd0: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
-00027fe0: 444f 287a 6877 7529 3a20 6164 6420 7465  DO(zhwu): add te
-00027ff0: 7374 2066 6f72 2046 4149 4c45 445f 5052  st for FAILED_PR
-00028000: 4f56 4953 494f 4e0a 2020 2020 2020 2020  OVISION.        
-00028010: 5d2c 0a20 2020 2020 2020 205f 5445 4152  ],.        _TEAR
-00028020: 444f 574e 5f53 4552 5649 4345 2e66 6f72  DOWN_SERVICE.for
-00028030: 6d61 7428 6e61 6d65 3d6e 616d 6529 2c0a  mat(name=name),.
-00028040: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-00028050: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
-00028060: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00028070: 7465 7374 290a 0a0a 2320 544f 444f 285a  test)...# TODO(Z
-00028080: 696d 696e 672c 2054 6961 6e29 3a20 4164  iming, Tian): Ad
-00028090: 6420 7465 7374 7320 666f 7220 6175 746f  d tests for auto
-000280a0: 7363 616c 696e 672e 0a0a 0a23 202d 2d2d  scaling....# ---
-000280b0: 2d2d 2d2d 2054 6573 7469 6e67 2075 7365  ---- Testing use
-000280c0: 7220 7261 7920 636c 7573 7465 7220 2d2d  r ray cluster --
-000280d0: 2d2d 2d2d 2d2d 0a64 6566 2074 6573 745f  ------.def test_
-000280e0: 7573 6572 5f72 6179 5f63 6c75 7374 6572  user_ray_cluster
-000280f0: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
-00028100: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
-00028110: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00028120: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-00028130: 5465 7374 280a 2020 2020 2020 2020 2775  Test(.        'u
-00028140: 7365 722d 7261 792d 636c 7573 7465 7227  ser-ray-cluster'
-00028150: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00028160: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00028170: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-00028180: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
-00028190: 6963 5f63 6c6f 7564 7d20 2272 6179 2073  ic_cloud} "ray s
-000281a0: 7461 7274 202d 2d68 6561 6422 272c 0a20  tart --head"',. 
-000281b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000281c0: 2065 7865 6320 7b6e 616d 657d 2022 6563   exec {name} "ec
-000281d0: 686f 2068 6922 272c 0a20 2020 2020 2020  ho hi"',.       
-000281e0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-000281f0: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-00028200: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-00028210: 6627 736b 7920 7374 6174 7573 202d 7220  f'sky status -r 
-00028220: 7b6e 616d 657d 207c 2067 7265 7020 5550  {name} | grep UP
-00028230: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00028240: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00028250: 2022 6563 686f 2062 7965 2227 2c0a 2020   "echo bye"',.  
-00028260: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00028270: 6c6f 6773 207b 6e61 6d65 7d20 3220 2d2d  logs {name} 2 --
-00028280: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-00028290: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-000282a0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-000282b0: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
-000282c0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-000282d0: 0a0a 2320 2d2d 2d2d 2d2d 2d20 5465 7374  ..# ------- Test
-000282e0: 696e 6720 7468 6520 636f 7265 2041 5049  ing the core API
-000282f0: 202d 2d2d 2d2d 2d2d 2d0a 2320 4d6f 7374   --------.# Most
-00028300: 206f 6620 7468 6520 636f 7265 2041 5049   of the core API
-00028310: 7320 6861 7665 2062 6565 6e20 7465 7374  s have been test
-00028320: 6564 2069 6e20 7468 6520 434c 4920 7465  ed in the CLI te
-00028330: 7374 732e 0a23 2054 6865 7365 2074 6573  sts..# These tes
-00028340: 7473 2061 7265 2066 6f72 2074 6573 7469  ts are for testi
-00028350: 6e67 2074 6865 2072 6574 7572 6e20 7661  ng the return va
-00028360: 6c75 6520 6f66 2074 6865 2041 5049 7320  lue of the APIs 
-00028370: 6e6f 7420 6675 6c6c 7920 7573 6564 2069  not fully used i
-00028380: 6e20 434c 492e 0a0a 0a40 7079 7465 7374  n CLI....@pytest
-00028390: 2e6d 6172 6b2e 6763 700a 6465 6620 7465  .mark.gcp.def te
-000283a0: 7374 5f63 6f72 655f 6170 695f 736b 795f  st_core_api_sky_
-000283b0: 6c61 756e 6368 5f65 7865 6328 293a 0a20  launch_exec():. 
-000283c0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-000283d0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-000283e0: 2020 7461 736b 203d 2073 6b79 2e54 6173    task = sky.Tas
-000283f0: 6b28 7275 6e3d 2277 686f 616d 6922 290a  k(run="whoami").
-00028400: 2020 2020 7461 736b 2e73 6574 5f72 6573      task.set_res
-00028410: 6f75 7263 6573 2873 6b79 2e52 6573 6f75  ources(sky.Resou
-00028420: 7263 6573 2863 6c6f 7564 3d73 6b79 2e47  rces(cloud=sky.G
-00028430: 4350 2829 2929 0a20 2020 206a 6f62 5f69  CP())).    job_i
-00028440: 642c 2068 616e 646c 6520 3d20 736b 792e  d, handle = sky.
-00028450: 6c61 756e 6368 2874 6173 6b2c 2063 6c75  launch(task, clu
-00028460: 7374 6572 5f6e 616d 653d 6e61 6d65 290a  ster_name=name).
-00028470: 2020 2020 6173 7365 7274 206a 6f62 5f69      assert job_i
-00028480: 6420 3d3d 2031 0a20 2020 2061 7373 6572  d == 1.    asser
-00028490: 7420 6861 6e64 6c65 2069 7320 6e6f 7420  t handle is not 
-000284a0: 4e6f 6e65 0a20 2020 2061 7373 6572 7420  None.    assert 
-000284b0: 6861 6e64 6c65 2e63 6c75 7374 6572 5f6e  handle.cluster_n
-000284c0: 616d 6520 3d3d 206e 616d 650a 2020 2020  ame == name.    
-000284d0: 6173 7365 7274 2068 616e 646c 652e 6c61  assert handle.la
-000284e0: 756e 6368 6564 5f72 6573 6f75 7263 6573  unched_resources
-000284f0: 2e63 6c6f 7564 2e69 735f 7361 6d65 5f63  .cloud.is_same_c
-00028500: 6c6f 7564 2873 6b79 2e47 4350 2829 290a  loud(sky.GCP()).
-00028510: 2020 2020 6a6f 625f 6964 5f65 7865 632c      job_id_exec,
-00028520: 2068 616e 646c 655f 6578 6563 203d 2073   handle_exec = s
-00028530: 6b79 2e65 7865 6328 7461 736b 2c20 636c  ky.exec(task, cl
-00028540: 7573 7465 725f 6e61 6d65 3d6e 616d 6529  uster_name=name)
-00028550: 0a20 2020 2061 7373 6572 7420 6a6f 625f  .    assert job_
-00028560: 6964 5f65 7865 6320 3d3d 2032 0a20 2020  id_exec == 2.   
-00028570: 2061 7373 6572 7420 6861 6e64 6c65 5f65   assert handle_e
-00028580: 7865 6320 6973 206e 6f74 204e 6f6e 650a  xec is not None.
-00028590: 2020 2020 6173 7365 7274 2068 616e 646c      assert handl
-000285a0: 655f 6578 6563 2e63 6c75 7374 6572 5f6e  e_exec.cluster_n
-000285b0: 616d 6520 3d3d 206e 616d 650a 2020 2020  ame == name.    
-000285c0: 6173 7365 7274 2068 616e 646c 655f 6578  assert handle_ex
-000285d0: 6563 2e6c 6175 6e63 6865 645f 7265 736f  ec.launched_reso
-000285e0: 7572 6365 732e 636c 6f75 642e 6973 5f73  urces.cloud.is_s
-000285f0: 616d 655f 636c 6f75 6428 736b 792e 4743  ame_cloud(sky.GC
-00028600: 5028 2929 0a20 2020 2023 2046 6f72 2064  P()).    # For d
-00028610: 756d 6d79 2074 6173 6b20 2869 2e65 2e20  ummy task (i.e. 
-00028620: 7461 736b 2e72 756e 2069 7320 4e6f 6e65  task.run is None
-00028630: 292c 2074 6865 206a 6f62 2077 6f6e 2774  ), the job won't
-00028640: 2062 6520 7375 626d 6974 7465 642e 0a20   be submitted.. 
-00028650: 2020 2064 756d 6d79 5f74 6173 6b20 3d20     dummy_task = 
-00028660: 736b 792e 5461 736b 2829 0a20 2020 206a  sky.Task().    j
-00028670: 6f62 5f69 645f 6475 6d6d 792c 205f 203d  ob_id_dummy, _ =
-00028680: 2073 6b79 2e65 7865 6328 6475 6d6d 795f   sky.exec(dummy_
-00028690: 7461 736b 2c20 636c 7573 7465 725f 6e61  task, cluster_na
-000286a0: 6d65 3d6e 616d 6529 0a20 2020 2061 7373  me=name).    ass
-000286b0: 6572 7420 6a6f 625f 6964 5f64 756d 6d79  ert job_id_dummy
-000286c0: 2069 7320 4e6f 6e65 0a20 2020 2073 6b79   is None.    sky
-000286d0: 2e64 6f77 6e28 6e61 6d65 290a 0a0a 2320  .down(name)...# 
-000286e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7469  ---------- Testi
-000286f0: 6e67 2053 746f 7261 6765 202d 2d2d 2d2d  ng Storage -----
-00028700: 2d2d 2d2d 2d0a 636c 6173 7320 5465 7374  -----.class Test
-00028710: 5374 6f72 6167 6557 6974 6843 7265 6465  StorageWithCrede
-00028720: 6e74 6961 6c73 3a0a 2020 2020 2222 2253  ntials:.    """S
-00028730: 746f 7261 6765 2074 6573 7473 2077 6869  torage tests whi
-00028740: 6368 2072 6571 7569 7265 2063 7265 6465  ch require crede
-00028750: 6e74 6961 6c73 2061 6e64 206e 6574 776f  ntials and netwo
-00028760: 726b 2063 6f6e 6e65 6374 696f 6e22 2222  rk connection"""
-00028770: 0a0a 2020 2020 4157 535f 494e 5641 4c49  ..    AWS_INVALI
-00028780: 445f 4e41 4d45 5320 3d20 5b0a 2020 2020  D_NAMES = [.    
-00028790: 2020 2020 2761 6227 2c20 2023 206c 6573      'ab',  # les
-000287a0: 7320 7468 616e 2033 2063 6861 7261 6374  s than 3 charact
-000287b0: 6572 730a 2020 2020 2020 2020 2761 6263  ers.        'abc
-000287c0: 6465 6667 6869 6a6b 6c6d 6e6f 7071 7273  defghijklmnopqrs
-000287d0: 7475 7677 7879 7a61 6263 6465 6667 6869  tuvwxyzabcdefghi
-000287e0: 6a6b 6c6d 6e6f 7071 7273 7475 7677 7879  jklmnopqrstuvwxy
-000287f0: 7a61 6263 6465 6667 6869 6a6b 6c6d 6e6f  zabcdefghijklmno
-00028800: 7071 7273 7475 7677 7879 7a31 272c 0a20  pqrstuvwxyz1',. 
-00028810: 2020 2020 2020 2023 206d 6f72 6520 7468         # more th
-00028820: 616e 2036 3320 6368 6172 6163 7465 7273  an 63 characters
-00028830: 0a20 2020 2020 2020 2027 4162 6364 6566  .        'Abcdef
-00028840: 272c 2020 2320 636f 6e74 6169 6e73 2061  ',  # contains a
-00028850: 6e20 7570 7065 7263 6173 6520 6c65 7474  n uppercase lett
-00028860: 6572 0a20 2020 2020 2020 2027 6162 6320  er.        'abc 
-00028870: 6465 6627 2c20 2023 2063 6f6e 7461 696e  def',  # contain
-00028880: 7320 6120 7370 6163 650a 2020 2020 2020  s a space.      
-00028890: 2020 2761 6263 2e2e 6465 6627 2c20 2023    'abc..def',  #
-000288a0: 2074 776f 2061 646a 6163 656e 7420 7065   two adjacent pe
-000288b0: 7269 6f64 730a 2020 2020 2020 2020 2731  riods.        '1
-000288c0: 3932 2e31 3638 2e35 2e34 272c 2020 2320  92.168.5.4',  # 
-000288d0: 666f 726d 6174 7465 6420 6173 2061 6e20  formatted as an 
-000288e0: 4950 2061 6464 7265 7373 0a20 2020 2020  IP address.     
-000288f0: 2020 2027 786e 2d2d 6275 636b 6574 272c     'xn--bucket',
-00028900: 2020 2320 7374 6172 7473 2077 6974 6820    # starts with 
-00028910: 2778 6e2d 2d27 2070 7265 6669 780a 2020  'xn--' prefix.  
-00028920: 2020 2020 2020 2762 7563 6b65 742d 7333        'bucket-s3
-00028930: 616c 6961 7327 2c20 2023 2065 6e64 7320  alias',  # ends 
-00028940: 7769 7468 2027 2d73 3361 6c69 6173 2720  with '-s3alias' 
-00028950: 7375 6666 6978 0a20 2020 2020 2020 2027  suffix.        '
-00028960: 6275 636b 6574 2d2d 6f6c 2d73 3327 2c20  bucket--ol-s3', 
-00028970: 2023 2065 6e64 7320 7769 7468 2027 2d2d   # ends with '--
-00028980: 6f6c 2d73 3327 2073 7566 6669 780a 2020  ol-s3' suffix.  
-00028990: 2020 2020 2020 272e 6162 6327 2c20 2023        '.abc',  #
-000289a0: 2073 7461 7274 7320 7769 7468 2061 2064   starts with a d
-000289b0: 6f74 0a20 2020 2020 2020 2027 6162 632e  ot.        'abc.
-000289c0: 272c 2020 2320 656e 6473 2077 6974 6820  ',  # ends with 
-000289d0: 6120 646f 740a 2020 2020 2020 2020 272d  a dot.        '-
-000289e0: 6162 6327 2c20 2023 2073 7461 7274 7320  abc',  # starts 
-000289f0: 7769 7468 2061 2068 7970 6865 6e0a 2020  with a hyphen.  
-00028a00: 2020 2020 2020 2761 6263 2d27 2c20 2023        'abc-',  #
-00028a10: 2065 6e64 7320 7769 7468 2061 2068 7970   ends with a hyp
-00028a20: 6865 6e0a 2020 2020 5d0a 0a20 2020 2047  hen.    ]..    G
-00028a30: 4353 5f49 4e56 414c 4944 5f4e 414d 4553  CS_INVALID_NAMES
-00028a40: 203d 205b 0a20 2020 2020 2020 2027 6162   = [.        'ab
-00028a50: 272c 2020 2320 6c65 7373 2074 6861 6e20  ',  # less than 
-00028a60: 3320 6368 6172 6163 7465 7273 0a20 2020  3 characters.   
-00028a70: 2020 2020 2027 6162 6364 6566 6768 696a       'abcdefghij
-00028a80: 6b6c 6d6e 6f70 7172 7374 7576 7778 797a  klmnopqrstuvwxyz
-00028a90: 6162 6364 6566 6768 696a 6b6c 6d6e 6f70  abcdefghijklmnop
-00028aa0: 7172 7374 7576 7778 797a 6162 6364 6566  qrstuvwxyzabcdef
-00028ab0: 6768 696a 6b6c 6d6e 6f70 7172 7374 7576  ghijklmnopqrstuv
-00028ac0: 7778 797a 3127 2c0a 2020 2020 2020 2020  wxyz1',.        
-00028ad0: 2320 6d6f 7265 2074 6861 6e20 3633 2063  # more than 63 c
-00028ae0: 6861 7261 6374 6572 7320 2877 6974 686f  haracters (witho
-00028af0: 7574 2064 6f74 7329 0a20 2020 2020 2020  ut dots).       
-00028b00: 2027 4162 6364 6566 272c 2020 2320 636f   'Abcdef',  # co
-00028b10: 6e74 6169 6e73 2061 6e20 7570 7065 7263  ntains an upperc
-00028b20: 6173 6520 6c65 7474 6572 0a20 2020 2020  ase letter.     
-00028b30: 2020 2027 6162 6320 6465 6627 2c20 2023     'abc def',  #
-00028b40: 2063 6f6e 7461 696e 7320 6120 7370 6163   contains a spac
-00028b50: 650a 2020 2020 2020 2020 2761 6263 2e2e  e.        'abc..
-00028b60: 6465 6627 2c20 2023 2074 776f 2061 646a  def',  # two adj
-00028b70: 6163 656e 7420 7065 7269 6f64 730a 2020  acent periods.  
-00028b80: 2020 2020 2020 2761 6263 5f2e 6465 662e        'abc_.def.
-00028b90: 6768 692e 6a6b 6c6d 6e6f 7071 7273 7475  ghi.jklmnopqrstu
-00028ba0: 7677 7879 7a61 6263 6465 6667 6869 6a6b  vwxyzabcdefghijk
-00028bb0: 6c6d 6e6f 7071 7273 7475 7677 7879 7a61  lmnopqrstuvwxyza
-00028bc0: 6263 6465 6667 6869 6a6b 6c6d 6e6f 7071  bcdefghijklmnopq
-00028bd0: 7273 7475 7677 7879 7a31 270a 2020 2020  rstuvwxyz1'.    
-00028be0: 2020 2020 2320 4d6f 7265 2074 6861 6e20      # More than 
-00028bf0: 3633 2063 6861 7261 6374 6572 7320 6265  63 characters be
-00028c00: 7477 6565 6e20 646f 7473 0a20 2020 2020  tween dots.     
-00028c10: 2020 2027 6162 635f 2e64 6566 2e67 6869     'abc_.def.ghi
-00028c20: 2e6a 6b6c 6d6e 6f70 7172 7374 7576 7778  .jklmnopqrstuvwx
-00028c30: 797a 6162 6364 6566 6768 696a 6b6c 6d6e  yzabcdefghijklmn
-00028c40: 6f70 7166 6768 696a 6b6c 6d6e 6f70 7172  opqfghijklmnopqr
-00028c50: 7374 7576 7727 202a 2035 2c0a 2020 2020  stuvw' * 5,.    
-00028c60: 2020 2020 2320 6d6f 7265 2074 6861 6e20      # more than 
-00028c70: 3232 3220 6368 6172 6163 7465 7273 2028  222 characters (
-00028c80: 7769 7468 2064 6f74 7329 0a20 2020 2020  with dots).     
-00028c90: 2020 2027 3139 322e 3136 382e 352e 3427     '192.168.5.4'
-00028ca0: 2c20 2023 2066 6f72 6d61 7474 6564 2061  ,  # formatted a
-00028cb0: 7320 616e 2049 5020 6164 6472 6573 730a  s an IP address.
-00028cc0: 2020 2020 2020 2020 2767 6f6f 6762 7563          'googbuc
-00028cd0: 6b65 7427 2c20 2023 2073 7461 7274 7320  ket',  # starts 
-00028ce0: 7769 7468 2027 676f 6f67 2720 7072 6566  with 'goog' pref
-00028cf0: 6978 0a20 2020 2020 2020 2027 676f 6f67  ix.        'goog
-00028d00: 6c65 6275 636b 6574 272c 2020 2320 636f  lebucket',  # co
-00028d10: 6e74 6169 6e73 2027 676f 6f67 6c65 270a  ntains 'google'.
-00028d20: 2020 2020 2020 2020 2767 3030 676c 6562          'g00gleb
-00028d30: 7563 6b65 7427 2c20 2023 2076 6172 6961  ucket',  # varia
-00028d40: 6e74 206f 6620 2767 6f6f 676c 6527 0a20  nt of 'google'. 
-00028d50: 2020 2020 2020 2027 676f 3067 6c65 6275         'go0glebu
-00028d60: 636b 6574 272c 2020 2320 7661 7269 616e  cket',  # varian
-00028d70: 7420 6f66 2027 676f 6f67 6c65 270a 2020  t of 'google'.  
-00028d80: 2020 2020 2020 2767 306f 676c 6562 7563        'g0oglebuc
-00028d90: 6b65 7427 2c20 2023 2076 6172 6961 6e74  ket',  # variant
-00028da0: 206f 6620 2767 6f6f 676c 6527 0a20 2020   of 'google'.   
-00028db0: 2020 2020 2027 2e61 6263 272c 2020 2320       '.abc',  # 
-00028dc0: 7374 6172 7473 2077 6974 6820 6120 646f  starts with a do
-00028dd0: 740a 2020 2020 2020 2020 2761 6263 2e27  t.        'abc.'
-00028de0: 2c20 2023 2065 6e64 7320 7769 7468 2061  ,  # ends with a
-00028df0: 2064 6f74 0a20 2020 2020 2020 2027 5f61   dot.        '_a
-00028e00: 6263 272c 2020 2320 7374 6172 7473 2077  bc',  # starts w
-00028e10: 6974 6820 616e 2075 6e64 6572 7363 6f72  ith an underscor
-00028e20: 650a 2020 2020 2020 2020 2761 6263 5f27  e.        'abc_'
-00028e30: 2c20 2023 2065 6e64 7320 7769 7468 2061  ,  # ends with a
-00028e40: 6e20 756e 6465 7273 636f 7265 0a20 2020  n underscore.   
-00028e50: 205d 0a0a 2020 2020 4942 4d5f 494e 5641   ]..    IBM_INVA
-00028e60: 4c49 445f 4e41 4d45 5320 3d20 5b0a 2020  LID_NAMES = [.  
-00028e70: 2020 2020 2020 2761 6227 2c20 2023 206c        'ab',  # l
-00028e80: 6573 7320 7468 616e 2033 2063 6861 7261  ess than 3 chara
-00028e90: 6374 6572 730a 2020 2020 2020 2020 2761  cters.        'a
-00028ea0: 6263 6465 6667 6869 6a6b 6c6d 6e6f 7071  bcdefghijklmnopq
-00028eb0: 7273 7475 7677 7879 7a61 6263 6465 6667  rstuvwxyzabcdefg
-00028ec0: 6869 6a6b 6c6d 6e6f 7071 7273 7475 7677  hijklmnopqrstuvw
-00028ed0: 7879 7a61 6263 6465 6667 6869 6a6b 6c6d  xyzabcdefghijklm
-00028ee0: 6e6f 7071 7273 7475 7677 7879 7a31 272c  nopqrstuvwxyz1',
-00028ef0: 0a20 2020 2020 2020 2023 206d 6f72 6520  .        # more 
-00028f00: 7468 616e 2036 3320 6368 6172 6163 7465  than 63 characte
-00028f10: 7273 0a20 2020 2020 2020 2027 4162 6364  rs.        'Abcd
-00028f20: 6566 272c 2020 2320 636f 6e74 6169 6e73  ef',  # contains
-00028f30: 2061 6e20 7570 7065 7263 6173 6520 6c65   an uppercase le
-00028f40: 7474 6572 0a20 2020 2020 2020 2027 6162  tter.        'ab
-00028f50: 6320 6465 6627 2c20 2023 2063 6f6e 7461  c def',  # conta
-00028f60: 696e 7320 6120 7370 6163 650a 2020 2020  ins a space.    
-00028f70: 2020 2020 2761 6263 2e2e 6465 6627 2c20      'abc..def', 
-00028f80: 2023 2074 776f 2061 646a 6163 656e 7420   # two adjacent 
-00028f90: 7065 7269 6f64 730a 2020 2020 2020 2020  periods.        
-00028fa0: 2731 3932 2e31 3638 2e35 2e34 272c 2020  '192.168.5.4',  
-00028fb0: 2320 666f 726d 6174 7465 6420 6173 2061  # formatted as a
-00028fc0: 6e20 4950 2061 6464 7265 7373 0a20 2020  n IP address.   
-00028fd0: 2020 2020 2027 786e 2d2d 6275 636b 6574       'xn--bucket
-00028fe0: 272c 2020 2320 7374 6172 7473 2077 6974  ',  # starts wit
-00028ff0: 6820 2778 6e2d 2d27 2070 7265 6669 780a  h 'xn--' prefix.
-00029000: 2020 2020 2020 2020 272e 6162 6327 2c20          '.abc', 
-00029010: 2023 2073 7461 7274 7320 7769 7468 2061   # starts with a
-00029020: 2064 6f74 0a20 2020 2020 2020 2027 6162   dot.        'ab
-00029030: 632e 272c 2020 2320 656e 6473 2077 6974  c.',  # ends wit
-00029040: 6820 6120 646f 740a 2020 2020 2020 2020  h a dot.        
-00029050: 272d 6162 6327 2c20 2023 2073 7461 7274  '-abc',  # start
-00029060: 7320 7769 7468 2061 2068 7970 6865 6e0a  s with a hyphen.
-00029070: 2020 2020 2020 2020 2761 6263 2d27 2c20          'abc-', 
-00029080: 2023 2065 6e64 7320 7769 7468 2061 2068   # ends with a h
-00029090: 7970 6865 6e0a 2020 2020 2020 2020 2761  yphen.        'a
-000290a0: 2e2d 6263 272c 2020 2320 636f 6e74 6169  .-bc',  # contai
-000290b0: 6e73 2074 6865 2073 6571 7565 6e63 6520  ns the sequence 
-000290c0: 272e 2d27 0a20 2020 2020 2020 2027 612d  '.-'.        'a-
-000290d0: 2e62 6327 2c20 2023 2063 6f6e 7461 696e  .bc',  # contain
-000290e0: 7320 7468 6520 7365 7175 656e 6365 2027  s the sequence '
-000290f0: 2d2e 270a 2020 2020 2020 2020 2761 2662  -.'.        'a&b
-00029100: 6327 2020 2320 636f 6e74 6169 6e73 2073  c'  # contains s
-00029110: 7065 6369 616c 2063 6861 7261 6374 6572  pecial character
-00029120: 730a 2020 2020 2020 2020 2761 625e 6327  s.        'ab^c'
-00029130: 2020 2320 636f 6e74 6169 6e73 2073 7065    # contains spe
-00029140: 6369 616c 2063 6861 7261 6374 6572 730a  cial characters.
-00029150: 2020 2020 5d0a 2020 2020 4749 5449 474e      ].    GITIGN
-00029160: 4f52 455f 5359 4e43 5f54 4553 545f 4449  ORE_SYNC_TEST_DI
-00029170: 525f 5354 5255 4354 5552 4520 3d20 7b0a  R_STRUCTURE = {.
-00029180: 2020 2020 2020 2020 2764 6f75 626c 655f          'double_
-00029190: 6173 7465 7269 736b 273a 207b 0a20 2020  asterisk': {.   
-000291a0: 2020 2020 2020 2020 2027 646f 7562 6c65           'double
-000291b0: 5f61 7374 6572 6973 6b5f 6578 636c 7564  _asterisk_exclud
-000291c0: 6564 273a 204e 6f6e 652c 0a20 2020 2020  ed': None,.     
-000291d0: 2020 2020 2020 2027 646f 7562 6c65 5f61         'double_a
-000291e0: 7374 6572 6973 6b5f 6578 636c 7564 6564  sterisk_excluded
-000291f0: 5f64 6972 273a 207b 0a20 2020 2020 2020  _dir': {.       
-00029200: 2020 2020 2020 2020 2027 6469 725f 6578           'dir_ex
-00029210: 636c 7564 6564 273a 204e 6f6e 652c 0a20  cluded': None,. 
-00029220: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
-00029230: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-00029240: 2027 646f 7562 6c65 5f61 7374 6572 6973   'double_asteris
-00029250: 6b5f 7061 7265 6e74 273a 207b 0a20 2020  k_parent': {.   
-00029260: 2020 2020 2020 2020 2027 7061 7265 6e74           'parent
-00029270: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-00029280: 2020 2020 2027 616c 736f 5f65 7863 6c75       'also_exclu
-00029290: 6465 642e 7478 7427 3a20 4e6f 6e65 2c0a  ded.txt': None,.
-000292a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000292b0: 2763 6869 6c64 273a 207b 0a20 2020 2020  'child': {.     
-000292c0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-000292d0: 646f 7562 6c65 5f61 7374 6572 6973 6b5f  double_asterisk_
-000292e0: 7061 7265 6e74 5f63 6869 6c64 5f65 7863  parent_child_exc
-000292f0: 6c75 6465 642e 7478 7427 3a20 4e6f 6e65  luded.txt': None
-00029300: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00029310: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
-00029320: 2020 2020 2027 646f 7562 6c65 5f61 7374       'double_ast
-00029330: 6572 6973 6b5f 7061 7265 6e74 5f65 7863  erisk_parent_exc
-00029340: 6c75 6465 642e 7478 7427 3a20 4e6f 6e65  luded.txt': None
-00029350: 2c0a 2020 2020 2020 2020 2020 2020 7d2c  ,.            },
-00029360: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
-00029370: 2020 2020 2765 7863 6c75 6465 642e 6c6f      'excluded.lo
-00029380: 6727 3a20 4e6f 6e65 2c0a 2020 2020 2020  g': None,.      
-00029390: 2020 2765 7863 6c75 6465 645f 6469 7227    'excluded_dir'
-000293a0: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-000293b0: 2765 7863 6c75 6465 642e 7478 7427 3a20  'excluded.txt': 
-000293c0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-000293d0: 2020 276e 6573 7465 645f 6578 636c 7564    'nested_exclud
-000293e0: 6564 273a 207b 0a20 2020 2020 2020 2020  ed': {.         
-000293f0: 2020 2020 2020 2027 6578 636c 7564 6564         'excluded
-00029400: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-00029410: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-00029420: 7d2c 0a20 2020 2020 2020 2027 6578 702d  },.        'exp-
-00029430: 3127 3a20 7b0a 2020 2020 2020 2020 2020  1': {.          
-00029440: 2020 2762 655f 6578 636c 7564 6564 273a    'be_excluded':
-00029450: 204e 6f6e 652c 0a20 2020 2020 2020 207d   None,.        }
-00029460: 2c0a 2020 2020 2020 2020 2765 7870 2d32  ,.        'exp-2
-00029470: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-00029480: 2027 6265 5f65 7863 6c75 6465 6427 3a20   'be_excluded': 
-00029490: 4e6f 6e65 2c0a 2020 2020 2020 2020 7d2c  None,.        },
-000294a0: 0a20 2020 2020 2020 2027 6672 6f6e 745f  .        'front_
-000294b0: 736c 6173 685f 6578 636c 7564 6564 273a  slash_excluded':
-000294c0: 204e 6f6e 652c 0a20 2020 2020 2020 2027   None,.        '
-000294d0: 696e 636c 7564 6564 2e6c 6f67 273a 204e  included.log': N
-000294e0: 6f6e 652c 0a20 2020 2020 2020 2027 696e  one,.        'in
-000294f0: 636c 7564 6564 2e74 7874 273a 204e 6f6e  cluded.txt': Non
-00029500: 652c 0a20 2020 2020 2020 2027 696e 636c  e,.        'incl
-00029510: 7564 655f 6469 7227 3a20 7b0a 2020 2020  ude_dir': {.    
-00029520: 2020 2020 2020 2020 2765 7863 6c75 6465          'exclude
-00029530: 642e 6c6f 6727 3a20 4e6f 6e65 2c0a 2020  d.log': None,.  
-00029540: 2020 2020 2020 2020 2020 2769 6e63 6c75            'inclu
-00029550: 6465 642e 6c6f 6727 3a20 4e6f 6e65 2c0a  ded.log': None,.
-00029560: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-00029570: 2020 2027 6e65 7374 6564 5f64 6f75 626c     'nested_doubl
-00029580: 655f 6173 7465 7269 736b 273a 207b 0a20  e_asterisk': {. 
-00029590: 2020 2020 2020 2020 2020 2027 6f6e 6527             'one'
-000295a0: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-000295b0: 2020 2020 2761 6c73 6f5f 6578 636c 7564      'also_exclud
-000295c0: 652e 7478 7427 3a20 4e6f 6e65 2c0a 2020  e.txt': None,.  
-000295d0: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
-000295e0: 2020 2020 2020 2020 2027 7477 6f27 3a20           'two': 
-000295f0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00029600: 2020 2761 6c73 6f5f 6578 636c 7564 652e    'also_exclude.
-00029610: 7478 7427 3a20 4e6f 6e65 2c0a 2020 2020  txt': None,.    
-00029620: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-00029630: 2020 207d 2c0a 2020 2020 2020 2020 276e     },.        'n
-00029640: 6573 7465 645f 7769 6c64 6361 7264 5f64  ested_wildcard_d
-00029650: 6972 273a 207b 0a20 2020 2020 2020 2020  ir': {.         
-00029660: 2020 2027 6d6f 6e64 6179 273a 207b 0a20     'monday': {. 
-00029670: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00029680: 616c 736f 5f65 7863 6c75 6465 2e74 7874  also_exclude.txt
-00029690: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-000296a0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-000296b0: 2020 2020 2774 7565 7364 6179 273a 207b      'tuesday': {
-000296c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000296d0: 2027 616c 736f 5f65 7863 6c75 6465 2e74   'also_exclude.t
-000296e0: 7874 273a 204e 6f6e 652c 0a20 2020 2020  xt': None,.     
-000296f0: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-00029700: 2020 7d2c 0a20 2020 2020 2020 2027 6e6f    },.        'no
-00029710: 5f73 6c61 7368 5f65 7863 6c75 6465 6427  _slash_excluded'
-00029720: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-00029730: 276e 6f5f 736c 6173 685f 7465 7374 7327  'no_slash_tests'
-00029740: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-00029750: 276e 6f5f 736c 6173 685f 6578 636c 7564  'no_slash_exclud
-00029760: 6564 273a 207b 0a20 2020 2020 2020 2020  ed': {.         
-00029770: 2020 2020 2020 2027 616c 736f 5f65 7863         'also_exc
-00029780: 6c75 6465 642e 7478 7427 3a20 4e6f 6e65  luded.txt': None
-00029790: 2c0a 2020 2020 2020 2020 2020 2020 7d2c  ,.            },
-000297a0: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
-000297b0: 2020 2020 2771 7565 7374 696f 6e5f 6d61      'question_ma
-000297c0: 726b 273a 207b 0a20 2020 2020 2020 2020  rk': {.         
-000297d0: 2020 2027 6578 636c 7564 6564 312e 7478     'excluded1.tx
-000297e0: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
-000297f0: 2020 2020 2020 2765 7863 6c75 6465 6440        'excluded@
-00029800: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
-00029810: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-00029820: 2773 7175 6172 655f 6272 6163 6b65 7427  'square_bracket'
-00029830: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-00029840: 2765 7863 6c75 6465 6431 2e74 7874 273a  'excluded1.txt':
-00029850: 204e 6f6e 652c 0a20 2020 2020 2020 207d   None,.        }
-00029860: 2c0a 2020 2020 2020 2020 2773 7175 6172  ,.        'squar
-00029870: 655f 6272 6163 6b65 745f 616c 7068 6127  e_bracket_alpha'
-00029880: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-00029890: 2765 7863 6c75 6465 647a 2e74 7874 273a  'excludedz.txt':
-000298a0: 204e 6f6e 652c 0a20 2020 2020 2020 207d   None,.        }
-000298b0: 2c0a 2020 2020 2020 2020 2773 7175 6172  ,.        'squar
-000298c0: 655f 6272 6163 6b65 745f 6578 636c 6127  e_bracket_excla'
-000298d0: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-000298e0: 2765 7863 6c75 6465 6432 2e74 7874 273a  'excluded2.txt':
-000298f0: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
-00029900: 2020 2027 6578 636c 7564 6564 402e 7478     'excluded@.tx
-00029910: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
-00029920: 2020 7d2c 0a20 2020 2020 2020 2027 7371    },.        'sq
-00029930: 7561 7265 5f62 7261 636b 6574 5f73 696e  uare_bracket_sin
-00029940: 676c 6527 3a20 7b0a 2020 2020 2020 2020  gle': {.        
-00029950: 2020 2020 2765 7863 6c75 6465 6430 2e74      'excluded0.t
-00029960: 7874 273a 204e 6f6e 652c 0a20 2020 2020  xt': None,.     
-00029970: 2020 207d 2c0a 2020 2020 7d0a 0a20 2020     },.    }..   
-00029980: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
-00029990: 2020 2064 6566 2063 7265 6174 655f 6469     def create_di
-000299a0: 725f 7374 7275 6374 7572 6528 6261 7365  r_structure(base
-000299b0: 5f70 6174 682c 2073 7472 7563 7475 7265  _path, structure
-000299c0: 293a 0a20 2020 2020 2020 2023 2063 7265  ):.        # cre
-000299d0: 6174 6573 2061 2067 6976 656e 2066 696c  ates a given fil
-000299e0: 6520 5354 5255 4354 5552 4520 696e 2042  e STRUCTURE in B
-000299f0: 4153 455f 5041 5448 0a20 2020 2020 2020  ASE_PATH.       
-00029a00: 2066 6f72 206e 616d 652c 2073 7562 7374   for name, subst
-00029a10: 7275 6374 7572 6520 696e 2073 7472 7563  ructure in struc
-00029a20: 7475 7265 2e69 7465 6d73 2829 3a0a 2020  ture.items():.  
-00029a30: 2020 2020 2020 2020 2020 7061 7468 203d            path =
-00029a40: 206f 732e 7061 7468 2e6a 6f69 6e28 6261   os.path.join(ba
-00029a50: 7365 5f70 6174 682c 206e 616d 6529 0a20  se_path, name). 
-00029a60: 2020 2020 2020 2020 2020 2069 6620 7375             if su
-00029a70: 6273 7472 7563 7475 7265 2069 7320 4e6f  bstructure is No
-00029a80: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00029a90: 2020 2020 2320 4372 6561 7465 2061 2066      # Create a f
-00029aa0: 696c 650a 2020 2020 2020 2020 2020 2020  ile.            
-00029ab0: 2020 2020 6f70 656e 2870 6174 682c 2027      open(path, '
-00029ac0: 6127 2c20 656e 636f 6469 6e67 3d27 7574  a', encoding='ut
-00029ad0: 662d 3827 292e 636c 6f73 6528 290a 2020  f-8').close().  
-00029ae0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00029af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029b00: 2320 4372 6561 7465 2061 2073 7562 6469  # Create a subdi
-00029b10: 7265 6374 6f72 790a 2020 2020 2020 2020  rectory.        
-00029b20: 2020 2020 2020 2020 6f73 2e6d 6b64 6972          os.mkdir
-00029b30: 2870 6174 6829 0a20 2020 2020 2020 2020  (path).         
-00029b40: 2020 2020 2020 2054 6573 7453 746f 7261         TestStora
-00029b50: 6765 5769 7468 4372 6564 656e 7469 616c  geWithCredential
-00029b60: 732e 6372 6561 7465 5f64 6972 5f73 7472  s.create_dir_str
-00029b70: 7563 7475 7265 280a 2020 2020 2020 2020  ucture(.        
-00029b80: 2020 2020 2020 2020 2020 2020 7061 7468              path
-00029b90: 2c20 7375 6273 7472 7563 7475 7265 290a  , substructure).
-00029ba0: 0a20 2020 2040 7374 6174 6963 6d65 7468  .    @staticmeth
-00029bb0: 6f64 0a20 2020 2064 6566 2063 6c69 5f64  od.    def cli_d
-00029bc0: 656c 6574 655f 636d 6428 7374 6f72 655f  elete_cmd(store_
-00029bd0: 7479 7065 2c20 6275 636b 6574 5f6e 616d  type, bucket_nam
-00029be0: 6529 3a0a 2020 2020 2020 2020 6966 2073  e):.        if s
-00029bf0: 746f 7265 5f74 7970 6520 3d3d 2073 746f  tore_type == sto
-00029c00: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-00029c10: 7065 2e53 333a 0a20 2020 2020 2020 2020  pe.S3:.         
-00029c20: 2020 2075 726c 203d 2066 2773 333a 2f2f     url = f's3://
-00029c30: 7b62 7563 6b65 745f 6e61 6d65 7d27 0a20  {bucket_name}'. 
-00029c40: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00029c50: 6e20 6627 6177 7320 7333 2072 6220 7b75  n f'aws s3 rb {u
-00029c60: 726c 7d20 2d2d 666f 7263 6527 0a20 2020  rl} --force'.   
-00029c70: 2020 2020 2069 6620 7374 6f72 655f 7479       if store_ty
-00029c80: 7065 203d 3d20 7374 6f72 6167 655f 6c69  pe == storage_li
-00029c90: 622e 5374 6f72 6554 7970 652e 4743 533a  b.StoreType.GCS:
-00029ca0: 0a20 2020 2020 2020 2020 2020 2075 726c  .            url
-00029cb0: 203d 2066 2767 733a 2f2f 7b62 7563 6b65   = f'gs://{bucke
-00029cc0: 745f 6e61 6d65 7d27 0a20 2020 2020 2020  t_name}'.       
-00029cd0: 2020 2020 2067 7375 7469 6c5f 616c 6961       gsutil_alia
-00029ce0: 732c 2061 6c69 6173 5f67 656e 203d 2064  s, alias_gen = d
-00029cf0: 6174 615f 7574 696c 732e 6765 745f 6773  ata_utils.get_gs
-00029d00: 7574 696c 5f63 6f6d 6d61 6e64 2829 0a20  util_command(). 
-00029d10: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00029d20: 6e20 6627 7b61 6c69 6173 5f67 656e 7d3b  n f'{alias_gen};
-00029d30: 207b 6773 7574 696c 5f61 6c69 6173 7d20   {gsutil_alias} 
-00029d40: 726d 202d 7220 7b75 726c 7d27 0a20 2020  rm -r {url}'.   
-00029d50: 2020 2020 2069 6620 7374 6f72 655f 7479       if store_ty
-00029d60: 7065 203d 3d20 7374 6f72 6167 655f 6c69  pe == storage_li
-00029d70: 622e 5374 6f72 6554 7970 652e 5232 3a0a  b.StoreType.R2:.
-00029d80: 2020 2020 2020 2020 2020 2020 656e 6470              endp
-00029d90: 6f69 6e74 5f75 726c 203d 2063 6c6f 7564  oint_url = cloud
-00029da0: 666c 6172 652e 6372 6561 7465 5f65 6e64  flare.create_end
-00029db0: 706f 696e 7428 290a 2020 2020 2020 2020  point().        
-00029dc0: 2020 2020 7572 6c20 3d20 6627 7333 3a2f      url = f's3:/
-00029dd0: 2f7b 6275 636b 6574 5f6e 616d 657d 270a  /{bucket_name}'.
-00029de0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00029df0: 726e 2066 2741 5753 5f53 4841 5245 445f  rn f'AWS_SHARED_
-00029e00: 4352 4544 454e 5449 414c 535f 4649 4c45  CREDENTIALS_FILE
-00029e10: 3d7b 636c 6f75 6466 6c61 7265 2e52 325f  ={cloudflare.R2_
-00029e20: 4352 4544 454e 5449 414c 535f 5041 5448  CREDENTIALS_PATH
-00029e30: 7d20 6177 7320 7333 2072 6220 7b75 726c  } aws s3 rb {url
-00029e40: 7d20 2d2d 666f 7263 6520 2d2d 656e 6470  } --force --endp
-00029e50: 6f69 6e74 207b 656e 6470 6f69 6e74 5f75  oint {endpoint_u
-00029e60: 726c 7d20 2d2d 7072 6f66 696c 653d 7232  rl} --profile=r2
-00029e70: 270a 2020 2020 2020 2020 6966 2073 746f  '.        if sto
-00029e80: 7265 5f74 7970 6520 3d3d 2073 746f 7261  re_type == stora
-00029e90: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-00029ea0: 2e49 424d 3a0a 2020 2020 2020 2020 2020  .IBM:.          
-00029eb0: 2020 6275 636b 6574 5f72 636c 6f6e 655f    bucket_rclone_
-00029ec0: 7072 6f66 696c 6520 3d20 5263 6c6f 6e65  profile = Rclone
-00029ed0: 2e67 656e 6572 6174 655f 7263 6c6f 6e65  .generate_rclone
-00029ee0: 5f62 7563 6b65 745f 7072 6f66 696c 655f  _bucket_profile_
-00029ef0: 6e61 6d65 280a 2020 2020 2020 2020 2020  name(.          
-00029f00: 2020 2020 2020 6275 636b 6574 5f6e 616d        bucket_nam
-00029f10: 652c 2052 636c 6f6e 652e 5263 6c6f 6e65  e, Rclone.Rclone
-00029f20: 436c 6f75 6473 2e49 424d 290a 2020 2020  Clouds.IBM).    
-00029f30: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-00029f40: 2772 636c 6f6e 6520 7075 7267 6520 7b62  'rclone purge {b
-00029f50: 7563 6b65 745f 7263 6c6f 6e65 5f70 726f  ucket_rclone_pro
-00029f60: 6669 6c65 7d3a 7b62 7563 6b65 745f 6e61  file}:{bucket_na
-00029f70: 6d65 7d20 2626 2072 636c 6f6e 6520 636f  me} && rclone co
-00029f80: 6e66 6967 2064 656c 6574 6520 7b62 7563  nfig delete {buc
-00029f90: 6b65 745f 7263 6c6f 6e65 5f70 726f 6669  ket_rclone_profi
-00029fa0: 6c65 7d27 0a0a 2020 2020 4073 7461 7469  le}'..    @stati
-00029fb0: 636d 6574 686f 640a 2020 2020 6465 6620  cmethod.    def 
-00029fc0: 636c 695f 6c73 5f63 6d64 2873 746f 7265  cli_ls_cmd(store
-00029fd0: 5f74 7970 652c 2062 7563 6b65 745f 6e61  _type, bucket_na
-00029fe0: 6d65 2c20 7375 6666 6978 3d27 2729 3a0a  me, suffix=''):.
-00029ff0: 2020 2020 2020 2020 6966 2073 746f 7265          if store
-0002a000: 5f74 7970 6520 3d3d 2073 746f 7261 6765  _type == storage
-0002a010: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
-0002a020: 333a 0a20 2020 2020 2020 2020 2020 2069  3:.            i
-0002a030: 6620 7375 6666 6978 3a0a 2020 2020 2020  f suffix:.      
-0002a040: 2020 2020 2020 2020 2020 7572 6c20 3d20            url = 
-0002a050: 6627 7333 3a2f 2f7b 6275 636b 6574 5f6e  f's3://{bucket_n
-0002a060: 616d 657d 2f7b 7375 6666 6978 7d27 0a20  ame}/{suffix}'. 
-0002a070: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0002a080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a090: 2075 726c 203d 2066 2773 333a 2f2f 7b62   url = f's3://{b
-0002a0a0: 7563 6b65 745f 6e61 6d65 7d27 0a20 2020  ucket_name}'.   
-0002a0b0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0002a0c0: 6627 6177 7320 7333 206c 7320 7b75 726c  f'aws s3 ls {url
-0002a0d0: 7d27 0a20 2020 2020 2020 2069 6620 7374  }'.        if st
-0002a0e0: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
-0002a0f0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0002a100: 652e 4743 533a 0a20 2020 2020 2020 2020  e.GCS:.         
-0002a110: 2020 2069 6620 7375 6666 6978 3a0a 2020     if suffix:.  
-0002a120: 2020 2020 2020 2020 2020 2020 2020 7572                ur
-0002a130: 6c20 3d20 6627 6773 3a2f 2f7b 6275 636b  l = f'gs://{buck
-0002a140: 6574 5f6e 616d 657d 2f7b 7375 6666 6978  et_name}/{suffix
-0002a150: 7d27 0a20 2020 2020 2020 2020 2020 2065  }'.            e
-0002a160: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0002a170: 2020 2020 2075 726c 203d 2066 2767 733a       url = f'gs:
-0002a180: 2f2f 7b62 7563 6b65 745f 6e61 6d65 7d27  //{bucket_name}'
-0002a190: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0002a1a0: 7572 6e20 6627 6773 7574 696c 206c 7320  urn f'gsutil ls 
-0002a1b0: 7b75 726c 7d27 0a20 2020 2020 2020 2069  {url}'.        i
-0002a1c0: 6620 7374 6f72 655f 7479 7065 203d 3d20  f store_type == 
-0002a1d0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002a1e0: 6554 7970 652e 5232 3a0a 2020 2020 2020  eType.R2:.      
-0002a1f0: 2020 2020 2020 656e 6470 6f69 6e74 5f75        endpoint_u
-0002a200: 726c 203d 2063 6c6f 7564 666c 6172 652e  rl = cloudflare.
-0002a210: 6372 6561 7465 5f65 6e64 706f 696e 7428  create_endpoint(
-0002a220: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0002a230: 2073 7566 6669 783a 0a20 2020 2020 2020   suffix:.       
-0002a240: 2020 2020 2020 2020 2075 726c 203d 2066           url = f
-0002a250: 2773 333a 2f2f 7b62 7563 6b65 745f 6e61  's3://{bucket_na
-0002a260: 6d65 7d2f 7b73 7566 6669 787d 270a 2020  me}/{suffix}'.  
-0002a270: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0002a280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a290: 7572 6c20 3d20 6627 7333 3a2f 2f7b 6275  url = f's3://{bu
-0002a2a0: 636b 6574 5f6e 616d 657d 270a 2020 2020  cket_name}'.    
-0002a2b0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-0002a2c0: 2741 5753 5f53 4841 5245 445f 4352 4544  'AWS_SHARED_CRED
-0002a2d0: 454e 5449 414c 535f 4649 4c45 3d7b 636c  ENTIALS_FILE={cl
-0002a2e0: 6f75 6466 6c61 7265 2e52 325f 4352 4544  oudflare.R2_CRED
-0002a2f0: 454e 5449 414c 535f 5041 5448 7d20 6177  ENTIALS_PATH} aw
-0002a300: 7320 7333 206c 7320 7b75 726c 7d20 2d2d  s s3 ls {url} --
-0002a310: 656e 6470 6f69 6e74 207b 656e 6470 6f69  endpoint {endpoi
-0002a320: 6e74 5f75 726c 7d20 2d2d 7072 6f66 696c  nt_url} --profil
-0002a330: 653d 7232 270a 2020 2020 2020 2020 6966  e=r2'.        if
-0002a340: 2073 746f 7265 5f74 7970 6520 3d3d 2073   store_type == s
-0002a350: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-0002a360: 5479 7065 2e49 424d 3a0a 2020 2020 2020  Type.IBM:.      
-0002a370: 2020 2020 2020 6275 636b 6574 5f72 636c        bucket_rcl
-0002a380: 6f6e 655f 7072 6f66 696c 6520 3d20 5263  one_profile = Rc
-0002a390: 6c6f 6e65 2e67 656e 6572 6174 655f 7263  lone.generate_rc
-0002a3a0: 6c6f 6e65 5f62 7563 6b65 745f 7072 6f66  lone_bucket_prof
-0002a3b0: 696c 655f 6e61 6d65 280a 2020 2020 2020  ile_name(.      
-0002a3c0: 2020 2020 2020 2020 2020 6275 636b 6574            bucket
-0002a3d0: 5f6e 616d 652c 2052 636c 6f6e 652e 5263  _name, Rclone.Rc
-0002a3e0: 6c6f 6e65 436c 6f75 6473 2e49 424d 290a  loneClouds.IBM).
-0002a3f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0002a400: 726e 2066 2772 636c 6f6e 6520 6c73 207b  rn f'rclone ls {
-0002a410: 6275 636b 6574 5f72 636c 6f6e 655f 7072  bucket_rclone_pr
-0002a420: 6f66 696c 657d 3a7b 6275 636b 6574 5f6e  ofile}:{bucket_n
-0002a430: 616d 657d 2f7b 7375 6666 6978 7d27 0a0a  ame}/{suffix}'..
-0002a440: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
-0002a450: 640a 2020 2020 6465 6620 636c 695f 7265  d.    def cli_re
-0002a460: 6769 6f6e 5f63 6d64 2873 746f 7265 5f74  gion_cmd(store_t
-0002a470: 7970 652c 2062 7563 6b65 745f 6e61 6d65  ype, bucket_name
-0002a480: 293a 0a20 2020 2020 2020 2069 6620 7374  ):.        if st
-0002a490: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
-0002a4a0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0002a4b0: 652e 5333 3a0a 2020 2020 2020 2020 2020  e.S3:.          
-0002a4c0: 2020 7265 7475 726e 2028 2761 7773 2073    return ('aws s
-0002a4d0: 3361 7069 2067 6574 2d62 7563 6b65 742d  3api get-bucket-
-0002a4e0: 6c6f 6361 7469 6f6e 2027 0a20 2020 2020  location '.     
-0002a4f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002a500: 272d 2d62 7563 6b65 7420 7b62 7563 6b65  '--bucket {bucke
-0002a510: 745f 6e61 6d65 7d20 2d2d 6f75 7470 7574  t_name} --output
-0002a520: 2074 6578 7427 290a 2020 2020 2020 2020   text').        
-0002a530: 656c 6966 2073 746f 7265 5f74 7970 6520  elif store_type 
-0002a540: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
-0002a550: 746f 7265 5479 7065 2e47 4353 3a0a 2020  toreType.GCS:.  
-0002a560: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0002a570: 2028 6627 6773 7574 696c 206c 7320 2d4c   (f'gsutil ls -L
-0002a580: 202d 6220 6773 3a2f 2f7b 6275 636b 6574   -b gs://{bucket
-0002a590: 5f6e 616d 657d 2f20 7c20 270a 2020 2020  _name}/ | '.    
-0002a5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a5b0: 2767 7265 7020 224c 6f63 6174 696f 6e20  'grep "Location 
-0002a5c0: 636f 6e73 7472 6169 6e74 2220 7c20 270a  constraint" | '.
-0002a5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a5e0: 2020 2020 2761 776b 205c 277b 7072 696e      'awk \'{prin
-0002a5f0: 7420 746f 6c6f 7765 7228 244e 4629 7d5c  t tolower($NF)}\
-0002a600: 2727 290a 2020 2020 2020 2020 656c 7365  '').        else
-0002a610: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0002a620: 6973 6520 4e6f 7449 6d70 6c65 6d65 6e74  ise NotImplement
-0002a630: 6564 4572 726f 7228 6627 5265 6769 6f6e  edError(f'Region
-0002a640: 2063 6f6d 6d61 6e64 206e 6f74 2069 6d70   command not imp
-0002a650: 6c65 6d65 6e74 6564 2066 6f72 2027 0a20  lemented for '. 
-0002a660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a680: 2020 2020 2066 277b 7374 6f72 655f 7479       f'{store_ty
-0002a690: 7065 7d27 290a 0a20 2020 2040 7374 6174  pe}')..    @stat
-0002a6a0: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
-0002a6b0: 2063 6c69 5f63 6f75 6e74 5f6e 616d 655f   cli_count_name_
-0002a6c0: 696e 5f62 7563 6b65 7428 7374 6f72 655f  in_bucket(store_
-0002a6d0: 7479 7065 2c20 6275 636b 6574 5f6e 616d  type, bucket_nam
-0002a6e0: 652c 2066 696c 655f 6e61 6d65 2c20 7375  e, file_name, su
-0002a6f0: 6666 6978 3d27 2729 3a0a 2020 2020 2020  ffix=''):.      
-0002a700: 2020 6966 2073 746f 7265 5f74 7970 6520    if store_type 
-0002a710: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
-0002a720: 746f 7265 5479 7065 2e53 333a 0a20 2020  toreType.S3:.   
-0002a730: 2020 2020 2020 2020 2069 6620 7375 6666           if suff
-0002a740: 6978 3a0a 2020 2020 2020 2020 2020 2020  ix:.            
-0002a750: 2020 2020 7265 7475 726e 2066 2761 7773      return f'aws
-0002a760: 2073 3361 7069 206c 6973 742d 6f62 6a65   s3api list-obje
-0002a770: 6374 7320 2d2d 6275 636b 6574 2022 7b62  cts --bucket "{b
-0002a780: 7563 6b65 745f 6e61 6d65 7d22 202d 2d70  ucket_name}" --p
-0002a790: 7265 6669 7820 7b73 7566 6669 787d 202d  refix {suffix} -
-0002a7a0: 2d71 7565 7279 2022 6c65 6e67 7468 2843  -query "length(C
-0002a7b0: 6f6e 7465 6e74 735b 3f63 6f6e 7461 696e  ontents[?contain
-0002a7c0: 7328 4b65 792c 5c27 7b66 696c 655f 6e61  s(Key,\'{file_na
-0002a7d0: 6d65 7d5c 2729 5d2e 4b65 7929 2227 0a20  me}\')].Key)"'. 
-0002a7e0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0002a7f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a800: 2072 6574 7572 6e20 6627 6177 7320 7333   return f'aws s3
-0002a810: 6170 6920 6c69 7374 2d6f 626a 6563 7473  api list-objects
-0002a820: 202d 2d62 7563 6b65 7420 227b 6275 636b   --bucket "{buck
-0002a830: 6574 5f6e 616d 657d 2220 2d2d 7175 6572  et_name}" --quer
-0002a840: 7920 226c 656e 6774 6828 436f 6e74 656e  y "length(Conten
-0002a850: 7473 5b3f 636f 6e74 6169 6e73 284b 6579  ts[?contains(Key
-0002a860: 2c5c 277b 6669 6c65 5f6e 616d 657d 5c27  ,\'{file_name}\'
-0002a870: 295d 2e4b 6579 2922 270a 2020 2020 2020  )].Key)"'.      
-0002a880: 2020 656c 6966 2073 746f 7265 5f74 7970    elif store_typ
-0002a890: 6520 3d3d 2073 746f 7261 6765 5f6c 6962  e == storage_lib
-0002a8a0: 2e53 746f 7265 5479 7065 2e47 4353 3a0a  .StoreType.GCS:.
-0002a8b0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-0002a8c0: 7566 6669 783a 0a20 2020 2020 2020 2020  uffix:.         
-0002a8d0: 2020 2020 2020 2072 6574 7572 6e20 6627         return f'
-0002a8e0: 6773 7574 696c 206c 7320 2d72 2067 733a  gsutil ls -r gs:
-0002a8f0: 2f2f 7b62 7563 6b65 745f 6e61 6d65 7d2f  //{bucket_name}/
-0002a900: 7b73 7566 6669 787d 207c 2067 7265 7020  {suffix} | grep 
-0002a910: 227b 6669 6c65 5f6e 616d 657d 2220 7c20  "{file_name}" | 
-0002a920: 7763 202d 6c27 0a20 2020 2020 2020 2020  wc -l'.         
-0002a930: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002a940: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0002a950: 6627 6773 7574 696c 206c 7320 2d72 2067  f'gsutil ls -r g
-0002a960: 733a 2f2f 7b62 7563 6b65 745f 6e61 6d65  s://{bucket_name
-0002a970: 7d20 7c20 6772 6570 2022 7b66 696c 655f  } | grep "{file_
-0002a980: 6e61 6d65 7d22 207c 2077 6320 2d6c 270a  name}" | wc -l'.
-0002a990: 2020 2020 2020 2020 656c 6966 2073 746f          elif sto
-0002a9a0: 7265 5f74 7970 6520 3d3d 2073 746f 7261  re_type == stora
-0002a9b0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-0002a9c0: 2e52 323a 0a20 2020 2020 2020 2020 2020  .R2:.           
-0002a9d0: 2065 6e64 706f 696e 745f 7572 6c20 3d20   endpoint_url = 
-0002a9e0: 636c 6f75 6466 6c61 7265 2e63 7265 6174  cloudflare.creat
-0002a9f0: 655f 656e 6470 6f69 6e74 2829 0a20 2020  e_endpoint().   
-0002aa00: 2020 2020 2020 2020 2069 6620 7375 6666           if suff
-0002aa10: 6978 3a0a 2020 2020 2020 2020 2020 2020  ix:.            
-0002aa20: 2020 2020 7265 7475 726e 2066 2741 5753      return f'AWS
-0002aa30: 5f53 4841 5245 445f 4352 4544 454e 5449  _SHARED_CREDENTI
-0002aa40: 414c 535f 4649 4c45 3d7b 636c 6f75 6466  ALS_FILE={cloudf
-0002aa50: 6c61 7265 2e52 325f 4352 4544 454e 5449  lare.R2_CREDENTI
-0002aa60: 414c 535f 5041 5448 7d20 6177 7320 7333  ALS_PATH} aws s3
-0002aa70: 6170 6920 6c69 7374 2d6f 626a 6563 7473  api list-objects
-0002aa80: 202d 2d62 7563 6b65 7420 227b 6275 636b   --bucket "{buck
-0002aa90: 6574 5f6e 616d 657d 2220 2d2d 7072 6566  et_name}" --pref
-0002aaa0: 6978 207b 7375 6666 6978 7d20 2d2d 7175  ix {suffix} --qu
-0002aab0: 6572 7920 226c 656e 6774 6828 436f 6e74  ery "length(Cont
-0002aac0: 656e 7473 5b3f 636f 6e74 6169 6e73 284b  ents[?contains(K
-0002aad0: 6579 2c5c 277b 6669 6c65 5f6e 616d 657d  ey,\'{file_name}
-0002aae0: 5c27 295d 2e4b 6579 2922 202d 2d65 6e64  \')].Key)" --end
-0002aaf0: 706f 696e 7420 7b65 6e64 706f 696e 745f  point {endpoint_
-0002ab00: 7572 6c7d 202d 2d70 726f 6669 6c65 3d72  url} --profile=r
-0002ab10: 3227 0a20 2020 2020 2020 2020 2020 2065  2'.            e
-0002ab20: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0002ab30: 2020 2020 2072 6574 7572 6e20 6627 4157       return f'AW
-0002ab40: 535f 5348 4152 4544 5f43 5245 4445 4e54  S_SHARED_CREDENT
-0002ab50: 4941 4c53 5f46 494c 453d 7b63 6c6f 7564  IALS_FILE={cloud
-0002ab60: 666c 6172 652e 5232 5f43 5245 4445 4e54  flare.R2_CREDENT
-0002ab70: 4941 4c53 5f50 4154 487d 2061 7773 2073  IALS_PATH} aws s
-0002ab80: 3361 7069 206c 6973 742d 6f62 6a65 6374  3api list-object
-0002ab90: 7320 2d2d 6275 636b 6574 2022 7b62 7563  s --bucket "{buc
-0002aba0: 6b65 745f 6e61 6d65 7d22 202d 2d71 7565  ket_name}" --que
-0002abb0: 7279 2022 6c65 6e67 7468 2843 6f6e 7465  ry "length(Conte
-0002abc0: 6e74 735b 3f63 6f6e 7461 696e 7328 4b65  nts[?contains(Ke
-0002abd0: 792c 5c27 7b66 696c 655f 6e61 6d65 7d5c  y,\'{file_name}\
-0002abe0: 2729 5d2e 4b65 7929 2220 2d2d 656e 6470  ')].Key)" --endp
-0002abf0: 6f69 6e74 207b 656e 6470 6f69 6e74 5f75  oint {endpoint_u
-0002ac00: 726c 7d20 2d2d 7072 6f66 696c 653d 7232  rl} --profile=r2
-0002ac10: 270a 0a20 2020 2040 7374 6174 6963 6d65  '..    @staticme
-0002ac20: 7468 6f64 0a20 2020 2064 6566 2063 6c69  thod.    def cli
-0002ac30: 5f63 6f75 6e74 5f66 696c 655f 696e 5f62  _count_file_in_b
-0002ac40: 7563 6b65 7428 7374 6f72 655f 7479 7065  ucket(store_type
-0002ac50: 2c20 6275 636b 6574 5f6e 616d 6529 3a0a  , bucket_name):.
-0002ac60: 2020 2020 2020 2020 6966 2073 746f 7265          if store
-0002ac70: 5f74 7970 6520 3d3d 2073 746f 7261 6765  _type == storage
-0002ac80: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
-0002ac90: 333a 0a20 2020 2020 2020 2020 2020 2072  3:.            r
-0002aca0: 6574 7572 6e20 6627 6177 7320 7333 206c  eturn f'aws s3 l
-0002acb0: 7320 7333 3a2f 2f7b 6275 636b 6574 5f6e  s s3://{bucket_n
-0002acc0: 616d 657d 202d 2d72 6563 7572 7369 7665  ame} --recursive
-0002acd0: 207c 2077 6320 2d6c 270a 2020 2020 2020   | wc -l'.      
-0002ace0: 2020 656c 6966 2073 746f 7265 5f74 7970    elif store_typ
-0002acf0: 6520 3d3d 2073 746f 7261 6765 5f6c 6962  e == storage_lib
-0002ad00: 2e53 746f 7265 5479 7065 2e47 4353 3a0a  .StoreType.GCS:.
-0002ad10: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0002ad20: 726e 2066 2767 7375 7469 6c20 6c73 202d  rn f'gsutil ls -
-0002ad30: 7220 6773 3a2f 2f7b 6275 636b 6574 5f6e  r gs://{bucket_n
-0002ad40: 616d 657d 2f2a 2a20 7c20 7763 202d 6c27  ame}/** | wc -l'
-0002ad50: 0a20 2020 2020 2020 2065 6c69 6620 7374  .        elif st
-0002ad60: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
-0002ad70: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0002ad80: 652e 5232 3a0a 2020 2020 2020 2020 2020  e.R2:.          
-0002ad90: 2020 656e 6470 6f69 6e74 5f75 726c 203d    endpoint_url =
-0002ada0: 2063 6c6f 7564 666c 6172 652e 6372 6561   cloudflare.crea
-0002adb0: 7465 5f65 6e64 706f 696e 7428 290a 2020  te_endpoint().  
-0002adc0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0002add0: 2066 2741 5753 5f53 4841 5245 445f 4352   f'AWS_SHARED_CR
-0002ade0: 4544 454e 5449 414c 535f 4649 4c45 3d7b  EDENTIALS_FILE={
-0002adf0: 636c 6f75 6466 6c61 7265 2e52 325f 4352  cloudflare.R2_CR
-0002ae00: 4544 454e 5449 414c 535f 5041 5448 7d20  EDENTIALS_PATH} 
-0002ae10: 6177 7320 7333 206c 7320 7333 3a2f 2f7b  aws s3 ls s3://{
-0002ae20: 6275 636b 6574 5f6e 616d 657d 202d 2d72  bucket_name} --r
-0002ae30: 6563 7572 7369 7665 202d 2d65 6e64 706f  ecursive --endpo
-0002ae40: 696e 7420 7b65 6e64 706f 696e 745f 7572  int {endpoint_ur
-0002ae50: 6c7d 202d 2d70 726f 6669 6c65 3d72 3220  l} --profile=r2 
-0002ae60: 7c20 7763 202d 6c27 0a0a 2020 2020 4070  | wc -l'..    @p
-0002ae70: 7974 6573 742e 6669 7874 7572 650a 2020  ytest.fixture.  
-0002ae80: 2020 6465 6620 746d 705f 736f 7572 6365    def tmp_source
-0002ae90: 2873 656c 662c 2074 6d70 5f70 6174 6829  (self, tmp_path)
-0002aea0: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
-0002aeb0: 7465 7320 6120 7465 6d70 6f72 6172 7920  tes a temporary 
-0002aec0: 6469 7265 6374 6f72 7920 7769 7468 2061  directory with a
-0002aed0: 2066 696c 6520 696e 2069 740a 2020 2020   file in it.    
-0002aee0: 2020 2020 746d 705f 6469 7220 3d20 746d      tmp_dir = tm
-0002aef0: 705f 7061 7468 202f 2027 746d 702d 736f  p_path / 'tmp-so
-0002af00: 7572 6365 270a 2020 2020 2020 2020 746d  urce'.        tm
-0002af10: 705f 6469 722e 6d6b 6469 7228 290a 2020  p_dir.mkdir().  
-0002af20: 2020 2020 2020 746d 705f 6669 6c65 203d        tmp_file =
-0002af30: 2074 6d70 5f64 6972 202f 2027 746d 702d   tmp_dir / 'tmp-
-0002af40: 6669 6c65 270a 2020 2020 2020 2020 746d  file'.        tm
-0002af50: 705f 6669 6c65 2e77 7269 7465 5f74 6578  p_file.write_tex
-0002af60: 7428 2774 6573 7427 290a 2020 2020 2020  t('test').      
-0002af70: 2020 6369 7263 6c65 5f6c 696e 6b20 3d20    circle_link = 
-0002af80: 746d 705f 6469 7220 2f20 2763 6972 636c  tmp_dir / 'circl
-0002af90: 652d 6c69 6e6b 270a 2020 2020 2020 2020  e-link'.        
-0002afa0: 6369 7263 6c65 5f6c 696e 6b2e 7379 6d6c  circle_link.syml
-0002afb0: 696e 6b5f 746f 2874 6d70 5f64 6972 2c20  ink_to(tmp_dir, 
-0002afc0: 7461 7267 6574 5f69 735f 6469 7265 6374  target_is_direct
-0002afd0: 6f72 793d 5472 7565 290a 2020 2020 2020  ory=True).      
-0002afe0: 2020 7969 656c 6420 7374 7228 746d 705f    yield str(tmp_
-0002aff0: 6469 7229 0a0a 2020 2020 4073 7461 7469  dir)..    @stati
-0002b000: 636d 6574 686f 640a 2020 2020 6465 6620  cmethod.    def 
-0002b010: 6765 6e65 7261 7465 5f62 7563 6b65 745f  generate_bucket_
-0002b020: 6e61 6d65 2829 3a0a 2020 2020 2020 2020  name():.        
-0002b030: 2320 4372 6561 7465 7320 6120 7465 6d70  # Creates a temp
-0002b040: 6f72 6172 7920 6275 636b 6574 206e 616d  orary bucket nam
-0002b050: 650a 2020 2020 2020 2020 2320 7469 6d65  e.        # time
-0002b060: 2e74 696d 6528 2920 7265 7475 726e 7320  .time() returns 
-0002b070: 7661 7279 696e 6720 7072 6563 6973 696f  varying precisio
-0002b080: 6e20 6f6e 2064 6966 6665 7265 6e74 2073  n on different s
-0002b090: 7973 7465 6d73 2c20 736f 2077 650a 2020  ystems, so we.  
-0002b0a0: 2020 2020 2020 2320 7265 706c 6163 6520        # replace 
-0002b0b0: 7468 6520 6465 6369 6d61 6c20 706f 696e  the decimal poin
-0002b0c0: 7420 616e 6420 7573 6520 7768 6174 6576  t and use whatev
-0002b0d0: 6572 2070 7265 6369 7369 6f6e 2077 6520  er precision we 
-0002b0e0: 6361 6e20 6765 742e 0a20 2020 2020 2020  can get..       
-0002b0f0: 2074 696d 6573 7461 6d70 203d 2073 7472   timestamp = str
-0002b100: 2874 696d 652e 7469 6d65 2829 292e 7265  (time.time()).re
-0002b110: 706c 6163 6528 272e 272c 2027 2729 0a20  place('.', ''). 
-0002b120: 2020 2020 2020 2072 6574 7572 6e20 6627         return f'
-0002b130: 736b 792d 7465 7374 2d7b 7469 6d65 7374  sky-test-{timest
-0002b140: 616d 707d 270a 0a20 2020 2040 7079 7465  amp}'..    @pyte
-0002b150: 7374 2e66 6978 7475 7265 0a20 2020 2064  st.fixture.    d
-0002b160: 6566 2074 6d70 5f62 7563 6b65 745f 6e61  ef tmp_bucket_na
-0002b170: 6d65 2873 656c 6629 3a0a 2020 2020 2020  me(self):.      
-0002b180: 2020 7969 656c 6420 7365 6c66 2e67 656e    yield self.gen
-0002b190: 6572 6174 655f 6275 636b 6574 5f6e 616d  erate_bucket_nam
-0002b1a0: 6528 290a 0a20 2020 2040 7374 6174 6963  e()..    @static
-0002b1b0: 6d65 7468 6f64 0a20 2020 2064 6566 2079  method.    def y
-0002b1c0: 6965 6c64 5f73 746f 7261 6765 5f6f 626a  ield_storage_obj
-0002b1d0: 6563 7428 0a20 2020 2020 2020 2020 2020  ect(.           
-0002b1e0: 206e 616d 653a 204f 7074 696f 6e61 6c5b   name: Optional[
-0002b1f0: 7374 725d 203d 204e 6f6e 652c 0a20 2020  str] = None,.   
-0002b200: 2020 2020 2020 2020 2073 6f75 7263 653a           source:
-0002b210: 204f 7074 696f 6e61 6c5b 7374 6f72 6167   Optional[storag
-0002b220: 655f 6c69 622e 5061 7468 5d20 3d20 4e6f  e_lib.Path] = No
-0002b230: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-0002b240: 7374 6f72 6573 3a20 4f70 7469 6f6e 616c  stores: Optional
-0002b250: 5b44 6963 745b 7374 6f72 6167 655f 6c69  [Dict[storage_li
-0002b260: 622e 5374 6f72 6554 7970 652c 0a20 2020  b.StoreType,.   
-0002b270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b280: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002b290: 746f 7261 6765 5f6c 6962 2e41 6273 7472  torage_lib.Abstr
-0002b2a0: 6163 7453 746f 7265 5d5d 203d 204e 6f6e  actStore]] = Non
-0002b2b0: 652c 0a20 2020 2020 2020 2020 2020 2070  e,.            p
-0002b2c0: 6572 7369 7374 656e 743a 204f 7074 696f  ersistent: Optio
-0002b2d0: 6e61 6c5b 626f 6f6c 5d20 3d20 5472 7565  nal[bool] = True
-0002b2e0: 2c0a 2020 2020 2020 2020 2020 2020 6d6f  ,.            mo
-0002b2f0: 6465 3a20 7374 6f72 6167 655f 6c69 622e  de: storage_lib.
-0002b300: 5374 6f72 6167 654d 6f64 6520 3d20 7374  StorageMode = st
-0002b310: 6f72 6167 655f 6c69 622e 5374 6f72 6167  orage_lib.Storag
-0002b320: 654d 6f64 652e 4d4f 554e 5429 3a0a 2020  eMode.MOUNT):.  
-0002b330: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
-0002b340: 6120 7465 6d70 6f72 6172 7920 7374 6f72  a temporary stor
-0002b350: 6167 6520 6f62 6a65 6374 2e20 5374 6f72  age object. Stor
-0002b360: 6573 206d 7573 7420 6265 2061 6464 6564  es must be added
-0002b370: 2069 6e20 7468 6520 7465 7374 2e0a 2020   in the test..  
-0002b380: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
-0002b390: 6a20 3d20 7374 6f72 6167 655f 6c69 622e  j = storage_lib.
-0002b3a0: 5374 6f72 6167 6528 6e61 6d65 3d6e 616d  Storage(name=nam
-0002b3b0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0002b3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b3d0: 2020 2020 2020 2020 2020 2020 2073 6f75               sou
-0002b3e0: 7263 653d 736f 7572 6365 2c0a 2020 2020  rce=source,.    
-0002b3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027890: 2831 2c20 4661 6c73 652c 205f 5345 5256  (1, False, _SERV
+000278a0: 4943 455f 4c41 554e 4348 494e 475f 5354  ICE_LAUNCHING_ST
+000278b0: 4154 5553 5f52 4547 4558 292c 0a20 2020  ATUS_REGEX),.   
+000278c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000278d0: 2020 2020 2832 2c20 4661 6c73 652c 2027      (2, False, '
+000278e0: 5245 4144 5927 295d 292c 0a20 2020 2020  READY')]),.     
+000278f0: 2020 2020 2020 202a 7570 6461 7465 5f63         *update_c
+00027900: 6865 636b 2c0a 2020 2020 2020 2020 2020  heck,.          
+00027910: 2020 5f53 4552 5645 5f57 4149 545f 554e    _SERVE_WAIT_UN
+00027920: 5449 4c5f 5245 4144 592e 666f 726d 6174  TIL_READY.format
+00027930: 286e 616d 653d 6e61 6d65 2c20 7265 706c  (name=name, repl
+00027940: 6963 615f 6e75 6d3d 3529 2c0a 2020 2020  ica_num=5),.    
+00027950: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
+00027960: 455f 454e 4450 4f49 4e54 5f57 4149 542e  E_ENDPOINT_WAIT.
+00027970: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00027980: 297d 3b20 270a 2020 2020 2020 2020 2020  )}; '.          
+00027990: 2020 2763 7572 6c20 6874 7470 3a2f 2f24    'curl http://$
+000279a0: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
+000279b0: 2248 692c 2053 6b79 5069 6c6f 7420 6865  "Hi, SkyPilot he
+000279c0: 7265 2227 2c0a 2020 2020 2020 2020 2020  re"',.          
+000279d0: 2020 5f63 6865 636b 5f72 6570 6c69 6361    _check_replica
+000279e0: 5f69 6e5f 7374 6174 7573 286e 616d 652c  _in_status(name,
+000279f0: 205b 2834 2c20 5472 7565 2c20 2752 4541   [(4, True, 'REA
+00027a00: 4459 2729 2c0a 2020 2020 2020 2020 2020  DY'),.          
+00027a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027a30: 2020 2831 2c20 4661 6c73 652c 2027 5245    (1, False, 'RE
+00027a40: 4144 5927 295d 292c 0a20 2020 2020 2020  ADY')]),.       
+00027a50: 205d 2c0a 2020 2020 2020 2020 5f54 4541   ],.        _TEA
+00027a60: 5244 4f57 4e5f 5345 5256 4943 452e 666f  RDOWN_SERVICE.fo
+00027a70: 726d 6174 286e 616d 653d 6e61 6d65 292c  rmat(name=name),
+00027a80: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+00027a90: 3d32 3020 2a20 3630 2c0a 2020 2020 290a  =20 * 60,.    ).
+00027aa0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00027ab0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00027ac0: 2e6d 6172 6b2e 7365 7276 650a 6465 6620  .mark.serve.def 
+00027ad0: 7465 7374 5f73 6b79 7365 7276 655f 6661  test_skyserve_fa
+00027ae0: 696c 7572 6573 2867 656e 6572 6963 5f63  ilures(generic_c
+00027af0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+00027b00: 2222 2254 6573 7420 7265 706c 6963 6120  """Test replica 
+00027b10: 6661 696c 7572 6520 7374 6174 7573 6573  failure statuses
+00027b20: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
+00027b30: 6765 745f 7365 7276 6963 655f 6e61 6d65  get_service_name
+00027b40: 2829 0a0a 2020 2020 7465 7374 203d 2054  ()..    test = T
+00027b50: 6573 7428 0a20 2020 2020 2020 2027 7465  est(.        'te
+00027b60: 7374 2d73 6b79 7365 7276 652d 6661 696c  st-skyserve-fail
+00027b70: 7572 6573 272c 0a20 2020 2020 2020 205b  ures',.        [
+00027b80: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00027b90: 6b79 2073 6572 7665 2075 7020 2d6e 207b  ky serve up -n {
+00027ba0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+00027bb0: 656e 6572 6963 5f63 6c6f 7564 7d20 2d79  eneric_cloud} -y
+00027bc0: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
+00027bd0: 6661 696c 7572 6573 2f69 6e69 7469 616c  failures/initial
+00027be0: 5f64 656c 6179 2e79 616d 6c27 2c0a 2020  _delay.yaml',.  
+00027bf0: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+00027c00: 736b 7920 7365 7276 6520 7374 6174 7573  sky serve status
+00027c10: 207b 6e61 6d65 7d29 3b20 270a 2020 2020   {name}); '.    
+00027c20: 2020 2020 2020 2020 6627 756e 7469 6c20          f'until 
+00027c30: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+00027c40: 2022 4641 494c 4544 5f49 4e49 5449 414c   "FAILED_INITIAL
+00027c50: 5f44 454c 4159 223b 2064 6f20 270a 2020  _DELAY"; do '.  
+00027c60: 2020 2020 2020 2020 2020 2765 6368 6f20            'echo 
+00027c70: 2257 6169 7469 6e67 2066 6f72 2072 6570  "Waiting for rep
+00027c80: 6c69 6361 2074 6f20 6265 2066 6169 6c65  lica to be faile
+00027c90: 642e 2e2e 223b 2073 6c65 6570 2035 3b20  d..."; sleep 5; 
+00027ca0: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+00027cb0: 733d 2428 736b 7920 7365 7276 6520 7374  s=$(sky serve st
+00027cc0: 6174 7573 207b 6e61 6d65 7d29 3b20 6563  atus {name}); ec
+00027cd0: 686f 2022 2473 223b 2064 6f6e 653b 272c  ho "$s"; done;',
+00027ce0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+00027cf0: 6565 7020 3630 272c 0a20 2020 2020 2020  eep 60',.       
+00027d00: 2020 2020 2066 277b 5f53 4552 5645 5f53       f'{_SERVE_S
+00027d10: 5441 5455 535f 5741 4954 2e66 6f72 6d61  TATUS_WAIT.forma
+00027d20: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2065  t(name=name)}; e
+00027d30: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+00027d40: 227b 6e61 6d65 7d22 207c 2067 7265 7020  "{name}" | grep 
+00027d50: 2246 4149 4c45 445f 494e 4954 4941 4c5f  "FAILED_INITIAL_
+00027d60: 4445 4c41 5922 207c 2077 6320 2d6c 207c  DELAY" | wc -l |
+00027d70: 2067 7265 7020 323b 2027 0a20 2020 2020   grep 2; '.     
+00027d80: 2020 2020 2020 2023 204d 616b 6520 7375         # Make su
+00027d90: 7265 206e 6f20 6e65 7720 7265 706c 6963  re no new replic
+00027da0: 6173 2061 7265 2073 7461 7274 6564 2066  as are started f
+00027db0: 6f72 2065 6172 6c79 2066 6169 6c75 7265  or early failure
+00027dc0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00027dd0: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+00027de0: 202d 4120 3130 3020 2253 6572 7669 6365   -A 100 "Service
+00027df0: 2052 6570 6c69 6361 7322 207c 2067 7265   Replicas" | gre
+00027e00: 7020 227b 6e61 6d65 7d22 207c 2077 6320  p "{name}" | wc 
+00027e10: 2d6c 207c 2067 7265 7020 323b 272c 0a20  -l | grep 2;',. 
+00027e20: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00027e30: 2073 6572 7665 2075 7064 6174 6520 7b6e   serve update {n
+00027e40: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
+00027e50: 6e65 7269 635f 636c 6f75 647d 202d 7920  neric_cloud} -y 
+00027e60: 7465 7374 732f 736b 7973 6572 7665 2f66  tests/skyserve/f
+00027e70: 6169 6c75 7265 732f 7072 6f62 696e 672e  ailures/probing.
+00027e80: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00027e90: 2020 2066 2773 3d24 2873 6b79 2073 6572     f's=$(sky ser
+00027ea0: 7665 2073 7461 7475 7320 7b6e 616d 657d  ve status {name}
+00027eb0: 293b 2027 0a20 2020 2020 2020 2020 2020  ); '.           
+00027ec0: 2023 2057 6169 7420 666f 7220 7265 706c   # Wait for repl
+00027ed0: 6963 6120 746f 2062 6520 7265 6164 792e  ica to be ready.
+00027ee0: 0a20 2020 2020 2020 2020 2020 2066 2775  .            f'u
+00027ef0: 6e74 696c 2065 6368 6f20 2224 7322 207c  ntil echo "$s" |
+00027f00: 2067 7265 7020 2252 4541 4459 223b 2064   grep "READY"; d
+00027f10: 6f20 270a 2020 2020 2020 2020 2020 2020  o '.            
+00027f20: 2765 6368 6f20 2257 6169 7469 6e67 2066  'echo "Waiting f
+00027f30: 6f72 2072 6570 6c69 6361 2074 6f20 6265  or replica to be
+00027f40: 2066 6169 6c65 642e 2e2e 223b 2073 6c65   failed..."; sle
+00027f50: 6570 2035 3b20 270a 2020 2020 2020 2020  ep 5; '.        
+00027f60: 2020 2020 6627 733d 2428 736b 7920 7365      f's=$(sky se
+00027f70: 7276 6520 7374 6174 7573 207b 6e61 6d65  rve status {name
+00027f80: 7d29 3b20 6563 686f 2022 2473 223b 2064  }); echo "$s"; d
+00027f90: 6f6e 653b 272c 0a20 2020 2020 2020 2020  one;',.         
+00027fa0: 2020 2023 2057 6169 7420 666f 7220 7265     # Wait for re
+00027fb0: 706c 6963 6120 746f 2063 6861 6e67 6520  plica to change 
+00027fc0: 746f 2046 4149 4c45 445f 5052 4f42 494e  to FAILED_PROBIN
+00027fd0: 470a 2020 2020 2020 2020 2020 2020 6627  G.            f'
+00027fe0: 733d 2428 736b 7920 7365 7276 6520 7374  s=$(sky serve st
+00027ff0: 6174 7573 207b 6e61 6d65 7d29 3b20 270a  atus {name}); '.
+00028000: 2020 2020 2020 2020 2020 2020 6627 756e              f'un
+00028010: 7469 6c20 6563 686f 2022 2473 2220 7c20  til echo "$s" | 
+00028020: 6772 6570 2022 4641 494c 4544 5f50 524f  grep "FAILED_PRO
+00028030: 4249 4e47 223b 2064 6f20 270a 2020 2020  BING"; do '.    
+00028040: 2020 2020 2020 2020 2765 6368 6f20 2257          'echo "W
+00028050: 6169 7469 6e67 2066 6f72 2072 6570 6c69  aiting for repli
+00028060: 6361 2074 6f20 6265 2066 6169 6c65 642e  ca to be failed.
+00028070: 2e2e 223b 2073 6c65 6570 2035 3b20 270a  .."; sleep 5; '.
+00028080: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+00028090: 2428 736b 7920 7365 7276 6520 7374 6174  $(sky serve stat
+000280a0: 7573 207b 6e61 6d65 7d29 3b20 6563 686f  us {name}); echo
+000280b0: 2022 2473 223b 2064 6f6e 653b 2720 2b0a   "$s"; done;' +.
+000280c0: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
+000280d0: 636b 5f72 6570 6c69 6361 5f69 6e5f 7374  ck_replica_in_st
+000280e0: 6174 7573 280a 2020 2020 2020 2020 2020  atus(.          
+000280f0: 2020 2020 2020 6e61 6d65 2c20 5b28 312c        name, [(1,
+00028100: 2046 616c 7365 2c20 2746 4149 4c45 445f   False, 'FAILED_
+00028110: 5052 4f42 494e 4727 292c 0a20 2020 2020  PROBING'),.     
+00028120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028130: 2020 2831 2c20 4661 6c73 652c 205f 5345    (1, False, _SE
+00028140: 5256 4943 455f 4c41 554e 4348 494e 475f  RVICE_LAUNCHING_
+00028150: 5354 4154 5553 5f52 4547 4558 295d 292c  STATUS_REGEX)]),
+00028160: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+00028170: 4f44 4f28 7a68 7775 293a 2061 6464 2074  ODO(zhwu): add t
+00028180: 6573 7420 666f 7220 4641 494c 4544 5f50  est for FAILED_P
+00028190: 524f 5649 5349 4f4e 0a20 2020 2020 2020  ROVISION.       
+000281a0: 205d 2c0a 2020 2020 2020 2020 5f54 4541   ],.        _TEA
+000281b0: 5244 4f57 4e5f 5345 5256 4943 452e 666f  RDOWN_SERVICE.fo
+000281c0: 726d 6174 286e 616d 653d 6e61 6d65 292c  rmat(name=name),
+000281d0: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+000281e0: 3d32 3020 2a20 3630 2c0a 2020 2020 290a  =20 * 60,.    ).
+000281f0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00028200: 2874 6573 7429 0a0a 0a23 2054 4f44 4f28  (test)...# TODO(
+00028210: 5a69 6d69 6e67 2c20 5469 616e 293a 2041  Ziming, Tian): A
+00028220: 6464 2074 6573 7473 2066 6f72 2061 7574  dd tests for aut
+00028230: 6f73 6361 6c69 6e67 2e0a 0a0a 2320 2d2d  oscaling....# --
+00028240: 2d2d 2d2d 2d20 5465 7374 696e 6720 7573  ----- Testing us
+00028250: 6572 2072 6179 2063 6c75 7374 6572 202d  er ray cluster -
+00028260: 2d2d 2d2d 2d2d 2d0a 6465 6620 7465 7374  -------.def test
+00028270: 5f75 7365 725f 7261 795f 636c 7573 7465  _user_ray_cluste
+00028280: 7228 6765 6e65 7269 635f 636c 6f75 643a  r(generic_cloud:
+00028290: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
+000282a0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+000282b0: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+000282c0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+000282d0: 7573 6572 2d72 6179 2d63 6c75 7374 6572  user-ray-cluster
+000282e0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+000282f0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00028300: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+00028310: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
+00028320: 7269 635f 636c 6f75 647d 2022 7261 7920  ric_cloud} "ray 
+00028330: 7374 6172 7420 2d2d 6865 6164 2227 2c0a  start --head"',.
+00028340: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00028350: 7920 6578 6563 207b 6e61 6d65 7d20 2265  y exec {name} "e
+00028360: 6368 6f20 6869 2227 2c0a 2020 2020 2020  cho hi"',.      
+00028370: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00028380: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
+00028390: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+000283a0: 2066 2773 6b79 2073 7461 7475 7320 2d72   f'sky status -r
+000283b0: 207b 6e61 6d65 7d20 7c20 6772 6570 2055   {name} | grep U
+000283c0: 5027 2c0a 2020 2020 2020 2020 2020 2020  P',.            
+000283d0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+000283e0: 7d20 2265 6368 6f20 6279 6522 272c 0a20  } "echo bye"',. 
+000283f0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00028400: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
+00028410: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+00028420: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+00028430: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00028440: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
+00028450: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00028460: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2054 6573  ...# ------- Tes
+00028470: 7469 6e67 2074 6865 2063 6f72 6520 4150  ting the core AP
+00028480: 4920 2d2d 2d2d 2d2d 2d2d 0a23 204d 6f73  I --------.# Mos
+00028490: 7420 6f66 2074 6865 2063 6f72 6520 4150  t of the core AP
+000284a0: 4973 2068 6176 6520 6265 656e 2074 6573  Is have been tes
+000284b0: 7465 6420 696e 2074 6865 2043 4c49 2074  ted in the CLI t
+000284c0: 6573 7473 2e0a 2320 5468 6573 6520 7465  ests..# These te
+000284d0: 7374 7320 6172 6520 666f 7220 7465 7374  sts are for test
+000284e0: 696e 6720 7468 6520 7265 7475 726e 2076  ing the return v
+000284f0: 616c 7565 206f 6620 7468 6520 4150 4973  alue of the APIs
+00028500: 206e 6f74 2066 756c 6c79 2075 7365 6420   not fully used 
+00028510: 696e 2043 4c49 2e0a 0a0a 4070 7974 6573  in CLI....@pytes
+00028520: 742e 6d61 726b 2e67 6370 0a64 6566 2074  t.mark.gcp.def t
+00028530: 6573 745f 636f 7265 5f61 7069 5f73 6b79  est_core_api_sky
+00028540: 5f6c 6175 6e63 685f 6578 6563 2829 3a0a  _launch_exec():.
+00028550: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00028560: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00028570: 2020 2074 6173 6b20 3d20 736b 792e 5461     task = sky.Ta
+00028580: 736b 2872 756e 3d22 7768 6f61 6d69 2229  sk(run="whoami")
+00028590: 0a20 2020 2074 6173 6b2e 7365 745f 7265  .    task.set_re
+000285a0: 736f 7572 6365 7328 736b 792e 5265 736f  sources(sky.Reso
+000285b0: 7572 6365 7328 636c 6f75 643d 736b 792e  urces(cloud=sky.
+000285c0: 4743 5028 2929 290a 2020 2020 6a6f 625f  GCP())).    job_
+000285d0: 6964 2c20 6861 6e64 6c65 203d 2073 6b79  id, handle = sky
+000285e0: 2e6c 6175 6e63 6828 7461 736b 2c20 636c  .launch(task, cl
+000285f0: 7573 7465 725f 6e61 6d65 3d6e 616d 6529  uster_name=name)
+00028600: 0a20 2020 2061 7373 6572 7420 6a6f 625f  .    assert job_
+00028610: 6964 203d 3d20 310a 2020 2020 6173 7365  id == 1.    asse
+00028620: 7274 2068 616e 646c 6520 6973 206e 6f74  rt handle is not
+00028630: 204e 6f6e 650a 2020 2020 6173 7365 7274   None.    assert
+00028640: 2068 616e 646c 652e 636c 7573 7465 725f   handle.cluster_
+00028650: 6e61 6d65 203d 3d20 6e61 6d65 0a20 2020  name == name.   
+00028660: 2061 7373 6572 7420 6861 6e64 6c65 2e6c   assert handle.l
+00028670: 6175 6e63 6865 645f 7265 736f 7572 6365  aunched_resource
+00028680: 732e 636c 6f75 642e 6973 5f73 616d 655f  s.cloud.is_same_
+00028690: 636c 6f75 6428 736b 792e 4743 5028 2929  cloud(sky.GCP())
+000286a0: 0a20 2020 206a 6f62 5f69 645f 6578 6563  .    job_id_exec
+000286b0: 2c20 6861 6e64 6c65 5f65 7865 6320 3d20  , handle_exec = 
+000286c0: 736b 792e 6578 6563 2874 6173 6b2c 2063  sky.exec(task, c
+000286d0: 6c75 7374 6572 5f6e 616d 653d 6e61 6d65  luster_name=name
+000286e0: 290a 2020 2020 6173 7365 7274 206a 6f62  ).    assert job
+000286f0: 5f69 645f 6578 6563 203d 3d20 320a 2020  _id_exec == 2.  
+00028700: 2020 6173 7365 7274 2068 616e 646c 655f    assert handle_
+00028710: 6578 6563 2069 7320 6e6f 7420 4e6f 6e65  exec is not None
+00028720: 0a20 2020 2061 7373 6572 7420 6861 6e64  .    assert hand
+00028730: 6c65 5f65 7865 632e 636c 7573 7465 725f  le_exec.cluster_
+00028740: 6e61 6d65 203d 3d20 6e61 6d65 0a20 2020  name == name.   
+00028750: 2061 7373 6572 7420 6861 6e64 6c65 5f65   assert handle_e
+00028760: 7865 632e 6c61 756e 6368 6564 5f72 6573  xec.launched_res
+00028770: 6f75 7263 6573 2e63 6c6f 7564 2e69 735f  ources.cloud.is_
+00028780: 7361 6d65 5f63 6c6f 7564 2873 6b79 2e47  same_cloud(sky.G
+00028790: 4350 2829 290a 2020 2020 2320 466f 7220  CP()).    # For 
+000287a0: 6475 6d6d 7920 7461 736b 2028 692e 652e  dummy task (i.e.
+000287b0: 2074 6173 6b2e 7275 6e20 6973 204e 6f6e   task.run is Non
+000287c0: 6529 2c20 7468 6520 6a6f 6220 776f 6e27  e), the job won'
+000287d0: 7420 6265 2073 7562 6d69 7474 6564 2e0a  t be submitted..
+000287e0: 2020 2020 6475 6d6d 795f 7461 736b 203d      dummy_task =
+000287f0: 2073 6b79 2e54 6173 6b28 290a 2020 2020   sky.Task().    
+00028800: 6a6f 625f 6964 5f64 756d 6d79 2c20 5f20  job_id_dummy, _ 
+00028810: 3d20 736b 792e 6578 6563 2864 756d 6d79  = sky.exec(dummy
+00028820: 5f74 6173 6b2c 2063 6c75 7374 6572 5f6e  _task, cluster_n
+00028830: 616d 653d 6e61 6d65 290a 2020 2020 6173  ame=name).    as
+00028840: 7365 7274 206a 6f62 5f69 645f 6475 6d6d  sert job_id_dumm
+00028850: 7920 6973 204e 6f6e 650a 2020 2020 736b  y is None.    sk
+00028860: 792e 646f 776e 286e 616d 6529 0a0a 0a23  y.down(name)...#
+00028870: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374   ---------- Test
+00028880: 696e 6720 5374 6f72 6167 6520 2d2d 2d2d  ing Storage ----
+00028890: 2d2d 2d2d 2d2d 0a63 6c61 7373 2054 6573  ------.class Tes
+000288a0: 7453 746f 7261 6765 5769 7468 4372 6564  tStorageWithCred
+000288b0: 656e 7469 616c 733a 0a20 2020 2022 2222  entials:.    """
+000288c0: 5374 6f72 6167 6520 7465 7374 7320 7768  Storage tests wh
+000288d0: 6963 6820 7265 7175 6972 6520 6372 6564  ich require cred
+000288e0: 656e 7469 616c 7320 616e 6420 6e65 7477  entials and netw
+000288f0: 6f72 6b20 636f 6e6e 6563 7469 6f6e 2222  ork connection""
+00028900: 220a 0a20 2020 2041 5753 5f49 4e56 414c  "..    AWS_INVAL
+00028910: 4944 5f4e 414d 4553 203d 205b 0a20 2020  ID_NAMES = [.   
+00028920: 2020 2020 2027 6162 272c 2020 2320 6c65       'ab',  # le
+00028930: 7373 2074 6861 6e20 3320 6368 6172 6163  ss than 3 charac
+00028940: 7465 7273 0a20 2020 2020 2020 2027 6162  ters.        'ab
+00028950: 6364 6566 6768 696a 6b6c 6d6e 6f70 7172  cdefghijklmnopqr
+00028960: 7374 7576 7778 797a 6162 6364 6566 6768  stuvwxyzabcdefgh
+00028970: 696a 6b6c 6d6e 6f70 7172 7374 7576 7778  ijklmnopqrstuvwx
+00028980: 797a 6162 6364 6566 6768 696a 6b6c 6d6e  yzabcdefghijklmn
+00028990: 6f70 7172 7374 7576 7778 797a 3127 2c0a  opqrstuvwxyz1',.
+000289a0: 2020 2020 2020 2020 2320 6d6f 7265 2074          # more t
+000289b0: 6861 6e20 3633 2063 6861 7261 6374 6572  han 63 character
+000289c0: 730a 2020 2020 2020 2020 2741 6263 6465  s.        'Abcde
+000289d0: 6627 2c20 2023 2063 6f6e 7461 696e 7320  f',  # contains 
+000289e0: 616e 2075 7070 6572 6361 7365 206c 6574  an uppercase let
+000289f0: 7465 720a 2020 2020 2020 2020 2761 6263  ter.        'abc
+00028a00: 2064 6566 272c 2020 2320 636f 6e74 6169   def',  # contai
+00028a10: 6e73 2061 2073 7061 6365 0a20 2020 2020  ns a space.     
+00028a20: 2020 2027 6162 632e 2e64 6566 272c 2020     'abc..def',  
+00028a30: 2320 7477 6f20 6164 6a61 6365 6e74 2070  # two adjacent p
+00028a40: 6572 696f 6473 0a20 2020 2020 2020 2027  eriods.        '
+00028a50: 3139 322e 3136 382e 352e 3427 2c20 2023  192.168.5.4',  #
+00028a60: 2066 6f72 6d61 7474 6564 2061 7320 616e   formatted as an
+00028a70: 2049 5020 6164 6472 6573 730a 2020 2020   IP address.    
+00028a80: 2020 2020 2778 6e2d 2d62 7563 6b65 7427      'xn--bucket'
+00028a90: 2c20 2023 2073 7461 7274 7320 7769 7468  ,  # starts with
+00028aa0: 2027 786e 2d2d 2720 7072 6566 6978 0a20   'xn--' prefix. 
+00028ab0: 2020 2020 2020 2027 6275 636b 6574 2d73         'bucket-s
+00028ac0: 3361 6c69 6173 272c 2020 2320 656e 6473  3alias',  # ends
+00028ad0: 2077 6974 6820 272d 7333 616c 6961 7327   with '-s3alias'
+00028ae0: 2073 7566 6669 780a 2020 2020 2020 2020   suffix.        
+00028af0: 2762 7563 6b65 742d 2d6f 6c2d 7333 272c  'bucket--ol-s3',
+00028b00: 2020 2320 656e 6473 2077 6974 6820 272d    # ends with '-
+00028b10: 2d6f 6c2d 7333 2720 7375 6666 6978 0a20  -ol-s3' suffix. 
+00028b20: 2020 2020 2020 2027 2e61 6263 272c 2020         '.abc',  
+00028b30: 2320 7374 6172 7473 2077 6974 6820 6120  # starts with a 
+00028b40: 646f 740a 2020 2020 2020 2020 2761 6263  dot.        'abc
+00028b50: 2e27 2c20 2023 2065 6e64 7320 7769 7468  .',  # ends with
+00028b60: 2061 2064 6f74 0a20 2020 2020 2020 2027   a dot.        '
+00028b70: 2d61 6263 272c 2020 2320 7374 6172 7473  -abc',  # starts
+00028b80: 2077 6974 6820 6120 6879 7068 656e 0a20   with a hyphen. 
+00028b90: 2020 2020 2020 2027 6162 632d 272c 2020         'abc-',  
+00028ba0: 2320 656e 6473 2077 6974 6820 6120 6879  # ends with a hy
+00028bb0: 7068 656e 0a20 2020 205d 0a0a 2020 2020  phen.    ]..    
+00028bc0: 4743 535f 494e 5641 4c49 445f 4e41 4d45  GCS_INVALID_NAME
+00028bd0: 5320 3d20 5b0a 2020 2020 2020 2020 2761  S = [.        'a
+00028be0: 6227 2c20 2023 206c 6573 7320 7468 616e  b',  # less than
+00028bf0: 2033 2063 6861 7261 6374 6572 730a 2020   3 characters.  
+00028c00: 2020 2020 2020 2761 6263 6465 6667 6869        'abcdefghi
+00028c10: 6a6b 6c6d 6e6f 7071 7273 7475 7677 7879  jklmnopqrstuvwxy
+00028c20: 7a61 6263 6465 6667 6869 6a6b 6c6d 6e6f  zabcdefghijklmno
+00028c30: 7071 7273 7475 7677 7879 7a61 6263 6465  pqrstuvwxyzabcde
+00028c40: 6667 6869 6a6b 6c6d 6e6f 7071 7273 7475  fghijklmnopqrstu
+00028c50: 7677 7879 7a31 272c 0a20 2020 2020 2020  vwxyz1',.       
+00028c60: 2023 206d 6f72 6520 7468 616e 2036 3320   # more than 63 
+00028c70: 6368 6172 6163 7465 7273 2028 7769 7468  characters (with
+00028c80: 6f75 7420 646f 7473 290a 2020 2020 2020  out dots).      
+00028c90: 2020 2741 6263 6465 6627 2c20 2023 2063    'Abcdef',  # c
+00028ca0: 6f6e 7461 696e 7320 616e 2075 7070 6572  ontains an upper
+00028cb0: 6361 7365 206c 6574 7465 720a 2020 2020  case letter.    
+00028cc0: 2020 2020 2761 6263 2064 6566 272c 2020      'abc def',  
+00028cd0: 2320 636f 6e74 6169 6e73 2061 2073 7061  # contains a spa
+00028ce0: 6365 0a20 2020 2020 2020 2027 6162 632e  ce.        'abc.
+00028cf0: 2e64 6566 272c 2020 2320 7477 6f20 6164  .def',  # two ad
+00028d00: 6a61 6365 6e74 2070 6572 696f 6473 0a20  jacent periods. 
+00028d10: 2020 2020 2020 2027 6162 635f 2e64 6566         'abc_.def
+00028d20: 2e67 6869 2e6a 6b6c 6d6e 6f70 7172 7374  .ghi.jklmnopqrst
+00028d30: 7576 7778 797a 6162 6364 6566 6768 696a  uvwxyzabcdefghij
+00028d40: 6b6c 6d6e 6f70 7172 7374 7576 7778 797a  klmnopqrstuvwxyz
+00028d50: 6162 6364 6566 6768 696a 6b6c 6d6e 6f70  abcdefghijklmnop
+00028d60: 7172 7374 7576 7778 797a 3127 0a20 2020  qrstuvwxyz1'.   
+00028d70: 2020 2020 2023 204d 6f72 6520 7468 616e       # More than
+00028d80: 2036 3320 6368 6172 6163 7465 7273 2062   63 characters b
+00028d90: 6574 7765 656e 2064 6f74 730a 2020 2020  etween dots.    
+00028da0: 2020 2020 2761 6263 5f2e 6465 662e 6768      'abc_.def.gh
+00028db0: 692e 6a6b 6c6d 6e6f 7071 7273 7475 7677  i.jklmnopqrstuvw
+00028dc0: 7879 7a61 6263 6465 6667 6869 6a6b 6c6d  xyzabcdefghijklm
+00028dd0: 6e6f 7071 6667 6869 6a6b 6c6d 6e6f 7071  nopqfghijklmnopq
+00028de0: 7273 7475 7677 2720 2a20 352c 0a20 2020  rstuvw' * 5,.   
+00028df0: 2020 2020 2023 206d 6f72 6520 7468 616e       # more than
+00028e00: 2032 3232 2063 6861 7261 6374 6572 7320   222 characters 
+00028e10: 2877 6974 6820 646f 7473 290a 2020 2020  (with dots).    
+00028e20: 2020 2020 2731 3932 2e31 3638 2e35 2e34      '192.168.5.4
+00028e30: 272c 2020 2320 666f 726d 6174 7465 6420  ',  # formatted 
+00028e40: 6173 2061 6e20 4950 2061 6464 7265 7373  as an IP address
+00028e50: 0a20 2020 2020 2020 2027 676f 6f67 6275  .        'googbu
+00028e60: 636b 6574 272c 2020 2320 7374 6172 7473  cket',  # starts
+00028e70: 2077 6974 6820 2767 6f6f 6727 2070 7265   with 'goog' pre
+00028e80: 6669 780a 2020 2020 2020 2020 2767 6f6f  fix.        'goo
+00028e90: 676c 6562 7563 6b65 7427 2c20 2023 2063  glebucket',  # c
+00028ea0: 6f6e 7461 696e 7320 2767 6f6f 676c 6527  ontains 'google'
+00028eb0: 0a20 2020 2020 2020 2027 6730 3067 6c65  .        'g00gle
+00028ec0: 6275 636b 6574 272c 2020 2320 7661 7269  bucket',  # vari
+00028ed0: 616e 7420 6f66 2027 676f 6f67 6c65 270a  ant of 'google'.
+00028ee0: 2020 2020 2020 2020 2767 6f30 676c 6562          'go0gleb
+00028ef0: 7563 6b65 7427 2c20 2023 2076 6172 6961  ucket',  # varia
+00028f00: 6e74 206f 6620 2767 6f6f 676c 6527 0a20  nt of 'google'. 
+00028f10: 2020 2020 2020 2027 6730 6f67 6c65 6275         'g0oglebu
+00028f20: 636b 6574 272c 2020 2320 7661 7269 616e  cket',  # varian
+00028f30: 7420 6f66 2027 676f 6f67 6c65 270a 2020  t of 'google'.  
+00028f40: 2020 2020 2020 272e 6162 6327 2c20 2023        '.abc',  #
+00028f50: 2073 7461 7274 7320 7769 7468 2061 2064   starts with a d
+00028f60: 6f74 0a20 2020 2020 2020 2027 6162 632e  ot.        'abc.
+00028f70: 272c 2020 2320 656e 6473 2077 6974 6820  ',  # ends with 
+00028f80: 6120 646f 740a 2020 2020 2020 2020 275f  a dot.        '_
+00028f90: 6162 6327 2c20 2023 2073 7461 7274 7320  abc',  # starts 
+00028fa0: 7769 7468 2061 6e20 756e 6465 7273 636f  with an undersco
+00028fb0: 7265 0a20 2020 2020 2020 2027 6162 635f  re.        'abc_
+00028fc0: 272c 2020 2320 656e 6473 2077 6974 6820  ',  # ends with 
+00028fd0: 616e 2075 6e64 6572 7363 6f72 650a 2020  an underscore.  
+00028fe0: 2020 5d0a 0a20 2020 2049 424d 5f49 4e56    ]..    IBM_INV
+00028ff0: 414c 4944 5f4e 414d 4553 203d 205b 0a20  ALID_NAMES = [. 
+00029000: 2020 2020 2020 2027 6162 272c 2020 2320         'ab',  # 
+00029010: 6c65 7373 2074 6861 6e20 3320 6368 6172  less than 3 char
+00029020: 6163 7465 7273 0a20 2020 2020 2020 2027  acters.        '
+00029030: 6162 6364 6566 6768 696a 6b6c 6d6e 6f70  abcdefghijklmnop
+00029040: 7172 7374 7576 7778 797a 6162 6364 6566  qrstuvwxyzabcdef
+00029050: 6768 696a 6b6c 6d6e 6f70 7172 7374 7576  ghijklmnopqrstuv
+00029060: 7778 797a 6162 6364 6566 6768 696a 6b6c  wxyzabcdefghijkl
+00029070: 6d6e 6f70 7172 7374 7576 7778 797a 3127  mnopqrstuvwxyz1'
+00029080: 2c0a 2020 2020 2020 2020 2320 6d6f 7265  ,.        # more
+00029090: 2074 6861 6e20 3633 2063 6861 7261 6374   than 63 charact
+000290a0: 6572 730a 2020 2020 2020 2020 2741 6263  ers.        'Abc
+000290b0: 6465 6627 2c20 2023 2063 6f6e 7461 696e  def',  # contain
+000290c0: 7320 616e 2075 7070 6572 6361 7365 206c  s an uppercase l
+000290d0: 6574 7465 720a 2020 2020 2020 2020 2761  etter.        'a
+000290e0: 6263 2064 6566 272c 2020 2320 636f 6e74  bc def',  # cont
+000290f0: 6169 6e73 2061 2073 7061 6365 0a20 2020  ains a space.   
+00029100: 2020 2020 2027 6162 632e 2e64 6566 272c       'abc..def',
+00029110: 2020 2320 7477 6f20 6164 6a61 6365 6e74    # two adjacent
+00029120: 2070 6572 696f 6473 0a20 2020 2020 2020   periods.       
+00029130: 2027 3139 322e 3136 382e 352e 3427 2c20   '192.168.5.4', 
+00029140: 2023 2066 6f72 6d61 7474 6564 2061 7320   # formatted as 
+00029150: 616e 2049 5020 6164 6472 6573 730a 2020  an IP address.  
+00029160: 2020 2020 2020 2778 6e2d 2d62 7563 6b65        'xn--bucke
+00029170: 7427 2c20 2023 2073 7461 7274 7320 7769  t',  # starts wi
+00029180: 7468 2027 786e 2d2d 2720 7072 6566 6978  th 'xn--' prefix
+00029190: 0a20 2020 2020 2020 2027 2e61 6263 272c  .        '.abc',
+000291a0: 2020 2320 7374 6172 7473 2077 6974 6820    # starts with 
+000291b0: 6120 646f 740a 2020 2020 2020 2020 2761  a dot.        'a
+000291c0: 6263 2e27 2c20 2023 2065 6e64 7320 7769  bc.',  # ends wi
+000291d0: 7468 2061 2064 6f74 0a20 2020 2020 2020  th a dot.       
+000291e0: 2027 2d61 6263 272c 2020 2320 7374 6172   '-abc',  # star
+000291f0: 7473 2077 6974 6820 6120 6879 7068 656e  ts with a hyphen
+00029200: 0a20 2020 2020 2020 2027 6162 632d 272c  .        'abc-',
+00029210: 2020 2320 656e 6473 2077 6974 6820 6120    # ends with a 
+00029220: 6879 7068 656e 0a20 2020 2020 2020 2027  hyphen.        '
+00029230: 612e 2d62 6327 2c20 2023 2063 6f6e 7461  a.-bc',  # conta
+00029240: 696e 7320 7468 6520 7365 7175 656e 6365  ins the sequence
+00029250: 2027 2e2d 270a 2020 2020 2020 2020 2761   '.-'.        'a
+00029260: 2d2e 6263 272c 2020 2320 636f 6e74 6169  -.bc',  # contai
+00029270: 6e73 2074 6865 2073 6571 7565 6e63 6520  ns the sequence 
+00029280: 272d 2e27 0a20 2020 2020 2020 2027 6126  '-.'.        'a&
+00029290: 6263 2720 2023 2063 6f6e 7461 696e 7320  bc'  # contains 
+000292a0: 7370 6563 6961 6c20 6368 6172 6163 7465  special characte
+000292b0: 7273 0a20 2020 2020 2020 2027 6162 5e63  rs.        'ab^c
+000292c0: 2720 2023 2063 6f6e 7461 696e 7320 7370  '  # contains sp
+000292d0: 6563 6961 6c20 6368 6172 6163 7465 7273  ecial characters
+000292e0: 0a20 2020 205d 0a20 2020 2047 4954 4947  .    ].    GITIG
+000292f0: 4e4f 5245 5f53 594e 435f 5445 5354 5f44  NORE_SYNC_TEST_D
+00029300: 4952 5f53 5452 5543 5455 5245 203d 207b  IR_STRUCTURE = {
+00029310: 0a20 2020 2020 2020 2027 646f 7562 6c65  .        'double
+00029320: 5f61 7374 6572 6973 6b27 3a20 7b0a 2020  _asterisk': {.  
+00029330: 2020 2020 2020 2020 2020 2764 6f75 626c            'doubl
+00029340: 655f 6173 7465 7269 736b 5f65 7863 6c75  e_asterisk_exclu
+00029350: 6465 6427 3a20 4e6f 6e65 2c0a 2020 2020  ded': None,.    
+00029360: 2020 2020 2020 2020 2764 6f75 626c 655f          'double_
+00029370: 6173 7465 7269 736b 5f65 7863 6c75 6465  asterisk_exclude
+00029380: 645f 6469 7227 3a20 7b0a 2020 2020 2020  d_dir': {.      
+00029390: 2020 2020 2020 2020 2020 2764 6972 5f65            'dir_e
+000293a0: 7863 6c75 6465 6427 3a20 4e6f 6e65 2c0a  xcluded': None,.
+000293b0: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
+000293c0: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+000293d0: 2020 2764 6f75 626c 655f 6173 7465 7269    'double_asteri
+000293e0: 736b 5f70 6172 656e 7427 3a20 7b0a 2020  sk_parent': {.  
+000293f0: 2020 2020 2020 2020 2020 2770 6172 656e            'paren
+00029400: 7427 3a20 7b0a 2020 2020 2020 2020 2020  t': {.          
+00029410: 2020 2020 2020 2761 6c73 6f5f 6578 636c        'also_excl
+00029420: 7564 6564 2e74 7874 273a 204e 6f6e 652c  uded.txt': None,
+00029430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029440: 2027 6368 696c 6427 3a20 7b0a 2020 2020   'child': {.    
+00029450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029460: 2764 6f75 626c 655f 6173 7465 7269 736b  'double_asterisk
+00029470: 5f70 6172 656e 745f 6368 696c 645f 6578  _parent_child_ex
+00029480: 636c 7564 6564 2e74 7874 273a 204e 6f6e  cluded.txt': Non
+00029490: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+000294a0: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
+000294b0: 2020 2020 2020 2764 6f75 626c 655f 6173        'double_as
+000294c0: 7465 7269 736b 5f70 6172 656e 745f 6578  terisk_parent_ex
+000294d0: 636c 7564 6564 2e74 7874 273a 204e 6f6e  cluded.txt': Non
+000294e0: 652c 0a20 2020 2020 2020 2020 2020 207d  e,.            }
+000294f0: 2c0a 2020 2020 2020 2020 7d2c 0a20 2020  ,.        },.   
+00029500: 2020 2020 2027 6578 636c 7564 6564 2e6c       'excluded.l
+00029510: 6f67 273a 204e 6f6e 652c 0a20 2020 2020  og': None,.     
+00029520: 2020 2027 6578 636c 7564 6564 5f64 6972     'excluded_dir
+00029530: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+00029540: 2027 6578 636c 7564 6564 2e74 7874 273a   'excluded.txt':
+00029550: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+00029560: 2020 2027 6e65 7374 6564 5f65 7863 6c75     'nested_exclu
+00029570: 6465 6427 3a20 7b0a 2020 2020 2020 2020  ded': {.        
+00029580: 2020 2020 2020 2020 2765 7863 6c75 6465          'exclude
+00029590: 6427 3a20 4e6f 6e65 2c0a 2020 2020 2020  d': None,.      
+000295a0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+000295b0: 207d 2c0a 2020 2020 2020 2020 2765 7870   },.        'exp
+000295c0: 2d31 273a 207b 0a20 2020 2020 2020 2020  -1': {.         
+000295d0: 2020 2027 6265 5f65 7863 6c75 6465 6427     'be_excluded'
+000295e0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+000295f0: 7d2c 0a20 2020 2020 2020 2027 6578 702d  },.        'exp-
+00029600: 3227 3a20 7b0a 2020 2020 2020 2020 2020  2': {.          
+00029610: 2020 2762 655f 6578 636c 7564 6564 273a    'be_excluded':
+00029620: 204e 6f6e 652c 0a20 2020 2020 2020 207d   None,.        }
+00029630: 2c0a 2020 2020 2020 2020 2766 726f 6e74  ,.        'front
+00029640: 5f73 6c61 7368 5f65 7863 6c75 6465 6427  _slash_excluded'
+00029650: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+00029660: 2769 6e63 6c75 6465 642e 6c6f 6727 3a20  'included.log': 
+00029670: 4e6f 6e65 2c0a 2020 2020 2020 2020 2769  None,.        'i
+00029680: 6e63 6c75 6465 642e 7478 7427 3a20 4e6f  ncluded.txt': No
+00029690: 6e65 2c0a 2020 2020 2020 2020 2769 6e63  ne,.        'inc
+000296a0: 6c75 6465 5f64 6972 273a 207b 0a20 2020  lude_dir': {.   
+000296b0: 2020 2020 2020 2020 2027 6578 636c 7564           'exclud
+000296c0: 6564 2e6c 6f67 273a 204e 6f6e 652c 0a20  ed.log': None,. 
+000296d0: 2020 2020 2020 2020 2020 2027 696e 636c             'incl
+000296e0: 7564 6564 2e6c 6f67 273a 204e 6f6e 652c  uded.log': None,
+000296f0: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
+00029700: 2020 2020 276e 6573 7465 645f 646f 7562      'nested_doub
+00029710: 6c65 5f61 7374 6572 6973 6b27 3a20 7b0a  le_asterisk': {.
+00029720: 2020 2020 2020 2020 2020 2020 276f 6e65              'one
+00029730: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+00029740: 2020 2020 2027 616c 736f 5f65 7863 6c75       'also_exclu
+00029750: 6465 2e74 7874 273a 204e 6f6e 652c 0a20  de.txt': None,. 
+00029760: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
+00029770: 2020 2020 2020 2020 2020 2774 776f 273a            'two':
+00029780: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00029790: 2020 2027 616c 736f 5f65 7863 6c75 6465     'also_exclude
+000297a0: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
+000297b0: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
+000297c0: 2020 2020 7d2c 0a20 2020 2020 2020 2027      },.        '
+000297d0: 6e65 7374 6564 5f77 696c 6463 6172 645f  nested_wildcard_
+000297e0: 6469 7227 3a20 7b0a 2020 2020 2020 2020  dir': {.        
+000297f0: 2020 2020 276d 6f6e 6461 7927 3a20 7b0a      'monday': {.
+00029800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029810: 2761 6c73 6f5f 6578 636c 7564 652e 7478  'also_exclude.tx
+00029820: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
+00029830: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+00029840: 2020 2020 2027 7475 6573 6461 7927 3a20       'tuesday': 
+00029850: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00029860: 2020 2761 6c73 6f5f 6578 636c 7564 652e    'also_exclude.
+00029870: 7478 7427 3a20 4e6f 6e65 2c0a 2020 2020  txt': None,.    
+00029880: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+00029890: 2020 207d 2c0a 2020 2020 2020 2020 276e     },.        'n
+000298a0: 6f5f 736c 6173 685f 6578 636c 7564 6564  o_slash_excluded
+000298b0: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
+000298c0: 2027 6e6f 5f73 6c61 7368 5f74 6573 7473   'no_slash_tests
+000298d0: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+000298e0: 2027 6e6f 5f73 6c61 7368 5f65 7863 6c75   'no_slash_exclu
+000298f0: 6465 6427 3a20 7b0a 2020 2020 2020 2020  ded': {.        
+00029900: 2020 2020 2020 2020 2761 6c73 6f5f 6578          'also_ex
+00029910: 636c 7564 6564 2e74 7874 273a 204e 6f6e  cluded.txt': Non
+00029920: 652c 0a20 2020 2020 2020 2020 2020 207d  e,.            }
+00029930: 2c0a 2020 2020 2020 2020 7d2c 0a20 2020  ,.        },.   
+00029940: 2020 2020 2027 7175 6573 7469 6f6e 5f6d       'question_m
+00029950: 6172 6b27 3a20 7b0a 2020 2020 2020 2020  ark': {.        
+00029960: 2020 2020 2765 7863 6c75 6465 6431 2e74      'excluded1.t
+00029970: 7874 273a 204e 6f6e 652c 0a20 2020 2020  xt': None,.     
+00029980: 2020 2020 2020 2027 6578 636c 7564 6564         'excluded
+00029990: 402e 7478 7427 3a20 4e6f 6e65 2c0a 2020  @.txt': None,.  
+000299a0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+000299b0: 2027 7371 7561 7265 5f62 7261 636b 6574   'square_bracket
+000299c0: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+000299d0: 2027 6578 636c 7564 6564 312e 7478 7427   'excluded1.txt'
+000299e0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+000299f0: 7d2c 0a20 2020 2020 2020 2027 7371 7561  },.        'squa
+00029a00: 7265 5f62 7261 636b 6574 5f61 6c70 6861  re_bracket_alpha
+00029a10: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+00029a20: 2027 6578 636c 7564 6564 7a2e 7478 7427   'excludedz.txt'
+00029a30: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+00029a40: 7d2c 0a20 2020 2020 2020 2027 7371 7561  },.        'squa
+00029a50: 7265 5f62 7261 636b 6574 5f65 7863 6c61  re_bracket_excla
+00029a60: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+00029a70: 2027 6578 636c 7564 6564 322e 7478 7427   'excluded2.txt'
+00029a80: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+00029a90: 2020 2020 2765 7863 6c75 6465 6440 2e74      'excluded@.t
+00029aa0: 7874 273a 204e 6f6e 652c 0a20 2020 2020  xt': None,.     
+00029ab0: 2020 207d 2c0a 2020 2020 2020 2020 2773     },.        's
+00029ac0: 7175 6172 655f 6272 6163 6b65 745f 7369  quare_bracket_si
+00029ad0: 6e67 6c65 273a 207b 0a20 2020 2020 2020  ngle': {.       
+00029ae0: 2020 2020 2027 6578 636c 7564 6564 302e       'excluded0.
+00029af0: 7478 7427 3a20 4e6f 6e65 2c0a 2020 2020  txt': None,.    
+00029b00: 2020 2020 7d2c 0a20 2020 207d 0a0a 2020      },.    }..  
+00029b10: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
+00029b20: 2020 2020 6465 6620 6372 6561 7465 5f64      def create_d
+00029b30: 6972 5f73 7472 7563 7475 7265 2862 6173  ir_structure(bas
+00029b40: 655f 7061 7468 2c20 7374 7275 6374 7572  e_path, structur
+00029b50: 6529 3a0a 2020 2020 2020 2020 2320 6372  e):.        # cr
+00029b60: 6561 7465 7320 6120 6769 7665 6e20 6669  eates a given fi
+00029b70: 6c65 2053 5452 5543 5455 5245 2069 6e20  le STRUCTURE in 
+00029b80: 4241 5345 5f50 4154 480a 2020 2020 2020  BASE_PATH.      
+00029b90: 2020 666f 7220 6e61 6d65 2c20 7375 6273    for name, subs
+00029ba0: 7472 7563 7475 7265 2069 6e20 7374 7275  tructure in stru
+00029bb0: 6374 7572 652e 6974 656d 7328 293a 0a20  cture.items():. 
+00029bc0: 2020 2020 2020 2020 2020 2070 6174 6820             path 
+00029bd0: 3d20 6f73 2e70 6174 682e 6a6f 696e 2862  = os.path.join(b
+00029be0: 6173 655f 7061 7468 2c20 6e61 6d65 290a  ase_path, name).
+00029bf0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00029c00: 7562 7374 7275 6374 7572 6520 6973 204e  ubstructure is N
+00029c10: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00029c20: 2020 2020 2023 2043 7265 6174 6520 6120       # Create a 
+00029c30: 6669 6c65 0a20 2020 2020 2020 2020 2020  file.           
+00029c40: 2020 2020 206f 7065 6e28 7061 7468 2c20       open(path, 
+00029c50: 2761 272c 2065 6e63 6f64 696e 673d 2775  'a', encoding='u
+00029c60: 7466 2d38 2729 2e63 6c6f 7365 2829 0a20  tf-8').close(). 
+00029c70: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00029c80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029c90: 2023 2043 7265 6174 6520 6120 7375 6264   # Create a subd
+00029ca0: 6972 6563 746f 7279 0a20 2020 2020 2020  irectory.       
+00029cb0: 2020 2020 2020 2020 206f 732e 6d6b 6469           os.mkdi
+00029cc0: 7228 7061 7468 290a 2020 2020 2020 2020  r(path).        
+00029cd0: 2020 2020 2020 2020 5465 7374 5374 6f72          TestStor
+00029ce0: 6167 6557 6974 6843 7265 6465 6e74 6961  ageWithCredentia
+00029cf0: 6c73 2e63 7265 6174 655f 6469 725f 7374  ls.create_dir_st
+00029d00: 7275 6374 7572 6528 0a20 2020 2020 2020  ructure(.       
+00029d10: 2020 2020 2020 2020 2020 2020 2070 6174               pat
+00029d20: 682c 2073 7562 7374 7275 6374 7572 6529  h, substructure)
+00029d30: 0a0a 2020 2020 4073 7461 7469 636d 6574  ..    @staticmet
+00029d40: 686f 640a 2020 2020 6465 6620 636c 695f  hod.    def cli_
+00029d50: 6465 6c65 7465 5f63 6d64 2873 746f 7265  delete_cmd(store
+00029d60: 5f74 7970 652c 2062 7563 6b65 745f 6e61  _type, bucket_na
+00029d70: 6d65 293a 0a20 2020 2020 2020 2069 6620  me):.        if 
+00029d80: 7374 6f72 655f 7479 7065 203d 3d20 7374  store_type == st
+00029d90: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+00029da0: 7970 652e 5333 3a0a 2020 2020 2020 2020  ype.S3:.        
+00029db0: 2020 2020 7572 6c20 3d20 6627 7333 3a2f      url = f's3:/
+00029dc0: 2f7b 6275 636b 6574 5f6e 616d 657d 270a  /{bucket_name}'.
+00029dd0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00029de0: 726e 2066 2761 7773 2073 3320 7262 207b  rn f'aws s3 rb {
+00029df0: 7572 6c7d 202d 2d66 6f72 6365 270a 2020  url} --force'.  
+00029e00: 2020 2020 2020 6966 2073 746f 7265 5f74        if store_t
+00029e10: 7970 6520 3d3d 2073 746f 7261 6765 5f6c  ype == storage_l
+00029e20: 6962 2e53 746f 7265 5479 7065 2e47 4353  ib.StoreType.GCS
+00029e30: 3a0a 2020 2020 2020 2020 2020 2020 7572  :.            ur
+00029e40: 6c20 3d20 6627 6773 3a2f 2f7b 6275 636b  l = f'gs://{buck
+00029e50: 6574 5f6e 616d 657d 270a 2020 2020 2020  et_name}'.      
+00029e60: 2020 2020 2020 6773 7574 696c 5f61 6c69        gsutil_ali
+00029e70: 6173 2c20 616c 6961 735f 6765 6e20 3d20  as, alias_gen = 
+00029e80: 6461 7461 5f75 7469 6c73 2e67 6574 5f67  data_utils.get_g
+00029e90: 7375 7469 6c5f 636f 6d6d 616e 6428 290a  sutil_command().
+00029ea0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00029eb0: 726e 2066 277b 616c 6961 735f 6765 6e7d  rn f'{alias_gen}
+00029ec0: 3b20 7b67 7375 7469 6c5f 616c 6961 737d  ; {gsutil_alias}
+00029ed0: 2072 6d20 2d72 207b 7572 6c7d 270a 2020   rm -r {url}'.  
+00029ee0: 2020 2020 2020 6966 2073 746f 7265 5f74        if store_t
+00029ef0: 7970 6520 3d3d 2073 746f 7261 6765 5f6c  ype == storage_l
+00029f00: 6962 2e53 746f 7265 5479 7065 2e52 323a  ib.StoreType.R2:
+00029f10: 0a20 2020 2020 2020 2020 2020 2065 6e64  .            end
+00029f20: 706f 696e 745f 7572 6c20 3d20 636c 6f75  point_url = clou
+00029f30: 6466 6c61 7265 2e63 7265 6174 655f 656e  dflare.create_en
+00029f40: 6470 6f69 6e74 2829 0a20 2020 2020 2020  dpoint().       
+00029f50: 2020 2020 2075 726c 203d 2066 2773 333a       url = f's3:
+00029f60: 2f2f 7b62 7563 6b65 745f 6e61 6d65 7d27  //{bucket_name}'
+00029f70: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00029f80: 7572 6e20 6627 4157 535f 5348 4152 4544  urn f'AWS_SHARED
+00029f90: 5f43 5245 4445 4e54 4941 4c53 5f46 494c  _CREDENTIALS_FIL
+00029fa0: 453d 7b63 6c6f 7564 666c 6172 652e 5232  E={cloudflare.R2
+00029fb0: 5f43 5245 4445 4e54 4941 4c53 5f50 4154  _CREDENTIALS_PAT
+00029fc0: 487d 2061 7773 2073 3320 7262 207b 7572  H} aws s3 rb {ur
+00029fd0: 6c7d 202d 2d66 6f72 6365 202d 2d65 6e64  l} --force --end
+00029fe0: 706f 696e 7420 7b65 6e64 706f 696e 745f  point {endpoint_
+00029ff0: 7572 6c7d 202d 2d70 726f 6669 6c65 3d72  url} --profile=r
+0002a000: 3227 0a20 2020 2020 2020 2069 6620 7374  2'.        if st
+0002a010: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
+0002a020: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0002a030: 652e 4942 4d3a 0a20 2020 2020 2020 2020  e.IBM:.         
+0002a040: 2020 2062 7563 6b65 745f 7263 6c6f 6e65     bucket_rclone
+0002a050: 5f70 726f 6669 6c65 203d 2052 636c 6f6e  _profile = Rclon
+0002a060: 652e 6765 6e65 7261 7465 5f72 636c 6f6e  e.generate_rclon
+0002a070: 655f 6275 636b 6574 5f70 726f 6669 6c65  e_bucket_profile
+0002a080: 5f6e 616d 6528 0a20 2020 2020 2020 2020  _name(.         
+0002a090: 2020 2020 2020 2062 7563 6b65 745f 6e61         bucket_na
+0002a0a0: 6d65 2c20 5263 6c6f 6e65 2e52 636c 6f6e  me, Rclone.Rclon
+0002a0b0: 6543 6c6f 7564 732e 4942 4d29 0a20 2020  eClouds.IBM).   
+0002a0c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0002a0d0: 6627 7263 6c6f 6e65 2070 7572 6765 207b  f'rclone purge {
+0002a0e0: 6275 636b 6574 5f72 636c 6f6e 655f 7072  bucket_rclone_pr
+0002a0f0: 6f66 696c 657d 3a7b 6275 636b 6574 5f6e  ofile}:{bucket_n
+0002a100: 616d 657d 2026 2620 7263 6c6f 6e65 2063  ame} && rclone c
+0002a110: 6f6e 6669 6720 6465 6c65 7465 207b 6275  onfig delete {bu
+0002a120: 636b 6574 5f72 636c 6f6e 655f 7072 6f66  cket_rclone_prof
+0002a130: 696c 657d 270a 0a20 2020 2040 7374 6174  ile}'..    @stat
+0002a140: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
+0002a150: 2063 6c69 5f6c 735f 636d 6428 7374 6f72   cli_ls_cmd(stor
+0002a160: 655f 7479 7065 2c20 6275 636b 6574 5f6e  e_type, bucket_n
+0002a170: 616d 652c 2073 7566 6669 783d 2727 293a  ame, suffix=''):
+0002a180: 0a20 2020 2020 2020 2069 6620 7374 6f72  .        if stor
+0002a190: 655f 7479 7065 203d 3d20 7374 6f72 6167  e_type == storag
+0002a1a0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0002a1b0: 5333 3a0a 2020 2020 2020 2020 2020 2020  S3:.            
+0002a1c0: 6966 2073 7566 6669 783a 0a20 2020 2020  if suffix:.     
+0002a1d0: 2020 2020 2020 2020 2020 2075 726c 203d             url =
+0002a1e0: 2066 2773 333a 2f2f 7b62 7563 6b65 745f   f's3://{bucket_
+0002a1f0: 6e61 6d65 7d2f 7b73 7566 6669 787d 270a  name}/{suffix}'.
+0002a200: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0002a210: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002a220: 2020 7572 6c20 3d20 6627 7333 3a2f 2f7b    url = f's3://{
+0002a230: 6275 636b 6574 5f6e 616d 657d 270a 2020  bucket_name}'.  
+0002a240: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0002a250: 2066 2761 7773 2073 3320 6c73 207b 7572   f'aws s3 ls {ur
+0002a260: 6c7d 270a 2020 2020 2020 2020 6966 2073  l}'.        if s
+0002a270: 746f 7265 5f74 7970 6520 3d3d 2073 746f  tore_type == sto
+0002a280: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0002a290: 7065 2e47 4353 3a0a 2020 2020 2020 2020  pe.GCS:.        
+0002a2a0: 2020 2020 6966 2073 7566 6669 783a 0a20      if suffix:. 
+0002a2b0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+0002a2c0: 726c 203d 2066 2767 733a 2f2f 7b62 7563  rl = f'gs://{buc
+0002a2d0: 6b65 745f 6e61 6d65 7d2f 7b73 7566 6669  ket_name}/{suffi
+0002a2e0: 787d 270a 2020 2020 2020 2020 2020 2020  x}'.            
+0002a2f0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0002a300: 2020 2020 2020 7572 6c20 3d20 6627 6773        url = f'gs
+0002a310: 3a2f 2f7b 6275 636b 6574 5f6e 616d 657d  ://{bucket_name}
+0002a320: 270a 2020 2020 2020 2020 2020 2020 7265  '.            re
+0002a330: 7475 726e 2066 2767 7375 7469 6c20 6c73  turn f'gsutil ls
+0002a340: 207b 7572 6c7d 270a 2020 2020 2020 2020   {url}'.        
+0002a350: 6966 2073 746f 7265 5f74 7970 6520 3d3d  if store_type ==
+0002a360: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+0002a370: 7265 5479 7065 2e52 323a 0a20 2020 2020  reType.R2:.     
+0002a380: 2020 2020 2020 2065 6e64 706f 696e 745f         endpoint_
+0002a390: 7572 6c20 3d20 636c 6f75 6466 6c61 7265  url = cloudflare
+0002a3a0: 2e63 7265 6174 655f 656e 6470 6f69 6e74  .create_endpoint
+0002a3b0: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
+0002a3c0: 6620 7375 6666 6978 3a0a 2020 2020 2020  f suffix:.      
+0002a3d0: 2020 2020 2020 2020 2020 7572 6c20 3d20            url = 
+0002a3e0: 6627 7333 3a2f 2f7b 6275 636b 6574 5f6e  f's3://{bucket_n
+0002a3f0: 616d 657d 2f7b 7375 6666 6978 7d27 0a20  ame}/{suffix}'. 
+0002a400: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0002a410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a420: 2075 726c 203d 2066 2773 333a 2f2f 7b62   url = f's3://{b
+0002a430: 7563 6b65 745f 6e61 6d65 7d27 0a20 2020  ucket_name}'.   
+0002a440: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0002a450: 6627 4157 535f 5348 4152 4544 5f43 5245  f'AWS_SHARED_CRE
+0002a460: 4445 4e54 4941 4c53 5f46 494c 453d 7b63  DENTIALS_FILE={c
+0002a470: 6c6f 7564 666c 6172 652e 5232 5f43 5245  loudflare.R2_CRE
+0002a480: 4445 4e54 4941 4c53 5f50 4154 487d 2061  DENTIALS_PATH} a
+0002a490: 7773 2073 3320 6c73 207b 7572 6c7d 202d  ws s3 ls {url} -
+0002a4a0: 2d65 6e64 706f 696e 7420 7b65 6e64 706f  -endpoint {endpo
+0002a4b0: 696e 745f 7572 6c7d 202d 2d70 726f 6669  int_url} --profi
+0002a4c0: 6c65 3d72 3227 0a20 2020 2020 2020 2069  le=r2'.        i
+0002a4d0: 6620 7374 6f72 655f 7479 7065 203d 3d20  f store_type == 
+0002a4e0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002a4f0: 6554 7970 652e 4942 4d3a 0a20 2020 2020  eType.IBM:.     
+0002a500: 2020 2020 2020 2062 7563 6b65 745f 7263         bucket_rc
+0002a510: 6c6f 6e65 5f70 726f 6669 6c65 203d 2052  lone_profile = R
+0002a520: 636c 6f6e 652e 6765 6e65 7261 7465 5f72  clone.generate_r
+0002a530: 636c 6f6e 655f 6275 636b 6574 5f70 726f  clone_bucket_pro
+0002a540: 6669 6c65 5f6e 616d 6528 0a20 2020 2020  file_name(.     
+0002a550: 2020 2020 2020 2020 2020 2062 7563 6b65             bucke
+0002a560: 745f 6e61 6d65 2c20 5263 6c6f 6e65 2e52  t_name, Rclone.R
+0002a570: 636c 6f6e 6543 6c6f 7564 732e 4942 4d29  cloneClouds.IBM)
+0002a580: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0002a590: 7572 6e20 6627 7263 6c6f 6e65 206c 7320  urn f'rclone ls 
+0002a5a0: 7b62 7563 6b65 745f 7263 6c6f 6e65 5f70  {bucket_rclone_p
+0002a5b0: 726f 6669 6c65 7d3a 7b62 7563 6b65 745f  rofile}:{bucket_
+0002a5c0: 6e61 6d65 7d2f 7b73 7566 6669 787d 270a  name}/{suffix}'.
+0002a5d0: 0a20 2020 2040 7374 6174 6963 6d65 7468  .    @staticmeth
+0002a5e0: 6f64 0a20 2020 2064 6566 2063 6c69 5f72  od.    def cli_r
+0002a5f0: 6567 696f 6e5f 636d 6428 7374 6f72 655f  egion_cmd(store_
+0002a600: 7479 7065 2c20 6275 636b 6574 5f6e 616d  type, bucket_nam
+0002a610: 6529 3a0a 2020 2020 2020 2020 6966 2073  e):.        if s
+0002a620: 746f 7265 5f74 7970 6520 3d3d 2073 746f  tore_type == sto
+0002a630: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0002a640: 7065 2e53 333a 0a20 2020 2020 2020 2020  pe.S3:.         
+0002a650: 2020 2072 6574 7572 6e20 2827 6177 7320     return ('aws 
+0002a660: 7333 6170 6920 6765 742d 6275 636b 6574  s3api get-bucket
+0002a670: 2d6c 6f63 6174 696f 6e20 270a 2020 2020  -location '.    
+0002a680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a690: 6627 2d2d 6275 636b 6574 207b 6275 636b  f'--bucket {buck
+0002a6a0: 6574 5f6e 616d 657d 202d 2d6f 7574 7075  et_name} --outpu
+0002a6b0: 7420 7465 7874 2729 0a20 2020 2020 2020  t text').       
+0002a6c0: 2065 6c69 6620 7374 6f72 655f 7479 7065   elif store_type
+0002a6d0: 203d 3d20 7374 6f72 6167 655f 6c69 622e   == storage_lib.
+0002a6e0: 5374 6f72 6554 7970 652e 4743 533a 0a20  StoreType.GCS:. 
+0002a6f0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0002a700: 6e20 2866 2767 7375 7469 6c20 6c73 202d  n (f'gsutil ls -
+0002a710: 4c20 2d62 2067 733a 2f2f 7b62 7563 6b65  L -b gs://{bucke
+0002a720: 745f 6e61 6d65 7d2f 207c 2027 0a20 2020  t_name}/ | '.   
+0002a730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a740: 2027 6772 6570 2022 4c6f 6361 7469 6f6e   'grep "Location
+0002a750: 2063 6f6e 7374 7261 696e 7422 207c 2027   constraint" | '
+0002a760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a770: 2020 2020 2027 6177 6b20 5c27 7b70 7269       'awk \'{pri
+0002a780: 6e74 2074 6f6c 6f77 6572 2824 4e46 297d  nt tolower($NF)}
+0002a790: 5c27 2729 0a20 2020 2020 2020 2065 6c73  \'').        els
+0002a7a0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0002a7b0: 6169 7365 204e 6f74 496d 706c 656d 656e  aise NotImplemen
+0002a7c0: 7465 6445 7272 6f72 2866 2752 6567 696f  tedError(f'Regio
+0002a7d0: 6e20 636f 6d6d 616e 6420 6e6f 7420 696d  n command not im
+0002a7e0: 706c 656d 656e 7465 6420 666f 7220 270a  plemented for '.
+0002a7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a810: 2020 2020 2020 6627 7b73 746f 7265 5f74        f'{store_t
+0002a820: 7970 657d 2729 0a0a 2020 2020 4073 7461  ype}')..    @sta
+0002a830: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
+0002a840: 6620 636c 695f 636f 756e 745f 6e61 6d65  f cli_count_name
+0002a850: 5f69 6e5f 6275 636b 6574 2873 746f 7265  _in_bucket(store
+0002a860: 5f74 7970 652c 2062 7563 6b65 745f 6e61  _type, bucket_na
+0002a870: 6d65 2c20 6669 6c65 5f6e 616d 652c 2073  me, file_name, s
+0002a880: 7566 6669 783d 2727 293a 0a20 2020 2020  uffix=''):.     
+0002a890: 2020 2069 6620 7374 6f72 655f 7479 7065     if store_type
+0002a8a0: 203d 3d20 7374 6f72 6167 655f 6c69 622e   == storage_lib.
+0002a8b0: 5374 6f72 6554 7970 652e 5333 3a0a 2020  StoreType.S3:.  
+0002a8c0: 2020 2020 2020 2020 2020 6966 2073 7566            if suf
+0002a8d0: 6669 783a 0a20 2020 2020 2020 2020 2020  fix:.           
+0002a8e0: 2020 2020 2072 6574 7572 6e20 6627 6177       return f'aw
+0002a8f0: 7320 7333 6170 6920 6c69 7374 2d6f 626a  s s3api list-obj
+0002a900: 6563 7473 202d 2d62 7563 6b65 7420 227b  ects --bucket "{
+0002a910: 6275 636b 6574 5f6e 616d 657d 2220 2d2d  bucket_name}" --
+0002a920: 7072 6566 6978 207b 7375 6666 6978 7d20  prefix {suffix} 
+0002a930: 2d2d 7175 6572 7920 226c 656e 6774 6828  --query "length(
+0002a940: 436f 6e74 656e 7473 5b3f 636f 6e74 6169  Contents[?contai
+0002a950: 6e73 284b 6579 2c5c 277b 6669 6c65 5f6e  ns(Key,\'{file_n
+0002a960: 616d 657d 5c27 295d 2e4b 6579 2922 270a  ame}\')].Key)"'.
+0002a970: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0002a980: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002a990: 2020 7265 7475 726e 2066 2761 7773 2073    return f'aws s
+0002a9a0: 3361 7069 206c 6973 742d 6f62 6a65 6374  3api list-object
+0002a9b0: 7320 2d2d 6275 636b 6574 2022 7b62 7563  s --bucket "{buc
+0002a9c0: 6b65 745f 6e61 6d65 7d22 202d 2d71 7565  ket_name}" --que
+0002a9d0: 7279 2022 6c65 6e67 7468 2843 6f6e 7465  ry "length(Conte
+0002a9e0: 6e74 735b 3f63 6f6e 7461 696e 7328 4b65  nts[?contains(Ke
+0002a9f0: 792c 5c27 7b66 696c 655f 6e61 6d65 7d5c  y,\'{file_name}\
+0002aa00: 2729 5d2e 4b65 7929 2227 0a20 2020 2020  ')].Key)"'.     
+0002aa10: 2020 2065 6c69 6620 7374 6f72 655f 7479     elif store_ty
+0002aa20: 7065 203d 3d20 7374 6f72 6167 655f 6c69  pe == storage_li
+0002aa30: 622e 5374 6f72 6554 7970 652e 4743 533a  b.StoreType.GCS:
+0002aa40: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0002aa50: 7375 6666 6978 3a0a 2020 2020 2020 2020  suffix:.        
+0002aa60: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+0002aa70: 2767 7375 7469 6c20 6c73 202d 7220 6773  'gsutil ls -r gs
+0002aa80: 3a2f 2f7b 6275 636b 6574 5f6e 616d 657d  ://{bucket_name}
+0002aa90: 2f7b 7375 6666 6978 7d20 7c20 6772 6570  /{suffix} | grep
+0002aaa0: 2022 7b66 696c 655f 6e61 6d65 7d22 207c   "{file_name}" |
+0002aab0: 2077 6320 2d6c 270a 2020 2020 2020 2020   wc -l'.        
+0002aac0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0002aad0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0002aae0: 2066 2767 7375 7469 6c20 6c73 202d 7220   f'gsutil ls -r 
+0002aaf0: 6773 3a2f 2f7b 6275 636b 6574 5f6e 616d  gs://{bucket_nam
+0002ab00: 657d 207c 2067 7265 7020 227b 6669 6c65  e} | grep "{file
+0002ab10: 5f6e 616d 657d 2220 7c20 7763 202d 6c27  _name}" | wc -l'
+0002ab20: 0a20 2020 2020 2020 2065 6c69 6620 7374  .        elif st
+0002ab30: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
+0002ab40: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0002ab50: 652e 5232 3a0a 2020 2020 2020 2020 2020  e.R2:.          
+0002ab60: 2020 656e 6470 6f69 6e74 5f75 726c 203d    endpoint_url =
+0002ab70: 2063 6c6f 7564 666c 6172 652e 6372 6561   cloudflare.crea
+0002ab80: 7465 5f65 6e64 706f 696e 7428 290a 2020  te_endpoint().  
+0002ab90: 2020 2020 2020 2020 2020 6966 2073 7566            if suf
+0002aba0: 6669 783a 0a20 2020 2020 2020 2020 2020  fix:.           
+0002abb0: 2020 2020 2072 6574 7572 6e20 6627 4157       return f'AW
+0002abc0: 535f 5348 4152 4544 5f43 5245 4445 4e54  S_SHARED_CREDENT
+0002abd0: 4941 4c53 5f46 494c 453d 7b63 6c6f 7564  IALS_FILE={cloud
+0002abe0: 666c 6172 652e 5232 5f43 5245 4445 4e54  flare.R2_CREDENT
+0002abf0: 4941 4c53 5f50 4154 487d 2061 7773 2073  IALS_PATH} aws s
+0002ac00: 3361 7069 206c 6973 742d 6f62 6a65 6374  3api list-object
+0002ac10: 7320 2d2d 6275 636b 6574 2022 7b62 7563  s --bucket "{buc
+0002ac20: 6b65 745f 6e61 6d65 7d22 202d 2d70 7265  ket_name}" --pre
+0002ac30: 6669 7820 7b73 7566 6669 787d 202d 2d71  fix {suffix} --q
+0002ac40: 7565 7279 2022 6c65 6e67 7468 2843 6f6e  uery "length(Con
+0002ac50: 7465 6e74 735b 3f63 6f6e 7461 696e 7328  tents[?contains(
+0002ac60: 4b65 792c 5c27 7b66 696c 655f 6e61 6d65  Key,\'{file_name
+0002ac70: 7d5c 2729 5d2e 4b65 7929 2220 2d2d 656e  }\')].Key)" --en
+0002ac80: 6470 6f69 6e74 207b 656e 6470 6f69 6e74  dpoint {endpoint
+0002ac90: 5f75 726c 7d20 2d2d 7072 6f66 696c 653d  _url} --profile=
+0002aca0: 7232 270a 2020 2020 2020 2020 2020 2020  r2'.            
+0002acb0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0002acc0: 2020 2020 2020 7265 7475 726e 2066 2741        return f'A
+0002acd0: 5753 5f53 4841 5245 445f 4352 4544 454e  WS_SHARED_CREDEN
+0002ace0: 5449 414c 535f 4649 4c45 3d7b 636c 6f75  TIALS_FILE={clou
+0002acf0: 6466 6c61 7265 2e52 325f 4352 4544 454e  dflare.R2_CREDEN
+0002ad00: 5449 414c 535f 5041 5448 7d20 6177 7320  TIALS_PATH} aws 
+0002ad10: 7333 6170 6920 6c69 7374 2d6f 626a 6563  s3api list-objec
+0002ad20: 7473 202d 2d62 7563 6b65 7420 227b 6275  ts --bucket "{bu
+0002ad30: 636b 6574 5f6e 616d 657d 2220 2d2d 7175  cket_name}" --qu
+0002ad40: 6572 7920 226c 656e 6774 6828 436f 6e74  ery "length(Cont
+0002ad50: 656e 7473 5b3f 636f 6e74 6169 6e73 284b  ents[?contains(K
+0002ad60: 6579 2c5c 277b 6669 6c65 5f6e 616d 657d  ey,\'{file_name}
+0002ad70: 5c27 295d 2e4b 6579 2922 202d 2d65 6e64  \')].Key)" --end
+0002ad80: 706f 696e 7420 7b65 6e64 706f 696e 745f  point {endpoint_
+0002ad90: 7572 6c7d 202d 2d70 726f 6669 6c65 3d72  url} --profile=r
+0002ada0: 3227 0a0a 2020 2020 4073 7461 7469 636d  2'..    @staticm
+0002adb0: 6574 686f 640a 2020 2020 6465 6620 636c  ethod.    def cl
+0002adc0: 695f 636f 756e 745f 6669 6c65 5f69 6e5f  i_count_file_in_
+0002add0: 6275 636b 6574 2873 746f 7265 5f74 7970  bucket(store_typ
+0002ade0: 652c 2062 7563 6b65 745f 6e61 6d65 293a  e, bucket_name):
+0002adf0: 0a20 2020 2020 2020 2069 6620 7374 6f72  .        if stor
+0002ae00: 655f 7479 7065 203d 3d20 7374 6f72 6167  e_type == storag
+0002ae10: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0002ae20: 5333 3a0a 2020 2020 2020 2020 2020 2020  S3:.            
+0002ae30: 7265 7475 726e 2066 2761 7773 2073 3320  return f'aws s3 
+0002ae40: 6c73 2073 333a 2f2f 7b62 7563 6b65 745f  ls s3://{bucket_
+0002ae50: 6e61 6d65 7d20 2d2d 7265 6375 7273 6976  name} --recursiv
+0002ae60: 6520 7c20 7763 202d 6c27 0a20 2020 2020  e | wc -l'.     
+0002ae70: 2020 2065 6c69 6620 7374 6f72 655f 7479     elif store_ty
+0002ae80: 7065 203d 3d20 7374 6f72 6167 655f 6c69  pe == storage_li
+0002ae90: 622e 5374 6f72 6554 7970 652e 4743 533a  b.StoreType.GCS:
+0002aea0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0002aeb0: 7572 6e20 6627 6773 7574 696c 206c 7320  urn f'gsutil ls 
+0002aec0: 2d72 2067 733a 2f2f 7b62 7563 6b65 745f  -r gs://{bucket_
+0002aed0: 6e61 6d65 7d2f 2a2a 207c 2077 6320 2d6c  name}/** | wc -l
+0002aee0: 270a 2020 2020 2020 2020 656c 6966 2073  '.        elif s
+0002aef0: 746f 7265 5f74 7970 6520 3d3d 2073 746f  tore_type == sto
+0002af00: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0002af10: 7065 2e52 323a 0a20 2020 2020 2020 2020  pe.R2:.         
+0002af20: 2020 2065 6e64 706f 696e 745f 7572 6c20     endpoint_url 
+0002af30: 3d20 636c 6f75 6466 6c61 7265 2e63 7265  = cloudflare.cre
+0002af40: 6174 655f 656e 6470 6f69 6e74 2829 0a20  ate_endpoint(). 
+0002af50: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0002af60: 6e20 6627 4157 535f 5348 4152 4544 5f43  n f'AWS_SHARED_C
+0002af70: 5245 4445 4e54 4941 4c53 5f46 494c 453d  REDENTIALS_FILE=
+0002af80: 7b63 6c6f 7564 666c 6172 652e 5232 5f43  {cloudflare.R2_C
+0002af90: 5245 4445 4e54 4941 4c53 5f50 4154 487d  REDENTIALS_PATH}
+0002afa0: 2061 7773 2073 3320 6c73 2073 333a 2f2f   aws s3 ls s3://
+0002afb0: 7b62 7563 6b65 745f 6e61 6d65 7d20 2d2d  {bucket_name} --
+0002afc0: 7265 6375 7273 6976 6520 2d2d 656e 6470  recursive --endp
+0002afd0: 6f69 6e74 207b 656e 6470 6f69 6e74 5f75  oint {endpoint_u
+0002afe0: 726c 7d20 2d2d 7072 6f66 696c 653d 7232  rl} --profile=r2
+0002aff0: 207c 2077 6320 2d6c 270a 0a20 2020 2040   | wc -l'..    @
+0002b000: 7079 7465 7374 2e66 6978 7475 7265 0a20  pytest.fixture. 
+0002b010: 2020 2064 6566 2074 6d70 5f73 6f75 7263     def tmp_sourc
+0002b020: 6528 7365 6c66 2c20 746d 705f 7061 7468  e(self, tmp_path
+0002b030: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
+0002b040: 6174 6573 2061 2074 656d 706f 7261 7279  ates a temporary
+0002b050: 2064 6972 6563 746f 7279 2077 6974 6820   directory with 
+0002b060: 6120 6669 6c65 2069 6e20 6974 0a20 2020  a file in it.   
+0002b070: 2020 2020 2074 6d70 5f64 6972 203d 2074       tmp_dir = t
+0002b080: 6d70 5f70 6174 6820 2f20 2774 6d70 2d73  mp_path / 'tmp-s
+0002b090: 6f75 7263 6527 0a20 2020 2020 2020 2074  ource'.        t
+0002b0a0: 6d70 5f64 6972 2e6d 6b64 6972 2829 0a20  mp_dir.mkdir(). 
+0002b0b0: 2020 2020 2020 2074 6d70 5f66 696c 6520         tmp_file 
+0002b0c0: 3d20 746d 705f 6469 7220 2f20 2774 6d70  = tmp_dir / 'tmp
+0002b0d0: 2d66 696c 6527 0a20 2020 2020 2020 2074  -file'.        t
+0002b0e0: 6d70 5f66 696c 652e 7772 6974 655f 7465  mp_file.write_te
+0002b0f0: 7874 2827 7465 7374 2729 0a20 2020 2020  xt('test').     
+0002b100: 2020 2063 6972 636c 655f 6c69 6e6b 203d     circle_link =
+0002b110: 2074 6d70 5f64 6972 202f 2027 6369 7263   tmp_dir / 'circ
+0002b120: 6c65 2d6c 696e 6b27 0a20 2020 2020 2020  le-link'.       
+0002b130: 2063 6972 636c 655f 6c69 6e6b 2e73 796d   circle_link.sym
+0002b140: 6c69 6e6b 5f74 6f28 746d 705f 6469 722c  link_to(tmp_dir,
+0002b150: 2074 6172 6765 745f 6973 5f64 6972 6563   target_is_direc
+0002b160: 746f 7279 3d54 7275 6529 0a20 2020 2020  tory=True).     
+0002b170: 2020 2079 6965 6c64 2073 7472 2874 6d70     yield str(tmp
+0002b180: 5f64 6972 290a 0a20 2020 2040 7374 6174  _dir)..    @stat
+0002b190: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
+0002b1a0: 2067 656e 6572 6174 655f 6275 636b 6574   generate_bucket
+0002b1b0: 5f6e 616d 6528 293a 0a20 2020 2020 2020  _name():.       
+0002b1c0: 2023 2043 7265 6174 6573 2061 2074 656d   # Creates a tem
+0002b1d0: 706f 7261 7279 2062 7563 6b65 7420 6e61  porary bucket na
+0002b1e0: 6d65 0a20 2020 2020 2020 2023 2074 696d  me.        # tim
+0002b1f0: 652e 7469 6d65 2829 2072 6574 7572 6e73  e.time() returns
+0002b200: 2076 6172 7969 6e67 2070 7265 6369 7369   varying precisi
+0002b210: 6f6e 206f 6e20 6469 6666 6572 656e 7420  on on different 
+0002b220: 7379 7374 656d 732c 2073 6f20 7765 0a20  systems, so we. 
+0002b230: 2020 2020 2020 2023 2072 6570 6c61 6365         # replace
+0002b240: 2074 6865 2064 6563 696d 616c 2070 6f69   the decimal poi
+0002b250: 6e74 2061 6e64 2075 7365 2077 6861 7465  nt and use whate
+0002b260: 7665 7220 7072 6563 6973 696f 6e20 7765  ver precision we
+0002b270: 2063 616e 2067 6574 2e0a 2020 2020 2020   can get..      
+0002b280: 2020 7469 6d65 7374 616d 7020 3d20 7374    timestamp = st
+0002b290: 7228 7469 6d65 2e74 696d 6528 2929 2e72  r(time.time()).r
+0002b2a0: 6570 6c61 6365 2827 2e27 2c20 2727 290a  eplace('.', '').
+0002b2b0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+0002b2c0: 2773 6b79 2d74 6573 742d 7b74 696d 6573  'sky-test-{times
+0002b2d0: 7461 6d70 7d27 0a0a 2020 2020 4070 7974  tamp}'..    @pyt
+0002b2e0: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
+0002b2f0: 6465 6620 746d 705f 6275 636b 6574 5f6e  def tmp_bucket_n
+0002b300: 616d 6528 7365 6c66 293a 0a20 2020 2020  ame(self):.     
+0002b310: 2020 2079 6965 6c64 2073 656c 662e 6765     yield self.ge
+0002b320: 6e65 7261 7465 5f62 7563 6b65 745f 6e61  nerate_bucket_na
+0002b330: 6d65 2829 0a0a 2020 2020 4073 7461 7469  me()..    @stati
+0002b340: 636d 6574 686f 640a 2020 2020 6465 6620  cmethod.    def 
+0002b350: 7969 656c 645f 7374 6f72 6167 655f 6f62  yield_storage_ob
+0002b360: 6a65 6374 280a 2020 2020 2020 2020 2020  ject(.          
+0002b370: 2020 6e61 6d65 3a20 4f70 7469 6f6e 616c    name: Optional
+0002b380: 5b73 7472 5d20 3d20 4e6f 6e65 2c0a 2020  [str] = None,.  
+0002b390: 2020 2020 2020 2020 2020 736f 7572 6365            source
+0002b3a0: 3a20 4f70 7469 6f6e 616c 5b73 746f 7261  : Optional[stora
+0002b3b0: 6765 5f6c 6962 2e50 6174 685d 203d 204e  ge_lib.Path] = N
+0002b3c0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+0002b3d0: 2073 746f 7265 733a 204f 7074 696f 6e61   stores: Optiona
+0002b3e0: 6c5b 4469 6374 5b73 746f 7261 6765 5f6c  l[Dict[storage_l
+0002b3f0: 6962 2e53 746f 7265 5479 7065 2c0a 2020  ib.StoreType,.  
 0002b400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b410: 2020 2020 2020 7374 6f72 6573 3d73 746f        stores=sto
-0002b420: 7265 732c 0a20 2020 2020 2020 2020 2020  res,.           
-0002b430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b440: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0002b450: 6572 7369 7374 656e 743d 7065 7273 6973  ersistent=persis
-0002b460: 7465 6e74 2c0a 2020 2020 2020 2020 2020  tent,.          
-0002b470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b490: 6d6f 6465 3d6d 6f64 6529 0a20 2020 2020  mode=mode).     
-0002b4a0: 2020 2079 6965 6c64 2073 746f 7261 6765     yield storage
-0002b4b0: 5f6f 626a 0a20 2020 2020 2020 2068 616e  _obj.        han
-0002b4c0: 646c 6520 3d20 676c 6f62 616c 5f75 7365  dle = global_use
-0002b4d0: 725f 7374 6174 652e 6765 745f 6861 6e64  r_state.get_hand
-0002b4e0: 6c65 5f66 726f 6d5f 7374 6f72 6167 655f  le_from_storage_
-0002b4f0: 6e61 6d65 280a 2020 2020 2020 2020 2020  name(.          
-0002b500: 2020 7374 6f72 6167 655f 6f62 6a2e 6e61    storage_obj.na
-0002b510: 6d65 290a 2020 2020 2020 2020 6966 2068  me).        if h
-0002b520: 616e 646c 653a 0a20 2020 2020 2020 2020  andle:.         
-0002b530: 2020 2023 2049 6620 6861 6e64 6c65 2065     # If handle e
-0002b540: 7869 7374 732c 2064 656c 6574 6520 6d61  xists, delete ma
-0002b550: 6e75 616c 6c79 0a20 2020 2020 2020 2020  nually.         
-0002b560: 2020 2023 2054 4f44 4f28 726f 6d69 6c62     # TODO(romilb
-0002b570: 293a 2054 6869 7320 6973 2070 6f74 656e  ): This is poten
-0002b580: 7469 616c 6c79 2072 6973 6b79 202d 2069  tially risky - i
-0002b590: 6620 7468 6520 6465 6c65 7465 206d 6574  f the delete met
-0002b5a0: 686f 6420 6861 730a 2020 2020 2020 2020  hod has.        
-0002b5b0: 2020 2020 2320 2020 6275 6773 2c20 7468      #   bugs, th
-0002b5c0: 6973 2063 616e 2063 6175 7365 2072 6573  is can cause res
-0002b5d0: 6f75 7263 6520 6c65 616b 732e 2049 6465  ource leaks. Ide
-0002b5e0: 616c 6c79 2077 6520 7368 6f75 6c64 206d  ally we should m
-0002b5f0: 616e 7561 6c6c 790a 2020 2020 2020 2020  anually.        
-0002b600: 2020 2020 2320 2020 656a 6563 7420 7374      #   eject st
-0002b610: 6f72 6167 6520 6672 6f6d 2067 6c6f 6261  orage from globa
-0002b620: 6c5f 7573 6572 5f73 7461 7465 2061 6e64  l_user_state and
-0002b630: 2064 656c 6574 6520 7468 6520 6275 636b   delete the buck
-0002b640: 6574 2075 7369 6e67 0a20 2020 2020 2020  et using.       
-0002b650: 2020 2020 2023 2020 2062 6f74 6f33 2064       #   boto3 d
-0002b660: 6972 6563 746c 792e 0a20 2020 2020 2020  irectly..       
-0002b670: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
-0002b680: 2e64 656c 6574 6528 290a 0a20 2020 2040  .delete()..    @
-0002b690: 7079 7465 7374 2e66 6978 7475 7265 0a20  pytest.fixture. 
-0002b6a0: 2020 2064 6566 2074 6d70 5f73 6372 6174     def tmp_scrat
-0002b6b0: 6368 5f73 746f 7261 6765 5f6f 626a 2873  ch_storage_obj(s
-0002b6c0: 656c 662c 2074 6d70 5f62 7563 6b65 745f  elf, tmp_bucket_
-0002b6d0: 6e61 6d65 293a 0a20 2020 2020 2020 2023  name):.        #
-0002b6e0: 2043 7265 6174 6573 2061 2073 746f 7261   Creates a stora
-0002b6f0: 6765 206f 626a 6563 7420 7769 7468 206e  ge object with n
-0002b700: 6f20 736f 7572 6365 2074 6f20 6372 6561  o source to crea
-0002b710: 7465 2061 2073 6372 6174 6368 2073 746f  te a scratch sto
-0002b720: 7261 6765 2e0a 2020 2020 2020 2020 2320  rage..        # 
-0002b730: 5374 6f72 6573 206d 7573 7420 6265 2061  Stores must be a
-0002b740: 6464 6564 2069 6e20 7468 6520 7465 7374  dded in the test
-0002b750: 2e0a 2020 2020 2020 2020 7969 656c 6420  ..        yield 
-0002b760: 6672 6f6d 2073 656c 662e 7969 656c 645f  from self.yield_
-0002b770: 7374 6f72 6167 655f 6f62 6a65 6374 286e  storage_object(n
-0002b780: 616d 653d 746d 705f 6275 636b 6574 5f6e  ame=tmp_bucket_n
-0002b790: 616d 6529 0a0a 2020 2020 4070 7974 6573  ame)..    @pytes
-0002b7a0: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
-0002b7b0: 6620 746d 705f 6d75 6c74 6970 6c65 5f73  f tmp_multiple_s
-0002b7c0: 6372 6174 6368 5f73 746f 7261 6765 5f6f  cratch_storage_o
-0002b7d0: 626a 2873 656c 6629 3a0a 2020 2020 2020  bj(self):.      
-0002b7e0: 2020 2320 4372 6561 7465 7320 6120 6c69    # Creates a li
-0002b7f0: 7374 206f 6620 3520 7374 6f72 6167 6520  st of 5 storage 
-0002b800: 6f62 6a65 6374 7320 7769 7468 206e 6f20  objects with no 
-0002b810: 736f 7572 6365 2074 6f20 6372 6561 7465  source to create
-0002b820: 0a20 2020 2020 2020 2023 206d 756c 7469  .        # multi
-0002b830: 706c 6520 7363 7261 7463 6820 7374 6f72  ple scratch stor
-0002b840: 6167 6573 2e0a 2020 2020 2020 2020 2320  ages..        # 
-0002b850: 5374 6f72 6573 2066 6f72 2065 6163 6820  Stores for each 
-0002b860: 6f62 6a65 6374 2069 6e20 7468 6520 6c69  object in the li
-0002b870: 7374 206d 7573 7420 6265 2061 6464 6564  st must be added
-0002b880: 2069 6e20 7468 6520 7465 7374 2e0a 2020   in the test..  
-0002b890: 2020 2020 2020 7374 6f72 6167 655f 6d75        storage_mu
-0002b8a0: 6c74 5f6f 626a 203d 205b 5d0a 2020 2020  lt_obj = [].    
-0002b8b0: 2020 2020 666f 7220 5f20 696e 2072 616e      for _ in ran
-0002b8c0: 6765 2835 293a 0a20 2020 2020 2020 2020  ge(5):.         
-0002b8d0: 2020 2074 696d 6573 7461 6d70 203d 2073     timestamp = s
-0002b8e0: 7472 2874 696d 652e 7469 6d65 2829 292e  tr(time.time()).
-0002b8f0: 7265 706c 6163 6528 272e 272c 2027 2729  replace('.', '')
-0002b900: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
-0002b910: 7265 5f6f 626a 203d 2073 746f 7261 6765  re_obj = storage
-0002b920: 5f6c 6962 2e53 746f 7261 6765 286e 616d  _lib.Storage(nam
-0002b930: 653d 6627 736b 792d 7465 7374 2d7b 7469  e=f'sky-test-{ti
-0002b940: 6d65 7374 616d 707d 2729 0a20 2020 2020  mestamp}').     
-0002b950: 2020 2020 2020 2073 746f 7261 6765 5f6d         storage_m
-0002b960: 756c 745f 6f62 6a2e 6170 7065 6e64 2873  ult_obj.append(s
-0002b970: 746f 7265 5f6f 626a 290a 2020 2020 2020  tore_obj).      
-0002b980: 2020 7969 656c 6420 7374 6f72 6167 655f    yield storage_
-0002b990: 6d75 6c74 5f6f 626a 0a20 2020 2020 2020  mult_obj.       
-0002b9a0: 2066 6f72 2073 746f 7261 6765 5f6f 626a   for storage_obj
-0002b9b0: 2069 6e20 7374 6f72 6167 655f 6d75 6c74   in storage_mult
-0002b9c0: 5f6f 626a 3a0a 2020 2020 2020 2020 2020  _obj:.          
-0002b9d0: 2020 6861 6e64 6c65 203d 2067 6c6f 6261    handle = globa
-0002b9e0: 6c5f 7573 6572 5f73 7461 7465 2e67 6574  l_user_state.get
-0002b9f0: 5f68 616e 646c 655f 6672 6f6d 5f73 746f  _handle_from_sto
-0002ba00: 7261 6765 5f6e 616d 6528 0a20 2020 2020  rage_name(.     
-0002ba10: 2020 2020 2020 2020 2020 2073 746f 7261             stora
-0002ba20: 6765 5f6f 626a 2e6e 616d 6529 0a20 2020  ge_obj.name).   
-0002ba30: 2020 2020 2020 2020 2069 6620 6861 6e64           if hand
-0002ba40: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
-0002ba50: 2020 2020 2320 4966 2068 616e 646c 6520      # If handle 
-0002ba60: 6578 6973 7473 2c20 6465 6c65 7465 206d  exists, delete m
-0002ba70: 616e 7561 6c6c 790a 2020 2020 2020 2020  anually.        
-0002ba80: 2020 2020 2020 2020 2320 544f 444f 2872          # TODO(r
-0002ba90: 6f6d 696c 6229 3a20 5468 6973 2069 7320  omilb): This is 
-0002baa0: 706f 7465 6e74 6961 6c6c 7920 7269 736b  potentially risk
-0002bab0: 7920 2d20 6966 2074 6865 2064 656c 6574  y - if the delet
-0002bac0: 6520 6d65 7468 6f64 2068 6173 0a20 2020  e method has.   
-0002bad0: 2020 2020 2020 2020 2020 2020 2023 2062               # b
-0002bae0: 7567 732c 2074 6869 7320 6361 6e20 6361  ugs, this can ca
-0002baf0: 7573 6520 7265 736f 7572 6365 206c 6561  use resource lea
-0002bb00: 6b73 2e20 4964 6561 6c6c 7920 7765 2073  ks. Ideally we s
-0002bb10: 686f 756c 6420 6d61 6e75 616c 6c79 0a20  hould manually. 
-0002bb20: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0002bb30: 2065 6a65 6374 2073 746f 7261 6765 2066   eject storage f
-0002bb40: 726f 6d20 676c 6f62 616c 5f75 7365 725f  rom global_user_
-0002bb50: 7374 6174 6520 616e 6420 6465 6c65 7465  state and delete
-0002bb60: 2074 6865 2062 7563 6b65 7420 7573 696e   the bucket usin
-0002bb70: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
-0002bb80: 2020 2320 626f 746f 3320 6469 7265 6374    # boto3 direct
-0002bb90: 6c79 2e0a 2020 2020 2020 2020 2020 2020  ly..            
-0002bba0: 2020 2020 7374 6f72 6167 655f 6f62 6a2e      storage_obj.
-0002bbb0: 6465 6c65 7465 2829 0a0a 2020 2020 4070  delete()..    @p
-0002bbc0: 7974 6573 742e 6669 7874 7572 650a 2020  ytest.fixture.  
-0002bbd0: 2020 6465 6620 746d 705f 6d75 6c74 6970    def tmp_multip
-0002bbe0: 6c65 5f63 7573 746f 6d5f 736f 7572 6365  le_custom_source
-0002bbf0: 5f73 746f 7261 6765 5f6f 626a 2873 656c  _storage_obj(sel
-0002bc00: 6629 3a0a 2020 2020 2020 2020 2320 4372  f):.        # Cr
-0002bc10: 6561 7465 7320 6120 6c69 7374 206f 6620  eates a list of 
-0002bc20: 7374 6f72 6167 6520 6f62 6a65 6374 7320  storage objects 
-0002bc30: 7769 7468 2063 7573 746f 6d20 736f 7572  with custom sour
-0002bc40: 6365 206e 616d 6573 2074 6f0a 2020 2020  ce names to.    
-0002bc50: 2020 2020 2320 6372 6561 7465 206d 756c      # create mul
-0002bc60: 7469 706c 6520 7363 7261 7463 6820 7374  tiple scratch st
-0002bc70: 6f72 6167 6573 2e0a 2020 2020 2020 2020  orages..        
-0002bc80: 2320 5374 6f72 6573 2066 6f72 2065 6163  # Stores for eac
-0002bc90: 6820 6f62 6a65 6374 2069 6e20 7468 6520  h object in the 
-0002bca0: 6c69 7374 206d 7573 7420 6265 2061 6464  list must be add
-0002bcb0: 6564 2069 6e20 7468 6520 7465 7374 2e0a  ed in the test..
-0002bcc0: 2020 2020 2020 2020 6375 7374 6f6d 5f73          custom_s
-0002bcd0: 6f75 7263 655f 6e61 6d65 7320 3d20 5b27  ource_names = ['
-0002bce0: 2270 6174 6820 5769 7468 2053 7061 6365  "path With Space
-0002bcf0: 7322 272c 2027 7061 7468 2057 6974 6820  s"', 'path With 
-0002bd00: 5370 6163 6573 275d 0a20 2020 2020 2020  Spaces'].       
-0002bd10: 2073 746f 7261 6765 5f6d 756c 745f 6f62   storage_mult_ob
-0002bd20: 6a20 3d20 5b5d 0a20 2020 2020 2020 2066  j = [].        f
-0002bd30: 6f72 206e 616d 6520 696e 2063 7573 746f  or name in custo
-0002bd40: 6d5f 736f 7572 6365 5f6e 616d 6573 3a0a  m_source_names:.
-0002bd50: 2020 2020 2020 2020 2020 2020 7372 635f              src_
-0002bd60: 7061 7468 203d 206f 732e 7061 7468 2e65  path = os.path.e
-0002bd70: 7870 616e 6475 7365 7228 6627 7e2f 7b6e  xpanduser(f'~/{n
-0002bd80: 616d 657d 2729 0a20 2020 2020 2020 2020  ame}').         
-0002bd90: 2020 2070 6174 686c 6962 2e50 6174 6828     pathlib.Path(
-0002bda0: 7372 635f 7061 7468 292e 6578 7061 6e64  src_path).expand
-0002bdb0: 7573 6572 2829 2e6d 6b64 6972 2865 7869  user().mkdir(exi
-0002bdc0: 7374 5f6f 6b3d 5472 7565 290a 2020 2020  st_ok=True).    
-0002bdd0: 2020 2020 2020 2020 7469 6d65 7374 616d          timestam
-0002bde0: 7020 3d20 7374 7228 7469 6d65 2e74 696d  p = str(time.tim
-0002bdf0: 6528 2929 2e72 6570 6c61 6365 2827 2e27  e()).replace('.'
-0002be00: 2c20 2727 290a 2020 2020 2020 2020 2020  , '').          
-0002be10: 2020 7374 6f72 655f 6f62 6a20 3d20 7374    store_obj = st
-0002be20: 6f72 6167 655f 6c69 622e 5374 6f72 6167  orage_lib.Storag
-0002be30: 6528 6e61 6d65 3d66 2773 6b79 2d74 6573  e(name=f'sky-tes
-0002be40: 742d 7b74 696d 6573 7461 6d70 7d27 2c0a  t-{timestamp}',.
-0002be50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002be60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002be70: 2020 2020 2020 2020 2020 2020 736f 7572              sour
-0002be80: 6365 3d73 7263 5f70 6174 6829 0a20 2020  ce=src_path).   
-0002be90: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-0002bea0: 5f6d 756c 745f 6f62 6a2e 6170 7065 6e64  _mult_obj.append
-0002beb0: 2873 746f 7265 5f6f 626a 290a 2020 2020  (store_obj).    
-0002bec0: 2020 2020 7969 656c 6420 7374 6f72 6167      yield storag
-0002bed0: 655f 6d75 6c74 5f6f 626a 0a20 2020 2020  e_mult_obj.     
-0002bee0: 2020 2066 6f72 2073 746f 7261 6765 5f6f     for storage_o
-0002bef0: 626a 2069 6e20 7374 6f72 6167 655f 6d75  bj in storage_mu
-0002bf00: 6c74 5f6f 626a 3a0a 2020 2020 2020 2020  lt_obj:.        
-0002bf10: 2020 2020 6861 6e64 6c65 203d 2067 6c6f      handle = glo
-0002bf20: 6261 6c5f 7573 6572 5f73 7461 7465 2e67  bal_user_state.g
-0002bf30: 6574 5f68 616e 646c 655f 6672 6f6d 5f73  et_handle_from_s
-0002bf40: 746f 7261 6765 5f6e 616d 6528 0a20 2020  torage_name(.   
-0002bf50: 2020 2020 2020 2020 2020 2020 2073 746f               sto
-0002bf60: 7261 6765 5f6f 626a 2e6e 616d 6529 0a20  rage_obj.name). 
-0002bf70: 2020 2020 2020 2020 2020 2069 6620 6861             if ha
-0002bf80: 6e64 6c65 3a0a 2020 2020 2020 2020 2020  ndle:.          
-0002bf90: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
-0002bfa0: 6a2e 6465 6c65 7465 2829 0a0a 2020 2020  j.delete()..    
-0002bfb0: 4070 7974 6573 742e 6669 7874 7572 650a  @pytest.fixture.
-0002bfc0: 2020 2020 6465 6620 746d 705f 6c6f 6361      def tmp_loca
-0002bfd0: 6c5f 7374 6f72 6167 655f 6f62 6a28 7365  l_storage_obj(se
-0002bfe0: 6c66 2c20 746d 705f 6275 636b 6574 5f6e  lf, tmp_bucket_n
-0002bff0: 616d 652c 2074 6d70 5f73 6f75 7263 6529  ame, tmp_source)
-0002c000: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
-0002c010: 7465 7320 6120 7465 6d70 6f72 6172 7920  tes a temporary 
-0002c020: 7374 6f72 6167 6520 6f62 6a65 6374 2e20  storage object. 
-0002c030: 5374 6f72 6573 206d 7573 7420 6265 2061  Stores must be a
-0002c040: 6464 6564 2069 6e20 7468 6520 7465 7374  dded in the test
-0002c050: 2e0a 2020 2020 2020 2020 7969 656c 6420  ..        yield 
-0002c060: 6672 6f6d 2073 656c 662e 7969 656c 645f  from self.yield_
-0002c070: 7374 6f72 6167 655f 6f62 6a65 6374 286e  storage_object(n
-0002c080: 616d 653d 746d 705f 6275 636b 6574 5f6e  ame=tmp_bucket_n
-0002c090: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
-0002c0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c0c0: 2020 736f 7572 6365 3d74 6d70 5f73 6f75    source=tmp_sou
-0002c0d0: 7263 6529 0a0a 2020 2020 4070 7974 6573  rce)..    @pytes
-0002c0e0: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
-0002c0f0: 6620 746d 705f 6c6f 6361 6c5f 6c69 7374  f tmp_local_list
-0002c100: 5f73 746f 7261 6765 5f6f 626a 2873 656c  _storage_obj(sel
-0002c110: 662c 2074 6d70 5f62 7563 6b65 745f 6e61  f, tmp_bucket_na
-0002c120: 6d65 2c20 746d 705f 736f 7572 6365 293a  me, tmp_source):
-0002c130: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
-0002c140: 6573 2061 2074 656d 7020 7374 6f72 6167  es a temp storag
-0002c150: 6520 6f62 6a65 6374 2077 6869 6368 2075  e object which u
-0002c160: 7365 7320 6120 6c69 7374 206f 6620 7061  ses a list of pa
-0002c170: 7468 7320 6173 2073 6f75 7263 652e 0a20  ths as source.. 
-0002c180: 2020 2020 2020 2023 2053 746f 7265 7320         # Stores 
-0002c190: 6d75 7374 2062 6520 6164 6465 6420 696e  must be added in
-0002c1a0: 2074 6865 2074 6573 742e 2041 6674 6572   the test. After
-0002c1b0: 2075 706c 6f61 642c 2074 6865 2062 7563   upload, the buc
-0002c1c0: 6b65 7420 7368 6f75 6c64 0a20 2020 2020  ket should.     
-0002c1d0: 2020 2023 2068 6176 6520 7477 6f20 6669     # have two fi
-0002c1e0: 6c65 7320 2d20 2f74 6d70 2d66 696c 6520  les - /tmp-file 
-0002c1f0: 616e 6420 2f74 6d70 2d73 6f75 7263 652f  and /tmp-source/
-0002c200: 746d 702d 6669 6c65 0a20 2020 2020 2020  tmp-file.       
-0002c210: 206c 6973 745f 736f 7572 6365 203d 205b   list_source = [
-0002c220: 746d 705f 736f 7572 6365 2c20 746d 705f  tmp_source, tmp_
-0002c230: 736f 7572 6365 202b 2027 2f74 6d70 2d66  source + '/tmp-f
-0002c240: 696c 6527 5d0a 2020 2020 2020 2020 7969  ile'].        yi
-0002c250: 656c 6420 6672 6f6d 2073 656c 662e 7969  eld from self.yi
-0002c260: 656c 645f 7374 6f72 6167 655f 6f62 6a65  eld_storage_obje
-0002c270: 6374 286e 616d 653d 746d 705f 6275 636b  ct(name=tmp_buck
-0002c280: 6574 5f6e 616d 652c 0a20 2020 2020 2020  et_name,.       
-0002c290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c2b0: 2020 2020 2020 736f 7572 6365 3d6c 6973        source=lis
-0002c2c0: 745f 736f 7572 6365 290a 0a20 2020 2040  t_source)..    @
-0002c2d0: 7079 7465 7374 2e66 6978 7475 7265 0a20  pytest.fixture. 
-0002c2e0: 2020 2064 6566 2074 6d70 5f62 756c 6b5f     def tmp_bulk_
-0002c2f0: 6465 6c5f 7374 6f72 6167 655f 6f62 6a28  del_storage_obj(
-0002c300: 7365 6c66 2c20 746d 705f 6275 636b 6574  self, tmp_bucket
-0002c310: 5f6e 616d 6529 3a0a 2020 2020 2020 2020  _name):.        
-0002c320: 2320 4372 6561 7465 7320 6120 7465 6d70  # Creates a temp
-0002c330: 6f72 6172 7920 7374 6f72 6167 6520 6f62  orary storage ob
-0002c340: 6a65 6374 2066 6f72 2074 6573 7469 6e67  ject for testing
-0002c350: 2062 756c 6b20 6465 6c65 7469 6f6e 2e0a   bulk deletion..
-0002c360: 2020 2020 2020 2020 2320 5374 6f72 6573          # Stores
-0002c370: 206d 7573 7420 6265 2061 6464 6564 2069   must be added i
-0002c380: 6e20 7468 6520 7465 7374 2e0a 2020 2020  n the test..    
-0002c390: 2020 2020 7769 7468 2074 656d 7066 696c      with tempfil
-0002c3a0: 652e 5465 6d70 6f72 6172 7944 6972 6563  e.TemporaryDirec
-0002c3b0: 746f 7279 2829 2061 7320 746d 7064 6972  tory() as tmpdir
-0002c3c0: 3a0a 2020 2020 2020 2020 2020 2020 7375  :.            su
-0002c3d0: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
-0002c3e0: 7574 7075 7428 6627 6d6b 6469 7220 2d70  utput(f'mkdir -p
-0002c3f0: 207b 746d 7064 6972 7d2f 666f 6c64 6572   {tmpdir}/folder
-0002c400: 7b7b 3030 302e 2e32 3535 7d7d 272c 0a20  {{000..255}}',. 
-0002c410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b420: 7374 6f72 6167 655f 6c69 622e 4162 7374  storage_lib.Abst
+0002b430: 7261 6374 5374 6f72 655d 5d20 3d20 4e6f  ractStore]] = No
+0002b440: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+0002b450: 7065 7273 6973 7465 6e74 3a20 4f70 7469  persistent: Opti
+0002b460: 6f6e 616c 5b62 6f6f 6c5d 203d 2054 7275  onal[bool] = Tru
+0002b470: 652c 0a20 2020 2020 2020 2020 2020 206d  e,.            m
+0002b480: 6f64 653a 2073 746f 7261 6765 5f6c 6962  ode: storage_lib
+0002b490: 2e53 746f 7261 6765 4d6f 6465 203d 2073  .StorageMode = s
+0002b4a0: 746f 7261 6765 5f6c 6962 2e53 746f 7261  torage_lib.Stora
+0002b4b0: 6765 4d6f 6465 2e4d 4f55 4e54 293a 0a20  geMode.MOUNT):. 
+0002b4c0: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
+0002b4d0: 2061 2074 656d 706f 7261 7279 2073 746f   a temporary sto
+0002b4e0: 7261 6765 206f 626a 6563 742e 2053 746f  rage object. Sto
+0002b4f0: 7265 7320 6d75 7374 2062 6520 6164 6465  res must be adde
+0002b500: 6420 696e 2074 6865 2074 6573 742e 0a20  d in the test.. 
+0002b510: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
+0002b520: 626a 203d 2073 746f 7261 6765 5f6c 6962  bj = storage_lib
+0002b530: 2e53 746f 7261 6765 286e 616d 653d 6e61  .Storage(name=na
+0002b540: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+0002b550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b560: 2020 2020 2020 2020 2020 2020 2020 736f                so
+0002b570: 7572 6365 3d73 6f75 7263 652c 0a20 2020  urce=source,.   
+0002b580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b5a0: 2020 2020 2020 2073 746f 7265 733d 7374         stores=st
+0002b5b0: 6f72 6573 2c0a 2020 2020 2020 2020 2020  ores,.          
+0002b5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b5e0: 7065 7273 6973 7465 6e74 3d70 6572 7369  persistent=persi
+0002b5f0: 7374 656e 742c 0a20 2020 2020 2020 2020  stent,.         
+0002b600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b620: 206d 6f64 653d 6d6f 6465 290a 2020 2020   mode=mode).    
+0002b630: 2020 2020 7969 656c 6420 7374 6f72 6167      yield storag
+0002b640: 655f 6f62 6a0a 2020 2020 2020 2020 6861  e_obj.        ha
+0002b650: 6e64 6c65 203d 2067 6c6f 6261 6c5f 7573  ndle = global_us
+0002b660: 6572 5f73 7461 7465 2e67 6574 5f68 616e  er_state.get_han
+0002b670: 646c 655f 6672 6f6d 5f73 746f 7261 6765  dle_from_storage
+0002b680: 5f6e 616d 6528 0a20 2020 2020 2020 2020  _name(.         
+0002b690: 2020 2073 746f 7261 6765 5f6f 626a 2e6e     storage_obj.n
+0002b6a0: 616d 6529 0a20 2020 2020 2020 2069 6620  ame).        if 
+0002b6b0: 6861 6e64 6c65 3a0a 2020 2020 2020 2020  handle:.        
+0002b6c0: 2020 2020 2320 4966 2068 616e 646c 6520      # If handle 
+0002b6d0: 6578 6973 7473 2c20 6465 6c65 7465 206d  exists, delete m
+0002b6e0: 616e 7561 6c6c 790a 2020 2020 2020 2020  anually.        
+0002b6f0: 2020 2020 2320 544f 444f 2872 6f6d 696c      # TODO(romil
+0002b700: 6229 3a20 5468 6973 2069 7320 706f 7465  b): This is pote
+0002b710: 6e74 6961 6c6c 7920 7269 736b 7920 2d20  ntially risky - 
+0002b720: 6966 2074 6865 2064 656c 6574 6520 6d65  if the delete me
+0002b730: 7468 6f64 2068 6173 0a20 2020 2020 2020  thod has.       
+0002b740: 2020 2020 2023 2020 2062 7567 732c 2074       #   bugs, t
+0002b750: 6869 7320 6361 6e20 6361 7573 6520 7265  his can cause re
+0002b760: 736f 7572 6365 206c 6561 6b73 2e20 4964  source leaks. Id
+0002b770: 6561 6c6c 7920 7765 2073 686f 756c 6420  eally we should 
+0002b780: 6d61 6e75 616c 6c79 0a20 2020 2020 2020  manually.       
+0002b790: 2020 2020 2023 2020 2065 6a65 6374 2073       #   eject s
+0002b7a0: 746f 7261 6765 2066 726f 6d20 676c 6f62  torage from glob
+0002b7b0: 616c 5f75 7365 725f 7374 6174 6520 616e  al_user_state an
+0002b7c0: 6420 6465 6c65 7465 2074 6865 2062 7563  d delete the buc
+0002b7d0: 6b65 7420 7573 696e 670a 2020 2020 2020  ket using.      
+0002b7e0: 2020 2020 2020 2320 2020 626f 746f 3320        #   boto3 
+0002b7f0: 6469 7265 6374 6c79 2e0a 2020 2020 2020  directly..      
+0002b800: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
+0002b810: 6a2e 6465 6c65 7465 2829 0a0a 2020 2020  j.delete()..    
+0002b820: 4070 7974 6573 742e 6669 7874 7572 650a  @pytest.fixture.
+0002b830: 2020 2020 6465 6620 746d 705f 7363 7261      def tmp_scra
+0002b840: 7463 685f 7374 6f72 6167 655f 6f62 6a28  tch_storage_obj(
+0002b850: 7365 6c66 2c20 746d 705f 6275 636b 6574  self, tmp_bucket
+0002b860: 5f6e 616d 6529 3a0a 2020 2020 2020 2020  _name):.        
+0002b870: 2320 4372 6561 7465 7320 6120 7374 6f72  # Creates a stor
+0002b880: 6167 6520 6f62 6a65 6374 2077 6974 6820  age object with 
+0002b890: 6e6f 2073 6f75 7263 6520 746f 2063 7265  no source to cre
+0002b8a0: 6174 6520 6120 7363 7261 7463 6820 7374  ate a scratch st
+0002b8b0: 6f72 6167 652e 0a20 2020 2020 2020 2023  orage..        #
+0002b8c0: 2053 746f 7265 7320 6d75 7374 2062 6520   Stores must be 
+0002b8d0: 6164 6465 6420 696e 2074 6865 2074 6573  added in the tes
+0002b8e0: 742e 0a20 2020 2020 2020 2079 6965 6c64  t..        yield
+0002b8f0: 2066 726f 6d20 7365 6c66 2e79 6965 6c64   from self.yield
+0002b900: 5f73 746f 7261 6765 5f6f 626a 6563 7428  _storage_object(
+0002b910: 6e61 6d65 3d74 6d70 5f62 7563 6b65 745f  name=tmp_bucket_
+0002b920: 6e61 6d65 290a 0a20 2020 2040 7079 7465  name)..    @pyte
+0002b930: 7374 2e66 6978 7475 7265 0a20 2020 2064  st.fixture.    d
+0002b940: 6566 2074 6d70 5f6d 756c 7469 706c 655f  ef tmp_multiple_
+0002b950: 7363 7261 7463 685f 7374 6f72 6167 655f  scratch_storage_
+0002b960: 6f62 6a28 7365 6c66 293a 0a20 2020 2020  obj(self):.     
+0002b970: 2020 2023 2043 7265 6174 6573 2061 206c     # Creates a l
+0002b980: 6973 7420 6f66 2035 2073 746f 7261 6765  ist of 5 storage
+0002b990: 206f 626a 6563 7473 2077 6974 6820 6e6f   objects with no
+0002b9a0: 2073 6f75 7263 6520 746f 2063 7265 6174   source to creat
+0002b9b0: 650a 2020 2020 2020 2020 2320 6d75 6c74  e.        # mult
+0002b9c0: 6970 6c65 2073 6372 6174 6368 2073 746f  iple scratch sto
+0002b9d0: 7261 6765 732e 0a20 2020 2020 2020 2023  rages..        #
+0002b9e0: 2053 746f 7265 7320 666f 7220 6561 6368   Stores for each
+0002b9f0: 206f 626a 6563 7420 696e 2074 6865 206c   object in the l
+0002ba00: 6973 7420 6d75 7374 2062 6520 6164 6465  ist must be adde
+0002ba10: 6420 696e 2074 6865 2074 6573 742e 0a20  d in the test.. 
+0002ba20: 2020 2020 2020 2073 746f 7261 6765 5f6d         storage_m
+0002ba30: 756c 745f 6f62 6a20 3d20 5b5d 0a20 2020  ult_obj = [].   
+0002ba40: 2020 2020 2066 6f72 205f 2069 6e20 7261       for _ in ra
+0002ba50: 6e67 6528 3529 3a0a 2020 2020 2020 2020  nge(5):.        
+0002ba60: 2020 2020 7469 6d65 7374 616d 7020 3d20      timestamp = 
+0002ba70: 7374 7228 7469 6d65 2e74 696d 6528 2929  str(time.time())
+0002ba80: 2e72 6570 6c61 6365 2827 2e27 2c20 2727  .replace('.', ''
+0002ba90: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
+0002baa0: 6f72 655f 6f62 6a20 3d20 7374 6f72 6167  ore_obj = storag
+0002bab0: 655f 6c69 622e 5374 6f72 6167 6528 6e61  e_lib.Storage(na
+0002bac0: 6d65 3d66 2773 6b79 2d74 6573 742d 7b74  me=f'sky-test-{t
+0002bad0: 696d 6573 7461 6d70 7d27 290a 2020 2020  imestamp}').    
+0002bae0: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
+0002baf0: 6d75 6c74 5f6f 626a 2e61 7070 656e 6428  mult_obj.append(
+0002bb00: 7374 6f72 655f 6f62 6a29 0a20 2020 2020  store_obj).     
+0002bb10: 2020 2079 6965 6c64 2073 746f 7261 6765     yield storage
+0002bb20: 5f6d 756c 745f 6f62 6a0a 2020 2020 2020  _mult_obj.      
+0002bb30: 2020 666f 7220 7374 6f72 6167 655f 6f62    for storage_ob
+0002bb40: 6a20 696e 2073 746f 7261 6765 5f6d 756c  j in storage_mul
+0002bb50: 745f 6f62 6a3a 0a20 2020 2020 2020 2020  t_obj:.         
+0002bb60: 2020 2068 616e 646c 6520 3d20 676c 6f62     handle = glob
+0002bb70: 616c 5f75 7365 725f 7374 6174 652e 6765  al_user_state.ge
+0002bb80: 745f 6861 6e64 6c65 5f66 726f 6d5f 7374  t_handle_from_st
+0002bb90: 6f72 6167 655f 6e61 6d65 280a 2020 2020  orage_name(.    
+0002bba0: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+0002bbb0: 6167 655f 6f62 6a2e 6e61 6d65 290a 2020  age_obj.name).  
+0002bbc0: 2020 2020 2020 2020 2020 6966 2068 616e            if han
+0002bbd0: 646c 653a 0a20 2020 2020 2020 2020 2020  dle:.           
+0002bbe0: 2020 2020 2023 2049 6620 6861 6e64 6c65       # If handle
+0002bbf0: 2065 7869 7374 732c 2064 656c 6574 6520   exists, delete 
+0002bc00: 6d61 6e75 616c 6c79 0a20 2020 2020 2020  manually.       
+0002bc10: 2020 2020 2020 2020 2023 2054 4f44 4f28           # TODO(
+0002bc20: 726f 6d69 6c62 293a 2054 6869 7320 6973  romilb): This is
+0002bc30: 2070 6f74 656e 7469 616c 6c79 2072 6973   potentially ris
+0002bc40: 6b79 202d 2069 6620 7468 6520 6465 6c65  ky - if the dele
+0002bc50: 7465 206d 6574 686f 6420 6861 730a 2020  te method has.  
+0002bc60: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0002bc70: 6275 6773 2c20 7468 6973 2063 616e 2063  bugs, this can c
+0002bc80: 6175 7365 2072 6573 6f75 7263 6520 6c65  ause resource le
+0002bc90: 616b 732e 2049 6465 616c 6c79 2077 6520  aks. Ideally we 
+0002bca0: 7368 6f75 6c64 206d 616e 7561 6c6c 790a  should manually.
+0002bcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bcc0: 2320 656a 6563 7420 7374 6f72 6167 6520  # eject storage 
+0002bcd0: 6672 6f6d 2067 6c6f 6261 6c5f 7573 6572  from global_user
+0002bce0: 5f73 7461 7465 2061 6e64 2064 656c 6574  _state and delet
+0002bcf0: 6520 7468 6520 6275 636b 6574 2075 7369  e the bucket usi
+0002bd00: 6e67 0a20 2020 2020 2020 2020 2020 2020  ng.             
+0002bd10: 2020 2023 2062 6f74 6f33 2064 6972 6563     # boto3 direc
+0002bd20: 746c 792e 0a20 2020 2020 2020 2020 2020  tly..           
+0002bd30: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
+0002bd40: 2e64 656c 6574 6528 290a 0a20 2020 2040  .delete()..    @
+0002bd50: 7079 7465 7374 2e66 6978 7475 7265 0a20  pytest.fixture. 
+0002bd60: 2020 2064 6566 2074 6d70 5f6d 756c 7469     def tmp_multi
+0002bd70: 706c 655f 6375 7374 6f6d 5f73 6f75 7263  ple_custom_sourc
+0002bd80: 655f 7374 6f72 6167 655f 6f62 6a28 7365  e_storage_obj(se
+0002bd90: 6c66 293a 0a20 2020 2020 2020 2023 2043  lf):.        # C
+0002bda0: 7265 6174 6573 2061 206c 6973 7420 6f66  reates a list of
+0002bdb0: 2073 746f 7261 6765 206f 626a 6563 7473   storage objects
+0002bdc0: 2077 6974 6820 6375 7374 6f6d 2073 6f75   with custom sou
+0002bdd0: 7263 6520 6e61 6d65 7320 746f 0a20 2020  rce names to.   
+0002bde0: 2020 2020 2023 2063 7265 6174 6520 6d75       # create mu
+0002bdf0: 6c74 6970 6c65 2073 6372 6174 6368 2073  ltiple scratch s
+0002be00: 746f 7261 6765 732e 0a20 2020 2020 2020  torages..       
+0002be10: 2023 2053 746f 7265 7320 666f 7220 6561   # Stores for ea
+0002be20: 6368 206f 626a 6563 7420 696e 2074 6865  ch object in the
+0002be30: 206c 6973 7420 6d75 7374 2062 6520 6164   list must be ad
+0002be40: 6465 6420 696e 2074 6865 2074 6573 742e  ded in the test.
+0002be50: 0a20 2020 2020 2020 2063 7573 746f 6d5f  .        custom_
+0002be60: 736f 7572 6365 5f6e 616d 6573 203d 205b  source_names = [
+0002be70: 2722 7061 7468 2057 6974 6820 5370 6163  '"path With Spac
+0002be80: 6573 2227 2c20 2770 6174 6820 5769 7468  es"', 'path With
+0002be90: 2053 7061 6365 7327 5d0a 2020 2020 2020   Spaces'].      
+0002bea0: 2020 7374 6f72 6167 655f 6d75 6c74 5f6f    storage_mult_o
+0002beb0: 626a 203d 205b 5d0a 2020 2020 2020 2020  bj = [].        
+0002bec0: 666f 7220 6e61 6d65 2069 6e20 6375 7374  for name in cust
+0002bed0: 6f6d 5f73 6f75 7263 655f 6e61 6d65 733a  om_source_names:
+0002bee0: 0a20 2020 2020 2020 2020 2020 2073 7263  .            src
+0002bef0: 5f70 6174 6820 3d20 6f73 2e70 6174 682e  _path = os.path.
+0002bf00: 6578 7061 6e64 7573 6572 2866 277e 2f7b  expanduser(f'~/{
+0002bf10: 6e61 6d65 7d27 290a 2020 2020 2020 2020  name}').        
+0002bf20: 2020 2020 7061 7468 6c69 622e 5061 7468      pathlib.Path
+0002bf30: 2873 7263 5f70 6174 6829 2e65 7870 616e  (src_path).expan
+0002bf40: 6475 7365 7228 292e 6d6b 6469 7228 6578  duser().mkdir(ex
+0002bf50: 6973 745f 6f6b 3d54 7275 6529 0a20 2020  ist_ok=True).   
+0002bf60: 2020 2020 2020 2020 2074 696d 6573 7461           timesta
+0002bf70: 6d70 203d 2073 7472 2874 696d 652e 7469  mp = str(time.ti
+0002bf80: 6d65 2829 292e 7265 706c 6163 6528 272e  me()).replace('.
+0002bf90: 272c 2027 2729 0a20 2020 2020 2020 2020  ', '').         
+0002bfa0: 2020 2073 746f 7265 5f6f 626a 203d 2073     store_obj = s
+0002bfb0: 746f 7261 6765 5f6c 6962 2e53 746f 7261  torage_lib.Stora
+0002bfc0: 6765 286e 616d 653d 6627 736b 792d 7465  ge(name=f'sky-te
+0002bfd0: 7374 2d7b 7469 6d65 7374 616d 707d 272c  st-{timestamp}',
+0002bfe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002bff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c000: 2020 2020 2020 2020 2020 2020 2073 6f75               sou
+0002c010: 7263 653d 7372 635f 7061 7468 290a 2020  rce=src_path).  
+0002c020: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+0002c030: 655f 6d75 6c74 5f6f 626a 2e61 7070 656e  e_mult_obj.appen
+0002c040: 6428 7374 6f72 655f 6f62 6a29 0a20 2020  d(store_obj).   
+0002c050: 2020 2020 2079 6965 6c64 2073 746f 7261       yield stora
+0002c060: 6765 5f6d 756c 745f 6f62 6a0a 2020 2020  ge_mult_obj.    
+0002c070: 2020 2020 666f 7220 7374 6f72 6167 655f      for storage_
+0002c080: 6f62 6a20 696e 2073 746f 7261 6765 5f6d  obj in storage_m
+0002c090: 756c 745f 6f62 6a3a 0a20 2020 2020 2020  ult_obj:.       
+0002c0a0: 2020 2020 2068 616e 646c 6520 3d20 676c       handle = gl
+0002c0b0: 6f62 616c 5f75 7365 725f 7374 6174 652e  obal_user_state.
+0002c0c0: 6765 745f 6861 6e64 6c65 5f66 726f 6d5f  get_handle_from_
+0002c0d0: 7374 6f72 6167 655f 6e61 6d65 280a 2020  storage_name(.  
+0002c0e0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0002c0f0: 6f72 6167 655f 6f62 6a2e 6e61 6d65 290a  orage_obj.name).
+0002c100: 2020 2020 2020 2020 2020 2020 6966 2068              if h
+0002c110: 616e 646c 653a 0a20 2020 2020 2020 2020  andle:.         
+0002c120: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
+0002c130: 626a 2e64 656c 6574 6528 290a 0a20 2020  bj.delete()..   
+0002c140: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
+0002c150: 0a20 2020 2064 6566 2074 6d70 5f6c 6f63  .    def tmp_loc
+0002c160: 616c 5f73 746f 7261 6765 5f6f 626a 2873  al_storage_obj(s
+0002c170: 656c 662c 2074 6d70 5f62 7563 6b65 745f  elf, tmp_bucket_
+0002c180: 6e61 6d65 2c20 746d 705f 736f 7572 6365  name, tmp_source
+0002c190: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
+0002c1a0: 6174 6573 2061 2074 656d 706f 7261 7279  ates a temporary
+0002c1b0: 2073 746f 7261 6765 206f 626a 6563 742e   storage object.
+0002c1c0: 2053 746f 7265 7320 6d75 7374 2062 6520   Stores must be 
+0002c1d0: 6164 6465 6420 696e 2074 6865 2074 6573  added in the tes
+0002c1e0: 742e 0a20 2020 2020 2020 2079 6965 6c64  t..        yield
+0002c1f0: 2066 726f 6d20 7365 6c66 2e79 6965 6c64   from self.yield
+0002c200: 5f73 746f 7261 6765 5f6f 626a 6563 7428  _storage_object(
+0002c210: 6e61 6d65 3d74 6d70 5f62 7563 6b65 745f  name=tmp_bucket_
+0002c220: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+0002c230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c250: 2020 2073 6f75 7263 653d 746d 705f 736f     source=tmp_so
+0002c260: 7572 6365 290a 0a20 2020 2040 7079 7465  urce)..    @pyte
+0002c270: 7374 2e66 6978 7475 7265 0a20 2020 2064  st.fixture.    d
+0002c280: 6566 2074 6d70 5f6c 6f63 616c 5f6c 6973  ef tmp_local_lis
+0002c290: 745f 7374 6f72 6167 655f 6f62 6a28 7365  t_storage_obj(se
+0002c2a0: 6c66 2c20 746d 705f 6275 636b 6574 5f6e  lf, tmp_bucket_n
+0002c2b0: 616d 652c 2074 6d70 5f73 6f75 7263 6529  ame, tmp_source)
+0002c2c0: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
+0002c2d0: 7465 7320 6120 7465 6d70 2073 746f 7261  tes a temp stora
+0002c2e0: 6765 206f 626a 6563 7420 7768 6963 6820  ge object which 
+0002c2f0: 7573 6573 2061 206c 6973 7420 6f66 2070  uses a list of p
+0002c300: 6174 6873 2061 7320 736f 7572 6365 2e0a  aths as source..
+0002c310: 2020 2020 2020 2020 2320 5374 6f72 6573          # Stores
+0002c320: 206d 7573 7420 6265 2061 6464 6564 2069   must be added i
+0002c330: 6e20 7468 6520 7465 7374 2e20 4166 7465  n the test. Afte
+0002c340: 7220 7570 6c6f 6164 2c20 7468 6520 6275  r upload, the bu
+0002c350: 636b 6574 2073 686f 756c 640a 2020 2020  cket should.    
+0002c360: 2020 2020 2320 6861 7665 2074 776f 2066      # have two f
+0002c370: 696c 6573 202d 202f 746d 702d 6669 6c65  iles - /tmp-file
+0002c380: 2061 6e64 202f 746d 702d 736f 7572 6365   and /tmp-source
+0002c390: 2f74 6d70 2d66 696c 650a 2020 2020 2020  /tmp-file.      
+0002c3a0: 2020 6c69 7374 5f73 6f75 7263 6520 3d20    list_source = 
+0002c3b0: 5b74 6d70 5f73 6f75 7263 652c 2074 6d70  [tmp_source, tmp
+0002c3c0: 5f73 6f75 7263 6520 2b20 272f 746d 702d  _source + '/tmp-
+0002c3d0: 6669 6c65 275d 0a20 2020 2020 2020 2079  file'].        y
+0002c3e0: 6965 6c64 2066 726f 6d20 7365 6c66 2e79  ield from self.y
+0002c3f0: 6965 6c64 5f73 746f 7261 6765 5f6f 626a  ield_storage_obj
+0002c400: 6563 7428 6e61 6d65 3d74 6d70 5f62 7563  ect(name=tmp_buc
+0002c410: 6b65 745f 6e61 6d65 2c0a 2020 2020 2020  ket_name,.      
 0002c420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c430: 2020 2073 6865 6c6c 3d54 7275 6529 0a20     shell=True). 
-0002c440: 2020 2020 2020 2020 2020 2073 7562 7072             subpr
-0002c450: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-0002c460: 7574 2866 2774 6f75 6368 207b 746d 7064  ut(f'touch {tmpd
-0002c470: 6972 7d2f 7465 7374 7b7b 3030 302e 2e32  ir}/test{{000..2
-0002c480: 3535 7d7d 2e74 7874 272c 0a20 2020 2020  55}}.txt',.     
-0002c490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c4a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002c4b0: 6865 6c6c 3d54 7275 6529 0a20 2020 2020  hell=True).     
-0002c4c0: 2020 2020 2020 2073 7562 7072 6f63 6573         subproces
-0002c4d0: 732e 6368 6563 6b5f 6f75 7470 7574 280a  s.check_output(.
-0002c4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c4f0: 6627 746f 7563 6820 7b74 6d70 6469 727d  f'touch {tmpdir}
-0002c500: 2f66 6f6c 6465 727b 7b30 3030 2e2e 3235  /folder{{000..25
-0002c510: 357d 7d2f 7465 7374 2e74 7874 272c 2073  5}}/test.txt', s
-0002c520: 6865 6c6c 3d54 7275 6529 0a20 2020 2020  hell=True).     
-0002c530: 2020 2020 2020 2079 6965 6c64 2066 726f         yield fro
-0002c540: 6d20 7365 6c66 2e79 6965 6c64 5f73 746f  m self.yield_sto
-0002c550: 7261 6765 5f6f 626a 6563 7428 6e61 6d65  rage_object(name
-0002c560: 3d74 6d70 5f62 7563 6b65 745f 6e61 6d65  =tmp_bucket_name
-0002c570: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002c580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c5a0: 2020 2073 6f75 7263 653d 746d 7064 6972     source=tmpdir
-0002c5b0: 290a 0a20 2020 2040 7079 7465 7374 2e66  )..    @pytest.f
-0002c5c0: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
-0002c5d0: 6d70 5f63 6f70 795f 6d6e 745f 6578 6973  mp_copy_mnt_exis
-0002c5e0: 7469 6e67 5f73 746f 7261 6765 5f6f 626a  ting_storage_obj
-0002c5f0: 2873 656c 662c 2074 6d70 5f73 6372 6174  (self, tmp_scrat
-0002c600: 6368 5f73 746f 7261 6765 5f6f 626a 293a  ch_storage_obj):
-0002c610: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
-0002c620: 6573 2061 2063 6f70 7920 6d6f 756e 7420  es a copy mount 
-0002c630: 7374 6f72 6167 6520 7768 6963 6820 7265  storage which re
-0002c640: 7573 6573 2061 6e20 6578 6973 7469 6e67  uses an existing
-0002c650: 2073 746f 7261 6765 206f 626a 6563 742e   storage object.
-0002c660: 0a20 2020 2020 2020 2074 6d70 5f73 6372  .        tmp_scr
-0002c670: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
-0002c680: 2e61 6464 5f73 746f 7265 2873 746f 7261  .add_store(stora
-0002c690: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-0002c6a0: 2e53 3329 0a20 2020 2020 2020 2073 746f  .S3).        sto
-0002c6b0: 7261 6765 5f6e 616d 6520 3d20 746d 705f  rage_name = tmp_
-0002c6c0: 7363 7261 7463 685f 7374 6f72 6167 655f  scratch_storage_
-0002c6d0: 6f62 6a2e 6e61 6d65 0a0a 2020 2020 2020  obj.name..      
-0002c6e0: 2020 2320 5472 7920 746f 2069 6e69 7469    # Try to initi
-0002c6f0: 616c 697a 6520 616e 6f74 6865 7220 7374  alize another st
-0002c700: 6f72 6167 6520 7769 7468 2074 6865 2073  orage with the s
-0002c710: 746f 7261 6765 206f 626a 6563 7420 6372  torage object cr
-0002c720: 6561 7465 640a 2020 2020 2020 2020 2320  eated.        # 
-0002c730: 6162 6f76 652c 2062 7574 206e 6f77 2069  above, but now i
-0002c740: 6e20 434f 5059 206d 6f64 652e 2054 6869  n COPY mode. Thi
-0002c750: 7320 7368 6f75 6c64 2073 7563 6365 6564  s should succeed
-0002c760: 2e0a 2020 2020 2020 2020 7969 656c 6420  ..        yield 
-0002c770: 6672 6f6d 2073 656c 662e 7969 656c 645f  from self.yield_
-0002c780: 7374 6f72 6167 655f 6f62 6a65 6374 286e  storage_object(n
-0002c790: 616d 653d 7374 6f72 6167 655f 6e61 6d65  ame=storage_name
-0002c7a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002c7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c7c0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0002c7d0: 6f64 653d 7374 6f72 6167 655f 6c69 622e  ode=storage_lib.
-0002c7e0: 5374 6f72 6167 654d 6f64 652e 434f 5059  StorageMode.COPY
-0002c7f0: 290a 0a20 2020 2040 7079 7465 7374 2e66  )..    @pytest.f
-0002c800: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
-0002c810: 6d70 5f67 6974 6967 6e6f 7265 5f73 746f  mp_gitignore_sto
-0002c820: 7261 6765 5f6f 626a 2873 656c 662c 2074  rage_obj(self, t
-0002c830: 6d70 5f62 7563 6b65 745f 6e61 6d65 2c20  mp_bucket_name, 
-0002c840: 6769 7469 676e 6f72 655f 7374 7275 6374  gitignore_struct
-0002c850: 7572 6529 3a0a 2020 2020 2020 2020 2320  ure):.        # 
-0002c860: 4372 6561 7465 7320 6120 7465 6d70 6f72  Creates a tempor
-0002c870: 6172 7920 7374 6f72 6167 6520 6f62 6a65  ary storage obje
-0002c880: 6374 2066 6f72 2074 6573 7469 6e67 202e  ct for testing .
-0002c890: 6769 7469 676e 6f72 6520 6669 6c74 6572  gitignore filter
-0002c8a0: 2e0a 2020 2020 2020 2020 2320 4749 5449  ..        # GITI
-0002c8b0: 4749 4e4f 5245 5f53 5452 5543 5455 5245  GINORE_STRUCTURE
-0002c8c0: 2069 7320 7265 7072 6573 656e 7469 6e67   is representing
-0002c8d0: 2061 2066 696c 6520 7374 7275 6374 7572   a file structur
-0002c8e0: 6520 696e 2061 2064 6963 7469 6f6e 6172  e in a dictionar
-0002c8f0: 790a 2020 2020 2020 2020 2320 666f 726d  y.        # form
-0002c900: 6174 2e20 4372 6561 7465 6420 7374 6f72  at. Created stor
-0002c910: 6167 6520 6f62 6a65 6374 2077 696c 6c20  age object will 
-0002c920: 636f 6e74 6169 6e20 7468 6520 6669 6c65  contain the file
-0002c930: 2073 7472 7563 7475 7265 2061 6c6f 6e67   structure along
-0002c940: 0a20 2020 2020 2020 2023 2077 6974 6820  .        # with 
-0002c950: 2e67 6974 6967 6e6f 7265 2061 6e64 202e  .gitignore and .
-0002c960: 6769 742f 696e 666f 2f65 7863 6c75 6465  git/info/exclude
-0002c970: 2066 696c 6573 2074 6f20 7465 7374 2065   files to test e
-0002c980: 7863 6c75 6465 2066 696c 7465 722e 0a20  xclude filter.. 
-0002c990: 2020 2020 2020 2023 2053 746f 7265 7320         # Stores 
-0002c9a0: 6d75 7374 2062 6520 6164 6465 6420 696e  must be added in
-0002c9b0: 2074 6865 2074 6573 742e 0a20 2020 2020   the test..     
-0002c9c0: 2020 2077 6974 6820 7465 6d70 6669 6c65     with tempfile
-0002c9d0: 2e54 656d 706f 7261 7279 4469 7265 6374  .TemporaryDirect
-0002c9e0: 6f72 7928 2920 6173 2074 6d70 6469 723a  ory() as tmpdir:
-0002c9f0: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
-0002ca00: 7265 6174 6573 2066 696c 6520 7374 7275  reates file stru
-0002ca10: 6374 7572 6520 746f 2062 6520 7570 6c6f  cture to be uplo
-0002ca20: 6164 6564 2069 6e20 7468 6520 5374 6f72  aded in the Stor
-0002ca30: 6167 650a 2020 2020 2020 2020 2020 2020  age.            
-0002ca40: 7365 6c66 2e63 7265 6174 655f 6469 725f  self.create_dir_
-0002ca50: 7374 7275 6374 7572 6528 746d 7064 6972  structure(tmpdir
-0002ca60: 2c20 6769 7469 676e 6f72 655f 7374 7275  , gitignore_stru
-0002ca70: 6374 7572 6529 0a0a 2020 2020 2020 2020  cture)..        
-0002ca80: 2020 2020 2320 4372 6561 7465 202e 6769      # Create .gi
-0002ca90: 7469 676e 6f72 6520 616e 6420 6c69 7374  tignore and list
-0002caa0: 2066 696c 6573 2f64 6972 7320 746f 2062   files/dirs to b
-0002cab0: 6520 6578 636c 7564 6564 2069 6e20 6974  e excluded in it
-0002cac0: 0a20 2020 2020 2020 2020 2020 2073 6b79  .            sky
-0002cad0: 7069 6c6f 745f 7061 7468 203d 206f 732e  pilot_path = os.
-0002cae0: 7061 7468 2e64 6972 6e61 6d65 286f 732e  path.dirname(os.
-0002caf0: 7061 7468 2e64 6972 6e61 6d65 2873 6b79  path.dirname(sky
-0002cb00: 2e5f 5f66 696c 655f 5f29 290a 2020 2020  .__file__)).    
-0002cb10: 2020 2020 2020 2020 7465 6d70 5f70 6174          temp_pat
-0002cb20: 6820 3d20 6627 7b74 6d70 6469 727d 2f2e  h = f'{tmpdir}/.
-0002cb30: 6769 7469 676e 6f72 6527 0a20 2020 2020  gitignore'.     
-0002cb40: 2020 2020 2020 2066 696c 655f 7061 7468         file_path
-0002cb50: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
-0002cb60: 736b 7970 696c 6f74 5f70 6174 682c 2027  skypilot_path, '
-0002cb70: 7465 7374 732f 6769 7469 676e 6f72 655f  tests/gitignore_
-0002cb80: 7465 7374 2729 0a20 2020 2020 2020 2020  test').         
-0002cb90: 2020 2073 6875 7469 6c2e 636f 7079 6669     shutil.copyfi
-0002cba0: 6c65 2866 696c 655f 7061 7468 2c20 7465  le(file_path, te
-0002cbb0: 6d70 5f70 6174 6829 0a0a 2020 2020 2020  mp_path)..      
-0002cbc0: 2020 2020 2020 2320 4372 6561 7465 202e        # Create .
-0002cbd0: 6769 742f 696e 666f 2f65 7863 6c75 6465  git/info/exclude
-0002cbe0: 2061 6e64 206c 6973 7420 6669 6c65 732f   and list files/
-0002cbf0: 6469 7273 2074 6f20 6265 2065 7863 6c75  dirs to be exclu
-0002cc00: 6465 6420 696e 2069 740a 2020 2020 2020  ded in it.      
-0002cc10: 2020 2020 2020 7465 6d70 5f70 6174 6820        temp_path 
-0002cc20: 3d20 6627 7b74 6d70 6469 727d 2f2e 6769  = f'{tmpdir}/.gi
-0002cc30: 742f 696e 666f 2f27 0a20 2020 2020 2020  t/info/'.       
-0002cc40: 2020 2020 206f 732e 6d61 6b65 6469 7273       os.makedirs
-0002cc50: 2874 656d 705f 7061 7468 290a 2020 2020  (temp_path).    
-0002cc60: 2020 2020 2020 2020 7465 6d70 5f65 7863          temp_exc
-0002cc70: 6c75 6465 5f70 6174 6820 3d20 6f73 2e70  lude_path = os.p
-0002cc80: 6174 682e 6a6f 696e 2874 656d 705f 7061  ath.join(temp_pa
-0002cc90: 7468 2c20 2765 7863 6c75 6465 2729 0a20  th, 'exclude'). 
-0002cca0: 2020 2020 2020 2020 2020 2066 696c 655f             file_
-0002ccb0: 7061 7468 203d 206f 732e 7061 7468 2e6a  path = os.path.j
-0002ccc0: 6f69 6e28 736b 7970 696c 6f74 5f70 6174  oin(skypilot_pat
-0002ccd0: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
-0002cce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ccf0: 2020 2020 2020 2020 2774 6573 7473 2f67          'tests/g
-0002cd00: 6974 5f69 6e66 6f5f 6578 636c 7564 655f  it_info_exclude_
-0002cd10: 7465 7374 2729 0a20 2020 2020 2020 2020  test').         
-0002cd20: 2020 2073 6875 7469 6c2e 636f 7079 6669     shutil.copyfi
-0002cd30: 6c65 2866 696c 655f 7061 7468 2c20 7465  le(file_path, te
-0002cd40: 6d70 5f65 7863 6c75 6465 5f70 6174 6829  mp_exclude_path)
-0002cd50: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0002cd60: 4372 6561 7465 2073 6b79 2053 746f 7261  Create sky Stora
-0002cd70: 6765 2077 6974 6820 7468 6520 6669 6c65  ge with the file
-0002cd80: 7320 6372 6561 7465 640a 2020 2020 2020  s created.      
-0002cd90: 2020 2020 2020 7969 656c 6420 6672 6f6d        yield from
-0002cda0: 2073 656c 662e 7969 656c 645f 7374 6f72   self.yield_stor
-0002cdb0: 6167 655f 6f62 6a65 6374 280a 2020 2020  age_object(.    
-0002cdc0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-0002cdd0: 3d74 6d70 5f62 7563 6b65 745f 6e61 6d65  =tmp_bucket_name
-0002cde0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002cdf0: 2020 736f 7572 6365 3d74 6d70 6469 722c    source=tmpdir,
-0002ce00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ce10: 206d 6f64 653d 7374 6f72 6167 655f 6c69   mode=storage_li
-0002ce20: 622e 5374 6f72 6167 654d 6f64 652e 434f  b.StorageMode.CO
-0002ce30: 5059 290a 0a20 2020 2040 7079 7465 7374  PY)..    @pytest
-0002ce40: 2e66 6978 7475 7265 0a20 2020 2064 6566  .fixture.    def
-0002ce50: 2074 6d70 5f61 7773 636c 695f 6275 636b   tmp_awscli_buck
-0002ce60: 6574 2873 656c 662c 2074 6d70 5f62 7563  et(self, tmp_buc
-0002ce70: 6b65 745f 6e61 6d65 293a 0a20 2020 2020  ket_name):.     
-0002ce80: 2020 2023 2043 7265 6174 6573 2061 2074     # Creates a t
-0002ce90: 656d 706f 7261 7279 2062 7563 6b65 7420  emporary bucket 
-0002cea0: 7573 696e 6720 6177 7363 6c69 0a20 2020  using awscli.   
-0002ceb0: 2020 2020 2062 7563 6b65 745f 7572 6920       bucket_uri 
-0002cec0: 3d20 6627 7333 3a2f 2f7b 746d 705f 6275  = f's3://{tmp_bu
-0002ced0: 636b 6574 5f6e 616d 657d 270a 2020 2020  cket_name}'.    
-0002cee0: 2020 2020 7375 6270 726f 6365 7373 2e63      subprocess.c
-0002cef0: 6865 636b 5f63 616c 6c28 5b27 6177 7327  heck_call(['aws'
-0002cf00: 2c20 2773 3327 2c20 276d 6227 2c20 6275  , 's3', 'mb', bu
-0002cf10: 636b 6574 5f75 7269 5d29 0a20 2020 2020  cket_uri]).     
-0002cf20: 2020 2079 6965 6c64 2074 6d70 5f62 7563     yield tmp_buc
-0002cf30: 6b65 745f 6e61 6d65 2c20 6275 636b 6574  ket_name, bucket
-0002cf40: 5f75 7269 0a20 2020 2020 2020 2073 7562  _uri.        sub
-0002cf50: 7072 6f63 6573 732e 6368 6563 6b5f 6361  process.check_ca
-0002cf60: 6c6c 285b 2761 7773 272c 2027 7333 272c  ll(['aws', 's3',
-0002cf70: 2027 7262 272c 2062 7563 6b65 745f 7572   'rb', bucket_ur
-0002cf80: 692c 2027 2d2d 666f 7263 6527 5d29 0a0a  i, '--force'])..
-0002cf90: 2020 2020 4070 7974 6573 742e 6669 7874      @pytest.fixt
-0002cfa0: 7572 650a 2020 2020 6465 6620 746d 705f  ure.    def tmp_
-0002cfb0: 6773 7574 696c 5f62 7563 6b65 7428 7365  gsutil_bucket(se
-0002cfc0: 6c66 2c20 746d 705f 6275 636b 6574 5f6e  lf, tmp_bucket_n
-0002cfd0: 616d 6529 3a0a 2020 2020 2020 2020 2320  ame):.        # 
-0002cfe0: 4372 6561 7465 7320 6120 7465 6d70 6f72  Creates a tempor
-0002cff0: 6172 7920 6275 636b 6574 2075 7369 6e67  ary bucket using
-0002d000: 2067 7375 7469 6c0a 2020 2020 2020 2020   gsutil.        
-0002d010: 6275 636b 6574 5f75 7269 203d 2066 2767  bucket_uri = f'g
-0002d020: 733a 2f2f 7b74 6d70 5f62 7563 6b65 745f  s://{tmp_bucket_
-0002d030: 6e61 6d65 7d27 0a20 2020 2020 2020 2073  name}'.        s
-0002d040: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-0002d050: 6361 6c6c 285b 2767 7375 7469 6c27 2c20  call(['gsutil', 
-0002d060: 276d 6227 2c20 6275 636b 6574 5f75 7269  'mb', bucket_uri
-0002d070: 5d29 0a20 2020 2020 2020 2079 6965 6c64  ]).        yield
-0002d080: 2074 6d70 5f62 7563 6b65 745f 6e61 6d65   tmp_bucket_name
-0002d090: 2c20 6275 636b 6574 5f75 7269 0a20 2020  , bucket_uri.   
-0002d0a0: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
-0002d0b0: 6368 6563 6b5f 6361 6c6c 285b 2767 7375  check_call(['gsu
-0002d0c0: 7469 6c27 2c20 2772 6d27 2c20 272d 7227  til', 'rm', '-r'
-0002d0d0: 2c20 6275 636b 6574 5f75 7269 5d29 0a0a  , bucket_uri])..
-0002d0e0: 2020 2020 4070 7974 6573 742e 6669 7874      @pytest.fixt
-0002d0f0: 7572 650a 2020 2020 6465 6620 746d 705f  ure.    def tmp_
-0002d100: 6177 7363 6c69 5f62 7563 6b65 745f 7232  awscli_bucket_r2
-0002d110: 2873 656c 662c 2074 6d70 5f62 7563 6b65  (self, tmp_bucke
-0002d120: 745f 6e61 6d65 293a 0a20 2020 2020 2020  t_name):.       
-0002d130: 2023 2043 7265 6174 6573 2061 2074 656d   # Creates a tem
-0002d140: 706f 7261 7279 2062 7563 6b65 7420 7573  porary bucket us
-0002d150: 696e 6720 6177 7363 6c69 0a20 2020 2020  ing awscli.     
-0002d160: 2020 2065 6e64 706f 696e 745f 7572 6c20     endpoint_url 
-0002d170: 3d20 636c 6f75 6466 6c61 7265 2e63 7265  = cloudflare.cre
-0002d180: 6174 655f 656e 6470 6f69 6e74 2829 0a20  ate_endpoint(). 
-0002d190: 2020 2020 2020 2062 7563 6b65 745f 7572         bucket_ur
-0002d1a0: 6920 3d20 6627 7333 3a2f 2f7b 746d 705f  i = f's3://{tmp_
-0002d1b0: 6275 636b 6574 5f6e 616d 657d 270a 2020  bucket_name}'.  
-0002d1c0: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
-0002d1d0: 2e63 6865 636b 5f63 616c 6c28 0a20 2020  .check_call(.   
-0002d1e0: 2020 2020 2020 2020 2066 2741 5753 5f53           f'AWS_S
-0002d1f0: 4841 5245 445f 4352 4544 454e 5449 414c  HARED_CREDENTIAL
-0002d200: 535f 4649 4c45 3d7b 636c 6f75 6466 6c61  S_FILE={cloudfla
-0002d210: 7265 2e52 325f 4352 4544 454e 5449 414c  re.R2_CREDENTIAL
-0002d220: 535f 5041 5448 7d20 6177 7320 7333 206d  S_PATH} aws s3 m
-0002d230: 6220 7b62 7563 6b65 745f 7572 697d 202d  b {bucket_uri} -
-0002d240: 2d65 6e64 706f 696e 7420 7b65 6e64 706f  -endpoint {endpo
-0002d250: 696e 745f 7572 6c7d 202d 2d70 726f 6669  int_url} --profi
-0002d260: 6c65 3d72 3227 2c0a 2020 2020 2020 2020  le=r2',.        
-0002d270: 2020 2020 7368 656c 6c3d 5472 7565 290a      shell=True).
-0002d280: 2020 2020 2020 2020 7969 656c 6420 746d          yield tm
-0002d290: 705f 6275 636b 6574 5f6e 616d 652c 2062  p_bucket_name, b
-0002d2a0: 7563 6b65 745f 7572 690a 2020 2020 2020  ucket_uri.      
-0002d2b0: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
-0002d2c0: 636b 5f63 616c 6c28 0a20 2020 2020 2020  ck_call(.       
-0002d2d0: 2020 2020 2066 2741 5753 5f53 4841 5245       f'AWS_SHARE
-0002d2e0: 445f 4352 4544 454e 5449 414c 535f 4649  D_CREDENTIALS_FI
-0002d2f0: 4c45 3d7b 636c 6f75 6466 6c61 7265 2e52  LE={cloudflare.R
-0002d300: 325f 4352 4544 454e 5449 414c 535f 5041  2_CREDENTIALS_PA
-0002d310: 5448 7d20 6177 7320 7333 2072 6220 7b62  TH} aws s3 rb {b
-0002d320: 7563 6b65 745f 7572 697d 202d 2d66 6f72  ucket_uri} --for
-0002d330: 6365 202d 2d65 6e64 706f 696e 7420 7b65  ce --endpoint {e
-0002d340: 6e64 706f 696e 745f 7572 6c7d 202d 2d70  ndpoint_url} --p
-0002d350: 726f 6669 6c65 3d72 3227 2c0a 2020 2020  rofile=r2',.    
-0002d360: 2020 2020 2020 2020 7368 656c 6c3d 5472          shell=Tr
-0002d370: 7565 290a 0a20 2020 2040 7079 7465 7374  ue)..    @pytest
-0002d380: 2e66 6978 7475 7265 0a20 2020 2064 6566  .fixture.    def
-0002d390: 2074 6d70 5f69 626d 5f63 6f73 5f62 7563   tmp_ibm_cos_buc
-0002d3a0: 6b65 7428 7365 6c66 2c20 746d 705f 6275  ket(self, tmp_bu
-0002d3b0: 636b 6574 5f6e 616d 6529 3a0a 2020 2020  cket_name):.    
-0002d3c0: 2020 2020 2320 4372 6561 7465 7320 6120      # Creates a 
-0002d3d0: 7465 6d70 6f72 6172 7920 6275 636b 6574  temporary bucket
-0002d3e0: 2075 7369 6e67 2049 424d 2043 4f53 2041   using IBM COS A
-0002d3f0: 5049 0a20 2020 2020 2020 2073 746f 7261  PI.        stora
-0002d400: 6765 5f6f 626a 203d 2073 746f 7261 6765  ge_obj = storage
-0002d410: 5f6c 6962 2e49 424d 436f 7353 746f 7265  _lib.IBMCosStore
-0002d420: 2873 6f75 7263 653d 2222 2c20 6e61 6d65  (source="", name
-0002d430: 3d74 6d70 5f62 7563 6b65 745f 6e61 6d65  =tmp_bucket_name
-0002d440: 290a 2020 2020 2020 2020 7969 656c 6420  ).        yield 
-0002d450: 746d 705f 6275 636b 6574 5f6e 616d 650a  tmp_bucket_name.
-0002d460: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-0002d470: 6f62 6a2e 6465 6c65 7465 2829 0a0a 2020  obj.delete()..  
-0002d480: 2020 4070 7974 6573 742e 6669 7874 7572    @pytest.fixtur
-0002d490: 650a 2020 2020 6465 6620 746d 705f 7075  e.    def tmp_pu
-0002d4a0: 626c 6963 5f73 746f 7261 6765 5f6f 626a  blic_storage_obj
-0002d4b0: 2873 656c 662c 2072 6571 7565 7374 293a  (self, request):
-0002d4c0: 0a20 2020 2020 2020 2023 2049 6e69 7469  .        # Initi
-0002d4d0: 616c 697a 6573 2061 2073 746f 7261 6765  alizes a storage
-0002d4e0: 206f 626a 6563 7420 7769 7468 2061 2070   object with a p
-0002d4f0: 7562 6c69 6320 6275 636b 6574 0a20 2020  ublic bucket.   
-0002d500: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
-0002d510: 203d 2073 746f 7261 6765 5f6c 6962 2e53   = storage_lib.S
-0002d520: 746f 7261 6765 2873 6f75 7263 653d 7265  torage(source=re
-0002d530: 7175 6573 742e 7061 7261 6d29 0a20 2020  quest.param).   
-0002d540: 2020 2020 2079 6965 6c64 2073 746f 7261       yield stora
-0002d550: 6765 5f6f 626a 0a20 2020 2020 2020 2023  ge_obj.        #
-0002d560: 2054 6869 7320 646f 6573 206e 6f74 2072   This does not r
-0002d570: 6571 7569 7265 2061 6e79 2064 656c 6574  equire any delet
-0002d580: 696f 6e20 6c6f 6769 6320 6265 6361 7573  ion logic becaus
-0002d590: 6520 6974 2069 7320 6120 7075 626c 6963  e it is a public
-0002d5a0: 2062 7563 6b65 740a 2020 2020 2020 2020   bucket.        
-0002d5b0: 2320 616e 6420 7368 6f75 6c64 206e 6f74  # and should not
-0002d5c0: 2067 6574 2061 6464 6564 2074 6f20 676c   get added to gl
-0002d5d0: 6f62 616c 5f75 7365 725f 7374 6174 652e  obal_user_state.
-0002d5e0: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
-0002d5f0: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
-0002d600: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0002d610: 6b2e 7061 7261 6d65 7472 697a 6528 2773  k.parametrize('s
-0002d620: 746f 7265 5f74 7970 6527 2c20 5b0a 2020  tore_type', [.  
-0002d630: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
-0002d640: 622e 5374 6f72 6554 7970 652e 5333 2c20  b.StoreType.S3, 
-0002d650: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002d660: 6554 7970 652e 4743 532c 0a20 2020 2020  eType.GCS,.     
-0002d670: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
-0002d680: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002d690: 6554 7970 652e 4942 4d2c 206d 6172 6b73  eType.IBM, marks
-0002d6a0: 3d70 7974 6573 742e 6d61 726b 2e69 626d  =pytest.mark.ibm
-0002d6b0: 292c 0a20 2020 2020 2020 2070 7974 6573  ),.        pytes
-0002d6c0: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
-0002d6d0: 6c69 622e 5374 6f72 6554 7970 652e 5232  lib.StoreType.R2
-0002d6e0: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
-0002d6f0: 6172 6b2e 636c 6f75 6466 6c61 7265 290a  ark.cloudflare).
-0002d700: 2020 2020 5d29 0a20 2020 2064 6566 2074      ]).    def t
-0002d710: 6573 745f 6e65 775f 6275 636b 6574 5f63  est_new_bucket_c
-0002d720: 7265 6174 696f 6e5f 616e 645f 6465 6c65  reation_and_dele
-0002d730: 7469 6f6e 2873 656c 662c 2074 6d70 5f6c  tion(self, tmp_l
-0002d740: 6f63 616c 5f73 746f 7261 6765 5f6f 626a  ocal_storage_obj
-0002d750: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002d760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d780: 7374 6f72 655f 7479 7065 293a 0a20 2020  store_type):.   
-0002d790: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
-0002d7a0: 206e 6577 2062 7563 6b65 7420 7769 7468   new bucket with
-0002d7b0: 2061 206c 6f63 616c 2073 6f75 7263 652c   a local source,
-0002d7c0: 2075 706c 6f61 6473 2066 696c 6573 2074   uploads files t
-0002d7d0: 6f20 6974 0a20 2020 2020 2020 2023 2061  o it.        # a
-0002d7e0: 6e64 2064 656c 6574 6573 2069 742e 0a20  nd deletes it.. 
-0002d7f0: 2020 2020 2020 2074 6d70 5f6c 6f63 616c         tmp_local
-0002d800: 5f73 746f 7261 6765 5f6f 626a 2e61 6464  _storage_obj.add
-0002d810: 5f73 746f 7265 2873 746f 7265 5f74 7970  _store(store_typ
-0002d820: 6529 0a0a 2020 2020 2020 2020 2320 5275  e)..        # Ru
-0002d830: 6e20 736b 7920 7374 6f72 6167 6520 6c73  n sky storage ls
-0002d840: 2074 6f20 6368 6563 6b20 6966 2073 746f   to check if sto
-0002d850: 7261 6765 206f 626a 6563 7420 6578 6973  rage object exis
-0002d860: 7473 2069 6e20 7468 6520 6f75 7470 7574  ts in the output
-0002d870: 0a20 2020 2020 2020 206f 7574 203d 2073  .        out = s
-0002d880: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-0002d890: 6f75 7470 7574 285b 2773 6b79 272c 2027  output(['sky', '
-0002d8a0: 7374 6f72 6167 6527 2c20 276c 7327 5d29  storage', 'ls'])
-0002d8b0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0002d8c0: 746d 705f 6c6f 6361 6c5f 7374 6f72 6167  tmp_local_storag
-0002d8d0: 655f 6f62 6a2e 6e61 6d65 2069 6e20 6f75  e_obj.name in ou
-0002d8e0: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
-0002d8f0: 290a 0a20 2020 2020 2020 2023 2052 756e  )..        # Run
-0002d900: 2073 6b79 2073 746f 7261 6765 2064 656c   sky storage del
-0002d910: 6574 6520 746f 2064 656c 6574 6520 7468  ete to delete th
-0002d920: 6520 7374 6f72 6167 6520 6f62 6a65 6374  e storage object
-0002d930: 0a20 2020 2020 2020 2073 7562 7072 6f63  .        subproc
-0002d940: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
-0002d950: 280a 2020 2020 2020 2020 2020 2020 5b27  (.            ['
-0002d960: 736b 7927 2c20 2773 746f 7261 6765 272c  sky', 'storage',
-0002d970: 2027 6465 6c65 7465 272c 2074 6d70 5f6c   'delete', tmp_l
-0002d980: 6f63 616c 5f73 746f 7261 6765 5f6f 626a  ocal_storage_obj
-0002d990: 2e6e 616d 652c 2027 2d2d 7965 7327 5d29  .name, '--yes'])
-0002d9a0: 0a0a 2020 2020 2020 2020 2320 5275 6e20  ..        # Run 
-0002d9b0: 736b 7920 7374 6f72 6167 6520 6c73 2074  sky storage ls t
-0002d9c0: 6f20 6368 6563 6b20 6966 2073 746f 7261  o check if stora
-0002d9d0: 6765 206f 626a 6563 7420 6973 2064 656c  ge object is del
-0002d9e0: 6574 6564 0a20 2020 2020 2020 206f 7574  eted.        out
-0002d9f0: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
-0002da00: 6563 6b5f 6f75 7470 7574 285b 2773 6b79  eck_output(['sky
-0002da10: 272c 2027 7374 6f72 6167 6527 2c20 276c  ', 'storage', 'l
-0002da20: 7327 5d29 0a20 2020 2020 2020 2061 7373  s']).        ass
-0002da30: 6572 7420 746d 705f 6c6f 6361 6c5f 7374  ert tmp_local_st
-0002da40: 6f72 6167 655f 6f62 6a2e 6e61 6d65 206e  orage_obj.name n
-0002da50: 6f74 2069 6e20 6f75 742e 6465 636f 6465  ot in out.decode
-0002da60: 2827 7574 662d 3827 290a 0a20 2020 2040  ('utf-8')..    @
-0002da70: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
-0002da80: 6c75 6964 7374 6163 6b0a 2020 2020 4070  luidstack.    @p
-0002da90: 7974 6573 742e 6d61 726b 2e78 6469 7374  ytest.mark.xdist
-0002daa0: 5f67 726f 7570 2827 6d75 6c74 6970 6c65  _group('multiple
-0002dab0: 5f62 7563 6b65 745f 6465 6c65 7469 6f6e  _bucket_deletion
-0002dac0: 2729 0a20 2020 2040 7079 7465 7374 2e6d  ').    @pytest.m
-0002dad0: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
-0002dae0: 2773 746f 7265 5f74 7970 6527 2c20 5b0a  'store_type', [.
-0002daf0: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-0002db00: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
-0002db10: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
-0002db20: 6f72 6554 7970 652e 4743 532c 0a20 2020  oreType.GCS,.   
-0002db30: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
-0002db40: 6d28 7374 6f72 6167 655f 6c69 622e 5374  m(storage_lib.St
-0002db50: 6f72 6554 7970 652e 5232 2c20 6d61 726b  oreType.R2, mark
-0002db60: 733d 7079 7465 7374 2e6d 6172 6b2e 636c  s=pytest.mark.cl
-0002db70: 6f75 6466 6c61 7265 292c 0a20 2020 2020  oudflare),.     
-0002db80: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
-0002db90: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002dba0: 6554 7970 652e 4942 4d2c 206d 6172 6b73  eType.IBM, marks
-0002dbb0: 3d70 7974 6573 742e 6d61 726b 2e69 626d  =pytest.mark.ibm
-0002dbc0: 290a 2020 2020 5d29 0a20 2020 2064 6566  ).    ]).    def
-0002dbd0: 2074 6573 745f 6d75 6c74 6970 6c65 5f62   test_multiple_b
-0002dbe0: 7563 6b65 7473 5f63 7265 6174 696f 6e5f  uckets_creation_
-0002dbf0: 616e 645f 6465 6c65 7469 6f6e 280a 2020  and_deletion(.  
-0002dc00: 2020 2020 2020 2020 2020 7365 6c66 2c20            self, 
-0002dc10: 746d 705f 6d75 6c74 6970 6c65 5f73 6372  tmp_multiple_scr
-0002dc20: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
-0002dc30: 2c20 7374 6f72 655f 7479 7065 293a 0a20  , store_type):. 
-0002dc40: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
-0002dc50: 206d 756c 7469 706c 6520 6e65 7720 6275   multiple new bu
-0002dc60: 636b 6574 7328 3520 6275 636b 6574 7329  ckets(5 buckets)
-0002dc70: 2077 6974 6820 6120 6c6f 6361 6c20 736f   with a local so
-0002dc80: 7572 6365 0a20 2020 2020 2020 2023 2061  urce.        # a
-0002dc90: 6e64 2064 656c 6574 6573 2074 6865 6d2e  nd deletes them.
-0002dca0: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
-0002dcb0: 5f6f 626a 5f6e 616d 6520 3d20 5b5d 0a20  _obj_name = []. 
-0002dcc0: 2020 2020 2020 2066 6f72 2073 746f 7265         for store
-0002dcd0: 5f6f 626a 2069 6e20 746d 705f 6d75 6c74  _obj in tmp_mult
-0002dce0: 6970 6c65 5f73 6372 6174 6368 5f73 746f  iple_scratch_sto
-0002dcf0: 7261 6765 5f6f 626a 3a0a 2020 2020 2020  rage_obj:.      
-0002dd00: 2020 2020 2020 7374 6f72 655f 6f62 6a2e        store_obj.
-0002dd10: 6164 645f 7374 6f72 6528 7374 6f72 655f  add_store(store_
-0002dd20: 7479 7065 290a 2020 2020 2020 2020 2020  type).          
-0002dd30: 2020 7374 6f72 6167 655f 6f62 6a5f 6e61    storage_obj_na
-0002dd40: 6d65 2e61 7070 656e 6428 7374 6f72 655f  me.append(store_
-0002dd50: 6f62 6a2e 6e61 6d65 290a 0a20 2020 2020  obj.name)..     
-0002dd60: 2020 2023 2052 756e 2073 6b79 2073 746f     # Run sky sto
-0002dd70: 7261 6765 206c 7320 746f 2063 6865 636b  rage ls to check
-0002dd80: 2069 6620 616c 6c20 7374 6f72 6167 6520   if all storage 
-0002dd90: 6f62 6a65 6374 7320 6578 6973 7473 2069  objects exists i
-0002dda0: 6e20 7468 650a 2020 2020 2020 2020 2320  n the.        # 
-0002ddb0: 6f75 7470 7574 2066 696c 7465 7265 6420  output filtered 
-0002ddc0: 6279 2073 746f 7265 2074 7970 650a 2020  by store type.  
-0002ddd0: 2020 2020 2020 6f75 745f 616c 6c20 3d20        out_all = 
-0002dde0: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
-0002ddf0: 5f6f 7574 7075 7428 5b27 736b 7927 2c20  _output(['sky', 
-0002de00: 2773 746f 7261 6765 272c 2027 6c73 275d  'storage', 'ls']
-0002de10: 290a 2020 2020 2020 2020 6f75 7420 3d20  ).        out = 
-0002de20: 5b0a 2020 2020 2020 2020 2020 2020 6974  [.            it
-0002de30: 656d 2e73 706c 6974 2829 5b30 5d0a 2020  em.split()[0].  
-0002de40: 2020 2020 2020 2020 2020 666f 7220 6974            for it
-0002de50: 656d 2069 6e20 6f75 745f 616c 6c2e 6465  em in out_all.de
-0002de60: 636f 6465 2827 7574 662d 3827 292e 7370  code('utf-8').sp
-0002de70: 6c69 746c 696e 6573 2829 0a20 2020 2020  litlines().     
-0002de80: 2020 2020 2020 2069 6620 7374 6f72 655f         if store_
-0002de90: 7479 7065 2e76 616c 7565 2069 6e20 6974  type.value in it
-0002dea0: 656d 0a20 2020 2020 2020 205d 0a20 2020  em.        ].   
-0002deb0: 2020 2020 2061 7373 6572 7420 616c 6c28       assert all(
-0002dec0: 5b69 7465 6d20 696e 206f 7574 2066 6f72  [item in out for
-0002ded0: 2069 7465 6d20 696e 2073 746f 7261 6765   item in storage
-0002dee0: 5f6f 626a 5f6e 616d 655d 290a 0a20 2020  _obj_name])..   
-0002def0: 2020 2020 2023 2052 756e 2073 6b79 2073       # Run sky s
-0002df00: 746f 7261 6765 2064 656c 6574 6520 616c  torage delete al
-0002df10: 6c20 746f 2064 656c 6574 6520 616c 6c20  l to delete all 
-0002df20: 7374 6f72 6167 6520 6f62 6a65 6374 730a  storage objects.
-0002df30: 2020 2020 2020 2020 6465 6c65 7465 5f63          delete_c
-0002df40: 6d64 203d 205b 2773 6b79 272c 2027 7374  md = ['sky', 'st
-0002df50: 6f72 6167 6527 2c20 2764 656c 6574 6527  orage', 'delete'
-0002df60: 2c20 272d 2d79 6573 275d 0a20 2020 2020  , '--yes'].     
-0002df70: 2020 2064 656c 6574 655f 636d 6420 2b3d     delete_cmd +=
-0002df80: 2073 746f 7261 6765 5f6f 626a 5f6e 616d   storage_obj_nam
-0002df90: 650a 2020 2020 2020 2020 7375 6270 726f  e.        subpro
-0002dfa0: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
-0002dfb0: 7428 6465 6c65 7465 5f63 6d64 290a 0a20  t(delete_cmd).. 
-0002dfc0: 2020 2020 2020 2023 2052 756e 2073 6b79         # Run sky
-0002dfd0: 2073 746f 7261 6765 206c 7320 746f 2063   storage ls to c
-0002dfe0: 6865 636b 2069 6620 616c 6c20 7374 6f72  heck if all stor
-0002dff0: 6167 6520 6f62 6a65 6374 7320 6669 6c74  age objects filt
-0002e000: 6572 6564 2062 7920 7374 6f72 650a 2020  ered by store.  
-0002e010: 2020 2020 2020 2320 7479 7065 2061 7265        # type are
-0002e020: 2064 656c 6574 6564 0a20 2020 2020 2020   deleted.       
-0002e030: 206f 7574 5f61 6c6c 203d 2073 7562 7072   out_all = subpr
-0002e040: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-0002e050: 7574 285b 2773 6b79 272c 2027 7374 6f72  ut(['sky', 'stor
-0002e060: 6167 6527 2c20 276c 7327 5d29 0a20 2020  age', 'ls']).   
-0002e070: 2020 2020 206f 7574 203d 205b 0a20 2020       out = [.   
-0002e080: 2020 2020 2020 2020 2069 7465 6d2e 7370           item.sp
-0002e090: 6c69 7428 295b 305d 0a20 2020 2020 2020  lit()[0].       
-0002e0a0: 2020 2020 2066 6f72 2069 7465 6d20 696e       for item in
-0002e0b0: 206f 7574 5f61 6c6c 2e64 6563 6f64 6528   out_all.decode(
-0002e0c0: 2775 7466 2d38 2729 2e73 706c 6974 6c69  'utf-8').splitli
-0002e0d0: 6e65 7328 290a 2020 2020 2020 2020 2020  nes().          
-0002e0e0: 2020 6966 2073 746f 7265 5f74 7970 652e    if store_type.
-0002e0f0: 7661 6c75 6520 696e 2069 7465 6d0a 2020  value in item.  
-0002e100: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-0002e110: 6173 7365 7274 2061 6c6c 285b 6974 656d  assert all([item
-0002e120: 206e 6f74 2069 6e20 6f75 7420 666f 7220   not in out for 
-0002e130: 6974 656d 2069 6e20 7374 6f72 6167 655f  item in storage_
-0002e140: 6f62 6a5f 6e61 6d65 5d29 0a0a 2020 2020  obj_name])..    
-0002e150: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-0002e160: 666c 7569 6473 7461 636b 0a20 2020 2040  fluidstack.    @
-0002e170: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
-0002e180: 6d65 7472 697a 6528 2773 746f 7265 5f74  metrize('store_t
-0002e190: 7970 6527 2c20 5b0a 2020 2020 2020 2020  ype', [.        
-0002e1a0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002e1b0: 6554 7970 652e 5333 2c20 7374 6f72 6167  eType.S3, storag
-0002e1c0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-0002e1d0: 4743 532c 0a20 2020 2020 2020 2070 7974  GCS,.        pyt
-0002e1e0: 6573 742e 7061 7261 6d28 7374 6f72 6167  est.param(storag
-0002e1f0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-0002e200: 4942 4d2c 206d 6172 6b73 3d70 7974 6573  IBM, marks=pytes
-0002e210: 742e 6d61 726b 2e69 626d 292c 0a20 2020  t.mark.ibm),.   
-0002e220: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
-0002e230: 6d28 7374 6f72 6167 655f 6c69 622e 5374  m(storage_lib.St
-0002e240: 6f72 6554 7970 652e 5232 2c20 6d61 726b  oreType.R2, mark
-0002e250: 733d 7079 7465 7374 2e6d 6172 6b2e 636c  s=pytest.mark.cl
-0002e260: 6f75 6466 6c61 7265 290a 2020 2020 5d29  oudflare).    ])
-0002e270: 0a20 2020 2064 6566 2074 6573 745f 7570  .    def test_up
-0002e280: 6c6f 6164 5f73 6f75 7263 655f 7769 7468  load_source_with
-0002e290: 5f73 7061 6365 7328 7365 6c66 2c20 7374  _spaces(self, st
-0002e2a0: 6f72 655f 7479 7065 2c0a 2020 2020 2020  ore_type,.      
-0002e2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e2d0: 2074 6d70 5f6d 756c 7469 706c 655f 6375   tmp_multiple_cu
-0002e2e0: 7374 6f6d 5f73 6f75 7263 655f 7374 6f72  stom_source_stor
-0002e2f0: 6167 655f 6f62 6a29 3a0a 2020 2020 2020  age_obj):.      
-0002e300: 2020 2320 4372 6561 7465 7320 7477 6f20    # Creates two 
-0002e310: 6275 636b 6574 7320 7769 7468 2073 7065  buckets with spe
-0002e320: 6369 6669 6564 206c 6f63 616c 2073 6f75  cified local sou
-0002e330: 7263 6573 0a20 2020 2020 2020 2023 2077  rces.        # w
-0002e340: 6974 6820 7370 6163 6573 2069 6e20 7468  ith spaces in th
-0002e350: 6520 6e61 6d65 0a20 2020 2020 2020 2073  e name.        s
-0002e360: 746f 7261 6765 5f6f 626a 5f6e 616d 6573  torage_obj_names
-0002e370: 203d 205b 5d0a 2020 2020 2020 2020 666f   = [].        fo
-0002e380: 7220 7374 6f72 6167 655f 6f62 6a20 696e  r storage_obj in
-0002e390: 2074 6d70 5f6d 756c 7469 706c 655f 6375   tmp_multiple_cu
-0002e3a0: 7374 6f6d 5f73 6f75 7263 655f 7374 6f72  stom_source_stor
-0002e3b0: 6167 655f 6f62 6a3a 0a20 2020 2020 2020  age_obj:.       
-0002e3c0: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
-0002e3d0: 2e61 6464 5f73 746f 7265 2873 746f 7265  .add_store(store
-0002e3e0: 5f74 7970 6529 0a20 2020 2020 2020 2020  _type).         
-0002e3f0: 2020 2073 746f 7261 6765 5f6f 626a 5f6e     storage_obj_n
-0002e400: 616d 6573 2e61 7070 656e 6428 7374 6f72  ames.append(stor
-0002e410: 6167 655f 6f62 6a2e 6e61 6d65 290a 0a20  age_obj.name).. 
-0002e420: 2020 2020 2020 2023 2052 756e 2073 6b79         # Run sky
-0002e430: 2073 746f 7261 6765 206c 7320 746f 2063   storage ls to c
-0002e440: 6865 636b 2069 6620 616c 6c20 7374 6f72  heck if all stor
-0002e450: 6167 6520 6f62 6a65 6374 7320 6578 6973  age objects exis
-0002e460: 7473 2069 6e20 7468 650a 2020 2020 2020  ts in the.      
-0002e470: 2020 2320 6f75 7470 7574 2066 696c 7465    # output filte
-0002e480: 7265 6420 6279 2073 746f 7265 2074 7970  red by store typ
-0002e490: 650a 2020 2020 2020 2020 6f75 745f 616c  e.        out_al
-0002e4a0: 6c20 3d20 7375 6270 726f 6365 7373 2e63  l = subprocess.c
-0002e4b0: 6865 636b 5f6f 7574 7075 7428 5b27 736b  heck_output(['sk
-0002e4c0: 7927 2c20 2773 746f 7261 6765 272c 2027  y', 'storage', '
-0002e4d0: 6c73 275d 290a 2020 2020 2020 2020 6f75  ls']).        ou
-0002e4e0: 7420 3d20 5b0a 2020 2020 2020 2020 2020  t = [.          
-0002e4f0: 2020 6974 656d 2e73 706c 6974 2829 5b30    item.split()[0
-0002e500: 5d0a 2020 2020 2020 2020 2020 2020 666f  ].            fo
-0002e510: 7220 6974 656d 2069 6e20 6f75 745f 616c  r item in out_al
-0002e520: 6c2e 6465 636f 6465 2827 7574 662d 3827  l.decode('utf-8'
-0002e530: 292e 7370 6c69 746c 696e 6573 2829 0a20  ).splitlines(). 
-0002e540: 2020 2020 2020 2020 2020 2069 6620 7374             if st
-0002e550: 6f72 655f 7479 7065 2e76 616c 7565 2069  ore_type.value i
-0002e560: 6e20 6974 656d 0a20 2020 2020 2020 205d  n item.        ]
-0002e570: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0002e580: 616c 6c28 5b69 7465 6d20 696e 206f 7574  all([item in out
-0002e590: 2066 6f72 2069 7465 6d20 696e 2073 746f   for item in sto
-0002e5a0: 7261 6765 5f6f 626a 5f6e 616d 6573 5d29  rage_obj_names])
-0002e5b0: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
-0002e5c0: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
-0002e5d0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0002e5e0: 6b2e 7061 7261 6d65 7472 697a 6528 2773  k.parametrize('s
-0002e5f0: 746f 7265 5f74 7970 6527 2c20 5b0a 2020  tore_type', [.  
-0002e600: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
-0002e610: 622e 5374 6f72 6554 7970 652e 5333 2c20  b.StoreType.S3, 
-0002e620: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002e630: 6554 7970 652e 4743 532c 0a20 2020 2020  eType.GCS,.     
-0002e640: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
-0002e650: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002e660: 6554 7970 652e 4942 4d2c 206d 6172 6b73  eType.IBM, marks
-0002e670: 3d70 7974 6573 742e 6d61 726b 2e69 626d  =pytest.mark.ibm
-0002e680: 292c 0a20 2020 2020 2020 2070 7974 6573  ),.        pytes
-0002e690: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
-0002e6a0: 6c69 622e 5374 6f72 6554 7970 652e 5232  lib.StoreType.R2
-0002e6b0: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
-0002e6c0: 6172 6b2e 636c 6f75 6466 6c61 7265 290a  ark.cloudflare).
-0002e6d0: 2020 2020 5d29 0a20 2020 2064 6566 2074      ]).    def t
-0002e6e0: 6573 745f 6275 636b 6574 5f65 7874 6572  est_bucket_exter
-0002e6f0: 6e61 6c5f 6465 6c65 7469 6f6e 2873 656c  nal_deletion(sel
-0002e700: 662c 2074 6d70 5f73 6372 6174 6368 5f73  f, tmp_scratch_s
-0002e710: 746f 7261 6765 5f6f 626a 2c0a 2020 2020  torage_obj,.    
-0002e720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e740: 2020 7374 6f72 655f 7479 7065 293a 0a20    store_type):. 
-0002e750: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
-0002e760: 2061 2062 7563 6b65 742c 2064 656c 6574   a bucket, delet
-0002e770: 6573 2069 7420 6578 7465 726e 616c 6c79  es it externally
-0002e780: 2075 7369 6e67 2063 6c6f 7564 2063 6c69   using cloud cli
-0002e790: 2063 6f6d 6d61 6e64 730a 2020 2020 2020   commands.      
-0002e7a0: 2020 2320 616e 6420 7468 656e 2074 7269    # and then tri
-0002e7b0: 6573 2074 6f20 6465 6c65 7465 2069 7420  es to delete it 
-0002e7c0: 7573 696e 6720 736b 7920 7374 6f72 6167  using sky storag
-0002e7d0: 6520 6465 6c65 7465 2e0a 2020 2020 2020  e delete..      
-0002e7e0: 2020 746d 705f 7363 7261 7463 685f 7374    tmp_scratch_st
-0002e7f0: 6f72 6167 655f 6f62 6a2e 6164 645f 7374  orage_obj.add_st
-0002e800: 6f72 6528 7374 6f72 655f 7479 7065 290a  ore(store_type).
-0002e810: 0a20 2020 2020 2020 2023 2052 756e 2073  .        # Run s
-0002e820: 6b79 2073 746f 7261 6765 206c 7320 746f  ky storage ls to
-0002e830: 2063 6865 636b 2069 6620 7374 6f72 6167   check if storag
-0002e840: 6520 6f62 6a65 6374 2065 7869 7374 7320  e object exists 
-0002e850: 696e 2074 6865 206f 7574 7075 740a 2020  in the output.  
-0002e860: 2020 2020 2020 6f75 7420 3d20 7375 6270        out = subp
-0002e870: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
-0002e880: 7075 7428 5b27 736b 7927 2c20 2773 746f  put(['sky', 'sto
-0002e890: 7261 6765 272c 2027 6c73 275d 290a 2020  rage', 'ls']).  
-0002e8a0: 2020 2020 2020 6173 7365 7274 2074 6d70        assert tmp
-0002e8b0: 5f73 6372 6174 6368 5f73 746f 7261 6765  _scratch_storage
-0002e8c0: 5f6f 626a 2e6e 616d 6520 696e 206f 7574  _obj.name in out
-0002e8d0: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-0002e8e0: 0a0a 2020 2020 2020 2020 2320 4465 6c65  ..        # Dele
-0002e8f0: 7465 2062 7563 6b65 7420 6578 7465 726e  te bucket extern
-0002e900: 616c 6c79 0a20 2020 2020 2020 2063 6d64  ally.        cmd
-0002e910: 203d 2073 656c 662e 636c 695f 6465 6c65   = self.cli_dele
-0002e920: 7465 5f63 6d64 2873 746f 7265 5f74 7970  te_cmd(store_typ
-0002e930: 652c 2074 6d70 5f73 6372 6174 6368 5f73  e, tmp_scratch_s
-0002e940: 746f 7261 6765 5f6f 626a 2e6e 616d 6529  torage_obj.name)
-0002e950: 0a20 2020 2020 2020 2073 7562 7072 6f63  .        subproc
-0002e960: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
-0002e970: 2863 6d64 2c20 7368 656c 6c3d 5472 7565  (cmd, shell=True
-0002e980: 290a 0a20 2020 2020 2020 2023 2052 756e  )..        # Run
-0002e990: 2073 6b79 2073 746f 7261 6765 2064 656c   sky storage del
-0002e9a0: 6574 6520 746f 2064 656c 6574 6520 7468  ete to delete th
-0002e9b0: 6520 7374 6f72 6167 6520 6f62 6a65 6374  e storage object
-0002e9c0: 0a20 2020 2020 2020 206f 7574 203d 2073  .        out = s
-0002e9d0: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-0002e9e0: 6f75 7470 7574 280a 2020 2020 2020 2020  output(.        
-0002e9f0: 2020 2020 5b27 736b 7927 2c20 2773 746f      ['sky', 'sto
-0002ea00: 7261 6765 272c 2027 6465 6c65 7465 272c  rage', 'delete',
-0002ea10: 2074 6d70 5f73 6372 6174 6368 5f73 746f   tmp_scratch_sto
-0002ea20: 7261 6765 5f6f 626a 2e6e 616d 652c 2027  rage_obj.name, '
-0002ea30: 2d2d 7965 7327 5d29 0a20 2020 2020 2020  --yes']).       
-0002ea40: 2023 204d 616b 6520 7375 7265 2062 7563   # Make sure buc
-0002ea50: 6b65 7420 7761 7320 6e6f 7420 6372 6561  ket was not crea
-0002ea60: 7465 6420 6475 7269 6e67 2064 656c 6574  ted during delet
-0002ea70: 696f 6e20 2873 6565 2069 7373 7565 2023  ion (see issue #
-0002ea80: 3133 3232 290a 2020 2020 2020 2020 6173  1322).        as
-0002ea90: 7365 7274 2027 6372 6561 7465 6427 206e  sert 'created' n
-0002eaa0: 6f74 2069 6e20 6f75 742e 6465 636f 6465  ot in out.decode
-0002eab0: 2827 7574 662d 3827 292e 6c6f 7765 7228  ('utf-8').lower(
-0002eac0: 290a 0a20 2020 2020 2020 2023 2052 756e  )..        # Run
-0002ead0: 2073 6b79 2073 746f 7261 6765 206c 7320   sky storage ls 
-0002eae0: 746f 2063 6865 636b 2069 6620 7374 6f72  to check if stor
-0002eaf0: 6167 6520 6f62 6a65 6374 2069 7320 6465  age object is de
-0002eb00: 6c65 7465 640a 2020 2020 2020 2020 6f75  leted.        ou
-0002eb10: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
-0002eb20: 6865 636b 5f6f 7574 7075 7428 5b27 736b  heck_output(['sk
-0002eb30: 7927 2c20 2773 746f 7261 6765 272c 2027  y', 'storage', '
-0002eb40: 6c73 275d 290a 2020 2020 2020 2020 6173  ls']).        as
-0002eb50: 7365 7274 2074 6d70 5f73 6372 6174 6368  sert tmp_scratch
-0002eb60: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
-0002eb70: 6520 6e6f 7420 696e 206f 7574 2e64 6563  e not in out.dec
-0002eb80: 6f64 6528 2775 7466 2d38 2729 0a0a 2020  ode('utf-8')..  
-0002eb90: 2020 4070 7974 6573 742e 6d61 726b 2e6e    @pytest.mark.n
-0002eba0: 6f5f 666c 7569 6473 7461 636b 0a20 2020  o_fluidstack.   
-0002ebb0: 2040 7079 7465 7374 2e6d 6172 6b2e 7061   @pytest.mark.pa
-0002ebc0: 7261 6d65 7472 697a 6528 2773 746f 7265  rametrize('store
-0002ebd0: 5f74 7970 6527 2c20 5b0a 2020 2020 2020  _type', [.      
-0002ebe0: 2020 7374 6f72 6167 655f 6c69 622e 5374    storage_lib.St
-0002ebf0: 6f72 6554 7970 652e 5333 2c20 7374 6f72  oreType.S3, stor
-0002ec00: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0002ec10: 652e 4743 532c 0a20 2020 2020 2020 2070  e.GCS,.        p
-0002ec20: 7974 6573 742e 7061 7261 6d28 7374 6f72  ytest.param(stor
-0002ec30: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0002ec40: 652e 4942 4d2c 206d 6172 6b73 3d70 7974  e.IBM, marks=pyt
-0002ec50: 6573 742e 6d61 726b 2e69 626d 292c 0a20  est.mark.ibm),. 
-0002ec60: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
-0002ec70: 7261 6d28 7374 6f72 6167 655f 6c69 622e  ram(storage_lib.
-0002ec80: 5374 6f72 6554 7970 652e 5232 2c20 6d61  StoreType.R2, ma
-0002ec90: 726b 733d 7079 7465 7374 2e6d 6172 6b2e  rks=pytest.mark.
-0002eca0: 636c 6f75 6466 6c61 7265 290a 2020 2020  cloudflare).    
-0002ecb0: 5d29 0a20 2020 2064 6566 2074 6573 745f  ]).    def test_
-0002ecc0: 6275 636b 6574 5f62 756c 6b5f 6465 6c65  bucket_bulk_dele
-0002ecd0: 7469 6f6e 2873 656c 662c 2073 746f 7265  tion(self, store
-0002ece0: 5f74 7970 652c 2074 6d70 5f62 756c 6b5f  _type, tmp_bulk_
-0002ecf0: 6465 6c5f 7374 6f72 6167 655f 6f62 6a29  del_storage_obj)
-0002ed00: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
-0002ed10: 7465 7320 6120 7465 6d70 2066 6f6c 6465  tes a temp folde
-0002ed20: 7220 7769 7468 206f 7665 7220 3235 3620  r with over 256 
-0002ed30: 6669 6c65 7320 616e 6420 666f 6c64 6572  files and folder
-0002ed40: 732c 2075 706c 6f61 640a 2020 2020 2020  s, upload.      
-0002ed50: 2020 2320 6669 6c65 7320 616e 6420 666f    # files and fo
-0002ed60: 6c64 6572 7320 746f 2061 206e 6577 2062  lders to a new b
-0002ed70: 7563 6b65 742c 2074 6865 6e20 6465 6c65  ucket, then dele
-0002ed80: 7465 2062 7563 6b65 742e 0a20 2020 2020  te bucket..     
-0002ed90: 2020 2074 6d70 5f62 756c 6b5f 6465 6c5f     tmp_bulk_del_
-0002eda0: 7374 6f72 6167 655f 6f62 6a2e 6164 645f  storage_obj.add_
-0002edb0: 7374 6f72 6528 7374 6f72 655f 7479 7065  store(store_type
-0002edc0: 290a 0a20 2020 2020 2020 2073 7562 7072  )..        subpr
-0002edd0: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-0002ede0: 7574 285b 0a20 2020 2020 2020 2020 2020  ut([.           
-0002edf0: 2027 736b 7927 2c20 2773 746f 7261 6765   'sky', 'storage
-0002ee00: 272c 2027 6465 6c65 7465 272c 2074 6d70  ', 'delete', tmp
-0002ee10: 5f62 756c 6b5f 6465 6c5f 7374 6f72 6167  _bulk_del_storag
-0002ee20: 655f 6f62 6a2e 6e61 6d65 2c20 272d 2d79  e_obj.name, '--y
-0002ee30: 6573 270a 2020 2020 2020 2020 5d29 0a0a  es'.        ])..
-0002ee40: 2020 2020 2020 2020 6f75 7470 7574 203d          output =
-0002ee50: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-0002ee60: 6b5f 6f75 7470 7574 285b 2773 6b79 272c  k_output(['sky',
-0002ee70: 2027 7374 6f72 6167 6527 2c20 276c 7327   'storage', 'ls'
-0002ee80: 5d29 0a20 2020 2020 2020 2061 7373 6572  ]).        asser
-0002ee90: 7420 746d 705f 6275 6c6b 5f64 656c 5f73  t tmp_bulk_del_s
-0002eea0: 746f 7261 6765 5f6f 626a 2e6e 616d 6520  torage_obj.name 
-0002eeb0: 6e6f 7420 696e 206f 7574 7075 742e 6465  not in output.de
-0002eec0: 636f 6465 2827 7574 662d 3827 290a 0a20  code('utf-8').. 
-0002eed0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-0002eee0: 6e6f 5f66 6c75 6964 7374 6163 6b0a 2020  no_fluidstack.  
-0002eef0: 2020 4070 7974 6573 742e 6d61 726b 2e70    @pytest.mark.p
-0002ef00: 6172 616d 6574 7269 7a65 280a 2020 2020  arametrize(.    
-0002ef10: 2020 2020 2774 6d70 5f70 7562 6c69 635f      'tmp_public_
-0002ef20: 7374 6f72 6167 655f 6f62 6a2c 2073 746f  storage_obj, sto
-0002ef30: 7265 5f74 7970 6527 2c0a 2020 2020 2020  re_type',.      
-0002ef40: 2020 5b28 2773 333a 2f2f 7463 6761 2d32    [('s3://tcga-2
-0002ef50: 2d6f 7065 6e27 2c20 7374 6f72 6167 655f  -open', storage_
-0002ef60: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
-0002ef70: 292c 0a20 2020 2020 2020 2020 2827 7333  ),.         ('s3
-0002ef80: 3a2f 2f64 6967 6974 616c 636f 7270 6f72  ://digitalcorpor
-0002ef90: 6127 2c20 7374 6f72 6167 655f 6c69 622e  a', storage_lib.
-0002efa0: 5374 6f72 6554 7970 652e 5333 292c 0a20  StoreType.S3),. 
-0002efb0: 2020 2020 2020 2020 2827 6773 3a2f 2f67          ('gs://g
-0002efc0: 6370 2d70 7562 6c69 632d 6461 7461 2d73  cp-public-data-s
-0002efd0: 656e 7469 6e65 6c2d 3227 2c20 7374 6f72  entinel-2', stor
-0002efe0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0002eff0: 652e 4743 5329 5d2c 0a20 2020 2020 2020  e.GCS)],.       
-0002f000: 2069 6e64 6972 6563 743d 5b27 746d 705f   indirect=['tmp_
-0002f010: 7075 626c 6963 5f73 746f 7261 6765 5f6f  public_storage_o
-0002f020: 626a 275d 290a 2020 2020 6465 6620 7465  bj']).    def te
-0002f030: 7374 5f70 7562 6c69 635f 6275 636b 6574  st_public_bucket
-0002f040: 2873 656c 662c 2074 6d70 5f70 7562 6c69  (self, tmp_publi
-0002f050: 635f 7374 6f72 6167 655f 6f62 6a2c 2073  c_storage_obj, s
-0002f060: 746f 7265 5f74 7970 6529 3a0a 2020 2020  tore_type):.    
-0002f070: 2020 2020 2320 4372 6561 7465 7320 6120      # Creates a 
-0002f080: 6e65 7720 6275 636b 6574 2077 6974 6820  new bucket with 
-0002f090: 6120 7075 626c 6963 2073 6f75 7263 6520  a public source 
-0002f0a0: 616e 6420 7665 7269 6669 6573 2074 6861  and verifies tha
-0002f0b0: 7420 6974 2069 7320 6e6f 740a 2020 2020  t it is not.    
-0002f0c0: 2020 2020 2320 6164 6465 6420 746f 2067      # added to g
-0002f0d0: 6c6f 6261 6c5f 7573 6572 5f73 7461 7465  lobal_user_state
-0002f0e0: 2e0a 2020 2020 2020 2020 746d 705f 7075  ..        tmp_pu
-0002f0f0: 626c 6963 5f73 746f 7261 6765 5f6f 626a  blic_storage_obj
-0002f100: 2e61 6464 5f73 746f 7265 2873 746f 7265  .add_store(store
-0002f110: 5f74 7970 6529 0a0a 2020 2020 2020 2020  _type)..        
-0002f120: 2320 5275 6e20 736b 7920 7374 6f72 6167  # Run sky storag
-0002f130: 6520 6c73 2074 6f20 6368 6563 6b20 6966  e ls to check if
-0002f140: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
-0002f150: 6578 6973 7473 2069 6e20 7468 6520 6f75  exists in the ou
-0002f160: 7470 7574 0a20 2020 2020 2020 206f 7574  tput.        out
-0002f170: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
-0002f180: 6563 6b5f 6f75 7470 7574 285b 2773 6b79  eck_output(['sky
-0002f190: 272c 2027 7374 6f72 6167 6527 2c20 276c  ', 'storage', 'l
-0002f1a0: 7327 5d29 0a20 2020 2020 2020 2061 7373  s']).        ass
-0002f1b0: 6572 7420 746d 705f 7075 626c 6963 5f73  ert tmp_public_s
-0002f1c0: 746f 7261 6765 5f6f 626a 2e6e 616d 6520  torage_obj.name 
-0002f1d0: 6e6f 7420 696e 206f 7574 2e64 6563 6f64  not in out.decod
-0002f1e0: 6528 2775 7466 2d38 2729 0a0a 2020 2020  e('utf-8')..    
-0002f1f0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-0002f200: 666c 7569 6473 7461 636b 0a20 2020 2040  fluidstack.    @
-0002f210: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
-0002f220: 6d65 7472 697a 6528 276e 6f6e 6578 6973  metrize('nonexis
-0002f230: 745f 6275 636b 6574 5f75 726c 272c 205b  t_bucket_url', [
-0002f240: 0a20 2020 2020 2020 2027 7333 3a2f 2f7b  .        's3://{
-0002f250: 7261 6e64 6f6d 5f6e 616d 657d 272c 2027  random_name}', '
-0002f260: 6773 3a2f 2f7b 7261 6e64 6f6d 5f6e 616d  gs://{random_nam
-0002f270: 657d 272c 0a20 2020 2020 2020 2070 7974  e}',.        pyt
-0002f280: 6573 742e 7061 7261 6d28 2763 6f73 3a2f  est.param('cos:/
-0002f290: 2f75 732d 6561 7374 2f7b 7261 6e64 6f6d  /us-east/{random
-0002f2a0: 5f6e 616d 657d 272c 206d 6172 6b73 3d70  _name}', marks=p
-0002f2b0: 7974 6573 742e 6d61 726b 2e69 626d 292c  ytest.mark.ibm),
-0002f2c0: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
-0002f2d0: 7061 7261 6d28 2772 323a 2f2f 7b72 616e  param('r2://{ran
-0002f2e0: 646f 6d5f 6e61 6d65 7d27 2c20 6d61 726b  dom_name}', mark
-0002f2f0: 733d 7079 7465 7374 2e6d 6172 6b2e 636c  s=pytest.mark.cl
-0002f300: 6f75 6466 6c61 7265 290a 2020 2020 5d29  oudflare).    ])
-0002f310: 0a20 2020 2064 6566 2074 6573 745f 6e6f  .    def test_no
-0002f320: 6e65 7869 7374 656e 745f 6275 636b 6574  nexistent_bucket
-0002f330: 2873 656c 662c 206e 6f6e 6578 6973 745f  (self, nonexist_
-0002f340: 6275 636b 6574 5f75 726c 293a 0a20 2020  bucket_url):.   
-0002f350: 2020 2020 2023 2041 7474 656d 7074 7320       # Attempts 
-0002f360: 746f 2063 7265 6174 6520 6665 7463 6820  to create fetch 
-0002f370: 6120 7374 726f 6167 6520 7769 7468 2061  a stroage with a
-0002f380: 206e 6f6e 2d65 7869 7374 656e 7420 736f   non-existent so
-0002f390: 7572 6365 2e0a 2020 2020 2020 2020 2320  urce..        # 
-0002f3a0: 4765 6e65 7261 7465 2061 2072 616e 646f  Generate a rando
-0002f3b0: 6d20 6275 636b 6574 206e 616d 6520 616e  m bucket name an
-0002f3c0: 6420 7665 7269 6679 2069 7420 646f 6573  d verify it does
-0002f3d0: 6e27 7420 6578 6973 743a 0a20 2020 2020  n't exist:.     
-0002f3e0: 2020 2072 6574 7279 5f63 6f75 6e74 203d     retry_count =
-0002f3f0: 2030 0a20 2020 2020 2020 2077 6869 6c65   0.        while
-0002f400: 2054 7275 653a 0a20 2020 2020 2020 2020   True:.         
-0002f410: 2020 206e 6f6e 6578 6973 745f 6275 636b     nonexist_buck
-0002f420: 6574 5f6e 616d 6520 3d20 7374 7228 7575  et_name = str(uu
-0002f430: 6964 2e75 7569 6434 2829 290a 2020 2020  id.uuid4()).    
-0002f440: 2020 2020 2020 2020 6966 206e 6f6e 6578          if nonex
-0002f450: 6973 745f 6275 636b 6574 5f75 726c 2e73  ist_bucket_url.s
-0002f460: 7461 7274 7377 6974 6828 2773 3327 293a  tartswith('s3'):
-0002f470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f480: 2063 6f6d 6d61 6e64 203d 2066 2761 7773   command = f'aws
-0002f490: 2073 3361 7069 2068 6561 642d 6275 636b   s3api head-buck
-0002f4a0: 6574 202d 2d62 7563 6b65 7420 7b6e 6f6e  et --bucket {non
-0002f4b0: 6578 6973 745f 6275 636b 6574 5f6e 616d  exist_bucket_nam
-0002f4c0: 657d 270a 2020 2020 2020 2020 2020 2020  e}'.            
-0002f4d0: 2020 2020 6578 7065 6374 6564 5f6f 7574      expected_out
-0002f4e0: 7075 7420 3d20 2734 3034 270a 2020 2020  put = '404'.    
-0002f4f0: 2020 2020 2020 2020 656c 6966 206e 6f6e          elif non
-0002f500: 6578 6973 745f 6275 636b 6574 5f75 726c  exist_bucket_url
-0002f510: 2e73 7461 7274 7377 6974 6828 2767 7327  .startswith('gs'
-0002f520: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0002f530: 2020 2063 6f6d 6d61 6e64 203d 2066 2767     command = f'g
-0002f540: 7375 7469 6c20 6c73 207b 6e6f 6e65 7869  sutil ls {nonexi
-0002f550: 7374 5f62 7563 6b65 745f 7572 6c2e 666f  st_bucket_url.fo
-0002f560: 726d 6174 2872 616e 646f 6d5f 6e61 6d65  rmat(random_name
-0002f570: 3d6e 6f6e 6578 6973 745f 6275 636b 6574  =nonexist_bucket
-0002f580: 5f6e 616d 6529 7d27 0a20 2020 2020 2020  _name)}'.       
-0002f590: 2020 2020 2020 2020 2065 7870 6563 7465           expecte
-0002f5a0: 645f 6f75 7470 7574 203d 2027 4275 636b  d_output = 'Buck
-0002f5b0: 6574 4e6f 7446 6f75 6e64 4578 6365 7074  etNotFoundExcept
-0002f5c0: 696f 6e27 0a20 2020 2020 2020 2020 2020  ion'.           
-0002f5d0: 2065 6c69 6620 6e6f 6e65 7869 7374 5f62   elif nonexist_b
-0002f5e0: 7563 6b65 745f 7572 6c2e 7374 6172 7473  ucket_url.starts
-0002f5f0: 7769 7468 2827 7232 2729 3a0a 2020 2020  with('r2'):.    
-0002f600: 2020 2020 2020 2020 2020 2020 656e 6470              endp
-0002f610: 6f69 6e74 5f75 726c 203d 2063 6c6f 7564  oint_url = cloud
-0002f620: 666c 6172 652e 6372 6561 7465 5f65 6e64  flare.create_end
-0002f630: 706f 696e 7428 290a 2020 2020 2020 2020  point().        
-0002f640: 2020 2020 2020 2020 636f 6d6d 616e 6420          command 
-0002f650: 3d20 6627 4157 535f 5348 4152 4544 5f43  = f'AWS_SHARED_C
-0002f660: 5245 4445 4e54 4941 4c53 5f46 494c 453d  REDENTIALS_FILE=
-0002f670: 7b63 6c6f 7564 666c 6172 652e 5232 5f43  {cloudflare.R2_C
-0002f680: 5245 4445 4e54 4941 4c53 5f50 4154 487d  REDENTIALS_PATH}
-0002f690: 2061 7773 2073 3361 7069 2068 6561 642d   aws s3api head-
-0002f6a0: 6275 636b 6574 202d 2d62 7563 6b65 7420  bucket --bucket 
-0002f6b0: 7b6e 6f6e 6578 6973 745f 6275 636b 6574  {nonexist_bucket
-0002f6c0: 5f6e 616d 657d 202d 2d65 6e64 706f 696e  _name} --endpoin
-0002f6d0: 7420 7b65 6e64 706f 696e 745f 7572 6c7d  t {endpoint_url}
-0002f6e0: 202d 2d70 726f 6669 6c65 3d72 3227 0a20   --profile=r2'. 
-0002f6f0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0002f700: 7870 6563 7465 645f 6f75 7470 7574 203d  xpected_output =
-0002f710: 2027 3430 3427 0a20 2020 2020 2020 2020   '404'.         
-0002f720: 2020 2065 6c69 6620 6e6f 6e65 7869 7374     elif nonexist
-0002f730: 5f62 7563 6b65 745f 7572 6c2e 7374 6172  _bucket_url.star
-0002f740: 7473 7769 7468 2827 636f 7327 293a 0a20  tswith('cos'):. 
-0002f750: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0002f760: 2055 7369 6e67 2041 5049 2063 616c 6c73   Using API calls
-0002f770: 2c20 7369 6e63 6520 7573 696e 6720 7263  , since using rc
-0002f780: 6c6f 6e65 2072 6571 7569 7265 7320 6120  lone requires a 
-0002f790: 7072 6f66 696c 6527 7320 6e61 6d65 0a20  profile's name. 
-0002f7a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0002f7b0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0002f7c0: 2020 2020 2020 2020 6578 7065 6374 6564          expected
-0002f7d0: 5f6f 7574 7075 7420 3d20 636f 6d6d 616e  _output = comman
-0002f7e0: 6420 3d20 2265 6368 6f22 2020 2320 6176  d = "echo"  # av
-0002f7f0: 6f69 6420 756e 7265 6c61 7465 6420 6578  oid unrelated ex
-0002f800: 6365 7074 696f 6e20 696e 2063 6173 6520  ception in case 
-0002f810: 6f66 2066 6169 6c75 7265 2e0a 2020 2020  of failure..    
-0002f820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f830: 6275 636b 6574 5f6e 616d 6520 3d20 7572  bucket_name = ur
-0002f840: 6c6c 6962 2e70 6172 7365 2e75 726c 7370  llib.parse.urlsp
-0002f850: 6c69 7428 0a20 2020 2020 2020 2020 2020  lit(.           
-0002f860: 2020 2020 2020 2020 2020 2020 206e 6f6e               non
-0002f870: 6578 6973 745f 6275 636b 6574 5f75 726c  exist_bucket_url
-0002f880: 2e66 6f72 6d61 7428 0a20 2020 2020 2020  .format(.       
-0002f890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f8a0: 2020 2020 2072 616e 646f 6d5f 6e61 6d65       random_name
-0002f8b0: 3d6e 6f6e 6578 6973 745f 6275 636b 6574  =nonexist_bucket
-0002f8c0: 5f6e 616d 6529 292e 7061 7468 2e73 7472  _name)).path.str
-0002f8d0: 6970 2827 2f27 290a 2020 2020 2020 2020  ip('/').        
-0002f8e0: 2020 2020 2020 2020 2020 2020 636c 6965              clie
-0002f8f0: 6e74 203d 2069 626d 2e67 6574 5f63 6f73  nt = ibm.get_cos
-0002f900: 5f63 6c69 656e 7428 2775 732d 6561 7374  _client('us-east
-0002f910: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-0002f920: 2020 2020 2020 2063 6c69 656e 742e 6865         client.he
-0002f930: 6164 5f62 7563 6b65 7428 4275 636b 6574  ad_bucket(Bucket
-0002f940: 3d62 7563 6b65 745f 6e61 6d65 290a 2020  =bucket_name).  
-0002f950: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-0002f960: 6365 7074 2069 626d 2e69 626d 5f62 6f74  cept ibm.ibm_bot
-0002f970: 6f63 6f72 652e 6578 6365 7074 696f 6e73  ocore.exceptions
-0002f980: 2e43 6c69 656e 7445 7272 6f72 2061 7320  .ClientError as 
-0002f990: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0002f9a0: 2020 2020 2020 2069 6620 652e 7265 7370         if e.resp
-0002f9b0: 6f6e 7365 5b27 4572 726f 7227 5d5b 2743  onse['Error']['C
-0002f9c0: 6f64 6527 5d20 3d3d 2027 3430 3427 3a0a  ode'] == '404':.
-0002f9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f9e0: 2020 2020 2020 2020 2320 7375 6363 6573          # succes
-0002f9f0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0002fa00: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0002fa10: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0002fa20: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0002fa30: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-0002fa40: 726f 7228 2755 6e73 7570 706f 7274 6564  ror('Unsupported
-0002fa50: 2062 7563 6b65 7420 7479 7065 2027 0a20   bucket type '. 
-0002fa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fa80: 6627 7b6e 6f6e 6578 6973 745f 6275 636b  f'{nonexist_buck
-0002fa90: 6574 5f75 726c 7d27 290a 0a20 2020 2020  et_url}')..     
-0002faa0: 2020 2020 2020 2023 2043 6865 636b 2069         # Check i
-0002fab0: 6620 6275 636b 6574 2065 7869 7374 7320  f bucket exists 
-0002fac0: 7573 696e 6720 7468 6520 636c 693a 0a20  using the cli:. 
-0002fad0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0002fae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002faf0: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
-0002fb00: 2e63 6865 636b 5f6f 7574 7075 7428 636f  .check_output(co
-0002fb10: 6d6d 616e 642c 0a20 2020 2020 2020 2020  mmand,.         
-0002fb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fb40: 2020 2020 2073 7464 6572 723d 7375 6270       stderr=subp
-0002fb50: 726f 6365 7373 2e53 5444 4f55 542c 0a20  rocess.STDOUT,. 
-0002fb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fb80: 2020 2020 2020 2020 2020 2020 2073 6865               she
-0002fb90: 6c6c 3d54 7275 6529 0a20 2020 2020 2020  ll=True).       
-0002fba0: 2020 2020 2065 7863 6570 7420 7375 6270       except subp
-0002fbb0: 726f 6365 7373 2e43 616c 6c65 6450 726f  rocess.CalledPro
-0002fbc0: 6365 7373 4572 726f 7220 6173 2065 3a0a  cessError as e:.
-0002fbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fbe0: 6f75 7420 3d20 652e 6f75 7470 7574 0a20  out = e.output. 
-0002fbf0: 2020 2020 2020 2020 2020 206f 7574 203d             out =
-0002fc00: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
-0002fc10: 2d38 2729 0a20 2020 2020 2020 2020 2020  -8').           
-0002fc20: 2069 6620 6578 7065 6374 6564 5f6f 7574   if expected_out
-0002fc30: 7075 7420 696e 206f 7574 3a0a 2020 2020  put in out:.    
-0002fc40: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-0002fc50: 6b0a 2020 2020 2020 2020 2020 2020 656c  k.            el
-0002fc60: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0002fc70: 2020 2020 7265 7472 795f 636f 756e 7420      retry_count 
-0002fc80: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
-0002fc90: 2020 2020 2069 6620 7265 7472 795f 636f       if retry_co
-0002fca0: 756e 7420 3e20 333a 0a20 2020 2020 2020  unt > 3:.       
-0002fcb0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-0002fcc0: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
-0002fcd0: 2755 6e61 626c 6520 746f 2066 696e 6420  'Unable to find 
-0002fce0: 6120 6e6f 6e65 7869 7374 656e 7420 6275  a nonexistent bu
-0002fcf0: 636b 6574 2027 0a20 2020 2020 2020 2020  cket '.         
+0002c430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c440: 2020 2020 2020 2073 6f75 7263 653d 6c69         source=li
+0002c450: 7374 5f73 6f75 7263 6529 0a0a 2020 2020  st_source)..    
+0002c460: 4070 7974 6573 742e 6669 7874 7572 650a  @pytest.fixture.
+0002c470: 2020 2020 6465 6620 746d 705f 6275 6c6b      def tmp_bulk
+0002c480: 5f64 656c 5f73 746f 7261 6765 5f6f 626a  _del_storage_obj
+0002c490: 2873 656c 662c 2074 6d70 5f62 7563 6b65  (self, tmp_bucke
+0002c4a0: 745f 6e61 6d65 293a 0a20 2020 2020 2020  t_name):.       
+0002c4b0: 2023 2043 7265 6174 6573 2061 2074 656d   # Creates a tem
+0002c4c0: 706f 7261 7279 2073 746f 7261 6765 206f  porary storage o
+0002c4d0: 626a 6563 7420 666f 7220 7465 7374 696e  bject for testin
+0002c4e0: 6720 6275 6c6b 2064 656c 6574 696f 6e2e  g bulk deletion.
+0002c4f0: 0a20 2020 2020 2020 2023 2053 746f 7265  .        # Store
+0002c500: 7320 6d75 7374 2062 6520 6164 6465 6420  s must be added 
+0002c510: 696e 2074 6865 2074 6573 742e 0a20 2020  in the test..   
+0002c520: 2020 2020 2077 6974 6820 7465 6d70 6669       with tempfi
+0002c530: 6c65 2e54 656d 706f 7261 7279 4469 7265  le.TemporaryDire
+0002c540: 6374 6f72 7928 2920 6173 2074 6d70 6469  ctory() as tmpdi
+0002c550: 723a 0a20 2020 2020 2020 2020 2020 2073  r:.            s
+0002c560: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
+0002c570: 6f75 7470 7574 2866 276d 6b64 6972 202d  output(f'mkdir -
+0002c580: 7020 7b74 6d70 6469 727d 2f66 6f6c 6465  p {tmpdir}/folde
+0002c590: 727b 7b30 3030 2e2e 3235 357d 7d27 2c0a  r{{000..255}}',.
+0002c5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c5c0: 2020 2020 7368 656c 6c3d 5472 7565 290a      shell=True).
+0002c5d0: 2020 2020 2020 2020 2020 2020 7375 6270              subp
+0002c5e0: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+0002c5f0: 7075 7428 6627 746f 7563 6820 7b74 6d70  put(f'touch {tmp
+0002c600: 6469 727d 2f74 6573 747b 7b30 3030 2e2e  dir}/test{{000..
+0002c610: 3235 357d 7d2e 7478 7427 2c0a 2020 2020  255}}.txt',.    
+0002c620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c640: 7368 656c 6c3d 5472 7565 290a 2020 2020  shell=True).    
+0002c650: 2020 2020 2020 2020 7375 6270 726f 6365          subproce
+0002c660: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
+0002c670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002c680: 2066 2774 6f75 6368 207b 746d 7064 6972   f'touch {tmpdir
+0002c690: 7d2f 666f 6c64 6572 7b7b 3030 302e 2e32  }/folder{{000..2
+0002c6a0: 3535 7d7d 2f74 6573 742e 7478 7427 2c20  55}}/test.txt', 
+0002c6b0: 7368 656c 6c3d 5472 7565 290a 2020 2020  shell=True).    
+0002c6c0: 2020 2020 2020 2020 7969 656c 6420 6672          yield fr
+0002c6d0: 6f6d 2073 656c 662e 7969 656c 645f 7374  om self.yield_st
+0002c6e0: 6f72 6167 655f 6f62 6a65 6374 286e 616d  orage_object(nam
+0002c6f0: 653d 746d 705f 6275 636b 6574 5f6e 616d  e=tmp_bucket_nam
+0002c700: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0002c710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c730: 2020 2020 736f 7572 6365 3d74 6d70 6469      source=tmpdi
+0002c740: 7229 0a0a 2020 2020 4070 7974 6573 742e  r)..    @pytest.
+0002c750: 6669 7874 7572 650a 2020 2020 6465 6620  fixture.    def 
+0002c760: 746d 705f 636f 7079 5f6d 6e74 5f65 7869  tmp_copy_mnt_exi
+0002c770: 7374 696e 675f 7374 6f72 6167 655f 6f62  sting_storage_ob
+0002c780: 6a28 7365 6c66 2c20 746d 705f 7363 7261  j(self, tmp_scra
+0002c790: 7463 685f 7374 6f72 6167 655f 6f62 6a29  tch_storage_obj)
+0002c7a0: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
+0002c7b0: 7465 7320 6120 636f 7079 206d 6f75 6e74  tes a copy mount
+0002c7c0: 2073 746f 7261 6765 2077 6869 6368 2072   storage which r
+0002c7d0: 6575 7365 7320 616e 2065 7869 7374 696e  euses an existin
+0002c7e0: 6720 7374 6f72 6167 6520 6f62 6a65 6374  g storage object
+0002c7f0: 2e0a 2020 2020 2020 2020 746d 705f 7363  ..        tmp_sc
+0002c800: 7261 7463 685f 7374 6f72 6167 655f 6f62  ratch_storage_ob
+0002c810: 6a2e 6164 645f 7374 6f72 6528 7374 6f72  j.add_store(stor
+0002c820: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0002c830: 652e 5333 290a 2020 2020 2020 2020 7374  e.S3).        st
+0002c840: 6f72 6167 655f 6e61 6d65 203d 2074 6d70  orage_name = tmp
+0002c850: 5f73 6372 6174 6368 5f73 746f 7261 6765  _scratch_storage
+0002c860: 5f6f 626a 2e6e 616d 650a 0a20 2020 2020  _obj.name..     
+0002c870: 2020 2023 2054 7279 2074 6f20 696e 6974     # Try to init
+0002c880: 6961 6c69 7a65 2061 6e6f 7468 6572 2073  ialize another s
+0002c890: 746f 7261 6765 2077 6974 6820 7468 6520  torage with the 
+0002c8a0: 7374 6f72 6167 6520 6f62 6a65 6374 2063  storage object c
+0002c8b0: 7265 6174 6564 0a20 2020 2020 2020 2023  reated.        #
+0002c8c0: 2061 626f 7665 2c20 6275 7420 6e6f 7720   above, but now 
+0002c8d0: 696e 2043 4f50 5920 6d6f 6465 2e20 5468  in COPY mode. Th
+0002c8e0: 6973 2073 686f 756c 6420 7375 6363 6565  is should succee
+0002c8f0: 642e 0a20 2020 2020 2020 2079 6965 6c64  d..        yield
+0002c900: 2066 726f 6d20 7365 6c66 2e79 6965 6c64   from self.yield
+0002c910: 5f73 746f 7261 6765 5f6f 626a 6563 7428  _storage_object(
+0002c920: 6e61 6d65 3d73 746f 7261 6765 5f6e 616d  name=storage_nam
+0002c930: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0002c940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c960: 6d6f 6465 3d73 746f 7261 6765 5f6c 6962  mode=storage_lib
+0002c970: 2e53 746f 7261 6765 4d6f 6465 2e43 4f50  .StorageMode.COP
+0002c980: 5929 0a0a 2020 2020 4070 7974 6573 742e  Y)..    @pytest.
+0002c990: 6669 7874 7572 650a 2020 2020 6465 6620  fixture.    def 
+0002c9a0: 746d 705f 6769 7469 676e 6f72 655f 7374  tmp_gitignore_st
+0002c9b0: 6f72 6167 655f 6f62 6a28 7365 6c66 2c20  orage_obj(self, 
+0002c9c0: 746d 705f 6275 636b 6574 5f6e 616d 652c  tmp_bucket_name,
+0002c9d0: 2067 6974 6967 6e6f 7265 5f73 7472 7563   gitignore_struc
+0002c9e0: 7475 7265 293a 0a20 2020 2020 2020 2023  ture):.        #
+0002c9f0: 2043 7265 6174 6573 2061 2074 656d 706f   Creates a tempo
+0002ca00: 7261 7279 2073 746f 7261 6765 206f 626a  rary storage obj
+0002ca10: 6563 7420 666f 7220 7465 7374 696e 6720  ect for testing 
+0002ca20: 2e67 6974 6967 6e6f 7265 2066 696c 7465  .gitignore filte
+0002ca30: 722e 0a20 2020 2020 2020 2023 2047 4954  r..        # GIT
+0002ca40: 4947 494e 4f52 455f 5354 5255 4354 5552  IGINORE_STRUCTUR
+0002ca50: 4520 6973 2072 6570 7265 7365 6e74 696e  E is representin
+0002ca60: 6720 6120 6669 6c65 2073 7472 7563 7475  g a file structu
+0002ca70: 7265 2069 6e20 6120 6469 6374 696f 6e61  re in a dictiona
+0002ca80: 7279 0a20 2020 2020 2020 2023 2066 6f72  ry.        # for
+0002ca90: 6d61 742e 2043 7265 6174 6564 2073 746f  mat. Created sto
+0002caa0: 7261 6765 206f 626a 6563 7420 7769 6c6c  rage object will
+0002cab0: 2063 6f6e 7461 696e 2074 6865 2066 696c   contain the fil
+0002cac0: 6520 7374 7275 6374 7572 6520 616c 6f6e  e structure alon
+0002cad0: 670a 2020 2020 2020 2020 2320 7769 7468  g.        # with
+0002cae0: 202e 6769 7469 676e 6f72 6520 616e 6420   .gitignore and 
+0002caf0: 2e67 6974 2f69 6e66 6f2f 6578 636c 7564  .git/info/exclud
+0002cb00: 6520 6669 6c65 7320 746f 2074 6573 7420  e files to test 
+0002cb10: 6578 636c 7564 6520 6669 6c74 6572 2e0a  exclude filter..
+0002cb20: 2020 2020 2020 2020 2320 5374 6f72 6573          # Stores
+0002cb30: 206d 7573 7420 6265 2061 6464 6564 2069   must be added i
+0002cb40: 6e20 7468 6520 7465 7374 2e0a 2020 2020  n the test..    
+0002cb50: 2020 2020 7769 7468 2074 656d 7066 696c      with tempfil
+0002cb60: 652e 5465 6d70 6f72 6172 7944 6972 6563  e.TemporaryDirec
+0002cb70: 746f 7279 2829 2061 7320 746d 7064 6972  tory() as tmpdir
+0002cb80: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0002cb90: 4372 6561 7465 7320 6669 6c65 2073 7472  Creates file str
+0002cba0: 7563 7475 7265 2074 6f20 6265 2075 706c  ucture to be upl
+0002cbb0: 6f61 6465 6420 696e 2074 6865 2053 746f  oaded in the Sto
+0002cbc0: 7261 6765 0a20 2020 2020 2020 2020 2020  rage.           
+0002cbd0: 2073 656c 662e 6372 6561 7465 5f64 6972   self.create_dir
+0002cbe0: 5f73 7472 7563 7475 7265 2874 6d70 6469  _structure(tmpdi
+0002cbf0: 722c 2067 6974 6967 6e6f 7265 5f73 7472  r, gitignore_str
+0002cc00: 7563 7475 7265 290a 0a20 2020 2020 2020  ucture)..       
+0002cc10: 2020 2020 2023 2043 7265 6174 6520 2e67       # Create .g
+0002cc20: 6974 6967 6e6f 7265 2061 6e64 206c 6973  itignore and lis
+0002cc30: 7420 6669 6c65 732f 6469 7273 2074 6f20  t files/dirs to 
+0002cc40: 6265 2065 7863 6c75 6465 6420 696e 2069  be excluded in i
+0002cc50: 740a 2020 2020 2020 2020 2020 2020 736b  t.            sk
+0002cc60: 7970 696c 6f74 5f70 6174 6820 3d20 6f73  ypilot_path = os
+0002cc70: 2e70 6174 682e 6469 726e 616d 6528 6f73  .path.dirname(os
+0002cc80: 2e70 6174 682e 6469 726e 616d 6528 736b  .path.dirname(sk
+0002cc90: 792e 5f5f 6669 6c65 5f5f 2929 0a20 2020  y.__file__)).   
+0002cca0: 2020 2020 2020 2020 2074 656d 705f 7061           temp_pa
+0002ccb0: 7468 203d 2066 277b 746d 7064 6972 7d2f  th = f'{tmpdir}/
+0002ccc0: 2e67 6974 6967 6e6f 7265 270a 2020 2020  .gitignore'.    
+0002ccd0: 2020 2020 2020 2020 6669 6c65 5f70 6174          file_pat
+0002cce0: 6820 3d20 6f73 2e70 6174 682e 6a6f 696e  h = os.path.join
+0002ccf0: 2873 6b79 7069 6c6f 745f 7061 7468 2c20  (skypilot_path, 
+0002cd00: 2774 6573 7473 2f67 6974 6967 6e6f 7265  'tests/gitignore
+0002cd10: 5f74 6573 7427 290a 2020 2020 2020 2020  _test').        
+0002cd20: 2020 2020 7368 7574 696c 2e63 6f70 7966      shutil.copyf
+0002cd30: 696c 6528 6669 6c65 5f70 6174 682c 2074  ile(file_path, t
+0002cd40: 656d 705f 7061 7468 290a 0a20 2020 2020  emp_path)..     
+0002cd50: 2020 2020 2020 2023 2043 7265 6174 6520         # Create 
+0002cd60: 2e67 6974 2f69 6e66 6f2f 6578 636c 7564  .git/info/exclud
+0002cd70: 6520 616e 6420 6c69 7374 2066 696c 6573  e and list files
+0002cd80: 2f64 6972 7320 746f 2062 6520 6578 636c  /dirs to be excl
+0002cd90: 7564 6564 2069 6e20 6974 0a20 2020 2020  uded in it.     
+0002cda0: 2020 2020 2020 2074 656d 705f 7061 7468         temp_path
+0002cdb0: 203d 2066 277b 746d 7064 6972 7d2f 2e67   = f'{tmpdir}/.g
+0002cdc0: 6974 2f69 6e66 6f2f 270a 2020 2020 2020  it/info/'.      
+0002cdd0: 2020 2020 2020 6f73 2e6d 616b 6564 6972        os.makedir
+0002cde0: 7328 7465 6d70 5f70 6174 6829 0a20 2020  s(temp_path).   
+0002cdf0: 2020 2020 2020 2020 2074 656d 705f 6578           temp_ex
+0002ce00: 636c 7564 655f 7061 7468 203d 206f 732e  clude_path = os.
+0002ce10: 7061 7468 2e6a 6f69 6e28 7465 6d70 5f70  path.join(temp_p
+0002ce20: 6174 682c 2027 6578 636c 7564 6527 290a  ath, 'exclude').
+0002ce30: 2020 2020 2020 2020 2020 2020 6669 6c65              file
+0002ce40: 5f70 6174 6820 3d20 6f73 2e70 6174 682e  _path = os.path.
+0002ce50: 6a6f 696e 2873 6b79 7069 6c6f 745f 7061  join(skypilot_pa
+0002ce60: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+0002ce70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ce80: 2020 2020 2020 2020 2027 7465 7374 732f           'tests/
+0002ce90: 6769 745f 696e 666f 5f65 7863 6c75 6465  git_info_exclude
+0002cea0: 5f74 6573 7427 290a 2020 2020 2020 2020  _test').        
+0002ceb0: 2020 2020 7368 7574 696c 2e63 6f70 7966      shutil.copyf
+0002cec0: 696c 6528 6669 6c65 5f70 6174 682c 2074  ile(file_path, t
+0002ced0: 656d 705f 6578 636c 7564 655f 7061 7468  emp_exclude_path
+0002cee0: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+0002cef0: 2043 7265 6174 6520 736b 7920 5374 6f72   Create sky Stor
+0002cf00: 6167 6520 7769 7468 2074 6865 2066 696c  age with the fil
+0002cf10: 6573 2063 7265 6174 6564 0a20 2020 2020  es created.     
+0002cf20: 2020 2020 2020 2079 6965 6c64 2066 726f         yield fro
+0002cf30: 6d20 7365 6c66 2e79 6965 6c64 5f73 746f  m self.yield_sto
+0002cf40: 7261 6765 5f6f 626a 6563 7428 0a20 2020  rage_object(.   
+0002cf50: 2020 2020 2020 2020 2020 2020 206e 616d               nam
+0002cf60: 653d 746d 705f 6275 636b 6574 5f6e 616d  e=tmp_bucket_nam
+0002cf70: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0002cf80: 2020 2073 6f75 7263 653d 746d 7064 6972     source=tmpdir
+0002cf90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002cfa0: 2020 6d6f 6465 3d73 746f 7261 6765 5f6c    mode=storage_l
+0002cfb0: 6962 2e53 746f 7261 6765 4d6f 6465 2e43  ib.StorageMode.C
+0002cfc0: 4f50 5929 0a0a 2020 2020 4070 7974 6573  OPY)..    @pytes
+0002cfd0: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
+0002cfe0: 6620 746d 705f 6177 7363 6c69 5f62 7563  f tmp_awscli_buc
+0002cff0: 6b65 7428 7365 6c66 2c20 746d 705f 6275  ket(self, tmp_bu
+0002d000: 636b 6574 5f6e 616d 6529 3a0a 2020 2020  cket_name):.    
+0002d010: 2020 2020 2320 4372 6561 7465 7320 6120      # Creates a 
+0002d020: 7465 6d70 6f72 6172 7920 6275 636b 6574  temporary bucket
+0002d030: 2075 7369 6e67 2061 7773 636c 690a 2020   using awscli.  
+0002d040: 2020 2020 2020 6275 636b 6574 5f75 7269        bucket_uri
+0002d050: 203d 2066 2773 333a 2f2f 7b74 6d70 5f62   = f's3://{tmp_b
+0002d060: 7563 6b65 745f 6e61 6d65 7d27 0a20 2020  ucket_name}'.   
+0002d070: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
+0002d080: 6368 6563 6b5f 6361 6c6c 285b 2761 7773  check_call(['aws
+0002d090: 272c 2027 7333 272c 2027 6d62 272c 2062  ', 's3', 'mb', b
+0002d0a0: 7563 6b65 745f 7572 695d 290a 2020 2020  ucket_uri]).    
+0002d0b0: 2020 2020 7969 656c 6420 746d 705f 6275      yield tmp_bu
+0002d0c0: 636b 6574 5f6e 616d 652c 2062 7563 6b65  cket_name, bucke
+0002d0d0: 745f 7572 690a 2020 2020 2020 2020 7375  t_uri.        su
+0002d0e0: 6270 726f 6365 7373 2e63 6865 636b 5f63  bprocess.check_c
+0002d0f0: 616c 6c28 5b27 6177 7327 2c20 2773 3327  all(['aws', 's3'
+0002d100: 2c20 2772 6227 2c20 6275 636b 6574 5f75  , 'rb', bucket_u
+0002d110: 7269 2c20 272d 2d66 6f72 6365 275d 290a  ri, '--force']).
+0002d120: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
+0002d130: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
+0002d140: 5f67 7375 7469 6c5f 6275 636b 6574 2873  _gsutil_bucket(s
+0002d150: 656c 662c 2074 6d70 5f62 7563 6b65 745f  elf, tmp_bucket_
+0002d160: 6e61 6d65 293a 0a20 2020 2020 2020 2023  name):.        #
+0002d170: 2043 7265 6174 6573 2061 2074 656d 706f   Creates a tempo
+0002d180: 7261 7279 2062 7563 6b65 7420 7573 696e  rary bucket usin
+0002d190: 6720 6773 7574 696c 0a20 2020 2020 2020  g gsutil.       
+0002d1a0: 2062 7563 6b65 745f 7572 6920 3d20 6627   bucket_uri = f'
+0002d1b0: 6773 3a2f 2f7b 746d 705f 6275 636b 6574  gs://{tmp_bucket
+0002d1c0: 5f6e 616d 657d 270a 2020 2020 2020 2020  _name}'.        
+0002d1d0: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+0002d1e0: 5f63 616c 6c28 5b27 6773 7574 696c 272c  _call(['gsutil',
+0002d1f0: 2027 6d62 272c 2062 7563 6b65 745f 7572   'mb', bucket_ur
+0002d200: 695d 290a 2020 2020 2020 2020 7969 656c  i]).        yiel
+0002d210: 6420 746d 705f 6275 636b 6574 5f6e 616d  d tmp_bucket_nam
+0002d220: 652c 2062 7563 6b65 745f 7572 690a 2020  e, bucket_uri.  
+0002d230: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
+0002d240: 2e63 6865 636b 5f63 616c 6c28 5b27 6773  .check_call(['gs
+0002d250: 7574 696c 272c 2027 726d 272c 2027 2d72  util', 'rm', '-r
+0002d260: 272c 2062 7563 6b65 745f 7572 695d 290a  ', bucket_uri]).
+0002d270: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
+0002d280: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
+0002d290: 5f61 7773 636c 695f 6275 636b 6574 5f72  _awscli_bucket_r
+0002d2a0: 3228 7365 6c66 2c20 746d 705f 6275 636b  2(self, tmp_buck
+0002d2b0: 6574 5f6e 616d 6529 3a0a 2020 2020 2020  et_name):.      
+0002d2c0: 2020 2320 4372 6561 7465 7320 6120 7465    # Creates a te
+0002d2d0: 6d70 6f72 6172 7920 6275 636b 6574 2075  mporary bucket u
+0002d2e0: 7369 6e67 2061 7773 636c 690a 2020 2020  sing awscli.    
+0002d2f0: 2020 2020 656e 6470 6f69 6e74 5f75 726c      endpoint_url
+0002d300: 203d 2063 6c6f 7564 666c 6172 652e 6372   = cloudflare.cr
+0002d310: 6561 7465 5f65 6e64 706f 696e 7428 290a  eate_endpoint().
+0002d320: 2020 2020 2020 2020 6275 636b 6574 5f75          bucket_u
+0002d330: 7269 203d 2066 2773 333a 2f2f 7b74 6d70  ri = f's3://{tmp
+0002d340: 5f62 7563 6b65 745f 6e61 6d65 7d27 0a20  _bucket_name}'. 
+0002d350: 2020 2020 2020 2073 7562 7072 6f63 6573         subproces
+0002d360: 732e 6368 6563 6b5f 6361 6c6c 280a 2020  s.check_call(.  
+0002d370: 2020 2020 2020 2020 2020 6627 4157 535f            f'AWS_
+0002d380: 5348 4152 4544 5f43 5245 4445 4e54 4941  SHARED_CREDENTIA
+0002d390: 4c53 5f46 494c 453d 7b63 6c6f 7564 666c  LS_FILE={cloudfl
+0002d3a0: 6172 652e 5232 5f43 5245 4445 4e54 4941  are.R2_CREDENTIA
+0002d3b0: 4c53 5f50 4154 487d 2061 7773 2073 3320  LS_PATH} aws s3 
+0002d3c0: 6d62 207b 6275 636b 6574 5f75 7269 7d20  mb {bucket_uri} 
+0002d3d0: 2d2d 656e 6470 6f69 6e74 207b 656e 6470  --endpoint {endp
+0002d3e0: 6f69 6e74 5f75 726c 7d20 2d2d 7072 6f66  oint_url} --prof
+0002d3f0: 696c 653d 7232 272c 0a20 2020 2020 2020  ile=r2',.       
+0002d400: 2020 2020 2073 6865 6c6c 3d54 7275 6529       shell=True)
+0002d410: 0a20 2020 2020 2020 2079 6965 6c64 2074  .        yield t
+0002d420: 6d70 5f62 7563 6b65 745f 6e61 6d65 2c20  mp_bucket_name, 
+0002d430: 6275 636b 6574 5f75 7269 0a20 2020 2020  bucket_uri.     
+0002d440: 2020 2073 7562 7072 6f63 6573 732e 6368     subprocess.ch
+0002d450: 6563 6b5f 6361 6c6c 280a 2020 2020 2020  eck_call(.      
+0002d460: 2020 2020 2020 6627 4157 535f 5348 4152        f'AWS_SHAR
+0002d470: 4544 5f43 5245 4445 4e54 4941 4c53 5f46  ED_CREDENTIALS_F
+0002d480: 494c 453d 7b63 6c6f 7564 666c 6172 652e  ILE={cloudflare.
+0002d490: 5232 5f43 5245 4445 4e54 4941 4c53 5f50  R2_CREDENTIALS_P
+0002d4a0: 4154 487d 2061 7773 2073 3320 7262 207b  ATH} aws s3 rb {
+0002d4b0: 6275 636b 6574 5f75 7269 7d20 2d2d 666f  bucket_uri} --fo
+0002d4c0: 7263 6520 2d2d 656e 6470 6f69 6e74 207b  rce --endpoint {
+0002d4d0: 656e 6470 6f69 6e74 5f75 726c 7d20 2d2d  endpoint_url} --
+0002d4e0: 7072 6f66 696c 653d 7232 272c 0a20 2020  profile=r2',.   
+0002d4f0: 2020 2020 2020 2020 2073 6865 6c6c 3d54           shell=T
+0002d500: 7275 6529 0a0a 2020 2020 4070 7974 6573  rue)..    @pytes
+0002d510: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
+0002d520: 6620 746d 705f 6962 6d5f 636f 735f 6275  f tmp_ibm_cos_bu
+0002d530: 636b 6574 2873 656c 662c 2074 6d70 5f62  cket(self, tmp_b
+0002d540: 7563 6b65 745f 6e61 6d65 293a 0a20 2020  ucket_name):.   
+0002d550: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
+0002d560: 2074 656d 706f 7261 7279 2062 7563 6b65   temporary bucke
+0002d570: 7420 7573 696e 6720 4942 4d20 434f 5320  t using IBM COS 
+0002d580: 4150 490a 2020 2020 2020 2020 7374 6f72  API.        stor
+0002d590: 6167 655f 6f62 6a20 3d20 7374 6f72 6167  age_obj = storag
+0002d5a0: 655f 6c69 622e 4942 4d43 6f73 5374 6f72  e_lib.IBMCosStor
+0002d5b0: 6528 736f 7572 6365 3d22 222c 206e 616d  e(source="", nam
+0002d5c0: 653d 746d 705f 6275 636b 6574 5f6e 616d  e=tmp_bucket_nam
+0002d5d0: 6529 0a20 2020 2020 2020 2079 6965 6c64  e).        yield
+0002d5e0: 2074 6d70 5f62 7563 6b65 745f 6e61 6d65   tmp_bucket_name
+0002d5f0: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
+0002d600: 5f6f 626a 2e64 656c 6574 6528 290a 0a20  _obj.delete().. 
+0002d610: 2020 2040 7079 7465 7374 2e66 6978 7475     @pytest.fixtu
+0002d620: 7265 0a20 2020 2064 6566 2074 6d70 5f70  re.    def tmp_p
+0002d630: 7562 6c69 635f 7374 6f72 6167 655f 6f62  ublic_storage_ob
+0002d640: 6a28 7365 6c66 2c20 7265 7175 6573 7429  j(self, request)
+0002d650: 3a0a 2020 2020 2020 2020 2320 496e 6974  :.        # Init
+0002d660: 6961 6c69 7a65 7320 6120 7374 6f72 6167  ializes a storag
+0002d670: 6520 6f62 6a65 6374 2077 6974 6820 6120  e object with a 
+0002d680: 7075 626c 6963 2062 7563 6b65 740a 2020  public bucket.  
+0002d690: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
+0002d6a0: 6a20 3d20 7374 6f72 6167 655f 6c69 622e  j = storage_lib.
+0002d6b0: 5374 6f72 6167 6528 736f 7572 6365 3d72  Storage(source=r
+0002d6c0: 6571 7565 7374 2e70 6172 616d 290a 2020  equest.param).  
+0002d6d0: 2020 2020 2020 7969 656c 6420 7374 6f72        yield stor
+0002d6e0: 6167 655f 6f62 6a0a 2020 2020 2020 2020  age_obj.        
+0002d6f0: 2320 5468 6973 2064 6f65 7320 6e6f 7420  # This does not 
+0002d700: 7265 7175 6972 6520 616e 7920 6465 6c65  require any dele
+0002d710: 7469 6f6e 206c 6f67 6963 2062 6563 6175  tion logic becau
+0002d720: 7365 2069 7420 6973 2061 2070 7562 6c69  se it is a publi
+0002d730: 6320 6275 636b 6574 0a20 2020 2020 2020  c bucket.       
+0002d740: 2023 2061 6e64 2073 686f 756c 6420 6e6f   # and should no
+0002d750: 7420 6765 7420 6164 6465 6420 746f 2067  t get added to g
+0002d760: 6c6f 6261 6c5f 7573 6572 5f73 7461 7465  lobal_user_state
+0002d770: 2e0a 0a20 2020 2040 7079 7465 7374 2e6d  ...    @pytest.m
+0002d780: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
+0002d790: 6b0a 2020 2020 4070 7974 6573 742e 6d61  k.    @pytest.ma
+0002d7a0: 726b 2e70 6172 616d 6574 7269 7a65 2827  rk.parametrize('
+0002d7b0: 7374 6f72 655f 7479 7065 272c 205b 0a20  store_type', [. 
+0002d7c0: 2020 2020 2020 2073 746f 7261 6765 5f6c         storage_l
+0002d7d0: 6962 2e53 746f 7265 5479 7065 2e53 332c  ib.StoreType.S3,
+0002d7e0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+0002d7f0: 7265 5479 7065 2e47 4353 2c0a 2020 2020  reType.GCS,.    
+0002d800: 2020 2020 7079 7465 7374 2e70 6172 616d      pytest.param
+0002d810: 2873 746f 7261 6765 5f6c 6962 2e53 746f  (storage_lib.Sto
+0002d820: 7265 5479 7065 2e49 424d 2c20 6d61 726b  reType.IBM, mark
+0002d830: 733d 7079 7465 7374 2e6d 6172 6b2e 6962  s=pytest.mark.ib
+0002d840: 6d29 2c0a 2020 2020 2020 2020 7079 7465  m),.        pyte
+0002d850: 7374 2e70 6172 616d 2873 746f 7261 6765  st.param(storage
+0002d860: 5f6c 6962 2e53 746f 7265 5479 7065 2e52  _lib.StoreType.R
+0002d870: 322c 206d 6172 6b73 3d70 7974 6573 742e  2, marks=pytest.
+0002d880: 6d61 726b 2e63 6c6f 7564 666c 6172 6529  mark.cloudflare)
+0002d890: 0a20 2020 205d 290a 2020 2020 6465 6620  .    ]).    def 
+0002d8a0: 7465 7374 5f6e 6577 5f62 7563 6b65 745f  test_new_bucket_
+0002d8b0: 6372 6561 7469 6f6e 5f61 6e64 5f64 656c  creation_and_del
+0002d8c0: 6574 696f 6e28 7365 6c66 2c20 746d 705f  etion(self, tmp_
+0002d8d0: 6c6f 6361 6c5f 7374 6f72 6167 655f 6f62  local_storage_ob
+0002d8e0: 6a2c 0a20 2020 2020 2020 2020 2020 2020  j,.             
+0002d8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d910: 2073 746f 7265 5f74 7970 6529 3a0a 2020   store_type):.  
+0002d920: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
+0002d930: 6120 6e65 7720 6275 636b 6574 2077 6974  a new bucket wit
+0002d940: 6820 6120 6c6f 6361 6c20 736f 7572 6365  h a local source
+0002d950: 2c20 7570 6c6f 6164 7320 6669 6c65 7320  , uploads files 
+0002d960: 746f 2069 740a 2020 2020 2020 2020 2320  to it.        # 
+0002d970: 616e 6420 6465 6c65 7465 7320 6974 2e0a  and deletes it..
+0002d980: 2020 2020 2020 2020 746d 705f 6c6f 6361          tmp_loca
+0002d990: 6c5f 7374 6f72 6167 655f 6f62 6a2e 6164  l_storage_obj.ad
+0002d9a0: 645f 7374 6f72 6528 7374 6f72 655f 7479  d_store(store_ty
+0002d9b0: 7065 290a 0a20 2020 2020 2020 2023 2052  pe)..        # R
+0002d9c0: 756e 2073 6b79 2073 746f 7261 6765 206c  un sky storage l
+0002d9d0: 7320 746f 2063 6865 636b 2069 6620 7374  s to check if st
+0002d9e0: 6f72 6167 6520 6f62 6a65 6374 2065 7869  orage object exi
+0002d9f0: 7374 7320 696e 2074 6865 206f 7574 7075  sts in the outpu
+0002da00: 740a 2020 2020 2020 2020 6f75 7420 3d20  t.        out = 
+0002da10: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+0002da20: 5f6f 7574 7075 7428 5b27 736b 7927 2c20  _output(['sky', 
+0002da30: 2773 746f 7261 6765 272c 2027 6c73 275d  'storage', 'ls']
+0002da40: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+0002da50: 2074 6d70 5f6c 6f63 616c 5f73 746f 7261   tmp_local_stora
+0002da60: 6765 5f6f 626a 2e6e 616d 6520 696e 206f  ge_obj.name in o
+0002da70: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
+0002da80: 2729 0a0a 2020 2020 2020 2020 2320 5275  ')..        # Ru
+0002da90: 6e20 736b 7920 7374 6f72 6167 6520 6465  n sky storage de
+0002daa0: 6c65 7465 2074 6f20 6465 6c65 7465 2074  lete to delete t
+0002dab0: 6865 2073 746f 7261 6765 206f 626a 6563  he storage objec
+0002dac0: 740a 2020 2020 2020 2020 7375 6270 726f  t.        subpro
+0002dad0: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
+0002dae0: 7428 0a20 2020 2020 2020 2020 2020 205b  t(.            [
+0002daf0: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
+0002db00: 2c20 2764 656c 6574 6527 2c20 746d 705f  , 'delete', tmp_
+0002db10: 6c6f 6361 6c5f 7374 6f72 6167 655f 6f62  local_storage_ob
+0002db20: 6a2e 6e61 6d65 2c20 272d 2d79 6573 275d  j.name, '--yes']
+0002db30: 290a 0a20 2020 2020 2020 2023 2052 756e  )..        # Run
+0002db40: 2073 6b79 2073 746f 7261 6765 206c 7320   sky storage ls 
+0002db50: 746f 2063 6865 636b 2069 6620 7374 6f72  to check if stor
+0002db60: 6167 6520 6f62 6a65 6374 2069 7320 6465  age object is de
+0002db70: 6c65 7465 640a 2020 2020 2020 2020 6f75  leted.        ou
+0002db80: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
+0002db90: 6865 636b 5f6f 7574 7075 7428 5b27 736b  heck_output(['sk
+0002dba0: 7927 2c20 2773 746f 7261 6765 272c 2027  y', 'storage', '
+0002dbb0: 6c73 275d 290a 2020 2020 2020 2020 6173  ls']).        as
+0002dbc0: 7365 7274 2074 6d70 5f6c 6f63 616c 5f73  sert tmp_local_s
+0002dbd0: 746f 7261 6765 5f6f 626a 2e6e 616d 6520  torage_obj.name 
+0002dbe0: 6e6f 7420 696e 206f 7574 2e64 6563 6f64  not in out.decod
+0002dbf0: 6528 2775 7466 2d38 2729 0a0a 2020 2020  e('utf-8')..    
+0002dc00: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+0002dc10: 666c 7569 6473 7461 636b 0a20 2020 2040  fluidstack.    @
+0002dc20: 7079 7465 7374 2e6d 6172 6b2e 7864 6973  pytest.mark.xdis
+0002dc30: 745f 6772 6f75 7028 276d 756c 7469 706c  t_group('multipl
+0002dc40: 655f 6275 636b 6574 5f64 656c 6574 696f  e_bucket_deletio
+0002dc50: 6e27 290a 2020 2020 4070 7974 6573 742e  n').    @pytest.
+0002dc60: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
+0002dc70: 2827 7374 6f72 655f 7479 7065 272c 205b  ('store_type', [
+0002dc80: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
+0002dc90: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
+0002dca0: 332c 2073 746f 7261 6765 5f6c 6962 2e53  3, storage_lib.S
+0002dcb0: 746f 7265 5479 7065 2e47 4353 2c0a 2020  toreType.GCS,.  
+0002dcc0: 2020 2020 2020 7079 7465 7374 2e70 6172        pytest.par
+0002dcd0: 616d 2873 746f 7261 6765 5f6c 6962 2e53  am(storage_lib.S
+0002dce0: 746f 7265 5479 7065 2e52 322c 206d 6172  toreType.R2, mar
+0002dcf0: 6b73 3d70 7974 6573 742e 6d61 726b 2e63  ks=pytest.mark.c
+0002dd00: 6c6f 7564 666c 6172 6529 2c0a 2020 2020  loudflare),.    
+0002dd10: 2020 2020 7079 7465 7374 2e70 6172 616d      pytest.param
+0002dd20: 2873 746f 7261 6765 5f6c 6962 2e53 746f  (storage_lib.Sto
+0002dd30: 7265 5479 7065 2e49 424d 2c20 6d61 726b  reType.IBM, mark
+0002dd40: 733d 7079 7465 7374 2e6d 6172 6b2e 6962  s=pytest.mark.ib
+0002dd50: 6d29 0a20 2020 205d 290a 2020 2020 6465  m).    ]).    de
+0002dd60: 6620 7465 7374 5f6d 756c 7469 706c 655f  f test_multiple_
+0002dd70: 6275 636b 6574 735f 6372 6561 7469 6f6e  buckets_creation
+0002dd80: 5f61 6e64 5f64 656c 6574 696f 6e28 0a20  _and_deletion(. 
+0002dd90: 2020 2020 2020 2020 2020 2073 656c 662c             self,
+0002dda0: 2074 6d70 5f6d 756c 7469 706c 655f 7363   tmp_multiple_sc
+0002ddb0: 7261 7463 685f 7374 6f72 6167 655f 6f62  ratch_storage_ob
+0002ddc0: 6a2c 2073 746f 7265 5f74 7970 6529 3a0a  j, store_type):.
+0002ddd0: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
+0002dde0: 7320 6d75 6c74 6970 6c65 206e 6577 2062  s multiple new b
+0002ddf0: 7563 6b65 7473 2835 2062 7563 6b65 7473  uckets(5 buckets
+0002de00: 2920 7769 7468 2061 206c 6f63 616c 2073  ) with a local s
+0002de10: 6f75 7263 650a 2020 2020 2020 2020 2320  ource.        # 
+0002de20: 616e 6420 6465 6c65 7465 7320 7468 656d  and deletes them
+0002de30: 2e0a 2020 2020 2020 2020 7374 6f72 6167  ..        storag
+0002de40: 655f 6f62 6a5f 6e61 6d65 203d 205b 5d0a  e_obj_name = [].
+0002de50: 2020 2020 2020 2020 666f 7220 7374 6f72          for stor
+0002de60: 655f 6f62 6a20 696e 2074 6d70 5f6d 756c  e_obj in tmp_mul
+0002de70: 7469 706c 655f 7363 7261 7463 685f 7374  tiple_scratch_st
+0002de80: 6f72 6167 655f 6f62 6a3a 0a20 2020 2020  orage_obj:.     
+0002de90: 2020 2020 2020 2073 746f 7265 5f6f 626a         store_obj
+0002dea0: 2e61 6464 5f73 746f 7265 2873 746f 7265  .add_store(store
+0002deb0: 5f74 7970 6529 0a20 2020 2020 2020 2020  _type).         
+0002dec0: 2020 2073 746f 7261 6765 5f6f 626a 5f6e     storage_obj_n
+0002ded0: 616d 652e 6170 7065 6e64 2873 746f 7265  ame.append(store
+0002dee0: 5f6f 626a 2e6e 616d 6529 0a0a 2020 2020  _obj.name)..    
+0002def0: 2020 2020 2320 5275 6e20 736b 7920 7374      # Run sky st
+0002df00: 6f72 6167 6520 6c73 2074 6f20 6368 6563  orage ls to chec
+0002df10: 6b20 6966 2061 6c6c 2073 746f 7261 6765  k if all storage
+0002df20: 206f 626a 6563 7473 2065 7869 7374 7320   objects exists 
+0002df30: 696e 2074 6865 0a20 2020 2020 2020 2023  in the.        #
+0002df40: 206f 7574 7075 7420 6669 6c74 6572 6564   output filtered
+0002df50: 2062 7920 7374 6f72 6520 7479 7065 0a20   by store type. 
+0002df60: 2020 2020 2020 206f 7574 5f61 6c6c 203d         out_all =
+0002df70: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+0002df80: 6b5f 6f75 7470 7574 285b 2773 6b79 272c  k_output(['sky',
+0002df90: 2027 7374 6f72 6167 6527 2c20 276c 7327   'storage', 'ls'
+0002dfa0: 5d29 0a20 2020 2020 2020 206f 7574 203d  ]).        out =
+0002dfb0: 205b 0a20 2020 2020 2020 2020 2020 2069   [.            i
+0002dfc0: 7465 6d2e 7370 6c69 7428 295b 305d 0a20  tem.split()[0]. 
+0002dfd0: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+0002dfe0: 7465 6d20 696e 206f 7574 5f61 6c6c 2e64  tem in out_all.d
+0002dff0: 6563 6f64 6528 2775 7466 2d38 2729 2e73  ecode('utf-8').s
+0002e000: 706c 6974 6c69 6e65 7328 290a 2020 2020  plitlines().    
+0002e010: 2020 2020 2020 2020 6966 2073 746f 7265          if store
+0002e020: 5f74 7970 652e 7661 6c75 6520 696e 2069  _type.value in i
+0002e030: 7465 6d0a 2020 2020 2020 2020 5d0a 2020  tem.        ].  
+0002e040: 2020 2020 2020 6173 7365 7274 2061 6c6c        assert all
+0002e050: 285b 6974 656d 2069 6e20 6f75 7420 666f  ([item in out fo
+0002e060: 7220 6974 656d 2069 6e20 7374 6f72 6167  r item in storag
+0002e070: 655f 6f62 6a5f 6e61 6d65 5d29 0a0a 2020  e_obj_name])..  
+0002e080: 2020 2020 2020 2320 5275 6e20 736b 7920        # Run sky 
+0002e090: 7374 6f72 6167 6520 6465 6c65 7465 2061  storage delete a
+0002e0a0: 6c6c 2074 6f20 6465 6c65 7465 2061 6c6c  ll to delete all
+0002e0b0: 2073 746f 7261 6765 206f 626a 6563 7473   storage objects
+0002e0c0: 0a20 2020 2020 2020 2064 656c 6574 655f  .        delete_
+0002e0d0: 636d 6420 3d20 5b27 736b 7927 2c20 2773  cmd = ['sky', 's
+0002e0e0: 746f 7261 6765 272c 2027 6465 6c65 7465  torage', 'delete
+0002e0f0: 272c 2027 2d2d 7965 7327 5d0a 2020 2020  ', '--yes'].    
+0002e100: 2020 2020 6465 6c65 7465 5f63 6d64 202b      delete_cmd +
+0002e110: 3d20 7374 6f72 6167 655f 6f62 6a5f 6e61  = storage_obj_na
+0002e120: 6d65 0a20 2020 2020 2020 2073 7562 7072  me.        subpr
+0002e130: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+0002e140: 7574 2864 656c 6574 655f 636d 6429 0a0a  ut(delete_cmd)..
+0002e150: 2020 2020 2020 2020 2320 5275 6e20 736b          # Run sk
+0002e160: 7920 7374 6f72 6167 6520 6c73 2074 6f20  y storage ls to 
+0002e170: 6368 6563 6b20 6966 2061 6c6c 2073 746f  check if all sto
+0002e180: 7261 6765 206f 626a 6563 7473 2066 696c  rage objects fil
+0002e190: 7465 7265 6420 6279 2073 746f 7265 0a20  tered by store. 
+0002e1a0: 2020 2020 2020 2023 2074 7970 6520 6172         # type ar
+0002e1b0: 6520 6465 6c65 7465 640a 2020 2020 2020  e deleted.      
+0002e1c0: 2020 6f75 745f 616c 6c20 3d20 7375 6270    out_all = subp
+0002e1d0: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+0002e1e0: 7075 7428 5b27 736b 7927 2c20 2773 746f  put(['sky', 'sto
+0002e1f0: 7261 6765 272c 2027 6c73 275d 290a 2020  rage', 'ls']).  
+0002e200: 2020 2020 2020 6f75 7420 3d20 5b0a 2020        out = [.  
+0002e210: 2020 2020 2020 2020 2020 6974 656d 2e73            item.s
+0002e220: 706c 6974 2829 5b30 5d0a 2020 2020 2020  plit()[0].      
+0002e230: 2020 2020 2020 666f 7220 6974 656d 2069        for item i
+0002e240: 6e20 6f75 745f 616c 6c2e 6465 636f 6465  n out_all.decode
+0002e250: 2827 7574 662d 3827 292e 7370 6c69 746c  ('utf-8').splitl
+0002e260: 696e 6573 2829 0a20 2020 2020 2020 2020  ines().         
+0002e270: 2020 2069 6620 7374 6f72 655f 7479 7065     if store_type
+0002e280: 2e76 616c 7565 2069 6e20 6974 656d 0a20  .value in item. 
+0002e290: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+0002e2a0: 2061 7373 6572 7420 616c 6c28 5b69 7465   assert all([ite
+0002e2b0: 6d20 6e6f 7420 696e 206f 7574 2066 6f72  m not in out for
+0002e2c0: 2069 7465 6d20 696e 2073 746f 7261 6765   item in storage
+0002e2d0: 5f6f 626a 5f6e 616d 655d 290a 0a20 2020  _obj_name])..   
+0002e2e0: 2040 7079 7465 7374 2e6d 6172 6b2e 6e6f   @pytest.mark.no
+0002e2f0: 5f66 6c75 6964 7374 6163 6b0a 2020 2020  _fluidstack.    
+0002e300: 4070 7974 6573 742e 6d61 726b 2e70 6172  @pytest.mark.par
+0002e310: 616d 6574 7269 7a65 2827 7374 6f72 655f  ametrize('store_
+0002e320: 7479 7065 272c 205b 0a20 2020 2020 2020  type', [.       
+0002e330: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+0002e340: 7265 5479 7065 2e53 332c 2073 746f 7261  reType.S3, stora
+0002e350: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0002e360: 2e47 4353 2c0a 2020 2020 2020 2020 7079  .GCS,.        py
+0002e370: 7465 7374 2e70 6172 616d 2873 746f 7261  test.param(stora
+0002e380: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0002e390: 2e49 424d 2c20 6d61 726b 733d 7079 7465  .IBM, marks=pyte
+0002e3a0: 7374 2e6d 6172 6b2e 6962 6d29 2c0a 2020  st.mark.ibm),.  
+0002e3b0: 2020 2020 2020 7079 7465 7374 2e70 6172        pytest.par
+0002e3c0: 616d 2873 746f 7261 6765 5f6c 6962 2e53  am(storage_lib.S
+0002e3d0: 746f 7265 5479 7065 2e52 322c 206d 6172  toreType.R2, mar
+0002e3e0: 6b73 3d70 7974 6573 742e 6d61 726b 2e63  ks=pytest.mark.c
+0002e3f0: 6c6f 7564 666c 6172 6529 0a20 2020 205d  loudflare).    ]
+0002e400: 290a 2020 2020 6465 6620 7465 7374 5f75  ).    def test_u
+0002e410: 706c 6f61 645f 736f 7572 6365 5f77 6974  pload_source_wit
+0002e420: 685f 7370 6163 6573 2873 656c 662c 2073  h_spaces(self, s
+0002e430: 746f 7265 5f74 7970 652c 0a20 2020 2020  tore_type,.     
+0002e440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e460: 2020 746d 705f 6d75 6c74 6970 6c65 5f63    tmp_multiple_c
+0002e470: 7573 746f 6d5f 736f 7572 6365 5f73 746f  ustom_source_sto
+0002e480: 7261 6765 5f6f 626a 293a 0a20 2020 2020  rage_obj):.     
+0002e490: 2020 2023 2043 7265 6174 6573 2074 776f     # Creates two
+0002e4a0: 2062 7563 6b65 7473 2077 6974 6820 7370   buckets with sp
+0002e4b0: 6563 6966 6965 6420 6c6f 6361 6c20 736f  ecified local so
+0002e4c0: 7572 6365 730a 2020 2020 2020 2020 2320  urces.        # 
+0002e4d0: 7769 7468 2073 7061 6365 7320 696e 2074  with spaces in t
+0002e4e0: 6865 206e 616d 650a 2020 2020 2020 2020  he name.        
+0002e4f0: 7374 6f72 6167 655f 6f62 6a5f 6e61 6d65  storage_obj_name
+0002e500: 7320 3d20 5b5d 0a20 2020 2020 2020 2066  s = [].        f
+0002e510: 6f72 2073 746f 7261 6765 5f6f 626a 2069  or storage_obj i
+0002e520: 6e20 746d 705f 6d75 6c74 6970 6c65 5f63  n tmp_multiple_c
+0002e530: 7573 746f 6d5f 736f 7572 6365 5f73 746f  ustom_source_sto
+0002e540: 7261 6765 5f6f 626a 3a0a 2020 2020 2020  rage_obj:.      
+0002e550: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
+0002e560: 6a2e 6164 645f 7374 6f72 6528 7374 6f72  j.add_store(stor
+0002e570: 655f 7479 7065 290a 2020 2020 2020 2020  e_type).        
+0002e580: 2020 2020 7374 6f72 6167 655f 6f62 6a5f      storage_obj_
+0002e590: 6e61 6d65 732e 6170 7065 6e64 2873 746f  names.append(sto
+0002e5a0: 7261 6765 5f6f 626a 2e6e 616d 6529 0a0a  rage_obj.name)..
+0002e5b0: 2020 2020 2020 2020 2320 5275 6e20 736b          # Run sk
+0002e5c0: 7920 7374 6f72 6167 6520 6c73 2074 6f20  y storage ls to 
+0002e5d0: 6368 6563 6b20 6966 2061 6c6c 2073 746f  check if all sto
+0002e5e0: 7261 6765 206f 626a 6563 7473 2065 7869  rage objects exi
+0002e5f0: 7374 7320 696e 2074 6865 0a20 2020 2020  sts in the.     
+0002e600: 2020 2023 206f 7574 7075 7420 6669 6c74     # output filt
+0002e610: 6572 6564 2062 7920 7374 6f72 6520 7479  ered by store ty
+0002e620: 7065 0a20 2020 2020 2020 206f 7574 5f61  pe.        out_a
+0002e630: 6c6c 203d 2073 7562 7072 6f63 6573 732e  ll = subprocess.
+0002e640: 6368 6563 6b5f 6f75 7470 7574 285b 2773  check_output(['s
+0002e650: 6b79 272c 2027 7374 6f72 6167 6527 2c20  ky', 'storage', 
+0002e660: 276c 7327 5d29 0a20 2020 2020 2020 206f  'ls']).        o
+0002e670: 7574 203d 205b 0a20 2020 2020 2020 2020  ut = [.         
+0002e680: 2020 2069 7465 6d2e 7370 6c69 7428 295b     item.split()[
+0002e690: 305d 0a20 2020 2020 2020 2020 2020 2066  0].            f
+0002e6a0: 6f72 2069 7465 6d20 696e 206f 7574 5f61  or item in out_a
+0002e6b0: 6c6c 2e64 6563 6f64 6528 2775 7466 2d38  ll.decode('utf-8
+0002e6c0: 2729 2e73 706c 6974 6c69 6e65 7328 290a  ').splitlines().
+0002e6d0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+0002e6e0: 746f 7265 5f74 7970 652e 7661 6c75 6520  tore_type.value 
+0002e6f0: 696e 2069 7465 6d0a 2020 2020 2020 2020  in item.        
+0002e700: 5d0a 2020 2020 2020 2020 6173 7365 7274  ].        assert
+0002e710: 2061 6c6c 285b 6974 656d 2069 6e20 6f75   all([item in ou
+0002e720: 7420 666f 7220 6974 656d 2069 6e20 7374  t for item in st
+0002e730: 6f72 6167 655f 6f62 6a5f 6e61 6d65 735d  orage_obj_names]
+0002e740: 290a 0a20 2020 2040 7079 7465 7374 2e6d  )..    @pytest.m
+0002e750: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
+0002e760: 6b0a 2020 2020 4070 7974 6573 742e 6d61  k.    @pytest.ma
+0002e770: 726b 2e70 6172 616d 6574 7269 7a65 2827  rk.parametrize('
+0002e780: 7374 6f72 655f 7479 7065 272c 205b 0a20  store_type', [. 
+0002e790: 2020 2020 2020 2073 746f 7261 6765 5f6c         storage_l
+0002e7a0: 6962 2e53 746f 7265 5479 7065 2e53 332c  ib.StoreType.S3,
+0002e7b0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+0002e7c0: 7265 5479 7065 2e47 4353 2c0a 2020 2020  reType.GCS,.    
+0002e7d0: 2020 2020 7079 7465 7374 2e70 6172 616d      pytest.param
+0002e7e0: 2873 746f 7261 6765 5f6c 6962 2e53 746f  (storage_lib.Sto
+0002e7f0: 7265 5479 7065 2e49 424d 2c20 6d61 726b  reType.IBM, mark
+0002e800: 733d 7079 7465 7374 2e6d 6172 6b2e 6962  s=pytest.mark.ib
+0002e810: 6d29 2c0a 2020 2020 2020 2020 7079 7465  m),.        pyte
+0002e820: 7374 2e70 6172 616d 2873 746f 7261 6765  st.param(storage
+0002e830: 5f6c 6962 2e53 746f 7265 5479 7065 2e52  _lib.StoreType.R
+0002e840: 322c 206d 6172 6b73 3d70 7974 6573 742e  2, marks=pytest.
+0002e850: 6d61 726b 2e63 6c6f 7564 666c 6172 6529  mark.cloudflare)
+0002e860: 0a20 2020 205d 290a 2020 2020 6465 6620  .    ]).    def 
+0002e870: 7465 7374 5f62 7563 6b65 745f 6578 7465  test_bucket_exte
+0002e880: 726e 616c 5f64 656c 6574 696f 6e28 7365  rnal_deletion(se
+0002e890: 6c66 2c20 746d 705f 7363 7261 7463 685f  lf, tmp_scratch_
+0002e8a0: 7374 6f72 6167 655f 6f62 6a2c 0a20 2020  storage_obj,.   
+0002e8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e8d0: 2020 2073 746f 7265 5f74 7970 6529 3a0a     store_type):.
+0002e8e0: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
+0002e8f0: 7320 6120 6275 636b 6574 2c20 6465 6c65  s a bucket, dele
+0002e900: 7465 7320 6974 2065 7874 6572 6e61 6c6c  tes it externall
+0002e910: 7920 7573 696e 6720 636c 6f75 6420 636c  y using cloud cl
+0002e920: 6920 636f 6d6d 616e 6473 0a20 2020 2020  i commands.     
+0002e930: 2020 2023 2061 6e64 2074 6865 6e20 7472     # and then tr
+0002e940: 6965 7320 746f 2064 656c 6574 6520 6974  ies to delete it
+0002e950: 2075 7369 6e67 2073 6b79 2073 746f 7261   using sky stora
+0002e960: 6765 2064 656c 6574 652e 0a20 2020 2020  ge delete..     
+0002e970: 2020 2074 6d70 5f73 6372 6174 6368 5f73     tmp_scratch_s
+0002e980: 746f 7261 6765 5f6f 626a 2e61 6464 5f73  torage_obj.add_s
+0002e990: 746f 7265 2873 746f 7265 5f74 7970 6529  tore(store_type)
+0002e9a0: 0a0a 2020 2020 2020 2020 2320 5275 6e20  ..        # Run 
+0002e9b0: 736b 7920 7374 6f72 6167 6520 6c73 2074  sky storage ls t
+0002e9c0: 6f20 6368 6563 6b20 6966 2073 746f 7261  o check if stora
+0002e9d0: 6765 206f 626a 6563 7420 6578 6973 7473  ge object exists
+0002e9e0: 2069 6e20 7468 6520 6f75 7470 7574 0a20   in the output. 
+0002e9f0: 2020 2020 2020 206f 7574 203d 2073 7562         out = sub
+0002ea00: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
+0002ea10: 7470 7574 285b 2773 6b79 272c 2027 7374  tput(['sky', 'st
+0002ea20: 6f72 6167 6527 2c20 276c 7327 5d29 0a20  orage', 'ls']). 
+0002ea30: 2020 2020 2020 2061 7373 6572 7420 746d         assert tm
+0002ea40: 705f 7363 7261 7463 685f 7374 6f72 6167  p_scratch_storag
+0002ea50: 655f 6f62 6a2e 6e61 6d65 2069 6e20 6f75  e_obj.name in ou
+0002ea60: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
+0002ea70: 290a 0a20 2020 2020 2020 2023 2044 656c  )..        # Del
+0002ea80: 6574 6520 6275 636b 6574 2065 7874 6572  ete bucket exter
+0002ea90: 6e61 6c6c 790a 2020 2020 2020 2020 636d  nally.        cm
+0002eaa0: 6420 3d20 7365 6c66 2e63 6c69 5f64 656c  d = self.cli_del
+0002eab0: 6574 655f 636d 6428 7374 6f72 655f 7479  ete_cmd(store_ty
+0002eac0: 7065 2c20 746d 705f 7363 7261 7463 685f  pe, tmp_scratch_
+0002ead0: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
+0002eae0: 290a 2020 2020 2020 2020 7375 6270 726f  ).        subpro
+0002eaf0: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
+0002eb00: 7428 636d 642c 2073 6865 6c6c 3d54 7275  t(cmd, shell=Tru
+0002eb10: 6529 0a0a 2020 2020 2020 2020 2320 5275  e)..        # Ru
+0002eb20: 6e20 736b 7920 7374 6f72 6167 6520 6465  n sky storage de
+0002eb30: 6c65 7465 2074 6f20 6465 6c65 7465 2074  lete to delete t
+0002eb40: 6865 2073 746f 7261 6765 206f 626a 6563  he storage objec
+0002eb50: 740a 2020 2020 2020 2020 6f75 7420 3d20  t.        out = 
+0002eb60: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+0002eb70: 5f6f 7574 7075 7428 0a20 2020 2020 2020  _output(.       
+0002eb80: 2020 2020 205b 2773 6b79 272c 2027 7374       ['sky', 'st
+0002eb90: 6f72 6167 6527 2c20 2764 656c 6574 6527  orage', 'delete'
+0002eba0: 2c20 746d 705f 7363 7261 7463 685f 7374  , tmp_scratch_st
+0002ebb0: 6f72 6167 655f 6f62 6a2e 6e61 6d65 2c20  orage_obj.name, 
+0002ebc0: 272d 2d79 6573 275d 290a 2020 2020 2020  '--yes']).      
+0002ebd0: 2020 2320 4d61 6b65 2073 7572 6520 6275    # Make sure bu
+0002ebe0: 636b 6574 2077 6173 206e 6f74 2063 7265  cket was not cre
+0002ebf0: 6174 6564 2064 7572 696e 6720 6465 6c65  ated during dele
+0002ec00: 7469 6f6e 2028 7365 6520 6973 7375 6520  tion (see issue 
+0002ec10: 2331 3332 3229 0a20 2020 2020 2020 2061  #1322).        a
+0002ec20: 7373 6572 7420 2763 7265 6174 6564 2720  ssert 'created' 
+0002ec30: 6e6f 7420 696e 206f 7574 2e64 6563 6f64  not in out.decod
+0002ec40: 6528 2775 7466 2d38 2729 2e6c 6f77 6572  e('utf-8').lower
+0002ec50: 2829 0a0a 2020 2020 2020 2020 2320 5275  ()..        # Ru
+0002ec60: 6e20 736b 7920 7374 6f72 6167 6520 6c73  n sky storage ls
+0002ec70: 2074 6f20 6368 6563 6b20 6966 2073 746f   to check if sto
+0002ec80: 7261 6765 206f 626a 6563 7420 6973 2064  rage object is d
+0002ec90: 656c 6574 6564 0a20 2020 2020 2020 206f  eleted.        o
+0002eca0: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
+0002ecb0: 6368 6563 6b5f 6f75 7470 7574 285b 2773  check_output(['s
+0002ecc0: 6b79 272c 2027 7374 6f72 6167 6527 2c20  ky', 'storage', 
+0002ecd0: 276c 7327 5d29 0a20 2020 2020 2020 2061  'ls']).        a
+0002ece0: 7373 6572 7420 746d 705f 7363 7261 7463  ssert tmp_scratc
+0002ecf0: 685f 7374 6f72 6167 655f 6f62 6a2e 6e61  h_storage_obj.na
+0002ed00: 6d65 206e 6f74 2069 6e20 6f75 742e 6465  me not in out.de
+0002ed10: 636f 6465 2827 7574 662d 3827 290a 0a20  code('utf-8').. 
+0002ed20: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
+0002ed30: 6e6f 5f66 6c75 6964 7374 6163 6b0a 2020  no_fluidstack.  
+0002ed40: 2020 4070 7974 6573 742e 6d61 726b 2e70    @pytest.mark.p
+0002ed50: 6172 616d 6574 7269 7a65 2827 7374 6f72  arametrize('stor
+0002ed60: 655f 7479 7065 272c 205b 0a20 2020 2020  e_type', [.     
+0002ed70: 2020 2073 746f 7261 6765 5f6c 6962 2e53     storage_lib.S
+0002ed80: 746f 7265 5479 7065 2e53 332c 2073 746f  toreType.S3, sto
+0002ed90: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0002eda0: 7065 2e47 4353 2c0a 2020 2020 2020 2020  pe.GCS,.        
+0002edb0: 7079 7465 7374 2e70 6172 616d 2873 746f  pytest.param(sto
+0002edc0: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0002edd0: 7065 2e49 424d 2c20 6d61 726b 733d 7079  pe.IBM, marks=py
+0002ede0: 7465 7374 2e6d 6172 6b2e 6962 6d29 2c0a  test.mark.ibm),.
+0002edf0: 2020 2020 2020 2020 7079 7465 7374 2e70          pytest.p
+0002ee00: 6172 616d 2873 746f 7261 6765 5f6c 6962  aram(storage_lib
+0002ee10: 2e53 746f 7265 5479 7065 2e52 322c 206d  .StoreType.R2, m
+0002ee20: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
+0002ee30: 2e63 6c6f 7564 666c 6172 6529 0a20 2020  .cloudflare).   
+0002ee40: 205d 290a 2020 2020 6465 6620 7465 7374   ]).    def test
+0002ee50: 5f62 7563 6b65 745f 6275 6c6b 5f64 656c  _bucket_bulk_del
+0002ee60: 6574 696f 6e28 7365 6c66 2c20 7374 6f72  etion(self, stor
+0002ee70: 655f 7479 7065 2c20 746d 705f 6275 6c6b  e_type, tmp_bulk
+0002ee80: 5f64 656c 5f73 746f 7261 6765 5f6f 626a  _del_storage_obj
+0002ee90: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
+0002eea0: 6174 6573 2061 2074 656d 7020 666f 6c64  ates a temp fold
+0002eeb0: 6572 2077 6974 6820 6f76 6572 2032 3536  er with over 256
+0002eec0: 2066 696c 6573 2061 6e64 2066 6f6c 6465   files and folde
+0002eed0: 7273 2c20 7570 6c6f 6164 0a20 2020 2020  rs, upload.     
+0002eee0: 2020 2023 2066 696c 6573 2061 6e64 2066     # files and f
+0002eef0: 6f6c 6465 7273 2074 6f20 6120 6e65 7720  olders to a new 
+0002ef00: 6275 636b 6574 2c20 7468 656e 2064 656c  bucket, then del
+0002ef10: 6574 6520 6275 636b 6574 2e0a 2020 2020  ete bucket..    
+0002ef20: 2020 2020 746d 705f 6275 6c6b 5f64 656c      tmp_bulk_del
+0002ef30: 5f73 746f 7261 6765 5f6f 626a 2e61 6464  _storage_obj.add
+0002ef40: 5f73 746f 7265 2873 746f 7265 5f74 7970  _store(store_typ
+0002ef50: 6529 0a0a 2020 2020 2020 2020 7375 6270  e)..        subp
+0002ef60: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+0002ef70: 7075 7428 5b0a 2020 2020 2020 2020 2020  put([.          
+0002ef80: 2020 2773 6b79 272c 2027 7374 6f72 6167    'sky', 'storag
+0002ef90: 6527 2c20 2764 656c 6574 6527 2c20 746d  e', 'delete', tm
+0002efa0: 705f 6275 6c6b 5f64 656c 5f73 746f 7261  p_bulk_del_stora
+0002efb0: 6765 5f6f 626a 2e6e 616d 652c 2027 2d2d  ge_obj.name, '--
+0002efc0: 7965 7327 0a20 2020 2020 2020 205d 290a  yes'.        ]).
+0002efd0: 0a20 2020 2020 2020 206f 7574 7075 7420  .        output 
+0002efe0: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
+0002eff0: 636b 5f6f 7574 7075 7428 5b27 736b 7927  ck_output(['sky'
+0002f000: 2c20 2773 746f 7261 6765 272c 2027 6c73  , 'storage', 'ls
+0002f010: 275d 290a 2020 2020 2020 2020 6173 7365  ']).        asse
+0002f020: 7274 2074 6d70 5f62 756c 6b5f 6465 6c5f  rt tmp_bulk_del_
+0002f030: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
+0002f040: 206e 6f74 2069 6e20 6f75 7470 7574 2e64   not in output.d
+0002f050: 6563 6f64 6528 2775 7466 2d38 2729 0a0a  ecode('utf-8')..
+0002f060: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
+0002f070: 2e6e 6f5f 666c 7569 6473 7461 636b 0a20  .no_fluidstack. 
+0002f080: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
+0002f090: 7061 7261 6d65 7472 697a 6528 0a20 2020  parametrize(.   
+0002f0a0: 2020 2020 2027 746d 705f 7075 626c 6963       'tmp_public
+0002f0b0: 5f73 746f 7261 6765 5f6f 626a 2c20 7374  _storage_obj, st
+0002f0c0: 6f72 655f 7479 7065 272c 0a20 2020 2020  ore_type',.     
+0002f0d0: 2020 205b 2827 7333 3a2f 2f74 6367 612d     [('s3://tcga-
+0002f0e0: 322d 6f70 656e 272c 2073 746f 7261 6765  2-open', storage
+0002f0f0: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
+0002f100: 3329 2c0a 2020 2020 2020 2020 2028 2773  3),.         ('s
+0002f110: 333a 2f2f 6469 6769 7461 6c63 6f72 706f  3://digitalcorpo
+0002f120: 7261 272c 2073 746f 7261 6765 5f6c 6962  ra', storage_lib
+0002f130: 2e53 746f 7265 5479 7065 2e53 3329 2c0a  .StoreType.S3),.
+0002f140: 2020 2020 2020 2020 2028 2767 733a 2f2f           ('gs://
+0002f150: 6763 702d 7075 626c 6963 2d64 6174 612d  gcp-public-data-
+0002f160: 7365 6e74 696e 656c 2d32 272c 2073 746f  sentinel-2', sto
+0002f170: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0002f180: 7065 2e47 4353 295d 2c0a 2020 2020 2020  pe.GCS)],.      
+0002f190: 2020 696e 6469 7265 6374 3d5b 2774 6d70    indirect=['tmp
+0002f1a0: 5f70 7562 6c69 635f 7374 6f72 6167 655f  _public_storage_
+0002f1b0: 6f62 6a27 5d29 0a20 2020 2064 6566 2074  obj']).    def t
+0002f1c0: 6573 745f 7075 626c 6963 5f62 7563 6b65  est_public_bucke
+0002f1d0: 7428 7365 6c66 2c20 746d 705f 7075 626c  t(self, tmp_publ
+0002f1e0: 6963 5f73 746f 7261 6765 5f6f 626a 2c20  ic_storage_obj, 
+0002f1f0: 7374 6f72 655f 7479 7065 293a 0a20 2020  store_type):.   
+0002f200: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
+0002f210: 206e 6577 2062 7563 6b65 7420 7769 7468   new bucket with
+0002f220: 2061 2070 7562 6c69 6320 736f 7572 6365   a public source
+0002f230: 2061 6e64 2076 6572 6966 6965 7320 7468   and verifies th
+0002f240: 6174 2069 7420 6973 206e 6f74 0a20 2020  at it is not.   
+0002f250: 2020 2020 2023 2061 6464 6564 2074 6f20       # added to 
+0002f260: 676c 6f62 616c 5f75 7365 725f 7374 6174  global_user_stat
+0002f270: 652e 0a20 2020 2020 2020 2074 6d70 5f70  e..        tmp_p
+0002f280: 7562 6c69 635f 7374 6f72 6167 655f 6f62  ublic_storage_ob
+0002f290: 6a2e 6164 645f 7374 6f72 6528 7374 6f72  j.add_store(stor
+0002f2a0: 655f 7479 7065 290a 0a20 2020 2020 2020  e_type)..       
+0002f2b0: 2023 2052 756e 2073 6b79 2073 746f 7261   # Run sky stora
+0002f2c0: 6765 206c 7320 746f 2063 6865 636b 2069  ge ls to check i
+0002f2d0: 6620 7374 6f72 6167 6520 6f62 6a65 6374  f storage object
+0002f2e0: 2065 7869 7374 7320 696e 2074 6865 206f   exists in the o
+0002f2f0: 7574 7075 740a 2020 2020 2020 2020 6f75  utput.        ou
+0002f300: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
+0002f310: 6865 636b 5f6f 7574 7075 7428 5b27 736b  heck_output(['sk
+0002f320: 7927 2c20 2773 746f 7261 6765 272c 2027  y', 'storage', '
+0002f330: 6c73 275d 290a 2020 2020 2020 2020 6173  ls']).        as
+0002f340: 7365 7274 2074 6d70 5f70 7562 6c69 635f  sert tmp_public_
+0002f350: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
+0002f360: 206e 6f74 2069 6e20 6f75 742e 6465 636f   not in out.deco
+0002f370: 6465 2827 7574 662d 3827 290a 0a20 2020  de('utf-8')..   
+0002f380: 2040 7079 7465 7374 2e6d 6172 6b2e 6e6f   @pytest.mark.no
+0002f390: 5f66 6c75 6964 7374 6163 6b0a 2020 2020  _fluidstack.    
+0002f3a0: 4070 7974 6573 742e 6d61 726b 2e70 6172  @pytest.mark.par
+0002f3b0: 616d 6574 7269 7a65 2827 6e6f 6e65 7869  ametrize('nonexi
+0002f3c0: 7374 5f62 7563 6b65 745f 7572 6c27 2c20  st_bucket_url', 
+0002f3d0: 5b0a 2020 2020 2020 2020 2773 333a 2f2f  [.        's3://
+0002f3e0: 7b72 616e 646f 6d5f 6e61 6d65 7d27 2c20  {random_name}', 
+0002f3f0: 2767 733a 2f2f 7b72 616e 646f 6d5f 6e61  'gs://{random_na
+0002f400: 6d65 7d27 2c0a 2020 2020 2020 2020 7079  me}',.        py
+0002f410: 7465 7374 2e70 6172 616d 2827 636f 733a  test.param('cos:
+0002f420: 2f2f 7573 2d65 6173 742f 7b72 616e 646f  //us-east/{rando
+0002f430: 6d5f 6e61 6d65 7d27 2c20 6d61 726b 733d  m_name}', marks=
+0002f440: 7079 7465 7374 2e6d 6172 6b2e 6962 6d29  pytest.mark.ibm)
+0002f450: 2c0a 2020 2020 2020 2020 7079 7465 7374  ,.        pytest
+0002f460: 2e70 6172 616d 2827 7232 3a2f 2f7b 7261  .param('r2://{ra
+0002f470: 6e64 6f6d 5f6e 616d 657d 272c 206d 6172  ndom_name}', mar
+0002f480: 6b73 3d70 7974 6573 742e 6d61 726b 2e63  ks=pytest.mark.c
+0002f490: 6c6f 7564 666c 6172 6529 0a20 2020 205d  loudflare).    ]
+0002f4a0: 290a 2020 2020 6465 6620 7465 7374 5f6e  ).    def test_n
+0002f4b0: 6f6e 6578 6973 7465 6e74 5f62 7563 6b65  onexistent_bucke
+0002f4c0: 7428 7365 6c66 2c20 6e6f 6e65 7869 7374  t(self, nonexist
+0002f4d0: 5f62 7563 6b65 745f 7572 6c29 3a0a 2020  _bucket_url):.  
+0002f4e0: 2020 2020 2020 2320 4174 7465 6d70 7473        # Attempts
+0002f4f0: 2074 6f20 6372 6561 7465 2066 6574 6368   to create fetch
+0002f500: 2061 2073 7472 6f61 6765 2077 6974 6820   a stroage with 
+0002f510: 6120 6e6f 6e2d 6578 6973 7465 6e74 2073  a non-existent s
+0002f520: 6f75 7263 652e 0a20 2020 2020 2020 2023  ource..        #
+0002f530: 2047 656e 6572 6174 6520 6120 7261 6e64   Generate a rand
+0002f540: 6f6d 2062 7563 6b65 7420 6e61 6d65 2061  om bucket name a
+0002f550: 6e64 2076 6572 6966 7920 6974 2064 6f65  nd verify it doe
+0002f560: 736e 2774 2065 7869 7374 3a0a 2020 2020  sn't exist:.    
+0002f570: 2020 2020 7265 7472 795f 636f 756e 7420      retry_count 
+0002f580: 3d20 300a 2020 2020 2020 2020 7768 696c  = 0.        whil
+0002f590: 6520 5472 7565 3a0a 2020 2020 2020 2020  e True:.        
+0002f5a0: 2020 2020 6e6f 6e65 7869 7374 5f62 7563      nonexist_buc
+0002f5b0: 6b65 745f 6e61 6d65 203d 2073 7472 2875  ket_name = str(u
+0002f5c0: 7569 642e 7575 6964 3428 2929 0a20 2020  uid.uuid4()).   
+0002f5d0: 2020 2020 2020 2020 2069 6620 6e6f 6e65           if none
+0002f5e0: 7869 7374 5f62 7563 6b65 745f 7572 6c2e  xist_bucket_url.
+0002f5f0: 7374 6172 7473 7769 7468 2827 7333 2729  startswith('s3')
+0002f600: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002f610: 2020 636f 6d6d 616e 6420 3d20 6627 6177    command = f'aw
+0002f620: 7320 7333 6170 6920 6865 6164 2d62 7563  s s3api head-buc
+0002f630: 6b65 7420 2d2d 6275 636b 6574 207b 6e6f  ket --bucket {no
+0002f640: 6e65 7869 7374 5f62 7563 6b65 745f 6e61  nexist_bucket_na
+0002f650: 6d65 7d27 0a20 2020 2020 2020 2020 2020  me}'.           
+0002f660: 2020 2020 2065 7870 6563 7465 645f 6f75       expected_ou
+0002f670: 7470 7574 203d 2027 3430 3427 0a20 2020  tput = '404'.   
+0002f680: 2020 2020 2020 2020 2065 6c69 6620 6e6f           elif no
+0002f690: 6e65 7869 7374 5f62 7563 6b65 745f 7572  nexist_bucket_ur
+0002f6a0: 6c2e 7374 6172 7473 7769 7468 2827 6773  l.startswith('gs
+0002f6b0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+0002f6c0: 2020 2020 636f 6d6d 616e 6420 3d20 6627      command = f'
+0002f6d0: 6773 7574 696c 206c 7320 7b6e 6f6e 6578  gsutil ls {nonex
+0002f6e0: 6973 745f 6275 636b 6574 5f75 726c 2e66  ist_bucket_url.f
+0002f6f0: 6f72 6d61 7428 7261 6e64 6f6d 5f6e 616d  ormat(random_nam
+0002f700: 653d 6e6f 6e65 7869 7374 5f62 7563 6b65  e=nonexist_bucke
+0002f710: 745f 6e61 6d65 297d 270a 2020 2020 2020  t_name)}'.      
+0002f720: 2020 2020 2020 2020 2020 6578 7065 6374            expect
+0002f730: 6564 5f6f 7574 7075 7420 3d20 2742 7563  ed_output = 'Buc
+0002f740: 6b65 744e 6f74 466f 756e 6445 7863 6570  ketNotFoundExcep
+0002f750: 7469 6f6e 270a 2020 2020 2020 2020 2020  tion'.          
+0002f760: 2020 656c 6966 206e 6f6e 6578 6973 745f    elif nonexist_
+0002f770: 6275 636b 6574 5f75 726c 2e73 7461 7274  bucket_url.start
+0002f780: 7377 6974 6828 2772 3227 293a 0a20 2020  swith('r2'):.   
+0002f790: 2020 2020 2020 2020 2020 2020 2065 6e64               end
+0002f7a0: 706f 696e 745f 7572 6c20 3d20 636c 6f75  point_url = clou
+0002f7b0: 6466 6c61 7265 2e63 7265 6174 655f 656e  dflare.create_en
+0002f7c0: 6470 6f69 6e74 2829 0a20 2020 2020 2020  dpoint().       
+0002f7d0: 2020 2020 2020 2020 2063 6f6d 6d61 6e64           command
+0002f7e0: 203d 2066 2741 5753 5f53 4841 5245 445f   = f'AWS_SHARED_
+0002f7f0: 4352 4544 454e 5449 414c 535f 4649 4c45  CREDENTIALS_FILE
+0002f800: 3d7b 636c 6f75 6466 6c61 7265 2e52 325f  ={cloudflare.R2_
+0002f810: 4352 4544 454e 5449 414c 535f 5041 5448  CREDENTIALS_PATH
+0002f820: 7d20 6177 7320 7333 6170 6920 6865 6164  } aws s3api head
+0002f830: 2d62 7563 6b65 7420 2d2d 6275 636b 6574  -bucket --bucket
+0002f840: 207b 6e6f 6e65 7869 7374 5f62 7563 6b65   {nonexist_bucke
+0002f850: 745f 6e61 6d65 7d20 2d2d 656e 6470 6f69  t_name} --endpoi
+0002f860: 6e74 207b 656e 6470 6f69 6e74 5f75 726c  nt {endpoint_url
+0002f870: 7d20 2d2d 7072 6f66 696c 653d 7232 270a  } --profile=r2'.
+0002f880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f890: 6578 7065 6374 6564 5f6f 7574 7075 7420  expected_output 
+0002f8a0: 3d20 2734 3034 270a 2020 2020 2020 2020  = '404'.        
+0002f8b0: 2020 2020 656c 6966 206e 6f6e 6578 6973      elif nonexis
+0002f8c0: 745f 6275 636b 6574 5f75 726c 2e73 7461  t_bucket_url.sta
+0002f8d0: 7274 7377 6974 6828 2763 6f73 2729 3a0a  rtswith('cos'):.
+0002f8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f8f0: 2320 5573 696e 6720 4150 4920 6361 6c6c  # Using API call
+0002f900: 732c 2073 696e 6365 2075 7369 6e67 2072  s, since using r
+0002f910: 636c 6f6e 6520 7265 7175 6972 6573 2061  clone requires a
+0002f920: 2070 726f 6669 6c65 2773 206e 616d 650a   profile's name.
+0002f930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f940: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0002f950: 2020 2020 2020 2020 2065 7870 6563 7465           expecte
+0002f960: 645f 6f75 7470 7574 203d 2063 6f6d 6d61  d_output = comma
+0002f970: 6e64 203d 2022 6563 686f 2220 2023 2061  nd = "echo"  # a
+0002f980: 766f 6964 2075 6e72 656c 6174 6564 2065  void unrelated e
+0002f990: 7863 6570 7469 6f6e 2069 6e20 6361 7365  xception in case
+0002f9a0: 206f 6620 6661 696c 7572 652e 0a20 2020   of failure..   
+0002f9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f9c0: 2062 7563 6b65 745f 6e61 6d65 203d 2075   bucket_name = u
+0002f9d0: 726c 6c69 622e 7061 7273 652e 7572 6c73  rllib.parse.urls
+0002f9e0: 706c 6974 280a 2020 2020 2020 2020 2020  plit(.          
+0002f9f0: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
+0002fa00: 6e65 7869 7374 5f62 7563 6b65 745f 7572  nexist_bucket_ur
+0002fa10: 6c2e 666f 726d 6174 280a 2020 2020 2020  l.format(.      
+0002fa20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fa30: 2020 2020 2020 7261 6e64 6f6d 5f6e 616d        random_nam
+0002fa40: 653d 6e6f 6e65 7869 7374 5f62 7563 6b65  e=nonexist_bucke
+0002fa50: 745f 6e61 6d65 2929 2e70 6174 682e 7374  t_name)).path.st
+0002fa60: 7269 7028 272f 2729 0a20 2020 2020 2020  rip('/').       
+0002fa70: 2020 2020 2020 2020 2020 2020 2063 6c69               cli
+0002fa80: 656e 7420 3d20 6962 6d2e 6765 745f 636f  ent = ibm.get_co
+0002fa90: 735f 636c 6965 6e74 2827 7573 2d65 6173  s_client('us-eas
+0002faa0: 7427 290a 2020 2020 2020 2020 2020 2020  t').            
+0002fab0: 2020 2020 2020 2020 636c 6965 6e74 2e68          client.h
+0002fac0: 6561 645f 6275 636b 6574 2842 7563 6b65  ead_bucket(Bucke
+0002fad0: 743d 6275 636b 6574 5f6e 616d 6529 0a20  t=bucket_name). 
+0002fae0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0002faf0: 7863 6570 7420 6962 6d2e 6962 6d5f 626f  xcept ibm.ibm_bo
+0002fb00: 746f 636f 7265 2e65 7863 6570 7469 6f6e  tocore.exception
+0002fb10: 732e 436c 6965 6e74 4572 726f 7220 6173  s.ClientError as
+0002fb20: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+0002fb30: 2020 2020 2020 2020 6966 2065 2e72 6573          if e.res
+0002fb40: 706f 6e73 655b 2745 7272 6f72 275d 5b27  ponse['Error']['
+0002fb50: 436f 6465 275d 203d 3d20 2734 3034 273a  Code'] == '404':
+0002fb60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002fb70: 2020 2020 2020 2020 2023 2073 7563 6365           # succe
+0002fb80: 7373 0a20 2020 2020 2020 2020 2020 2020  ss.             
+0002fb90: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0002fba0: 6e0a 2020 2020 2020 2020 2020 2020 656c  n.            el
+0002fbb0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0002fbc0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+0002fbd0: 7272 6f72 2827 556e 7375 7070 6f72 7465  rror('Unsupporte
+0002fbe0: 6420 6275 636b 6574 2074 7970 6520 270a  d bucket type '.
+0002fbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fc10: 2066 277b 6e6f 6e65 7869 7374 5f62 7563   f'{nonexist_buc
+0002fc20: 6b65 745f 7572 6c7d 2729 0a0a 2020 2020  ket_url}')..    
+0002fc30: 2020 2020 2020 2020 2320 4368 6563 6b20          # Check 
+0002fc40: 6966 2062 7563 6b65 7420 6578 6973 7473  if bucket exists
+0002fc50: 2075 7369 6e67 2074 6865 2063 6c69 3a0a   using the cli:.
+0002fc60: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+0002fc70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002fc80: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
+0002fc90: 732e 6368 6563 6b5f 6f75 7470 7574 2863  s.check_output(c
+0002fca0: 6f6d 6d61 6e64 2c0a 2020 2020 2020 2020  ommand,.        
+0002fcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fcd0: 2020 2020 2020 7374 6465 7272 3d73 7562        stderr=sub
+0002fce0: 7072 6f63 6573 732e 5354 444f 5554 2c0a  process.STDOUT,.
+0002fcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0002fd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fd10: 2020 2020 2020 2020 2020 2020 2020 2774                't
-0002fd20: 6f20 7573 652e 2054 6869 7320 6973 2068  o use. This is h
-0002fd30: 6967 6c79 2075 6e6c 696b 656c 7920 2d20  igly unlikely - 
-0002fd40: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0002fd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fd60: 2020 2020 2020 2020 2027 6368 6563 6b20           'check 
-0002fd70: 6966 2074 6865 2074 6573 7473 2061 7265  if the tests are
-0002fd80: 2063 6f72 7265 6374 2e27 290a 0a20 2020   correct.')..   
-0002fd90: 2020 2020 2077 6974 6820 7079 7465 7374       with pytest
-0002fda0: 2e72 6169 7365 7328 0a20 2020 2020 2020  .raises(.       
-0002fdb0: 2020 2020 2020 2020 2073 6b79 2e65 7863           sky.exc
-0002fdc0: 6570 7469 6f6e 732e 5374 6f72 6167 6542  eptions.StorageB
-0002fdd0: 7563 6b65 7447 6574 4572 726f 722c 0a20  ucketGetError,. 
-0002fde0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0002fdf0: 6174 6368 3d27 4174 7465 6d70 7465 6420  atch='Attempted 
-0002fe00: 746f 2075 7365 2061 206e 6f6e 2d65 7869  to use a non-exi
-0002fe10: 7374 656e 7420 6275 636b 6574 2061 7320  stent bucket as 
-0002fe20: 6120 736f 7572 6365 2729 3a0a 2020 2020  a source'):.    
-0002fe30: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-0002fe40: 6f62 6a20 3d20 7374 6f72 6167 655f 6c69  obj = storage_li
-0002fe50: 622e 5374 6f72 6167 6528 736f 7572 6365  b.Storage(source
-0002fe60: 3d6e 6f6e 6578 6973 745f 6275 636b 6574  =nonexist_bucket
-0002fe70: 5f75 726c 2e66 6f72 6d61 7428 0a20 2020  _url.format(.   
-0002fe80: 2020 2020 2020 2020 2020 2020 2072 616e               ran
-0002fe90: 646f 6d5f 6e61 6d65 3d6e 6f6e 6578 6973  dom_name=nonexis
-0002fea0: 745f 6275 636b 6574 5f6e 616d 6529 290a  t_bucket_name)).
-0002feb0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0002fec0: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b0a  k.no_fluidstack.
-0002fed0: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
-0002fee0: 2e70 6172 616d 6574 7269 7a65 2827 7072  .parametrize('pr
-0002fef0: 6976 6174 655f 6275 636b 6574 272c 205b  ivate_bucket', [
-0002ff00: 0a20 2020 2020 2020 2066 2773 333a 2f2f  .        f's3://
-0002ff10: 696d 6167 656e 6574 272c 2066 2767 733a  imagenet', f'gs:
-0002ff20: 2f2f 696d 6167 656e 6574 272c 0a20 2020  //imagenet',.   
-0002ff30: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
-0002ff40: 6d28 2763 6f73 3a2f 2f75 732d 6561 7374  m('cos://us-east
-0002ff50: 2f62 7563 6b65 7431 272c 206d 6172 6b73  /bucket1', marks
-0002ff60: 3d70 7974 6573 742e 6d61 726b 2e69 626d  =pytest.mark.ibm
-0002ff70: 290a 2020 2020 5d29 0a20 2020 2064 6566  ).    ]).    def
-0002ff80: 2074 6573 745f 7072 6976 6174 655f 6275   test_private_bu
-0002ff90: 636b 6574 2873 656c 662c 2070 7269 7661  cket(self, priva
-0002ffa0: 7465 5f62 7563 6b65 7429 3a0a 2020 2020  te_bucket):.    
-0002ffb0: 2020 2020 2320 4174 7465 6d70 7473 2074      # Attempts t
-0002ffc0: 6f20 6163 6365 7373 2070 7269 7661 7465  o access private
-0002ffd0: 2062 7563 6b65 7473 206e 6f74 2062 656c   buckets not bel
-0002ffe0: 6f6e 6769 6e67 2074 6f20 7468 6520 7573  onging to the us
-0002fff0: 6572 2e0a 2020 2020 2020 2020 2320 5468  er..        # Th
-00030000: 6573 6520 6275 636b 6574 7320 6172 6520  ese buckets are 
-00030010: 6b6e 6f77 6e20 746f 2062 6520 7072 6976  known to be priv
-00030020: 6174 652c 2062 7574 206d 6179 206e 6565  ate, but may nee
-00030030: 6420 746f 2062 6520 7570 6461 7465 6420  d to be updated 
-00030040: 6966 0a20 2020 2020 2020 2023 2074 6865  if.        # the
-00030050: 7920 6172 6520 7265 6d6f 7665 6420 6279  y are removed by
-00030060: 2074 6865 6972 206f 776e 6572 732e 0a20   their owners.. 
-00030070: 2020 2020 2020 2070 7269 7661 7465 5f62         private_b
-00030080: 7563 6b65 745f 6e61 6d65 203d 2075 726c  ucket_name = url
-00030090: 6c69 622e 7061 7273 652e 7572 6c73 706c  lib.parse.urlspl
-000300a0: 6974 2870 7269 7661 7465 5f62 7563 6b65  it(private_bucke
-000300b0: 7429 2e6e 6574 6c6f 6320 6966 205c 0a20  t).netloc if \. 
-000300c0: 2020 2020 2020 2020 2020 2020 2075 726c               url
-000300d0: 6c69 622e 7061 7273 652e 7572 6c73 706c  lib.parse.urlspl
-000300e0: 6974 2870 7269 7661 7465 5f62 7563 6b65  it(private_bucke
-000300f0: 7429 2e73 6368 656d 6520 213d 2027 636f  t).scheme != 'co
-00030100: 7327 2065 6c73 6520 5c0a 2020 2020 2020  s' else \.      
-00030110: 2020 2020 2020 2020 2020 2020 7572 6c6c              urll
-00030120: 6962 2e70 6172 7365 2e75 726c 7370 6c69  ib.parse.urlspli
-00030130: 7428 7072 6976 6174 655f 6275 636b 6574  t(private_bucket
-00030140: 292e 7061 7468 2e73 7472 6970 2827 2f27  ).path.strip('/'
-00030150: 290a 2020 2020 2020 2020 7769 7468 2070  ).        with p
-00030160: 7974 6573 742e 7261 6973 6573 280a 2020  ytest.raises(.  
-00030170: 2020 2020 2020 2020 2020 2020 2020 736b                sk
-00030180: 792e 6578 6365 7074 696f 6e73 2e53 746f  y.exceptions.Sto
-00030190: 7261 6765 4275 636b 6574 4765 7445 7272  rageBucketGetErr
-000301a0: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
-000301b0: 2020 2020 6d61 7463 683d 7374 6f72 6167      match=storag
-000301c0: 655f 6c69 622e 5f42 5543 4b45 545f 4641  e_lib._BUCKET_FA
-000301d0: 494c 5f54 4f5f 434f 4e4e 4543 545f 4d45  IL_TO_CONNECT_ME
-000301e0: 5353 4147 452e 666f 726d 6174 280a 2020  SSAGE.format(.  
-000301f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030200: 2020 6e61 6d65 3d70 7269 7661 7465 5f62    name=private_b
-00030210: 7563 6b65 745f 6e61 6d65 2929 3a0a 2020  ucket_name)):.  
-00030220: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
-00030230: 655f 6f62 6a20 3d20 7374 6f72 6167 655f  e_obj = storage_
-00030240: 6c69 622e 5374 6f72 6167 6528 736f 7572  lib.Storage(sour
-00030250: 6365 3d70 7269 7661 7465 5f62 7563 6b65  ce=private_bucke
-00030260: 7429 0a0a 2020 2020 4070 7974 6573 742e  t)..    @pytest.
-00030270: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
-00030280: 636b 0a20 2020 2040 7079 7465 7374 2e6d  ck.    @pytest.m
-00030290: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
-000302a0: 2765 7874 5f62 7563 6b65 745f 6669 7874  'ext_bucket_fixt
-000302b0: 7572 652c 2073 746f 7265 5f74 7970 6527  ure, store_type'
-000302c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000302d0: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-000302e0: 2827 746d 705f 6177 7363 6c69 5f62 7563  ('tmp_awscli_buc
-000302f0: 6b65 7427 2c20 7374 6f72 6167 655f 6c69  ket', storage_li
-00030300: 622e 5374 6f72 6554 7970 652e 5333 292c  b.StoreType.S3),
-00030310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030320: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00030330: 2774 6d70 5f67 7375 7469 6c5f 6275 636b  'tmp_gsutil_buck
-00030340: 6574 272c 2073 746f 7261 6765 5f6c 6962  et', storage_lib
-00030350: 2e53 746f 7265 5479 7065 2e47 4353 292c  .StoreType.GCS),
-00030360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030370: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00030380: 7974 6573 742e 7061 7261 6d28 2774 6d70  ytest.param('tmp
-00030390: 5f69 626d 5f63 6f73 5f62 7563 6b65 7427  _ibm_cos_bucket'
-000303a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000303b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000303c0: 2020 2020 2020 2020 2020 2020 2073 746f               sto
-000303d0: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-000303e0: 7065 2e49 424d 2c0a 2020 2020 2020 2020  pe.IBM,.        
-000303f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030410: 2020 206d 6172 6b73 3d70 7974 6573 742e     marks=pytest.
-00030420: 6d61 726b 2e69 626d 292c 0a20 2020 2020  mark.ibm),.     
-00030430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030440: 2020 2020 2020 2020 2070 7974 6573 742e           pytest.
-00030450: 7061 7261 6d28 2774 6d70 5f61 7773 636c  param('tmp_awscl
-00030460: 695f 6275 636b 6574 5f72 3227 2c0a 2020  i_bucket_r2',.  
-00030470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030490: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-000304a0: 5f6c 6962 2e53 746f 7265 5479 7065 2e52  _lib.StoreType.R
-000304b0: 322c 0a20 2020 2020 2020 2020 2020 2020  2,.             
-000304c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000304d0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-000304e0: 726b 733d 7079 7465 7374 2e6d 6172 6b2e  rks=pytest.mark.
-000304f0: 636c 6f75 6466 6c61 7265 295d 290a 2020  cloudflare)]).  
-00030500: 2020 6465 6620 7465 7374 5f75 706c 6f61    def test_uploa
-00030510: 645f 746f 5f65 7869 7374 696e 675f 6275  d_to_existing_bu
-00030520: 636b 6574 2873 656c 662c 2065 7874 5f62  cket(self, ext_b
-00030530: 7563 6b65 745f 6669 7874 7572 652c 2072  ucket_fixture, r
-00030540: 6571 7565 7374 2c0a 2020 2020 2020 2020  equest,.        
-00030550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030560: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00030570: 6d70 5f73 6f75 7263 652c 2073 746f 7265  mp_source, store
-00030580: 5f74 7970 6529 3a0a 2020 2020 2020 2020  _type):.        
-00030590: 2320 5472 6965 7320 7570 6c6f 6164 696e  # Tries uploadin
-000305a0: 6720 6578 6973 7469 6e67 2066 696c 6573  g existing files
-000305b0: 2074 6f20 6e65 776c 7920 6372 6561 7465   to newly create
-000305c0: 6420 6275 636b 6574 2028 6f75 7473 6964  d bucket (outsid
-000305d0: 6520 6f66 0a20 2020 2020 2020 2023 2073  e of.        # s
-000305e0: 6b79 2920 616e 6420 7665 7269 6669 6573  ky) and verifies
-000305f0: 2074 6861 7420 6669 6c65 7320 6172 6520   that files are 
-00030600: 7772 6974 7465 6e2e 0a20 2020 2020 2020  written..       
-00030610: 2062 7563 6b65 745f 6e61 6d65 2c20 5f20   bucket_name, _ 
-00030620: 3d20 7265 7175 6573 742e 6765 7466 6978  = request.getfix
-00030630: 7475 7265 7661 6c75 6528 6578 745f 6275  turevalue(ext_bu
-00030640: 636b 6574 5f66 6978 7475 7265 290a 2020  cket_fixture).  
-00030650: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
-00030660: 6a20 3d20 7374 6f72 6167 655f 6c69 622e  j = storage_lib.
-00030670: 5374 6f72 6167 6528 6e61 6d65 3d62 7563  Storage(name=buc
-00030680: 6b65 745f 6e61 6d65 2c20 736f 7572 6365  ket_name, source
-00030690: 3d74 6d70 5f73 6f75 7263 6529 0a20 2020  =tmp_source).   
-000306a0: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
-000306b0: 2e61 6464 5f73 746f 7265 2873 746f 7265  .add_store(store
-000306c0: 5f74 7970 6529 0a0a 2020 2020 2020 2020  _type)..        
-000306d0: 2320 4368 6563 6b20 6966 2074 6d70 5f73  # Check if tmp_s
-000306e0: 6f75 7263 652f 746d 702d 6669 6c65 2065  ource/tmp-file e
-000306f0: 7869 7374 7320 696e 2074 6865 2062 7563  xists in the buc
-00030700: 6b65 7420 7573 696e 6720 6177 7320 636c  ket using aws cl
-00030710: 690a 2020 2020 2020 2020 6f75 7420 3d20  i.        out = 
-00030720: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
-00030730: 5f6f 7574 7075 7428 7365 6c66 2e63 6c69  _output(self.cli
-00030740: 5f6c 735f 636d 6428 7374 6f72 655f 7479  _ls_cmd(store_ty
-00030750: 7065 2c20 6275 636b 6574 5f6e 616d 6529  pe, bucket_name)
-00030760: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00030770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030780: 2020 2020 2020 2020 7368 656c 6c3d 5472          shell=Tr
-00030790: 7565 290a 2020 2020 2020 2020 6173 7365  ue).        asse
-000307a0: 7274 2027 746d 702d 6669 6c65 2720 696e  rt 'tmp-file' in
-000307b0: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
-000307c0: 2d38 2729 2c20 5c0a 2020 2020 2020 2020  -8'), \.        
-000307d0: 2020 2020 2746 696c 6520 6e6f 7420 666f      'File not fo
-000307e0: 756e 6420 696e 2062 7563 6b65 7420 2d20  und in bucket - 
-000307f0: 6f75 7470 7574 2077 6173 203a 207b 7d27  output was : {}'
-00030800: 2e66 6f72 6d61 7428 6f75 742e 6465 636f  .format(out.deco
-00030810: 6465 0a20 2020 2020 2020 2020 2020 2020  de.             
-00030820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030850: 2020 2028 2775 7466 2d38 2729 290a 0a20     ('utf-8')).. 
-00030860: 2020 2020 2020 2023 2043 6865 636b 2073         # Check s
-00030870: 796d 6c69 6e6b 7320 2d20 7379 6d6c 696e  ymlinks - symlin
-00030880: 6b73 2064 6f6e 2774 2067 6574 2063 6f70  ks don't get cop
-00030890: 6965 6420 6279 2073 6b79 2073 746f 7261  ied by sky stora
-000308a0: 6765 0a20 2020 2020 2020 2061 7373 6572  ge.        asser
-000308b0: 7420 2870 6174 686c 6962 2e50 6174 6828  t (pathlib.Path(
-000308c0: 746d 705f 736f 7572 6365 2920 2f20 2763  tmp_source) / 'c
-000308d0: 6972 636c 652d 6c69 6e6b 2729 2e69 735f  ircle-link').is_
-000308e0: 7379 6d6c 696e 6b28 292c 2028 0a20 2020  symlink(), (.   
-000308f0: 2020 2020 2020 2020 2027 6369 7263 6c65           'circle
-00030900: 2d6c 696e 6b20 7761 7320 6e6f 7420 666f  -link was not fo
-00030910: 756e 6420 696e 2074 6865 2075 706c 6f61  und in the uploa
-00030920: 6420 736f 7572 6365 202d 2027 0a20 2020  d source - '.   
-00030930: 2020 2020 2020 2020 2027 6172 6520 7468           'are th
-00030940: 6520 7465 7374 2066 6978 7475 7265 7320  e test fixtures 
-00030950: 636f 7272 6563 743f 2729 0a20 2020 2020  correct?').     
-00030960: 2020 2061 7373 6572 7420 2763 6972 636c     assert 'circl
-00030970: 652d 6c69 6e6b 2720 6e6f 7420 696e 206f  e-link' not in o
-00030980: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
-00030990: 2729 2c20 280a 2020 2020 2020 2020 2020  '), (.          
-000309a0: 2020 2753 796d 6c69 6e6b 2066 6f75 6e64    'Symlink found
-000309b0: 2069 6e20 6275 636b 6574 202d 206c 7320   in bucket - ls 
-000309c0: 6f75 7470 7574 2077 6173 203a 207b 7d27  output was : {}'
-000309d0: 2e66 6f72 6d61 7428 0a20 2020 2020 2020  .format(.       
-000309e0: 2020 2020 2020 2020 206f 7574 2e64 6563           out.dec
-000309f0: 6f64 6528 2775 7466 2d38 2729 2929 0a0a  ode('utf-8')))..
-00030a00: 2020 2020 2020 2020 2320 5275 6e20 736b          # Run sk
-00030a10: 7920 7374 6f72 6167 6520 6c73 2074 6f20  y storage ls to 
-00030a20: 6368 6563 6b20 6966 2073 746f 7261 6765  check if storage
-00030a30: 206f 626a 6563 7420 6578 6973 7473 2069   object exists i
-00030a40: 6e20 7468 6520 6f75 7470 7574 2e0a 2020  n the output..  
-00030a50: 2020 2020 2020 2320 4974 2073 686f 756c        # It shoul
-00030a60: 6420 6e6f 7420 6578 6973 7420 6265 6361  d not exist beca
-00030a70: 7573 6520 7468 6520 6275 636b 6574 2077  use the bucket w
-00030a80: 6173 2063 7265 6174 6564 2065 7874 6572  as created exter
-00030a90: 6e61 6c6c 792e 0a20 2020 2020 2020 206f  nally..        o
-00030aa0: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
-00030ab0: 6368 6563 6b5f 6f75 7470 7574 285b 2773  check_output(['s
-00030ac0: 6b79 272c 2027 7374 6f72 6167 6527 2c20  ky', 'storage', 
-00030ad0: 276c 7327 5d29 0a20 2020 2020 2020 2061  'ls']).        a
-00030ae0: 7373 6572 7420 7374 6f72 6167 655f 6f62  ssert storage_ob
-00030af0: 6a2e 6e61 6d65 206e 6f74 2069 6e20 6f75  j.name not in ou
-00030b00: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
-00030b10: 290a 0a20 2020 2040 7079 7465 7374 2e6d  )..    @pytest.m
-00030b20: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
-00030b30: 6b0a 2020 2020 6465 6620 7465 7374 5f63  k.    def test_c
-00030b40: 6f70 795f 6d6f 756e 745f 6578 6973 7469  opy_mount_existi
-00030b50: 6e67 5f73 746f 7261 6765 2873 656c 662c  ng_storage(self,
-00030b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030b80: 2020 2020 2020 2020 2020 746d 705f 636f            tmp_co
-00030b90: 7079 5f6d 6e74 5f65 7869 7374 696e 675f  py_mnt_existing_
-00030ba0: 7374 6f72 6167 655f 6f62 6a29 3a0a 2020  storage_obj):.  
-00030bb0: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
-00030bc0: 6120 6275 636b 6574 2077 6974 6820 6e6f  a bucket with no
-00030bd0: 2073 6f75 7263 6520 696e 204d 4f55 4e54   source in MOUNT
-00030be0: 206d 6f64 6520 2865 6d70 7479 2062 7563   mode (empty buc
-00030bf0: 6b65 7429 2c20 616e 640a 2020 2020 2020  ket), and.      
-00030c00: 2020 2320 7468 656e 2074 7269 6573 2074    # then tries t
-00030c10: 6f20 6c6f 6164 2074 6865 2073 616d 6520  o load the same 
-00030c20: 7374 6f72 6167 6520 696e 2043 4f50 5920  storage in COPY 
-00030c30: 6d6f 6465 2e0a 2020 2020 2020 2020 746d  mode..        tm
-00030c40: 705f 636f 7079 5f6d 6e74 5f65 7869 7374  p_copy_mnt_exist
-00030c50: 696e 675f 7374 6f72 6167 655f 6f62 6a2e  ing_storage_obj.
-00030c60: 6164 645f 7374 6f72 6528 7374 6f72 6167  add_store(storag
-00030c70: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-00030c80: 5333 290a 2020 2020 2020 2020 7374 6f72  S3).        stor
-00030c90: 6167 655f 6e61 6d65 203d 2074 6d70 5f63  age_name = tmp_c
-00030ca0: 6f70 795f 6d6e 745f 6578 6973 7469 6e67  opy_mnt_existing
-00030cb0: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
-00030cc0: 650a 0a20 2020 2020 2020 2023 2043 6865  e..        # Che
-00030cd0: 636b 2060 736b 7920 7374 6f72 6167 6520  ck `sky storage 
-00030ce0: 6c73 6020 746f 2065 6e73 7572 6520 7374  ls` to ensure st
-00030cf0: 6f72 6167 6520 6f62 6a65 6374 2065 7869  orage object exi
-00030d00: 7374 730a 2020 2020 2020 2020 6f75 7420  sts.        out 
-00030d10: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
-00030d20: 636b 5f6f 7574 7075 7428 5b27 736b 7927  ck_output(['sky'
-00030d30: 2c20 2773 746f 7261 6765 272c 2027 6c73  , 'storage', 'ls
-00030d40: 275d 292e 6465 636f 6465 2827 7574 662d  ']).decode('utf-
-00030d50: 3827 290a 2020 2020 2020 2020 6173 7365  8').        asse
-00030d60: 7274 2073 746f 7261 6765 5f6e 616d 6520  rt storage_name 
-00030d70: 696e 206f 7574 2c20 6627 5374 6f72 6167  in out, f'Storag
-00030d80: 6520 7b73 746f 7261 6765 5f6e 616d 657d  e {storage_name}
-00030d90: 206e 6f74 2066 6f75 6e64 2069 6e20 736b   not found in sk
-00030da0: 7920 7374 6f72 6167 6520 6c73 2e27 0a0a  y storage ls.'..
-00030db0: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
-00030dc0: 2e6e 6f5f 666c 7569 6473 7461 636b 0a20  .no_fluidstack. 
-00030dd0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-00030de0: 7061 7261 6d65 7472 697a 6528 2773 746f  parametrize('sto
-00030df0: 7265 5f74 7970 6527 2c20 5b0a 2020 2020  re_type', [.    
-00030e00: 2020 2020 7374 6f72 6167 655f 6c69 622e      storage_lib.
-00030e10: 5374 6f72 6554 7970 652e 5333 2c20 7374  StoreType.S3, st
-00030e20: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-00030e30: 7970 652e 4743 532c 0a20 2020 2020 2020  ype.GCS,.       
-00030e40: 2070 7974 6573 742e 7061 7261 6d28 7374   pytest.param(st
-00030e50: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-00030e60: 7970 652e 4942 4d2c 206d 6172 6b73 3d70  ype.IBM, marks=p
-00030e70: 7974 6573 742e 6d61 726b 2e69 626d 292c  ytest.mark.ibm),
-00030e80: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
-00030e90: 7061 7261 6d28 7374 6f72 6167 655f 6c69  param(storage_li
-00030ea0: 622e 5374 6f72 6554 7970 652e 5232 2c20  b.StoreType.R2, 
-00030eb0: 6d61 726b 733d 7079 7465 7374 2e6d 6172  marks=pytest.mar
-00030ec0: 6b2e 636c 6f75 6466 6c61 7265 290a 2020  k.cloudflare).  
-00030ed0: 2020 5d29 0a20 2020 2064 6566 2074 6573    ]).    def tes
-00030ee0: 745f 6c69 7374 5f73 6f75 7263 6528 7365  t_list_source(se
-00030ef0: 6c66 2c20 746d 705f 6c6f 6361 6c5f 6c69  lf, tmp_local_li
-00030f00: 7374 5f73 746f 7261 6765 5f6f 626a 2c20  st_storage_obj, 
-00030f10: 7374 6f72 655f 7479 7065 293a 0a20 2020  store_type):.   
-00030f20: 2020 2020 2023 2055 7365 7320 6120 6c69       # Uses a li
-00030f30: 7374 2069 6e20 7468 6520 736f 7572 6365  st in the source
-00030f40: 2066 6965 6c64 2074 6f20 7370 6563 6966   field to specif
-00030f50: 7920 6120 6669 6c65 2061 6e64 2061 2064  y a file and a d
-00030f60: 6972 6563 746f 7279 2074 6f0a 2020 2020  irectory to.    
-00030f70: 2020 2020 2320 6265 2075 706c 6f61 6465      # be uploade
-00030f80: 6420 746f 2074 6865 2073 746f 7261 6765  d to the storage
-00030f90: 206f 626a 6563 742e 0a20 2020 2020 2020   object..       
-00030fa0: 2074 6d70 5f6c 6f63 616c 5f6c 6973 745f   tmp_local_list_
-00030fb0: 7374 6f72 6167 655f 6f62 6a2e 6164 645f  storage_obj.add_
-00030fc0: 7374 6f72 6528 7374 6f72 655f 7479 7065  store(store_type
-00030fd0: 290a 0a20 2020 2020 2020 2023 2043 6865  )..        # Che
-00030fe0: 636b 2069 6620 746d 702d 6669 6c65 2065  ck if tmp-file e
-00030ff0: 7869 7374 7320 696e 2074 6865 2062 7563  xists in the buc
-00031000: 6b65 7420 726f 6f74 2075 7369 6e67 2063  ket root using c
-00031010: 6c69 0a20 2020 2020 2020 206f 7574 203d  li.        out =
-00031020: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-00031030: 6b5f 6f75 7470 7574 2873 656c 662e 636c  k_output(self.cl
-00031040: 695f 6c73 5f63 6d64 280a 2020 2020 2020  i_ls_cmd(.      
-00031050: 2020 2020 2020 7374 6f72 655f 7479 7065        store_type
-00031060: 2c20 746d 705f 6c6f 6361 6c5f 6c69 7374  , tmp_local_list
-00031070: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
-00031080: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-00031090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000310a0: 2020 2020 2020 2020 2020 7368 656c 6c3d            shell=
-000310b0: 5472 7565 290a 2020 2020 2020 2020 6173  True).        as
-000310c0: 7365 7274 2027 746d 702d 6669 6c65 2720  sert 'tmp-file' 
-000310d0: 696e 206f 7574 2e64 6563 6f64 6528 2775  in out.decode('u
-000310e0: 7466 2d38 2729 2c20 5c0a 2020 2020 2020  tf-8'), \.      
-000310f0: 2020 2020 2020 2746 696c 6520 6e6f 7420        'File not 
-00031100: 666f 756e 6420 696e 2062 7563 6b65 7420  found in bucket 
-00031110: 2d20 6f75 7470 7574 2077 6173 203a 207b  - output was : {
-00031120: 7d27 2e66 6f72 6d61 7428 6f75 742e 6465  }'.format(out.de
-00031130: 636f 6465 0a20 2020 2020 2020 2020 2020  code.           
-00031140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031170: 2020 2020 2028 2775 7466 2d38 2729 290a       ('utf-8')).
-00031180: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
-00031190: 2069 6620 746d 702d 6669 6c65 2065 7869   if tmp-file exi
-000311a0: 7374 7320 696e 2074 6865 2062 7563 6b65  sts in the bucke
-000311b0: 742f 746d 702d 736f 7572 6365 2075 7369  t/tmp-source usi
-000311c0: 6e67 2063 6c69 0a20 2020 2020 2020 206f  ng cli.        o
-000311d0: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
-000311e0: 6368 6563 6b5f 6f75 7470 7574 2873 656c  check_output(sel
-000311f0: 662e 636c 695f 6c73 5f63 6d64 280a 2020  f.cli_ls_cmd(.  
-00031200: 2020 2020 2020 2020 2020 7374 6f72 655f            store_
-00031210: 7479 7065 2c20 746d 705f 6c6f 6361 6c5f  type, tmp_local_
-00031220: 6c69 7374 5f73 746f 7261 6765 5f6f 626a  list_storage_obj
-00031230: 2e6e 616d 652c 2027 746d 702d 736f 7572  .name, 'tmp-sour
-00031240: 6365 2f27 292c 0a20 2020 2020 2020 2020  ce/'),.         
-00031250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031260: 2020 2020 2020 2020 2020 2020 2073 6865               she
-00031270: 6c6c 3d54 7275 6529 0a20 2020 2020 2020  ll=True).       
-00031280: 2061 7373 6572 7420 2774 6d70 2d66 696c   assert 'tmp-fil
-00031290: 6527 2069 6e20 6f75 742e 6465 636f 6465  e' in out.decode
-000312a0: 2827 7574 662d 3827 292c 205c 0a20 2020  ('utf-8'), \.   
-000312b0: 2020 2020 2020 2020 2027 4669 6c65 206e           'File n
-000312c0: 6f74 2066 6f75 6e64 2069 6e20 6275 636b  ot found in buck
-000312d0: 6574 202d 206f 7574 7075 7420 7761 7320  et - output was 
-000312e0: 3a20 7b7d 272e 666f 726d 6174 286f 7574  : {}'.format(out
-000312f0: 2e64 6563 6f64 650a 2020 2020 2020 2020  .decode.        
-00031300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031330: 2020 2020 2020 2020 2827 7574 662d 3827          ('utf-8'
-00031340: 2929 0a0a 2020 2020 4070 7974 6573 742e  ))..    @pytest.
-00031350: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
-00031360: 636b 0a20 2020 2040 7079 7465 7374 2e6d  ck.    @pytest.m
-00031370: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
-00031380: 2769 6e76 616c 6964 5f6e 616d 655f 6c69  'invalid_name_li
-00031390: 7374 2c20 7374 6f72 655f 7479 7065 272c  st, store_type',
-000313a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000313b0: 2020 2020 2020 2020 2020 2020 2020 5b28                [(
-000313c0: 4157 535f 494e 5641 4c49 445f 4e41 4d45  AWS_INVALID_NAME
-000313d0: 532c 2073 746f 7261 6765 5f6c 6962 2e53  S, storage_lib.S
-000313e0: 746f 7265 5479 7065 2e53 3329 2c0a 2020  toreType.S3),.  
-000313f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031400: 2020 2020 2020 2020 2020 2020 2847 4353              (GCS
-00031410: 5f49 4e56 414c 4944 5f4e 414d 4553 2c20  _INVALID_NAMES, 
-00031420: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-00031430: 6554 7970 652e 4743 5329 2c0a 2020 2020  eType.GCS),.    
-00031440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031450: 2020 2020 2020 2020 2020 7079 7465 7374            pytest
-00031460: 2e70 6172 616d 2849 424d 5f49 4e56 414c  .param(IBM_INVAL
-00031470: 4944 5f4e 414d 4553 2c0a 2020 2020 2020  ID_NAMES,.      
-00031480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fd10: 2020 2020 2020 2020 2020 2020 2020 7368                sh
+0002fd20: 656c 6c3d 5472 7565 290a 2020 2020 2020  ell=True).      
+0002fd30: 2020 2020 2020 6578 6365 7074 2073 7562        except sub
+0002fd40: 7072 6f63 6573 732e 4361 6c6c 6564 5072  process.CalledPr
+0002fd50: 6f63 6573 7345 7272 6f72 2061 7320 653a  ocessError as e:
+0002fd60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002fd70: 206f 7574 203d 2065 2e6f 7574 7075 740a   out = e.output.
+0002fd80: 2020 2020 2020 2020 2020 2020 6f75 7420              out 
+0002fd90: 3d20 6f75 742e 6465 636f 6465 2827 7574  = out.decode('ut
+0002fda0: 662d 3827 290a 2020 2020 2020 2020 2020  f-8').          
+0002fdb0: 2020 6966 2065 7870 6563 7465 645f 6f75    if expected_ou
+0002fdc0: 7470 7574 2069 6e20 6f75 743a 0a20 2020  tput in out:.   
+0002fdd0: 2020 2020 2020 2020 2020 2020 2062 7265               bre
+0002fde0: 616b 0a20 2020 2020 2020 2020 2020 2065  ak.            e
+0002fdf0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0002fe00: 2020 2020 2072 6574 7279 5f63 6f75 6e74       retry_count
+0002fe10: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
+0002fe20: 2020 2020 2020 6966 2072 6574 7279 5f63        if retry_c
+0002fe30: 6f75 6e74 203e 2033 3a0a 2020 2020 2020  ount > 3:.      
+0002fe40: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0002fe50: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
+0002fe60: 2827 556e 6162 6c65 2074 6f20 6669 6e64  ('Unable to find
+0002fe70: 2061 206e 6f6e 6578 6973 7465 6e74 2062   a nonexistent b
+0002fe80: 7563 6b65 7420 270a 2020 2020 2020 2020  ucket '.        
+0002fe90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fea0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0002feb0: 746f 2075 7365 2e20 5468 6973 2069 7320  to use. This is 
+0002fec0: 6869 676c 7920 756e 6c69 6b65 6c79 202d  higly unlikely -
+0002fed0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0002fee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fef0: 2020 2020 2020 2020 2020 2763 6865 636b            'check
+0002ff00: 2069 6620 7468 6520 7465 7374 7320 6172   if the tests ar
+0002ff10: 6520 636f 7272 6563 742e 2729 0a0a 2020  e correct.')..  
+0002ff20: 2020 2020 2020 7769 7468 2070 7974 6573        with pytes
+0002ff30: 742e 7261 6973 6573 280a 2020 2020 2020  t.raises(.      
+0002ff40: 2020 2020 2020 2020 2020 736b 792e 6578            sky.ex
+0002ff50: 6365 7074 696f 6e73 2e53 746f 7261 6765  ceptions.Storage
+0002ff60: 4275 636b 6574 4765 7445 7272 6f72 2c0a  BucketGetError,.
+0002ff70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ff80: 6d61 7463 683d 2741 7474 656d 7074 6564  match='Attempted
+0002ff90: 2074 6f20 7573 6520 6120 6e6f 6e2d 6578   to use a non-ex
+0002ffa0: 6973 7465 6e74 2062 7563 6b65 7420 6173  istent bucket as
+0002ffb0: 2061 2073 6f75 7263 6527 293a 0a20 2020   a source'):.   
+0002ffc0: 2020 2020 2020 2020 2073 746f 7261 6765           storage
+0002ffd0: 5f6f 626a 203d 2073 746f 7261 6765 5f6c  _obj = storage_l
+0002ffe0: 6962 2e53 746f 7261 6765 2873 6f75 7263  ib.Storage(sourc
+0002fff0: 653d 6e6f 6e65 7869 7374 5f62 7563 6b65  e=nonexist_bucke
+00030000: 745f 7572 6c2e 666f 726d 6174 280a 2020  t_url.format(.  
+00030010: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00030020: 6e64 6f6d 5f6e 616d 653d 6e6f 6e65 7869  ndom_name=nonexi
+00030030: 7374 5f62 7563 6b65 745f 6e61 6d65 2929  st_bucket_name))
+00030040: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
+00030050: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
+00030060: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+00030070: 6b2e 7061 7261 6d65 7472 697a 6528 2770  k.parametrize('p
+00030080: 7269 7661 7465 5f62 7563 6b65 7427 2c20  rivate_bucket', 
+00030090: 5b0a 2020 2020 2020 2020 6627 7333 3a2f  [.        f's3:/
+000300a0: 2f69 6d61 6765 6e65 7427 2c20 6627 6773  /imagenet', f'gs
+000300b0: 3a2f 2f69 6d61 6765 6e65 7427 2c0a 2020  ://imagenet',.  
+000300c0: 2020 2020 2020 7079 7465 7374 2e70 6172        pytest.par
+000300d0: 616d 2827 636f 733a 2f2f 7573 2d65 6173  am('cos://us-eas
+000300e0: 742f 6275 636b 6574 3127 2c20 6d61 726b  t/bucket1', mark
+000300f0: 733d 7079 7465 7374 2e6d 6172 6b2e 6962  s=pytest.mark.ib
+00030100: 6d29 0a20 2020 205d 290a 2020 2020 6465  m).    ]).    de
+00030110: 6620 7465 7374 5f70 7269 7661 7465 5f62  f test_private_b
+00030120: 7563 6b65 7428 7365 6c66 2c20 7072 6976  ucket(self, priv
+00030130: 6174 655f 6275 636b 6574 293a 0a20 2020  ate_bucket):.   
+00030140: 2020 2020 2023 2041 7474 656d 7074 7320       # Attempts 
+00030150: 746f 2061 6363 6573 7320 7072 6976 6174  to access privat
+00030160: 6520 6275 636b 6574 7320 6e6f 7420 6265  e buckets not be
+00030170: 6c6f 6e67 696e 6720 746f 2074 6865 2075  longing to the u
+00030180: 7365 722e 0a20 2020 2020 2020 2023 2054  ser..        # T
+00030190: 6865 7365 2062 7563 6b65 7473 2061 7265  hese buckets are
+000301a0: 206b 6e6f 776e 2074 6f20 6265 2070 7269   known to be pri
+000301b0: 7661 7465 2c20 6275 7420 6d61 7920 6e65  vate, but may ne
+000301c0: 6564 2074 6f20 6265 2075 7064 6174 6564  ed to be updated
+000301d0: 2069 660a 2020 2020 2020 2020 2320 7468   if.        # th
+000301e0: 6579 2061 7265 2072 656d 6f76 6564 2062  ey are removed b
+000301f0: 7920 7468 6569 7220 6f77 6e65 7273 2e0a  y their owners..
+00030200: 2020 2020 2020 2020 7072 6976 6174 655f          private_
+00030210: 6275 636b 6574 5f6e 616d 6520 3d20 7572  bucket_name = ur
+00030220: 6c6c 6962 2e70 6172 7365 2e75 726c 7370  llib.parse.urlsp
+00030230: 6c69 7428 7072 6976 6174 655f 6275 636b  lit(private_buck
+00030240: 6574 292e 6e65 746c 6f63 2069 6620 5c0a  et).netloc if \.
+00030250: 2020 2020 2020 2020 2020 2020 2020 7572                ur
+00030260: 6c6c 6962 2e70 6172 7365 2e75 726c 7370  llib.parse.urlsp
+00030270: 6c69 7428 7072 6976 6174 655f 6275 636b  lit(private_buck
+00030280: 6574 292e 7363 6865 6d65 2021 3d20 2763  et).scheme != 'c
+00030290: 6f73 2720 656c 7365 205c 0a20 2020 2020  os' else \.     
+000302a0: 2020 2020 2020 2020 2020 2020 2075 726c               url
+000302b0: 6c69 622e 7061 7273 652e 7572 6c73 706c  lib.parse.urlspl
+000302c0: 6974 2870 7269 7661 7465 5f62 7563 6b65  it(private_bucke
+000302d0: 7429 2e70 6174 682e 7374 7269 7028 272f  t).path.strip('/
+000302e0: 2729 0a20 2020 2020 2020 2077 6974 6820  ').        with 
+000302f0: 7079 7465 7374 2e72 6169 7365 7328 0a20  pytest.raises(. 
+00030300: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00030310: 6b79 2e65 7863 6570 7469 6f6e 732e 5374  ky.exceptions.St
+00030320: 6f72 6167 6542 7563 6b65 7447 6574 4572  orageBucketGetEr
+00030330: 726f 722c 0a20 2020 2020 2020 2020 2020  ror,.           
+00030340: 2020 2020 206d 6174 6368 3d73 746f 7261       match=stora
+00030350: 6765 5f6c 6962 2e5f 4255 434b 4554 5f46  ge_lib._BUCKET_F
+00030360: 4149 4c5f 544f 5f43 4f4e 4e45 4354 5f4d  AIL_TO_CONNECT_M
+00030370: 4553 5341 4745 2e66 6f72 6d61 7428 0a20  ESSAGE.format(. 
+00030380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030390: 2020 206e 616d 653d 7072 6976 6174 655f     name=private_
+000303a0: 6275 636b 6574 5f6e 616d 6529 293a 0a20  bucket_name)):. 
+000303b0: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+000303c0: 6765 5f6f 626a 203d 2073 746f 7261 6765  ge_obj = storage
+000303d0: 5f6c 6962 2e53 746f 7261 6765 2873 6f75  _lib.Storage(sou
+000303e0: 7263 653d 7072 6976 6174 655f 6275 636b  rce=private_buck
+000303f0: 6574 290a 0a20 2020 2040 7079 7465 7374  et)..    @pytest
+00030400: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
+00030410: 6163 6b0a 2020 2020 4070 7974 6573 742e  ack.    @pytest.
+00030420: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
+00030430: 2827 6578 745f 6275 636b 6574 5f66 6978  ('ext_bucket_fix
+00030440: 7475 7265 2c20 7374 6f72 655f 7479 7065  ture, store_type
+00030450: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00030460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030470: 5b28 2774 6d70 5f61 7773 636c 695f 6275  [('tmp_awscli_bu
+00030480: 636b 6574 272c 2073 746f 7261 6765 5f6c  cket', storage_l
+00030490: 6962 2e53 746f 7265 5479 7065 2e53 3329  ib.StoreType.S3)
+000304a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000304b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000304c0: 2827 746d 705f 6773 7574 696c 5f62 7563  ('tmp_gsutil_buc
+000304d0: 6b65 7427 2c20 7374 6f72 6167 655f 6c69  ket', storage_li
+000304e0: 622e 5374 6f72 6554 7970 652e 4743 5329  b.StoreType.GCS)
+000304f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00030500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030510: 7079 7465 7374 2e70 6172 616d 2827 746d  pytest.param('tm
+00030520: 705f 6962 6d5f 636f 735f 6275 636b 6574  p_ibm_cos_bucket
+00030530: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00030540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030550: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00030560: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+00030570: 7970 652e 4942 4d2c 0a20 2020 2020 2020  ype.IBM,.       
+00030580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000305a0: 2020 2020 6d61 726b 733d 7079 7465 7374      marks=pytest
+000305b0: 2e6d 6172 6b2e 6962 6d29 2c0a 2020 2020  .mark.ibm),.    
+000305c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000305d0: 2020 2020 2020 2020 2020 7079 7465 7374            pytest
+000305e0: 2e70 6172 616d 2827 746d 705f 6177 7363  .param('tmp_awsc
+000305f0: 6c69 5f62 7563 6b65 745f 7232 272c 0a20  li_bucket_r2',. 
+00030600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030620: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+00030630: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+00030640: 5232 2c0a 2020 2020 2020 2020 2020 2020  R2,.            
+00030650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030660: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00030670: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
+00030680: 2e63 6c6f 7564 666c 6172 6529 5d29 0a20  .cloudflare)]). 
+00030690: 2020 2064 6566 2074 6573 745f 7570 6c6f     def test_uplo
+000306a0: 6164 5f74 6f5f 6578 6973 7469 6e67 5f62  ad_to_existing_b
+000306b0: 7563 6b65 7428 7365 6c66 2c20 6578 745f  ucket(self, ext_
+000306c0: 6275 636b 6574 5f66 6978 7475 7265 2c20  bucket_fixture, 
+000306d0: 7265 7175 6573 742c 0a20 2020 2020 2020  request,.       
+000306e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000306f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030700: 746d 705f 736f 7572 6365 2c20 7374 6f72  tmp_source, stor
+00030710: 655f 7479 7065 293a 0a20 2020 2020 2020  e_type):.       
+00030720: 2023 2054 7269 6573 2075 706c 6f61 6469   # Tries uploadi
+00030730: 6e67 2065 7869 7374 696e 6720 6669 6c65  ng existing file
+00030740: 7320 746f 206e 6577 6c79 2063 7265 6174  s to newly creat
+00030750: 6564 2062 7563 6b65 7420 286f 7574 7369  ed bucket (outsi
+00030760: 6465 206f 660a 2020 2020 2020 2020 2320  de of.        # 
+00030770: 736b 7929 2061 6e64 2076 6572 6966 6965  sky) and verifie
+00030780: 7320 7468 6174 2066 696c 6573 2061 7265  s that files are
+00030790: 2077 7269 7474 656e 2e0a 2020 2020 2020   written..      
+000307a0: 2020 6275 636b 6574 5f6e 616d 652c 205f    bucket_name, _
+000307b0: 203d 2072 6571 7565 7374 2e67 6574 6669   = request.getfi
+000307c0: 7874 7572 6576 616c 7565 2865 7874 5f62  xturevalue(ext_b
+000307d0: 7563 6b65 745f 6669 7874 7572 6529 0a20  ucket_fixture). 
+000307e0: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
+000307f0: 626a 203d 2073 746f 7261 6765 5f6c 6962  bj = storage_lib
+00030800: 2e53 746f 7261 6765 286e 616d 653d 6275  .Storage(name=bu
+00030810: 636b 6574 5f6e 616d 652c 2073 6f75 7263  cket_name, sourc
+00030820: 653d 746d 705f 736f 7572 6365 290a 2020  e=tmp_source).  
+00030830: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
+00030840: 6a2e 6164 645f 7374 6f72 6528 7374 6f72  j.add_store(stor
+00030850: 655f 7479 7065 290a 0a20 2020 2020 2020  e_type)..       
+00030860: 2023 2043 6865 636b 2069 6620 746d 705f   # Check if tmp_
+00030870: 736f 7572 6365 2f74 6d70 2d66 696c 6520  source/tmp-file 
+00030880: 6578 6973 7473 2069 6e20 7468 6520 6275  exists in the bu
+00030890: 636b 6574 2075 7369 6e67 2061 7773 2063  cket using aws c
+000308a0: 6c69 0a20 2020 2020 2020 206f 7574 203d  li.        out =
+000308b0: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+000308c0: 6b5f 6f75 7470 7574 2873 656c 662e 636c  k_output(self.cl
+000308d0: 695f 6c73 5f63 6d64 2873 746f 7265 5f74  i_ls_cmd(store_t
+000308e0: 7970 652c 2062 7563 6b65 745f 6e61 6d65  ype, bucket_name
+000308f0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00030900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030910: 2020 2020 2020 2020 2073 6865 6c6c 3d54           shell=T
+00030920: 7275 6529 0a20 2020 2020 2020 2061 7373  rue).        ass
+00030930: 6572 7420 2774 6d70 2d66 696c 6527 2069  ert 'tmp-file' i
+00030940: 6e20 6f75 742e 6465 636f 6465 2827 7574  n out.decode('ut
+00030950: 662d 3827 292c 205c 0a20 2020 2020 2020  f-8'), \.       
+00030960: 2020 2020 2027 4669 6c65 206e 6f74 2066       'File not f
+00030970: 6f75 6e64 2069 6e20 6275 636b 6574 202d  ound in bucket -
+00030980: 206f 7574 7075 7420 7761 7320 3a20 7b7d   output was : {}
+00030990: 272e 666f 726d 6174 286f 7574 2e64 6563  '.format(out.dec
+000309a0: 6f64 650a 2020 2020 2020 2020 2020 2020  ode.            
+000309b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000309c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000309d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000309e0: 2020 2020 2827 7574 662d 3827 2929 0a0a      ('utf-8'))..
+000309f0: 2020 2020 2020 2020 2320 4368 6563 6b20          # Check 
+00030a00: 7379 6d6c 696e 6b73 202d 2073 796d 6c69  symlinks - symli
+00030a10: 6e6b 7320 646f 6e27 7420 6765 7420 636f  nks don't get co
+00030a20: 7069 6564 2062 7920 736b 7920 7374 6f72  pied by sky stor
+00030a30: 6167 650a 2020 2020 2020 2020 6173 7365  age.        asse
+00030a40: 7274 2028 7061 7468 6c69 622e 5061 7468  rt (pathlib.Path
+00030a50: 2874 6d70 5f73 6f75 7263 6529 202f 2027  (tmp_source) / '
+00030a60: 6369 7263 6c65 2d6c 696e 6b27 292e 6973  circle-link').is
+00030a70: 5f73 796d 6c69 6e6b 2829 2c20 280a 2020  _symlink(), (.  
+00030a80: 2020 2020 2020 2020 2020 2763 6972 636c            'circl
+00030a90: 652d 6c69 6e6b 2077 6173 206e 6f74 2066  e-link was not f
+00030aa0: 6f75 6e64 2069 6e20 7468 6520 7570 6c6f  ound in the uplo
+00030ab0: 6164 2073 6f75 7263 6520 2d20 270a 2020  ad source - '.  
+00030ac0: 2020 2020 2020 2020 2020 2761 7265 2074            'are t
+00030ad0: 6865 2074 6573 7420 6669 7874 7572 6573  he test fixtures
+00030ae0: 2063 6f72 7265 6374 3f27 290a 2020 2020   correct?').    
+00030af0: 2020 2020 6173 7365 7274 2027 6369 7263      assert 'circ
+00030b00: 6c65 2d6c 696e 6b27 206e 6f74 2069 6e20  le-link' not in 
+00030b10: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
+00030b20: 3827 292c 2028 0a20 2020 2020 2020 2020  8'), (.         
+00030b30: 2020 2027 5379 6d6c 696e 6b20 666f 756e     'Symlink foun
+00030b40: 6420 696e 2062 7563 6b65 7420 2d20 6c73  d in bucket - ls
+00030b50: 206f 7574 7075 7420 7761 7320 3a20 7b7d   output was : {}
+00030b60: 272e 666f 726d 6174 280a 2020 2020 2020  '.format(.      
+00030b70: 2020 2020 2020 2020 2020 6f75 742e 6465            out.de
+00030b80: 636f 6465 2827 7574 662d 3827 2929 290a  code('utf-8'))).
+00030b90: 0a20 2020 2020 2020 2023 2052 756e 2073  .        # Run s
+00030ba0: 6b79 2073 746f 7261 6765 206c 7320 746f  ky storage ls to
+00030bb0: 2063 6865 636b 2069 6620 7374 6f72 6167   check if storag
+00030bc0: 6520 6f62 6a65 6374 2065 7869 7374 7320  e object exists 
+00030bd0: 696e 2074 6865 206f 7574 7075 742e 0a20  in the output.. 
+00030be0: 2020 2020 2020 2023 2049 7420 7368 6f75         # It shou
+00030bf0: 6c64 206e 6f74 2065 7869 7374 2062 6563  ld not exist bec
+00030c00: 6175 7365 2074 6865 2062 7563 6b65 7420  ause the bucket 
+00030c10: 7761 7320 6372 6561 7465 6420 6578 7465  was created exte
+00030c20: 726e 616c 6c79 2e0a 2020 2020 2020 2020  rnally..        
+00030c30: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
+00030c40: 2e63 6865 636b 5f6f 7574 7075 7428 5b27  .check_output(['
+00030c50: 736b 7927 2c20 2773 746f 7261 6765 272c  sky', 'storage',
+00030c60: 2027 6c73 275d 290a 2020 2020 2020 2020   'ls']).        
+00030c70: 6173 7365 7274 2073 746f 7261 6765 5f6f  assert storage_o
+00030c80: 626a 2e6e 616d 6520 6e6f 7420 696e 206f  bj.name not in o
+00030c90: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
+00030ca0: 2729 0a0a 2020 2020 4070 7974 6573 742e  ')..    @pytest.
+00030cb0: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
+00030cc0: 636b 0a20 2020 2064 6566 2074 6573 745f  ck.    def test_
+00030cd0: 636f 7079 5f6d 6f75 6e74 5f65 7869 7374  copy_mount_exist
+00030ce0: 696e 675f 7374 6f72 6167 6528 7365 6c66  ing_storage(self
+00030cf0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00030d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030d10: 2020 2020 2020 2020 2020 2074 6d70 5f63             tmp_c
+00030d20: 6f70 795f 6d6e 745f 6578 6973 7469 6e67  opy_mnt_existing
+00030d30: 5f73 746f 7261 6765 5f6f 626a 293a 0a20  _storage_obj):. 
+00030d40: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
+00030d50: 2061 2062 7563 6b65 7420 7769 7468 206e   a bucket with n
+00030d60: 6f20 736f 7572 6365 2069 6e20 4d4f 554e  o source in MOUN
+00030d70: 5420 6d6f 6465 2028 656d 7074 7920 6275  T mode (empty bu
+00030d80: 636b 6574 292c 2061 6e64 0a20 2020 2020  cket), and.     
+00030d90: 2020 2023 2074 6865 6e20 7472 6965 7320     # then tries 
+00030da0: 746f 206c 6f61 6420 7468 6520 7361 6d65  to load the same
+00030db0: 2073 746f 7261 6765 2069 6e20 434f 5059   storage in COPY
+00030dc0: 206d 6f64 652e 0a20 2020 2020 2020 2074   mode..        t
+00030dd0: 6d70 5f63 6f70 795f 6d6e 745f 6578 6973  mp_copy_mnt_exis
+00030de0: 7469 6e67 5f73 746f 7261 6765 5f6f 626a  ting_storage_obj
+00030df0: 2e61 6464 5f73 746f 7265 2873 746f 7261  .add_store(stora
+00030e00: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+00030e10: 2e53 3329 0a20 2020 2020 2020 2073 746f  .S3).        sto
+00030e20: 7261 6765 5f6e 616d 6520 3d20 746d 705f  rage_name = tmp_
+00030e30: 636f 7079 5f6d 6e74 5f65 7869 7374 696e  copy_mnt_existin
+00030e40: 675f 7374 6f72 6167 655f 6f62 6a2e 6e61  g_storage_obj.na
+00030e50: 6d65 0a0a 2020 2020 2020 2020 2320 4368  me..        # Ch
+00030e60: 6563 6b20 6073 6b79 2073 746f 7261 6765  eck `sky storage
+00030e70: 206c 7360 2074 6f20 656e 7375 7265 2073   ls` to ensure s
+00030e80: 746f 7261 6765 206f 626a 6563 7420 6578  torage object ex
+00030e90: 6973 7473 0a20 2020 2020 2020 206f 7574  ists.        out
+00030ea0: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
+00030eb0: 6563 6b5f 6f75 7470 7574 285b 2773 6b79  eck_output(['sky
+00030ec0: 272c 2027 7374 6f72 6167 6527 2c20 276c  ', 'storage', 'l
+00030ed0: 7327 5d29 2e64 6563 6f64 6528 2775 7466  s']).decode('utf
+00030ee0: 2d38 2729 0a20 2020 2020 2020 2061 7373  -8').        ass
+00030ef0: 6572 7420 7374 6f72 6167 655f 6e61 6d65  ert storage_name
+00030f00: 2069 6e20 6f75 742c 2066 2753 746f 7261   in out, f'Stora
+00030f10: 6765 207b 7374 6f72 6167 655f 6e61 6d65  ge {storage_name
+00030f20: 7d20 6e6f 7420 666f 756e 6420 696e 2073  } not found in s
+00030f30: 6b79 2073 746f 7261 6765 206c 732e 270a  ky storage ls.'.
+00030f40: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+00030f50: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b0a  k.no_fluidstack.
+00030f60: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
+00030f70: 2e70 6172 616d 6574 7269 7a65 2827 7374  .parametrize('st
+00030f80: 6f72 655f 7479 7065 272c 205b 0a20 2020  ore_type', [.   
+00030f90: 2020 2020 2073 746f 7261 6765 5f6c 6962       storage_lib
+00030fa0: 2e53 746f 7265 5479 7065 2e53 332c 2073  .StoreType.S3, s
+00030fb0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+00030fc0: 5479 7065 2e47 4353 2c0a 2020 2020 2020  Type.GCS,.      
+00030fd0: 2020 7079 7465 7374 2e70 6172 616d 2873    pytest.param(s
+00030fe0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+00030ff0: 5479 7065 2e49 424d 2c20 6d61 726b 733d  Type.IBM, marks=
+00031000: 7079 7465 7374 2e6d 6172 6b2e 6962 6d29  pytest.mark.ibm)
+00031010: 2c0a 2020 2020 2020 2020 7079 7465 7374  ,.        pytest
+00031020: 2e70 6172 616d 2873 746f 7261 6765 5f6c  .param(storage_l
+00031030: 6962 2e53 746f 7265 5479 7065 2e52 322c  ib.StoreType.R2,
+00031040: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
+00031050: 726b 2e63 6c6f 7564 666c 6172 6529 0a20  rk.cloudflare). 
+00031060: 2020 205d 290a 2020 2020 6465 6620 7465     ]).    def te
+00031070: 7374 5f6c 6973 745f 736f 7572 6365 2873  st_list_source(s
+00031080: 656c 662c 2074 6d70 5f6c 6f63 616c 5f6c  elf, tmp_local_l
+00031090: 6973 745f 7374 6f72 6167 655f 6f62 6a2c  ist_storage_obj,
+000310a0: 2073 746f 7265 5f74 7970 6529 3a0a 2020   store_type):.  
+000310b0: 2020 2020 2020 2320 5573 6573 2061 206c        # Uses a l
+000310c0: 6973 7420 696e 2074 6865 2073 6f75 7263  ist in the sourc
+000310d0: 6520 6669 656c 6420 746f 2073 7065 6369  e field to speci
+000310e0: 6679 2061 2066 696c 6520 616e 6420 6120  fy a file and a 
+000310f0: 6469 7265 6374 6f72 7920 746f 0a20 2020  directory to.   
+00031100: 2020 2020 2023 2062 6520 7570 6c6f 6164       # be upload
+00031110: 6564 2074 6f20 7468 6520 7374 6f72 6167  ed to the storag
+00031120: 6520 6f62 6a65 6374 2e0a 2020 2020 2020  e object..      
+00031130: 2020 746d 705f 6c6f 6361 6c5f 6c69 7374    tmp_local_list
+00031140: 5f73 746f 7261 6765 5f6f 626a 2e61 6464  _storage_obj.add
+00031150: 5f73 746f 7265 2873 746f 7265 5f74 7970  _store(store_typ
+00031160: 6529 0a0a 2020 2020 2020 2020 2320 4368  e)..        # Ch
+00031170: 6563 6b20 6966 2074 6d70 2d66 696c 6520  eck if tmp-file 
+00031180: 6578 6973 7473 2069 6e20 7468 6520 6275  exists in the bu
+00031190: 636b 6574 2072 6f6f 7420 7573 696e 6720  cket root using 
+000311a0: 636c 690a 2020 2020 2020 2020 6f75 7420  cli.        out 
+000311b0: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
+000311c0: 636b 5f6f 7574 7075 7428 7365 6c66 2e63  ck_output(self.c
+000311d0: 6c69 5f6c 735f 636d 6428 0a20 2020 2020  li_ls_cmd(.     
+000311e0: 2020 2020 2020 2073 746f 7265 5f74 7970         store_typ
+000311f0: 652c 2074 6d70 5f6c 6f63 616c 5f6c 6973  e, tmp_local_lis
+00031200: 745f 7374 6f72 6167 655f 6f62 6a2e 6e61  t_storage_obj.na
+00031210: 6d65 292c 0a20 2020 2020 2020 2020 2020  me),.           
+00031220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031230: 2020 2020 2020 2020 2020 2073 6865 6c6c             shell
+00031240: 3d54 7275 6529 0a20 2020 2020 2020 2061  =True).        a
+00031250: 7373 6572 7420 2774 6d70 2d66 696c 6527  ssert 'tmp-file'
+00031260: 2069 6e20 6f75 742e 6465 636f 6465 2827   in out.decode('
+00031270: 7574 662d 3827 292c 205c 0a20 2020 2020  utf-8'), \.     
+00031280: 2020 2020 2020 2027 4669 6c65 206e 6f74         'File not
+00031290: 2066 6f75 6e64 2069 6e20 6275 636b 6574   found in bucket
+000312a0: 202d 206f 7574 7075 7420 7761 7320 3a20   - output was : 
+000312b0: 7b7d 272e 666f 726d 6174 286f 7574 2e64  {}'.format(out.d
+000312c0: 6563 6f64 650a 2020 2020 2020 2020 2020  ecode.          
+000312d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000312e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000312f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031300: 2020 2020 2020 2827 7574 662d 3827 2929        ('utf-8'))
+00031310: 0a0a 2020 2020 2020 2020 2320 4368 6563  ..        # Chec
+00031320: 6b20 6966 2074 6d70 2d66 696c 6520 6578  k if tmp-file ex
+00031330: 6973 7473 2069 6e20 7468 6520 6275 636b  ists in the buck
+00031340: 6574 2f74 6d70 2d73 6f75 7263 6520 7573  et/tmp-source us
+00031350: 696e 6720 636c 690a 2020 2020 2020 2020  ing cli.        
+00031360: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
+00031370: 2e63 6865 636b 5f6f 7574 7075 7428 7365  .check_output(se
+00031380: 6c66 2e63 6c69 5f6c 735f 636d 6428 0a20  lf.cli_ls_cmd(. 
+00031390: 2020 2020 2020 2020 2020 2073 746f 7265             store
+000313a0: 5f74 7970 652c 2074 6d70 5f6c 6f63 616c  _type, tmp_local
+000313b0: 5f6c 6973 745f 7374 6f72 6167 655f 6f62  _list_storage_ob
+000313c0: 6a2e 6e61 6d65 2c20 2774 6d70 2d73 6f75  j.name, 'tmp-sou
+000313d0: 7263 652f 2729 2c0a 2020 2020 2020 2020  rce/'),.        
+000313e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000313f0: 2020 2020 2020 2020 2020 2020 2020 7368                sh
+00031400: 656c 6c3d 5472 7565 290a 2020 2020 2020  ell=True).      
+00031410: 2020 6173 7365 7274 2027 746d 702d 6669    assert 'tmp-fi
+00031420: 6c65 2720 696e 206f 7574 2e64 6563 6f64  le' in out.decod
+00031430: 6528 2775 7466 2d38 2729 2c20 5c0a 2020  e('utf-8'), \.  
+00031440: 2020 2020 2020 2020 2020 2746 696c 6520            'File 
+00031450: 6e6f 7420 666f 756e 6420 696e 2062 7563  not found in buc
+00031460: 6b65 7420 2d20 6f75 7470 7574 2077 6173  ket - output was
+00031470: 203a 207b 7d27 2e66 6f72 6d61 7428 6f75   : {}'.format(ou
+00031480: 742e 6465 636f 6465 0a20 2020 2020 2020  t.decode.       
 00031490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000314a0: 2020 2020 2073 746f 7261 6765 5f6c 6962       storage_lib
-000314b0: 2e53 746f 7265 5479 7065 2e49 424d 2c0a  .StoreType.IBM,.
-000314c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000314d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000314e0: 2020 2020 2020 2020 2020 206d 6172 6b73             marks
-000314f0: 3d70 7974 6573 742e 6d61 726b 2e69 626d  =pytest.mark.ibm
-00031500: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00031510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031520: 2070 7974 6573 742e 7061 7261 6d28 4157   pytest.param(AW
-00031530: 535f 494e 5641 4c49 445f 4e41 4d45 532c  S_INVALID_NAMES,
-00031540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031560: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-00031570: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-00031580: 652e 5232 2c0a 2020 2020 2020 2020 2020  e.R2,.          
-00031590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000315a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000315b0: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-000315c0: 726b 2e63 6c6f 7564 666c 6172 6529 5d29  rk.cloudflare)])
-000315d0: 0a20 2020 2064 6566 2074 6573 745f 696e  .    def test_in
-000315e0: 7661 6c69 645f 6e61 6d65 7328 7365 6c66  valid_names(self
-000315f0: 2c20 696e 7661 6c69 645f 6e61 6d65 5f6c  , invalid_name_l
-00031600: 6973 742c 2073 746f 7265 5f74 7970 6529  ist, store_type)
-00031610: 3a0a 2020 2020 2020 2020 2320 5573 6573  :.        # Uses
-00031620: 2061 206c 6973 7420 696e 2074 6865 2073   a list in the s
-00031630: 6f75 7263 6520 6669 656c 6420 746f 2073  ource field to s
-00031640: 7065 6369 6679 2061 2066 696c 6520 616e  pecify a file an
-00031650: 6420 6120 6469 7265 6374 6f72 7920 746f  d a directory to
-00031660: 0a20 2020 2020 2020 2023 2062 6520 7570  .        # be up
-00031670: 6c6f 6164 6564 2074 6f20 7468 6520 7374  loaded to the st
-00031680: 6f72 6167 6520 6f62 6a65 6374 2e0a 2020  orage object..  
-00031690: 2020 2020 2020 666f 7220 6e61 6d65 2069        for name i
-000316a0: 6e20 696e 7661 6c69 645f 6e61 6d65 5f6c  n invalid_name_l
-000316b0: 6973 743a 0a20 2020 2020 2020 2020 2020  ist:.           
-000316c0: 2077 6974 6820 7079 7465 7374 2e72 6169   with pytest.rai
-000316d0: 7365 7328 736b 792e 6578 6365 7074 696f  ses(sky.exceptio
-000316e0: 6e73 2e53 746f 7261 6765 4e61 6d65 4572  ns.StorageNameEr
-000316f0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-00031700: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
-00031710: 6a20 3d20 7374 6f72 6167 655f 6c69 622e  j = storage_lib.
-00031720: 5374 6f72 6167 6528 6e61 6d65 3d6e 616d  Storage(name=nam
-00031730: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00031740: 2020 2073 746f 7261 6765 5f6f 626a 2e61     storage_obj.a
-00031750: 6464 5f73 746f 7265 2873 746f 7265 5f74  dd_store(store_t
-00031760: 7970 6529 0a0a 2020 2020 4070 7974 6573  ype)..    @pytes
-00031770: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
-00031780: 7461 636b 0a20 2020 2040 7079 7465 7374  tack.    @pytest
-00031790: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
-000317a0: 6528 0a20 2020 2020 2020 2027 6769 7469  e(.        'giti
-000317b0: 676e 6f72 655f 7374 7275 6374 7572 652c  gnore_structure,
-000317c0: 2073 746f 7265 5f74 7970 6527 2c0a 2020   store_type',.  
-000317d0: 2020 2020 2020 5b28 4749 5449 474e 4f52        [(GITIGNOR
-000317e0: 455f 5359 4e43 5f54 4553 545f 4449 525f  E_SYNC_TEST_DIR_
-000317f0: 5354 5255 4354 5552 452c 2073 746f 7261  STRUCTURE, stora
-00031800: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-00031810: 2e53 3329 2c0a 2020 2020 2020 2020 2028  .S3),.         (
-00031820: 4749 5449 474e 4f52 455f 5359 4e43 5f54  GITIGNORE_SYNC_T
-00031830: 4553 545f 4449 525f 5354 5255 4354 5552  EST_DIR_STRUCTUR
-00031840: 452c 2073 746f 7261 6765 5f6c 6962 2e53  E, storage_lib.S
-00031850: 746f 7265 5479 7065 2e47 4353 292c 0a20  toreType.GCS),. 
-00031860: 2020 2020 2020 2020 7079 7465 7374 2e70          pytest.p
-00031870: 6172 616d 2847 4954 4947 4e4f 5245 5f53  aram(GITIGNORE_S
-00031880: 594e 435f 5445 5354 5f44 4952 5f53 5452  YNC_TEST_DIR_STR
-00031890: 5543 5455 5245 2c0a 2020 2020 2020 2020  UCTURE,.        
-000318a0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-000318b0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-000318c0: 7970 652e 5232 2c0a 2020 2020 2020 2020  ype.R2,.        
-000318d0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-000318e0: 726b 733d 7079 7465 7374 2e6d 6172 6b2e  rks=pytest.mark.
-000318f0: 636c 6f75 6466 6c61 7265 295d 290a 2020  cloudflare)]).  
-00031900: 2020 6465 6620 7465 7374 5f65 7863 6c75    def test_exclu
-00031910: 6465 645f 6669 6c65 5f63 6c6f 7564 5f73  ded_file_cloud_s
-00031920: 746f 7261 6765 5f75 706c 6f61 645f 636f  torage_upload_co
-00031930: 7079 2873 656c 662c 2067 6974 6967 6e6f  py(self, gitigno
-00031940: 7265 5f73 7472 7563 7475 7265 2c0a 2020  re_structure,.  
-00031950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031980: 2020 2073 746f 7265 5f74 7970 652c 0a20     store_type,. 
-00031990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000319a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000319b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000319c0: 2020 2020 746d 705f 6769 7469 676e 6f72      tmp_gitignor
-000319d0: 655f 7374 6f72 6167 655f 6f62 6a29 3a0a  e_storage_obj):.
-000319e0: 2020 2020 2020 2020 2320 7465 7374 7320          # tests 
-000319f0: 6966 2066 696c 6573 2069 6e63 6c75 6465  if files include
-00031a00: 6420 696e 202e 6769 7469 676e 6f72 6520  d in .gitignore 
-00031a10: 616e 6420 2e67 6974 2f69 6e66 6f2f 6578  and .git/info/ex
-00031a20: 636c 7564 6520 6172 650a 2020 2020 2020  clude are.      
-00031a30: 2020 2320 6578 636c 7564 6564 2066 726f    # excluded fro
-00031a40: 6d20 6265 696e 6720 7472 616e 7366 6572  m being transfer
-00031a50: 7265 6420 746f 2053 746f 7261 6765 0a0a  red to Storage..
-00031a60: 2020 2020 2020 2020 746d 705f 6769 7469          tmp_giti
-00031a70: 676e 6f72 655f 7374 6f72 6167 655f 6f62  gnore_storage_ob
-00031a80: 6a2e 6164 645f 7374 6f72 6528 7374 6f72  j.add_store(stor
-00031a90: 655f 7479 7065 290a 0a20 2020 2020 2020  e_type)..       
-00031aa0: 2075 706c 6f61 645f 6669 6c65 5f6e 616d   upload_file_nam
-00031ab0: 6520 3d20 2769 6e63 6c75 6465 6427 0a20  e = 'included'. 
-00031ac0: 2020 2020 2020 2023 2043 6f75 6e74 2074         # Count t
-00031ad0: 6865 206e 756d 6265 7220 6f66 2066 696c  he number of fil
-00031ae0: 6573 2077 6974 6820 7468 6520 6769 7665  es with the give
-00031af0: 6e20 6669 6c65 206e 616d 650a 2020 2020  n file name.    
-00031b00: 2020 2020 7570 5f63 6d64 203d 2073 656c      up_cmd = sel
-00031b10: 662e 636c 695f 636f 756e 745f 6e61 6d65  f.cli_count_name
-00031b20: 5f69 6e5f 6275 636b 6574 2873 746f 7265  _in_bucket(store
-00031b30: 5f74 7970 652c 205c 0a20 2020 2020 2020  _type, \.       
-00031b40: 2020 2020 2074 6d70 5f67 6974 6967 6e6f       tmp_gitigno
-00031b50: 7265 5f73 746f 7261 6765 5f6f 626a 2e6e  re_storage_obj.n
-00031b60: 616d 652c 2066 696c 655f 6e61 6d65 3d75  ame, file_name=u
-00031b70: 706c 6f61 645f 6669 6c65 5f6e 616d 6529  pload_file_name)
-00031b80: 0a20 2020 2020 2020 2067 6974 5f65 7863  .        git_exc
-00031b90: 6c75 6465 5f63 6d64 203d 2073 656c 662e  lude_cmd = self.
-00031ba0: 636c 695f 636f 756e 745f 6e61 6d65 5f69  cli_count_name_i
-00031bb0: 6e5f 6275 636b 6574 2873 746f 7265 5f74  n_bucket(store_t
-00031bc0: 7970 652c 205c 0a20 2020 2020 2020 2020  ype, \.         
-00031bd0: 2020 2074 6d70 5f67 6974 6967 6e6f 7265     tmp_gitignore
-00031be0: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
-00031bf0: 652c 2066 696c 655f 6e61 6d65 3d27 2e67  e, file_name='.g
-00031c00: 6974 2729 0a20 2020 2020 2020 2063 6e74  it').        cnt
-00031c10: 5f6e 756d 5f66 696c 655f 636d 6420 3d20  _num_file_cmd = 
-00031c20: 7365 6c66 2e63 6c69 5f63 6f75 6e74 5f66  self.cli_count_f
-00031c30: 696c 655f 696e 5f62 7563 6b65 7428 0a20  ile_in_bucket(. 
-00031c40: 2020 2020 2020 2020 2020 2073 746f 7265             store
-00031c50: 5f74 7970 652c 2074 6d70 5f67 6974 6967  _type, tmp_gitig
-00031c60: 6e6f 7265 5f73 746f 7261 6765 5f6f 626a  nore_storage_obj
-00031c70: 2e6e 616d 6529 0a0a 2020 2020 2020 2020  .name)..        
-00031c80: 7570 5f6f 7574 7075 7420 3d20 7375 6270  up_output = subp
-00031c90: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
-00031ca0: 7075 7428 7570 5f63 6d64 2c20 7368 656c  put(up_cmd, shel
-00031cb0: 6c3d 5472 7565 290a 2020 2020 2020 2020  l=True).        
-00031cc0: 6769 745f 6578 636c 7564 655f 6f75 7470  git_exclude_outp
-00031cd0: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
-00031ce0: 6368 6563 6b5f 6f75 7470 7574 2867 6974  check_output(git
-00031cf0: 5f65 7863 6c75 6465 5f63 6d64 2c0a 2020  _exclude_cmd,.  
-00031d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031d30: 2020 2073 6865 6c6c 3d54 7275 6529 0a20     shell=True). 
-00031d40: 2020 2020 2020 2063 6e74 5f6f 7574 7075         cnt_outpu
-00031d50: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
-00031d60: 6865 636b 5f6f 7574 7075 7428 636e 745f  heck_output(cnt_
-00031d70: 6e75 6d5f 6669 6c65 5f63 6d64 2c20 7368  num_file_cmd, sh
-00031d80: 656c 6c3d 5472 7565 290a 0a20 2020 2020  ell=True)..     
-00031d90: 2020 2061 7373 6572 7420 2733 2720 696e     assert '3' in
-00031da0: 2075 705f 6f75 7470 7574 2e64 6563 6f64   up_output.decod
-00031db0: 6528 2775 7466 2d38 2729 2c20 5c0a 2020  e('utf-8'), \.  
-00031dc0: 2020 2020 2020 2020 2020 2020 2020 2746                'F
-00031dd0: 696c 6573 2074 6f20 6265 2069 6e63 6c75  iles to be inclu
-00031de0: 6465 6420 6172 6520 6e6f 7420 636f 6d70  ded are not comp
-00031df0: 6c65 7465 6c79 2075 706c 6f61 6465 642e  letely uploaded.
-00031e00: 270a 2020 2020 2020 2020 2320 3120 6973  '.        # 1 is
-00031e10: 2072 6561 6420 6173 202e 6769 7469 676e   read as .gitign
-00031e20: 6f72 6520 6973 2075 706c 6f61 6465 640a  ore is uploaded.
-00031e30: 2020 2020 2020 2020 6173 7365 7274 2027          assert '
-00031e40: 3127 2069 6e20 6769 745f 6578 636c 7564  1' in git_exclud
-00031e50: 655f 6f75 7470 7574 2e64 6563 6f64 6528  e_output.decode(
-00031e60: 2775 7466 2d38 2729 2c20 5c0a 2020 2020  'utf-8'), \.    
-00031e70: 2020 2020 2020 2020 2020 2027 2e67 6974             '.git
-00031e80: 2064 6972 6563 746f 7279 2073 686f 756c   directory shoul
-00031e90: 6420 6e6f 7420 6265 2075 706c 6f61 6465  d not be uploade
-00031ea0: 642e 270a 2020 2020 2020 2020 2320 3420  d.'.        # 4 
-00031eb0: 6669 6c65 7320 696e 636c 7564 6520 2e67  files include .g
-00031ec0: 6974 6967 6e6f 7265 2c20 696e 636c 7564  itignore, includ
-00031ed0: 6564 2e6c 6f67 2c20 696e 636c 7564 6564  ed.log, included
-00031ee0: 2e74 7874 2c20 696e 636c 7564 655f 6469  .txt, include_di
-00031ef0: 722f 696e 636c 7564 6564 2e6c 6f67 0a20  r/included.log. 
-00031f00: 2020 2020 2020 2061 7373 6572 7420 2734         assert '4
-00031f10: 2720 696e 2063 6e74 5f6f 7574 7075 742e  ' in cnt_output.
-00031f20: 6465 636f 6465 2827 7574 662d 3827 292c  decode('utf-8'),
-00031f30: 205c 0a20 2020 2020 2020 2020 2020 2020   \.             
-00031f40: 2020 2753 6f6d 6520 6974 656d 7320 6c69    'Some items li
-00031f50: 7374 6564 2069 6e20 2e67 6974 6967 6e6f  sted in .gitigno
-00031f60: 7265 2061 6e64 202e 6769 742f 696e 666f  re and .git/info
-00031f70: 2f65 7863 6c75 6465 2061 7265 206e 6f74  /exclude are not
-00031f80: 2065 7863 6c75 6465 642e 270a 0a20 2020   excluded.'..   
-00031f90: 2040 7079 7465 7374 2e6d 6172 6b2e 7061   @pytest.mark.pa
-00031fa0: 7261 6d65 7472 697a 6528 2765 7874 5f62  rametrize('ext_b
-00031fb0: 7563 6b65 745f 6669 7874 7572 652c 2073  ucket_fixture, s
-00031fc0: 746f 7265 5f74 7970 6527 2c0a 2020 2020  tore_type',.    
-00031fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031fe0: 2020 2020 2020 2020 205b 2827 746d 705f           [('tmp_
-00031ff0: 6177 7363 6c69 5f62 7563 6b65 7427 2c20  awscli_bucket', 
-00032000: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-00032010: 6554 7970 652e 5333 292c 0a20 2020 2020  eType.S3),.     
-00032020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032030: 2020 2020 2020 2020 2028 2774 6d70 5f67           ('tmp_g
-00032040: 7375 7469 6c5f 6275 636b 6574 272c 2073  sutil_bucket', s
-00032050: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-00032060: 5479 7065 2e47 4353 292c 0a20 2020 2020  Type.GCS),.     
-00032070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032080: 2020 2020 2020 2020 2070 7974 6573 742e           pytest.
-00032090: 7061 7261 6d28 2774 6d70 5f61 7773 636c  param('tmp_awscl
-000320a0: 695f 6275 636b 6574 5f72 3227 2c0a 2020  i_bucket_r2',.  
-000320b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000320c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000320d0: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-000320e0: 5f6c 6962 2e53 746f 7265 5479 7065 2e52  _lib.StoreType.R
-000320f0: 322c 0a20 2020 2020 2020 2020 2020 2020  2,.             
-00032100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032110: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-00032120: 726b 733d 7079 7465 7374 2e6d 6172 6b2e  rks=pytest.mark.
-00032130: 636c 6f75 6466 6c61 7265 295d 290a 2020  cloudflare)]).  
-00032140: 2020 6465 6620 7465 7374 5f65 7874 6572    def test_exter
-00032150: 6e61 6c6c 795f 6372 6561 7465 645f 6275  nally_created_bu
-00032160: 636b 6574 5f6d 6f75 6e74 5f77 6974 686f  cket_mount_witho
-00032170: 7574 5f73 6f75 7263 6528 0a20 2020 2020  ut_source(.     
-00032180: 2020 2020 2020 2073 656c 662c 2065 7874         self, ext
-00032190: 5f62 7563 6b65 745f 6669 7874 7572 652c  _bucket_fixture,
-000321a0: 2072 6571 7565 7374 2c20 7374 6f72 655f   request, store_
-000321b0: 7479 7065 293a 0a20 2020 2020 2020 2023  type):.        #
-000321c0: 204e 6f6e 2d73 6b79 206d 616e 6167 6564   Non-sky managed
-000321d0: 2062 7563 6b65 7473 2862 7563 6b65 7473   buckets(buckets
-000321e0: 2063 7265 6174 6564 206f 7574 7369 6465   created outside
-000321f0: 206f 6620 536b 7970 696c 6f74 2043 4c49   of Skypilot CLI
-00032200: 290a 2020 2020 2020 2020 2320 6172 6520  ).        # are 
-00032210: 616c 6c6f 7765 6420 746f 2062 6520 4d4f  allowed to be MO
-00032220: 554e 5465 6420 6279 2073 7065 6369 6679  UNTed by specify
-00032230: 696e 6720 7468 6520 5552 4920 6f66 2074  ing the URI of t
-00032240: 6865 2062 7563 6b65 7420 746f 0a20 2020  he bucket to.   
-00032250: 2020 2020 2023 2073 6f75 7263 6520 6669       # source fi
-00032260: 656c 6420 6f6e 6c79 2e20 5768 656e 2069  eld only. When i
-00032270: 7420 6973 2061 7474 656d 7074 6564 2062  t is attempted b
-00032280: 7920 7370 6563 6966 7969 6e67 2074 6865  y specifying the
-00032290: 206e 616d 6520 6f66 0a20 2020 2020 2020   name of.       
-000322a0: 2023 2074 6865 2062 7563 6b65 7420 6f6e   # the bucket on
-000322b0: 6c79 2c20 6974 2073 686f 756c 6420 6572  ly, it should er
-000322c0: 726f 7220 6f75 742e 0a20 2020 2020 2020  ror out..       
-000322d0: 2023 0a20 2020 2020 2020 2023 2054 4f44   #.        # TOD
-000322e0: 4f28 646f 796f 756e 6729 3a20 4164 6420  O(doyoung): Add 
-000322f0: 7465 7374 2066 6f72 2049 424d 2043 4f53  test for IBM COS
-00032300: 2e20 4375 7272 656e 746c 792c 2074 6869  . Currently, thi
-00032310: 7320 6973 2062 6c6f 636b 6564 0a20 2020  s is blocked.   
-00032320: 2020 2020 2023 2061 7320 7263 6c6f 6e65       # as rclone
-00032330: 2075 7365 6420 746f 2069 6e74 6572 6163   used to interac
-00032340: 7420 7769 7468 2049 424d 2043 4f53 2064  t with IBM COS d
-00032350: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-00032360: 6665 6174 7572 6520 746f 0a20 2020 2020  feature to.     
-00032370: 2020 2023 2063 7265 6174 6520 6120 6275     # create a bu
-00032380: 636b 6574 2c20 616e 6420 7468 6520 6962  cket, and the ib
-00032390: 6d63 6c6f 7564 2043 4c49 2069 7320 6e6f  mcloud CLI is no
-000323a0: 7420 7375 7070 6f72 7465 6420 696e 2053  t supported in S
-000323b0: 6b79 7069 6c6f 742e 0a20 2020 2020 2020  kypilot..       
-000323c0: 2023 2045 6974 6865 7220 6f66 2074 6865   # Either of the
-000323d0: 2066 6561 7475 7265 2069 7320 6e65 6365   feature is nece
-000323e0: 7373 6172 7920 746f 2073 696d 756c 6174  ssary to simulat
-000323f0: 6520 616e 2065 7874 6572 6e61 6c20 6275  e an external bu
-00032400: 636b 6574 0a20 2020 2020 2020 2023 2063  cket.        # c
-00032410: 7265 6174 696f 6e20 666f 7220 4942 4d20  reation for IBM 
-00032420: 434f 532e 0a20 2020 2020 2020 2023 2068  COS..        # h
-00032430: 7474 7073 3a2f 2f67 6974 6875 622e 636f  ttps://github.co
-00032440: 6d2f 736b 7970 696c 6f74 2d6f 7267 2f73  m/skypilot-org/s
-00032450: 6b79 7069 6c6f 742f 7075 6c6c 2f31 3936  kypilot/pull/196
-00032460: 362f 6669 6c65 7323 7231 3235 3334 3339  6/files#r1253439
-00032470: 3833 370a 0a20 2020 2020 2020 2065 7874  837..        ext
-00032480: 5f62 7563 6b65 745f 6e61 6d65 2c20 6578  _bucket_name, ex
-00032490: 745f 6275 636b 6574 5f75 7269 203d 2072  t_bucket_uri = r
-000324a0: 6571 7565 7374 2e67 6574 6669 7874 7572  equest.getfixtur
-000324b0: 6576 616c 7565 280a 2020 2020 2020 2020  evalue(.        
-000324c0: 2020 2020 6578 745f 6275 636b 6574 5f66      ext_bucket_f
-000324d0: 6978 7475 7265 290a 2020 2020 2020 2020  ixture).        
-000324e0: 2320 696e 7661 6c69 6420 7370 6563 0a20  # invalid spec. 
-000324f0: 2020 2020 2020 2077 6974 6820 7079 7465         with pyte
-00032500: 7374 2e72 6169 7365 7328 736b 792e 6578  st.raises(sky.ex
-00032510: 6365 7074 696f 6e73 2e53 746f 7261 6765  ceptions.Storage
-00032520: 5370 6563 4572 726f 7229 2061 7320 653a  SpecError) as e:
-00032530: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
-00032540: 7261 6765 5f6f 626a 203d 2073 746f 7261  rage_obj = stora
-00032550: 6765 5f6c 6962 2e53 746f 7261 6765 280a  ge_lib.Storage(.
-00032560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032570: 6e61 6d65 3d65 7874 5f62 7563 6b65 745f  name=ext_bucket_
-00032580: 6e61 6d65 2c20 6d6f 6465 3d73 746f 7261  name, mode=stora
-00032590: 6765 5f6c 6962 2e53 746f 7261 6765 4d6f  ge_lib.StorageMo
-000325a0: 6465 2e4d 4f55 4e54 290a 2020 2020 2020  de.MOUNT).      
-000325b0: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
-000325c0: 6a2e 6164 645f 7374 6f72 6528 7374 6f72  j.add_store(stor
-000325d0: 655f 7479 7065 290a 0a20 2020 2020 2020  e_type)..       
-000325e0: 2061 7373 6572 7420 2741 7474 656d 7074   assert 'Attempt
-000325f0: 6564 2074 6f20 6d6f 756e 7420 6120 6e6f  ed to mount a no
-00032600: 6e2d 736b 7920 6d61 6e61 6765 6420 6275  n-sky managed bu
-00032610: 636b 6574 2720 696e 2073 7472 2865 290a  cket' in str(e).
-00032620: 0a20 2020 2020 2020 2023 2076 616c 6964  .        # valid
-00032630: 2073 7065 630a 2020 2020 2020 2020 7374   spec.        st
-00032640: 6f72 6167 655f 6f62 6a20 3d20 7374 6f72  orage_obj = stor
-00032650: 6167 655f 6c69 622e 5374 6f72 6167 6528  age_lib.Storage(
-00032660: 736f 7572 6365 3d65 7874 5f62 7563 6b65  source=ext_bucke
-00032670: 745f 7572 692c 0a20 2020 2020 2020 2020  t_uri,.         
-00032680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000326a0: 206d 6f64 653d 7374 6f72 6167 655f 6c69   mode=storage_li
-000326b0: 622e 5374 6f72 6167 654d 6f64 652e 4d4f  b.StorageMode.MO
-000326c0: 554e 5429 0a20 2020 2020 2020 2068 616e  UNT).        han
-000326d0: 646c 6520 3d20 676c 6f62 616c 5f75 7365  dle = global_use
-000326e0: 725f 7374 6174 652e 6765 745f 6861 6e64  r_state.get_hand
-000326f0: 6c65 5f66 726f 6d5f 7374 6f72 6167 655f  le_from_storage_
-00032700: 6e61 6d65 280a 2020 2020 2020 2020 2020  name(.          
-00032710: 2020 7374 6f72 6167 655f 6f62 6a2e 6e61    storage_obj.na
-00032720: 6d65 290a 2020 2020 2020 2020 6966 2068  me).        if h
-00032730: 616e 646c 653a 0a20 2020 2020 2020 2020  andle:.         
-00032740: 2020 2073 746f 7261 6765 5f6f 626a 2e64     storage_obj.d
-00032750: 656c 6574 6528 290a 0a20 2020 2040 7079  elete()..    @py
-00032760: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
-00032770: 6964 7374 6163 6b0a 2020 2020 4070 7974  idstack.    @pyt
-00032780: 6573 742e 6d61 726b 2e70 6172 616d 6574  est.mark.paramet
-00032790: 7269 7a65 2827 7265 6769 6f6e 272c 205b  rize('region', [
-000327a0: 0a20 2020 2020 2020 2027 6170 2d6e 6f72  .        'ap-nor
-000327b0: 7468 6561 7374 2d31 272c 2027 6170 2d6e  theast-1', 'ap-n
-000327c0: 6f72 7468 6561 7374 2d32 272c 2027 6170  ortheast-2', 'ap
-000327d0: 2d6e 6f72 7468 6561 7374 2d33 272c 2027  -northeast-3', '
-000327e0: 6170 2d73 6f75 7468 2d31 272c 0a20 2020  ap-south-1',.   
-000327f0: 2020 2020 2027 6170 2d73 6f75 7468 6561       'ap-southea
-00032800: 7374 2d31 272c 2027 6170 2d73 6f75 7468  st-1', 'ap-south
-00032810: 6561 7374 2d32 272c 2027 6575 2d63 656e  east-2', 'eu-cen
-00032820: 7472 616c 2d31 272c 2027 6575 2d6e 6f72  tral-1', 'eu-nor
-00032830: 7468 2d31 272c 0a20 2020 2020 2020 2027  th-1',.        '
-00032840: 6575 2d77 6573 742d 3127 2c20 2765 752d  eu-west-1', 'eu-
-00032850: 7765 7374 2d32 272c 2027 6575 2d77 6573  west-2', 'eu-wes
-00032860: 742d 3327 2c20 2773 612d 6561 7374 2d31  t-3', 'sa-east-1
-00032870: 272c 2027 7573 2d65 6173 742d 3127 2c0a  ', 'us-east-1',.
-00032880: 2020 2020 2020 2020 2775 732d 6561 7374          'us-east
-00032890: 2d32 272c 2027 7573 2d77 6573 742d 3127  -2', 'us-west-1'
-000328a0: 2c20 2775 732d 7765 7374 2d32 270a 2020  , 'us-west-2'.  
-000328b0: 2020 5d29 0a20 2020 2064 6566 2074 6573    ]).    def tes
-000328c0: 745f 6177 735f 7265 6769 6f6e 7328 7365  t_aws_regions(se
-000328d0: 6c66 2c20 746d 705f 6c6f 6361 6c5f 7374  lf, tmp_local_st
-000328e0: 6f72 6167 655f 6f62 6a2c 2072 6567 696f  orage_obj, regio
-000328f0: 6e29 3a0a 2020 2020 2020 2020 2320 5468  n):.        # Th
-00032900: 6973 2074 6573 7473 2063 7265 6174 696f  is tests creatio
-00032910: 6e20 616e 6420 7570 6c6f 6164 2074 6f20  n and upload to 
-00032920: 6275 636b 6574 2069 6e20 616c 6c20 4157  bucket in all AW
-00032930: 5320 7333 2072 6567 696f 6e73 0a20 2020  S s3 regions.   
-00032940: 2020 2020 2023 2054 6f20 7465 7374 2066       # To test f
-00032950: 756c 6c20 6675 6e63 7469 6f6e 616c 6974  ull functionalit
-00032960: 792c 2075 7365 2074 6573 745f 6d61 6e61  y, use test_mana
-00032970: 6765 645f 6a6f 6273 5f73 746f 7261 6765  ged_jobs_storage
-00032980: 2061 626f 7665 2e0a 2020 2020 2020 2020   above..        
-00032990: 7374 6f72 655f 7479 7065 203d 2073 746f  store_type = sto
-000329a0: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-000329b0: 7065 2e53 330a 2020 2020 2020 2020 746d  pe.S3.        tm
-000329c0: 705f 6c6f 6361 6c5f 7374 6f72 6167 655f  p_local_storage_
-000329d0: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
-000329e0: 6f72 655f 7479 7065 2c20 7265 6769 6f6e  ore_type, region
-000329f0: 3d72 6567 696f 6e29 0a20 2020 2020 2020  =region).       
-00032a00: 2062 7563 6b65 745f 6e61 6d65 203d 2074   bucket_name = t
-00032a10: 6d70 5f6c 6f63 616c 5f73 746f 7261 6765  mp_local_storage
-00032a20: 5f6f 626a 2e6e 616d 650a 0a20 2020 2020  _obj.name..     
-00032a30: 2020 2023 2043 6f6e 6669 726d 2074 6861     # Confirm tha
-00032a40: 7420 7468 6520 6275 636b 6574 2077 6173  t the bucket was
-00032a50: 2063 7265 6174 6564 2069 6e20 7468 6520   created in the 
-00032a60: 636f 7272 6563 7420 7265 6769 6f6e 0a20  correct region. 
-00032a70: 2020 2020 2020 2072 6567 696f 6e5f 636d         region_cm
-00032a80: 6420 3d20 7365 6c66 2e63 6c69 5f72 6567  d = self.cli_reg
-00032a90: 696f 6e5f 636d 6428 7374 6f72 655f 7479  ion_cmd(store_ty
-00032aa0: 7065 2c20 6275 636b 6574 5f6e 616d 6529  pe, bucket_name)
-00032ab0: 0a20 2020 2020 2020 206f 7574 203d 2073  .        out = s
-00032ac0: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-00032ad0: 6f75 7470 7574 2872 6567 696f 6e5f 636d  output(region_cm
-00032ae0: 642c 2073 6865 6c6c 3d54 7275 6529 0a20  d, shell=True). 
-00032af0: 2020 2020 2020 206f 7574 7075 7420 3d20         output = 
-00032b00: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
-00032b10: 3827 290a 2020 2020 2020 2020 6578 7065  8').        expe
-00032b20: 6374 6564 5f6f 7574 7075 745f 7265 6769  cted_output_regi
-00032b30: 6f6e 203d 2072 6567 696f 6e0a 2020 2020  on = region.    
-00032b40: 2020 2020 6966 2072 6567 696f 6e20 3d3d      if region ==
-00032b50: 2027 7573 2d65 6173 742d 3127 3a0a 2020   'us-east-1':.  
-00032b60: 2020 2020 2020 2020 2020 6578 7065 6374            expect
-00032b70: 6564 5f6f 7574 7075 745f 7265 6769 6f6e  ed_output_region
-00032b80: 203d 2027 4e6f 6e65 2720 2023 2075 732d   = 'None'  # us-
-00032b90: 6561 7374 2d31 2069 7320 7468 6520 6465  east-1 is the de
-00032ba0: 6661 756c 7420 7265 6769 6f6e 0a20 2020  fault region.   
-00032bb0: 2020 2020 2061 7373 6572 7420 6578 7065       assert expe
-00032bc0: 6374 6564 5f6f 7574 7075 745f 7265 6769  cted_output_regi
-00032bd0: 6f6e 2069 6e20 6f75 742e 6465 636f 6465  on in out.decode
-00032be0: 2827 7574 662d 3827 292c 2028 0a20 2020  ('utf-8'), (.   
-00032bf0: 2020 2020 2020 2020 2066 2742 7563 6b65           f'Bucke
-00032c00: 7420 7761 7320 6e6f 7420 666f 756e 6420  t was not found 
-00032c10: 696e 2072 6567 696f 6e20 7b72 6567 696f  in region {regio
-00032c20: 6e7d 202d 2027 0a20 2020 2020 2020 2020  n} - '.         
-00032c30: 2020 2066 276f 7574 7075 7420 6f66 207b     f'output of {
-00032c40: 7265 6769 6f6e 5f63 6d64 7d20 7761 733a  region_cmd} was:
-00032c50: 207b 6f75 7470 7574 7d27 290a 0a20 2020   {output}')..   
-00032c60: 2020 2020 2023 2043 6865 636b 2069 6620       # Check if 
-00032c70: 746d 705f 736f 7572 6365 2f74 6d70 2d66  tmp_source/tmp-f
-00032c80: 696c 6520 6578 6973 7473 2069 6e20 7468  ile exists in th
-00032c90: 6520 6275 636b 6574 2075 7369 6e67 2063  e bucket using c
-00032ca0: 6c69 0a20 2020 2020 2020 206c 735f 636d  li.        ls_cm
-00032cb0: 6420 3d20 7365 6c66 2e63 6c69 5f6c 735f  d = self.cli_ls_
-00032cc0: 636d 6428 7374 6f72 655f 7479 7065 2c20  cmd(store_type, 
-00032cd0: 6275 636b 6574 5f6e 616d 6529 0a20 2020  bucket_name).   
-00032ce0: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
-00032cf0: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-00032d00: 7574 286c 735f 636d 642c 2073 6865 6c6c  ut(ls_cmd, shell
-00032d10: 3d54 7275 6529 0a20 2020 2020 2020 206f  =True).        o
-00032d20: 7574 7075 7420 3d20 6f75 742e 6465 636f  utput = out.deco
-00032d30: 6465 2827 7574 662d 3827 290a 2020 2020  de('utf-8').    
-00032d40: 2020 2020 6173 7365 7274 2027 746d 702d      assert 'tmp-
-00032d50: 6669 6c65 2720 696e 206f 7574 7075 742c  file' in output,
-00032d60: 2028 0a20 2020 2020 2020 2020 2020 2066   (.            f
-00032d70: 2774 6d70 2d66 696c 6520 6e6f 7420 666f  'tmp-file not fo
-00032d80: 756e 6420 696e 2062 7563 6b65 7420 2d20  und in bucket - 
-00032d90: 6f75 7470 7574 206f 6620 7b6c 735f 636d  output of {ls_cm
-00032da0: 647d 2077 6173 3a20 7b6f 7574 7075 747d  d} was: {output}
-00032db0: 2729 0a0a 2020 2020 4070 7974 6573 742e  ')..    @pytest.
-00032dc0: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
-00032dd0: 636b 0a20 2020 2040 7079 7465 7374 2e6d  ck.    @pytest.m
-00032de0: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
-00032df0: 2772 6567 696f 6e27 2c20 5b0a 2020 2020  'region', [.    
-00032e00: 2020 2020 276e 6f72 7468 616d 6572 6963      'northameric
-00032e10: 612d 6e6f 7274 6865 6173 7431 272c 2027  a-northeast1', '
-00032e20: 6e6f 7274 6861 6d65 7269 6361 2d6e 6f72  northamerica-nor
-00032e30: 7468 6561 7374 3227 2c20 2775 732d 6365  theast2', 'us-ce
-00032e40: 6e74 7261 6c31 272c 0a20 2020 2020 2020  ntral1',.       
-00032e50: 2027 7573 2d65 6173 7431 272c 2027 7573   'us-east1', 'us
-00032e60: 2d65 6173 7434 272c 2027 7573 2d65 6173  -east4', 'us-eas
-00032e70: 7435 272c 2027 7573 2d73 6f75 7468 3127  t5', 'us-south1'
-00032e80: 2c20 2775 732d 7765 7374 3127 2c20 2775  , 'us-west1', 'u
-00032e90: 732d 7765 7374 3227 2c0a 2020 2020 2020  s-west2',.      
-00032ea0: 2020 2775 732d 7765 7374 3327 2c20 2775    'us-west3', 'u
-00032eb0: 732d 7765 7374 3427 2c20 2773 6f75 7468  s-west4', 'south
-00032ec0: 616d 6572 6963 612d 6561 7374 3127 2c20  america-east1', 
-00032ed0: 2773 6f75 7468 616d 6572 6963 612d 7765  'southamerica-we
-00032ee0: 7374 3127 2c0a 2020 2020 2020 2020 2765  st1',.        'e
-00032ef0: 7572 6f70 652d 6365 6e74 7261 6c32 272c  urope-central2',
-00032f00: 2027 6575 726f 7065 2d6e 6f72 7468 3127   'europe-north1'
-00032f10: 2c20 2765 7572 6f70 652d 736f 7574 6877  , 'europe-southw
-00032f20: 6573 7431 272c 2027 6575 726f 7065 2d77  est1', 'europe-w
-00032f30: 6573 7431 272c 0a20 2020 2020 2020 2027  est1',.        '
-00032f40: 6575 726f 7065 2d77 6573 7432 272c 2027  europe-west2', '
-00032f50: 6575 726f 7065 2d77 6573 7433 272c 2027  europe-west3', '
-00032f60: 6575 726f 7065 2d77 6573 7434 272c 2027  europe-west4', '
-00032f70: 6575 726f 7065 2d77 6573 7436 272c 0a20  europe-west6',. 
-00032f80: 2020 2020 2020 2027 6575 726f 7065 2d77         'europe-w
-00032f90: 6573 7438 272c 2027 6575 726f 7065 2d77  est8', 'europe-w
-00032fa0: 6573 7439 272c 2027 6575 726f 7065 2d77  est9', 'europe-w
-00032fb0: 6573 7431 3027 2c20 2765 7572 6f70 652d  est10', 'europe-
-00032fc0: 7765 7374 3132 272c 0a20 2020 2020 2020  west12',.       
-00032fd0: 2027 6173 6961 2d65 6173 7431 272c 2027   'asia-east1', '
-00032fe0: 6173 6961 2d65 6173 7432 272c 2027 6173  asia-east2', 'as
-00032ff0: 6961 2d6e 6f72 7468 6561 7374 3127 2c20  ia-northeast1', 
-00033000: 2761 7369 612d 6e6f 7274 6865 6173 7432  'asia-northeast2
-00033010: 272c 0a20 2020 2020 2020 2027 6173 6961  ',.        'asia
-00033020: 2d6e 6f72 7468 6561 7374 3327 2c20 2761  -northeast3', 'a
-00033030: 7369 612d 736f 7574 6865 6173 7431 272c  sia-southeast1',
-00033040: 2027 6173 6961 2d73 6f75 7468 3127 2c20   'asia-south1', 
-00033050: 2761 7369 612d 736f 7574 6832 272c 0a20  'asia-south2',. 
-00033060: 2020 2020 2020 2027 6173 6961 2d73 6f75         'asia-sou
-00033070: 7468 6561 7374 3227 2c20 276d 652d 6365  theast2', 'me-ce
-00033080: 6e74 7261 6c31 272c 2027 6d65 2d63 656e  ntral1', 'me-cen
-00033090: 7472 616c 3227 2c20 276d 652d 7765 7374  tral2', 'me-west
-000330a0: 3127 2c0a 2020 2020 2020 2020 2761 7573  1',.        'aus
-000330b0: 7472 616c 6961 2d73 6f75 7468 6561 7374  tralia-southeast
-000330c0: 3127 2c20 2761 7573 7472 616c 6961 2d73  1', 'australia-s
-000330d0: 6f75 7468 6561 7374 3227 2c20 2761 6672  outheast2', 'afr
-000330e0: 6963 612d 736f 7574 6831 270a 2020 2020  ica-south1'.    
-000330f0: 5d29 0a20 2020 2064 6566 2074 6573 745f  ]).    def test_
-00033100: 6763 735f 7265 6769 6f6e 7328 7365 6c66  gcs_regions(self
-00033110: 2c20 746d 705f 6c6f 6361 6c5f 7374 6f72  , tmp_local_stor
-00033120: 6167 655f 6f62 6a2c 2072 6567 696f 6e29  age_obj, region)
-00033130: 3a0a 2020 2020 2020 2020 2320 5468 6973  :.        # This
-00033140: 2074 6573 7473 2063 7265 6174 696f 6e20   tests creation 
-00033150: 616e 6420 7570 6c6f 6164 2074 6f20 6275  and upload to bu
-00033160: 636b 6574 2069 6e20 616c 6c20 4743 5320  cket in all GCS 
-00033170: 7265 6769 6f6e 730a 2020 2020 2020 2020  regions.        
-00033180: 2320 546f 2074 6573 7420 6675 6c6c 2066  # To test full f
-00033190: 756e 6374 696f 6e61 6c69 7479 2c20 7573  unctionality, us
-000331a0: 6520 7465 7374 5f6d 616e 6167 6564 5f6a  e test_managed_j
-000331b0: 6f62 735f 7374 6f72 6167 6520 6162 6f76  obs_storage abov
-000331c0: 652e 0a20 2020 2020 2020 2073 746f 7265  e..        store
-000331d0: 5f74 7970 6520 3d20 7374 6f72 6167 655f  _type = storage_
-000331e0: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
-000331f0: 530a 2020 2020 2020 2020 746d 705f 6c6f  S.        tmp_lo
-00033200: 6361 6c5f 7374 6f72 6167 655f 6f62 6a2e  cal_storage_obj.
-00033210: 6164 645f 7374 6f72 6528 7374 6f72 655f  add_store(store_
-00033220: 7479 7065 2c20 7265 6769 6f6e 3d72 6567  type, region=reg
-00033230: 696f 6e29 0a20 2020 2020 2020 2062 7563  ion).        buc
-00033240: 6b65 745f 6e61 6d65 203d 2074 6d70 5f6c  ket_name = tmp_l
-00033250: 6f63 616c 5f73 746f 7261 6765 5f6f 626a  ocal_storage_obj
-00033260: 2e6e 616d 650a 0a20 2020 2020 2020 2023  .name..        #
-00033270: 2043 6f6e 6669 726d 2074 6861 7420 7468   Confirm that th
-00033280: 6520 6275 636b 6574 2077 6173 2063 7265  e bucket was cre
-00033290: 6174 6564 2069 6e20 7468 6520 636f 7272  ated in the corr
-000332a0: 6563 7420 7265 6769 6f6e 0a20 2020 2020  ect region.     
-000332b0: 2020 2072 6567 696f 6e5f 636d 6420 3d20     region_cmd = 
-000332c0: 7365 6c66 2e63 6c69 5f72 6567 696f 6e5f  self.cli_region_
-000332d0: 636d 6428 7374 6f72 655f 7479 7065 2c20  cmd(store_type, 
-000332e0: 6275 636b 6574 5f6e 616d 6529 0a20 2020  bucket_name).   
-000332f0: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
-00033300: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-00033310: 7574 2872 6567 696f 6e5f 636d 642c 2073  ut(region_cmd, s
-00033320: 6865 6c6c 3d54 7275 6529 0a20 2020 2020  hell=True).     
-00033330: 2020 206f 7574 7075 7420 3d20 6f75 742e     output = out.
-00033340: 6465 636f 6465 2827 7574 662d 3827 290a  decode('utf-8').
-00033350: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
-00033360: 6567 696f 6e20 696e 206f 7574 2e64 6563  egion in out.dec
-00033370: 6f64 6528 2775 7466 2d38 2729 2c20 280a  ode('utf-8'), (.
-00033380: 2020 2020 2020 2020 2020 2020 6627 4275              f'Bu
-00033390: 636b 6574 2077 6173 206e 6f74 2066 6f75  cket was not fou
-000333a0: 6e64 2069 6e20 7265 6769 6f6e 207b 7265  nd in region {re
-000333b0: 6769 6f6e 7d20 2d20 270a 2020 2020 2020  gion} - '.      
-000333c0: 2020 2020 2020 6627 6f75 7470 7574 206f        f'output o
-000333d0: 6620 7b72 6567 696f 6e5f 636d 647d 2077  f {region_cmd} w
-000333e0: 6173 3a20 7b6f 7574 7075 747d 2729 0a0a  as: {output}')..
-000333f0: 2020 2020 2020 2020 2320 4368 6563 6b20          # Check 
-00033400: 6966 2074 6d70 5f73 6f75 7263 652f 746d  if tmp_source/tm
-00033410: 702d 6669 6c65 2065 7869 7374 7320 696e  p-file exists in
-00033420: 2074 6865 2062 7563 6b65 7420 7573 696e   the bucket usin
-00033430: 6720 636c 690a 2020 2020 2020 2020 6c73  g cli.        ls
-00033440: 5f63 6d64 203d 2073 656c 662e 636c 695f  _cmd = self.cli_
-00033450: 6c73 5f63 6d64 2873 746f 7265 5f74 7970  ls_cmd(store_typ
-00033460: 652c 2062 7563 6b65 745f 6e61 6d65 290a  e, bucket_name).
-00033470: 2020 2020 2020 2020 6f75 7420 3d20 7375          out = su
-00033480: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
-00033490: 7574 7075 7428 6c73 5f63 6d64 2c20 7368  utput(ls_cmd, sh
-000334a0: 656c 6c3d 5472 7565 290a 2020 2020 2020  ell=True).      
-000334b0: 2020 6f75 7470 7574 203d 206f 7574 2e64    output = out.d
-000334c0: 6563 6f64 6528 2775 7466 2d38 2729 0a20  ecode('utf-8'). 
-000334d0: 2020 2020 2020 2061 7373 6572 7420 2774         assert 't
-000334e0: 6d70 2d66 696c 6527 2069 6e20 6f75 7470  mp-file' in outp
-000334f0: 7574 2c20 280a 2020 2020 2020 2020 2020  ut, (.          
-00033500: 2020 6627 746d 702d 6669 6c65 206e 6f74    f'tmp-file not
-00033510: 2066 6f75 6e64 2069 6e20 6275 636b 6574   found in bucket
-00033520: 202d 206f 7574 7075 7420 6f66 207b 6c73   - output of {ls
-00033530: 5f63 6d64 7d20 7761 733a 207b 6f75 7470  _cmd} was: {outp
-00033540: 7574 7d27 290a 0a0a 2320 2d2d 2d2d 2d2d  ut}')...# ------
-00033550: 2d2d 2d2d 2054 6573 7469 6e67 2059 414d  ---- Testing YAM
-00033560: 4c20 5370 6563 7320 2d2d 2d2d 2d2d 2d2d  L Specs --------
-00033570: 2d2d 0a23 204f 7572 2073 6b79 2073 746f  --.# Our sky sto
-00033580: 7261 6765 2072 6571 7569 7265 7320 6372  rage requires cr
-00033590: 6564 656e 7469 616c 7320 746f 2063 6865  edentials to che
-000335a0: 636b 2074 6865 2062 7563 6b65 7420 6578  ck the bucket ex
-000335b0: 6973 7461 6e63 6520 7768 656e 0a23 206c  istance when.# l
-000335c0: 6f61 6469 6e67 2061 2074 6173 6b20 6672  oading a task fr
-000335d0: 6f6d 2074 6865 2079 616d 6c20 6669 6c65  om the yaml file
-000335e0: 2c20 736f 2077 6520 6361 6e6e 6f74 206d  , so we cannot m
-000335f0: 616b 6520 6974 2061 2075 6e69 7420 7465  ake it a unit te
-00033600: 7374 2e0a 636c 6173 7320 5465 7374 5961  st..class TestYa
-00033610: 6d6c 5370 6563 733a 0a20 2020 2023 2054  mlSpecs:.    # T
-00033620: 4f44 4f28 7a68 7775 293a 2041 6464 2074  ODO(zhwu): Add t
-00033630: 6573 7420 666f 7220 6074 6f5f 7961 6d6c  est for `to_yaml
-00033640: 5f63 6f6e 6669 6760 2066 6f72 2074 6865  _config` for the
-00033650: 2053 746f 7261 6765 206f 626a 6563 742e   Storage object.
-00033660: 0a20 2020 2023 2020 5765 2073 686f 756c  .    #  We shoul
-00033670: 6420 6e6f 7420 7573 6520 6065 7861 6d70  d not use `examp
-00033680: 6c65 732f 7374 6f72 6167 655f 6465 6d6f  les/storage_demo
-00033690: 2e79 616d 6c60 2068 6572 652c 2073 696e  .yaml` here, sin
-000336a0: 6365 2069 7420 7265 7175 6972 6573 0a20  ce it requires. 
-000336b0: 2020 2023 2020 7573 6572 7320 746f 2065     #  users to e
-000336c0: 6e73 7572 6520 6275 636b 6574 206e 616d  nsure bucket nam
-000336d0: 6573 2074 6f20 6e6f 7420 6578 6973 7420  es to not exist 
-000336e0: 616e 642f 6f72 2062 6520 756e 6971 7565  and/or be unique
-000336f0: 2e0a 2020 2020 5f54 4553 545f 5941 4d4c  ..    _TEST_YAML
-00033700: 5f50 4154 4853 203d 205b 0a20 2020 2020  _PATHS = [.     
-00033710: 2020 2027 6578 616d 706c 6573 2f6d 696e     'examples/min
-00033720: 696d 616c 2e79 616d 6c27 2c20 2765 7861  imal.yaml', 'exa
-00033730: 6d70 6c65 732f 6d61 6e61 6765 645f 6a6f  mples/managed_jo
-00033740: 622e 7961 6d6c 272c 0a20 2020 2020 2020  b.yaml',.       
-00033750: 2027 6578 616d 706c 6573 2f75 7369 6e67   'examples/using
-00033760: 5f66 696c 655f 6d6f 756e 7473 2e79 616d  _file_mounts.yam
-00033770: 6c27 2c20 2765 7861 6d70 6c65 732f 7265  l', 'examples/re
-00033780: 736e 6574 5f61 7070 2e79 616d 6c27 2c0a  snet_app.yaml',.
-00033790: 2020 2020 2020 2020 2765 7861 6d70 6c65          'example
-000337a0: 732f 6d75 6c74 695f 686f 7374 6e61 6d65  s/multi_hostname
-000337b0: 2e79 616d 6c27 0a20 2020 205d 0a0a 2020  .yaml'.    ]..  
-000337c0: 2020 6465 6620 5f69 735f 6469 6374 5f73    def _is_dict_s
-000337d0: 7562 7365 7428 7365 6c66 2c20 6431 2c20  ubset(self, d1, 
-000337e0: 6432 293a 0a20 2020 2020 2020 2022 2222  d2):.        """
-000337f0: 4368 6563 6b20 6966 2064 3120 6973 2074  Check if d1 is t
-00033800: 6865 2073 7562 7365 7420 6f66 2064 322e  he subset of d2.
-00033810: 2222 220a 2020 2020 2020 2020 666f 7220  """.        for 
-00033820: 6b2c 2076 2069 6e20 6431 2e69 7465 6d73  k, v in d1.items
-00033830: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00033840: 6966 206b 206e 6f74 2069 6e20 6432 3a0a  if k not in d2:.
-00033850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033860: 6966 2069 7369 6e73 7461 6e63 6528 762c  if isinstance(v,
-00033870: 206c 6973 7429 206f 7220 6973 696e 7374   list) or isinst
-00033880: 616e 6365 2876 2c20 6469 6374 293a 0a20  ance(v, dict):. 
-00033890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000338a0: 2020 2061 7373 6572 7420 6c65 6e28 7629     assert len(v)
-000338b0: 203d 3d20 302c 2028 6b2c 2076 290a 2020   == 0, (k, v).  
-000338c0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-000338d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000338e0: 2020 2020 2020 2020 6173 7365 7274 2046          assert F
-000338f0: 616c 7365 2c20 286b 2c20 7629 0a20 2020  alse, (k, v).   
-00033900: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
-00033910: 696e 7374 616e 6365 2876 2c20 6469 6374  instance(v, dict
-00033920: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00033930: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
-00033940: 616e 6365 2864 325b 6b5d 2c20 6469 6374  ance(d2[k], dict
-00033950: 292c 2028 6b2c 2076 2c20 6432 290a 2020  ), (k, v, d2).  
-00033960: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00033970: 6c66 2e5f 6973 5f64 6963 745f 7375 6273  lf._is_dict_subs
-00033980: 6574 2876 2c20 6432 5b6b 5d29 0a20 2020  et(v, d2[k]).   
-00033990: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
-000339a0: 696e 7374 616e 6365 2876 2c20 7374 7229  instance(v, str)
-000339b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000339c0: 2020 6966 206b 203d 3d20 2761 6363 656c    if k == 'accel
-000339d0: 6572 6174 6f72 7327 3a0a 2020 2020 2020  erators':.      
-000339e0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-000339f0: 736f 7572 6365 7320 3d20 736b 792e 5265  sources = sky.Re
-00033a00: 736f 7572 6365 7328 290a 2020 2020 2020  sources().      
-00033a10: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00033a20: 736f 7572 6365 732e 5f73 6574 5f61 6363  sources._set_acc
-00033a30: 656c 6572 6174 6f72 7328 762c 204e 6f6e  elerators(v, Non
-00033a40: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00033a50: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
-00033a60: 736f 7572 6365 732e 6163 6365 6c65 7261  sources.accelera
-00033a70: 746f 7273 203d 3d20 6432 5b6b 5d2c 2028  tors == d2[k], (
-00033a80: 6b2c 2076 2c20 6432 290a 2020 2020 2020  k, v, d2).      
-00033a90: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00033aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033ab0: 2020 2020 6173 7365 7274 2076 2e6c 6f77      assert v.low
-00033ac0: 6572 2829 203d 3d20 6432 5b6b 5d2e 6c6f  er() == d2[k].lo
-00033ad0: 7765 7228 292c 2028 6b2c 2076 2c20 6432  wer(), (k, v, d2
-00033ae0: 5b6b 5d29 0a20 2020 2020 2020 2020 2020  [k]).           
-00033af0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00033b00: 2020 2020 2020 2061 7373 6572 7420 7620         assert v 
-00033b10: 3d3d 2064 325b 6b5d 2c20 286b 2c20 762c  == d2[k], (k, v,
-00033b20: 2064 325b 6b5d 290a 0a20 2020 2064 6566   d2[k])..    def
-00033b30: 205f 6368 6563 6b5f 6571 7569 7661 6c65   _check_equivale
-00033b40: 6e74 2873 656c 662c 2079 616d 6c5f 7061  nt(self, yaml_pa
-00033b50: 7468 293a 0a20 2020 2020 2020 2022 2222  th):.        """
-00033b60: 4368 6563 6b20 6966 2074 6865 2079 616d  Check if the yam
-00033b70: 6c20 6973 2065 7175 6976 616c 656e 7420  l is equivalent 
-00033b80: 6166 7465 7220 6c6f 6164 2061 6e64 2064  after load and d
-00033b90: 756d 7020 6167 6169 6e2e 2222 220a 2020  ump again.""".  
-00033ba0: 2020 2020 2020 6f72 6967 696e 5f74 6173        origin_tas
-00033bb0: 6b5f 636f 6e66 6967 203d 2063 6f6d 6d6f  k_config = commo
-00033bc0: 6e5f 7574 696c 732e 7265 6164 5f79 616d  n_utils.read_yam
-00033bd0: 6c28 7961 6d6c 5f70 6174 6829 0a0a 2020  l(yaml_path)..  
-00033be0: 2020 2020 2020 7461 736b 203d 2073 6b79        task = sky
-00033bf0: 2e54 6173 6b2e 6672 6f6d 5f79 616d 6c28  .Task.from_yaml(
-00033c00: 7961 6d6c 5f70 6174 6829 0a20 2020 2020  yaml_path).     
-00033c10: 2020 206e 6577 5f74 6173 6b5f 636f 6e66     new_task_conf
-00033c20: 6967 203d 2074 6173 6b2e 746f 5f79 616d  ig = task.to_yam
-00033c30: 6c5f 636f 6e66 6967 2829 0a20 2020 2020  l_config().     
-00033c40: 2020 2023 2064 3120 3c3d 2064 320a 2020     # d1 <= d2.  
-00033c50: 2020 2020 2020 7072 696e 7428 6f72 6967        print(orig
-00033c60: 696e 5f74 6173 6b5f 636f 6e66 6967 2c20  in_task_config, 
-00033c70: 6e65 775f 7461 736b 5f63 6f6e 6669 6729  new_task_config)
-00033c80: 0a20 2020 2020 2020 2073 656c 662e 5f69  .        self._i
-00033c90: 735f 6469 6374 5f73 7562 7365 7428 6f72  s_dict_subset(or
-00033ca0: 6967 696e 5f74 6173 6b5f 636f 6e66 6967  igin_task_config
-00033cb0: 2c20 6e65 775f 7461 736b 5f63 6f6e 6669  , new_task_confi
-00033cc0: 6729 0a0a 2020 2020 6465 6620 7465 7374  g)..    def test
-00033cd0: 5f6c 6f61 645f 6475 6d70 5f79 616d 6c5f  _load_dump_yaml_
-00033ce0: 636f 6e66 6967 5f65 7175 6976 616c 656e  config_equivalen
-00033cf0: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
-00033d00: 2022 2222 5465 7374 2069 6620 7468 6520   """Test if the 
-00033d10: 7961 6d6c 2063 6f6e 6669 6720 6973 2065  yaml config is e
-00033d20: 7175 6976 616c 656e 7420 6166 7465 7220  quivalent after 
-00033d30: 6c6f 6164 2061 6e64 2064 756d 7020 6167  load and dump ag
-00033d40: 6169 6e2e 2222 220a 2020 2020 2020 2020  ain.""".        
-00033d50: 7061 7468 6c69 622e 5061 7468 2827 7e2f  pathlib.Path('~/
-00033d60: 6461 7461 7365 7473 2729 2e65 7870 616e  datasets').expan
-00033d70: 6475 7365 7228 292e 6d6b 6469 7228 6578  duser().mkdir(ex
-00033d80: 6973 745f 6f6b 3d54 7275 6529 0a20 2020  ist_ok=True).   
-00033d90: 2020 2020 2070 6174 686c 6962 2e50 6174       pathlib.Pat
-00033da0: 6828 277e 2f74 6d70 6669 6c65 2729 2e65  h('~/tmpfile').e
-00033db0: 7870 616e 6475 7365 7228 292e 746f 7563  xpanduser().touc
-00033dc0: 6828 290a 2020 2020 2020 2020 7061 7468  h().        path
-00033dd0: 6c69 622e 5061 7468 2827 7e2f 2e73 7368  lib.Path('~/.ssh
-00033de0: 2729 2e65 7870 616e 6475 7365 7228 292e  ').expanduser().
-00033df0: 6d6b 6469 7228 6578 6973 745f 6f6b 3d54  mkdir(exist_ok=T
-00033e00: 7275 6529 0a20 2020 2020 2020 2070 6174  rue).        pat
-00033e10: 686c 6962 2e50 6174 6828 277e 2f2e 7373  hlib.Path('~/.ss
-00033e20: 682f 6964 5f72 7361 2e70 7562 2729 2e65  h/id_rsa.pub').e
-00033e30: 7870 616e 6475 7365 7228 292e 746f 7563  xpanduser().touc
-00033e40: 6828 290a 2020 2020 2020 2020 7061 7468  h().        path
-00033e50: 6c69 622e 5061 7468 2827 7e2f 746d 702d  lib.Path('~/tmp-
-00033e60: 776f 726b 6469 7227 292e 6578 7061 6e64  workdir').expand
-00033e70: 7573 6572 2829 2e6d 6b64 6972 2865 7869  user().mkdir(exi
-00033e80: 7374 5f6f 6b3d 5472 7565 290a 2020 2020  st_ok=True).    
-00033e90: 2020 2020 7061 7468 6c69 622e 5061 7468      pathlib.Path
-00033ea0: 2827 7e2f 446f 776e 6c6f 6164 732f 7470  ('~/Downloads/tp
-00033eb0: 7527 292e 6578 7061 6e64 7573 6572 2829  u').expanduser()
-00033ec0: 2e6d 6b64 6972 2870 6172 656e 7473 3d54  .mkdir(parents=T
-00033ed0: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-00033ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033f10: 6578 6973 745f 6f6b 3d54 7275 6529 0a20  exist_ok=True). 
-00033f20: 2020 2020 2020 2066 6f72 2079 616d 6c5f         for yaml_
-00033f30: 7061 7468 2069 6e20 7365 6c66 2e5f 5445  path in self._TE
-00033f40: 5354 5f59 414d 4c5f 5041 5448 533a 0a20  ST_YAML_PATHS:. 
-00033f50: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00033f60: 5f63 6865 636b 5f65 7175 6976 616c 656e  _check_equivalen
-00033f70: 7428 7961 6d6c 5f70 6174 6829 0a0a 0a23  t(yaml_path)...#
-00033f80: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374   ---------- Test
-00033f90: 696e 6720 4d75 6c74 6970 6c65 2041 6363  ing Multiple Acc
-00033fa0: 656c 6572 6174 6f72 7320 2d2d 2d2d 2d2d  elerators ------
-00033fb0: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
-00033fc0: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b20  k.no_fluidstack 
-00033fd0: 2023 2046 6c75 6964 7374 6163 6b20 646f   # Fluidstack do
-00033fe0: 6573 206e 6f74 2073 7570 706f 7274 204b  es not support K
-00033ff0: 3830 2067 7075 7320 666f 7220 6e6f 770a  80 gpus for now.
-00034000: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00034010: 7061 7065 7273 7061 6365 2020 2320 5061  paperspace  # Pa
-00034020: 7065 7273 7061 6365 2064 6f65 7320 6e6f  perspace does no
-00034030: 7420 7375 7070 6f72 7420 4b38 3020 6770  t support K80 gp
-00034040: 7573 0a64 6566 2074 6573 745f 6d75 6c74  us.def test_mult
-00034050: 6970 6c65 5f61 6363 656c 6572 6174 6f72  iple_accelerator
-00034060: 735f 6f72 6465 7265 6428 293a 0a20 2020  s_ordered():.   
-00034070: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00034080: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00034090: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-000340a0: 2020 2020 2027 6d75 6c74 6970 6c65 2d61       'multiple-a
-000340b0: 6363 656c 6572 6174 6f72 732d 6f72 6465  ccelerators-orde
-000340c0: 7265 6427 2c0a 2020 2020 2020 2020 5b0a  red',.        [.
-000340d0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000340e0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-000340f0: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
-00034100: 5f79 616d 6c73 2f74 6573 745f 6d75 6c74  _yamls/test_mult
-00034110: 6970 6c65 5f61 6363 656c 6572 6174 6f72  iple_accelerator
-00034120: 735f 6f72 6465 7265 642e 7961 6d6c 207c  s_ordered.yaml |
-00034130: 2067 7265 7020 2255 7369 6e67 2075 7365   grep "Using use
-00034140: 722d 7370 6563 6966 6965 6420 6163 6365  r-specified acce
-00034150: 6c65 7261 746f 7273 206c 6973 7422 272c  lerators list"',
-00034160: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00034170: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-00034180: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
-00034190: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
-000341a0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
-000341b0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-000341c0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-000341d0: 272c 0a20 2020 2020 2020 2074 696d 656f  ',.        timeo
-000341e0: 7574 3d32 3020 2a20 3630 2c0a 2020 2020  ut=20 * 60,.    
-000341f0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00034200: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-00034210: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
-00034220: 7374 6163 6b20 2023 2046 6c75 6964 7374  stack  # Fluidst
-00034230: 6163 6b20 6861 7320 6c6f 7720 6176 6169  ack has low avai
-00034240: 6c61 6269 6c69 7479 2066 6f72 2054 3420  lability for T4 
-00034250: 4750 5573 0a40 7079 7465 7374 2e6d 6172  GPUs.@pytest.mar
-00034260: 6b2e 6e6f 5f70 6170 6572 7370 6163 6520  k.no_paperspace 
-00034270: 2023 2050 6170 6572 7370 6163 6520 646f   # Paperspace do
-00034280: 6573 206e 6f74 2073 7570 706f 7274 2054  es not support T
-00034290: 3420 4750 5573 0a64 6566 2074 6573 745f  4 GPUs.def test_
-000342a0: 6d75 6c74 6970 6c65 5f61 6363 656c 6572  multiple_acceler
-000342b0: 6174 6f72 735f 6f72 6465 7265 645f 7769  ators_ordered_wi
-000342c0: 7468 5f64 6566 6175 6c74 2829 3a0a 2020  th_default():.  
-000342d0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-000342e0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-000342f0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00034300: 2020 2020 2020 276d 756c 7469 706c 652d        'multiple-
-00034310: 6163 6365 6c65 7261 746f 7273 2d6f 7264  accelerators-ord
-00034320: 6572 6564 272c 0a20 2020 2020 2020 205b  ered',.        [
-00034330: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00034340: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-00034350: 7b6e 616d 657d 2074 6573 7473 2f74 6573  {name} tests/tes
-00034360: 745f 7961 6d6c 732f 7465 7374 5f6d 756c  t_yamls/test_mul
-00034370: 7469 706c 655f 6163 6365 6c65 7261 746f  tiple_accelerato
-00034380: 7273 5f6f 7264 6572 6564 5f77 6974 685f  rs_ordered_with_
-00034390: 6465 6661 756c 742e 7961 6d6c 207c 2067  default.yaml | g
-000343a0: 7265 7020 2255 7369 6e67 2075 7365 722d  rep "Using user-
-000343b0: 7370 6563 6966 6965 6420 6163 6365 6c65  specified accele
-000343c0: 7261 746f 7273 206c 6973 7422 272c 0a20  rators list"',. 
-000343d0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000343e0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-000343f0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
-00034400: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
-00034410: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
-00034420: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
-00034430: 7b6e 616d 657d 207c 2067 7265 7020 5370  {name} | grep Sp
-00034440: 6f74 272c 0a20 2020 2020 2020 205d 2c0a  ot',.        ],.
-00034450: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-00034460: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-00034470: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00034480: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-00034490: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
-000344a0: 7569 6473 7461 636b 2020 2320 466c 7569  uidstack  # Flui
-000344b0: 6473 7461 636b 2068 6173 206c 6f77 2061  dstack has low a
-000344c0: 7661 696c 6162 696c 6974 7920 666f 7220  vailability for 
-000344d0: 5434 2047 5055 730a 4070 7974 6573 742e  T4 GPUs.@pytest.
-000344e0: 6d61 726b 2e6e 6f5f 7061 7065 7273 7061  mark.no_paperspa
-000344f0: 6365 2020 2320 5061 7065 7273 7061 6365  ce  # Paperspace
-00034500: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00034510: 7420 5434 2047 5055 730a 6465 6620 7465  t T4 GPUs.def te
-00034520: 7374 5f6d 756c 7469 706c 655f 6163 6365  st_multiple_acce
-00034530: 6c65 7261 746f 7273 5f75 6e6f 7264 6572  lerators_unorder
-00034540: 6564 2829 3a0a 2020 2020 6e61 6d65 203d  ed():.    name =
-00034550: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00034560: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-00034570: 5465 7374 280a 2020 2020 2020 2020 276d  Test(.        'm
-00034580: 756c 7469 706c 652d 6163 6365 6c65 7261  ultiple-accelera
-00034590: 746f 7273 2d75 6e6f 7264 6572 6564 272c  tors-unordered',
-000345a0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-000345b0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-000345c0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-000345d0: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-000345e0: 732f 7465 7374 5f6d 756c 7469 706c 655f  s/test_multiple_
-000345f0: 6163 6365 6c65 7261 746f 7273 5f75 6e6f  accelerators_uno
-00034600: 7264 6572 6564 2e79 616d 6c27 2c0a 2020  rdered.yaml',.  
-00034610: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00034620: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
-00034630: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-00034640: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
-00034650: 6564 6564 2e0a 2020 2020 2020 2020 5d2c  eded..        ],
-00034660: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-00034670: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-00034680: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00034690: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-000346a0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
-000346b0: 6c75 6964 7374 6163 6b20 2023 2046 6c75  luidstack  # Flu
-000346c0: 6964 7374 6163 6b20 6861 7320 6c6f 7720  idstack has low 
-000346d0: 6176 6169 6c61 6269 6c69 7479 2066 6f72  availability for
-000346e0: 2054 3420 4750 5573 0a40 7079 7465 7374   T4 GPUs.@pytest
-000346f0: 2e6d 6172 6b2e 6e6f 5f70 6170 6572 7370  .mark.no_papersp
-00034700: 6163 6520 2023 2050 6170 6572 7370 6163  ace  # Paperspac
-00034710: 6520 646f 6573 206e 6f74 2073 7570 706f  e does not suppo
-00034720: 7274 2054 3420 4750 5573 0a64 6566 2074  rt T4 GPUs.def t
-00034730: 6573 745f 6d75 6c74 6970 6c65 5f61 6363  est_multiple_acc
-00034740: 656c 6572 6174 6f72 735f 756e 6f72 6465  elerators_unorde
-00034750: 7265 645f 7769 7468 5f64 6566 6175 6c74  red_with_default
-00034760: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-00034770: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00034780: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-00034790: 7374 280a 2020 2020 2020 2020 276d 756c  st(.        'mul
-000347a0: 7469 706c 652d 6163 6365 6c65 7261 746f  tiple-accelerato
-000347b0: 7273 2d75 6e6f 7264 6572 6564 272c 0a20  rs-unordered',. 
-000347c0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-000347d0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-000347e0: 6820 2d79 202d 6320 7b6e 616d 657d 2074  h -y -c {name} t
-000347f0: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
-00034800: 7465 7374 5f6d 756c 7469 706c 655f 6163  test_multiple_ac
-00034810: 6365 6c65 7261 746f 7273 5f75 6e6f 7264  celerators_unord
-00034820: 6572 6564 5f77 6974 685f 6465 6661 756c  ered_with_defaul
-00034830: 742e 7961 6d6c 272c 0a20 2020 2020 2020  t.yaml',.       
-00034840: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00034850: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-00034860: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-00034870: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-00034880: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00034890: 6b79 2073 7461 7475 7320 7b6e 616d 657d  ky status {name}
-000348a0: 207c 2067 7265 7020 5370 6f74 272c 0a20   | grep Spot',. 
-000348b0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-000348c0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-000348d0: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-000348e0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-000348f0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00034900: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
-00034910: 636b 2020 2320 5265 7175 6972 6573 206f  ck  # Requires o
-00034920: 7468 6572 2063 6c6f 7564 7320 746f 2062  ther clouds to b
-00034930: 6520 656e 6162 6c65 640a 6465 6620 7465  e enabled.def te
-00034940: 7374 5f6d 756c 7469 706c 655f 7265 736f  st_multiple_reso
-00034950: 7572 6365 7328 293a 0a20 2020 206e 616d  urces():.    nam
-00034960: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00034970: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00034980: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00034990: 2027 6d75 6c74 6970 6c65 2d72 6573 6f75   'multiple-resou
-000349a0: 7263 6573 272c 0a20 2020 2020 2020 205b  rces',.        [
-000349b0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000349c0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-000349d0: 7b6e 616d 657d 2074 6573 7473 2f74 6573  {name} tests/tes
-000349e0: 745f 7961 6d6c 732f 7465 7374 5f6d 756c  t_yamls/test_mul
-000349f0: 7469 706c 655f 7265 736f 7572 6365 732e  tiple_resources.
-00034a00: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00034a10: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00034a20: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
-00034a30: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-00034a40: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-00034a50: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00034a60: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00034a70: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-00034a80: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00034a90: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-00034aa0: 2d2d 2d2d 2053 6b79 2042 656e 6368 6d61  ---- Sky Benchma
-00034ab0: 726b 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  rk ----------.@p
-00034ac0: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
-00034ad0: 7569 6473 7461 636b 2020 2320 5265 7175  uidstack  # Requ
-00034ae0: 6972 6573 206f 7468 6572 2063 6c6f 7564  ires other cloud
-00034af0: 7320 746f 2062 6520 656e 6162 6c65 640a  s to be enabled.
-00034b00: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00034b10: 7061 7065 7273 7061 6365 2020 2320 5265  paperspace  # Re
-00034b20: 7175 6972 6573 206f 7468 6572 2063 6c6f  quires other clo
-00034b30: 7564 7320 746f 2062 6520 656e 6162 6c65  uds to be enable
-00034b40: 640a 4070 7974 6573 742e 6d61 726b 2e6e  d.@pytest.mark.n
-00034b50: 6f5f 6b75 6265 726e 6574 6573 0a64 6566  o_kubernetes.def
-00034b60: 2074 6573 745f 736b 795f 6265 6e63 6828   test_sky_bench(
-00034b70: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-00034b80: 7472 293a 0a20 2020 206e 616d 6520 3d20  tr):.    name = 
-00034b90: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00034ba0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00034bb0: 6573 7428 0a20 2020 2020 2020 2027 736b  est(.        'sk
-00034bc0: 792d 6265 6e63 6827 2c0a 2020 2020 2020  y-bench',.      
-00034bd0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00034be0: 6627 736b 7920 6265 6e63 6820 6c61 756e  f'sky bench laun
-00034bf0: 6368 202d 7920 2d62 207b 6e61 6d65 7d20  ch -y -b {name} 
-00034c00: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-00034c10: 5f63 6c6f 7564 7d20 2d69 3020 7465 7374  _cloud} -i0 test
-00034c20: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
-00034c30: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
-00034c40: 2020 2020 2020 2020 2773 6c65 6570 2031          'sleep 1
-00034c50: 3230 272c 0a20 2020 2020 2020 2020 2020  20',.           
-00034c60: 2066 2773 6b79 2062 656e 6368 2073 686f   f'sky bench sho
-00034c70: 7720 7b6e 616d 657d 207c 2067 7265 7020  w {name} | grep 
-00034c80: 736b 792d 6265 6e63 682d 7b6e 616d 657d  sky-bench-{name}
-00034c90: 207c 2067 7265 7020 4649 4e49 5348 4544   | grep FINISHED
-00034ca0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-00034cb0: 2020 2020 2020 6627 736b 7920 6265 6e63        f'sky benc
-00034cc0: 6820 646f 776e 207b 6e61 6d65 7d20 2d79  h down {name} -y
-00034cd0: 3b20 736b 7920 6265 6e63 6820 6465 6c65  ; sky bench dele
-00034ce0: 7465 207b 6e61 6d65 7d20 2d79 272c 0a20  te {name} -y',. 
-00034cf0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00034d00: 5f74 6573 7428 7465 7374 290a            _test(test).
+000314a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000314b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000314c0: 2020 2020 2020 2020 2028 2775 7466 2d38           ('utf-8
+000314d0: 2729 290a 0a20 2020 2040 7079 7465 7374  '))..    @pytest
+000314e0: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
+000314f0: 6163 6b0a 2020 2020 4070 7974 6573 742e  ack.    @pytest.
+00031500: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
+00031510: 2827 696e 7661 6c69 645f 6e61 6d65 5f6c  ('invalid_name_l
+00031520: 6973 742c 2073 746f 7265 5f74 7970 6527  ist, store_type'
+00031530: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00031540: 2020 2020 2020 2020 2020 2020 2020 205b                 [
+00031550: 2841 5753 5f49 4e56 414c 4944 5f4e 414d  (AWS_INVALID_NAM
+00031560: 4553 2c20 7374 6f72 6167 655f 6c69 622e  ES, storage_lib.
+00031570: 5374 6f72 6554 7970 652e 5333 292c 0a20  StoreType.S3),. 
+00031580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031590: 2020 2020 2020 2020 2020 2020 2028 4743               (GC
+000315a0: 535f 494e 5641 4c49 445f 4e41 4d45 532c  S_INVALID_NAMES,
+000315b0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+000315c0: 7265 5479 7065 2e47 4353 292c 0a20 2020  reType.GCS),.   
+000315d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000315e0: 2020 2020 2020 2020 2020 2070 7974 6573             pytes
+000315f0: 742e 7061 7261 6d28 4942 4d5f 494e 5641  t.param(IBM_INVA
+00031600: 4c49 445f 4e41 4d45 532c 0a20 2020 2020  LID_NAMES,.     
+00031610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031630: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
+00031640: 622e 5374 6f72 6554 7970 652e 4942 4d2c  b.StoreType.IBM,
+00031650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00031660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031670: 2020 2020 2020 2020 2020 2020 6d61 726b              mark
+00031680: 733d 7079 7465 7374 2e6d 6172 6b2e 6962  s=pytest.mark.ib
+00031690: 6d29 2c0a 2020 2020 2020 2020 2020 2020  m),.            
+000316a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000316b0: 2020 7079 7465 7374 2e70 6172 616d 2841    pytest.param(A
+000316c0: 5753 5f49 4e56 414c 4944 5f4e 414d 4553  WS_INVALID_NAMES
+000316d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000316e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000316f0: 2020 2020 2020 2020 2020 2020 2073 746f               sto
+00031700: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+00031710: 7065 2e52 322c 0a20 2020 2020 2020 2020  pe.R2,.         
+00031720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031740: 2020 6d61 726b 733d 7079 7465 7374 2e6d    marks=pytest.m
+00031750: 6172 6b2e 636c 6f75 6466 6c61 7265 295d  ark.cloudflare)]
+00031760: 290a 2020 2020 6465 6620 7465 7374 5f69  ).    def test_i
+00031770: 6e76 616c 6964 5f6e 616d 6573 2873 656c  nvalid_names(sel
+00031780: 662c 2069 6e76 616c 6964 5f6e 616d 655f  f, invalid_name_
+00031790: 6c69 7374 2c20 7374 6f72 655f 7479 7065  list, store_type
+000317a0: 293a 0a20 2020 2020 2020 2023 2055 7365  ):.        # Use
+000317b0: 7320 6120 6c69 7374 2069 6e20 7468 6520  s a list in the 
+000317c0: 736f 7572 6365 2066 6965 6c64 2074 6f20  source field to 
+000317d0: 7370 6563 6966 7920 6120 6669 6c65 2061  specify a file a
+000317e0: 6e64 2061 2064 6972 6563 746f 7279 2074  nd a directory t
+000317f0: 6f0a 2020 2020 2020 2020 2320 6265 2075  o.        # be u
+00031800: 706c 6f61 6465 6420 746f 2074 6865 2073  ploaded to the s
+00031810: 746f 7261 6765 206f 626a 6563 742e 0a20  torage object.. 
+00031820: 2020 2020 2020 2066 6f72 206e 616d 6520         for name 
+00031830: 696e 2069 6e76 616c 6964 5f6e 616d 655f  in invalid_name_
+00031840: 6c69 7374 3a0a 2020 2020 2020 2020 2020  list:.          
+00031850: 2020 7769 7468 2070 7974 6573 742e 7261    with pytest.ra
+00031860: 6973 6573 2873 6b79 2e65 7863 6570 7469  ises(sky.excepti
+00031870: 6f6e 732e 5374 6f72 6167 654e 616d 6545  ons.StorageNameE
+00031880: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+00031890: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
+000318a0: 626a 203d 2073 746f 7261 6765 5f6c 6962  bj = storage_lib
+000318b0: 2e53 746f 7261 6765 286e 616d 653d 6e61  .Storage(name=na
+000318c0: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
+000318d0: 2020 2020 7374 6f72 6167 655f 6f62 6a2e      storage_obj.
+000318e0: 6164 645f 7374 6f72 6528 7374 6f72 655f  add_store(store_
+000318f0: 7479 7065 290a 0a20 2020 2040 7079 7465  type)..    @pyte
+00031900: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
+00031910: 7374 6163 6b0a 2020 2020 4070 7974 6573  stack.    @pytes
+00031920: 742e 6d61 726b 2e70 6172 616d 6574 7269  t.mark.parametri
+00031930: 7a65 280a 2020 2020 2020 2020 2767 6974  ze(.        'git
+00031940: 6967 6e6f 7265 5f73 7472 7563 7475 7265  ignore_structure
+00031950: 2c20 7374 6f72 655f 7479 7065 272c 0a20  , store_type',. 
+00031960: 2020 2020 2020 205b 2847 4954 4947 4e4f         [(GITIGNO
+00031970: 5245 5f53 594e 435f 5445 5354 5f44 4952  RE_SYNC_TEST_DIR
+00031980: 5f53 5452 5543 5455 5245 2c20 7374 6f72  _STRUCTURE, stor
+00031990: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+000319a0: 652e 5333 292c 0a20 2020 2020 2020 2020  e.S3),.         
+000319b0: 2847 4954 4947 4e4f 5245 5f53 594e 435f  (GITIGNORE_SYNC_
+000319c0: 5445 5354 5f44 4952 5f53 5452 5543 5455  TEST_DIR_STRUCTU
+000319d0: 5245 2c20 7374 6f72 6167 655f 6c69 622e  RE, storage_lib.
+000319e0: 5374 6f72 6554 7970 652e 4743 5329 2c0a  StoreType.GCS),.
+000319f0: 2020 2020 2020 2020 2070 7974 6573 742e           pytest.
+00031a00: 7061 7261 6d28 4749 5449 474e 4f52 455f  param(GITIGNORE_
+00031a10: 5359 4e43 5f54 4553 545f 4449 525f 5354  SYNC_TEST_DIR_ST
+00031a20: 5255 4354 5552 452c 0a20 2020 2020 2020  RUCTURE,.       
+00031a30: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00031a40: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+00031a50: 5479 7065 2e52 322c 0a20 2020 2020 2020  Type.R2,.       
+00031a60: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00031a70: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
+00031a80: 2e63 6c6f 7564 666c 6172 6529 5d29 0a20  .cloudflare)]). 
+00031a90: 2020 2064 6566 2074 6573 745f 6578 636c     def test_excl
+00031aa0: 7564 6564 5f66 696c 655f 636c 6f75 645f  uded_file_cloud_
+00031ab0: 7374 6f72 6167 655f 7570 6c6f 6164 5f63  storage_upload_c
+00031ac0: 6f70 7928 7365 6c66 2c20 6769 7469 676e  opy(self, gitign
+00031ad0: 6f72 655f 7374 7275 6374 7572 652c 0a20  ore_structure,. 
+00031ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031b10: 2020 2020 7374 6f72 655f 7479 7065 2c0a      store_type,.
+00031b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031b50: 2020 2020 2074 6d70 5f67 6974 6967 6e6f       tmp_gitigno
+00031b60: 7265 5f73 746f 7261 6765 5f6f 626a 293a  re_storage_obj):
+00031b70: 0a20 2020 2020 2020 2023 2074 6573 7473  .        # tests
+00031b80: 2069 6620 6669 6c65 7320 696e 636c 7564   if files includ
+00031b90: 6564 2069 6e20 2e67 6974 6967 6e6f 7265  ed in .gitignore
+00031ba0: 2061 6e64 202e 6769 742f 696e 666f 2f65   and .git/info/e
+00031bb0: 7863 6c75 6465 2061 7265 0a20 2020 2020  xclude are.     
+00031bc0: 2020 2023 2065 7863 6c75 6465 6420 6672     # excluded fr
+00031bd0: 6f6d 2062 6569 6e67 2074 7261 6e73 6665  om being transfe
+00031be0: 7272 6564 2074 6f20 5374 6f72 6167 650a  rred to Storage.
+00031bf0: 0a20 2020 2020 2020 2074 6d70 5f67 6974  .        tmp_git
+00031c00: 6967 6e6f 7265 5f73 746f 7261 6765 5f6f  ignore_storage_o
+00031c10: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
+00031c20: 7265 5f74 7970 6529 0a0a 2020 2020 2020  re_type)..      
+00031c30: 2020 7570 6c6f 6164 5f66 696c 655f 6e61    upload_file_na
+00031c40: 6d65 203d 2027 696e 636c 7564 6564 270a  me = 'included'.
+00031c50: 2020 2020 2020 2020 2320 436f 756e 7420          # Count 
+00031c60: 7468 6520 6e75 6d62 6572 206f 6620 6669  the number of fi
+00031c70: 6c65 7320 7769 7468 2074 6865 2067 6976  les with the giv
+00031c80: 656e 2066 696c 6520 6e61 6d65 0a20 2020  en file name.   
+00031c90: 2020 2020 2075 705f 636d 6420 3d20 7365       up_cmd = se
+00031ca0: 6c66 2e63 6c69 5f63 6f75 6e74 5f6e 616d  lf.cli_count_nam
+00031cb0: 655f 696e 5f62 7563 6b65 7428 7374 6f72  e_in_bucket(stor
+00031cc0: 655f 7479 7065 2c20 5c0a 2020 2020 2020  e_type, \.      
+00031cd0: 2020 2020 2020 746d 705f 6769 7469 676e        tmp_gitign
+00031ce0: 6f72 655f 7374 6f72 6167 655f 6f62 6a2e  ore_storage_obj.
+00031cf0: 6e61 6d65 2c20 6669 6c65 5f6e 616d 653d  name, file_name=
+00031d00: 7570 6c6f 6164 5f66 696c 655f 6e61 6d65  upload_file_name
+00031d10: 290a 2020 2020 2020 2020 6769 745f 6578  ).        git_ex
+00031d20: 636c 7564 655f 636d 6420 3d20 7365 6c66  clude_cmd = self
+00031d30: 2e63 6c69 5f63 6f75 6e74 5f6e 616d 655f  .cli_count_name_
+00031d40: 696e 5f62 7563 6b65 7428 7374 6f72 655f  in_bucket(store_
+00031d50: 7479 7065 2c20 5c0a 2020 2020 2020 2020  type, \.        
+00031d60: 2020 2020 746d 705f 6769 7469 676e 6f72      tmp_gitignor
+00031d70: 655f 7374 6f72 6167 655f 6f62 6a2e 6e61  e_storage_obj.na
+00031d80: 6d65 2c20 6669 6c65 5f6e 616d 653d 272e  me, file_name='.
+00031d90: 6769 7427 290a 2020 2020 2020 2020 636e  git').        cn
+00031da0: 745f 6e75 6d5f 6669 6c65 5f63 6d64 203d  t_num_file_cmd =
+00031db0: 2073 656c 662e 636c 695f 636f 756e 745f   self.cli_count_
+00031dc0: 6669 6c65 5f69 6e5f 6275 636b 6574 280a  file_in_bucket(.
+00031dd0: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+00031de0: 655f 7479 7065 2c20 746d 705f 6769 7469  e_type, tmp_giti
+00031df0: 676e 6f72 655f 7374 6f72 6167 655f 6f62  gnore_storage_ob
+00031e00: 6a2e 6e61 6d65 290a 0a20 2020 2020 2020  j.name)..       
+00031e10: 2075 705f 6f75 7470 7574 203d 2073 7562   up_output = sub
+00031e20: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
+00031e30: 7470 7574 2875 705f 636d 642c 2073 6865  tput(up_cmd, she
+00031e40: 6c6c 3d54 7275 6529 0a20 2020 2020 2020  ll=True).       
+00031e50: 2067 6974 5f65 7863 6c75 6465 5f6f 7574   git_exclude_out
+00031e60: 7075 7420 3d20 7375 6270 726f 6365 7373  put = subprocess
+00031e70: 2e63 6865 636b 5f6f 7574 7075 7428 6769  .check_output(gi
+00031e80: 745f 6578 636c 7564 655f 636d 642c 0a20  t_exclude_cmd,. 
+00031e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031ec0: 2020 2020 7368 656c 6c3d 5472 7565 290a      shell=True).
+00031ed0: 2020 2020 2020 2020 636e 745f 6f75 7470          cnt_outp
+00031ee0: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
+00031ef0: 6368 6563 6b5f 6f75 7470 7574 2863 6e74  check_output(cnt
+00031f00: 5f6e 756d 5f66 696c 655f 636d 642c 2073  _num_file_cmd, s
+00031f10: 6865 6c6c 3d54 7275 6529 0a0a 2020 2020  hell=True)..    
+00031f20: 2020 2020 6173 7365 7274 2027 3327 2069      assert '3' i
+00031f30: 6e20 7570 5f6f 7574 7075 742e 6465 636f  n up_output.deco
+00031f40: 6465 2827 7574 662d 3827 292c 205c 0a20  de('utf-8'), \. 
+00031f50: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00031f60: 4669 6c65 7320 746f 2062 6520 696e 636c  Files to be incl
+00031f70: 7564 6564 2061 7265 206e 6f74 2063 6f6d  uded are not com
+00031f80: 706c 6574 656c 7920 7570 6c6f 6164 6564  pletely uploaded
+00031f90: 2e27 0a20 2020 2020 2020 2023 2031 2069  .'.        # 1 i
+00031fa0: 7320 7265 6164 2061 7320 2e67 6974 6967  s read as .gitig
+00031fb0: 6e6f 7265 2069 7320 7570 6c6f 6164 6564  nore is uploaded
+00031fc0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00031fd0: 2731 2720 696e 2067 6974 5f65 7863 6c75  '1' in git_exclu
+00031fe0: 6465 5f6f 7574 7075 742e 6465 636f 6465  de_output.decode
+00031ff0: 2827 7574 662d 3827 292c 205c 0a20 2020  ('utf-8'), \.   
+00032000: 2020 2020 2020 2020 2020 2020 272e 6769              '.gi
+00032010: 7420 6469 7265 6374 6f72 7920 7368 6f75  t directory shou
+00032020: 6c64 206e 6f74 2062 6520 7570 6c6f 6164  ld not be upload
+00032030: 6564 2e27 0a20 2020 2020 2020 2023 2034  ed.'.        # 4
+00032040: 2066 696c 6573 2069 6e63 6c75 6465 202e   files include .
+00032050: 6769 7469 676e 6f72 652c 2069 6e63 6c75  gitignore, inclu
+00032060: 6465 642e 6c6f 672c 2069 6e63 6c75 6465  ded.log, include
+00032070: 642e 7478 742c 2069 6e63 6c75 6465 5f64  d.txt, include_d
+00032080: 6972 2f69 6e63 6c75 6465 642e 6c6f 670a  ir/included.log.
+00032090: 2020 2020 2020 2020 6173 7365 7274 2027          assert '
+000320a0: 3427 2069 6e20 636e 745f 6f75 7470 7574  4' in cnt_output
+000320b0: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+000320c0: 2c20 5c0a 2020 2020 2020 2020 2020 2020  , \.            
+000320d0: 2020 2027 536f 6d65 2069 7465 6d73 206c     'Some items l
+000320e0: 6973 7465 6420 696e 202e 6769 7469 676e  isted in .gitign
+000320f0: 6f72 6520 616e 6420 2e67 6974 2f69 6e66  ore and .git/inf
+00032100: 6f2f 6578 636c 7564 6520 6172 6520 6e6f  o/exclude are no
+00032110: 7420 6578 636c 7564 6564 2e27 0a0a 2020  t excluded.'..  
+00032120: 2020 4070 7974 6573 742e 6d61 726b 2e70    @pytest.mark.p
+00032130: 6172 616d 6574 7269 7a65 2827 6578 745f  arametrize('ext_
+00032140: 6275 636b 6574 5f66 6978 7475 7265 2c20  bucket_fixture, 
+00032150: 7374 6f72 655f 7479 7065 272c 0a20 2020  store_type',.   
+00032160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032170: 2020 2020 2020 2020 2020 5b28 2774 6d70            [('tmp
+00032180: 5f61 7773 636c 695f 6275 636b 6574 272c  _awscli_bucket',
+00032190: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+000321a0: 7265 5479 7065 2e53 3329 2c0a 2020 2020  reType.S3),.    
+000321b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000321c0: 2020 2020 2020 2020 2020 2827 746d 705f            ('tmp_
+000321d0: 6773 7574 696c 5f62 7563 6b65 7427 2c20  gsutil_bucket', 
+000321e0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+000321f0: 6554 7970 652e 4743 5329 2c0a 2020 2020  eType.GCS),.    
+00032200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032210: 2020 2020 2020 2020 2020 7079 7465 7374            pytest
+00032220: 2e70 6172 616d 2827 746d 705f 6177 7363  .param('tmp_awsc
+00032230: 6c69 5f62 7563 6b65 745f 7232 272c 0a20  li_bucket_r2',. 
+00032240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032260: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+00032270: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+00032280: 5232 2c0a 2020 2020 2020 2020 2020 2020  R2,.            
+00032290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000322a0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+000322b0: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
+000322c0: 2e63 6c6f 7564 666c 6172 6529 5d29 0a20  .cloudflare)]). 
+000322d0: 2020 2064 6566 2074 6573 745f 6578 7465     def test_exte
+000322e0: 726e 616c 6c79 5f63 7265 6174 6564 5f62  rnally_created_b
+000322f0: 7563 6b65 745f 6d6f 756e 745f 7769 7468  ucket_mount_with
+00032300: 6f75 745f 736f 7572 6365 280a 2020 2020  out_source(.    
+00032310: 2020 2020 2020 2020 7365 6c66 2c20 6578          self, ex
+00032320: 745f 6275 636b 6574 5f66 6978 7475 7265  t_bucket_fixture
+00032330: 2c20 7265 7175 6573 742c 2073 746f 7265  , request, store
+00032340: 5f74 7970 6529 3a0a 2020 2020 2020 2020  _type):.        
+00032350: 2320 4e6f 6e2d 736b 7920 6d61 6e61 6765  # Non-sky manage
+00032360: 6420 6275 636b 6574 7328 6275 636b 6574  d buckets(bucket
+00032370: 7320 6372 6561 7465 6420 6f75 7473 6964  s created outsid
+00032380: 6520 6f66 2053 6b79 7069 6c6f 7420 434c  e of Skypilot CL
+00032390: 4929 0a20 2020 2020 2020 2023 2061 7265  I).        # are
+000323a0: 2061 6c6c 6f77 6564 2074 6f20 6265 204d   allowed to be M
+000323b0: 4f55 4e54 6564 2062 7920 7370 6563 6966  OUNTed by specif
+000323c0: 7969 6e67 2074 6865 2055 5249 206f 6620  ying the URI of 
+000323d0: 7468 6520 6275 636b 6574 2074 6f0a 2020  the bucket to.  
+000323e0: 2020 2020 2020 2320 736f 7572 6365 2066        # source f
+000323f0: 6965 6c64 206f 6e6c 792e 2057 6865 6e20  ield only. When 
+00032400: 6974 2069 7320 6174 7465 6d70 7465 6420  it is attempted 
+00032410: 6279 2073 7065 6369 6679 696e 6720 7468  by specifying th
+00032420: 6520 6e61 6d65 206f 660a 2020 2020 2020  e name of.      
+00032430: 2020 2320 7468 6520 6275 636b 6574 206f    # the bucket o
+00032440: 6e6c 792c 2069 7420 7368 6f75 6c64 2065  nly, it should e
+00032450: 7272 6f72 206f 7574 2e0a 2020 2020 2020  rror out..      
+00032460: 2020 230a 2020 2020 2020 2020 2320 544f    #.        # TO
+00032470: 444f 2864 6f79 6f75 6e67 293a 2041 6464  DO(doyoung): Add
+00032480: 2074 6573 7420 666f 7220 4942 4d20 434f   test for IBM CO
+00032490: 532e 2043 7572 7265 6e74 6c79 2c20 7468  S. Currently, th
+000324a0: 6973 2069 7320 626c 6f63 6b65 640a 2020  is is blocked.  
+000324b0: 2020 2020 2020 2320 6173 2072 636c 6f6e        # as rclon
+000324c0: 6520 7573 6564 2074 6f20 696e 7465 7261  e used to intera
+000324d0: 6374 2077 6974 6820 4942 4d20 434f 5320  ct with IBM COS 
+000324e0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+000324f0: 2066 6561 7475 7265 2074 6f0a 2020 2020   feature to.    
+00032500: 2020 2020 2320 6372 6561 7465 2061 2062      # create a b
+00032510: 7563 6b65 742c 2061 6e64 2074 6865 2069  ucket, and the i
+00032520: 626d 636c 6f75 6420 434c 4920 6973 206e  bmcloud CLI is n
+00032530: 6f74 2073 7570 706f 7274 6564 2069 6e20  ot supported in 
+00032540: 536b 7970 696c 6f74 2e0a 2020 2020 2020  Skypilot..      
+00032550: 2020 2320 4569 7468 6572 206f 6620 7468    # Either of th
+00032560: 6520 6665 6174 7572 6520 6973 206e 6563  e feature is nec
+00032570: 6573 7361 7279 2074 6f20 7369 6d75 6c61  essary to simula
+00032580: 7465 2061 6e20 6578 7465 726e 616c 2062  te an external b
+00032590: 7563 6b65 740a 2020 2020 2020 2020 2320  ucket.        # 
+000325a0: 6372 6561 7469 6f6e 2066 6f72 2049 424d  creation for IBM
+000325b0: 2043 4f53 2e0a 2020 2020 2020 2020 2320   COS..        # 
+000325c0: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
+000325d0: 6f6d 2f73 6b79 7069 6c6f 742d 6f72 672f  om/skypilot-org/
+000325e0: 736b 7970 696c 6f74 2f70 756c 6c2f 3139  skypilot/pull/19
+000325f0: 3636 2f66 696c 6573 2372 3132 3533 3433  66/files#r125343
+00032600: 3938 3337 0a0a 2020 2020 2020 2020 6578  9837..        ex
+00032610: 745f 6275 636b 6574 5f6e 616d 652c 2065  t_bucket_name, e
+00032620: 7874 5f62 7563 6b65 745f 7572 6920 3d20  xt_bucket_uri = 
+00032630: 7265 7175 6573 742e 6765 7466 6978 7475  request.getfixtu
+00032640: 7265 7661 6c75 6528 0a20 2020 2020 2020  revalue(.       
+00032650: 2020 2020 2065 7874 5f62 7563 6b65 745f       ext_bucket_
+00032660: 6669 7874 7572 6529 0a20 2020 2020 2020  fixture).       
+00032670: 2023 2069 6e76 616c 6964 2073 7065 630a   # invalid spec.
+00032680: 2020 2020 2020 2020 7769 7468 2070 7974          with pyt
+00032690: 6573 742e 7261 6973 6573 2873 6b79 2e65  est.raises(sky.e
+000326a0: 7863 6570 7469 6f6e 732e 5374 6f72 6167  xceptions.Storag
+000326b0: 6553 7065 6345 7272 6f72 2920 6173 2065  eSpecError) as e
+000326c0: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
+000326d0: 6f72 6167 655f 6f62 6a20 3d20 7374 6f72  orage_obj = stor
+000326e0: 6167 655f 6c69 622e 5374 6f72 6167 6528  age_lib.Storage(
+000326f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00032700: 206e 616d 653d 6578 745f 6275 636b 6574   name=ext_bucket
+00032710: 5f6e 616d 652c 206d 6f64 653d 7374 6f72  _name, mode=stor
+00032720: 6167 655f 6c69 622e 5374 6f72 6167 654d  age_lib.StorageM
+00032730: 6f64 652e 4d4f 554e 5429 0a20 2020 2020  ode.MOUNT).     
+00032740: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
+00032750: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
+00032760: 7265 5f74 7970 6529 0a0a 2020 2020 2020  re_type)..      
+00032770: 2020 6173 7365 7274 2027 4174 7465 6d70    assert 'Attemp
+00032780: 7465 6420 746f 206d 6f75 6e74 2061 206e  ted to mount a n
+00032790: 6f6e 2d73 6b79 206d 616e 6167 6564 2062  on-sky managed b
+000327a0: 7563 6b65 7427 2069 6e20 7374 7228 6529  ucket' in str(e)
+000327b0: 0a0a 2020 2020 2020 2020 2320 7661 6c69  ..        # vali
+000327c0: 6420 7370 6563 0a20 2020 2020 2020 2073  d spec.        s
+000327d0: 746f 7261 6765 5f6f 626a 203d 2073 746f  torage_obj = sto
+000327e0: 7261 6765 5f6c 6962 2e53 746f 7261 6765  rage_lib.Storage
+000327f0: 2873 6f75 7263 653d 6578 745f 6275 636b  (source=ext_buck
+00032800: 6574 5f75 7269 2c0a 2020 2020 2020 2020  et_uri,.        
+00032810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032830: 2020 6d6f 6465 3d73 746f 7261 6765 5f6c    mode=storage_l
+00032840: 6962 2e53 746f 7261 6765 4d6f 6465 2e4d  ib.StorageMode.M
+00032850: 4f55 4e54 290a 2020 2020 2020 2020 6861  OUNT).        ha
+00032860: 6e64 6c65 203d 2067 6c6f 6261 6c5f 7573  ndle = global_us
+00032870: 6572 5f73 7461 7465 2e67 6574 5f68 616e  er_state.get_han
+00032880: 646c 655f 6672 6f6d 5f73 746f 7261 6765  dle_from_storage
+00032890: 5f6e 616d 6528 0a20 2020 2020 2020 2020  _name(.         
+000328a0: 2020 2073 746f 7261 6765 5f6f 626a 2e6e     storage_obj.n
+000328b0: 616d 6529 0a20 2020 2020 2020 2069 6620  ame).        if 
+000328c0: 6861 6e64 6c65 3a0a 2020 2020 2020 2020  handle:.        
+000328d0: 2020 2020 7374 6f72 6167 655f 6f62 6a2e      storage_obj.
+000328e0: 6465 6c65 7465 2829 0a0a 2020 2020 4070  delete()..    @p
+000328f0: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
+00032900: 7569 6473 7461 636b 0a20 2020 2040 7079  uidstack.    @py
+00032910: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
+00032920: 7472 697a 6528 2772 6567 696f 6e27 2c20  trize('region', 
+00032930: 5b0a 2020 2020 2020 2020 2761 702d 6e6f  [.        'ap-no
+00032940: 7274 6865 6173 742d 3127 2c20 2761 702d  rtheast-1', 'ap-
+00032950: 6e6f 7274 6865 6173 742d 3227 2c20 2761  northeast-2', 'a
+00032960: 702d 6e6f 7274 6865 6173 742d 3327 2c20  p-northeast-3', 
+00032970: 2761 702d 736f 7574 682d 3127 2c0a 2020  'ap-south-1',.  
+00032980: 2020 2020 2020 2761 702d 736f 7574 6865        'ap-southe
+00032990: 6173 742d 3127 2c20 2761 702d 736f 7574  ast-1', 'ap-sout
+000329a0: 6865 6173 742d 3227 2c20 2765 752d 6365  heast-2', 'eu-ce
+000329b0: 6e74 7261 6c2d 3127 2c20 2765 752d 6e6f  ntral-1', 'eu-no
+000329c0: 7274 682d 3127 2c0a 2020 2020 2020 2020  rth-1',.        
+000329d0: 2765 752d 7765 7374 2d31 272c 2027 6575  'eu-west-1', 'eu
+000329e0: 2d77 6573 742d 3227 2c20 2765 752d 7765  -west-2', 'eu-we
+000329f0: 7374 2d33 272c 2027 7361 2d65 6173 742d  st-3', 'sa-east-
+00032a00: 3127 2c20 2775 732d 6561 7374 2d31 272c  1', 'us-east-1',
+00032a10: 0a20 2020 2020 2020 2027 7573 2d65 6173  .        'us-eas
+00032a20: 742d 3227 2c20 2775 732d 7765 7374 2d31  t-2', 'us-west-1
+00032a30: 272c 2027 7573 2d77 6573 742d 3227 0a20  ', 'us-west-2'. 
+00032a40: 2020 205d 290a 2020 2020 6465 6620 7465     ]).    def te
+00032a50: 7374 5f61 7773 5f72 6567 696f 6e73 2873  st_aws_regions(s
+00032a60: 656c 662c 2074 6d70 5f6c 6f63 616c 5f73  elf, tmp_local_s
+00032a70: 746f 7261 6765 5f6f 626a 2c20 7265 6769  torage_obj, regi
+00032a80: 6f6e 293a 0a20 2020 2020 2020 2023 2054  on):.        # T
+00032a90: 6869 7320 7465 7374 7320 6372 6561 7469  his tests creati
+00032aa0: 6f6e 2061 6e64 2075 706c 6f61 6420 746f  on and upload to
+00032ab0: 2062 7563 6b65 7420 696e 2061 6c6c 2041   bucket in all A
+00032ac0: 5753 2073 3320 7265 6769 6f6e 730a 2020  WS s3 regions.  
+00032ad0: 2020 2020 2020 2320 546f 2074 6573 7420        # To test 
+00032ae0: 6675 6c6c 2066 756e 6374 696f 6e61 6c69  full functionali
+00032af0: 7479 2c20 7573 6520 7465 7374 5f6d 616e  ty, use test_man
+00032b00: 6167 6564 5f6a 6f62 735f 7374 6f72 6167  aged_jobs_storag
+00032b10: 6520 6162 6f76 652e 0a20 2020 2020 2020  e above..       
+00032b20: 2073 746f 7265 5f74 7970 6520 3d20 7374   store_type = st
+00032b30: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+00032b40: 7970 652e 5333 0a20 2020 2020 2020 2074  ype.S3.        t
+00032b50: 6d70 5f6c 6f63 616c 5f73 746f 7261 6765  mp_local_storage
+00032b60: 5f6f 626a 2e61 6464 5f73 746f 7265 2873  _obj.add_store(s
+00032b70: 746f 7265 5f74 7970 652c 2072 6567 696f  tore_type, regio
+00032b80: 6e3d 7265 6769 6f6e 290a 2020 2020 2020  n=region).      
+00032b90: 2020 6275 636b 6574 5f6e 616d 6520 3d20    bucket_name = 
+00032ba0: 746d 705f 6c6f 6361 6c5f 7374 6f72 6167  tmp_local_storag
+00032bb0: 655f 6f62 6a2e 6e61 6d65 0a0a 2020 2020  e_obj.name..    
+00032bc0: 2020 2020 2320 436f 6e66 6972 6d20 7468      # Confirm th
+00032bd0: 6174 2074 6865 2062 7563 6b65 7420 7761  at the bucket wa
+00032be0: 7320 6372 6561 7465 6420 696e 2074 6865  s created in the
+00032bf0: 2063 6f72 7265 6374 2072 6567 696f 6e0a   correct region.
+00032c00: 2020 2020 2020 2020 7265 6769 6f6e 5f63          region_c
+00032c10: 6d64 203d 2073 656c 662e 636c 695f 7265  md = self.cli_re
+00032c20: 6769 6f6e 5f63 6d64 2873 746f 7265 5f74  gion_cmd(store_t
+00032c30: 7970 652c 2062 7563 6b65 745f 6e61 6d65  ype, bucket_name
+00032c40: 290a 2020 2020 2020 2020 6f75 7420 3d20  ).        out = 
+00032c50: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+00032c60: 5f6f 7574 7075 7428 7265 6769 6f6e 5f63  _output(region_c
+00032c70: 6d64 2c20 7368 656c 6c3d 5472 7565 290a  md, shell=True).
+00032c80: 2020 2020 2020 2020 6f75 7470 7574 203d          output =
+00032c90: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
+00032ca0: 2d38 2729 0a20 2020 2020 2020 2065 7870  -8').        exp
+00032cb0: 6563 7465 645f 6f75 7470 7574 5f72 6567  ected_output_reg
+00032cc0: 696f 6e20 3d20 7265 6769 6f6e 0a20 2020  ion = region.   
+00032cd0: 2020 2020 2069 6620 7265 6769 6f6e 203d       if region =
+00032ce0: 3d20 2775 732d 6561 7374 2d31 273a 0a20  = 'us-east-1':. 
+00032cf0: 2020 2020 2020 2020 2020 2065 7870 6563             expec
+00032d00: 7465 645f 6f75 7470 7574 5f72 6567 696f  ted_output_regio
+00032d10: 6e20 3d20 274e 6f6e 6527 2020 2320 7573  n = 'None'  # us
+00032d20: 2d65 6173 742d 3120 6973 2074 6865 2064  -east-1 is the d
+00032d30: 6566 6175 6c74 2072 6567 696f 6e0a 2020  efault region.  
+00032d40: 2020 2020 2020 6173 7365 7274 2065 7870        assert exp
+00032d50: 6563 7465 645f 6f75 7470 7574 5f72 6567  ected_output_reg
+00032d60: 696f 6e20 696e 206f 7574 2e64 6563 6f64  ion in out.decod
+00032d70: 6528 2775 7466 2d38 2729 2c20 280a 2020  e('utf-8'), (.  
+00032d80: 2020 2020 2020 2020 2020 6627 4275 636b            f'Buck
+00032d90: 6574 2077 6173 206e 6f74 2066 6f75 6e64  et was not found
+00032da0: 2069 6e20 7265 6769 6f6e 207b 7265 6769   in region {regi
+00032db0: 6f6e 7d20 2d20 270a 2020 2020 2020 2020  on} - '.        
+00032dc0: 2020 2020 6627 6f75 7470 7574 206f 6620      f'output of 
+00032dd0: 7b72 6567 696f 6e5f 636d 647d 2077 6173  {region_cmd} was
+00032de0: 3a20 7b6f 7574 7075 747d 2729 0a0a 2020  : {output}')..  
+00032df0: 2020 2020 2020 2320 4368 6563 6b20 6966        # Check if
+00032e00: 2074 6d70 5f73 6f75 7263 652f 746d 702d   tmp_source/tmp-
+00032e10: 6669 6c65 2065 7869 7374 7320 696e 2074  file exists in t
+00032e20: 6865 2062 7563 6b65 7420 7573 696e 6720  he bucket using 
+00032e30: 636c 690a 2020 2020 2020 2020 6c73 5f63  cli.        ls_c
+00032e40: 6d64 203d 2073 656c 662e 636c 695f 6c73  md = self.cli_ls
+00032e50: 5f63 6d64 2873 746f 7265 5f74 7970 652c  _cmd(store_type,
+00032e60: 2062 7563 6b65 745f 6e61 6d65 290a 2020   bucket_name).  
+00032e70: 2020 2020 2020 6f75 7420 3d20 7375 6270        out = subp
+00032e80: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+00032e90: 7075 7428 6c73 5f63 6d64 2c20 7368 656c  put(ls_cmd, shel
+00032ea0: 6c3d 5472 7565 290a 2020 2020 2020 2020  l=True).        
+00032eb0: 6f75 7470 7574 203d 206f 7574 2e64 6563  output = out.dec
+00032ec0: 6f64 6528 2775 7466 2d38 2729 0a20 2020  ode('utf-8').   
+00032ed0: 2020 2020 2061 7373 6572 7420 2774 6d70       assert 'tmp
+00032ee0: 2d66 696c 6527 2069 6e20 6f75 7470 7574  -file' in output
+00032ef0: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
+00032f00: 6627 746d 702d 6669 6c65 206e 6f74 2066  f'tmp-file not f
+00032f10: 6f75 6e64 2069 6e20 6275 636b 6574 202d  ound in bucket -
+00032f20: 206f 7574 7075 7420 6f66 207b 6c73 5f63   output of {ls_c
+00032f30: 6d64 7d20 7761 733a 207b 6f75 7470 7574  md} was: {output
+00032f40: 7d27 290a 0a20 2020 2040 7079 7465 7374  }')..    @pytest
+00032f50: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
+00032f60: 6163 6b0a 2020 2020 4070 7974 6573 742e  ack.    @pytest.
+00032f70: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
+00032f80: 2827 7265 6769 6f6e 272c 205b 0a20 2020  ('region', [.   
+00032f90: 2020 2020 2027 6e6f 7274 6861 6d65 7269       'northameri
+00032fa0: 6361 2d6e 6f72 7468 6561 7374 3127 2c20  ca-northeast1', 
+00032fb0: 276e 6f72 7468 616d 6572 6963 612d 6e6f  'northamerica-no
+00032fc0: 7274 6865 6173 7432 272c 2027 7573 2d63  rtheast2', 'us-c
+00032fd0: 656e 7472 616c 3127 2c0a 2020 2020 2020  entral1',.      
+00032fe0: 2020 2775 732d 6561 7374 3127 2c20 2775    'us-east1', 'u
+00032ff0: 732d 6561 7374 3427 2c20 2775 732d 6561  s-east4', 'us-ea
+00033000: 7374 3527 2c20 2775 732d 736f 7574 6831  st5', 'us-south1
+00033010: 272c 2027 7573 2d77 6573 7431 272c 2027  ', 'us-west1', '
+00033020: 7573 2d77 6573 7432 272c 0a20 2020 2020  us-west2',.     
+00033030: 2020 2027 7573 2d77 6573 7433 272c 2027     'us-west3', '
+00033040: 7573 2d77 6573 7434 272c 2027 736f 7574  us-west4', 'sout
+00033050: 6861 6d65 7269 6361 2d65 6173 7431 272c  hamerica-east1',
+00033060: 2027 736f 7574 6861 6d65 7269 6361 2d77   'southamerica-w
+00033070: 6573 7431 272c 0a20 2020 2020 2020 2027  est1',.        '
+00033080: 6575 726f 7065 2d63 656e 7472 616c 3227  europe-central2'
+00033090: 2c20 2765 7572 6f70 652d 6e6f 7274 6831  , 'europe-north1
+000330a0: 272c 2027 6575 726f 7065 2d73 6f75 7468  ', 'europe-south
+000330b0: 7765 7374 3127 2c20 2765 7572 6f70 652d  west1', 'europe-
+000330c0: 7765 7374 3127 2c0a 2020 2020 2020 2020  west1',.        
+000330d0: 2765 7572 6f70 652d 7765 7374 3227 2c20  'europe-west2', 
+000330e0: 2765 7572 6f70 652d 7765 7374 3327 2c20  'europe-west3', 
+000330f0: 2765 7572 6f70 652d 7765 7374 3427 2c20  'europe-west4', 
+00033100: 2765 7572 6f70 652d 7765 7374 3627 2c0a  'europe-west6',.
+00033110: 2020 2020 2020 2020 2765 7572 6f70 652d          'europe-
+00033120: 7765 7374 3827 2c20 2765 7572 6f70 652d  west8', 'europe-
+00033130: 7765 7374 3927 2c20 2765 7572 6f70 652d  west9', 'europe-
+00033140: 7765 7374 3130 272c 2027 6575 726f 7065  west10', 'europe
+00033150: 2d77 6573 7431 3227 2c0a 2020 2020 2020  -west12',.      
+00033160: 2020 2761 7369 612d 6561 7374 3127 2c20    'asia-east1', 
+00033170: 2761 7369 612d 6561 7374 3227 2c20 2761  'asia-east2', 'a
+00033180: 7369 612d 6e6f 7274 6865 6173 7431 272c  sia-northeast1',
+00033190: 2027 6173 6961 2d6e 6f72 7468 6561 7374   'asia-northeast
+000331a0: 3227 2c0a 2020 2020 2020 2020 2761 7369  2',.        'asi
+000331b0: 612d 6e6f 7274 6865 6173 7433 272c 2027  a-northeast3', '
+000331c0: 6173 6961 2d73 6f75 7468 6561 7374 3127  asia-southeast1'
+000331d0: 2c20 2761 7369 612d 736f 7574 6831 272c  , 'asia-south1',
+000331e0: 2027 6173 6961 2d73 6f75 7468 3227 2c0a   'asia-south2',.
+000331f0: 2020 2020 2020 2020 2761 7369 612d 736f          'asia-so
+00033200: 7574 6865 6173 7432 272c 2027 6d65 2d63  utheast2', 'me-c
+00033210: 656e 7472 616c 3127 2c20 276d 652d 6365  entral1', 'me-ce
+00033220: 6e74 7261 6c32 272c 2027 6d65 2d77 6573  ntral2', 'me-wes
+00033230: 7431 272c 0a20 2020 2020 2020 2027 6175  t1',.        'au
+00033240: 7374 7261 6c69 612d 736f 7574 6865 6173  stralia-southeas
+00033250: 7431 272c 2027 6175 7374 7261 6c69 612d  t1', 'australia-
+00033260: 736f 7574 6865 6173 7432 272c 2027 6166  southeast2', 'af
+00033270: 7269 6361 2d73 6f75 7468 3127 0a20 2020  rica-south1'.   
+00033280: 205d 290a 2020 2020 6465 6620 7465 7374   ]).    def test
+00033290: 5f67 6373 5f72 6567 696f 6e73 2873 656c  _gcs_regions(sel
+000332a0: 662c 2074 6d70 5f6c 6f63 616c 5f73 746f  f, tmp_local_sto
+000332b0: 7261 6765 5f6f 626a 2c20 7265 6769 6f6e  rage_obj, region
+000332c0: 293a 0a20 2020 2020 2020 2023 2054 6869  ):.        # Thi
+000332d0: 7320 7465 7374 7320 6372 6561 7469 6f6e  s tests creation
+000332e0: 2061 6e64 2075 706c 6f61 6420 746f 2062   and upload to b
+000332f0: 7563 6b65 7420 696e 2061 6c6c 2047 4353  ucket in all GCS
+00033300: 2072 6567 696f 6e73 0a20 2020 2020 2020   regions.       
+00033310: 2023 2054 6f20 7465 7374 2066 756c 6c20   # To test full 
+00033320: 6675 6e63 7469 6f6e 616c 6974 792c 2075  functionality, u
+00033330: 7365 2074 6573 745f 6d61 6e61 6765 645f  se test_managed_
+00033340: 6a6f 6273 5f73 746f 7261 6765 2061 626f  jobs_storage abo
+00033350: 7665 2e0a 2020 2020 2020 2020 7374 6f72  ve..        stor
+00033360: 655f 7479 7065 203d 2073 746f 7261 6765  e_type = storage
+00033370: 5f6c 6962 2e53 746f 7265 5479 7065 2e47  _lib.StoreType.G
+00033380: 4353 0a20 2020 2020 2020 2074 6d70 5f6c  CS.        tmp_l
+00033390: 6f63 616c 5f73 746f 7261 6765 5f6f 626a  ocal_storage_obj
+000333a0: 2e61 6464 5f73 746f 7265 2873 746f 7265  .add_store(store
+000333b0: 5f74 7970 652c 2072 6567 696f 6e3d 7265  _type, region=re
+000333c0: 6769 6f6e 290a 2020 2020 2020 2020 6275  gion).        bu
+000333d0: 636b 6574 5f6e 616d 6520 3d20 746d 705f  cket_name = tmp_
+000333e0: 6c6f 6361 6c5f 7374 6f72 6167 655f 6f62  local_storage_ob
+000333f0: 6a2e 6e61 6d65 0a0a 2020 2020 2020 2020  j.name..        
+00033400: 2320 436f 6e66 6972 6d20 7468 6174 2074  # Confirm that t
+00033410: 6865 2062 7563 6b65 7420 7761 7320 6372  he bucket was cr
+00033420: 6561 7465 6420 696e 2074 6865 2063 6f72  eated in the cor
+00033430: 7265 6374 2072 6567 696f 6e0a 2020 2020  rect region.    
+00033440: 2020 2020 7265 6769 6f6e 5f63 6d64 203d      region_cmd =
+00033450: 2073 656c 662e 636c 695f 7265 6769 6f6e   self.cli_region
+00033460: 5f63 6d64 2873 746f 7265 5f74 7970 652c  _cmd(store_type,
+00033470: 2062 7563 6b65 745f 6e61 6d65 290a 2020   bucket_name).  
+00033480: 2020 2020 2020 6f75 7420 3d20 7375 6270        out = subp
+00033490: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+000334a0: 7075 7428 7265 6769 6f6e 5f63 6d64 2c20  put(region_cmd, 
+000334b0: 7368 656c 6c3d 5472 7565 290a 2020 2020  shell=True).    
+000334c0: 2020 2020 6f75 7470 7574 203d 206f 7574      output = out
+000334d0: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+000334e0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+000334f0: 7265 6769 6f6e 2069 6e20 6f75 742e 6465  region in out.de
+00033500: 636f 6465 2827 7574 662d 3827 292c 2028  code('utf-8'), (
+00033510: 0a20 2020 2020 2020 2020 2020 2066 2742  .            f'B
+00033520: 7563 6b65 7420 7761 7320 6e6f 7420 666f  ucket was not fo
+00033530: 756e 6420 696e 2072 6567 696f 6e20 7b72  und in region {r
+00033540: 6567 696f 6e7d 202d 2027 0a20 2020 2020  egion} - '.     
+00033550: 2020 2020 2020 2066 276f 7574 7075 7420         f'output 
+00033560: 6f66 207b 7265 6769 6f6e 5f63 6d64 7d20  of {region_cmd} 
+00033570: 7761 733a 207b 6f75 7470 7574 7d27 290a  was: {output}').
+00033580: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
+00033590: 2069 6620 746d 705f 736f 7572 6365 2f74   if tmp_source/t
+000335a0: 6d70 2d66 696c 6520 6578 6973 7473 2069  mp-file exists i
+000335b0: 6e20 7468 6520 6275 636b 6574 2075 7369  n the bucket usi
+000335c0: 6e67 2063 6c69 0a20 2020 2020 2020 206c  ng cli.        l
+000335d0: 735f 636d 6420 3d20 7365 6c66 2e63 6c69  s_cmd = self.cli
+000335e0: 5f6c 735f 636d 6428 7374 6f72 655f 7479  _ls_cmd(store_ty
+000335f0: 7065 2c20 6275 636b 6574 5f6e 616d 6529  pe, bucket_name)
+00033600: 0a20 2020 2020 2020 206f 7574 203d 2073  .        out = s
+00033610: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
+00033620: 6f75 7470 7574 286c 735f 636d 642c 2073  output(ls_cmd, s
+00033630: 6865 6c6c 3d54 7275 6529 0a20 2020 2020  hell=True).     
+00033640: 2020 206f 7574 7075 7420 3d20 6f75 742e     output = out.
+00033650: 6465 636f 6465 2827 7574 662d 3827 290a  decode('utf-8').
+00033660: 2020 2020 2020 2020 6173 7365 7274 2027          assert '
+00033670: 746d 702d 6669 6c65 2720 696e 206f 7574  tmp-file' in out
+00033680: 7075 742c 2028 0a20 2020 2020 2020 2020  put, (.         
+00033690: 2020 2066 2774 6d70 2d66 696c 6520 6e6f     f'tmp-file no
+000336a0: 7420 666f 756e 6420 696e 2062 7563 6b65  t found in bucke
+000336b0: 7420 2d20 6f75 7470 7574 206f 6620 7b6c  t - output of {l
+000336c0: 735f 636d 647d 2077 6173 3a20 7b6f 7574  s_cmd} was: {out
+000336d0: 7075 747d 2729 0a0a 0a23 202d 2d2d 2d2d  put}')...# -----
+000336e0: 2d2d 2d2d 2d20 5465 7374 696e 6720 5941  ----- Testing YA
+000336f0: 4d4c 2053 7065 6373 202d 2d2d 2d2d 2d2d  ML Specs -------
+00033700: 2d2d 2d0a 2320 4f75 7220 736b 7920 7374  ---.# Our sky st
+00033710: 6f72 6167 6520 7265 7175 6972 6573 2063  orage requires c
+00033720: 7265 6465 6e74 6961 6c73 2074 6f20 6368  redentials to ch
+00033730: 6563 6b20 7468 6520 6275 636b 6574 2065  eck the bucket e
+00033740: 7869 7374 616e 6365 2077 6865 6e0a 2320  xistance when.# 
+00033750: 6c6f 6164 696e 6720 6120 7461 736b 2066  loading a task f
+00033760: 726f 6d20 7468 6520 7961 6d6c 2066 696c  rom the yaml fil
+00033770: 652c 2073 6f20 7765 2063 616e 6e6f 7420  e, so we cannot 
+00033780: 6d61 6b65 2069 7420 6120 756e 6974 2074  make it a unit t
+00033790: 6573 742e 0a63 6c61 7373 2054 6573 7459  est..class TestY
+000337a0: 616d 6c53 7065 6373 3a0a 2020 2020 2320  amlSpecs:.    # 
+000337b0: 544f 444f 287a 6877 7529 3a20 4164 6420  TODO(zhwu): Add 
+000337c0: 7465 7374 2066 6f72 2060 746f 5f79 616d  test for `to_yam
+000337d0: 6c5f 636f 6e66 6967 6020 666f 7220 7468  l_config` for th
+000337e0: 6520 5374 6f72 6167 6520 6f62 6a65 6374  e Storage object
+000337f0: 2e0a 2020 2020 2320 2057 6520 7368 6f75  ..    #  We shou
+00033800: 6c64 206e 6f74 2075 7365 2060 6578 616d  ld not use `exam
+00033810: 706c 6573 2f73 746f 7261 6765 5f64 656d  ples/storage_dem
+00033820: 6f2e 7961 6d6c 6020 6865 7265 2c20 7369  o.yaml` here, si
+00033830: 6e63 6520 6974 2072 6571 7569 7265 730a  nce it requires.
+00033840: 2020 2020 2320 2075 7365 7273 2074 6f20      #  users to 
+00033850: 656e 7375 7265 2062 7563 6b65 7420 6e61  ensure bucket na
+00033860: 6d65 7320 746f 206e 6f74 2065 7869 7374  mes to not exist
+00033870: 2061 6e64 2f6f 7220 6265 2075 6e69 7175   and/or be uniqu
+00033880: 652e 0a20 2020 205f 5445 5354 5f59 414d  e..    _TEST_YAM
+00033890: 4c5f 5041 5448 5320 3d20 5b0a 2020 2020  L_PATHS = [.    
+000338a0: 2020 2020 2765 7861 6d70 6c65 732f 6d69      'examples/mi
+000338b0: 6e69 6d61 6c2e 7961 6d6c 272c 2027 6578  nimal.yaml', 'ex
+000338c0: 616d 706c 6573 2f6d 616e 6167 6564 5f6a  amples/managed_j
+000338d0: 6f62 2e79 616d 6c27 2c0a 2020 2020 2020  ob.yaml',.      
+000338e0: 2020 2765 7861 6d70 6c65 732f 7573 696e    'examples/usin
+000338f0: 675f 6669 6c65 5f6d 6f75 6e74 732e 7961  g_file_mounts.ya
+00033900: 6d6c 272c 2027 6578 616d 706c 6573 2f72  ml', 'examples/r
+00033910: 6573 6e65 745f 6170 702e 7961 6d6c 272c  esnet_app.yaml',
+00033920: 0a20 2020 2020 2020 2027 6578 616d 706c  .        'exampl
+00033930: 6573 2f6d 756c 7469 5f68 6f73 746e 616d  es/multi_hostnam
+00033940: 652e 7961 6d6c 270a 2020 2020 5d0a 0a20  e.yaml'.    ].. 
+00033950: 2020 2064 6566 205f 6973 5f64 6963 745f     def _is_dict_
+00033960: 7375 6273 6574 2873 656c 662c 2064 312c  subset(self, d1,
+00033970: 2064 3229 3a0a 2020 2020 2020 2020 2222   d2):.        ""
+00033980: 2243 6865 636b 2069 6620 6431 2069 7320  "Check if d1 is 
+00033990: 7468 6520 7375 6273 6574 206f 6620 6432  the subset of d2
+000339a0: 2e22 2222 0a20 2020 2020 2020 2066 6f72  .""".        for
+000339b0: 206b 2c20 7620 696e 2064 312e 6974 656d   k, v in d1.item
+000339c0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+000339d0: 2069 6620 6b20 6e6f 7420 696e 2064 323a   if k not in d2:
+000339e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000339f0: 2069 6620 6973 696e 7374 616e 6365 2876   if isinstance(v
+00033a00: 2c20 6c69 7374 2920 6f72 2069 7369 6e73  , list) or isins
+00033a10: 7461 6e63 6528 762c 2064 6963 7429 3a0a  tance(v, dict):.
+00033a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033a30: 2020 2020 6173 7365 7274 206c 656e 2876      assert len(v
+00033a40: 2920 3d3d 2030 2c20 286b 2c20 7629 0a20  ) == 0, (k, v). 
+00033a50: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00033a60: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00033a70: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00033a80: 4661 6c73 652c 2028 6b2c 2076 290a 2020  False, (k, v).  
+00033a90: 2020 2020 2020 2020 2020 656c 6966 2069            elif i
+00033aa0: 7369 6e73 7461 6e63 6528 762c 2064 6963  sinstance(v, dic
+00033ab0: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
+00033ac0: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+00033ad0: 7461 6e63 6528 6432 5b6b 5d2c 2064 6963  tance(d2[k], dic
+00033ae0: 7429 2c20 286b 2c20 762c 2064 3229 0a20  t), (k, v, d2). 
+00033af0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00033b00: 656c 662e 5f69 735f 6469 6374 5f73 7562  elf._is_dict_sub
+00033b10: 7365 7428 762c 2064 325b 6b5d 290a 2020  set(v, d2[k]).  
+00033b20: 2020 2020 2020 2020 2020 656c 6966 2069            elif i
+00033b30: 7369 6e73 7461 6e63 6528 762c 2073 7472  sinstance(v, str
+00033b40: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00033b50: 2020 2069 6620 6b20 3d3d 2027 6163 6365     if k == 'acce
+00033b60: 6c65 7261 746f 7273 273a 0a20 2020 2020  lerators':.     
+00033b70: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00033b80: 6573 6f75 7263 6573 203d 2073 6b79 2e52  esources = sky.R
+00033b90: 6573 6f75 7263 6573 2829 0a20 2020 2020  esources().     
+00033ba0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00033bb0: 6573 6f75 7263 6573 2e5f 7365 745f 6163  esources._set_ac
+00033bc0: 6365 6c65 7261 746f 7273 2876 2c20 4e6f  celerators(v, No
+00033bd0: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
+00033be0: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
+00033bf0: 6573 6f75 7263 6573 2e61 6363 656c 6572  esources.acceler
+00033c00: 6174 6f72 7320 3d3d 2064 325b 6b5d 2c20  ators == d2[k], 
+00033c10: 286b 2c20 762c 2064 3229 0a20 2020 2020  (k, v, d2).     
+00033c20: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00033c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00033c40: 2020 2020 2061 7373 6572 7420 762e 6c6f       assert v.lo
+00033c50: 7765 7228 2920 3d3d 2064 325b 6b5d 2e6c  wer() == d2[k].l
+00033c60: 6f77 6572 2829 2c20 286b 2c20 762c 2064  ower(), (k, v, d
+00033c70: 325b 6b5d 290a 2020 2020 2020 2020 2020  2[k]).          
+00033c80: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00033c90: 2020 2020 2020 2020 6173 7365 7274 2076          assert v
+00033ca0: 203d 3d20 6432 5b6b 5d2c 2028 6b2c 2076   == d2[k], (k, v
+00033cb0: 2c20 6432 5b6b 5d29 0a0a 2020 2020 6465  , d2[k])..    de
+00033cc0: 6620 5f63 6865 636b 5f65 7175 6976 616c  f _check_equival
+00033cd0: 656e 7428 7365 6c66 2c20 7961 6d6c 5f70  ent(self, yaml_p
+00033ce0: 6174 6829 3a0a 2020 2020 2020 2020 2222  ath):.        ""
+00033cf0: 2243 6865 636b 2069 6620 7468 6520 7961  "Check if the ya
+00033d00: 6d6c 2069 7320 6571 7569 7661 6c65 6e74  ml is equivalent
+00033d10: 2061 6674 6572 206c 6f61 6420 616e 6420   after load and 
+00033d20: 6475 6d70 2061 6761 696e 2e22 2222 0a20  dump again.""". 
+00033d30: 2020 2020 2020 206f 7269 6769 6e5f 7461         origin_ta
+00033d40: 736b 5f63 6f6e 6669 6720 3d20 636f 6d6d  sk_config = comm
+00033d50: 6f6e 5f75 7469 6c73 2e72 6561 645f 7961  on_utils.read_ya
+00033d60: 6d6c 2879 616d 6c5f 7061 7468 290a 0a20  ml(yaml_path).. 
+00033d70: 2020 2020 2020 2074 6173 6b20 3d20 736b         task = sk
+00033d80: 792e 5461 736b 2e66 726f 6d5f 7961 6d6c  y.Task.from_yaml
+00033d90: 2879 616d 6c5f 7061 7468 290a 2020 2020  (yaml_path).    
+00033da0: 2020 2020 6e65 775f 7461 736b 5f63 6f6e      new_task_con
+00033db0: 6669 6720 3d20 7461 736b 2e74 6f5f 7961  fig = task.to_ya
+00033dc0: 6d6c 5f63 6f6e 6669 6728 290a 2020 2020  ml_config().    
+00033dd0: 2020 2020 2320 6431 203c 3d20 6432 0a20      # d1 <= d2. 
+00033de0: 2020 2020 2020 2070 7269 6e74 286f 7269         print(ori
+00033df0: 6769 6e5f 7461 736b 5f63 6f6e 6669 672c  gin_task_config,
+00033e00: 206e 6577 5f74 6173 6b5f 636f 6e66 6967   new_task_config
+00033e10: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
+00033e20: 6973 5f64 6963 745f 7375 6273 6574 286f  is_dict_subset(o
+00033e30: 7269 6769 6e5f 7461 736b 5f63 6f6e 6669  rigin_task_confi
+00033e40: 672c 206e 6577 5f74 6173 6b5f 636f 6e66  g, new_task_conf
+00033e50: 6967 290a 0a20 2020 2064 6566 2074 6573  ig)..    def tes
+00033e60: 745f 6c6f 6164 5f64 756d 705f 7961 6d6c  t_load_dump_yaml
+00033e70: 5f63 6f6e 6669 675f 6571 7569 7661 6c65  _config_equivale
+00033e80: 6e74 2873 656c 6629 3a0a 2020 2020 2020  nt(self):.      
+00033e90: 2020 2222 2254 6573 7420 6966 2074 6865    """Test if the
+00033ea0: 2079 616d 6c20 636f 6e66 6967 2069 7320   yaml config is 
+00033eb0: 6571 7569 7661 6c65 6e74 2061 6674 6572  equivalent after
+00033ec0: 206c 6f61 6420 616e 6420 6475 6d70 2061   load and dump a
+00033ed0: 6761 696e 2e22 2222 0a20 2020 2020 2020  gain.""".       
+00033ee0: 2070 6174 686c 6962 2e50 6174 6828 277e   pathlib.Path('~
+00033ef0: 2f64 6174 6173 6574 7327 292e 6578 7061  /datasets').expa
+00033f00: 6e64 7573 6572 2829 2e6d 6b64 6972 2865  nduser().mkdir(e
+00033f10: 7869 7374 5f6f 6b3d 5472 7565 290a 2020  xist_ok=True).  
+00033f20: 2020 2020 2020 7061 7468 6c69 622e 5061        pathlib.Pa
+00033f30: 7468 2827 7e2f 746d 7066 696c 6527 292e  th('~/tmpfile').
+00033f40: 6578 7061 6e64 7573 6572 2829 2e74 6f75  expanduser().tou
+00033f50: 6368 2829 0a20 2020 2020 2020 2070 6174  ch().        pat
+00033f60: 686c 6962 2e50 6174 6828 277e 2f2e 7373  hlib.Path('~/.ss
+00033f70: 6827 292e 6578 7061 6e64 7573 6572 2829  h').expanduser()
+00033f80: 2e6d 6b64 6972 2865 7869 7374 5f6f 6b3d  .mkdir(exist_ok=
+00033f90: 5472 7565 290a 2020 2020 2020 2020 7061  True).        pa
+00033fa0: 7468 6c69 622e 5061 7468 2827 7e2f 2e73  thlib.Path('~/.s
+00033fb0: 7368 2f69 645f 7273 612e 7075 6227 292e  sh/id_rsa.pub').
+00033fc0: 6578 7061 6e64 7573 6572 2829 2e74 6f75  expanduser().tou
+00033fd0: 6368 2829 0a20 2020 2020 2020 2070 6174  ch().        pat
+00033fe0: 686c 6962 2e50 6174 6828 277e 2f74 6d70  hlib.Path('~/tmp
+00033ff0: 2d77 6f72 6b64 6972 2729 2e65 7870 616e  -workdir').expan
+00034000: 6475 7365 7228 292e 6d6b 6469 7228 6578  duser().mkdir(ex
+00034010: 6973 745f 6f6b 3d54 7275 6529 0a20 2020  ist_ok=True).   
+00034020: 2020 2020 2070 6174 686c 6962 2e50 6174       pathlib.Pat
+00034030: 6828 277e 2f44 6f77 6e6c 6f61 6473 2f74  h('~/Downloads/t
+00034040: 7075 2729 2e65 7870 616e 6475 7365 7228  pu').expanduser(
+00034050: 292e 6d6b 6469 7228 7061 7265 6e74 733d  ).mkdir(parents=
+00034060: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+00034070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000340a0: 2065 7869 7374 5f6f 6b3d 5472 7565 290a   exist_ok=True).
+000340b0: 2020 2020 2020 2020 666f 7220 7961 6d6c          for yaml
+000340c0: 5f70 6174 6820 696e 2073 656c 662e 5f54  _path in self._T
+000340d0: 4553 545f 5941 4d4c 5f50 4154 4853 3a0a  EST_YAML_PATHS:.
+000340e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000340f0: 2e5f 6368 6563 6b5f 6571 7569 7661 6c65  ._check_equivale
+00034100: 6e74 2879 616d 6c5f 7061 7468 290a 0a0a  nt(yaml_path)...
+00034110: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
+00034120: 7469 6e67 204d 756c 7469 706c 6520 4163  ting Multiple Ac
+00034130: 6365 6c65 7261 746f 7273 202d 2d2d 2d2d  celerators -----
+00034140: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
+00034150: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
+00034160: 2020 2320 466c 7569 6473 7461 636b 2064    # Fluidstack d
+00034170: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+00034180: 4b38 3020 6770 7573 2066 6f72 206e 6f77  K80 gpus for now
+00034190: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+000341a0: 5f70 6170 6572 7370 6163 6520 2023 2050  _paperspace  # P
+000341b0: 6170 6572 7370 6163 6520 646f 6573 206e  aperspace does n
+000341c0: 6f74 2073 7570 706f 7274 204b 3830 2067  ot support K80 g
+000341d0: 7075 730a 6465 6620 7465 7374 5f6d 756c  pus.def test_mul
+000341e0: 7469 706c 655f 6163 6365 6c65 7261 746f  tiple_accelerato
+000341f0: 7273 5f6f 7264 6572 6564 2829 3a0a 2020  rs_ordered():.  
+00034200: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00034210: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00034220: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00034230: 2020 2020 2020 276d 756c 7469 706c 652d        'multiple-
+00034240: 6163 6365 6c65 7261 746f 7273 2d6f 7264  accelerators-ord
+00034250: 6572 6564 272c 0a20 2020 2020 2020 205b  ered',.        [
+00034260: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00034270: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00034280: 7b6e 616d 657d 2074 6573 7473 2f74 6573  {name} tests/tes
+00034290: 745f 7961 6d6c 732f 7465 7374 5f6d 756c  t_yamls/test_mul
+000342a0: 7469 706c 655f 6163 6365 6c65 7261 746f  tiple_accelerato
+000342b0: 7273 5f6f 7264 6572 6564 2e79 616d 6c20  rs_ordered.yaml 
+000342c0: 7c20 6772 6570 2022 5573 696e 6720 7573  | grep "Using us
+000342d0: 6572 2d73 7065 6369 6669 6564 2061 6363  er-specified acc
+000342e0: 656c 6572 6174 6f72 7320 6c69 7374 2227  elerators list"'
+000342f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00034300: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00034310: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
+00034320: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
+00034330: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
+00034340: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+00034350: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00034360: 7d27 2c0a 2020 2020 2020 2020 7469 6d65  }',.        time
+00034370: 6f75 743d 3230 202a 2036 302c 0a20 2020  out=20 * 60,.   
+00034380: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00034390: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+000343a0: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
+000343b0: 6473 7461 636b 2020 2320 466c 7569 6473  dstack  # Fluids
+000343c0: 7461 636b 2068 6173 206c 6f77 2061 7661  tack has low ava
+000343d0: 696c 6162 696c 6974 7920 666f 7220 5434  ilability for T4
+000343e0: 2047 5055 730a 4070 7974 6573 742e 6d61   GPUs.@pytest.ma
+000343f0: 726b 2e6e 6f5f 7061 7065 7273 7061 6365  rk.no_paperspace
+00034400: 2020 2320 5061 7065 7273 7061 6365 2064    # Paperspace d
+00034410: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+00034420: 5434 2047 5055 730a 6465 6620 7465 7374  T4 GPUs.def test
+00034430: 5f6d 756c 7469 706c 655f 6163 6365 6c65  _multiple_accele
+00034440: 7261 746f 7273 5f6f 7264 6572 6564 5f77  rators_ordered_w
+00034450: 6974 685f 6465 6661 756c 7428 293a 0a20  ith_default():. 
+00034460: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00034470: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00034480: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00034490: 2020 2020 2020 2027 6d75 6c74 6970 6c65         'multiple
+000344a0: 2d61 6363 656c 6572 6174 6f72 732d 6f72  -accelerators-or
+000344b0: 6465 7265 6427 2c0a 2020 2020 2020 2020  dered',.        
+000344c0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+000344d0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+000344e0: 207b 6e61 6d65 7d20 7465 7374 732f 7465   {name} tests/te
+000344f0: 7374 5f79 616d 6c73 2f74 6573 745f 6d75  st_yamls/test_mu
+00034500: 6c74 6970 6c65 5f61 6363 656c 6572 6174  ltiple_accelerat
+00034510: 6f72 735f 6f72 6465 7265 645f 7769 7468  ors_ordered_with
+00034520: 5f64 6566 6175 6c74 2e79 616d 6c20 7c20  _default.yaml | 
+00034530: 6772 6570 2022 5573 696e 6720 7573 6572  grep "Using user
+00034540: 2d73 7065 6369 6669 6564 2061 6363 656c  -specified accel
+00034550: 6572 6174 6f72 7320 6c69 7374 2227 2c0a  erators list"',.
+00034560: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00034570: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+00034580: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
+00034590: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
+000345a0: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+000345b0: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
+000345c0: 207b 6e61 6d65 7d20 7c20 6772 6570 2053   {name} | grep S
+000345d0: 706f 7427 2c0a 2020 2020 2020 2020 5d2c  pot',.        ],
+000345e0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+000345f0: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+00034600: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00034610: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+00034620: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
+00034630: 6c75 6964 7374 6163 6b20 2023 2046 6c75  luidstack  # Flu
+00034640: 6964 7374 6163 6b20 6861 7320 6c6f 7720  idstack has low 
+00034650: 6176 6169 6c61 6269 6c69 7479 2066 6f72  availability for
+00034660: 2054 3420 4750 5573 0a40 7079 7465 7374   T4 GPUs.@pytest
+00034670: 2e6d 6172 6b2e 6e6f 5f70 6170 6572 7370  .mark.no_papersp
+00034680: 6163 6520 2023 2050 6170 6572 7370 6163  ace  # Paperspac
+00034690: 6520 646f 6573 206e 6f74 2073 7570 706f  e does not suppo
+000346a0: 7274 2054 3420 4750 5573 0a64 6566 2074  rt T4 GPUs.def t
+000346b0: 6573 745f 6d75 6c74 6970 6c65 5f61 6363  est_multiple_acc
+000346c0: 656c 6572 6174 6f72 735f 756e 6f72 6465  elerators_unorde
+000346d0: 7265 6428 293a 0a20 2020 206e 616d 6520  red():.    name 
+000346e0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+000346f0: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+00034700: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+00034710: 6d75 6c74 6970 6c65 2d61 6363 656c 6572  multiple-acceler
+00034720: 6174 6f72 732d 756e 6f72 6465 7265 6427  ators-unordered'
+00034730: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00034740: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+00034750: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+00034760: 7d20 7465 7374 732f 7465 7374 5f79 616d  } tests/test_yam
+00034770: 6c73 2f74 6573 745f 6d75 6c74 6970 6c65  ls/test_multiple
+00034780: 5f61 6363 656c 6572 6174 6f72 735f 756e  _accelerators_un
+00034790: 6f72 6465 7265 642e 7961 6d6c 272c 0a20  ordered.yaml',. 
+000347a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000347b0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+000347c0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+000347d0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+000347e0: 6565 6465 642e 0a20 2020 2020 2020 205d  eeded..        ]
+000347f0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00034800: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00034810: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00034820: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00034830: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00034840: 666c 7569 6473 7461 636b 2020 2320 466c  fluidstack  # Fl
+00034850: 7569 6473 7461 636b 2068 6173 206c 6f77  uidstack has low
+00034860: 2061 7661 696c 6162 696c 6974 7920 666f   availability fo
+00034870: 7220 5434 2047 5055 730a 4070 7974 6573  r T4 GPUs.@pytes
+00034880: 742e 6d61 726b 2e6e 6f5f 7061 7065 7273  t.mark.no_papers
+00034890: 7061 6365 2020 2320 5061 7065 7273 7061  pace  # Paperspa
+000348a0: 6365 2064 6f65 7320 6e6f 7420 7375 7070  ce does not supp
+000348b0: 6f72 7420 5434 2047 5055 730a 6465 6620  ort T4 GPUs.def 
+000348c0: 7465 7374 5f6d 756c 7469 706c 655f 6163  test_multiple_ac
+000348d0: 6365 6c65 7261 746f 7273 5f75 6e6f 7264  celerators_unord
+000348e0: 6572 6564 5f77 6974 685f 6465 6661 756c  ered_with_defaul
+000348f0: 7428 293a 0a20 2020 206e 616d 6520 3d20  t():.    name = 
+00034900: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00034910: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+00034920: 6573 7428 0a20 2020 2020 2020 2027 6d75  est(.        'mu
+00034930: 6c74 6970 6c65 2d61 6363 656c 6572 6174  ltiple-accelerat
+00034940: 6f72 732d 756e 6f72 6465 7265 6427 2c0a  ors-unordered',.
+00034950: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00034960: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00034970: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
+00034980: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+00034990: 2f74 6573 745f 6d75 6c74 6970 6c65 5f61  /test_multiple_a
+000349a0: 6363 656c 6572 6174 6f72 735f 756e 6f72  ccelerators_unor
+000349b0: 6465 7265 645f 7769 7468 5f64 6566 6175  dered_with_defau
+000349c0: 6c74 2e79 616d 6c27 2c0a 2020 2020 2020  lt.yaml',.      
+000349d0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+000349e0: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
+000349f0: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
+00034a00: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
+00034a10: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00034a20: 736b 7920 7374 6174 7573 207b 6e61 6d65  sky status {name
+00034a30: 7d20 7c20 6772 6570 2053 706f 7427 2c0a  } | grep Spot',.
+00034a40: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00034a50: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+00034a60: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
+00034a70: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00034a80: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00034a90: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
+00034aa0: 6163 6b20 2023 2052 6571 7569 7265 7320  ack  # Requires 
+00034ab0: 6f74 6865 7220 636c 6f75 6473 2074 6f20  other clouds to 
+00034ac0: 6265 2065 6e61 626c 6564 0a64 6566 2074  be enabled.def t
+00034ad0: 6573 745f 6d75 6c74 6970 6c65 5f72 6573  est_multiple_res
+00034ae0: 6f75 7263 6573 2829 3a0a 2020 2020 6e61  ources():.    na
+00034af0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00034b00: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+00034b10: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00034b20: 2020 276d 756c 7469 706c 652d 7265 736f    'multiple-reso
+00034b30: 7572 6365 7327 2c0a 2020 2020 2020 2020  urces',.        
+00034b40: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00034b50: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00034b60: 207b 6e61 6d65 7d20 7465 7374 732f 7465   {name} tests/te
+00034b70: 7374 5f79 616d 6c73 2f74 6573 745f 6d75  st_yamls/test_mu
+00034b80: 6c74 6970 6c65 5f72 6573 6f75 7263 6573  ltiple_resources
+00034b90: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00034ba0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00034bb0: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+00034bc0: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+00034bd0: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+00034be0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00034bf0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+00034c00: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
+00034c10: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00034c20: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
+00034c30: 2d2d 2d2d 2d20 536b 7920 4265 6e63 686d  ----- Sky Benchm
+00034c40: 6172 6b20 2d2d 2d2d 2d2d 2d2d 2d2d 0a40  ark ----------.@
+00034c50: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
+00034c60: 6c75 6964 7374 6163 6b20 2023 2052 6571  luidstack  # Req
+00034c70: 7569 7265 7320 6f74 6865 7220 636c 6f75  uires other clou
+00034c80: 6473 2074 6f20 6265 2065 6e61 626c 6564  ds to be enabled
+00034c90: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00034ca0: 5f70 6170 6572 7370 6163 6520 2023 2052  _paperspace  # R
+00034cb0: 6571 7569 7265 7320 6f74 6865 7220 636c  equires other cl
+00034cc0: 6f75 6473 2074 6f20 6265 2065 6e61 626c  ouds to be enabl
+00034cd0: 6564 0a40 7079 7465 7374 2e6d 6172 6b2e  ed.@pytest.mark.
+00034ce0: 6e6f 5f6b 7562 6572 6e65 7465 730a 6465  no_kubernetes.de
+00034cf0: 6620 7465 7374 5f73 6b79 5f62 656e 6368  f test_sky_bench
+00034d00: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
+00034d10: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
+00034d20: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00034d30: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00034d40: 5465 7374 280a 2020 2020 2020 2020 2773  Test(.        's
+00034d50: 6b79 2d62 656e 6368 272c 0a20 2020 2020  ky-bench',.     
+00034d60: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00034d70: 2066 2773 6b79 2062 656e 6368 206c 6175   f'sky bench lau
+00034d80: 6e63 6820 2d79 202d 6220 7b6e 616d 657d  nch -y -b {name}
+00034d90: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+00034da0: 635f 636c 6f75 647d 202d 6930 2074 6573  c_cloud} -i0 tes
+00034db0: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
+00034dc0: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
+00034dd0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00034de0: 3132 3027 2c0a 2020 2020 2020 2020 2020  120',.          
+00034df0: 2020 6627 736b 7920 6265 6e63 6820 7368    f'sky bench sh
+00034e00: 6f77 207b 6e61 6d65 7d20 7c20 6772 6570  ow {name} | grep
+00034e10: 2073 6b79 2d62 656e 6368 2d7b 6e61 6d65   sky-bench-{name
+00034e20: 7d20 7c20 6772 6570 2046 494e 4953 4845  } | grep FINISHE
+00034e30: 4427 2c0a 2020 2020 2020 2020 5d2c 0a20  D',.        ],. 
+00034e40: 2020 2020 2020 2066 2773 6b79 2062 656e         f'sky ben
+00034e50: 6368 2064 6f77 6e20 7b6e 616d 657d 202d  ch down {name} -
+00034e60: 793b 2073 6b79 2062 656e 6368 2064 656c  y; sky bench del
+00034e70: 6574 6520 7b6e 616d 657d 202d 7927 2c0a  ete {name} -y',.
+00034e80: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00034e90: 655f 7465 7374 2874 6573 7429 0a         e_test(test).
```

### Comparing `skypilot_nightly-1.0.0.dev20240516/tests/test_storage.py` & `skypilot_nightly-1.0.0.dev20240517/tests/test_storage.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/tests/test_wheels.py` & `skypilot_nightly-1.0.0.dev20240517/tests/test_wheels.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240516/tests/test_yaml_parser.py` & `skypilot_nightly-1.0.0.dev20240517/tests/test_yaml_parser.py`

 * *Files 4% similar despite different names*

```diff
@@ -130,7 +130,19 @@
             envs:
                 - env_key1: abc
                 - env_key2: abc
             """), tmp_path)
     with pytest.raises(ValueError) as e:
         Task.from_yaml(config_path)
     assert 'is not of type \'dict\'' in e.value.args[0]
+
+
+def test_invalid_empty_envs(tmp_path):
+    config_path = _create_config_file(
+        textwrap.dedent(f"""\
+            envs:
+                env_key1: abc
+                env_key2:
+            """), tmp_path)
+    with pytest.raises(ValueError) as e:
+        Task.from_yaml(config_path)
+    assert 'Environment variable \'env_key2\' is None.' in e.value.args[0]
```

